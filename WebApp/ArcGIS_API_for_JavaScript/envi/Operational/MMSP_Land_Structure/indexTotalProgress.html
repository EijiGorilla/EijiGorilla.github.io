<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
<title>Progress Summary (MMSP)</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>

<script src="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.esm.js" type="module"></script>
<link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.css" />

<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://js.arcgis.com/4.25/"></script>

  </head>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <calcite-tabs>
        <div id="applicationDiv">
          <div id="headerDiv">
            <div id="headerTitleDiv">Status of Land Acquisition (MMSP)</div>
          </div>
          <calcite-tab-nav slot="tab-nav" id="thetabs">
            <calcite-tab-title class="Stations" selected>Stations</calcite-tab-title>
            <calcite-tab-title class="Subterranean">Subterranean</calcite-tab-title>
          </calcite-tab-nav>
          <calcite-tab>
            <div class="contentBox">
              <div class="container">
                <div class="landStrucIsfBox">
                  <div id="legalpChartDiv"></div>
                  <div id="appraisalChartDiv"></div>
                  <div id="exproChartDiv"></div>
                </div>
                <div class="treeBox">
                  <div id="paypChartDiv"></div>
                  <div id="handedOverChartDiv"></div>
                  <div id="wopChartDiv"></div>
                </div>
                <div class="utilityBox">
                  <div id="paidChartDiv"></div>
                  <div id="utilityLineChartDiv"></div>
                  <div id="structureChartDiv"></div>
                </div> 
            </div>
            </div>
          </calcite-tab>
          <calcite-tab>
            <div class="contentBox2">
              <div class="container2">
                <div class="landStrucIsfBox2">
                  <div id="legalpChartDiv2"></div>
                  <div id="appraisalChartDiv2"></div>
                  <div id="exproChartDiv2"></div>
                </div>
                <div class="treeBox2">
                  <div id="paypChartDiv2"></div>
                  <div id="handedOverChartDiv2"></div>
                  <div id="wopChartDiv2"></div>
                </div>
                <div class="utilityBox2">
                  <div id="paidChartDiv2"></div>
                  <div id="utilityLineChartDiv2"></div>
                  <div id="structureChartDiv2"></div>
                </div>      
            </div>
            </div>
          </calcite-tab>
          <div id="infoIcon">
            <calcite-action-bar slot="action-bar">
              <calcite-action class="inforClass" data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>
            <calcite-panel heading="Description" data-panel-id="information" hidden>
              <div id="info-content">
                <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                <div id="item-description">
                  <!-- Dynamically populated -->
                </div>
              </div>
            </calcite-panel>
          </div>
            <div id="legendChartDiv"></div>
            <div id="legendChartDiv2"></div>
          <div class="dateDiv">January 16, 2023</div> 
          <div id="informationDiv"></div>
          <calcite-button
            href="https://www.arcgis.com/apps/mapviewer/index.html?marker=142.1994;11.3498;4326;Mariana Trench;https://clipart.world/wp-content/uploads/2021/07/Target-clipart-transparent-background-4.png&level=6"
            icon-end="launch"
            label="Open Process Flow Chart"
            target="_blank">
            Open Process Flow Chart
        </calcite-button>
        </div>
      </calcite-tabs>
    </calcite-shell>
  </body>
</html>

<style>
html,
body {
  padding: 0;
  margin: 0;
  /*background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.3));*/
  /*border-color: white;*/
  /*box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);*/
  /*background-color: rgb(0,0,0,0.5);*/
}

#applicationDiv {
  display: flex;
  flex-wrap: wrap;
  height: 100%;
  padding: 10px;
  margin: 0 auto;
  box-sizing: border-box;

}

#item-description {
  padding: 0.5rem;

}

#item-description b {
  color: orange;
}

calcite-button {
  position: absolute;
  z-index: 99;
  bottom: 50;
  right: 10;
}

calcite-action-bar {
  position: absolute;
  z-index: 99;
  top: 0;
  right: 0;
  margin: 1rem;
}

calcite-panel {
  position: absolute;
  z-index: 99;
  bottom: 4rem;
  right: 2rem;
  width: 30vw;
  

}

calcite-loader {
  align-self: center;
  justify-self: center;
}

calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tab-nav {
      margin: auto;
      width: 20vw;
    }


calcite-rating {
      margin-top: 0.25rem;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

#informationDiv {
  position: absolute;
  z-index: 99;
  width: 30vw;
  height: 10vh;
  color: white;
  bottom: 190;
  right: 5;
  font-size: 1rem;
}

#informationDiv b {
  font-size: 1rem;
  color: orange;
  margin: 0;
  padding: 0;
}

.contentBox,
.contentBox2 {
  display: grid;
  grid-template-columns: 80vw 17.8vw;
  width: 100%;
  height: 100%;
}

.container,
.container2 {
  display: grid;
  flex-wrap: wrap;
  height: 88vh;
  box-sizing: border-box;
  border-right: 0;
}


.containerB {
  font-size: 1.5vw;
  color: white;
  padding-top: 40%;
}


#headerDiv {
  margin-bottom: 3px;
  display: grid;
  grid-template-columns: 2fr 150px;
  margin: 0.5%;
}

#headerTitleDiv {
  color: white;
  font-weight: bold;
  font-size: 1.8vw;

}

.dateDiv {
  z-index: 99;
  position: absolute;
  padding-bottom: 10;
  font-size: 1vw;
  color: rgb(0, 197, 255);
  right:10;
  bottom: 10;
}

.landStrucIsfBox,
.treeBox,
.landStrucIsfBox2,
.treeBox2 {
  display: inline-flex;
  height: 29vh;
  width: 100%;
  box-sizing: border-box;
  border-top: 0;
  border-bottom: 0;
  margin: 0;
  padding: 0;
  border-bottom: 0.7px solid rgb(185, 171, 171);
}

.utilityBox,
.utilityBox2 {
  display: inline-flex;
  height: 29vh;
  width: 100%;
  box-sizing: border-box;
  border-top: 0;
  border-bottom: 0;
  margin: 0;
  padding: 0;
}

#legendChartDiv {
  position: absolute;
  z-index: 99;
  right: 80;
  margin: 0;
  padding: 0;
  top: 0;
  background-color: rgba(0, 0, 0, 0);
  height: 50vh;
  width: 10vw;
}

#legendChartDiv2 {
  position: absolute;
  z-index: 99;
  right: 80;
  margin: 0;
  padding: 0;
  top: 0;
  background-color: rgba(0, 0, 0, 0);
  height: 50vh;
  width: 10vw;
}

#paidChartDiv,
#structureChartDiv,
#paypChartDiv,
#legalpChartDiv,
#exproChartDiv,
#utilityLineChartDiv,
#appraisalChartDiv,
#wopChartDiv,
#paidChartDiv2,
#structureChartDiv2,
#paypChartDiv2,
#legalpChartDiv2,
#exproChartDiv2,
#utilityLineChartDiv2,
#appraisalChartDiv2,
#wopChartDiv2 {
    width: 35%;
    height: 32vh;
    align-items: center;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    margin: 0;
    padding: 0;
    }

#handedOverChartDiv,
#handedOverChartDiv2 {
    width: 35%;
    height: 32vh;
    align-items: center;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    margin: 0;
    padding: 0;
    
    }

a {
  font-size: 1.2vw;
  color: white;
  font-weight: bold;
}

a:hover,
a:focus {
  color: rgb(185, 171, 171);
  font-size: 1.2vw;
}

ul {
list-style: none;
padding-left: 10;
line-height: 3rem;
}
â€‹



p {
  font-size: 1rem;
  width: auto;
  vertical-align: text-bottom;
  padding: 0;
  margin-top: 0;
}


h2 {
  font-weight: 400;
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  font-style: normal;
  font-size: 23px;
  color: white;
  padding:3px;
  margin: 0px;
  width: 470px;
  vertical-align: text-top;
}



h3 {
  color: white;
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  padding: 10;
  width: 100%;

}

h4 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: left;
  font-weight: normal;
  font-size: 16px;
  padding-top: 20px;
  margin: 0;
  width: 160px;
  vertical-align: text-bottom;
}

h5 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  padding: 3;
  margin: 10;
}

h6 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: normal;
  font-size: 30px;
  padding: 0px 0px 0px 0px;
  }


    .sassy-theme .esri-menu,
.sassy-theme .esri-popup__main-container,
.sassy-theme .esri-popup .esri-popup__pointer-direction,
.sassy-theme .esri-popup .esri-popup__button,
.sassy-theme .esri-button,
.sassy-theme .esri-input,
.sassy-theme .esri-legend,
.sassy-theme .esri-layer-list,
.sassy-theme .esri-widget a {
  background-color: rgb(0, 0, 0, 0.7);
  color: #fff;
}

.sassy-theme .esri-legend__layer-caption {
display: none;
}

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    require([
  "esri/Basemap",
  "esri/Map",
  "esri/views/MapView",
  "esri/views/SceneView",
  "esri/layers/FeatureLayer",
  "esri/layers/support/FeatureFilter",
  "esri/layers/SceneLayer",
  "esri/layers/Layer",
  "esri/layers/TileLayer",
  "esri/layers/VectorTileLayer",
  "esri/layers/support/LabelClass",
  "esri/symbols/LabelSymbol3D",
  "esri/WebMap",
  "esri/WebScene",
  "esri/portal/PortalItem",
  "esri/portal/Portal",
  "esri/widgets/TimeSlider",
  "esri/widgets/Legend",
  "esri/widgets/LayerList",
  "esri/widgets/Fullscreen",
  "esri/rest/geometryService",
  "esri/rest/support/Query",
  "esri/rest/support/StatisticDefinition",
  "esri/symbols/WebStyleSymbol",
  "esri/TimeExtent",
  "esri/widgets/Expand",
  "esri/widgets/Editor",
  "esri/renderers/UniqueValueRenderer",
  "esri/widgets/support/DatePicker",
  "esri/widgets/FeatureTable",
  "esri/widgets/Compass",
  "esri/layers/ElevationLayer",
  "esri/Ground",
  "esri/layers/GraphicsLayer",
  "esri/widgets/Search",
], function(Basemap, Map, MapView, SceneView, 
            FeatureLayer, FeatureFilter,
            SceneLayer, Layer, TileLayer, VectorTileLayer,
            LabelClass, LabelSymbol3D, WebMap,
            WebScene, PortalItem, Portal,
            TimeSlider, Legend, LayerList, Fullscreen,
            geometryService, Query,
            StatisticDefinition, WebStyleSymbol,
            TimeExtent, Expand, Editor, UniqueValueRenderer, DatePicker,
            FeatureTable, Compass, ElevationLayer, Ground,
            GraphicsLayer, Search) {

////////////////////////////////////////////////////
var basemap = new Basemap({
  baseLayers: [
    new VectorTileLayer({
      portalItem: {
        id: "8a9ef2a144e8423786f6139408ac3424" // 3a62040541b84f528da3ac7b80cf4a63
      }
    })
  ]
});

   var map = new Map({
        basemap: basemap, //"gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation"
  }); 
  //map.ground.surfaceColor = "#FFFF";
  //map.ground.opacity = 0.5;


  // Setup UI




//*******************************//
// Import Layers                 //
//*******************************//
var lotLayer = new FeatureLayer({
    portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
  outFields: ["*"],
  title: "Status of Land Acquisition",
  labelsVisible: false,
});


// Structure
var structureLayer = new FeatureLayer({
portalItem: {
id: "dca1d785da0f458b8f87638a76918496",
portal: {
url: "https://gis.railway-sector.com/portal"
}
},
layerId: 6,
  title: "Status of Structure",
  outFields: ["*"]
});


// Relocation Status point layer
var reloISFLayer = new FeatureLayer({
portalItem: {
id: "dca1d785da0f458b8f87638a76918496",
portal: {
url: "https://gis.railway-sector.com/portal"
}
},
layerId: 4,
  outFields: ["*"],
  title: "Status for Relocation (ISF)"
});
//reloISFLayer.listMode = "hide";



// Tree Cutting
var treeLayer = new FeatureLayer ({
portalItem: {
id: "4da5697d684f4babad15aedfe74c5b36",
portal: {
  url: "https://gis.railway-sector.com/portal"
}
},
elevationInfo: {
      mode: "on-the-ground"
    },
outFields: ["*"],
title: "Status of Tree Cutting",

});


// Utility Relocation (Point)
var utilPointLayer = new FeatureLayer({
portalItem: {
id: "109d4ef09fd946d1bda17396f35deb94",
portal: {
  url: "https://gis.railway-sector.com/portal"
}
},
layerId: 1,
title: "Utility Point",
outFields: ["*"],
elevationInfo: {
      mode: "on-the-ground"
    }
});

// Utility Relocation (Line)
var utilLineLayer = new FeatureLayer({
portalItem: {
id: "109d4ef09fd946d1bda17396f35deb94",
portal: {
  url: "https://gis.railway-sector.com/portal"
}
},
layerId: 2,
title: "Utility Line",
elevationInfo: {
mode: "relative-to-scene",
featureExpressionInfo: {
 expression: "$feature.height"
},
unit: "meters"
//offset: 0
},
outFields: ["*"],

});


/////////////////////////////////////////////////////////////////////
var applicationDiv = document.getElementById("applicationDiv");

var headerDiv = document.getElementById("headerDiv");
var headerTitleDiv = document.getElementById("headerTitleDiv");

// Land, structure, and ISF
var paidChartDiv = document.getElementById("paidChartDiv");
var structureChartDiv = document.getElementById("structureChartDiv");
var paypChartDiv = document.getElementById("paypChartDiv");

// Tree cutting and tree compensation
var legalpChartDiv = document.getElementById("legalpChartDiv");
var handedOverChartDiv = document.getElementById("handedOverChartDiv");

// Utitlity Relocation
var exproChartDiv = document.getElementById("exproChartDiv");
var utilityLineChartDiv = document.getElementById("utilityLineChartDiv");

var informationDiv = document.getElementById("informationDiv");

//informationDiv.innerHTML =  "<br>" + "<b>" + "Note:" + "</b>" + "<br>" + "<br>" + "* Each gauge shows percent progress of each CP in the sliced chart.";
/*
informationDiv.innerHTML =  `<b>Note:</b><br>
                             <p>1. This dashboard shows the progress of land acquisition using gauges.</p>
                             <p>2. Each gauge represents individual land processes by different contract packages.</p>
                             <p>3. Overall progress including all CPs is indicated at the bottom of each gauge.</p>
                             <p>4. Progress of individual CPs is displayed in the sliced areas of each gauge with respective colors from Legend.</p>
                             <p>3. <b>Click 'Station' or 'Subterranean'</b> tab at the screen top to view the respective progress of land acquisition.</p> 
                             `
*/
// Thousand separators function
function thousands_separators(num)
{
var num_parts = num.toString().split(".");
num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
return num_parts.join(".");
}

////////// Chart Begins //////////////////
am4core.ready(function() {

// Bottom Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

// Gauge Needle (hand) length
const NEEDLE_LENGTH = am4core.percent(70);

// Themes begin
am4core.useTheme(am4themes_animated);


//////////////////////////////////////////
// query
const queryStation = "Type = 'Station'";
const querySubterranean = "Type = 'Subterranean'";

// chart color
var axis1TickColor = "#C5C5C5";
const color_101  = "#ffa500";
const color_102  = "#00ff00";
const color_103 = "#70AD47";
const color_104 = "#ffff00";
const color_105 = "#bf40bf";
const color_108 = "#ff7f7f";
const color_109 = "#cdaa66";
const color_handedOver = "#00c5ff"

// chart title
const title_otb = "[bold]For Appraisal/Offer to Buy"+" (1)";
const title_legalp = "[bold]For Legal Pass" + " (2A)";
const title_payp = "[bold]For Payment Process" + " (3A)";
const title_paid = "[bold]For Paid" + " (4A)";
const title_expro = "[bold]For Expro (2B)";
const title_wop = "[bold]With WOP Turned-Over (3B)";
const title_handedOver = "[bold]HANDED-OVER"

const onStatisticField_total = "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END";
//////////////////////////////////////////
// 1. Legend
function legendPackage() {
  var total_cp101_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP101' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp101_lot",
  statisticType: "sum"
  };
  
  var total_cp102_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP102' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp102_lot",
  statisticType: "sum"
  };
  
  var total_cp103_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP103' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp103_lot",
  statisticType: "sum"
  };
  
  var total_cp104_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP104' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp104_lot",
  statisticType: "sum"
  };
  
  var total_cp105_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP105' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp105_lot",
  statisticType: "sum"
  };

  var total_cp108_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP108' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp108_lot",
  statisticType: "sum"
  };

  var total_cp109_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP109' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp109_lot",
  statisticType: "sum"
  };
  
  
  var query = lotLayer.createQuery();
  query.outStatistics = [total_cp101_lot,
                         total_cp102_lot, 
                         total_cp103_lot, 
                         total_cp104_lot,
                         total_cp105_lot,
                         total_cp108_lot,
                         total_cp109_lot
                        ];
  query.returnGeometry = true;
  query.where = queryStation;
  
  return lotLayer.queryFeatures(query).then(function(response) {
  var stats = response.features[0].attributes;
  
  const cp101 = stats.total_cp101_lot;
  const cp102 = stats.total_cp102_lot;
  const cp103 = stats.total_cp103_lot;
  const cp104 = stats.total_cp104_lot;
  const cp105 = stats.total_cp105_lot;
  const cp108 = stats.total_cp108_lot;
  const cp109 = stats.total_cp109_lot;
  const allCps = cp101 + cp102 + cp103 + cp104 + cp105 + cp108 + cp109;

  const legend_allCps = `All CPs (%), ${allCps}`;
  const legend_cp101 = `CP 101 (%), ${cp101}`;
  const legend_cp102 = `CP 102 (%), ${cp102}`;
  const legend_cp103 = `CP 103 (%), ${cp103}`;
  const legend_cp104 = `CP 104 (%), ${cp104}`;
  const legend_cp105 = `CP 105 (%), ${cp105}`;
  const legend_cp108 = `CP 108 (%), ${cp108}`;
  const legend_cp109 = `CP 109 (%), ${cp109}`;
  
  var chart = am4core.create("legendChartDiv", am4charts.PieChart);

  
  // Add data
  chart.data = [
  {
    "CP": legend_allCps,
    "status": cp109,
    "color": am4core.color(color_handedOver)
  },
  {
    "CP": legend_cp101,
    "status": cp101,
    "color": am4core.color(color_101)
  },
  {
    "CP": legend_cp102,
    "status": cp102,
    "color": am4core.color(color_102)
  },
  {
    "CP": legend_cp103,
    "status": cp103,
    "color": am4core.color(color_103)   
  },
  {
    "CP": legend_cp104,
    "status": cp104,
    "color": am4core.color(color_104) 
  },
  {
    "CP": legend_cp105,
    "status": cp105,
    "color": am4core.color(color_105)
  },
  {
    "CP": legend_cp108,
    "status": cp108,
    "color": am4core.color(color_108)
  },
  {
    "CP": legend_cp109,
    "status": cp109,
    "color": am4core.color(color_109)
  },

  ];
  
  // Set inner radius
  chart.innerRadius = am4core.percent(0);
  chart.radius = am4core.percent(0);
  // Add and configure Series
  
  function createSlices(field, status){
  var pieSeries = chart.series.push(new am4charts.PieSeries());
  pieSeries.dataFields.value = field;
  pieSeries.dataFields.category = status;
  pieSeries.disabled = true;
  pieSeries.slices.template.propertyFields.fill = "color";
  pieSeries.slices.template.stroke = am4core.color("#fff");
  pieSeries.slices.template.strokeWidth = 0;
  pieSeries.slices.template.strokeOpacity = 1;
  
  pieSeries.slices.template
  // change the cursor on hover to make it apparent the object can be interacted with
  .cursorOverStyle = [
  {
  "property": "cursor",
  "value": "pointer"
  }
  ];
  
  
  // Add a legend
  const LegendFontSizze = "1em";
  chart.legend = new am4charts.Legend();
  
  chart.legend.valueLabels.template.align = "right"
  chart.legend.valueLabels.template.textAlign = "end";  

  
  //chart.legend.position = "bottom";
  chart.legend.labels.template.fontSize = LegendFontSizze;
  chart.legend.labels.template.fill = "#ffffff";
  chart.legend.valueLabels.template.fill = am4core.color("#ffffff"); 

  //pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
  //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";
  
  // Responsive code for chart
  chart.responsive.enabled = true;
  chart.responsive.useDefault = false
  
  chart.responsive.rules.push({
  relevant: function(target) {
  if (target.pixelWidth <= 400) {
    return true;
  }
  return false;
  },
  state: function(target, stateId) {
  if (target instanceof am4charts.PieSeries) {
    var state = target.states.create(stateId);
        
    var labelState = target.labels.template.states.create(stateId);
    labelState.properties.disabled = true;
        
    var tickState = target.ticks.template.states.create(stateId);
    tickState.properties.disabled = true;
    return state;
  }
  if (target instanceof am4charts.Legend) {
    var state = target.states.create(stateId);
    state.properties.paddingTop = 0;
    state.properties.paddingRight = 0;
    state.properties.paddingBottom = 0;
    state.properties.paddingLeft = 0;
    state.properties.marginLeft = 0;
    return state;
  }
  return null;
  }
  });
  // Responsive code for chart
  
  // Chart Title
  //var title = chart.titles.create();
  //title.text = "Land"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
  //title.fontSize = 20;
  //title.fontWeight = "bold";
  //title.fill = "#ffffff";
  //title.marginTop = 5;
  
  var marker = chart.legend.markers.template.children.getIndex(0);
  var markerTemplate = chart.legend.markers.template;
  //marker.cornerRadius(12, 12, 12, 12); round legend marker
  marker.strokeWidth = 1;
  marker.strokeOpacity = 1;
  marker.stroke = am4core.color("#ccc");
  
  // Change size of legend marker
  markerTemplate.width = 18;
  markerTemplate.height = 18;
  // This creates initial animation
  //pieSeries.hiddenState.properties.opacity = 1;
  //pieSeries.hiddenState.properties.endAngle = -90;
  //pieSeries.hiddenState.properties.startAngle = -90;

  
  } // End of createSlices function
  
  createSlices("status", "CP");
  
  }); // End of queryFeatures
  } // End of updateChartLot()
  legendPackage();
  
  function legendPackage2() {
  var total_cp101_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP101' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp101_lot",
  statisticType: "sum"
  };
  
  var total_cp102_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP102' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp102_lot",
  statisticType: "sum"
  };
  
  var total_cp103_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP103' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp103_lot",
  statisticType: "sum"
  };
  
  var total_cp104_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP104' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp104_lot",
  statisticType: "sum"
  };
  
  var total_cp105_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP105' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp105_lot",
  statisticType: "sum"
  };

  var total_cp108_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP108' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp108_lot",
  statisticType: "sum"
  };

  var total_cp109_lot = {
  onStatisticField: "CASE WHEN (Package = 'CP109' and StatusNVS3 >=1) THEN 1 ELSE 0 END",
  outStatisticFieldName: "total_cp109_lot",
  statisticType: "sum"
  };
  
  
  var query = lotLayer.createQuery();
  query.outStatistics = [total_cp101_lot,
                         total_cp102_lot, 
                         total_cp103_lot, 
                         total_cp104_lot,
                         total_cp105_lot,
                         total_cp108_lot,
                         total_cp109_lot
                        ];
  query.returnGeometry = true;
  query.where = querySubterranean;
  
  return lotLayer.queryFeatures(query).then(function(response) {
  var stats = response.features[0].attributes;
  
  const cp101 = stats.total_cp101_lot;
  const cp102 = stats.total_cp102_lot;
  const cp103 = stats.total_cp103_lot;
  const cp104 = stats.total_cp104_lot;
  const cp105 = stats.total_cp105_lot;
  const cp108 = stats.total_cp108_lot;
  const cp109 = stats.total_cp109_lot;
  const allCps = cp101 + cp102 + cp103 + cp104 + cp105 + cp108 + cp109;

  const legend_allCps = `All CPs (%), ${allCps}`;
  const legend_cp101 = `CP 101 (%), ${cp101}`;
  const legend_cp102 = `CP 102 (%), ${cp102}`;
  const legend_cp103 = `CP 103 (%), ${cp103}`;
  const legend_cp104 = `CP 104 (%), ${cp104}`;
  const legend_cp105 = `CP 105 (%), ${cp105}`;
  const legend_cp108 = `CP 108 (%), ${cp108}`;
  const legend_cp109 = `CP 109 (%), ${cp109}`;
  
  var chart = am4core.create("legendChartDiv2", am4charts.PieChart);

  
  // Add data
  chart.data = [
  {
    "CP": legend_allCps,
    "status": cp109,
    "color": am4core.color(color_handedOver)
  },
  {
    "CP": legend_cp101,
    "status": cp101,
    "color": am4core.color(color_101)
  },
  {
    "CP": legend_cp102,
    "status": cp102,
    "color": am4core.color(color_102)
  },
  {
    "CP": legend_cp103,
    "status": cp103,
    "color": am4core.color(color_103)   
  },
  {
    "CP": legend_cp104,
    "status": cp104,
    "color": am4core.color(color_104) 
  },
  {
    "CP": legend_cp105,
    "status": cp105,
    "color": am4core.color(color_105)
  },
  {
    "CP": legend_cp108,
    "status": cp108,
    "color": am4core.color(color_108)
  },
  {
    "CP": legend_cp109,
    "status": cp109,
    "color": am4core.color(color_109)
  },

  ];
  
  // Set inner radius
  chart.innerRadius = am4core.percent(0);
  chart.radius = am4core.percent(0);
  // Add and configure Series
  
  function createSlices(field, status){
  var pieSeries = chart.series.push(new am4charts.PieSeries());
  pieSeries.dataFields.value = field;
  pieSeries.dataFields.category = status;
  pieSeries.disabled = true;
  pieSeries.slices.template.propertyFields.fill = "color";
  pieSeries.slices.template.stroke = am4core.color("#fff");
  pieSeries.slices.template.strokeWidth = 0;
  pieSeries.slices.template.strokeOpacity = 1;
  
  pieSeries.slices.template
  // change the cursor on hover to make it apparent the object can be interacted with
  .cursorOverStyle = [
  {
  "property": "cursor",
  "value": "pointer"
  }
  ];
  
  
  // Add a legend
  const LegendFontSizze = "1em";
  chart.legend = new am4charts.Legend();
  
  chart.legend.valueLabels.template.align = "right"
  chart.legend.valueLabels.template.textAlign = "end";  

  
  //chart.legend.position = "bottom";
  chart.legend.labels.template.fontSize = LegendFontSizze;
  chart.legend.labels.template.fill = "#ffffff";
  chart.legend.valueLabels.template.fill = am4core.color("#ffffff"); 

  //pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
  //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";
  
  // Responsive code for chart
  chart.responsive.enabled = true;
  chart.responsive.useDefault = false
  
  chart.responsive.rules.push({
  relevant: function(target) {
  if (target.pixelWidth <= 400) {
    return true;
  }
  return false;
  },
  state: function(target, stateId) {
  if (target instanceof am4charts.PieSeries) {
    var state = target.states.create(stateId);
        
    var labelState = target.labels.template.states.create(stateId);
    labelState.properties.disabled = true;
        
    var tickState = target.ticks.template.states.create(stateId);
    tickState.properties.disabled = true;
    return state;
  }
  if (target instanceof am4charts.Legend) {
    var state = target.states.create(stateId);
    state.properties.paddingTop = 0;
    state.properties.paddingRight = 0;
    state.properties.paddingBottom = 0;
    state.properties.paddingLeft = 0;
    state.properties.marginLeft = 0;
    return state;
  }
  return null;
  }
  });
  // Responsive code for chart
  
  // Chart Title
  //var title = chart.titles.create();
  //title.text = "Land"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
  //title.fontSize = 20;
  //title.fontWeight = "bold";
  //title.fill = "#ffffff";
  //title.marginTop = 5;
  
  var marker = chart.legend.markers.template.children.getIndex(0);
  var markerTemplate = chart.legend.markers.template;
  //marker.cornerRadius(12, 12, 12, 12); round legend marker
  marker.strokeWidth = 1;
  marker.strokeOpacity = 1;
  marker.stroke = am4core.color("#ccc");
  
  // Change size of legend marker
  markerTemplate.width = 18;
  markerTemplate.height = 18;
  // This creates initial animation
  //pieSeries.hiddenState.properties.opacity = 1;
  //pieSeries.hiddenState.properties.endAngle = -90;
  //pieSeries.hiddenState.properties.startAngle = -90;

  
  } // End of createSlices function
  
  createSlices("status", "CP");
  
  }); // End of queryFeatures
  } // End of updateChartLot()
  

//////////////////////////////////////////////
///////////////////  Stations ///////////////////
//////////////////////////////////////////////

/// 2. Land (in only Station)
function lotPaidTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function paidLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of paidLotSummary function

function paidLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("paidChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_paid;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotPaidTotalCount().then(paidLotSummary).then(paidLotChart);

// 3. For Payment Processing
function lotPaypTotalCount() {
    var total_number_lot = {
        onStatisticField: "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        console.log(totalNumberLot);
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function paypLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of paypLotSummary function

function paypLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("paypChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_payp;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotPaypTotalCount().then(paypLotSummary).then(paypLotChart);


// 4. For Legal Pass
function lotlegalpassTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function legalpassLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of legalpassLotSummary function

function legalpassLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("legalpChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_legalp;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotlegalpassTotalCount().then(legalpassLotSummary).then(legalpassLotChart);



// 5. For Appraisal/Offer to Buy
function lotappraisalTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function appraisalLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of appraisalLotSummary function

function appraisalLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("appraisalChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_otb;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotappraisalTotalCount().then(appraisalLotSummary).then(appraisalLotChart);

// 6. For Expro
function lotExproTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function exproLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of exproLotSummary function

function exproLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("exproChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_expro;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotExproTotalCount().then(exproLotSummary).then(exproLotChart);


// 7. With WOP Fully tunr...
function lotWopTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function wopLotSummary([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of wopLotSummary function

function wopLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("wopChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_wop;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotWopTotalCount().then(wopLotSummary).then(wopLotChart);


// Handed over
function lotHandedOverTotalCount() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_handedOver = {
        onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_handedOver",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_handedOver];
    query.where = queryStation;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberHandedOver = stats.total_number_handedOver;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberHandedOver];
        
    });
}

function handedOverLotSummary([totalNumberLot, totalNumberHandedOver]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_handedOver_cp = {
        onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_handedOver_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_handedOver_cp];
    query.returnGeometry = true;
    query.where = queryStation;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const handedover_lot = attributes.total_number_lot_cp;
        const handedover_CP = attributes.total_number_handedOver_cp;
        
        const HANDEDOVER_CP_PERC = (handedover_CP/totalNumberLot)*100;
        const handedover_cp_perc = (handedover_CP/handedover_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(HANDEDOVER_CP_PERC);
            cp101_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(HANDEDOVER_CP_PERC);
            cp102_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(HANDEDOVER_CP_PERC);
            cp103_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(HANDEDOVER_CP_PERC);
            cp104_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(HANDEDOVER_CP_PERC);
            cp105_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(HANDEDOVER_CP_PERC);
            cp108_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(HANDEDOVER_CP_PERC);
            cp109_a.push(handedover_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of wopLotSummary function

function handedOverLotChart([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
  var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

  var CP101 = Number(cp101);
  var CP102 = Number(cp101) + Number(cp102);
  var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
  var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
  var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
  var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
  var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

  var chartMin = 0;
  var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("handedOverChartDiv", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_handedOver;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/



}
lotHandedOverTotalCount().then(handedOverLotSummary).then(handedOverLotChart);


//////////////////////////////////////////////
////////////////  Subterranean ///////////////
//////////////////////////////////////////////

/// 2. Land (in only Station)
function lotPaidTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function paidLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of paidLotSummary function

function paidLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("paidChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_paid;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotPaidTotalCount2().then(paidLotSummary2).then(paidLotChart2);

// 3. For Payment Processing
function lotPaypTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function paypLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of paypLotSummary function

function paypLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("paypChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_payp;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotPaypTotalCount2().then(paypLotSummary2).then(paypLotChart2);


// 4. For Legal Pass
function lotlegalpassTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function legalpassLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of legalpassLotSummary function

function legalpassLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("legalpChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_legalp;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotlegalpassTotalCount2().then(legalpassLotSummary2).then(legalpassLotChart2);



// 5. For Appraisal/Offer to Buy
function lotappraisalTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function appraisalLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of appraisalLotSummary function

function appraisalLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("appraisalChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_otb;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotappraisalTotalCount2().then(appraisalLotSummary2).then(appraisalLotChart2);

// 6. For Expro
function lotExproTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function exproLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of exproLotSummary function

function exproLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("exproChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_expro;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotExproTotalCount2().then(exproLotSummary2).then(exproLotChart2);


// 7. With WOP Fully tunr...
function lotWopTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_paid = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_paid];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberPaid = stats.total_number_paid;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberPaid];
        
    });
}

function wopLotSummary2([totalNumberLot, totalNumberPaid]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_paid_cp = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_paid_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_paid_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const paid_lot = attributes.total_number_lot_cp;
        const paid_CP = attributes.total_number_paid_cp;
        
        const PAID_CP_PERC = (paid_CP/totalNumberLot)*100;
        const paid_cp_perc = (paid_CP/paid_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(PAID_CP_PERC);
            cp101_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(PAID_CP_PERC);
            cp102_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(PAID_CP_PERC);
            cp103_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(PAID_CP_PERC);
            cp104_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(PAID_CP_PERC);
            cp105_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(PAID_CP_PERC);
            cp108_a.push(paid_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(PAID_CP_PERC);
            cp109_a.push(paid_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of wopLotSummary function

function wopLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

var CP101 = Number(cp101);
var CP102 = Number(cp101) + Number(cp102);
var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

var chartMin = 0;
var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("wopChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_wop;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/

}
lotWopTotalCount2().then(wopLotSummary2).then(wopLotChart2);


// Handed over
function lotHandedOverTotalCount2() {
    var total_number_lot = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot",
        statisticType: "sum"
    };

    var total_number_handedOver = {
        onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_handedOver",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot, total_number_handedOver];
    query.where = querySubterranean;

    return lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const totalNumberLot = stats.total_number_lot;
        const totalNumberHandedOver = stats.total_number_handedOver;
        //const LOT_HANDOVER_PERC = (handedOver/affected)*100;
        return [totalNumberLot, totalNumberHandedOver];
        
    });
}

function handedOverLotSummary2([totalNumberLot, totalNumberHandedOver]) {
    var total_number_lot_cp = {
        onStatisticField: onStatisticField_total,
        outStatisticFieldName: "total_number_lot_cp",
        statisticType: "sum"
    };

    var total_number_handedOver_cp = {
        onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_handedOver_cp",
        statisticType: "sum"
    };

    var query = lotLayer.createQuery();
    query.outStatistics = [total_number_lot_cp, total_number_handedOver_cp];
    query.returnGeometry = true;
    query.where = querySubterranean;
    query.groupByFieldsForStatistics = ["Package"];

    var cp101 = [];
    var cp101_a = [];

    var cp102 = [];
    var cp102_a = [];

    var cp103 = [];
    var cp103_a = [];

    var cp104 = [];
    var cp104_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp105 = [];
    var cp105_a = [];

    var cp108 = [];
    var cp108_a = [];

    var cp109 = [];
    var cp109_a = [];

return lotLayer.queryFeatures(query).then(function(response) {
    stats = response.features;

    stats.forEach((result, index) => {
        const attributes = result.attributes;
        const cpPackage = attributes.Package;
        const handedover_lot = attributes.total_number_lot_cp;
        const handedover_CP = attributes.total_number_handedOver_cp;
        
        const HANDEDOVER_CP_PERC = (handedover_CP/totalNumberLot)*100;
        const handedover_cp_perc = (handedover_CP/handedover_lot)*100;

        //
        if (cpPackage === 'CP101') {
            cp101.push(HANDEDOVER_CP_PERC);
            cp101_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP102') {
            cp102.push(HANDEDOVER_CP_PERC);
            cp102_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP103') {
            cp103.push(HANDEDOVER_CP_PERC);
            cp103_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP104') {
            cp104.push(HANDEDOVER_CP_PERC);
            cp104_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP105') {
            cp105.push(HANDEDOVER_CP_PERC);
            cp105_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP108') {
            cp108.push(HANDEDOVER_CP_PERC);
            cp108_a.push(handedover_cp_perc);

        } else if (cpPackage === 'CP109') {
            cp109.push(HANDEDOVER_CP_PERC);
            cp109_a.push(handedover_cp_perc);

        }

    });
    return [cp101, cp102, cp103, cp104, cp105, cp108, cp109,
            cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a];
});

} // End of wopLotSummary function

function handedOverLotChart2([cp101, cp102, cp103, cp104, cp105, cp108, cp109, cp101_a, cp102_a, cp103_a, cp104_a, cp105_a, cp108_a, cp109_a]) {
  var totalScore = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);

  var CP101 = Number(cp101);
  var CP102 = Number(cp101) + Number(cp102);
  var CP103 = Number(cp101) + Number(cp102) + Number(cp103);
  var CP104 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104);
  var CP105 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105);
  var CP108 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108);
  var CP109 = Number(cp101) + Number(cp102) + Number(cp103) + Number(cp104) + Number(cp105) + Number(cp108) + Number(cp109);

  var chartMin = 0;
  var chartMax = 100;

// #ffea8c|#b3ab60|#4b595e|#6693c8|#aadbff
// const colors = ["#ffea8c", "#b3ab60", "#4b595e", "#6693c8", "#aadbff"];

var data = {
score: totalScore,
gradingData: [
{
  title: isNaN(cp101_a) ? "" : Number(cp101_a).toFixed(0),
  color: color_101,
  lowScore: 0,
  highScore: CP101
},
{
  title: isNaN(cp102_a) ? "" : Number(cp102_a).toFixed(0),
  color: color_102,
  lowScore: CP101,
  highScore: CP102
},
{
  title: isNaN(cp103_a) ? "" : Number(cp103_a).toFixed(0),
  color: color_103,
  lowScore: CP102,
  highScore: CP103
},
{
  title: isNaN(cp104_a) ? "" : Number(cp104_a).toFixed(0),
  color: color_104,
  lowScore: CP103,
  highScore: CP104
},
{
  title: isNaN(cp105_a) ? "" : Number(cp105_a).toFixed(0),
  color: color_105,
  lowScore: CP104,
  highScore: CP105
},
{
  title: isNaN(cp108_a) ? "" : Number(cp108_a).toFixed(0),
  color: color_108,
  lowScore: CP105,
  highScore: CP108
},
{
  title: isNaN(cp109_a) ? "" : Number(cp109_a).toFixed(0),
  color: color_109,
  lowScore: CP108,
  highScore: CP109
},
{
  title: "",
  color: "#C5C5C5",
  lowScore: CP105,
  highScore: 100
}
]
};

/**
Grading Lookup
*/
function lookUpGrade(lookupScore, grades) {
// Only change code below this line
for (var i = 0; i < grades.length; i++) {
if (
  grades[i].lowScore < lookupScore &&
  grades[i].highScore >= lookupScore
) {
  return grades[i];
}
}
return null;
}

// create chart
var chart = am4core.create("handedOverChartDiv2", am4charts.GaugeChart);
chart.hiddenState.properties.opacity = 0;
chart.fontSize = 11;
chart.innerRadius = am4core.percent(80);
chart.resizable = true;
chart.responsive.enabled = true;
/**
* Chart Title
*/
// Title Color
const BOTTOM_LABEL_COL = am4core.color("#FFA500");
const TOP_TITLE_COL = am4core.color("#FFFFFF");

var title = chart.titles.create();
//title.text = "[bold]EXISTING STRUCTURE";
title.text = title_handedOver;
title.fontSize = "1.8em";
title.align = "center";
title.marginBottom = -10;
title.marginTop = 0;
title.fill = TOP_TITLE_COL;

// Add bottom label
/*
var label = chart.chartContainer.createChild(am4core.Label);
label.text = "[bold]PAID";
label.fontSize = "1.4em";
label.align = "center";
label.marginTop = 0;
label.fill = BOTTOM_LABEL_COL;
*/
/**
* Normal axis
*/

var axis = chart.xAxes.push(new am4charts.ValueAxis());
axis.min = chartMin;
axis.max = chartMax;
axis.strictMinMax = true;
axis.renderer.radius = am4core.percent(80);
axis.renderer.inside = true;
axis.renderer.line.strokeOpacity = 0.5; // line opacity inside curve line
axis.renderer.ticks.template.disabled = false;
axis.renderer.ticks.template.strokeOpacity = 1;
//axis.renderer.ticks.template.strokeWidth = 1;
axis.renderer.ticks.template.length = 10;
axis.renderer.ticks.template.stroke = am4core.color(axis1TickColor);
//axis.renderer.grid.template.disabled = true;
axis.renderer.labels.template.radius = am4core.percent(40);
axis.renderer.labels.template.fontSize = "1.2em"; // default: 1.2em inner radius axis percent labels (0 to 100%)
axis.renderer.labels.template.fill = am4core.color(axis1TickColor);

/**
* Axis for ranges
*/

var axis2 = chart.xAxes.push(new am4charts.ValueAxis());
axis2.min = chartMin;
axis2.max = chartMax;
axis2.strictMinMax = true;
axis2.renderer.labels.template.disabled = true;
axis2.renderer.ticks.template.disabled = true;
axis2.renderer.grid.template.disabled = true; // when true inside tick marks will disappear
axis2.renderer.grid.template.opacity = 0.5;
axis2.renderer.labels.template.bent = true;
axis2.renderer.labels.template.fill = am4core.color("#000");
axis2.renderer.labels.template.fontWeight = "bold";
axis2.renderer.labels.template.fillOpacity = 0.7; // 0.3 // category labels: N-01, N-02,....



/**
Ranges
*/

for (let grading of data.gradingData) {
var range = axis2.axisRanges.create();
range.axisFill.fill = am4core.color(grading.color);
range.axisFill.fillOpacity = 1;
range.axisFill.zIndex = -1;
range.value = grading.lowScore > chartMin ? grading.lowScore : chartMin;
range.endValue = grading.highScore < chartMax ? grading.highScore : chartMax;
range.grid.strokeOpacity = 0; // changes opacity of inside tick mark
range.stroke = am4core.color(grading.color).lighten(-0.1);
range.label.inside = true;
range.label.text = grading.title.toUpperCase();
range.label.inside = true;
range.label.location = 0.5;
range.label.inside = true;
range.label.radius = am4core.percent(10);
range.label.paddingBottom = -5; // ~half font size
range.label.fontSize = "1.4em"; // category label (i.e., N-01, N-02, ....)
}

var matchingGrade = lookUpGrade(data.score, data.gradingData);

/**
* Label 1 (total Percent)
*/

var label = chart.radarContainer.createChild(am4core.Label);
label.isMeasured = false;
label.fontSize = "3.5em";
label.x = am4core.percent(50);
label.y = am4core.percent(100);
label.paddingBottom = -5;
label.horizontalCenter = "middle";
label.verticalCenter = "bottom";
//label.dataItem = data;
label.text = data.score.toFixed(0).toString() + "%";
//label.text = "{score}";
//label.fill = am4core.color(matchingGrade.color);
label.fill =  am4core.color("#00C3FF");

/**
* Label 2
*/

/*
var label2 = chart.radarContainer.createChild(am4core.Label);
label2.isMeasured = false;
label2.fontSize = "2em";
label2.horizontalCenter = "middle";
label2.verticalCenter = "bottom";
label2.text = matchingGrade.title.toUpperCase();
//label2.fill = am4core.color(matchingGrade.color);
label2.fill =  am4core.color("#00C3FF");
*/
/**
* Hand
*/

var hand = chart.hands.push(new am4charts.ClockHand());
hand.axis = axis2;
hand.innerRadius = am4core.percent(55);
hand.startWidth = 8;
hand.pin.disabled = true;
hand.value = data.score;
hand.fill = am4core.color("#000000"); // inner color of needle
//hand.stroke = am4core.color("#000");
hand.fillOpacity = 0.5;

/*
hand.events.on("positionchanged", function(){
label.text = axis2.positionToValue(hand.currentPosition).toFixed(0).toString() + "%";
var value2 = axis.positionToValue(hand.currentPosition);
var matchingGrade = lookUpGrade(axis.positionToValue(hand.currentPosition), data.gradingData);
label2.text = matchingGrade.title.toUpperCase();
label2.fill = am4core.color(matchingGrade.color);
label2.stroke = am4core.color(matchingGrade.color);  
label.fill = am4core.color(matchingGrade.color);
})
*/
/*
setInterval(function() {
var value = chartMin + Math.random() * (chartMax - chartMin);
hand.showValue(value, 1000, am4core.ease.cubicOut);
}, 2000);
*/



}
lotHandedOverTotalCount2().then(handedOverLotSummary2).then(handedOverLotChart2);


  document.querySelector("#item-description").innerHTML = 
                              `
                              <p>1. This dashboard shows progress of land acquisition using gauges in the two sections: stations and subterranean.</p>
                              <p>2. Each gauge represents progress of individual land processes with overall progress including all CPs and individual CPs.</p>
                              <p>3. Overall progress per land process including all CPs is indicated at the bottom of each gauge.</p>
                              <p>4. Progress of individual CPs is displayed in the sliced areas of each gauge with respective colors from Legend.</p>
                              <p>5. <b>Click 'Station' or 'Subterranean'</b> tab at the screen top to view the respective progress of land acquisition.</p> 
                              <p>6. Values in the Legend represent the total number of lots of the respective CPs.
                             `;
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector(".inforClass").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;

        

        // update legend when Station or Subterranean is chosen
        document.querySelector("#thetabs").addEventListener("click", switchArea);
        function switchArea(event) {
          const value = event.target.className;
          if (value === 'Stations') {
            document.getElementById("legendChartDiv").style.display = 'block';
            document.getElementById("legendChartDiv2").style.display = 'none';
            legendPackage();

          } else {
            document.getElementById("legendChartDiv").style.display = 'none';
            document.getElementById("legendChartDiv2").style.display = 'block';
            legendPackage2();
          }

          
        }



}); // end am4core.ready()



});
</script>