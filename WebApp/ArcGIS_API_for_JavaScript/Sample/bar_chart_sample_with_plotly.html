<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
<title>SC1 Subcontractor Submissions</title>

    <style>
      
      html,
      body {
        padding: 0;
        margin: 0;
        background-color: black;       
      }

      #titleDiv {
        font-size: 2vw;
        color: white;
        background-color: green;


      }

      #viewDiv {
        padding: 0;
        margin: 0;
        height: 99%;
        width: 100%;
        background-color: black;
        flex: 1 1 auto;
        order: 1;
        overflow: hidden;
      }

      #chartDiv {
        z-index: 99;
        height: 40vh;
        width: 50%;
      }

    ::-webkit-scrollbar {
    display: none;
    }
    
      .sassy-theme .esri-legend .esri-legend__layer-cell--info {
        background-color: black;
        color: white;
        font-size: 12px;
      }

      .sassy-theme .esri-legend__layer-caption {
    display: none;
  }

    </style>

<link
rel="stylesheet"
href="https://js.arcgis.com/4.22/esri/themes/dark/main.css"
/>
<!-- Resources -->
<script src='https://cdn.plot.ly/plotly-2.12.1.min.js'></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://js.arcgis.com/4.22/"></script>


    <script>
      require([
        "esri/Basemap",
        "esri/Map",
        "esri/views/MapView",
        "esri/views/SceneView",
        "esri/layers/FeatureLayer",
        "esri/views/layers/support/FeatureFilter",
        "esri/layers/SceneLayer",
        "esri/layers/CSVLayer"
      ], function(Basemap, Map, MapView, SceneView, 
                  FeatureLayer, FeatureFilter,
                  SceneLayer,CSVLayer) {


var map = new Map({
              basemap: "gray-vector", // "streets-night-vector", basemap
              ground: "world-elevation"
        }); 
        //map.ground.surfaceColor = "#FFFF";
        //map.ground.opacity = 0.5;
         
var view = new SceneView({
            map: map,
            container: "viewDiv",
            environment: {
                background: {
                    type: "color", // autocasts as new ColorBackground()
                    color: [0, 0, 0, 1]
                    },
                    // disable stars
                    starsEnabled: false,
                    //disable atmosphere
                    atmosphereEnabled: false
                    }
        });

// Import Layer
var viaductLayer = new SceneLayer({
  portalItem: {
    id: "a9c0878766964fa794cc67bbf38b7a09",
    portal: {
      url: "https://gis.railway-sector.com/portal"
    }
  },
  outFields: ["*"]
});
map.add(viaductLayer);

titleDiv = document.getElementById("titleDiv");

// Define Year, Month, and Types
const years = [2021,2022];
const months = [1,2,3,4,5,6,7,8,9,10,11,12];
const typesN = [1,2,3,4,5];

const piles = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [2], 8: [], 9: [], 10: [], 11: [], 12: [], // 2021
               13: [], 14: [], 15: [], 16: [], 17: [], 18: [], 19: [2], 20: [], 21: [], 22: [], 23: [], 24: []} // 2022

const pileCap = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [2], 8: [], 9: [], 10: [], 11: [], 12: [], // 2021
               13: [], 14: [], 15: [], 16: [], 17: [], 18: [], 19: [2], 20: [], 21: [], 22: [], 23: [], 24: []} // 2022

const pier = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [2], 8: [], 9: [], 10: [], 11: [], 12: [], // 2021
               13: [], 14: [], 15: [], 16: [], 17: [], 18: [], 19: [2], 20: [], 21: [], 22: [], 23: [], 24: []} // 2022

const pierHead = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [2], 8: [], 9: [], 10: [], 11: [], 12: [], // 2021
               13: [], 14: [], 15: [], 16: [], 17: [], 18: [], 19: [2], 20: [], 21: [], 22: [], 23: [], 24: []} // 2022

const precast = {1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [2], 8: [], 9: [], 10: [], 11: [], 12: [], // 2021
               13: [], 14: [], 15: [], 16: [], 17: [], 18: [], 19: [2], 20: [], 21: [], 22: [], 23: [], 24: []} // 2022




const array = [];

/*
const obj = {
  Type: compType,
  Value: compValue,
  Date: compDate
}
*/

// Length of Year and Month array
var ylength = years.length;
var mlength = months.length;
var arr = new Array();

// Compile Year and Month in an empty Array
for(var i=years[0]; i<=years[ylength-1]; i++){
  for(var j=months[0]; j<=months[mlength-1]; j++){
    var ym = i.toString() + "-" + j.toString();
    arr.push(new Date(ym).toLocaleDateString('en-ZA'));
  }
}

// Calculate the total number of combinations


// OPTION 2: use forEach
// I could not return values using Promise when forEach is used
function compileAll(){
  typesN.forEach((types, index) => {
    arr.forEach((dates, index2) => {
     
      // Get Year and Month for date filter
      var newDate = new Date(dates);
      var year = newDate.getFullYear()
      var month = newDate.getMonth() + 1;
      var d = new Date(year, month, 0);
      var lastDay = d.getDate();

      var start = year + "-" + month + "-" + "01" + " 00:00:00";
      var end = year + "-" + month + "-" + lastDay + " 23:59:59";

      // Query and Filter
      var total_count = {
        onStatisticField: "CASE WHEN Status1 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_count",
        statisticType: "sum"
      }
      
      var query = viaductLayer.createQuery();
      query.outStatistics = [total_count];
      query.returnGeometry = true;
      query.where = "Type = " + types + " AND " + "end_date >= timestamp'" + start + "' and end_date <= timestamp '" + end + "'";
//      query.where = "Type = " + types + " AND " + "end_date >= date'" + start + "' and end_date <= date '" + end + "'";
   


      //viaductLayer.definitionExpression = "TargetDate <= date'" + timeExtent.end.getFullYear() + "-" + (timeExtent.end.getMonth()+1) + "-" + (timeExtent.end.getDate()) +"'";
 
    return viaductLayer.queryFeatures(query).then(function(response) {
      var stats = response.features[0].attributes;
      const total_complete = stats.total_count;

      // When the value is null, we want it to be zero.
      if(total_complete === null){
        proxy = 0;
      } else {
        proxy = total_complete;
      }

      

      // Concatenate the results;
      // Note that forEach give 
      if(types === 1) {
        piles[month].push(dates + "," + proxy);
      } else if (types === 2){
        pileCap[month].push(dates + "," + proxy);
      } else if (types === 3){
        pier[month].push(dates + "," + proxy);
      } else if (types === 4){
        pierHead[month].push(dates + "," + proxy);
      } else if (types === 5){
        precast[month].push(dates + "," + proxy);
      }

      //titleDiv.innerHTML = comp;
      displayFunction(piles);
      
      return piles;
      
    
    });
  });

});

} // End of compileAll() function

const pilesDatesArr = [];
const pilesValueArr = [];

function displayFunction(piles){
  var test = piles[1][0].split(',');
  //var testSplit = test.split(',');

  // testSplit[0]. dates = even numbers (0, 2, 4, 6, 8)
  

  // testSplit[1]. value = odd numbers (1, 3, 5, 7)
  //titleDiv.innerHTML = testSplit[1];

  // Compile Dates
  /// Piles
  //titleDiv.innerHTML = piles[12];
    // dates
      const pileTemp = piles[11][0].split(',');
      
      pilesDatesArr.push(pileTemp[0].toString());

      titleDiv.innerHTML = pilesDatesArr[0];
    
   

  



  //const ttt = collected.toString();
  //titleDiv.innerHTML = collected;
  //titleDiv.innerHTML = piles[1].length;
}
compileAll();

// OPTION 2: END




/*
// reference
const year = [2021,2022,2023];
const type = [1,2];

const array = {1:[],2:[],3:[],4:[],5:[],6:[]};
year.forEach((years, index) => {
  type.forEach((types, index2) => {
    //console.log(index + "," + index2 + "; " + years + ";" + types);
  });
});
    
//
*/
//query.where = "CP = '" + "N-01" + "'" + " AND " + "Type = " + typesN;
/*
viaductLayer.queryFeatures(query).then(function(response) {
    var stats = response.features[0].attributes;
    const total_complete = stats.total_count;
    titleDiv.innerHTML = total_complete;
   
});
*/





               

///******************************************************************************************************************
/*
// OPTION 1:
function summaryStats(){
  
  var total_count = {
    onStatisticField: "CASE WHEN Status1 = 4 THEN 1 ELSE 0 END",
    outStatisticFieldName: "total_count",
    statisticType: "sum"
  //query.having?
}

  var query = viaductLayer.createQuery();
query.outStatistics = [total_count];
query.returnGeometry = true;
//query.orderByFields = ["CP ASC"];
//query.groupByFieldsForStatistics = ["Type","CP"]

  //query.where = "CP = '" + cpN[i] + "'" + " AND " + "Type = " + typesN[j];
  query.where = "Type = " + typesN[i] + " AND " + "end_date >= date'" + '2022-04-01' + "' and end_date <= date '" + '2022-04-30' + "'";
  // better use Date
  /// const start = new Date(2019, 0, 1);
  /// const end = new Date(2022,0,1);
  // timeExtent = { start, end }
 // var theDefExp = "startDate < date'" + today.toLocaleDateString() + "' and endDate > date '" + today.toLocaleDateString() + "'";
  //query.where = "Type = " + typesN[i] + " AND " + "Date <= date'" + timeExtent.end.getFullYear() + "-" + (timeExtent.end.getMonth()+1) + "-" + (timeExtent.end.getDate()) +"'";
  //query.where = "Type = " + typesN[i] + " AND " + "Date >= date'" + '2021/01/1' + "'" + " AND " + "Date <= date'" + '2021/01/31' + "'";
  //EndDate = date'2020-6-3'"
  //viaductLayer.definitionExpression = "TargetDate <= date'" + timeExtent.end.getFullYear() + "-" + (timeExtent.end.getMonth()+1) + "-" + (timeExtent.end.getDate()) +"'";

 return viaductLayer.queryFeatures(query).then(function(response) {
    
    var stats = response.features[0].attributes;
    const total_complete = stats.total_count;
    if(total_complete === null){
      proxy = 0;
    } else {
      proxy = total_complete;
    }
    array.push(proxy);
    //text +=  + ":" + total_complete + "<br>";
    //titleDiv.innerHTML = array;

      return array;  
});

}

function displayFunction(array){
  titleDiv.innerHTML = array;
  //titleDiv.innerHTML = obj['Value'];
}


//for(var i=0; i<=4; i++){ // Type
//  for(var j=arr[0]; j<=arr[arr.length-1]; j++){
//    summaryStats().then(displayFunction);
//  }
//}

for(var i=0; i<=4; i++){ // Type
    summaryStats().then(displayFunction);

}
// OPTION 1: END
*/
///******************************************************************************************************************














// update view when points are updated
var trace1 = {
  x: arr,
  y: [12, 18, 29, 12, 4],
  name: 'SF Zoo',
  type: 'bar'
};

var trace2 = {
  x: arr,
  y: [12, 18, 29, 12, 4],
  name: 'LA Zoo',
  type: 'bar'
};

var data = [trace1, trace2];

var layout = {barmode: 'stack'};

Plotly.newPlot('chartDiv', data, layout);




      });
    </script>
  </head>

  <body class="sassy-theme">
    <div id="chartDiv"></div>
    <div id="titleDiv"></div>
    <div id="viewDiv"></div> 
  </body>
</html>