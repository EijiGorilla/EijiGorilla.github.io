<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
    <title>Station Structure (MMSP)</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.28/esri/themes/dark/main.css"
    />
    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js"
    ></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css"
    />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <!-- Resources -->
    <script src="https://js.arcgis.com/4.28/"></script>
  </head>

  <body class="calcite-mode-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">
        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>
        <div id="dateDiv"></div>
        <!-- Dropdown Lists -->
        <div id="dropdownDiv" class="esri-widget">
          <label id="dropdownStationLabel">
            STATION:
            <select id="stationSelect" class="esri-widget"></select>
          </label>
        </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" display-mode="float" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action
            data-action-id="layers"
            icon="layers"
            text="Layers"
          ></calcite-action>
          <calcite-action
            data-action-id="basemaps"
            icon="basemap"
            text="Basemaps"
          ></calcite-action>
          <calcite-action
            data-action-id="legend"
            icon="legend"
            text="Legend"
          ></calcite-action>
          <calcite-action
            data-action-id="charts"
            icon="graph-time-series"
            text="Progree Chart"
          ></calcite-action>
          <calcite-action
            data-action-id="information"
            icon="information"
            text="Information"
          ></calcite-action>
        </calcite-action-bar>

        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel
          heading="Layers"
          height-scale="l"
          data-panel-id="layers"
          hidden
        >
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel
          heading="Basemaps"
          height-scale="l"
          data-panel-id="basemaps"
          hidden
        >
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel
          heading="Legend"
          height-scale="l"
          data-panel-id="legend"
          hidden
        >
          <div id="legend-container"></div>
        </calcite-panel>

        <calcite-panel
          class="timeSeries-panel"
          height-scale="l"
          data-panel-id="charts"
          hidden
        >
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="viewDiv">
        <div id="chartPanel">
          <div id="totalProgressDiv"></div>
          <div id="chartDiv"></div>
        </div>
        <calcite-label layout="inline" id="see-through-label">
          <calcite-checkbox id="myLink"></calcite-checkbox>See-through-Ground
        </calcite-label>

        <div id="timeSeriesChart" hidden></div>
      </div>
    </calcite-shell>
  </body>
</html>

<style>
  html,
  body,
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }

  body {
    display: flex;
  }

  calcite-loader {
    align-self: center;
    justify-self: center;
  }

  calcite-label {
    position: fixed;
    z-index: 1;
    --calcite-label-margin-bottom: 0px;
    bottom: 1.5vw;
    right: 22vw;
  }

  #header-title {
    margin-left: 1rem;
    margin-right: 1rem;
  }

  #item-description b {
    color: orange;
    font-size: "1.1vw";
  }

  #info-content {
    padding: 0.75rem;
  }

  calcite-rating {
    margin-top: 0.25rem;
  }

  #header {
    display: flex;
    padding: 0 1rem;
    background-color: var(--calcite-ui-foreground-1);
    border: solid 0.5px #555555;
  }

  #header-controls {
    display: flex;
    margin-inline-start: auto;
    align-self: center;
  }

  .label-wrapper {
    display: flex;
    margin-inline: 1rem;
    padding: 0.5rem;
    border: 1px solid var(--calcite-ui-border-1);
    cursor: pointer;
  }

  calcite-switch {
    margin: 0 0.5rem;
  }

  #chartPanel {
    background-color: rgb(0, 0, 0, 0);
    width: 23vw;
    margin-right: 4vw;
  }

  #chartDiv {
    margin-top: 2vw;
    height: 30vw;
    width: 23vw;
  }

  #totalProgressDiv {
    margin-top: 1.5vw;
    width: 21vw;
    height: 12vh;
    text-align: center;
    font-weight: normal;
    font-size: 1.7vw;
    color: white;
  }

  #totalProgressDiv b {
    font-size: 2.7vw;
    color: rgb(0, 197, 255);
  }

  #dateDiv {
    font-size: 0.85vw;
    text-align: right;
    display: flex;
    align-items: flex-end;
    font-weight: bold;
  }

  /* Dropdown list */
  #dropdownDiv {
    background-color: rgb(0, 0, 0, 0);
    width: 50%;
    opacity: 1;
    color: white;
    text-align: center;
    margin: auto;
  }

  #timeSeriesChart {
    position: absolute;
    z-index: 1;
    height: 30%;
    width: 70%;
    bottom: 20;
    left: 5%;
    background-color: rgb(37, 37, 37);
  }

  #time-series {
    position: fixed;
    top: 15;
    right: 10;
    width: 12.5vw;
    height: 3.5vh;
  }

  .esri-view .esri-view-surface--touch-none:focus::after {
    outline: none !important;
  }

  /* Browser Setting */
  ::-webkit-scrollbar {
    display: none;
  }

  /*  */
  .sassy-theme .esri-legend__layer-caption {
    display: none;
  }

  .esri-layer-list__item-toggle-icon,
  .esri-layer-list__item-title {
    color: white;
  }

  .sassy-theme .esri-popup__header-title {
    width: 17vw;
    background-color: rgba(0, 0, 0, 0.8);
  }

  .sassy-theme .esri-menu,
  .sassy-theme .esri-popup__main-container,
  .sassy-theme .esri-popup .esri-popup__pointer-direction,
  .sassy-theme .esri-popup .esri-popup__button,
  .sassy-theme .esri-button,
  .sassy-theme .esri-input,
  .sassy-theme .esri-legend,
  .sassy-theme .esri-layer-list,
  .sassy-theme .esri-widget a {
    background-color: rgb(0, 0, 0, 0.7);
    color: #fff;
  }
</style>

<script>
  require([
    "esri/Basemap",
    "esri/Map",
    "esri/views/MapView",
    "esri/views/SceneView",
    "esri/layers/FeatureLayer",
    "esri/layers/support/FeatureFilter",
    "esri/layers/SceneLayer",
    "esri/layers/Layer",
    "esri/layers/TileLayer",
    "esri/layers/VectorTileLayer",
    "esri/layers/support/LabelClass",
    "esri/symbols/LabelSymbol3D",
    "esri/WebMap",
    "esri/WebScene",
    "esri/portal/PortalItem",
    "esri/portal/Portal",
    "esri/widgets/TimeSlider",
    "esri/widgets/Legend",
    "esri/widgets/LayerList",
    "esri/widgets/Fullscreen",
    "esri/rest/geometryService",
    "esri/rest/support/Query",
    "esri/rest/support/StatisticDefinition",
    "esri/symbols/WebStyleSymbol",
    "esri/TimeExtent",
    "esri/widgets/Expand",
    "esri/widgets/Editor",
    "esri/renderers/UniqueValueRenderer",
    "esri/widgets/support/DatePicker",
    "esri/widgets/FeatureTable",
    "esri/widgets/Compass",
    "esri/layers/ElevationLayer",
    "esri/Ground",
    "esri/widgets/BasemapToggle",
    "esri/widgets/BasemapGallery",
  ], function (
    Basemap,
    Map,
    MapView,
    SceneView,
    FeatureLayer,
    FeatureFilter,
    SceneLayer,
    Layer,
    TileLayer,
    VectorTileLayer,
    LabelClass,
    LabelSymbol3D,
    WebMap,
    WebScene,
    PortalItem,
    Portal,
    TimeSlider,
    Legend,
    LayerList,
    Fullscreen,
    geometryService,
    Query,
    StatisticDefinition,
    WebStyleSymbol,
    TimeExtent,
    Expand,
    Editor,
    UniqueValueRenderer,
    DatePicker,
    FeatureTable,
    Compass,
    ElevationLayer,
    Ground,
    BasemapToggle,
    BasemapGallery
  ) {
    let chartLayerView;
    ////////////////////////////////////////////////////

    // Add custom DEM to the default elevation layer of esri
    const worldElevation = new ElevationLayer({
      url: "//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",
    });

    const dem = new ElevationLayer({
      portalItem: {
        id: "68ecd53e3df14d768c0818d681314f7a",
        portal: {
          url: "https://gis.railway-sector.com/portal",
        },
      },
    });

    var map = new Map({
      basemap: "dark-gray-vector", // "streets-night-vector", basemap, topo-vector
      ground: new Ground({
        layers: [worldElevation, dem],
      }),
    });
    //map.ground.surfaceColor = "#FFFF";
    //map.ground.opacity = 0.1;

    var view = new SceneView({
      map: map,
      container: "viewDiv",
      viewingMode: "local",
      camera: {
        position: {
          x: 121.0322874,
          y: 14.6750462,
          z: 1000,
        },
        tilt: 65,
      },
      environment: {
        background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1],
        },
        // disable stars
        starsEnabled: false,
        //disable atmosphere
        atmosphereEnabled: false,
      },
    });

    view.ui.components = [];

    function catchAbortError(error) {
      if (error.name != "AbortError") {
        console.error(error);
      }
    }

    // Setup UI

    //*******************************//
    // Label Class Property Settings //
    //*******************************//
    // site photo labels
    var sitePhotoLabelClass = new LabelClass({
      symbol: {
        type: "label-3d", // autocasts as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text", // autocasts as new TextSymbol3DLayer()
            material: {
              color: "orange",
            },
            size: 15,
            color: "black",
            haloColor: "black",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "bold",
            },
          },
        ],
        verticalOffset: {
          screenLength: 40,
          maxWorldLength: 200,
          minWorldLength: 20,
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7],
          },
        },
      },
      labelPlacement: "above-center",
      labelExpressionInfo: {
        expression: 'DefaultValue($feature.Description, "no data")',
      },
    });

    // Station labels
    var stationLabelClass = new LabelClass({
      symbol: {
        type: "label-3d", // autocasts as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text", // autocasts as new TextSymbol3DLayer()
            material: {
              color: "white",
            },
            size: 15,
            color: "black",
            haloColor: "black",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "bold",
            },
          },
        ],
        verticalOffset: {
          screenLength: 40,
          maxWorldLength: 100,
          minWorldLength: 20,
        },
      },
      labelPlacement: "above-center",
      labelExpressionInfo: {
        expression: 'DefaultValue($feature.Station, "no data")',
      },
    });

    //*****************************//
    //      Renderer Settings      //
    //*****************************//
    // Photo Symbol
    function getUniqueValueSymbol(name, color, sizeS, util) {
      // The point symbol is visualized with an icon symbol. To clearly see the location of the point
      // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
      // of the point feature.
      if (util == "Existing") {
        return {
          type: "point-3d", // autocasts as new PointSymbol3D()
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              resource: {
                href: name,
              },
              size: sizeS,
              outline: {
                color: "white",
                size: 2,
              },
            },
          ],
          verticalOffset: {
            screenLength: 40,
            maxWorldLength: 100,
            minWorldLength: 20,
          },
          callout: {
            type: "line", // autocasts as new LineCallout3D()
            color: [128, 128, 128, 0.1],
            size: 0.2,
            border: {
              color: "grey",
            },
          },
        };
      } else {
        return {
          type: "point-3d", // autocasts as new PointSymbol3D()
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              resource: {
                href: name,
              },
              size: sizeS,
              outline: {
                color: "white",
                size: 2,
              },
            },
          ],
          verticalOffset: {
            screenLength: 40,
            maxWorldLength: 100,
            minWorldLength: 20,
          },
          callout: {
            type: "line",
            size: 0.5,
            color: [0, 0, 0],
            border: {
              color: [255, 255, 255, 0.7],
            },
          },
        };
      }
    }

    var photoSymbolRenderer = {
      type: "unique-value",
      valueExpression:
        "When($feature.Description == 'PHOTO','PHOTO',$feature.Description)",
      uniqueValueInfos: [
        {
          value: "PHOTO",
          label: "Photo Spot",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Photo_symbol.png",
            "#D13470",
            20,
            "Relocation"
          ),
        },
      ],
    };

    // Station Symbol
    function stationsSymbol(name) {
      return {
        type: "web-style", // autocasts as new WebStyleSymbol()
        name: name,
        styleName: "EsriIconsStyle", //EsriRealisticTransportationStyle, EsriIconsStyle
      };
    }

    // Station Renderer
    var stationsRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      field: "Name",
      defaultSymbol: stationsSymbol("Train"), //Backhoe, Train
    };

    // Legend Color for Structure Layer
    const colors = {
      1: [225, 225, 225, 0], // To be Constructed (white)
      2: [130, 130, 130, 0.3], // Under Construction
      3: [255, 0, 0, 0.6], // Delayed
      4: [0, 197, 255, 0.5], // Completed
    };

    //*******************************//
    // Import Layers                 //
    //*******************************//
    // TBM Alignment reference line:--------------
    let defaultTBMAlign = {
      type: "simple-line",
      color: [211, 211, 211, 0.8],
      style: "solid",
      width: 1,
    };

    // Station point feature
    var stationLayer = new FeatureLayer({
      portalItem: {
        id: "c34277793d164f248abb0926963ae92d",
        portal: {
          url: "https://gis.railway-sector.com/portal",
        },
      },
      layerId: 1,
      labelingInfo: [stationLabelClass],
      renderer: stationsRenderer,
      definitionExpression: "sector = 'MMSP'",
      popupEnabled: false,
      elevationInfo: {
        // this elevation mode will place points on top of
        // buildings or other SceneLayer 3D objects
        mode: "relative-to-ground",
      },
      //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
    });
    stationLayer.listMode = "hide";
    map.add(stationLayer);

    // Structure Layer
    var structureLayer = new SceneLayer({
      //structureLayer
      portalItem: {
        id: "1f03030cd36c4d83880427354fc05c66",
      },
      popupTemplate: {
        title: "<h5>{Status}</h5>",
        lastEditInfoEnabled: false,
        outFields: ["*"],
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Type",
                label: "Type of Structure",
              },
              {
                fieldName: "ID",
                label: "Structure ID",
              },
              {
                fieldName: "Status",
                label: "Construction Status",
              },
            ],
          },
        ],
      },
      elevationInfo: {
        mode: "absolute-height",
        offset: 0,
      },
      title: "Station Structure",
      // when filter using date, example below. use this format
      //definitionExpression: "EndDate = date'2020-6-3'"
    });
    structureLayer.listMode = "hide";
    map.add(structureLayer, 1);

    function renderStructureLayer() {
      const renderer = new UniqueValueRenderer({
        field: "Status",
      });

      for (let property in colors) {
        if (colors.hasOwnProperty(property)) {
          renderer.addUniqueValueInfo({
            value: property,
            symbol: {
              type: "mesh-3d",
              symbolLayers: [
                {
                  type: "fill",
                  material: {
                    color: colors[property],
                    colorMixMode: "replace",
                  },
                  edges: {
                    type: "solid", // autocasts as new SolidEdges3D()
                    color: [225, 225, 225, 0.8],
                  },
                },
              ],
            },
          });
        }
      }

      structureLayer.renderer = renderer;
    }

    renderStructureLayer();

    // TBM Tunnel used as a reference
    var tbmTunnelLayer = new FeatureLayer({
      portalItem: {
        id: "6992715c99d04df28fb93ca9ee9d2b5f",
        portal: {
          url: "https://gis.railway-sector.com/portal",
        },
      },
      layerId: 1,
      elevationInfo: {
        mode: "absolute-height", //"on-the-ground", relative-to-ground, absolute-height
        offset: -2,
      },
      //renderer: roundTubeSymbol,
      title: "TBM Segment",
      //definitionExpression: "sens='Aller'",
      outFields: ["*"],
      popupEnabled: false,
    });
    map.add(tbmTunnelLayer);

    const options = {
      profile: "circle",
      cap: "butt", // butt
      join: "miter",
      width: 5,
      height: 5,
      color: [200, 200, 200, 0.3],
      profileRotation: "all",
    };

    /* The colors used for the each transit line */
    const colorsTBM = {
      0: [225, 225, 225, 0.2], // To be Constructed
      1: [225, 225, 225, 0.2], // Completed
      2: [225, 225, 225, 0.2], // Delayed
    };

    function renderTransitLayer() {
      const renderer = new UniqueValueRenderer({
        field: "status",
      });

      for (let property in colorsTBM) {
        if (colorsTBM.hasOwnProperty(property)) {
          renderer.addUniqueValueInfo({
            value: property,
            symbol: {
              type: "line-3d",
              symbolLayers: [
                {
                  type: "path",
                  profile: options.profile,
                  material: {
                    color: colorsTBM[property],
                  },
                  width: options.width,
                  height: options.height,
                  join: options.join,
                  cap: options.cap,
                  anchor: "bottom",
                  profileRotation: options.profileRotation,
                },
              ],
            },
          });
        }
      }

      tbmTunnelLayer.renderer = renderer;
    }

    renderTransitLayer();

    // photo points
    // var photoLayer = new FeatureLayer({
    //   portalItem: {
    //     id: "bdbfa1159b6c4ef3a94e0c87462bc625",
    //     portal: {
    //       url: "https://gis.railway-sector.com/portal",
    //     },
    //   },
    //   //labelingInfo: [sitePhotoLabelClass],
    //   renderer: photoSymbolRenderer,
    //   elevationInfo: {
    //     mode: "relative-to-ground",
    //     featureExpressionInfo: {
    //       expression: "Geometry($feature).z * 0",
    //     },
    //     unit: "meters",
    //   },
    //   popupTemplate: {
    //     lastEditInfoEnabled: false,
    //     returnGeometry: true,
    //     content: [
    //       {
    //         type: "media",
    //         mediaInfos: [
    //           {
    //             title: "{Title}",
    //             type: "image",
    //             caption: "As of {DateTime}",
    //             value: {
    //               sourceURL: "{ImageURL}",
    //             },
    //           },
    //         ],
    //       },
    //     ],
    //   },
    // });
    // map.add(photoLayer, 1);

    // Radio Button Selection //
    // Selection of 'D-Wall' or 'Station Box' only for visualization (not chart)
    let structureLayerView;

    //*******************************//
    //      Progress Chart           //
    //*******************************//

    // Total progress //
    function perStationProgress() {
      var total_complete = {
        onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_complete",
        statisticType: "sum",
      };

      var total_obs = {
        onStatisticField: "Status",
        outStatisticFieldName: "total_obs",
        statisticType: "count",
      };
      var query = structureLayer.createQuery();
      query.outStatistics = [total_complete, total_obs];
      query.returnGeometry = true;
      structureLayer.queryFeatures(query).then(function (response) {
        var stats = response.features[0].attributes;

        const total_complete = stats.total_complete;
        const total_obs = stats.total_obs;
        const percent = ((total_complete / total_obs) * 100).toFixed(1);
        document.getElementById("totalProgressDiv").innerHTML = `
                                                            <div>Total Progress</div>
                                                            <b>${percent}%</b>
                                                            `;
      });
    }
    perStationProgress();

    /* Function for zooming to selected layers */
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function (response) {
        view
          .goTo(response.extent, {
            //response.extent
            speedFactor: 2,
          })
          .catch(function (error) {
            if (error.name != "AbortError") {
              console.error(error);
            }
          });
      });
    }

    const stationValue = document.getElementById("stationSelect");

    document.getElementById("dateDiv").innerHTML = "As of November 13, 2023"; //lastEditedDate;lastEditedDate;

    // Create Bar chart to show progress of station structure
    am5.ready(function () {
      // For Monitoring Chart
      // various properties setting
      const marginTop = 0;
      const marginLeft = 0;
      const marginRight = 0;
      const marginBottom = 0;
      const paddingTop = 0;
      const paddingLeft = 5;
      const paddingRight = 5;
      const paddingBottom = 15;

      const xAxisNumberFormat = "#'%'";
      const seriesBulletLabelFontSize = "1.5vw";

      // series line fill pattern
      const linePatternColorComplete = "#0070ff";
      const linePatternColorOpacityComplete = 0;
      const linePatternFillOpacityComplete = 0;

      const linePatternColorOpacityIncomplet = 0;
      const linePatternFillOpacityIncomplet = 1;
      const linePatternStrokeOpacityIncomplet = 0;

      // axis label
      const yAxisLabelFontSize = "1.2vw";
      const xAxisLabelFontSize = "0.8vw";
      const legendFontSize = "1vw";

      //
      class MyTheme extends am5.Theme {
        setupDefaultRules() {
          var theme = this;

          this.patterns = [
            am5.LinePattern.new(this._root, {
              color: am5.color(linePatternColorComplete),
              colorOpacity: linePatternColorOpacityComplete,
              fillOpacity: linePatternFillOpacityComplete,
            }),

            am5.LinePattern.new(this._root, {
              colorOpacity: linePatternColorOpacityIncomplet,
              fillOpacity: linePatternFillOpacityIncomplet,
              strokeOpacity: linePatternStrokeOpacityIncomplet,
            }),
          ];

          this.currentPattern = 0;
          this.rule("RoundedRectangle").setAll({
            fillOpacity: 1,
          });

          this.rule("RoundedRectangle").setup = function (target) {
            target.set("fillPattern", theme.patterns[theme.currentPattern]);
            theme.currentPattern++;
            if (theme.currentPattern == theme.patterns.length) {
              theme.currentPattern = 0;
            }
          };
        }
      }

      var root = am5.Root.new("chartDiv");
      root._logo.dispose();
      const type = [
        {
          type: "D-Wall",
          value: 1,
        },
        {
          type: "Column",
          value: 2,
        },
        {
          type: "Slab",
          value: 3,
        },
        {
          type: "Kings Post",
          value: 4,
        },
        {
          type: "Secant Pile",
          value: 5,
        },
        {
          type: "Column Head",
          value: 6,
        },
      ];

      function updateChart() {
        root.container.children.clear();

        var total_dwall_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 1 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_dwall_tobeC",
          statisticType: "sum",
        };

        var total_dwall_done = {
          onStatisticField:
            "CASE WHEN (Type = 1 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_dwall_done",
          statisticType: "sum",
        };

        // Column
        var total_column_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 2 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_column_tobeC",
          statisticType: "sum",
        };

        var total_column_done = {
          onStatisticField:
            "CASE WHEN (Type = 2 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_column_done",
          statisticType: "sum",
        };

        // Slab
        var total_slab_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 3 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_slab_tobeC",
          statisticType: "sum",
        };

        var total_slab_done = {
          onStatisticField:
            "CASE WHEN (Type = 3 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_slab_done",
          statisticType: "sum",
        };

        // King's Post
        var total_kingpost_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 4 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_kingpost_tobeC",
          statisticType: "sum",
        };

        var total_kingpost_done = {
          onStatisticField:
            "CASE WHEN (Type = 4 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_kingpost_done",
          statisticType: "sum",
        };

        // Secant Pile
        var total_secant_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 5 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_secant_tobeC",
          statisticType: "sum",
        };

        var total_secant_done = {
          onStatisticField:
            "CASE WHEN (Type = 5 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_secant_done",
          statisticType: "sum",
        };

        // Column Head
        var total_columnhead_tobeC = {
          onStatisticField:
            "CASE WHEN (Type = 6 and Status = 1) THEN 1 ELSE 0 END", // D-Wall and to be Constructed
          outStatisticFieldName: "total_columnhead_tobeC",
          statisticType: "sum",
        };

        var total_columnhead_done = {
          onStatisticField:
            "CASE WHEN (Type = 6 and Status = 4) THEN 1 ELSE 0 END", // D-Wall and Complete
          outStatisticFieldName: "total_columnhead_done",
          statisticType: "sum",
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [
          total_dwall_tobeC,
          total_dwall_done,
          total_column_tobeC,
          total_column_done,
          total_slab_tobeC,
          total_slab_done,
          total_kingpost_tobeC,
          total_kingpost_done,
          total_secant_tobeC,
          total_secant_done,
          total_columnhead_tobeC,
          total_columnhead_done,
        ];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function (response) {
          var stats = response.features[0].attributes;

          // D-wall
          const dwall_tobeC = stats.total_dwall_tobeC;
          const dwall_done = stats.total_dwall_done;

          // Column
          const column_tobeC = stats.total_column_tobeC;
          const column_done = stats.total_column_done;

          // Slab
          const slab_tobeC = stats.total_slab_tobeC;
          const slab_done = stats.total_slab_done;

          // King's Post
          const kingpost_tobeC = stats.total_kingpost_tobeC;
          const kingpost_done = stats.total_kingpost_done;

          // Secant pile
          const secant_tobeC = stats.total_secant_tobeC;
          const secant_done = stats.total_secant_done;

          // Secant pile
          const columnhead_tobeC = stats.total_columnhead_tobeC;
          const columnhead_done = stats.total_columnhead_done;

          // Set themes
          // https://www.amcharts.com/docs/v5/concepts/themes/
          root.setThemes([
            am5themes_Animated.new(root),
            am5themes_Responsive.new(root),
            //MyTheme.new(root)
          ]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          var chart = root.container.children.push(
            am5xy.XYChart.new(root, {
              panX: false,
              panY: false,
              layout: root.verticalLayout,
              marginTop: marginTop,
              marginLeft: marginLeft,
              marginRight: marginRight,
              marginBottom: marginBottom,
              paddingTop: paddingTop,
              paddingLeft: paddingLeft,
              paddingRight: paddingRight,
              paddingBottom: paddingBottom,
              scale: 0.9,
            })
          );

          var data = [
            {
              category: "Secant Pile",
              comp: secant_done,
              incomp: secant_tobeC,
            },
            {
              category: "Kings Post",
              comp: kingpost_done,
              incomp: kingpost_tobeC,
            },
            {
              category: "Slab",
              comp: slab_done,
              incomp: slab_tobeC,
            },
            {
              category: "Column",
              comp: column_done,
              incomp: column_tobeC,
            },
            {
              category: "D-Wall",
              comp: dwall_done,
              incomp: dwall_tobeC,
            },
            {
              category: "Column Head",
              comp: columnhead_done,
              incomp: columnhead_tobeC,
            },
          ];

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          var yRenderer = am5xy.AxisRendererY.new(root, {
            inversed: true,
          });
          var yAxis = chart.yAxes.push(
            am5xy.CategoryAxis.new(root, {
              categoryField: "category",
              renderer: yRenderer,
              tooltip: am5.Tooltip.new(root, {}),
            })
          );

          yRenderer.grid.template.setAll({
            location: 1,
          });

          // Label properties Y axis
          yAxis.get("renderer").labels.template.setAll({
            //oversizedBehavior: "wrap",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            //maxWidth: 150,
            fontSize: yAxisLabelFontSize,
          });

          yAxis.data.setAll(data);

          var xAxis = chart.xAxes.push(
            am5xy.ValueAxis.new(root, {
              min: 0,
              max: 100,
              strictMax: true,
              numberFormat: xAxisNumberFormat,
              calculateTotals: true,
              renderer: am5xy.AxisRendererX.new(root, {
                strokeOpacity: 0,
                strokeWidth: 1,
                stroke: am5.color("#ffffff"),
              }),
            })
          );

          // Label properties for yAxis (category axis)
          xAxis.get("renderer").labels.template.setAll({
            //oversizedBehavior: "wrap",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            //maxWidth: 150,
            fontSize: xAxisLabelFontSize,
          });

          // Add legend
          // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
          var legend = chart.children.push(
            am5.Legend.new(root, {
              centerX: am5.p50,
              x: am5.percent(70),
              y: am5.percent(100),
            })
          );

          legend.labels.template.setAll({
            oversizedBehavior: "truncate",
            fill: am5.color("#ffffff"),
            fontSize: legendFontSize,
            //scale: 0.8,
            //textDecoration: "underline"
            //width: am5.percent(200)
            //fontWeight: "300"
          });

          // Chart title
          /*
            chart.children.unshift(am5.Label.new(root, {
              text: "Construction Progress",
              fontSize: "1.5vw",
              fontWeight: "bold",
              textAlign: "center",
              fill: am5.color("#ffffff"),
              x: am5.percent(50),
              centerX: am5.percent(50),
              paddingTop: 5,
              paddingBottom: 8,
          }));
          */

          chart.get("colors").set("colors", [
            am5.color("#0070ff"), //
            am5.color("#000000"),
          ]);

          // Add series
          // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
          function makeSeries(name, fieldName) {
            var series = chart.series.push(
              am5xy.ColumnSeries.new(root, {
                name: name,
                stacked: true,
                xAxis: xAxis,
                yAxis: yAxis,
                baseAxis: yAxis,
                valueXField: fieldName,
                valueXShow: "valueXTotalPercent",
                categoryYField: "category",
              })
            );

            series.columns.template.setAll({
              tooltipText: "{name}: {valueX}", // "{categoryY}: {valueX}",
              tooltipY: am5.percent(90),
              //fill: am5.color("#ffffff")
              // 100% transparent for incomplete
              fillOpacity: fieldName == "incomp" ? 0 : 1,
            });
            series.data.setAll(data);

            // Make stuff animate on load
            // https://www.amcharts.com/docs/v5/concepts/animations/
            series.appear();

            series.bullets.push(function () {
              return am5.Bullet.new(root, {
                sprite: am5.Label.new(root, {
                  text:
                    "{valueX}" == 0
                      ? ""
                      : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                  fill: root.interfaceColors.get("alternativeText"),
                  opacity: fieldName == "incomp" ? 0 : 1,
                  fontSize: seriesBulletLabelFontSize,
                  centerY: am5.p50,
                  centerX: am5.p50,
                  populateText: true,
                }),
              });
            });

            series.columns.template.events.on("click", function (ev) {
              // Layer
              const SELECTED = ev.target.dataItem.dataContext.category;
              const find = type.find((emp) => emp.type === SELECTED);
              const typeSelect = find.value;

              if (fieldName === "incomp") {
                selectedStatus = 1;
              } else if (fieldName === "comp") {
                selectedStatus = 4;
              } else {
                selectedLayer = null;
              }

              var highlight = null;
              // Update layerView based on viaduct components being selected
              view
                .whenLayerView(structureLayer)
                .then(function (structureLayerView) {
                  structureLayerView.filter = {
                    where:
                      "Type = " +
                      typeSelect +
                      " AND " +
                      "Status = " +
                      selectedStatus,
                    //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'"
                  };

                  structureLayerView.queryFeatures().then(function (results) {
                    const ggg = results.features;
                    const rowN = ggg.length;

                    // Extract and obtain OBJECTID
                    let objID = [];
                    for (var i = 0; i < rowN; i++) {
                      var obj = results.features[i].attributes.OBJECTID;
                      objID.push(obj);
                    }
                    highlightSelect = structureLayerView.highlight([objID]);
                    if (highlightSelect) {
                      highlightSelect.remove();
                    }
                    // Reset selection by clicking anywhere on the map
                    view.on("click", function () {
                      structureLayerView.filter = null;
                      highlightSelect.remove();
                    });
                  });
                }); // whenLayerView
            }); // End of filterByChart

            legend.data.push(series);
          } // end of makeSeries
          makeSeries("Complete", "comp");
          makeSeries("Incomplete", "incomp");
          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          chart.appear(1000, 100);
        }); // End of queryFeatures function
      } // End of updateChart
      updateChart();

      // Time series chart for progress monitoring of viaduct components
      var root2 = am5.Root.new("timeSeriesChart");
      root2._logo.dispose();
      function timeSeriesChart(stationValue) {
        root2.container.children.clear();

        var total_complete_dwall = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_dwall",
          statisticType: "sum",
        };

        var total_complete_column = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 2) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_column",
          statisticType: "sum",
        };

        var total_complete_slab = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 3) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_slab",
          statisticType: "sum",
        };

        var total_complete_kingpost = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 4) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_kingpost",
          statisticType: "sum",
        };

        var total_complete_secant = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 5) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_secant",
          statisticType: "sum",
        };

        var total_complete_columnhead = {
          onStatisticField:
            "CASE WHEN (Status = 4 and Type = 6) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_complete_columnhead",
          statisticType: "sum",
        };

        var query = structureLayer.createQuery();
        // Define cut date properties for dates
        const cutDateValue = "2022-01-01";
        const numberDate = new Date(cutDateValue);
        const cutDate = numberDate.toLocaleDateString("en-US");
        const undefinedExpression =
          "end_date IS NOT NULL" +
          " AND " +
          "end_date >= date'" +
          cutDate +
          "'";
        const stationExpression =
          "end_date IS NOT NULL" +
          " AND " +
          "end_date >= date'" +
          cutDate +
          "'" +
          " AND " +
          "Station1 = '" +
          stationValue +
          "'";
        const queryDate =
          stationValue === undefined ? undefinedExpression : stationExpression;

        query.where = queryDate;
        query.outStatistics = [
          total_complete_dwall,
          total_complete_column,
          total_complete_slab,
          total_complete_kingpost,
          total_complete_secant,
          total_complete_columnhead,
        ];
        query.outFields = ["end_date"];
        query.orderByFields = ["end_date"];
        query.groupByFieldsForStatistics = ["end_date"];

        const dwall = [];
        const column = [];
        const slab = [];
        const kingpost = [];
        const secant = [];
        const columnhead = [];

        structureLayer.queryFeatures(query).then(function (response) {
          var stats = response.features;

          // collect all dates for each viaduct type
          const data = stats.map((result, index) => {
            const attributes = result.attributes;
            const date = attributes.end_date;

            const dwallCount = attributes.total_complete_dwall;
            const columnCount = attributes.total_complete_column;
            const slabCount = attributes.total_complete_slab;
            const kingpostCount = attributes.total_complete_kingpost;
            const secantCount = attributes.total_complete_secant;
            const columnheadCount = attributes.total_complete_columnhead;

            // comdwall in object
            return Object.assign(
              {},
              {
                date,
                dwall: dwallCount,
                column: columnCount,
                slab: slabCount,
                kingpost: kingpostCount,
                secant: secantCount,
                columnhead: columnheadCount,
              }
            );
          });

          // 6. Add to Chart

          // set themes
          root2.setThemes([am5themes_Animated.new(root2)]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          var chart = root2.container.children.push(
            am5xy.XYChart.new(root2, {
              panX: false,
              panY: false,
              wheelX: "panX",
              wheelY: "zoomX",
              layout: root2.verticalLayout,
            })
          );

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          var xRenderer = am5xy.AxisRendererX.new(root2, {
            //minGridDistance: 60,
            strokeOpacity: 1,
            strokeWidth: 1,
            stroke: am5.color("#ffffff"),
          });
          var xAxis = chart.xAxes.push(
            am5xy.DateAxis.new(root2, {
              // When you group data for series
              // Note you need to baseInterval timeUnit is 'day'
              // and groupIntervals timeUnit is 'month'
              maxDeviation: 0,
              groupData: true,
              baseInterval: {
                timeUnit: "day",
                count: 1,
              },
              // count:
              groupIntervals: [{ timeUnit: "month", count: 1 }],

              categoryField: "date",
              renderer: xRenderer,
              tooltip: am5.Tooltip.new(root2, {}),
            })
          );

          xRenderer.grid.template.setAll({
            location: 1,
          });

          // Label properties for yAxis (category axis)
          xAxis.get("renderer").labels.template.setAll({
            //oversizedBehavior: "wrap",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            //maxWidth: 150,
            fontSize: 12,
          });

          xAxis.data.setAll(data);

          var yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root2, {
              min: 0,
              renderer: am5xy.AxisRendererY.new(root2, {
                strokeOpacity: 0.1,
                minGridDistance: 60,
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: am5.color("#ffffff"),
              }),
            })
          );

          // Add yaxix title
          yAxis.children.unshift(
            am5.Label.new(root2, {
              rotation: -90,
              text: "Count",
              y: am5.p50,
              centerX: am5.p50,
              fill: am5.color("#ffffff"),
              fontSize: 11,
            })
          );

          yAxis.get("renderer").labels.template.setAll({
            //oversizedBehavior: "wrap",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            //maxWidth: 150,
            fontSize: 12,
          });

          // Add legend
          // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
          var legend = chart.children.push(
            am5.Legend.new(root2, {
              centerX: am5.p50,
              x: am5.p50,
            })
          );

          legend.labels.template.setAll({
            oversizedBehavior: "truncate",
            fill: am5.color("#ffffff"),
            fontSize: 17,
            scale: 0.8,
            //textDecoration: "underline"
            //width: am5.percent(200)
            //fontWeight: "300"
          });

          // Add series
          // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
          function makeSeries(name, fieldName) {
            var series = chart.series.push(
              am5xy.ColumnSeries.new(root2, {
                name: name,
                stacked: true,
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: fieldName,
                valueXField: "date",
                valueYGrouped: "sum",
              })
            );

            series.columns.template.setAll({
              tooltipText: "{name}, {categoryX}: {valueY}",
              tooltipY: am5.percent(10),
            });
            series.data.setAll(data);

            // Make stuff animate on load
            // https://www.amcharts.com/docs/v5/concepts/animations/
            series.appear();

            series.bullets.push(function () {
              return am5.Bullet.new(root2, {
                sprite: am5.Label.new(root2, {
                  text: "{valueY}",
                  fill: root2.interfaceColors.get("alternativeText"),
                  centerY: am5.p50,
                  centerX: am5.p50,
                  populateText: true,
                }),
              });
            });

            legend.data.push(series);
          }

          makeSeries("D-Wall", "dwall");
          makeSeries("Column", "column");
          makeSeries("Slab", "slab");
          makeSeries("Kings Post", "kingpost");
          makeSeries("Secant Pile", "secant");
          makeSeries("Column Head", "columnhead");
          chart.appear(1000, 100);
        }); // end of queryFeatures
      }
      timeSeriesChart();

      // Default selection = 'None'
      function defaultRenderer() {
        structureLayer.definitionExpression = null;
        zoomToLayer(structureLayer);
        updateChart();
      }
      defaultRenderer();

      function getValues() {
        var testArray = [];
        var query = structureLayer.createQuery();
        query.outFields = ["Station1"];
        structureLayer.returnGeometry = true;
        return structureLayer.queryFeatures(query).then(function (response) {
          var stats = response.features;
          stats.forEach((result, index) => {
            var attributes = result.attributes;
            const values = attributes.Station1;
            testArray.push(values);
          });
          return testArray;
        });
      }

      function getUniqueValues(values) {
        var uniqueValues = [];
        values.forEach(function (item, i) {
          if (
            (uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) &&
            item !== ""
          ) {
            uniqueValues.push(item);
            //headerTitleDiv.innerHTML = uniqueValues;
          }
        });
        return uniqueValues;
      }

      function addToSelect(values) {
        stationValue.options.length = 0;
        values.sort();
        values.unshift("None"); // Add 'None' to the array and place it to the beginning of the array
        values.forEach(function (value) {
          var option = document.createElement("option");
          option.text = value;
          stationValue.add(option);
        });
      }
      getValues().then(getUniqueValues).then(addToSelect);

      // click event handler for choices

      stationValue.addEventListener("click", filterByTest);
      function filterByTest(event) {
        const selectedID = event.target.value;
        if (selectedID === "None") {
          structureLayer.definitionExpression = null;
          zoomToLayer(structureLayer);
          updateChart();
          perStationProgress();
          timeSeriesChart();
        } else {
          structureLayer.definitionExpression =
            "Station1 = '" + selectedID + "'";
          zoomToLayer(structureLayer);
          updateChart();
          perStationProgress();
          timeSeriesChart(selectedID);
        }
      } // End of filterByTest

      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent =
          "MMSP STATION STRUCTURE";
        document.querySelector("#item-description").innerHTML = `
                                                              1. You can <b>filter data</b> by Station from a dropdown list in header panel.<br>
                                                              <br>2. You can view construction progress in bar charts.<br>
                                                              <br>3. <b>Click column series in chart</b> to view selected structural components on the map.<br>
                                                              <br>4. <b>Click 'Progress Chart'</b> in header panel to view time-series construction progress.<br>
                                                              <br>5. Click/unclick widgets icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                            `;
        const timeSeriesChartDiv = document.getElementById("timeSeriesChart");
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(
              `[data-action-id=${activeWidget}]`
            ).active = false;
            document.querySelector(
              `[data-panel-id=${activeWidget}]`
            ).hidden = true;
          }

          // Close the progress time series chart when chart widget is closed
          if (`${activeWidget}` === "charts") {
            //document.getElementById("land-checkbox").checked = false;
            timeSeriesChartDiv.style.display = "none";
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(
              `[data-action-id=${nextWidget}]`
            ).active = true;
            document.querySelector(
              `[data-panel-id=${nextWidget}]`
            ).hidden = false;
            activeWidget = nextWidget;

            // Open the time series chart when chart widget is opened.
            if (`${activeWidget}` === "charts") {
              //document.getElementById("land-checkbox").checked = true;
              timeSeriesChartDiv.style.display = "block";
            }
          } else {
            activeWidget = null;
          }
        };

        // Action bar
        document
          .querySelector("calcite-action-bar")
          .addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", (event) => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45,
          };
        });
      }); // end of view.when
    }); // End of am5

    const basemaps = new BasemapGallery({
      view,
      container: "basemaps-container",
    });

    // LayerList and Add legend to the LayerList
    // On-off feature layer tab
    var layerList = new LayerList({
      view: view,
      container: "layers-container",
      listItemCreatedFunction: function (event) {
        const item = event.item;
        if (
          item.title === "Chainage" ||
          item.title === "ROW" ||
          item.title === "TBM Segment"
        ) {
          item.visible = false;
        }
      },
    });

    var legend = new Legend({
      view,
      container: "legend-container",
      layerInfos: [
        {
          layer: stationLayer,
          title: "Station",
        },
        {
          layer: structureLayer,
          title: "Station Structure",
        },
        // {
        //   layer: photoLayer,
        //   title: "Site Photo",
        // },
      ],
    });

    view.ui.empty("top-left");

    // Compass
    var compass = new Compass({
      view: view,
    });
    // adds the compass to the top left corner of the MapView
    view.ui.add(compass, "top-right");

    // See-through-Ground
    view.when(function () {
      // allow navigation above and below the ground
      map.ground.navigationConstraint = {
        type: "none",
      };
      // the webscene has no basemap, so set a surfaceColor on the ground
      map.ground.surfaceColor = "#fff";

      // to see through the ground, set the ground opacity to 0.4
      map.ground.opacity = 0.9;
    });

    document
      .getElementById("myLink")
      .addEventListener("click", function (event) {
        const checked = event.srcElement.checked;
        map.ground.opacity = event.srcElement.checked ? 0.1 : 0.6;
      });
  });
</script>
