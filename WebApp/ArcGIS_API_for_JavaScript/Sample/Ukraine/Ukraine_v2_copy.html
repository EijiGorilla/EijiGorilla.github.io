<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.26/"></script>
  </head>
  
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    /*NOTE: If you add padding to calcite-tab, width of 'calcite-tabs' */
    /* must be greater than that of 'calcite-tab'. Otherwise, */
    /* You will not see any space after padding. */

    calcite-button {
      position: absolute;
      z-index: 99;
      bottom: 50;
      right: 10;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    #messageDiv {
      padding-left: 10px;
      padding-right: 10px;
    }

    #chartPanel {
      width: 25vw;
    
    }

    #chartHospitalDiv {
      width: 21vw;
      height: 47vh;
    }

    .panel {
      position: fixed;
      z-index: 1;
      padding: 0px;
      box-sizing: border-box;
      width: 30vw;
      height: 10vh;
      position: absolute;
      top: 1.8%;
      right: 10%;
      font-size: 1.5vw;
      color: white;
      background-color: rgb(0, 0, 0, 0);
      overflow: auto;
      transition: 3;
    }

    h6 {
      color: rgb(0, 197, 255);
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      text-align: center;
      font-weight: normal;
      font-size: 1vw;
      }
  
  .active, .test:hover {
    background-color: rgba(77, 75, 75, 0);
    color: orange;
    font-size: 2.3vw;
  }

  /* Esris Setting */
  .esri-layer-list__item-toggle-icon,
    .esri-layer-list__item-title {
    color: white;
  }

  .sassy-theme .esri-popup__header-title {
    width: 25vw;
    background-color: rgba(0, 0, 0, 0.8);
  }
    
  .sassy-theme .esri-menu,
  .sassy-theme .esri-popup__main-container,
  .sassy-theme .esri-popup .esri-popup__pointer-direction,
  .sassy-theme .esri-popup .esri-popup__button,
  .sassy-theme .esri-button,
  .sassy-theme .esri-input,
  .sassy-theme .esri-layer-list,
  .sassy-theme .esri-widget {
    background-color: rgb(0, 0, 0, 0.5);
    color: #fff;
  }

  .sassy-theme .esri-legend--card__carousel-indicator-container,
  .sassy-theme .esri-legend__group-layer-child,
  .sassy-theme .esri-legend__layer-body {
    background-color: rgba(0, 0, 0, 0.5);
  }

  .esri-legend__layer-caption {
    display: none;
  }

  /* Browser Setting */
  ::-webkit-scrollbar {
    display: none;
  }
  
  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">
        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>
        <div id="dateDiv">February 27, 2023</div>
      </div>
      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>
        <div id="viewDiv">
          <div class="panel">
            <ul id="damageFactorList">
              <li style="display:inline" class="test active" id="Hospital">Hospital / </li>
                <li style="display:inline" class="test" id="Bridge">Bridge</li>
            </ul>
          </div>
          <div id="chartPanel">
            <div class="boxHospital" id="chartHospitalDiv"></div>
            <div class="boxBridge" id="chartBridgeDiv"></div>
          </div>
        </div>
    </calcite-shell>
  </body>
  <script>
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/TileLayer",
        "esri/Graphic",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/layers/GroupLayer",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/rest/support/Query",
        "esri/widgets/Fullscreen",
        "esri/symbols/TextSymbol",
        "esri/views/SceneView",
        "esri/widgets/LayerList",
        "esri/widgets/BasemapGallery"
      ], function(Map, MapView, TileLayer, Graphic, FeatureLayer, GraphicsLayer, GroupLayer,
              Expand, Legend, Query, Fullscreen, TextSymbol,
              SceneView, LayerList, BasemapGallery) {
                
                
    const worldImagery = new TileLayer({
      portalItem: {
        id: "10df2279f9684e4a9f6a7f08febac2a9" // world imagery
      },
      popupEnabled: false
    });
    worldImagery.listMode = "hide";

    worldImagery.when(() => {
      worldImagery.sublayers.forEach((layer) => {
        if (layer.popupEnabled === true) {
          layer.popupEnabled = false;
        }
      });
    });

    // https://developers.arcgis.com/javascript/latest/sample-code/effect-blur-shadow/
    // Ukraine - hospital layer

    const labelClass = {  // autocasts as new LabelClass()
      symbol: {
        type: "text",  // autocasts as new TextSymbol()
        color: "white",
        //haloColor: "blue",
        //haloSize: 1,
        font: {  // autocast as new Font()
          size: 20,
          weight: "bold"
        }
      },
      labelPlacement: "above-right",
      labelExpressionInfo: {
        expression: "$feature.Name"
      },
      maxScale: 0,
      minScale: 25000000
    };

  let textSymbol = {
    type: "text",  // autocasts as new TextSymbol()
    color: "white",
    //haloColor: "black",
    //haloSize: "1px",
    text: "Ukraine",
    xoffset: 190,
    yoffset: -200,
    font: {  // autocasts as new Font()
      size: 20,
      weight: "bold"
    }
  };

  // Military front line
  var frontLine = new FeatureLayer({
      portalItem: {
          id: "5707eb58d6a7452cbc783ee458ea6b8a"
      },
      title: "Military Frontline",
      layerId: 85,
      popupEnabled: false
  });

  // Hospital Damage Rating
  var hospitalLayer = new FeatureLayer({
      portalItem: {
          id:"5707eb58d6a7452cbc783ee458ea6b8a"
      },
      title: "Hospital Damage Rating",
      layerId: 4,
      outFields: ["*"],
      popupTemplate: {
        title: "Damage Status: {Damage} <br>Restoration Cost: {Cost}</br>",
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "amenity",
                label: "Amenity"
              }
            ]
          }
        ]
      },
      definitionExpression: "Note = 'Kyiv'"
  });

  // Hospital Restoration Cost
  var hospitalCostLayer = new FeatureLayer({
    portalItem: {
        id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Hospital Restoration Cost",
    layerId: 36,
    outFields: ["*"],
    popupTemplate: {
      title: "Restoration Cost for this hospital is ${Cost}",
      returnGeometry: true
    },
    definitionExpression: "Note = 'Kyiv'"
  });

  // Bridge Damage Rating
  var bridgeLayer = new FeatureLayer({
    portalItem: {
        id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Bridge Damage Rating",
    layerId: 33,
    outFields: ["*"],
    popupTemplate: {
      title: "Damage Status of ths Bridge: {Damage}",
      returnGeometry: true
    },
    definitionExpression: "note = 'International'"
    });

  // Populated places layer
  const populationLabel = {  // autocasts as new LabelClass()
    symbol: {
      type: "text",  // autocasts as new TextSymbol()
      color: "black",
      haloColor: "white",
      haloSize: 0.7,
      font: {  // autocast as new Font()
        size: 15,
        weight: "bold"
      }
    },
    labelPlacement: "above-right",
    labelExpressionInfo: {
      expression: "$feature.ADM4_EN"
    }
  };


  var populatedPlaceLayer = new FeatureLayer({
    portalItem: {
      id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Major City",
    layerId: 37,
    outFields: ["*"],
    popupTemplate: {
      title: "{name_EN}",
      returnGeometry: true,
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Population_HDX_2001",
              label: "Population"
            },
            {
              fieldName: "Admin 1 Pcode",
              label: "Admin 1 Pcode"
            },
            {
              fieldName: "Admin 1 Name EN",
              label: "Admin 1 Name"
            }
          ]
        }
      ]
    },
    labelingInfo: [populationLabel],
    definitionExpression: "Type_ = 'national capital'",
  });

  // Population
  var populationLayer = new FeatureLayer({
    portalItem: {
      id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Population",
    layerId: 32,
    outFields: ["*"],
    popupTemplate: {
      title: "Total population in this Admin {admin1Name_en}: {SUM_Population_HDX_2001}",
      returnGeometry: true,
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "admin1Pcode",
              label: "Admin 1 Pcode"
            }
          ]
        }
      ]
    }
  });

  // Major Road network
  var majorRoadLayer = new FeatureLayer({
    portalItem: {
      id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Major Road",
    layerId: 84,
    outFields: ["*"],
    popupEnabled: false
  });

  // Coundary Boundary
  var ukrainBoundary = new FeatureLayer({
    portalItem: {
      id:"5707eb58d6a7452cbc783ee458ea6b8a"
    },
    title: "Boundary",
    //labelingInfo: [textSymbol],
    layerId: 1,
    outFields: ["*"],
    labelsVisible: false,
    popupEnabled: false
  });
  ukrainBoundary.listMode = "hide";

  // this layer is only used to query for the intersecting country when the map is clicked
  const countries = new FeatureLayer({
    portalItem: {
      id: "53a1e68de7e4499cad77c80daba46a94"
    },
    outFields: ["*"],
    popupEnabled: false
  });
  countries.listMode = "hide";

  // clicked country feature will be added to this layer
  const graphicsLayer = new GraphicsLayer({
    blendMode: "destination-in",
    title: "layer"
  });
  graphicsLayer.listMode = "hide";

  const tileLayer = new TileLayer({
    portalItem: {
      // bottom layer in the group layer
      id: "10df2279f9684e4a9f6a7f08febac2a9" // world imagery
    }
  });
  tileLayer.listMode = "hide";
  tileLayer.when(() => {
    tileLayer.sublayers.forEach((layer) => {
      if (layer.popupEnabled === true) {
        layer.popupEnabled = false;
      }
    });
  });

  // this grouplayer has two layers
  // destination-in blendMode set on the graphics layer
  // country from the world imagery layer will show when user clicks on a country
  const groupLayer = new GroupLayer({
    layers: [
      tileLayer,
      // world imagery layer will show where it overlaps with the graphicslayer
      graphicsLayer
    ],
    opacity: 0 // initially this layer will be transparent
  });
  groupLayer.listMode = "hide";

  var map = new Map({
    layers: [worldImagery, groupLayer,ukrainBoundary,
              populationLayer,majorRoadLayer,bridgeLayer,
              hospitalCostLayer,hospitalLayer,populatedPlaceLayer,
              frontLine
            ]
  });

  var view = new MapView({
    container: "viewDiv",
    map: map,
    zoom: 6,
    center: [32.1021672, 48.7944170],
    popup: null,
    constraints: {
      snapToZoom: false,
      minScale: 147914381
    }
  });

  view.when(() => {
    const query = {
      geometry: view.center,
      returnGeometry: true,
      outFields: ["*"]
    };
    highlightCountry(query, view.center);
  });

  // listen to the view's click event
  view.on("click", async (event) => {
    const query = {
      // The following code stops zooming to the boundary extent every time you click on the map. 
      //geometry: view.toMap(event),

      // If false for returnGeometry, the spatial extent is fixed at Ukraine (not allows to select other counties)
      // Also, if false, when you click feature layers it does not zoom at every time. (so maybe we should keep it false)
      // When returnGeometry is true, you can click other countries but when you click feature layers, 
      // it zooms out to the extent of Ukraine country.
      returnGeometry: true,
      outFields: ["*"]
    };
    highlightCountry(query, query.geometry);
  });

  async function highlightCountry(query, zoomGeometry) {
    // country symbol - when user clicks on a country
    // we will query the country from the countries featurelayer
    // add the country feature to the graphics layer.
    const symbol = {
      type: "simple-fill",
      color: "rgba(255, 255, 255, 1)",
      outline: null
    };

    // query the countries layer for a country that intersects the clicked point
    const {
      features: [feature]
    } = await countries.queryFeatures(query);
    // user clicked on a country and the feature is returned
    if (feature) {
      graphicsLayer.graphics.removeAll();
      feature.symbol = symbol;
      // add the country to the graphics layer
      graphicsLayer.graphics.add(feature);
      // zoom to the highlighted country
      view.goTo(
        {
          target: zoomGeometry,
          extent: feature.geometry.extent.clone().expand(1.8)
        },
        { duration: 1000 }
      );
      // blur the world imagery basemap so that the clicked country can be highlighted
      worldImagery.effect = "blur(8px) brightness(1.2) grayscale(0.8)";
      // set the group layer transparency to 1.
      // also increase the layer brightness and add drop-shadow to make the clicked country stand out.
      groupLayer.effect = "brightness(1.5) drop-shadow(0, 0px, 12px)";
      groupLayer.opacity = 1;
    }
    // did not click on a country. remove effects
    else {
      worldImagery.effect = null;
      groupLayer.effect = null;
    }
  }


      // Pier Chart to summarize damage ratings of hospitals in Ukraine
  let chartLayerView;
  var highlightSelect;

  var titleDiv = document.getElementById("titleDiv");
  const chartPanel = document.getElementById("chartPanel");

  // Damage List
  var damageFactorList = document.getElementById("damageFactorList");
  var ttt = damageFactorList.getElementsByClassName("test");


  /* Function for zooming to selected layers */
  function zoomToLayer(layer) {
    return layer.queryExtent().then((response) => {
      view.goTo(response.extent).catch((error) => {
        console.error(error);
      });
    });
  }

  // Chart
  am5.ready(function() {
    var root = am5.Root.new("chartHospitalDiv");
    function updateChart() {
      root.container.children.clear();
      const damageType = [
        {
          category: "Total Destruction",
          value: 1
        },
        {
          category: "Damaged Beyond Repair",
          value: 2
        },
        {
          category: "Seriously Damaged-Not Repairable",
          value: 3
        },
        {
          category: "Seriously Damaged-Repairable",
          value: 4
        },
        {
          category: "No Damage",
          value: 5
        },
      ]

      var total_destruction = {
            onStatisticField: "CASE WHEN Damage = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_destruction",
            statisticType: "sum"
        }

        var total_damaged = {
            onStatisticField: "CASE WHEN Damage = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_damaged",
            statisticType: "sum"
        }
        
        var total_nonrepair = {
            onStatisticField: "CASE WHEN Damage = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nonrepair",
            statisticType: "sum"
        }

        var total_repair = {
            onStatisticField: "CASE WHEN Damage = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_repair",
            statisticType: "sum"
        }

        var total_notdamaged = {
            onStatisticField: "CASE WHEN Damage = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_notdamaged",
            statisticType: "sum"
        }

        var query = hospitalLayer.createQuery();
        query.outStatistics = [total_destruction, total_damaged, total_nonrepair, 
                               total_repair, total_notdamaged];

        query.returnGeometry = true;

        hospitalLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const TOTAL_DESTRUCTION = stats.total_destruction;
            const DAMAGED_NOREPAIR = stats.total_damaged;
            const DAMAGED_SERIOUS = stats.total_nonrepair;
            const DAMAGED_REPAIRABLE = stats.total_repair;
            const NO_DAMAGE = stats.total_notdamaged;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // To set slice color, you need to add this before data.setAll
        /*
        pieSeries.get("colors").set("colors", [
          am5.color("#70ad47"),
          am5.color("#0070FF"),
          am5.color("#FFFF00"),
          am5.color("#FFAA00"),
          am5.color("#FF0000"),
          am5.color("#00734C"),
        ]);
        */

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);


        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          const find = damageType.find((emp) => emp.category == SELECTED);
          const selectedStatus = find.value;

          view.when(function() {
            view.whenLayerView(hospitalLayer).then(function (layerView) {
              //chartLayerView = layerView;

              hospitalLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                hospitalLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "Damage = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: damageType[0].category,
              value: TOTAL_DESTRUCTION,
              sliceSettings: {
                fill: am5.color("#000000")
              }
            },
            {
              category: damageType[1].category,
              value: DAMAGED_NOREPAIR,
              sliceSettings: {
                fill: am5.color("#C500FF")
              }
            },
            {
              category: damageType[2].category,
              value: DAMAGED_SERIOUS,
              sliceSettings: {
                fill: am5.color("#FF0000")
              }
            },
            {
              category: damageType[3].category,
              value: DAMAGED_REPAIRABLE,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
            category: damageType[4].category,
              value: NO_DAMAGE,
              sliceSettings: {
                fill: am5.color("#89CD66")
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.boxHospital');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
        }); // end of queryFeatures
      } // end of updateChart
    


    function defaultRenderer() {
      hospitalLayer.visible = true;
      hospitalCostLayer.visible = true;
      bridgeLayer.visible = false;
      updateChart();
    }
    defaultRenderer();



for(var i = 0; i < ttt.length; i ++) {
  ttt[i].addEventListener("click", filterByP);
}

function filterByP(event) {
  var current = document.getElementsByClassName("active");
  current[0].className = current[0].className.replace(" active","");
  this.className += " active";

  const selectedID = event.target.id;
    if(selectedID == "Hospital") {
      hospitalLayer.visible = true;
      hospitalCostLayer.visible = true;
      bridgeLayer.visible = false;
      zoomToLayer(ukrainBoundary);
      updateChart();

    } else if (selectedID == "Bridge") {
      hospitalLayer.visible = false;
      hospitalCostLayer.visible = false;
      bridgeLayer.visible = true;
      zoomToLayer(ukrainBoundary);
      updateChartBridge();
      
    } 
}
      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "DAMAGE ASSESSMENT MAP";
        document.querySelector("#item-description").innerHTML = `
                                                                 1. You can opt for either <b>light theme or dark theme</b> for a window screen via a switch icon in the upper right.<br>
                                                                 2. You can <b>filter the data</b> by CP, land type (station or subterranean), and section using dropdown lits.<br>
                                                                 3. <b>Toggle a checkbox</b> at the bottom of 'Land' panel to filter for handed-over lots.<br>
                                                                 4. View charts for summary statistics and progress on acquisition of land/structure.<br>
                                                                 5. <b>Click pie chart</b> to view the respective lots/structures on the map.<br>
                                                                 6. <b>Lots under expropriation</b> is available in the 'Expro List' tab under the theme switch.<br>
                                                                 7. <b>Click/unclick widgets</b> icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                                 8. <b>NVS</b> stands for <b>'Negotiated Voluntary Sale'.</b><br>
                                                                 9. <b>ROWUA</b> stands for <b>'Right-of-Way Usage Agreement'</b>.
                                                                 `
                                                                 ;
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;


      }); // end of view.when



}); // end of am5.ready
/////////////////////////////////////////////////////////
  view.ui.empty("top-left");

  var legend = new Legend({
    view,
    container: "legend-container",
    layerInfos: [
      {
          layer: frontLine,
          title: "Military Frontline"
      },
      {
        layer: hospitalLayer,
        title: "Hospital Damage Rating"
      },
      {
        layer: bridgeLayer,
        title: "Bridge Damage Rating"
      },
      {
        layer: hospitalCostLayer,
        title: "Hospital Restoration Cost"
      },
      {
        layer: populationLayer,
        title: "Population"
      },
      {
        layer: majorRoadLayer,
        title: "Major Road"
      },
      {
        layer: populatedPlaceLayer,
        title: "Populated Place Layer"
      }
    ]
  });

  const basemaps = new BasemapGallery({
    view,
    container: "basemaps-container"
  });

  // Layer list
  var layerList = new LayerList({
    view,
    selectionEnabled: true,
    container: "layers-container",
    listItemCreatedFunction: function(event) {
      const item = event.item;
      if (item.title === "Bridge Damage Rating"){
        item.visible = false
      }

    }
  });


      });

    </script>
</html>
