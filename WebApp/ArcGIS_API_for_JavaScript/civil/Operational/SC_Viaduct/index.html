<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
<title>SC Viaduct</title>

<script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

<!-- Resources -->
<link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/dark/main.css"/>
<script src="https://js.arcgis.com/4.26/"></script>

</head>

<style>
  html,
  body,
  #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%; 
  }

  /** See-through-ground **/
  calcite-label {
    position: fixed;
    z-index: 1;
    bottom: 8.6vw;
    left: 5;
    vertical-align: middle;
    background-color: rgb(52, 52, 52);
    text-align: center;
    padding: 7;
    color: white;
  }

  #see-through-label {
    color: white;
    padding-top: 10;
    padding-bottom: 0;
    display: flex;
    align-self: center;
  }

  #see-through-label b {
    font-weight: normal;
  }

  #headerTitleDiv {
    font-size: 2.2rem;
    vertical-align: middle;
    padding-top: 3px;
    z-index: 99;
    position: fixed;
    left: 1.5%;
    top: 2%;
    color: white;
  }

  #cpButton {
    margin-right:1%;
    margin:0;
    width: 34vw;
    text-align: center;
    right: 6vw;
    top: 1.3vw;
  }

  .cpButtonClass {
      position: absolute;
    font-style: normal;
    font-size: 1vw;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    color: white;
    text-align: center;
    z-index: 1;
    right: 80;
    top: 20;
  }

  #menu {
    padding: 3px 3px 3px 3px;
    background-color: rgb(0,0,0,0.3);
    color: white;
  }

  #timeSeriesChart {
    position: absolute;
    z-index: 99;
    height: 40vh;
    width: 70vw;
    bottom: 40%;
    left:10vw;
    background-color: rgb(37, 37, 37);
  }

  .dateDiv {
    color: rgb(0, 197, 255);
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: left;
    font-weight: normal;
    font-size: 0.9rem;
    padding-top: 2%;
    margin: 0;
    z-index:1;
    top: 4%;
    left: 4%;
    position: fixed;
  }

  .img {
      float: left;
      padding-left: 20;
  }

  img {
      width: 40;
      height: 40;
      /*- center images-*/
      display: block;
      margin-left: auto;
      margin-right: auto;
  }

  .labelPileCap,
  .labelPier,
  .labelPierHead,
  .labelPrecast,
  .labelAtGrade {
      color: white;
      font-size: 1.4vw;
      text-align: center;
      background-color: green;
  }

  #labelBoredPile,
  #labelPileCap,
  #labelPier,
  #labelPierHead,
  #labelPrecast,
  #labelAtGrade {
      color: white;
      font-size: 1.3vw;
      text-align: center;
      width: 14vw;
      height: 4vh;
      padding-top: 3;  
  }

  #labelTotalDiv {
      color: white;
      font-size: 1.3vw;
      width: 14vw;
      height: 4vh;
      padding-top: 3;
      text-align: center;
  }

  .lowerPanelBox {
      display: flex;
      height: 70%;
  }

  #logoDiv {
      width: 35%;
      height: 100%;
      /*-Vertically align in the middle-*/
      display: flex;
      align-items: center;
  }

  #chartPanel {
      display: inline-block;
      width: 100%;
      height: 100%;
      /*-Vertically align in the middle-*/
  }

  #boxBoredPile {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 0.2%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxPileCap {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 14.4%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxPier {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 28.7%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxPierHead {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 43.0%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxPrecast {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 57.3%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxAtGrade {
      position: absolute;
      z-index: 99;
      background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
      border-color: white;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      background-color: rgb(0,0,0,0.5);
      bottom: 1%;
      left: 71.6%;
      color: white;
      font-size: 2vw;
      text-align: center;
      aspect-ratio: auto 4 / 2;
  }

  #boxTotal {
          position: absolute;
          z-index: 99;
          background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
          border-color: white;
          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
          background-color: rgb(0,0,0,0.5);
          bottom: 1%;
          left: 85.9%;
          color: white;
          font-size: 2vw;
          text-align: center;
          aspect-ratio: auto 4 / 2;
        }

  #chartBoredPileDiv,
  #chartPileCapDiv,
  #chartPierDiv,
  #chartPierHeadDiv,
  #chartPrecastDiv,
  #chartAtGradeDiv {
    width: 100%;
  }

  #totalProgressDiv {
    position: absolute;
      color: rgb(0, 197, 255);
      font-size: 2.5vw;
      padding-top: 11;
      text-align: center;
      width: 14vw;
  }

  /* Default Letter */    
  p {
    color: rgb(0, 197, 255);
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    width: auto;
    vertical-align: text-bottom;
    padding: 3px;
    margin-top: 10px;
  }

  h2 {
    font-weight: 400;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    font-style: normal;
    font-size: 1.8vw;
    color: white;
    padding:3px;
    margin: 0px;
    vertical-align: text-top;
  }

  h4 {
    color: rgb(0, 197, 255);
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: left;
    font-weight: normal;
    font-size: 1vw;
    padding-top: 20px;
    margin: 0;
    width: 180px;
    vertical-align: text-bottom;
  }

  h5 {
    color: rgb(0, 197, 255);
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: left;
    font-weight: normal;
    font-size: 14px;
    padding: 0;
    margin: 0;
  }

  h6 {
    color: rgb(0, 197, 255);
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: center;
    font-weight: normal;
    font-size: 3vw;
    margin-top: 7%;
  }



</style>
<body class="calcite-theme-dark">
  <calcite-loader></calcite-loader>
  <calcite-shell content-behind>
    <div id="viewDiv">
    <div class="dateDiv">As of xx, 2022</div>
    <div id="headerTitleDiv">SC VIADUCT</div>
    <calcite-segmented-control id="contractPackage">
      <calcite-segmented-control-item id="S-01" value="S-01" checked>S-01</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-02" value="S-02">S-02</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-03a" value="S-03a">S-03a</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-03b" value="S-03b">S-03b</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-03c" value="S-03c">S-03c</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-04" value="S-04">S-04</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-05" value="S-05">S-05</calcite-segmented-control-item>
      <calcite-segmented-control-item id="S-06" value="S-06">S-06</calcite-segmented-control-item>
    </calcite-segmented-control>
  <div id="boxBoredPile">
      <div id="labelBoredPile">Bored Pile</div>
      <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartBoredPileDiv"></div>
          </div>
      </div>
  </div>
    <div id="boxPileCap">
      <div id="labelPileCap">Pile Cap</div>
      <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartPileCapDiv"></div>
          </div>
      </div>
    </div>
    <div id="boxPier">
      <div id="labelPier">Pier</div>
      <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartPierDiv"></div>
          </div>
      </div>
    </div>
    <div id="boxPierHead">
      <div id="labelPierHead">Pier Head</div>
      <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartPierHeadDiv"></div>
          </div>
      </div>
    </div>
    <div id="boxPrecast">
      <div id="labelPrecast">Precast</div>
      <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartPrecastDiv"></div>
          </div>
      </div>
    </div>
    <div id="boxTotal">
      <div id="labelTotalDiv">TOTAL</div>
      <div class="lowerPanelBox">
        <div id="totalProgressDiv"></div>
      </div>
    </div>
      <div id="boxAtGrade">
        <div id="labelAtGrade">At-Grade</div>
        <div class="lowerPanelBox">
          <div id="chartPanel">
              <div id="chartAtGradeDiv"></div>
          </div>
        </div>
      </div>
      <calcite-label layout="inline" id="see-through-label">
        <calcite-checkbox id="myLink"></calcite-checkbox><b style="color:white;">See-through-ground</b>
      </calcite-label>
      <calcite-button
        icon-end="graph-time-series"
        id="time-series"
        >
      </calcite-button>
      <div id="timeSeriesChart" hidden></div>
  </div>
</calcite-shell>
</body>
<script>
  require([
  "esri/Basemap",
  "esri/Map",
  "esri/views/MapView",
  "esri/views/SceneView",
  "esri/layers/FeatureLayer",
  "esri/layers/support/FeatureFilter",
  "esri/layers/SceneLayer",
  "esri/layers/Layer",
  "esri/layers/TileLayer",
  "esri/layers/VectorTileLayer",
  "esri/layers/support/LabelClass",
  "esri/symbols/LabelSymbol3D",
  "esri/WebMap",
  "esri/WebScene",
  "esri/PopupTemplate",
  "esri/portal/PortalItem",
  "esri/portal/Portal",
  "esri/widgets/TimeSlider",
  "esri/widgets/Legend",
  "esri/widgets/LayerList",
  "esri/widgets/Fullscreen",
  "esri/rest/geometryService",
  "esri/rest/support/Query",
  "esri/rest/support/StatisticDefinition",
  "esri/symbols/WebStyleSymbol",
  "esri/TimeExtent",
  "esri/widgets/Expand",
  "esri/widgets/Editor",
  "esri/renderers/UniqueValueRenderer",
  "esri/widgets/support/DatePicker",
  "esri/widgets/FeatureTable",
  "esri/widgets/Compass",
  "esri/TimeExtent",
  "esri/widgets/Search",
  "esri/widgets/BasemapToggle",
  "esri/widgets/BasemapGallery",
], function(Basemap, Map, MapView, SceneView, FeatureLayer, FeatureFilter,
            SceneLayer, Layer, TileLayer, VectorTileLayer,
            LabelClass, LabelSymbol3D, WebMap,
            WebScene, PortalItem, Portal, PopupTemplate,
            TimeSlider, Legend, LayerList, Fullscreen,
            geometryService, Query,
            StatisticDefinition, WebStyleSymbol,
            TimeExtent, Expand, Editor, UniqueValueRenderer,
            DatePicker, FeatureTable, Compass, TimeExtent, Search, BasemapToggle, BasemapGallery,) {

  const timeSeries = document.querySelector("calcite-button");
  timeSeries.addEventListener("click", function(event) {
    const timeSeriesChart = document.getElementById("timeSeriesChart");
    timeSeriesChart.hidden = !timeSeriesChart.hidden
  });
  
  // Basemap
  // Add Map
  var map = new Map({
    basemap: "satellite",//basemap, // "streets-night-vector"
    ground: "world-elevation" // ground: "no"
  }); 
  //map.ground.surfaceColor = "#FFFF";
  //map.ground.opacity = 0.5;
          
  // Add scene view
  var view = new SceneView({
    map: map,
    container: "viewDiv",
    viewingMode: "local",
    camera: {
      position: {
        x: 120.75200,
        y: 14.90,
        z: 2500
      },
      tilt: 65
    },
    environment: {
      background: {
        type: "color", // autocasts as new ColorBackground()
        color: [0, 0, 0, 1]
      },
      
      // disable stars
      starsEnabled: false,
            
      //disable atmosphere
      atmosphereEnabled: false
    }
  });

  view.ui.components = [];

  // Basemap Toggle

        
  // Error Abort function 
  function catchAbortError(error) {
    if (error.name != "AbortError") {
      console.error(error);
    }
  }

  // OpenStreetMap 3D Buildings
  let osmSymbol = {
    type: "mesh-3d",
    symbolLayers: [
      {
        type: "fill",
        material: {
          color: [74, 80, 87, 0.5],
          colorMixMode: "replace"
        },
        edges: {
          type: "solid", // autocasts as new SolidEdges3D()
          color: [225, 225, 225, 0.3]
        }
    }
  ]
  };


  var osm3D = new SceneLayer({
    portalItem: {
      id: "ca0470dbbddb4db28bad74ed39949e25"
    },
    title: "OpenStreetMap 3D Buildings"
  });
  map.add(osm3D);
  osm3D.renderer = {
    type: "simple",
    symbol: osmSymbol
  }


  //*******************************//
  // Label Class Property Settings //
  //*******************************//
  // Chainage Label
  var labelChainage = new LabelClass({
    labelExpressionInfo: {expression: "$feature.KmSpot"},
    symbol: {
      type: "text",
      color: [85, 255, 0],
      size: 25
    }
  });

  // Pier No Label
  var pierNoLabelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "white"
          },
          size: 10,
          color: "black",
          haloColor: "black",
          haloSize: 1,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 40,
        maxWorldLength: 100,
        minWorldLength: 40
      },
      callout: {
        type: "line", // autocasts as new LineCallout3D()
        color: "white",
        size: 0.7,
        border: {
          color: "grey"
        }
      }
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.PIER"
              //value: "{TEXTSTRING}"
    }
  });

  // Station labels
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: [255, 170, 0]
          },
          size: 20,
          color: "black",
          haloColor: "black",
          haloSize: 1,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 40,
        maxWorldLength: 100,
        minWorldLength: 20
      },
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
              //value: "{TEXTSTRING}"
    }
  });

  //*****************************//
  //      Renderer Settings      //
  //*****************************//
  // Station Symbol
  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  // Station Renderer
  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  // Chainage symbol
  var chainageRenderer = {
    type: "simple",
    symbol: {
      type: "simple-marker",
      size: 5,
      color: [255, 255, 255, 0.9],
      outline: {
        width: 0.2,
        color: "black"
      }
    }
  };

  // Legend Color for Viaduct Layer
  // 0.1: more transparent, 0.9: not transparent 
  const colors = {
    1: [225, 225, 225, 0.1], // To be Constructed (white)
    2: [130, 130, 130, 0.5], // Under Construction
    3: [255, 0, 0, 0.8], // Delayed
    4: [0, 112, 255, 0.8], // Bored Pile
    5: [0, 112, 255, 0.8], // Pile cap
    6: [0, 112, 255, 0.8], // Pier
    7: [0, 112, 255, 0.8], // Pier head
    8: [0, 112, 255, 0.8], // Pre-cast
  };

          
  //*******************************//
  // Import Layers                 //
  //*******************************//
  // Station Layer
  var stationLayer = new SceneLayer({
    portalItem: {
      id: "87903f4d1859454a837d68e18a27ad4c",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    labelingInfo: [labelClass],
    renderer: stationsRenderer,
    elevationInfo: {
      mode: "relative-to-ground"
    },
    definitionExpression: "Extension = 'SC'"
                //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);

  // Centerline and chainage
  var chainageLayer = new FeatureLayer ({
    portalItem: {
      id: "d3926383cf3548569372216edb808996",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }   
    },
    layerId: 5,
    title: "Chainage",
    elevationInfo: {
      mode: "relative-to-ground"
    },
    labelingInfo: [labelChainage],
    renderer: chainageRenderer,
    outFields: ["*"],
    popupEnabled: false
  });
  //chainageLayer.listMode = "hide";
  map.add(chainageLayer, 1);

  // Pier No. (point feature)
  var PierNoLayer = new FeatureLayer ({
    portalItem: {
      id: "d3926383cf3548569372216edb808996",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 6,
    labelingInfo: [pierNoLabelClass],
    elevationInfo: {
      mode: "on-the-ground" //absolute-height, relative-to-ground
    },
    title: "Pier No",
    outFields: ["*"],
    popupEnabled: false
  });

  //chainageLayer.listMode = "hide";
  map.add(PierNoLayer, 1);

  // PROW //
  var rowLayer = new FeatureLayer ({
    portalItem: {
      id: "d3926383cf3548569372216edb808996",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }   
    },
    layerId: 1,
    title: "ROW",
    popupEnabled: false
  });
  map.add(rowLayer,2);

  // Viaduct Layer
  var viaductLayer = new SceneLayer({
    portalItem: {
      id: "a17403d9c7de46b282437f30b66bfdca",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    // popupTemplate: viadTemplate,
    elevationInfo: {
      mode: "absolute-height" //absolute-height, relative-to-ground
    },
    title: "Viaduct sample",
    outFields: ["*"],
    // when filter using date, example below. use this format
    //definitionExpression: "EndDate = date'2020-6-3'"
    /*
    popupTemplate: {
      title: "<h5>{Status1}</h5>",
      lastEditInfoEnabled: false,
      returnGeometry: true,
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Type",
              label: "Type of Structure"
            },
            {
              fieldName: "PierNumber",
              Label: "Pier No."
            }
          ]
        }
      ]
    }
    */      
  });
  viaductLayer.listMode = "hide";
  map.add(viaductLayer);

  // Symbology for Viaduct Layer
  function renderViaductLayer() {
    // Obtain unique values from Status1
    const renderer = new UniqueValueRenderer({
      field: "Status1"
    });
    
    for (let property in colors) {
      if (colors.hasOwnProperty(property)) {
        renderer.addUniqueValueInfo({
          value: property,
          symbol: {
            type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: colors[property],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
        });
      }
    }
    viaductLayer.renderer = renderer;
  }
  renderViaductLayer();


  //*******************************//
  //      Progress Chart           //
  //*******************************//
  // Total progress //
  function perCpProgress() {
  var total_complete = {
    onStatisticField: "CASE WHEN Status1 = 4 THEN 1 ELSE 0 END",
    outStatisticFieldName: "total_complete",
    statisticType: "sum"
  };

  var total_obs = {
    onStatisticField: "Status1",
    outStatisticFieldName: "total_obs",
    statisticType: "count"
  };

  var query = viaductLayer.createQuery();
  query.outStatistics = [total_complete, total_obs];
  query.returnGeometry = true;

  viaductLayer.queryFeatures(query).then(function(response) {
    var stats = response.features[0].attributes;

    const total_complete = stats.total_complete;
    const total_obs = stats.total_obs;
    document.getElementById("totalProgressDiv").innerHTML = ((total_complete/total_obs)*100).toFixed(1) + " %";
  });
  }
  perCpProgress();

  // Function for zooming to selected layers */
  function zoomToLayer(layer) {
    return layer.queryExtent().then(function(response) {
      view.goTo(response.extent, { //response.extent
        speedFactor: 2
      }).catch(function(error) {
        if (error.name != "AbortError") {
          console.error(error);
        }
      });
    });
  }

  // Setup DOM

  const cpButtonElement = document.getElementById("cpButton");
  const monthlyProgressChartDiv = document.getElementById("monthlyProgressChartDiv");
  const chartElement = document.getElementById("chartPanel");

  const contractPackage = document.getElementById("contractPackage");
  //*******************************************************************//
  // CHART FUNCTION:
  //
  // All commands related to chart must fall inside am4core
  //*******************************************************************//

  // Create a Bar chart to calculate % completion for each viaduct sample
  am5.ready(function() {

        // CHART
    // various properties setting
    const marginTop = 0;
    const marginLeft = 0;
    const marginRight = 0;
    const marginBottom = 0;
    const paddingTop = 0;
    const paddingLeft = 5;
    const paddingRight = 5;
    const paddingBottom = 15;

    const xAxisNumberFormat = "#'%'";
    const seriesBulletLabelFontSize = "0.5em";

    // series line fill pattern
    const linePatternColorComplete = "#70AD47";
    const linePatternColorOpacityComplete = 0;
    const linePatternFillOpacityComplete = 0;

    const linePatternColorOpacityIncomplet = 0;
    const linePatternFillOpacityIncomplet = 1;
    const linePatternStrokeOpacityIncomplet = 0;

    const chartIconWidth = 40;
    const chartIconHeight = 40;
    const chartIconPositionX = -27;
    const chartPaddingRightIconLabel = 45;

    class MyTheme extends am5.Theme {
      setupDefaultRules() {
        var theme = this;

        this.patterns = [
          am5.LinePattern.new(this._root, {
            color: am5.color(linePatternColorComplete),
            colorOpacity: linePatternColorOpacityComplete,
            fillOpacity: linePatternFillOpacityComplete,
          }),

          am5.LinePattern.new(this._root, {
            colorOpacity: linePatternColorOpacityIncomplet,
            fillOpacity: linePatternFillOpacityIncomplet,
            strokeOpacity: linePatternStrokeOpacityIncomplet,
          }),
        ];

        this.currentPattern = 0;
        this.rule("RoundedRectangle").setAll({
          fillOpacity: 1
        });

        this.rule("RoundedRectangle").setup = function(target) {
          target.set("fillPattern", theme.patterns[theme.currentPattern]);
          theme.currentPattern++;
          if (theme.currentPattern == theme.patterns.length) {
            theme.currentPattern = 0;
          }
        };
      }
    }

  // 1. Bored pile
  var root = am5.Root.new("chartBoredPileDiv");
  root._logo.dispose();

  var myTheme = am5.Theme.new(root);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartBoredPile() {
    var total_boredpile_incomp = {
          onStatisticField: "CASE WHEN (Type = 1 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_boredpile_incomp",
          statisticType: "sum"
      }
  
      var total_boredpile_comp = {
          onStatisticField: "CASE WHEN (Type = 1 and Status1 = 4) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_boredpile_comp",
          statisticType: "sum"
      }

      var query = viaductLayer.createQuery();
      query.outStatistics = [total_boredpile_incomp, total_boredpile_comp];
      query.returnGeometry = true;

      viaductLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
          const boredPile_incomp = stats.total_boredpile_incomp;
          const boredPile_comp = stats.total_boredpile_comp;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root),
          MyTheme.new(root)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root.container.children.push(am5xy.XYChart.new(root, {
          panX: false,
          panY: false,
          layout: root.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "boredpile",
                "comp": boredPile_comp,
                "incomp": boredPile_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pile_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root, {
            location: 0.5,
            sprite: am5.Picture.new(root, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root, {})
        }));

        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });

        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root, {
              sprite: am5.Label.new(root, {
                text: boredPile_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 1" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }

                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }

        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");

        chart.appear(1000, 100);

      });
  }
 

  // 2. Pile Cap
  var root2 = am5.Root.new("chartPileCapDiv"); //testChartDiv
  root2._logo.dispose();
  var myTheme = am5.Theme.new(root2);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartPileCap() {
    root2.container.children.clear();

      var total_pilecap_incomp = {
          onStatisticField: "CASE WHEN (Type = 2 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pilecap_incomp",
          statisticType: "sum"
      }
  
      var total_pilecap_comp = {
          onStatisticField: "CASE WHEN (Type = 2 and Status1 = 4) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pilecap_comp",
          statisticType: "sum"
      }
  
      var total_pilecap_delay = {
          onStatisticField: "CASE WHEN (Type = 2 and Status1 = 3) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pilecap_delay",
          statisticType: "sum"
      }
  
      var query = viaductLayer.createQuery();
      query.outStatistics = [total_pilecap_incomp, total_pilecap_comp, total_pilecap_delay];
      query.returnGeometry = true;
  
      viaductLayer.queryFeatures(query).then(function(response) {
          var stats = response.features[0].attributes;
          const pileCap_incomp = stats.total_pilecap_incomp;
          const pileCap_comp = stats.total_pilecap_comp;
          const pileCap_delay = stats.total_pilecap_delay;

                  // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root2.setThemes([
          am5themes_Animated.new(root2),
          am5themes_Responsive.new(root2),
          MyTheme.new(root2)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root2.container.children.push(am5xy.XYChart.new(root2, {
          panX: false,
          panY: false,
          layout: root2.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "pilecap",
                "comp": pileCap_comp,
                "incomp": pileCap_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pilecap_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root2, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root2, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root2_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root2, {
            location: 0.5,
            sprite: am5.Picture.new(root2, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root2, {})
        }));

        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });

        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root2, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root2, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root2, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root2, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root2, {
              sprite: am5.Label.new(root2, {
                text: pileCap_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "Delay"){
                  selectedStatus = 3;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 2" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }

                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }

        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");


        chart.appear(1000, 100);

  }); // end of queryFeatures
  } // end of chartPileCap
  

  // 3. Pier (Column)
  var root3 = am5.Root.new("chartPierDiv"); //testChartDiv
  root3._logo.dispose();
  var myTheme = am5.Theme.new(root3);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartPier() {
    root3.container.children.clear();

    var total_pier_incomp = {
          onStatisticField: "CASE WHEN (Type = 3 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pier_incomp",
          statisticType: "sum"
      }
  
      var total_pier_comp = {
          onStatisticField: "CASE WHEN (Type = 3 and Status1 = 4) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pier_comp",
          statisticType: "sum"
      }
  
      var total_pier_delay = {
          onStatisticField: "CASE WHEN (Type = 3 and Status1 = 3) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pier_delay",
          statisticType: "sum"
      }
  
      var query = viaductLayer.createQuery();
      query.outStatistics = [total_pier_incomp, total_pier_comp, total_pier_delay];
      query.returnGeometry = true;

      viaductLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
        const pier_incomp = stats.total_pier_incomp;
        const pier_comp = stats.total_pier_comp;
        const pier_delay = stats.total_pier_delay;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root3.setThemes([
          am5themes_Animated.new(root3),
          am5themes_Responsive.new(root3),
          MyTheme.new(root3)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root3.container.children.push(am5xy.XYChart.new(root3, {
          panX: false,
          panY: false,
          layout: root3.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "pilecap",
                "comp": pier_comp,
                "incomp": pier_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pier_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root3, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root3, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root3_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root3, {
            location: 0.5,
            sprite: am5.Picture.new(root3, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root3, {})
        }));

        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });

        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root3, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root3, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root3, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root3, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root3, {
              sprite: am5.Label.new(root3, {
                text: pier_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "Delay"){
                  selectedStatus = 3;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 3" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }


                      
                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/


        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");
        chart.appear(1000, 100);

  }); // end of queryFeatures
  } // end of chartPileCap

    // 4. Pier Head
    var root4 = am5.Root.new("chartPierHeadDiv"); //testChartDiv
    root4._logo.dispose();
  var myTheme = am5.Theme.new(root4);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartPierHead() {
    root4.container.children.clear();

      var total_pierhead_incomp = {
          onStatisticField: "CASE WHEN (Type = 4 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pierhead_incomp",
          statisticType: "sum"
      }
  
      var total_pierhead_comp = {
          onStatisticField: "CASE WHEN (Type = 4 and Status1 = 4) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pierhead_comp",
          statisticType: "sum"
      }
  
      var total_pierhead_delay = {
          onStatisticField: "CASE WHEN (Type = 4 and Status1 = 3) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_pierhead_delay",
          statisticType: "sum"
      }
  
      var query = viaductLayer.createQuery();
      query.outStatistics = [total_pierhead_incomp, total_pierhead_comp, total_pierhead_delay];
      query.returnGeometry = true;
  
      viaductLayer.queryFeatures(query).then(function(response) {
          var stats = response.features[0].attributes;
          const pierHead_incomp = stats.total_pierhead_incomp;
          const pierHead_comp = stats.total_pierhead_comp;
          const pierHead_delay = stats.total_pierhead_delay;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root4.setThemes([
          am5themes_Animated.new(root4),
          am5themes_Responsive.new(root4),
          MyTheme.new(root4)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root4.container.children.push(am5xy.XYChart.new(root4, {
          panX: false,
          panY: false,
          layout: root4.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "pilehead",
                "comp": pierHead_comp,
                "incomp": pierHead_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pierhead_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root4, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root4, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root4_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root4, {
            location: 0.5,
            sprite: am5.Picture.new(root4, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root4, {})
        }));
        
        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });


        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root4, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root4, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root4, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root4, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root4, {
              sprite: am5.Label.new(root4, {
                text: pierHead_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "Delay"){
                  selectedStatus = 3;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 4" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }


                      
                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }

        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");
        chart.appear(1000, 100);

  }); // end of queryFeatures
  } // end of chartPileCap


  // 5. Precast
  var root5 = am5.Root.new("chartPrecastDiv"); //testChartDiv
  root5._logo.dispose();
  var myTheme = am5.Theme.new(root5);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartPrecast() {
    root5.container.children.clear();

    var total_precast_incomp = {
          onStatisticField: "CASE WHEN (Type = 5 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_precast_incomp",
          statisticType: "sum"
    }

    var total_precast_comp = {
        onStatisticField: "CASE WHEN (Type = 5 and Status1 = 4) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_precast_comp",
        statisticType: "sum"
    }

    var total_precast_delay = {
        onStatisticField: "CASE WHEN (Type = 5 and Status1 = 3) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_precast_delay",
        statisticType: "sum"
    }

    var query = viaductLayer.createQuery();
    query.outStatistics = [total_precast_incomp, total_precast_comp, total_precast_delay];
    query.returnGeometry = true;

    viaductLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
        const preCast_incomp = stats.total_precast_incomp;
        const preCast_comp = stats.total_precast_comp;
        const preCast_delay = stats.total_precast_delay;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root5.setThemes([
          am5themes_Animated.new(root5),
          am5themes_Responsive.new(root5),
          MyTheme.new(root5)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root5.container.children.push(am5xy.XYChart.new(root5, {
          panX: false,
          panY: false,
          layout: root5.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "precast",
                "comp": preCast_comp,
                "incomp": preCast_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Precast_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root5, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root5, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root5_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root5, {
            location: 0.5,
            sprite: am5.Picture.new(root5, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root5, {})
        }));
        
        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });

        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root5, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root5, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root5, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root5, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root5, {
              sprite: am5.Label.new(root5, {
                text: preCast_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "Delay"){
                  selectedStatus = 3;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 5" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }


                      
                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }
        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");
        chart.appear(1000, 100);

  }); // end of queryFeatures
  } // end of chartPileCap

  var root7 = am5.Root.new("chartAtGradeDiv"); //testChartDiv
  root7._logo.dispose();
  var myTheme = am5.Theme.new(root7);
  myTheme.rule("Grid", ["base"]).setAll({
      strokeOpacity: 0,
    });

  function chartAtGrade() {
    root7.container.children.clear();

    var total_atgrade_incomp = {
          onStatisticField: "CASE WHEN (Type = 7 and Status1 = 1) THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_atgrade_incomp",
          statisticType: "sum"
    }

    var total_atgrade_comp = {
        onStatisticField: "CASE WHEN (Type = 7 and Status1 = 4) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_atgrade_comp",
        statisticType: "sum"
    }

    var total_atgrade_delay = {
        onStatisticField: "CASE WHEN (Type = 7 and Status1 = 3) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_atgrade_delay",
        statisticType: "sum"
    }

    var query = viaductLayer.createQuery();
    query.outStatistics = [total_atgrade_incomp, total_atgrade_comp, total_atgrade_delay];
    query.returnGeometry = true;

    viaductLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
        const atGrade_incomp = stats.total_atgrade_incomp;
        const atGrade_comp = stats.total_atgrade_comp;
        const atGrade_delay = stats.total_atgrade_delay;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root7.setThemes([
          am5themes_Animated.new(root7),
          am5themes_Responsive.new(root7),
          MyTheme.new(root7)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root7.container.children.push(am5xy.XYChart.new(root7, {
          panX: false,
          panY: false,
          layout: root7.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom
        }));

        var data = [
            {
                "category": "atgrade",
                "comp": atGrade_comp,
                "incomp": atGrade_incomp,
                "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Precast_Logo.svg",
            },
        ];

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root7, {});
        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root7, {
          categoryField: "category",
          //visible: false, // disable axis label
          renderer: yRenderer,
          bullet: function(root7_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root7, {
            location: 0.5,
            sprite: am5.Picture.new(root7, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
          tooltip: am5.Tooltip.new(root7, {})
        }));
        
        yRenderer.labels.template.setAll({
          paddingRight: 45
        });

        yRenderer.grid.template.setAll({
          location: 1
        });

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
          //maxWidth: 150,
          fontSize: "0em",
        });

        yAxis.data.setAll(data);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root7, {
          min: 0,
          max: 100,
          strictMinMax: true,
          numberFormat: xAxisNumberFormat,
          calculateTotals: true,
          visible: false, // disable axis label
          renderer: am5xy.AxisRendererX.new(root7, {
            strokeOpacity: 0.1
          })
        }));

        // Add series
        
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
          var series = chart.series.push(am5xy.ColumnSeries.new(root7, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXField: fieldName,
            valueXShow: "valueXTotalPercent",
            categoryYField: "category",
          }));

          series.columns.template.setAll({
            tooltipText: "{name}, {categoryX}: {valueY}",
            width: am5.percent(30),
            tooltipY: 0
          });

          var tooltip = am5.Tooltip.new(root7, {
            getFillFromSprite: true,
            labelText: "[bold][fontSize:16px]{name}: {valueX}"
          });

          tooltip.get("background").setAll({
            fillOpacity: 0.8,
            strokeOpacity: 0,
            //width: am5.percent(10)
          });

          series.set("tooltip", tooltip);
          series.data.setAll(data);

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          series.appear();

          series.bullets.push(function() {
            return am5.Bullet.new(root7, {
              sprite: am5.Label.new(root7, {
                text: atGrade_comp == 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
                fill: root4.interfaceColors.get("alternativeText"),
                opacity: fieldName == "incomp" ? 0 : 1,
                fontSize: seriesBulletLabelFontSize,
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true
              })
            });
          });

          series.columns.template.events.on("click", function(ev) {
              // Layer
              if (fieldName === "incomp") {
                  selectedStatus = 1;
              } else if (fieldName === "Delay"){
                  selectedStatus = 3;
              } else if (fieldName === "comp") {
                  selectedStatus = 4;
              } else {
                  selectedLayer = null;
              }
              
              var highlight = null;
              // Update layerView based on viaduct components being selected
              view.whenLayerView(viaductLayer).then(function (viaductLayerView) {
                  viaductLayerView.filter = {
                      where: "Type = 7" + " AND " +  "Status1 = " + selectedStatus
                      //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
                  };
                  
                  viaductLayerView.queryFeatures().then(function(results) {
                      const ggg = results.features;
                      const rowN = ggg.length;
                      
                      // Extract and obtain OBJECTID
                      let objID = [];
                      for (var i=0; i< rowN; i++) {
                          var obj = results.features[i].attributes.OBJECTID;
                          objID.push(obj);
                      }
                      highlightSelect = viaductLayerView.highlight([objID]);
                      if (highlightSelect) {
                        highlightSelect.remove();
                      }


                      
                      // Reset selection by clicking anywhere on the map
                      view.on("click", function() {
                          viaductLayerView.filter = null;
                          highlightSelect.remove();
                      });
                  });
              }); // whenLayerView
            });// End of filterByChart

        }
        makeSeries("Complete", "comp");
        makeSeries("Incomplete", "incomp");
        chart.appear(1000, 100);

  }); // end of queryFeatures
  } // end of chartPileCap



  function chartAllViaduct() {
    chartBoredPile();
    chartPileCap();
    chartPier();
    chartPierHead();
    chartPrecast();
    chartAtGrade();
  }

  // Time series chart for progress monitoring of viaduct components
  var root6 = am5.Root.new("timeSeriesChart");
  root6._logo.dispose();
  function timeSeriesChart(cpValue) {
    root6.container.children.clear();

    var total_complete_pile = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pile",
      statisticType: "sum"
    };
  
    var total_complete_pilecap = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 2) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pilecap",
      statisticType: "sum"
    };

    var total_complete_pier = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 3) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pier",
      statisticType: "sum"
    };

    var total_complete_pierhead = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pierhead",
      statisticType: "sum"
    };

    var total_complete_precast = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 5) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_precast",
      statisticType: "sum"
    };

    var query = viaductLayer.createQuery();
    query.where = "end_date IS NOT NULL" + " AND " + "CP = '" + cpValue + "'";
    query.outStatistics = [total_complete_pile, total_complete_pilecap,
                           total_complete_pier, total_complete_pierhead, total_complete_precast];
    query.outFields = ["end_date"];
    query.orderByFields = ["end_date"];
    query.groupByFieldsForStatistics = ["end_date"];

      const pile = [];
      const pilecap = [];
      const pier = [];
      const pierhead = [];
      const precast = [];

    viaductLayer.queryFeatures(query).then(function(response) {
      var stats = response.features;

      // collect all dates for each viaduct type
      const data = stats.map((result, index) => {
        const attributes = result.attributes;
        const date = attributes.end_date;
        
        const pileCount = attributes.total_complete_pile;
        const pilecapCount = attributes.total_complete_pilecap;
        const pierCount = attributes.total_complete_pier;
        const pierheadCount = attributes.total_complete_pierhead;
        const precastCount = attributes.total_complete_precast;

        // compile in object
        return Object.assign({}, {
          date,
          pile: pileCount,
          pilecap: pilecapCount,
          pier: pierCount,
          piearhead: pierheadCount,
          precast: precastCount
        });
      });

      // 6. Add to Chart

      // set themes
      root6.setThemes([
        am5themes_Animated.new(root6)
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root6.container.children.push(am5xy.XYChart.new(root6, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX",
        layout: root6.verticalLayout
      }));

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var xRenderer = am5xy.AxisRendererX.new(root6, {
        //minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
      });
      var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root6, {
        // When you group data for series 
        // Note you need to baseInterval timeUnit is 'day'
        // and groupIntervals timeUnit is 'month'
        maxDeviation: 0,
        groupData: true,
        baseInterval: {
          timeUnit: "day",
          count: 1
        },
        // count: 
       groupIntervals: [{timeUnit: "month", count: 1}],
        
        categoryField: "date",
        renderer: xRenderer,
        tooltip: am5.Tooltip.new(root6, {})
      }));

      xRenderer.grid.template.setAll({
        location: 1
      })

      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      xAxis.data.setAll(data);

      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root6, {
        min: 0,
        renderer: am5xy.AxisRendererY.new(root6, {
          strokeOpacity: 0.1,
          minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));

    // Add yaxix title
    yAxis.children.unshift(
      am5.Label.new(root6, {
        rotation: -90,
        text: "Count",
        y: am5.p50,
        centerX: am5.p50,
        fill: am5.color("#ffffff"),
        fontSize: 11
      })
    );

      yAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      // Add legend
      // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
      var legend = chart.children.push(am5.Legend.new(root6, {
        centerX: am5.p50,
        x: am5.p50
      }));

      legend.labels.template.setAll({
        oversizedBehavior: "truncate",
        fill: am5.color("#ffffff"),
        fontSize: 17,
        scale: 0.8,
        //textDecoration: "underline"
        //width: am5.percent(200)
        //fontWeight: "300"
      });

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root6, {
          name: name,
          stacked: true,
          xAxis: xAxis,
          yAxis: yAxis,
          valueYField: fieldName,
          valueXField: "date",
          valueYGrouped: "sum"
        }));

        series.columns.template.setAll({
          tooltipText: "{name}, {categoryX}: {valueY}",
          tooltipY: am5.percent(10)
        });
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear();

        series.bullets.push(function() {
          return am5.Bullet.new(root6, {
            sprite: am5.Label.new(root6, {
              text: "{valueY}",
              fill: root6.interfaceColors.get("alternativeText"),
              centerY: am5.p50,
              centerX: am5.p50,
              populateText: true
            })
          });
        });

        legend.data.push(series);
      }

      makeSeries("Bored Pile", "pile");
      makeSeries("Pile Cap", "pilecap");
      makeSeries("Pier", "pier");
      makeSeries("Pier Head", "pierhead");
      makeSeries("Precast", "precast");

      chart.appear(1000, 100);


    });
  }
  timeSeriesChart("S-01");


  //
  
  contractPackage.addEventListener("calciteSegmentedControlChange", async (event) => { cpValue = event.target.value, filterItems()});

  function filterItems() {
    viaductLayer.definitionExpression = "CP = '" + cpValue + "'";
      PierNoLayer.definitionExpression = "CP = '" + cpValue + "'";
      zoomToLayer(viaductLayer);
      chartAllViaduct();
      timeSeriesChart(cpValue);
      //updateChart();
      perCpProgress();
  }

  function defaultRenderer() {
    viaductLayer.definitionExpression = "CP = 'S-01'";
      PierNoLayer.definitionExpression = "CP = 'S-01'";
      zoomToLayer(viaductLayer);
      chartAllViaduct();
      perCpProgress();
  }

  view.when(() => {
    defaultRenderer();
  })

  }); // end am5
  view.ui.add(contractPackage,"top-right");



  // LayerList and Add legend to the LayerList
  var layerList = new LayerList({
    view: view,
    listItemCreatedFunction: function(event) {
      const item = event.item;
      if (item.title === "Chainage" || item.title === "OpenStreetMap 3D Buildings"){
        item.visible = false
      }
    }
  });

  var layerListExpand = new Expand ({
      view: view,
      content: layerList,
      expandIconClass: "esri-icon-visible",
      group: "top-right"
  });
  view.ui.add(layerListExpand, {
      position: "top-right"
  });


  // Legend
  var legend = new Legend({
    view: view,
    container: document.getElementById("legendDiv"),
    layerInfos: [
      {
        layer: rowLayer,
        title: "PROW"
      },
      {
        layer: chainageLayer,
        title: "chainage"
      },
      {
        layer: PierNoLayer,
        title: "Pier No."
      },
      {
        layer: osm3D,
        title: "OpenStreetMap 3D Buildings"
      }
    ]
  });
  var legendExpand = new Expand({
      view: view,
      content: legend,
      expandIconClass: "esri-icon-legend"
  });
  view.ui.add(legendExpand, {
      position: "top-right"
  });

  var layerListExpand = new Expand ({
    view: view,
    content: layerList,
    expandIconClass: "esri-icon-visible"
  });
  view.ui.add(layerListExpand, {
    position: "top-left"
  });

  // Empty top-left widget
  view.ui.empty("top-left");
  
  // See-through-Ground
  view.when(function() {
    // allow navigation above and below the ground
    map.ground.navigationConstraint = {
      type: "none"
    };
    // the webscene has no basemap, so set a surfaceColor on the ground
    map.ground.surfaceColor = "#fff";
            
    // to see through the ground, set the ground opacity to 0.4
    map.ground.opacity = 0.9;
  });
            
  document.getElementById("myLink").addEventListener("click", function(event) {
      const checked = event.srcElement.checked;
      map.ground.opacity = event.srcElement.checked ? 0.1 : 0.6;
    });


  //Search Widget 
  var searchWidget = new Search({
    view: view,
    locationEnabled: false,
    allPlaceholder: "Chainage or Pier Number",
    includeDefaultSources: false,
    sources: [
      {
        layer: chainageLayer,
        searchFields: ["KmSpot"],
        displayField: "KmSpot",
        exactMatch: false,
        outFields: ["KmSpot"],
        name: "Main KM",
        placeholder: "example: 80+400"
    },
    {
        layer: viaductLayer,
        searchFields: ["PierNumber"],
        displayField: "PierNumber",
        exactMatch: false,
        outFields: ["PierNumber"],
        name: "Pier No.",
        placeholder: "example: PLK-01"
    }
  ]
  });

  const searchExpand = new Expand({
    view: view,
    content: searchWidget,
    expandIconClass: "esri-icon-search"
  });
  view.ui.add(searchExpand, {
    position: "top-right"
  });

  searchExpand.watch("expanded", function() {
    if(!searchExpand.expanded) {
      searchWidget.searchTerm = null;
    }
  });

  // Basemap Gallery
  let basemapGallery = new BasemapGallery({
    view: view
  });

  const basemapGalleryExpand = new Expand({
    view,
    content: basemapGallery,
    expandIconClass: "esri-icon-basemap",
    group: "top-right"
  });
  // Add widget to the top right corner of the view
  view.ui.add(basemapGalleryExpand, {
    position: "top-right"
  });

  // Compass
  var compassWidget = new Compass({
    view: view
  });
  view.ui.add(compassWidget, "top-right");

  // time series chart
  view.ui.add(document.getElementById("time-series"), {
    position: "top-right"
  });

  });
</script>
</html>