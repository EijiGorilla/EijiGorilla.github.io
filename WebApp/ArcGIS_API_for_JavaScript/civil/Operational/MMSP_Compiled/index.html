<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MMSP Compiled</title>
    
        <!-- https://www.esri.com/arcgis-blog/products/arcgis-living-atlas/public-safety/wildfire-aware-app-design-and-implementation/-->

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <!-- Resources -->
    <script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.144.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <script src="https://js.arcgis.com/4.27/"></script>
    <script src="js/animepoint.js"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
    }


    #container {
      display: grid;
      flex-wrap: wrap;
      box-sizing: border-box;
      grid-template-columns: 1fr 0.25fr;
      width: 100%;
      height: 100%;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    calcite-list {
      overflow-y: auto;
    }


    calcite-tab {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }



    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #contractPackageDiv {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;

    }

    calcite-segmented-control {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;
    }

    calcite-button {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;
    }

    #info-content {
      padding: 0.75rem;
      overflow-y: auto;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }

    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    /* CHART AND CONTENT PANEL */
    #chartPanel {
      background-color: rgb(0, 0, 0, 0);
      padding: 8;
      width: 100%;
      height: 100%;
    }
    
    #landPieChartDiv,
    #structurePieChartDiv,
    #nloPieChartDiv,
    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
      height: 45%;
      margin-bottom: 5;
    }

    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
      height: 40%;
      margin-bottom: 5;
    }


    .lotNumber-container,
    .structureNumber-container,
    .nloNumber-container,
    .pteLot-container,
    .pteStructure-container,
    .treeNumber-container,
    .utilityNumber-container,
    .viaductNumber-container {
      display: flex;
    }

    #lotNumberDiv,
    #structureNumberDiv,
    #nloNumberDiv,
    #pteLotNumberDiv,
    #pteStructureNumberDiv,
    #treeNumberDiv,
    #utilityNumberDiv,
    #viaductNumberDiv {
      width: 50%;
      height: 10%;
      padding-top: 2%;
      padding-left: 15px;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #pteLotNumberDiv b,
    #pteStructureNumberDiv b {
      font-size: 2vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #landImage,
    #landNumberImage,
    #nloNumberImage,
    #structureImage,
    #structureNumberImage,
    #treeNumberImage,
    #utilityNumberImage {
      width: 17.5%;
      height: auto;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      margin-bottom: -10;
    }

    #viaductNumberImage {
      width: 17%;
      height: 17%;
      margin-left: auto;
      margin-right: auto;
      margin-top: 5;
      margin-bottom: -30;
    }

    #lotNumberDiv b,
    #nloNumberDiv b,
    #structureNumberDiv b,
    #treeNumberDiv b,
    #utilityNumberDiv b,
    #viaductNumberDiv b {
      font-size: 2.5vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #chartMoaLotDiv,
    #chartMoaStructureDiv {
      width: 100%;
      height: 30%;
      align-items: center;
      padding: 1%;
      margin-top: 5%;
    }

    #utilityPointChartDiv,
    #utilityLineChartDiv {
      padding-left: 12px;
      align-items: center;
      width: 91%;
      height: 38%;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #viaductChartDiv {
      padding-left: 12px;
      align-items: center;
      width: 91%;
      height: 50%;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #timeSeriesChartViaduct,
    #timeSeriesChartLand {
      position: absolute;
      z-index: 1;
      height: 40vh;
      width: 60vw;
      bottom: 20%;
      left: 8vw;
      background-color: rgb(37, 37, 37);
    }

    /* See Through Label */
    #see-through-label,
    #viaduct-checkbox,
    #land-checkbox {
      padding: 10;
    }

    b {
        color: orange;
    }

    /* TRAIN ANIMATION BUTTON */
    .overlay {
      position: fixed;
      z-index: 1;
      width: 2%;
      bottom: 0;
      right: 7;
      background-color: rgba(80, 80, 80, 0);
      padding: 0;
      /*text-align: center;*/
    }
  
    .button {
      cursor: pointer;
      font-size: 1vw !important;
      font-weight: bold !important;
      color: rgb(230, 230, 230);
      padding: 0;
    }
    
    .button:hover, #label {
      color: white;
    }
    
    .button, #label {
      margin: 15px;
    }

    /* SCROLL BAR */
    /* ESRI POPUP */

    ::-webkit-scrollbar {
      width: 5px;
      
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #00032235; /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #FFBA1F;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
      }

    /*
    .esri-legend__layer-cell--info {
      background-color: black;
      color: white;
      font-size: 0.85vw;
    }
    */

    .esri-legend {
      overflow: hidden;
      overflow-y: auto;
      margin-left: -10;
    }



    #image {
      width: 50px;
      height: 50px;
    }

    /*
    .esri-legend__layer-cell {
      min-width: 100px;
      word-break: break-word;
      padding: 0;
      vertical-align: middle;
      margin: 0;
    }
    */

  #measurementToolMenu {
    padding: 0.8em;
    max-width: 180px;
    width: 250px;
  }

  #measurementToolLabel {
    color: white;
  }

  #sliceContainer {
    width: inherit;
  }

  #sliceOptions {
    margin: 0 15px;
  }

  #sliceOptions>button {
    margin-bottom: 15px;
  }

  #sliceContainer {
    max-width: 228px;
  }

  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">

        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>
        <div id="dateDiv">As of June 7, 2023</div>

        <!-- Dropdown Lists -->
        <div id="contractPackageDiv">
          <calcite-segmented-control>
            <calcite-segmented-control-item id="All" value="all" checked>All</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP101" value="cp-01">CP101</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP102" value="cp-02">CP102</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP103" value="cp-03">CP103</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP104" value="cp-04">CP104</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP105" value="cp-05">CP105</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP108" value="cp-08">CP108</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP109" value="cp-09">CP109</calcite-segmented-control-item>
          </calcite-segmented-control>
        </div>
      </div>

            <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" display-mode="float" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="seethrough" icon="transparency" text="Underground"></calcite-action>
          <calcite-action data-action-id="charts" icon="graph-time-series" text="Progree Chart"></calcite-action>
          <calcite-action data-action-id="smartmaps" icon="collection" text="Smart Map Link"></calcite-action>
          <calcite-action data-action-id="animation" icon="play" text="Animation"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <calcite-list>
            <calcite-list-item label="Land Acquisition" description="" value="land-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="land-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="land-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="Existing Structure" description="" value="structure-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="structure-check" style="margin-left: 5px"></calcite-checkbox>
                <div id="structure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Non-Land Owner" description="" value="NLO-acquisition">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="NLO-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="nlo-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Occupancy (Structure)" description="" value="occupancy-acquisition">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="occupancy-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="occupancy-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="NLO/LO Ownership (Structure)" description="" value="strucOwnership-acquisition">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="strucOwnership-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="strucOwnership-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="PNR Land" description="" value="pnr-acquisition">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="pnr-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="pnr-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="Tree Cutting" description="" value="treeCutting">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="treeCutting-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="treeCutting-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Tree Compensation" description="" value="treeCompensation">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="treeCompensation-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="treeCompensation-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Point Sybmol)" description="" value="utility-point">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilityPoint-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilityPoint-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Point Status)" description="" value="utility-pointStatus">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilityPointStatus-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilityPointStatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Line Symbol)" description="" value="utility-line">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilityLine-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilityLine-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Line Status)" description="" value="utility-lineStatus">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilityLineStatus-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilityLineStatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Pier with Access Date" description="" value="pierAccess-date">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="pierAccess-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="pierAccess-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="Station Box" description="" value="stationBox">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="stationBox-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="stationBox-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="PROW" description="" value="prow">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="prow-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="prow-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="Chainage" description="" value="chainage">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="chainage-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="chainage-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Viaduct" description="" value="viaduct">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="viaduct-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="viaduct-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Station Structure" description="" value="stationstructure">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="stationstructure-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="stationstructure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
          </calcite-list>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="View Underground" height-scale="l" data-panel-id="seethrough" hidden>
          <calcite-label layout="inline" id="see-through-label">
            <calcite-checkbox id="myLink"></calcite-checkbox> Ground color becomes transparent
          </calcite-label>
        </calcite-panel>

        <calcite-panel class="timeSeries-panel" heading="Progress Chart" height-scale="l" data-panel-id="charts" hidden>
          <calcite-label layout="inline" id="viaduct-timeSeries-label">
            <calcite-checkbox id="viaduct-checkbox"></calcite-checkbox>Viaduct
          </calcite-label>
          <calcite-label layout="inline" id="land-timeSeries-label">
            <calcite-checkbox id="land-checkbox"></calcite-checkbox>Handed-Over Lot
          </calcite-label>
        </calcite-panel>

        <calcite-panel heading="Links to Individual Smart Maps" height-scale="l" data-panel-id="smartmaps" hidden>
          <calcite-list>
            <calcite-list-item label="Land Acqusition" description="Structure/NLO included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="Tree Cutting/Compensation" description="Tree conservation status included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Tree_Cutting/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation" description="Major utility companies included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Utility_Relocation/index.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="Viaduct" description="Construction progress on main viaduct">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Viaduct/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
          </calcite-list>
        </calcite-panel>

        <calcite-panel class="animation-panel"  height-scale="l" data-panel-id="animation" hidden></calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="container">
        <div id="timeSeriesChartViaduct" hidden></div>
        <div id="timeSeriesChartLand" hidden></div>
      <div id="viewDiv">
        <div id="measurementToolMenu" class="esri-widget">
          <calcite-label>
            <div id="measurementToolLabel">
              Click one of the buttons below to open the corresponding analysis widget and interact with the analysis.
            </div>
          </calcite-label>
          <calcite-button
            id="directLineMeasurementAnalysisButton"
            icon-start="measure-line"
            title="Interact with direct line measurement"
          >
          </calcite-button>
          <calcite-button
            id="areaMeasurementAnalysisButton"
            icon-start="measure-area"
            title="Interact with area measurement"
          >
          </calcite-button>
          <calcite-button id="sliceAnalysisButton" icon-start="slice" title="Interact with slice plane"> </calcite-button>
          <calcite-button
            id="lineOfSightAnalysisButton"
            icon-start="line-of-sight"
            title="Interact with line of sight analysis"
          >
          </calcite-button>
          <calcite-label></calcite-label>
          <calcite-button id="removeWidgetButton" title="Remove Widget" style="display: none; width: 140px"
            >Remove Widget
          </calcite-button>
        </div>
      </div>
      <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
      <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
      <calcite-tabs>
        <div id="chartPanel">
            <calcite-tab-nav slot="tab-nav" id="thetabs">
                <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                <calcite-tab-title class="ISF">NLO</calcite-tab-title>
                <calcite-tab-title class="Trees">Tree</calcite-tab-title>
                <calcite-tab-title class="Utility">Utility</calcite-tab-title>
                <calcite-tab-title class="Viaduct">Viaduct</calcite-tab-title>
            </calcite-tab-nav>
            <calcite-tab>
              <div class="lotNumber-container">
                <div id="lotNumberDiv"></div>
                <img id="landNumberImage" src="https://EijiGorilla.github.io/Symbols/Land_logo.png">
              </div>
              <div class="box" id="landPieChartDiv"></div>
              <div class="pteLot-container">
                <div id="pteLotNumberDiv"></div>
                <img id="landImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaLotDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="structureNumber-container">
                <div id="structureNumberDiv"></div>
                <img id="structureNumberImage" src="https://EijiGorilla.github.io/Symbols/House_Logo.svg">
              </div>
              <div class="box2" id="structurePieChartDiv"></div>
              <div class="pteStructure-container">
                <div id="pteStructureNumberDiv"></div>
                <img id="structureImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaStructureDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="nloNumber-container">
                <div id="nloNumberDiv"></div>
                <img id="nloNumberImage" src="https://EijiGorilla.github.io/Symbols/NLO_Logo.svg">
              </div>
              <div class="box3" id="nloPieChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="treeNumber-container">
                <div id="treeNumberDiv"></div>
                <img id="treeNumberImage" src="https://EijiGorilla.github.io/Symbols/Tree_Logo.svg">
              </div>
              <div class="box4" id="treeCuttingPieChartDiv"></div>
              <div class="box5" id="treeCompensationPieChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="utilityNumber-container">
                <div id="utilityNumberDiv"></div>
                <img id="utilityNumberImage" src="https://EijiGorilla.github.io/Symbols/Utility_Logo.png">
              </div>
              <div class="box6" id="utilityPointChartDiv">UTILITY POINT</div>
              <div class="box7" id="utilityLineChartDiv">UTILITY LINE</div>
            </calcite-tab>
            <calcite-tab>
              <div class="viaductNumber-container">
                <div id="viaductNumberDiv"></div>
                <img id="viaductNumberImage" src="https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_All_Logo.svg">
              </div>
              <div class="box8" id="viaductChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="panel-side esri-widget">
                <ul id="expropriationListDiv">
                  <li>Loading&hellip;</li>
                </ul>
              </div>
            </calcite-tab>
      </calcite-tabs>
    </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/layers/SceneLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer",
      "esri/core/reactiveUtils",
      "esri/popup/support/FieldInfoFormat",
      "esri/geometry/geometryEngine",
      "esri/rest/route",
      "esri/rest/support/RouteParameters",
      "esri/core/Accessor",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/geometry/Polyline",
      "esri/views/3d/externalRenderers",
      "esri/rest/support/FeatureSet",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol",
      "esri/geometry/SpatialReference",
      "esri/layers/BuildingSceneLayer",
      "esri/analysis/DirectLineMeasurementAnalysis",
      "esri/widgets/DirectLineMeasurement3D",
      "esri/analysis/AreaMeasurementAnalysis",
      "esri/widgets/AreaMeasurement3D",
      "esri/analysis/SliceAnalysis",
      "esri/widgets/Slice",
      "esri/analysis/LineOfSightAnalysis",
      "esri/widgets/LineOfSight",
      "esri/geometry/Polygon",
    ], function(WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer, reactiveUtils, 
                FieldInfoFormat, geometryEngine, route, RouteParameters, Accessor, Graphic,
                Point, Polyline, externalRenderers, FeatureSet, SimpleMarkerSymbol, SimpleLineSymbol,
                SpatialReference, BuildingSceneLayer,
                DirectLineMeasurementAnalysis, DirectLineMeasurement3D, 
                AreaMeasurementAnalysis, AreaMeasurement3D, SliceAnalysis, Slice,
                LineOfSightAnalysis, LineOfSight, Polygon
                 ) {
      


    // Reference link
    // 2D to 3D
    //https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/

    // 3D Extrusion using point, line, and polygon
    // https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/3d-visualization-working-with-objects-paths-and-extrusion/?rmedium=redirect&rsource=blogs.esri.com/esri/arcgis/2016/01/25/3d-visualization-working-with-objects-paths-and-extrusion


    var map = new Map({
        basemap: "satellite",//"dark-gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new SceneView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        viewingMode: "local",
        container: "viewDiv",
        camera: {
          position: {
            x: 120.75200,
            y: 14.90,
            z: 2500
          },
          tilt: 65
        },
        environment: {
          background: {
            type: "color", // autocasts as new ColorBackground()
            color: [0, 0, 0, 1]
          },
          starsEnabled: false,
          
        }
    });

    view.ui.components = [];

    const basemaps = new BasemapGallery({
      view,
      container: "basemaps-container"
    });


    // TRAIN ANIMATION //
////// Train Animation using externalRenderers
// Route Layer for animatioin
      // The stops and route result will be stored in this layer
      var routeLyr = new GraphicsLayer();
  
      // Setup the route parameters
      var routeParams = new RouteParameters({
          stops: new FeatureSet(),
          outSpatialReference: { // autocasts as new SpatialReference()
              wkid: 3857
          }
      });
  
      // Define the symbology used to display the stops
      var stopSymbol = new SimpleMarkerSymbol({
          style: "cross",
          size: 0, // 15
          outline: { // autocasts as new SimpleLineSymbol()
              width: 0 // 4
          }
      });
  
      // Define the symbology used to display the route
      var routeSymbol = new SimpleLineSymbol({
          color: [0, 0, 255, 0], // [0, 0, 255, 0.5]
          width: 5
      });
  
      // Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
      //on(view, "click", addStop);
      /*
      view.on("click", function() {
        addStop();

    });
    */

    function addStop(event) {

        // Add a point at the location of the map click
        //var stop = new Graphic({
        //    geometry: event.mapPoint,
        //    symbol: stopSymbol
        //});

        var stop1 = new Graphic({
            geometry: new Point({x: 13422812.716400001, y: 1710317.0639999993, z: 115.65110000000277, spatialReference: SpatialReference.WebMercator}),
            symbol: stopSymbol
        });
        routeLyr.add(stop1);

        var stop2 = new Graphic({
            geometry: new Point({x: 13422004.020599999, y: 1713789.0846000016, z: 105.54970000000321, spatialReference: SpatialReference.WebMercator }),
            symbol: stopSymbol
        });
        routeLyr.add(stop2);

        routeParams.stops.features.push(stop1);
        routeParams.stops.features.push(stop2);

        // Execute the route task if 2 or more stops are input
        //routeParams.stops.features.push(stop);
        if (routeParams.stops.features.length >= 2) {
            //routeTask.solve(routeParams).then(showRoute);
            showRoute();
        }
    }

    // Adds the solved route to the map as a graphic
    function showRoute(data) {
        
        //var routeResult = data.routeResults[0].route;

        var polyline = new Polyline(polylinePoints);
        polyline.spatialReference = SpatialReference.WebMercator;

        var routeResult = new Graphic({
            geometry: polyline,
            symbol: routeSymbol
        });
        routeResult.symbol = routeSymbol;

        routeLyr.add(routeResult);
      
      // the speed of the object becomes low with maximum segment of length
      var pl = geometryEngine.densify(routeResult.geometry, 0.5, "meters");
        // register the external renderer
        const myExternalRenderer = new skeletonRenderer(view, pl);
        externalRenderers.add(view, myExternalRenderer);

    }
    // Disable lighting based on the current camera position.
    // We want to display the lighting according to the current time of day.
    //view.environment.lighting.cameraTrackingEnabled = false;

    // Create our custom external renderer
   //////////////////////////////////////////////////////////////////////////////////////
    //https://github.nicogis.it/externalRendererSkeleton/
    var skeletonRenderer = Accessor.createSubclass({ // if '|| {}' is not added beside null,
    // you will receive the following error 'Cannot destructure property of xx of 'null' as it is null'
        view: null,
        //pl: null,
        renderer: null,     // three.js renderer
        camera: null,       // three.js camera
        scene: null,        // three.js scene
        vertexIdx: 0,
        ambient: null,      // three.js ambient light source
        sun: null,          // three.js sun light source
        mixer: null,
        mixer2: null,
        clock: null,
        clips: null,
        animate: null,
        light: null,
        iss: null, 
        iss2: null,                                                   // ISS model
        issScale: 3,                                     // scale for the iss model
        issScale2: 10,
        path: null,
      count: null,
      up: null,
      timeDelta: null,
      markerMaterial: null,    // material for the markers left by the ISS
      markerGeometry: null,    // geometry for the markers left by the ISS
      //issMaterial: new THREE.MeshLambertMaterial({ color: 0x2194ce, transparent: true, opacity: 0.1 }), 

        cameraPositionInitialized: false, // we focus the view on the ISS once we receive our first data point
        positionHistory: [],
      
        constructor: function (view, pl) {
          this.view = view;
            this.path = pl.paths[0]; //pl.paths[0];
        },
        /**
         * Setup function, called once by the ArcGIS JS API.
         */
        setup: function (context) {

            // initialize the three.js renderer
            /////////////////////////////////////////////////////////////////////////////////////
            this.renderer = new THREE.WebGLRenderer({
                context: context.gl,
                premultipliedAlpha: false
            });
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.setSize(context.camera.fullWidth, context.camera.fullHeight);
            this.renderer.setViewport(0, 0, view.width, view.height);

            // prevent three.js from clearing the buffers provided by the ArcGIS JS API.
            this.renderer.autoClearDepth = false;
            this.renderer.autoClearStencil = false;
            this.renderer.autoClearColor = false;

            // The ArcGIS JS API renders to custom offscreen buffers, and not to the default framebuffers.
            // We have to inject this bit of code into the three.js runtime in order for it to bind those
            // buffers instead of the default ones.
            var originalSetRenderTarget = this.renderer.setRenderTarget.bind(this.renderer);
            this.renderer.setRenderTarget = function (target) {
                originalSetRenderTarget(target);
                if (target == null) {
                    context.bindRenderTarget();
                }
            }

            // setup the three.js scene
            //////////////////////////////////////////////////////////////////////////////////////         
            this.scene = new THREE.Scene();

            // setup the camera
            this.camera = new THREE.PerspectiveCamera();

            // setup scene lighting
            this.ambient = new THREE.AmbientLight(0xffffff, 0.5);
            this.scene.add(this.ambient);
            this.sun = new THREE.DirectionalLight(0xffffff, 0.5);
            this.scene.add(this.sun);

          // setup markers
            this.markerGeometry = new THREE.SphereBufferGeometry(12*1000, 16, 16);
            this.markerMaterial = new THREE.MeshBasicMaterial({ color: 0xe03110, transparent: true, opacity: 0.5});

            this.clock = new THREE.Clock();

            var issMeshUrl = "https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Locomotive_rev.glb"; 
            var loaderGLTF = new THREE.GLTFLoader(); // check this: https://qgenhate.hatenablog.com/ [object not an instance of THREE.Object3D]
            let example = new THREE.Object3D();

            loaderGLTF.load(issMeshUrl,
            function(gltf) {
                console.log("ISS mesh loaded.");
               
                example = gltf.scene;
                this.iss = example;

                // set the specified scale for the model
                this.iss.scale.set(this.issScale, this.issScale, this.issScale);
                
                // add the model
                this.scene.add(this.iss); // original: this.iss
                console.log("ISS mesh added.");

                // Mixer for animation
                this.mixer = new THREE.AnimationMixer(this.iss);
                this.mixer.clipAction(gltf.animations[0]).play();
            
            }.bind(this), undefined, function(error) {
                console.error("Error loading ISS mesh. ", error);
            });

            this.light = new THREE.DirectionalLight(0xffffff, 1);
            this.light.position.set(0, 1, 0);
            this.scene.add(this.light);
          
          // rotation 
              this.up = new THREE.Vector3(0, 0, 1); // used with lookAt: look at the next point at x-axis
              this.axis = new THREE.Vector3();
              this.n  = new THREE.Vector3( ); // normal,
              this.b  = new THREE.Vector3( ); // binormal
              this.M3 = new THREE.Matrix3( );
              this.M4 = new THREE.Matrix4( );
              this.pp = new THREE.Vector3( );
              this.quaternion = new THREE.Quaternion();

            // cleanup after ourselfs
            context.resetWebGLState();
        },
        render: function (context) {

            // update camera parameters
            ///////////////////////////////////////////////////////////////////////////////////
            var cam = context.camera;

            this.camera.position.set(cam.eye[0], cam.eye[1], cam.eye[2]);
            this.camera.up.set(cam.up[0], cam.up[1], cam.up[2]);
            this.camera.lookAt(new THREE.Vector3(cam.center[0], cam.center[1], cam.center[2]));

            // Projection matrix can be copied directly
            this.camera.projectionMatrix.fromArray(cam.projectionMatrix);
          
            if (this.iss) {
                     
                // Add this.mixer.update first; otherwise, the object will not be animated.s
                if (this.mixer) {
                    var scale = 0.0001; //this.gui.getTimeScale();
                    var delta = this.clock.getDelta();

                  this.mixer.update(delta);         
                }

                    if (this.path.length == (this.vertexIdx + 1))
                {
                    this.vertexIdx = 0;
                }
              
                var p = this.path[this.vertexIdx]; // vertexIdx = 0
              var p1 = this.path[this.vertexIdx + 1];
              
            
              // Define Z:
              // It is important that the same Z values are set for both current (pt) and next points (pt1)
              // Otherwise, the object will be tilted.
              const changeZ = 0;
              const offset = 0;
              const offsetZ = 0;

                var pt = new Point({
                    x: p[0] + offset, // longitude
                    y: p[1], // latitude
                    z: p[2] + offsetZ
                });

                pt.spatialReference = SpatialReference.WebMercator;

                //z = offsetZ; // view.basemapTerrain.getElevation(p);

                pos = [pt.x, pt.y, pt.z];

                this.vertexIdx++;

                if (this.path.length == (this.vertexIdx)) {
                    this.vertexIdx--;
                }
              
                var transform = new THREE.Matrix4();
                transform.fromArray(externalRenderers.renderCoordinateTransformAt(view, pos, SpatialReference.WebMercator, new Array(16)));

               this.iss.position.set(transform.elements[12], transform.elements[13], transform.elements[14]);
              
                this.count ++;
                if (this.count === 1) {
                  console.log(transform.elements[12], transform.elements[13], transform.elements[14]);
                }

                var p0;
                var p1;

                if ((this.path.length - 1) == (this.vertexIdx))
                {
                    p0 = this.path[--this.vertexIdx];
                    p1 = this.path[this.vertexIdx];
                }
                else
                {
                    p0 = this.path[this.vertexIdx];
                    p1 = this.path[++this.vertexIdx];
                }
                            
              var rotation = new THREE.Matrix4();
              
                var pt1 = new Point({
                    x: p1[0] + offset, // longitude
                    y: p1[1], // latitude
                    z: p1[2] + offsetZ
                });
              posR = [pt1.x, pt1.y, pt1.z];
              rotation.fromArray(externalRenderers.renderCoordinateTransformAt(view, posR, SpatialReference.WebMercator, new Array(16)));
              // https://answers.unity.com/questions/36255/lookat-to-only-rotate-on-y-axis-how.html
              // how to use '.up' with lookAt?
              //geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( Math.PI / 2 ) );
              this.iss.up = this.up;
              
              this.iss.lookAt(rotation.elements[12], rotation.elements[13], rotation.elements[14]);
            }


            // update lighting
            /////////////////////////////////////////////////////////////////////////////////////////////////////
            //view.environment.lighting.date = Date.now();

            var l = context.sunLight;
            this.sun.position.set(
              l.direction[0],
              l.direction[1],
              l.direction[2]
            );
            this.sun.intensity = l.diffuse.intensity;
            this.sun.color = new THREE.Color(l.diffuse.color[0], l.diffuse.color[1], l.diffuse.color[2]);

            this.ambient.intensity = l.ambient.intensity;
            this.ambient.color = new THREE.Color(l.ambient.color[0], l.ambient.color[1], l.ambient.color[2]);

            // draw the scene
            /////////////////////////////////////////////////////////////////////////////////////////////////////
            this.renderer.resetState();
            context.bindRenderTarget();
            this.renderer.render(this.scene, this.camera);
            externalRenderers.requestRender(view);

            // cleanup
            context.resetWebGLState();
        },
    })
    externalRenderers.add(view, skeletonRenderer);
    // End of externalRenderers

    /// Camera animation
    const camera = view.camera.clone();

    const pt1 = {x: 120.58066534, y: 15.18190446, z: 193.6964};
    const pt2 = {x: 120.57976213, y: 15.1870787, z: 128.02725};
    const pt3 = {x: 120.57975569, y: 15.19070198, z: 138.165};
    const pt4 = {x: 120.57831507, y: 15.19802226, z: 183.82172};
    const pt5 = {x: 120.57478353, y: 15.20799639, z: 145.15981};
    const pt6 = {x: 120.57369966, y: 15.21207364, z: 138.33217};

    const comp_pts = [pt1, pt2, pt3, pt4, pt5, pt6];
    const heading_pts = [331.62, 334.31, 336.19, 323.47, 311.74, 289.63];
    const tilt_pts = [72.29, 81.91, 78.58, 72.66, 72.48, 73.59];

    let abort = false;
    async function startAnimation(slideNo) {
        if (!view.interacting && !abort) {

            if (slideNo < comp_pts.length) {
                if (slideNo === 0) {
                    camera.heading = heading_pts[slideNo];
                    camera.tilt = tilt_pts[slideNo];
                } else {
                    camera.heading = heading_pts[slideNo];
                }
                camera.tilt = tilt_pts[slideNo];
                camera.position = comp_pts[slideNo];
        
                await view.goTo(camera, {animate: true, speedFactor: 0.265, easing: "linear"});
                //requestAnimationFrame(startAnimation);
                window.setTimeout(function() {
                    startAnimation(slideNo + 1);
                }, 0);
            }
        } else {
            abort = true;
        }
    }

    // Initialization

    async function initialization() {
      abort = false;

      viaductLayer.visible = true;
      viaductLayer.renderer = viaductForAnimationRenderer;
      viaductLayer.definitionExpression = "CP = 'CP104'";
      map.basemap = "satellite";
      lotLayer.visible = false;
      structureLayer.visible = false;
      nloLayer.visible = false;
      pierAccessLayer.visible = false;
      utilityPointLayer.visible = false;
      utilityPointLayer1.visible = false;
      utilityLineLayer.visible = false;
      utilityLineLayer1.visible = false;
      pnrLayer.visible = false;

      addStop();
      await startAnimation(0);
      /*
        window.setTimeout(function() {
            startAnimation(0);
        }, 1)
        */
    }
    // TRAIN ANIMATION END //



    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    const LOT_LABEL_CLASS = {
        symbol: {
            type: "text",  // autocasts as new TextSymbol()
            color: "black",
            /*
            font: {  // autocast as new Font()
                family: "Gill Sans",
                size: 8
            }
            */
        },
        labelPlacement: "always-horizontal",
        labelExpressionInfo: {
            expression: "$feature.CN"
        }
    };
      
    let lotDefaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };

    let lotDefaultRenderer = {
      type: "simple",
      symbol: lotDefaultSymbol
    };

    let lotLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: lotDefaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusNVS3 == 1, '1',$feature.StatusNVS3 == 2, '2', $feature.StatusNVS3 == 3, '3', \
                        $feature.StatusNVS3 == 4, '4', $feature.StatusNVS3 == 5, '5', \
                        $feature.StatusNVS3 == 6, '6', $feature.StatusNVS3 == 7, '7', $feature.StatusNVS3)",
        uniqueValueInfos: [
            {
              // All features with value of "North" will be blue
              value: "1",
              label: "Paid",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[1],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "2",
              label: "For Payment Processing",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[2],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "3",
              label: "For Legal Pass",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[3],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "4",
              label: "For Appraisal/Offer to Buy",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[4],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "5",
              label: "For Expro",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[5],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "6",
              label: "with WOP Fully Turned-over",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[6],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "7",
              label: "ROWUA/TUA",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[7],
              }
            }
        ]
    }
      
    function colorLotReqs(){
        return {
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,115,76],
            7: "#55FF00"
        }
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        title: "Land Acquisition",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotLayerRenderer,
        popupTemplate: {
            title: "<p>{Id}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                      {
                        fieldName: "Issue",
                        label: "Remarks"
                      },
                      {
                          fieldName: "OWNER",
                          label: "Land Owner"
                      },
                      {
                          fieldName: "Station1",
                          label: "Station"
                      },
                      {
                          fieldName: "StatusNVS3",
                          label: "<p>Status of Land Acquisition</p>"
                      }
                    ]
                }
            ]
        }
    });
    map.add(lotLayer);

    // Handed-Over Layer
    const handedOverRenderer = {
      type: "simple",
      field: "HandedOver",
      symbol: {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: "#FF00C5",
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.5
        }
    }

    }
    var handedOverLotLayer = new FeatureLayer({
      portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "HandedOver = 1",
        title: "Handed-Over Lots",
        renderer: handedOverRenderer,
        popupEnabled: false
    });
    map.add(handedOverLotLayer);
    handedOverLotLayer.visible = false;


    // Delete this layer later. temporary used to experiment time series chart
    var handedOverLotBackgroundLayer = new FeatureLayer({
        portalItem: {
          id: "032432d931624de9bf5ff03f1f9d7016",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "HandedOver IS NULL",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotDefaultRenderer,
        popupTemplate: {
          title: "<p>{Id}</p>",
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "Issue",
                    label: "Remarks"
                  },
                  {
                      fieldName: "OWNER",
                      label: "Land Owner"
                  },
                  {
                      fieldName: "Station1",
                      label: "Station"
                  },
                  {
                      fieldName: "StatusNVS3",
                      label: "<p>Status of Land Acquisition</p>"
                  }
                ]
            }
          ]
        }
    });
    handedOverLotBackgroundLayer.visible = false;
    map.add(handedOverLotBackgroundLayer);

    // Handed-Over subterranean lots
    var pteLotSubteLayer = new FeatureLayer({
      portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 1",
        title: "PTE Subterranean Lots",
        renderer: handedOverRenderer,
        popupEnabled: false
    });
    map.add(pteLotSubteLayer);
    pteLotSubteLayer.visible = false;

    var pteLotSubteBackgroundLayer = new FeatureLayer({
        portalItem: {
          id: "032432d931624de9bf5ff03f1f9d7016",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 0",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotDefaultRenderer,
        popupTemplate: {
          title: "<p>{Id}</p>",
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "Issue",
                    label: "Remarks"
                  },
                  {
                      fieldName: "OWNER",
                      label: "Land Owner"
                  },
                  {
                      fieldName: "Station1",
                      label: "Station"
                  },
                  {
                      fieldName: "StatusNVS3",
                      label: "<p>Status of Land Acquisition</p>"
                  }
                ]
            }
          ]
        }
    });
    pteLotSubteBackgroundLayer.visible = false;
    map.add(pteLotSubteBackgroundLayer);
    
      
    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
          zoom: 17
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      
      // Structure Layer----------------------------------
      function colorStructureReqs(){
        return {
          1: [112, 173, 71], // Paid #70AD47
          2: [0, 112, 255], // For Payment Processing #0070FF
          3: [255, 255, 0], // For Legal Pass #FFFF00
          4: [255, 170, 0], // For Appraisal/Offer to Compensate #FFAA00
          5: [255, 0, 0], // For Expro #FF0000
          6: [0, 115, 76] //Quit Claim #00734C
        }
      }

      let structureLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: defaultLotSymbolBoundary,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.Status == 1, '1',$feature.Status == 2, '2', \
                          $feature.Status == 3, '3', \
                          $feature.Status == 4, '4', $feature.Status == 5, '5', \
                          $feature.Status == 6, '6', $feature.Status)",
        uniqueValueInfos: [
          {
            // All features with value of "North" will be blue
            value: "1",
            label: "Paid",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[1],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "2",
            label: "For Payment Processing",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[2],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "3",
            label: "For Legal Pass",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[3],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "4",
            label: "For Appraisal/Offer to Buy",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[4],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
        {
            // All features with value of "North" will be blue
            value: "5",
            label: "For Expro",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[5],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "6",
            label: "Quit Claim",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[6],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          }
        ]
      }

      var structureLayer = new FeatureLayer({
        portalItem: {
            id: "ec9dac0c16af4797bb917a0babc735e9",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "Existing Structure",
        outFields: ["*"],
        renderer: structureLayerRenderer,
        popupTemplate: {
          title: "Structure ID: <b>{STRUCTURE_TAG_NO_}</b>" ,
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "STATION",
                  label: "Station"
                },
                {
                  fieldName: "Status",
                  label: "<b>Status of Structure</b>"
                },
                {
                  fieldName: "LOT_OWNER",
                  label: "Lot Owner"
                }
              ]
            }
          ]
        }
      });
      map.add(structureLayer);

      // Structure demolished
      let structureDemolishedRenderer = {
        type: "unique-value",
        field: "REMARKS",
        defaultSymbol: defaultLotSymbolBoundary,  // autocasts as new SimpleFillSymbol()
        uniqueValueInfos: [
          {
            // All features with value of "North" will be blue
            value: "Demolished",
            label: "Demolished",
            symbol: {
              type: "simple-fill",
              color: "#FFAA00",
              style: "solid", // "backward-diagonal"
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "Not Yet",
            label: "Occupied",
            symbol: {
              type: "simple-fill",
              color: "#99A5A2",
              style: "solid",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          }
        ]
      }

      var structureDemolishedLayer = new FeatureLayer({
        portalItem: {
          id: "ec9dac0c16af4797bb917a0babc735e9",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        title: "Demolished Structure",
        outFields: ["*"],
        renderer: structureDemolishedRenderer,
        popupTemplate: {
          title: "Structure ID: <b>{STRUCTURE_TAG_NO_}</b>" ,
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "STATION",
                  label: "Station"
                },
                {
                  fieldName: "Status",
                  label: "<b>Status of Structure</b>"
                },
                {
                  fieldName: "LOT_OWNER",
                  label: "Lot Owner"
                }
              ]
            }
          ]
        }
      });
      map.add(structureDemolishedLayer);

      // ISF Layer----------------------------------
      const outlineColor = "gray";

      var verticalOffsetExisting = {
        screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
      };

      var verticalOffsetNLO = {
        screenLength: 0,
          maxWorldLength: 0,
          minWorldLength: 0
      };

      function getUniqueValueSymbolNLO(name, size) {
        return {
          type: "point-3d", // autocasts as new PointSymbol3D()
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              resource: {
                href: name
              },
              size: size,
              outline: {
                color: "white",
                size: 2
              }
            }
          ],

          verticalOffset: verticalOffsetNLO,

          callout: {
            type: "line", // autocasts as new LineCallout3D()
            color: [128,128,128,0.6],
            size: 0.4,
            border: {
              color: "grey"
            }
          }
        };
      }

      const symbolSize = 30;
      let isfRenderer = {
        type: "unique-value",
        field: "RELOCATION",
        uniqueValueInfos: [
            {
              value: 'RELOCATED',
              label: "Relocated",
              symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Relocated.svg", symbolSize),
            },
            {
                value: 'FOR RELOCATION',
                label: "For Relocation",
                symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LBP.svg", symbolSize),
            }
        ]
      };

      var isfLayer = new FeatureLayer ({
        portalItem: {
            id: "a2e32eb82db84b3a8006e1c1e2cd7874",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "ISF (Informal Settlers Families)",
        outFields: ["*"],
        returnGeometry: true,
        renderer: isfRenderer,
        labelsVisible: false
      });
      map.add(isfLayer);

      // Construction Boundary----------------------------------
      let ConstructionBoundaryFill = {
        type: "unique-value",
        valueExpression: "When($feature.MappingBoundary == 1, 'Boundary', $feature.MappingBoundary)",
        uniqueValueInfos: [
          {
            value: "Boundary",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0,0],
              outline: {
                width: 1.5,
                color: [255,255, 255],
                style: "short-dash"
              }
            }
          }
        ]
      };

      var constBoundary = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        outFields: ["*"],
        renderer: ConstructionBoundaryFill,
        definitionExpression: "MappingBoundary = 1",
        title: "Construction Boundary",
        popupEnabled: false
      });
      map.add(constBoundary);

      // Alignment----------------------------------
      var alignmentLine = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 13,
        outFields: ["*"],
        title: "Alignment",
        popupEnabled: false
      });
      map.add(alignmentLine);

      // Segment DPWH----------------------------------
      var dpwhSegmentLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "DPWH Segment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(dpwhSegmentLayer);

      // BSS Boundary----------------------------------
      /*
      var bssDepotLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        title: "BSS Boundary",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotLayer);
*/
      // Creek Diversion----------------------------------
      var creekDivLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 10,
        title: "Creek Diversion",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(creekDivLayer);

      // Depot Building----------------------------------
      var depotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 6,
        title: "Depot Building",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(depotBuildingLayer);

      // BSS Building----------------------------------
      var bssDepotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        title: "BSS Building",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotBuildingLayer);

      // East Valenzuela----------------------------------
      var evsLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 9,
        title: "East Valenzuela",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(evsLayer);

      // NNC Construction boundary (Senate)----------------------------------
      var senateBoundaryLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "NCC Property",
        outFields: ["*"],
        popupEnabled: false
      });
      //senateBoundaryLayer.list = "hide";
      map.add(senateBoundaryLayer);

      // Station1 box----------------------------------
      let poSectionBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
          {
            value: "U-Shape Retaining Wall",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "Cut & Cover Box",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM Shaft",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "black"
              }
            }
          },
          {
            value: "Station Platform",
            symbol: {
              type: "simple-fill",
              color: [240, 204, 230],
              style: "backward-diagonal",
              outline: {
                width: 0.4,
                color: "black"
              }
            }
          },
          {
            value: "Station Box",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0, 0],
              outline: {
                width: 2,
                color: "red"
              }
            }
          },
          {
            value: "NATM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "grey"
              }
            }
          }
        ]
      };

      var poSectionBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 8,
        renderer: poSectionBoxRenderer,
        title: "Alignment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(poSectionBoxLayer);



      // Station Point----------------------------------
      var stationLayer = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "Station",
        definitionExpression: "Project = 'MMSP'"
                    //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
      });
      stationLayer.listMode = "hide";
      map.add(stationLayer, 0);

      // Get last edited date
      const month = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      function getEditedDateValue() {
        var tempDates = [];

        var query = lotLayer.createQuery();
        //query.fields = ["enddate"];
        query.where = "last_edited_date IS NOT NULL";
        return lotLayer.queryFeatures(query).then(function(response) {
          var stats = response.features;
          stats.forEach((result, index) => {
            var attributes = result.attributes;
            const dates = attributes.last_edited_date;
            tempDates.push(dates);
          });
          const lastDate = Math.max(...tempDates);
          const lastEdit = new Date(lastDate);
          const yyyy = lastEdit.getFullYear();
          const mm = month[lastEdit.getMonth()];
          const dd = lastEdit.getDate();
          const lastEditedDate = `As of ${mm} ${dd}, ${yyyy}`;
          document.getElementById("dateDiv").innerHTML = "As of June 19, 2023";
        });
      }
      getEditedDateValue();

      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;


    /// Popup for lot layer
    const lotStatusArray = [
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro",
        "With FOP Fully Turned-over",
        "ROWUA/TUA"
    ];

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked pierAccessLayer
            const lotNo = event.graphic.attributes.ID;
            const remarks = event.graphic.attributes.Remarks;
            const landOwner = event.graphic.attributes.OWNER;
            const station = event.graphic.attributes.Station1;
            const status = event.graphic.attributes.StatusNVS3;
            const cp = event.graphic.attributes.Package;

            // Convert numeric to date format
            return `<ul><li>Lot No: <b>${lotNo} %</b></li><br>
                    <li>Land Owner:           <b>${landOwner}</b></li><br>
                    <li>Status:         <b>${status}</b></li><br>
                    <li>Station:     <b>${station}</b></li><br>
                    <li>Remarks:               <b>${remarks}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{ID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


    // Structure Layer 
    // Polygon 3D extrution
    const height = 5;
    const edgeSize = 0.3;

    const paid = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [112, 173, 71, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const payp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 112, 255, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const legalpass = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 255, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const otb = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 170, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const expro = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 0, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const quitclaim = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 115, 76, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const structureRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: [0, 0, 0, 0.4]
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: edgeSize
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "StatusStruc",
      legendOptions: {
        title: "Status of Structure"
      },
      uniqueValueInfos: [
        {
          value: 1,
          symbol: paid,
          label: "Paid"
        },
        {
          value: 2,
          symbol: payp,
          label: "For Payment Processing"
        },
        {
          value: 3,
          symbol: legalpass,
          label: "For Legal Pass"
        },
        {
          value: 4,
          symbol: otb,
          label: "For Appraisal/Offer to Buy"
        },
        {
          value: 5,
          symbol: expro,
          label: "For Expro"
        },
        {
          value: 6,
          symbol: quitclaim,
          label: "Quit Claim"
        },
      ]
    }

    var structureLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      title: "Affected Structure",
      renderer: structureRenderer,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      },
      popupTemplate: {
        title: "Structure ID: <p>{STRUCTURE_TAG_NO_}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "STATION",
                label: "Station"
              },
              {
                fieldName: "Status",
                label: "<b>Status of Structure</b>"
              },
              {
                fieldName: "LOT_OWNER",
                label: "Lot Owner"
              }
            ]
          }
        ]
      }
    });
    map.add(structureLayer);


    // Structure (NLO/LO)
    let NLOLORenderer = {
        type: "unique-value",
        field: "Status",
        uniqueValueInfos:[
            {
                value: 1,
                label: "LO (Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "forward-diagonal",
                    color: [128, 128, 128, 1],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            },
            {
                value: 2,
                label: "NLO (Non-Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "vertical",
                    color: [128, 128, 128, 1],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            }
        ]
    };

    var strucOwnershipLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        renderer: NLOLORenderer,
        layerId: 3,
        title: "NLO/LO Ownership (Structure)",
        outFields: ["*"],
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    map.add(strucOwnershipLayer);

    // Status of Relocation (Occupancy)
    const outlineColorOccupancy = "gray";

    var verticalOffsetExistingOccupancy = {
      screenLength: 10,
        maxWorldLength: 10,
        minWorldLength: 10
    };

    function getUniqueValueSymbolOccupancy(name, size) {
      return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: size,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetExistingOccupancy,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.6],
          size: 0.4,
          border: {
            color: "grey"
          }
        }
      };
    }
    const occupancyPointSize = 20;
    let occupancyRenderer = {
      type: "unique-value",
      valueExpression: "When($feature.Occupancy == 0, 'Occupied', \
                      $feature.Occupancy == 1, 'Relocated', $feature.Occupancy)",
      uniqueValueInfos: [
        {
          value: "Occupied",
          label: "Occupied",
          symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/Demolished.png", occupancyPointSize),
        },
        {
          value: "Relocated",
          label: "Relocated",
          symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png", occupancyPointSize),
        },
      ]
    };

    var occupancyLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 5,
      outFields: ["*"],
      title: "Occupancy (Structure)",
      renderer: occupancyRenderer,
      elevationInfo: {
        mode: "relative-to-scene"
      },
      popupTemplate: {
        title: "<p>{StrucID}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
        {
          type: "fields",
          fieldInfos: [
          {
            fieldName: "StrucOwner",
            label: "Structure Owner"
          },
          {
            fieldName: "Municipality"
          },
          {
            fieldName: "Barangay"
          },
          {
            fieldName: "Occupancy",
            label: "<p>Status for Relocation(structure)</p>"
          },
          {
            fieldName: "Name",
          },
          {
            fieldName: "Status",
            label: "NLO/LO Ownership"
          }
          ]
        }
        ]
      }
    });
    map.add(occupancyLayer);


  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  // Station Layer
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "#d4ff33"
          },
          size: 15,
          color: "black",
          haloColor: "black",
          haloSize: 0.5,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 100,
        maxWorldLength: 300,
        minWorldLength: 80
      },

      callout: {
        type: "line", // autocasts as new LineCallout3D()
        color: [128,128,128,0.5],
        size: 0.2,
        border: {
          color: "grey"
        }
      }
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
              //value: "{TEXTSTRING}"
    }
  });

  var stationLayer = new SceneLayer({
    portalItem: {
      id: "26d8f953c71d440bad2daccb8f8c41a6",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    title: "MMSP Stations",
    labelingInfo: [labelClass],
    //renderer: stationsRenderer,
    elevationInfo: {
      mode: "relative-to-ground"
    },
                //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);


  // Tree Cutting Layer
  const cutStatus = {
        tcpapp: "For TCP Application",
        denr: "Submitted to DENR",
        permitc: "With Permit-Not Yet Cut",
        permite: "With Permit-Not Yet Earthballed",
        cut: "Cut",
        earthb: "Earthballed",
        expro: "TCP Expired"

    }

    const cutColor = {
        tcpapp_hex: "#71AB48",
        tcpapp_rgb: [113, 171, 72],

        denr_hex: "#5E4FA2",
        denr_rgb: [94, 79, 162],

        permitc_hex: "#FFFF00",
        permitc_rgb: [255, 255, 0],

        permite_hex: "#FFAA00",
        permite_rgb: [255, 170, 0],

        cut_hex: "#0073FF",
        cut_rgb: [0, 115, 255],

        earthb_hex: "#3288BD",
        earthb_rgb: [50, 136, 189],

        exp_hex: "#FF0000",
        exp_rgb: [255, 0, 0]

    }

    function treeCutting3DSymbol(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriThematicTreesStyle"
      };
    }

    const treeCuttingRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.TCP_Proces == 1, 'tcpapp', $feature.TCP_Proces == 2, 'denr', \
                        $feature.TCP_Proces == 3, 'permitcut', $feature.TCP_Proces == 4, 'permitearthb', \
                        $feature.TCP_Proces == 5, 'cut', $feature.TCP_Proces == 6, 'earthb', \
                        $feature.TCP_Proces == 7, 'tcpexp', 'other')",
        uniqueValueInfos: [
            {
                value: "tcpapp",
                label: "For TCP Application",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
  
            },
            {
                value: "denr",
                label: "Submitted to DENR",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },
            {
                value: "permitcut",
                label: "With Permit-Not Yet Cut",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },
            {
                value: "permitearthb",
                label: "With Permit-Not Yet Earthballed",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },
            {
                value: "cut",
                label: "Cut",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },
            {
                value: "earthb",
                label: "Earthballed",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },
            {
                value: "tcpexp",
                label: "TCP Expired",
                type: "simple",
                symbol: treeCutting3DSymbol("Larix")
            },

        ],
        visualVariables: [
        {
          type: "size",
          axis: "height",
          valueExpression: "When($feature.Status >= 1, 5, 0)",
          valueUnit: "meters"
        },
        {
          type: "color",
          valueExpression: "$feature.TCP_Proces",
          valueExpressionTitle: "Status Color",
          stops: [
            { value:1, color: cutColor[tcpapp_hex]},
            { value:2, color: cutColor[denr_hex]},
            { value:3, color: cutColor[permitc_hex]},
            { value:4, color: cutColor[permite_hex]},
            { value:5, color: cutColor[cut_hex]},
            { value:6, color: cutColor[earthb_hex]},
            { value:7, color: cutColor[exp_hex]},
          ],
          legendOptions: {
            showLegend: false
          }
        },
      ]
    };

    var treeCuttingLayer = new FeatureLayer ({
        portalItem: {
            id: "30cdb9f9775146308a05dd17cfbfa87a",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        outFields: ["*"],
        title: "Status of Tree Cutting",
        renderer: treeCuttingRenderer,
        popupTemplate: {
          title: "<b>{TCP_Proces}</b>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                      {
                        fieldName: "Scientific",
                        label: "Scientific Name"
                      },
                      {
                        fieldName: "Common_Nam",
                        label: "Common Name"
                      },
                      {
                        fieldName: "TreeStatus",
                        label: "Tree Status"
                      },
                      {
                        fieldName: "Recom",
                        label: "Recommendation"
                      },
                      {
                        fieldName: "City"
                      },
                      {
                        fieldName: "Id",
                        label: "Tree ID"
                      },
                      {
                        fieldName: "TCP_Proces",
                        label: "Tree Cutting"
                      },
                      {
                        fieldName: "Remarks2",
                        label: "Remarks"
                      }
                    ]
                }
            ]
        }
    });
    map.add(treeCuttingLayer,2);

    // Tree Compensation
    const compenStatus = {
            appraisal: "For Appraisal",
            serving: "For Serving of RfD/OtC",
            served: "Served RfD/OtC",
            legalp: "For Legal Pass",
            payp: "For Payment Processing/Obligation/Signing of ACRCT",
            check: "For Check Issuance",
            paid: "Paid",
            nocompen: "No Compensation",
            donation: "For Donation",
            expro: "Expro",
            row: "Right of Way Usage Agreement (ROWUA)"
        }

    const compenColor = {
        appraisal_hex: "#FFFF00",
        appraisal_rgb: [255, 255, 0],

        serving_hex: "#FF5500",
        serving_rgb: [255, 85, 0],

        served_hex: "#FF73DF",
        served_rgb: [255, 115, 223],

        legalp_hex: "#00A884",
        legalp_rgb: [0, 168, 132],

        payp_hex: "#FFAA00",
        payp_rgb: [255, 170, 0],

        check_hex: "#3288BD",
        check_rgb: [50, 136, 189],

        paid_hex: "#71AB48",
        paid_rgb: [113, 171, 72],

        nocompen_hex: "#0073FF",
        nocompen_rgb: [0, 115, 255],

        donation_hex: "#5E4FA2",
        donation_rgb: [94, 79, 162],

        expro_hex: "#FF0000",
        expro_rgb: [255, 0, 0],

        row_hex: "#E1E1E1",
        row_rgb: [225, 225, 225]
    }

    const treeCompensationRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.Tree_Compe == 1, 'appraisal', $feature.Tree_Compe == 2, 'serving', \
                        $feature.Tree_Compe == 3, 'served', $feature.Tree_Compe == 4, 'legalp', \
                        $feature.Tree_Compe == 5, 'payp', $feature.Tree_Compe == 6, 'check', \
                        $feature.Tree_Compe == 7, 'paid', $feature.Tree_Compe == 8, 'nocompen', $feature.Tree_Compe == 9, 'donation', \
                        $feature.Tree_Compe == 10, 'expro', $feature.Tree_Compe == 11, 'row', $feature.Tree_Compe)",
        uniqueValueInfos: [
            {
              value: "appraisal",
              label: compenStatus.appraisal,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
  
            },
            {
              value: "serving",
              label: compenStatus.serving,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "served",
              label: "compenStatus.served",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "legalp",
              label: compenStatus.legalp,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "payp",
              label: compenStatus.payp,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "check",
              label: compenStatus.check,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "paid",
              label: compenStatus.paid,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "nocompen",
              label: compenStatus.nocompen,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "donation",
              label: compenStatus.donation,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "expro",
              label: compenStatus.expro,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
            {
              value: "row",
              label: compenStatus.row,
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
            },
        ],
        visualVariables: [
        {
          type: "size",
          axis: "height",
          valueExpression: "When($feature.Tree_Compe >= 1, 11, 0)",
          valueUnit: "meters"
        },
        {
          type: "color",
          valueExpression: "$feature.Tree_Compe",
          valueExpressionTitle: "Status Color",
          stops: [
            { value:1, color: compenColor[appraisal_hex]},
            { value:2, color: compenColor[serving_hex]},
            { value:3, color: compenColor[served_hex]},
            { value:4, color: compenColor[legalp_hex]},
            { value:5, color: compenColor[payp_hex]},
            { value:6, color: compenColor[check_hex]},
            { value:7, color: compenColor[paid_hex]},
            { value:8, color: compenColor[nocompen]},
            { value:9, color: compenColor[donation_hex]},
            { value:10, color: compenColor[expro_hex]},
            { value:11, color: compenColor[row_hex]},
          ],
          legendOptions: {
            showLegend: false
          }
        },
      ]
    };

    var treeCompensationLayer = new FeatureLayer ({
      portalItem: {
        id: "30cdb9f9775146308a05dd17cfbfa87a",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      outFields: ["*"],
      layerId: 1,
      title: "Status of Tree Compensation",
      renderer: treeTree_CompeRenderer,
      popupTemplate: {
        title: "<h5>{Tree_Compe}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Scientific",
                label: "Scientific Name"
              },
              {
                fieldName: "Common_Nam",
                label: "Common Name"
              },
              {
                fieldName: "TreeStatus",
                label: "Tree Status"
              },
              {
                fieldName: "Recom",
                label: "Recommendation"
              },
              {
                fieldName: "City"
              },
              {
                fieldName: "Id",
                label: "Tree ID"
              },
              {
                fieldName: "Remarks2",
                label: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(treeCompensationLayer,1);


    // UTILITY RELOCATIOIN
    // 1. Utility Point
    var labelUtilPtSymbol = {
      type: "label-3d", // autocasts as new LabelSymbol3D()
      labelPlacement: "above-center",
      labelExpressionInfo: {
        //value: "{Company}",
        expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')" //$feature.Comp_Agency
      },
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "black"
          },
          halo: {
            color: [255, 255, 255, 0.7],
            size: 2
          },
          size: 10
        }
      ],
    };

    // Esri Icon Symbol
    function IconSymbol(name) {
      return {
        type: "web-style", // autocasts as new WebStyleSymbol()
        name: name,
        styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
      };
    }

    // Utility Point Symbol
    /// https://developers.arcgis.com/javascript/latest/guide/esri-web-style-symbols-3d/
    function utilPtSymbolInfra(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriInfrastructureStyle"
      };
    }

    function utilPtSymbolStreet(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriRealisticStreetSceneStyle"
      };
    }

    function utilPtSymbolIcons(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriIconsStyle"
      };
    }

    /* custom 3D Web Style for Utility Pole */
    // Choice: 3D_Electric_Pole, 3D_Drain_Box, 3D_Water_Valve, 3D_Telecom_BTS, 3D_TelecomCATV_Pole
    function customSymbol3D(name) {
      return {
        type: "web-style",
        portal: "https://www.maps.arcgis.com",

        // IMPORTANT: Your browser needs to be able to open the following link. It will say insecure so need to go to advanced.
        styleUrl: "https://www.maps.arcgis.com/sharing/rest/content/items/c04d4d4145f64f8fa38407dd5331dd1f/data",
        name: name
      };
    }

    /* Company and Utilty Relocation Status Symbols with Callout */
    var verticalOffsetExisting = {
      screenLength: 10,
      maxWorldLength: 10,
      minWorldLength: 15
    };

    var verticalOffsetRelocation = {
      screenLength: 10,
      maxWorldLength: 30,
      minWorldLength: 35
    };


    // Function that automatically creates the symbol for the points of interest
    function getUniqueValueSymbol(name, color, sizeS, util) {
      // The point symbol is visualized with an icon symbol. To clearly see the location of the point
      // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
      // of the point feature.
      if (util == "Existing") {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetExisting,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
      };
      } else {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetRelocation,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
      };
      }
    }

    var utilTypePtRenderer = {
      type: "unique-value", //"unique-value", "simple"
      //Field: "UtilType2",
      //defaultSymbol: ,
      //valueExpression: "When($feature.UtilType == 1, 'Telecom', $feature.UtilType == 2, 'Water',$feature.UtilType == 3, 'Power', $feature.UtilType)",
      valueExpression: "When($feature.UtilType2 == 1, 'Telecom Pole (BTS)', \
                            $feature.UtilType2 == 2, 'Telecom Pole (CATV)', \
                            $feature.UtilType2 == 3, 'Water Meter', \
                            $feature.UtilType2 == 4, 'Water Valve', \
                            $feature.UtilType2 == 5, 'Manhole', \
                            $feature.UtilType2 == 6, 'Drain Box', \
                            $feature.UtilType2 == 7, 'Electric Pole', \
                            $feature.UtilType2 == 8, 'Street Light', \
                            $feature.UtilType2 == 9, 'Junction Box', \
                            $feature.UtilType2 == 10, 'Coupling', \
                            $feature.UtilType2 == 11, 'Fitting', \
                            $feature.UtilType2 == 12, 'Transformer', \
                            $feature.UtilType2 == 13, 'Truss Guy', \
                            $feature.UtilType2 == 14, 'Concrete Pedestal', \
                            $feature.UtilType2 == 15, 'Ground', \
                            $feature.UtilType2 == 16, 'Down Guy', \
                            $feature.UtilType2 == 17, 'Entry/Exit Pit', \
                            $feature.UtilType2 == 18, 'Handhole', \
                            $feature.UtilType2 == 19, 'Transmission Tower', \
                            $feature.UtilType)",
      uniqueValueInfos: [
        {
          value: "Telecom Pole (BTS)",
          symbol: customSymbol3D("3D_Telecom_BTS")
        },
        {
          value: "Telecom Pole (CATV)",
          symbol: customSymbol3D("3D_TelecomCATV_Pole")
        },
        {
          value: "Manhole",
          symbol: utilPtSymbolStreet("Storm_Drain")
        },
        {
          value: "Electric Pole",
          //symbol: utilPtSymbolInfra("Powerline_Pole")
          symbol: customSymbol3D("3D_Electric_Pole")
        },
        {
          value: "Street Light",
          symbol: utilPtSymbolStreet("Overhanging_Street_and_Sidewalk_-_Light_on")
        },
        {
          value: "Junction Box",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Coupling",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Fitting",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Transformer",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Truss Guy",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Concrete Pedestal",
          symbol: customSymbol3D("Concrete Pedestal")
        },
        {
          value: "Ground",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Down Guy",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Entry/Exit Pit",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Handhole",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Transmission Tower",
          symbol: utilPtSymbolInfra("Powerline_Pole")
        }
      ],
      visualVariables: [
        {
          type: "size",
          axis: "height",
          field: "SIZE",
          valueUnit: "meters"
        },
        {
          type: "rotation",
          field: "ROTATION"
        },
        /*
        {
          type: "opacity",
          valueExpression: "($feature.Status * $feature.LAYER) / 2",
          // when utility is demolished, it becomes transparent
          //valueExpression: "When($feature.Status == 1 && $feature.LAYER == 1, 0, 1)",
          //field: "SIZE",
          stops: [
            {value: 0, opacity: 0.005}, //  want to delete
            {value: 1, opacity: 1}, // want to visualize
          ],
          legendOptions: {
            showLegend: false
          }
        }
  */
      ]
    };

    var utilReloSymbolRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      valueExpression: "When($feature.Remarks == 'pending', 'NoAction', \
                            $feature.Status == 1 && $feature.LAYER == 1, 'DemolishComplete',\
                            $feature.Status == 0 && $feature.LAYER == 1, 'DemolishIncomplete',\
                            $feature.Status == 0 && $feature.LAYER == 2, 'RelocIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 2, 'RelocComplete', \
                            $feature.Status == 0 && $feature.LAYER == 3, 'NewlyAdded', \
                            $feature.Status == 1 && $feature.LAYER == 3, 'NewlyAddedComplete',$feature.Comp_Agency)", 
      //field: "Company",
      uniqueValueInfos: [
        {
          value: "DemolishIncomplete",
          label: "To be Demolished",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Demolished.png",
            "#D13470",
            20,
            "Relocation"
          )
        },
        {
          value: "DemolishComplete",
          label: "Demolision Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png",
            "#D13470",
            25,
            "Relocation"
            )
        },
        {
          value: "RelocIncomplete",
          label: "Proposed Relocation",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Relocatd.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "RelocComplete",
          label: "Relocation Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Utility_Relocated_Completed_Symbol.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "NewlyAdded",
          label: "Add New Utility",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "NewlyAddedComplete",
          label: "Newly Utility Added",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded_Completed.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "NoAction",
          label: "Require Data Checking",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
            "#D13470",
            35,
            "Relocation"
            )
        }
      ]
    };

    var utilityPointLayer = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 1,
      title: "Relocation Plan (Point)",
      outFields: ["*"],
      renderer: utilTypePtRenderer,
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.Height"
        },
      unit: "meters"
      //offset: 0
      },
      popupTemplate: {
        title: "<h5>{Comp_Agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated",
            title: "Go to Relocated"
          }
          ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(utilityPointLayer, 3);

    /* Symbols with callout */
    // To locate a symbol with callout on the ground, 
    // If basemap elevation layer is on, use "relative-to-scene"
    // If basemap elevatio layer is off, use "absolute-height"

    var utilityPointLayer1 = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 1,
      title: "Utility 3D Render Test",
      outFields: ["*"],
      renderer: utilReloSymbolRenderer,
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.Height"
        },
        unit: "meters"
      //offset: 0
      },
      labelingInfo: [labelUtilPtSymbol],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    utilityPointLayer1.listMode = "hide";
    map.add(utilityPointLayer1);



    // 2. Utilit Line
    var utilityLineLayerLabelClass = {
      type: "label-3d", // autocasts as new LabelSymbol3D()
      labelPlacement: "above-center", // Polyline has not choice
      labelExpressionInfo: {
        expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')"
      },
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "black"
          },
          halo: {
            color: [255, 255, 255, 0.7],
            size: 2
          },
          size: 10
        }
      ],
    };

    const options = { // Circle
      profile: "circle",
      cap: "none",
      join: "miter",
      width: 0.5,
      height: 0.5,
      //color: [200, 200, 200],
      profileRotation: "all"
    };

    const options1 = { // rectangular
      profile: "quad",
      cap: "none",
      join: "miter",
      width: 0.5,
      height: 0.5,
      color: [200, 200, 200],
      profileRotation: "heading"
    };

    /* The colors used for the each transit line */

    const colorsRelocation = {
      1: [32,178,170, 0.5], //Telecom Line
      2: [112,128,144, 0.5], // Internet Cable Line
      3: [0, 128, 255, 0.5], // Water Distribution Pipe
      4: [224, 224, 224, 0.5], // Sewage
      5: [105,105,105, 0.5], // Drainage
      6: [205,133,63, 0.5], // Canal
      7: [139,69,19, 0.5], // Creek
      8: [211,211,211, 0.5] // Elecric Line
    };

    const colorsExisting = {
      1: [229, 229, 229, 0.1], //Telecom/CA (Utility TYpe)
      2: [229, 229, 229, 0.1], // Water
      3: [229, 229, 229, 0.1], // Power
    };

    var utilityLineLayer = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 2,
      title: "Relocation Plan (Line)",
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.height"
        },
        unit: "meters"
        //offset: 0
      },
      outFields: ["*"],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated-line",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(utilityLineLayer, 4);

    /* Utility Line rendnerer*/
    function lineSizeShapeSymbolLayers(profile, cap, join, width, height, profileRotation, property){
      return {
        type: "line-3d",
        symbolLayers: [
          {
            type: "path",
              profile: profile,
              material: {
                color: colorsRelocation[property]
              },
              width: width,
              height: height,
              join: join,
              cap: cap,
              anchor: "bottom",
              profileRotation: profileRotation
          }
        ]
      }
    }

    function renderutilityLineLayer() {
      const renderer = new UniqueValueRenderer({
        field: "utiltype2"
      });

      for (let property in colorsRelocation) { // For each utility type 2
        if (property == 1) { // If utility type2 === Telecom Line
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.5,0.5,"all", property)
          });

        } else if (property == 2) { // "Internet Cable Line"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.4,0.4,"all", property)
          });

        } else if (property == 3) { // "Water Distributin Pipe"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1, "all", property)
          });

        } else if (property == 4) { // "Sewerage"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });

        } else if (property == 5) { // "Drainage"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });
        
        } else if (property == 6) { // "Canal"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("quad","none","miter", 2, 2,"all", property)
          });

        } else if (property == 7) { // "Creek"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });

        } else if (property == 8) { // "Electric Line"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.3, 0.3,"all", property)
          });

        } else {// end of 'property == '1'
          renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("quad","none","miter", 0.3, 0.3,"all", property)

          });
        }
      }
      utilityLineLayer.renderer = renderer;
    }

    renderutilityLineLayer();

    /*Line for Symbols */
    var utilityLineLayer1 = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 2,
      title: "utilityLineLayer",
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.height"
        },
        unit: "meters"
        //offset: 0
      },
      outFields: ["*"],
      renderer: utilReloSymbolRenderer,
      labelingInfo: [utilityLineLayerLabelClass],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated-line",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    utilityLineLayer1.listMode = "hide";
    map.add(utilityLineLayer1);


    // Viaduct Layer
    const colors = {
      1: [225, 225, 225, 0.1], // To be Constructed (white)
      2: [130, 130, 130, 0.5], // Under Construction
      3: [255, 0, 0, 0.8], // Delayed
      4: [0, 112, 255, 0.8], // Completed #0070FF
    };

    let viaductForAnimationRenderer = {
      type: "simple",
      symbol: {
        type: "mesh-3d",
        symbolLayers: [
          {
            type: "fill",
            material: {
              color: "gray",
              colorMixMode: "replace"
            },
            edges: {
              type: "solid",
              color: [225, 225, 225, 0.3]
            }
          }
        ]
      }
    }


    let viaductRenderer = {
      type: "unique-value",
      defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
      valueExpression: "When($feature.Status1 == 1, 'toBeConstructed',$feature.Status1 == 4, 'Completed', $feature.Status1)",
      uniqueValueInfos: [
        {
          value: "toBeConstructed",
          label: "To be Constructed",
          symbol: {
          type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: colors[1],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
        },
        {
          value: "Completed",
          label: "Completed",
          symbol: {
          type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: colors[4],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
        },
      ]
    }

    var viaductLayer = new SceneLayer({
      portalItem: {
        id: "a9c0878766964fa794cc67bbf38b7a09",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      // popupTemplate: viadTemplate,
      elevationInfo: {
        mode: "absolute-height" //absolute-height, relative-to-ground
      },
      title: "Viaduct",
      outFields: ["*"],
      renderer: viaductRenderer
    });
    map.add(viaductLayer);

    // Station structures
    const structureStatusColor = {
    1: [225, 225, 225, 0.1],
    2: [0, 112, 255, 0.8],
  }


  const structureStatusRenderer = {
    type: "unique-value",
    field: "Status",
    uniqueValueInfos: [
      {
        value: 1,
        label: "To be Constructed",
        symbol: {
            type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: structureStatusColor[1],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
      },
      {
        value: 4,
        label: "Completed",
        symbol: {
            type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: structureStatusColor[2],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
      }
    ]
  }

const buildingLayer = new BuildingSceneLayer({ 
    portalItem: {
      id: "19fcf150d0474029a49643408a7c17dc", 
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
  outFields: ["*"],
  title: "N2 Station Structures"
  });
  map.add(buildingLayer);

  var columnsLayer = null;
  var floorsLayer = null;
  var wallsLayer = null;

  // Discipline: Structural
  var stFramingLayer = null;
  var stColumnLayer = null;
  var stFoundationLayer = null;
  
  //
  var fullModelLayer = null;
  var defaultLayer = null;

  buildingLayer.when(() => {
    // Iterate through the flat array of sublayers and extract the ones
    // that should be excluded from the slice widget
    buildingLayer.allSublayers.forEach((layer) => {
      // modelName is standard accross all BuildingSceneLayer,
      // use it to identify a certain layer
      switch (layer.modelName) {
        // Because of performance reasons, the Full Model view is
        // by default set to false. In this scene the Full Model should be visible.
        case "FullModel":
          layer.visible = true;
          break;
        
          case "Columns":
            columnsLayer = layer;
            //excludedLayers.push(layer);
            break;

          case "Floors":
            floorsLayer = layer;
            //excludedLayers
            break;

          case "Walls":
            wallsLayer = layer;
            break;
                
          case "StructuralFraming":
            stFramingLayer = layer;
            break;
          
          case "StructuralColumns":
            stColumnLayer = layer;
            break;
          
          case "StructuralFoundation":
            stFoundationLayer = layer;
            break;
            
          default:
            layer.visible = true;
        }
    });
    // setSliceWidget();
  });



    
  // Filter by Contract Package

  function updateSummary(cpValue) {
    
    totalNumberOfLots();
    totalNumberOfStructures();
    totalProgressUtility();
    totalProgressViaduct();

    pteNumberLot();
    pteNumberStructure();

    updateChartLot(cpValue);
    updateChartStructure(cpValue);
    updateChartNLO(cpValue);
    updateChartCutting(cpValue);
    updateChartTreeComp(cpValue);
    updateChartUtilityPoint(cpValue);
    updateChartUtilityLine(cpValue);
    updateChartViaduct(cpValue);

    updateMoaChartLot(cpValue);
    updateMoaChartStructure(cpValue);

    timeSeriesChartLand(cpValue);
  }

  const viaductChartDiv = document.getElementById("viaductChartDiv");
  const timeSeriesChartViaductDiv = document.getElementById("timeSeriesChartViaduct");

  document.getElementById("contractPackageDiv").addEventListener("click", changeProject);
    function changeProject(event) {
      const value = event.srcElement.id;

      const cpExpression = "CP = '" + value + "'";

      if (value === "All") {
        lotLayer.definitionExpression = null;
        structureLayer.definitionExpression = null;
        nloLayer.definitionExpression = null;
        occupancyLayer.definitionExpression = null;
        strucOwnershipLayer.definitionExpression = null;
        treeCuttingLayer.definitionExpression = null;
        treeCompensationLayer.definitionExpression = null;
        utilityPointLayer.definitionExpression = null;
        utilityPointLayer1.definitionExpression = null;
        utilityLineLayer.definitionExpression = null;
        utilityLineLayer1.definitionExpression = null;
        pierAccessLayer.definitionExpression = null;
        viaductLayer.definitionExpression = null;
        pnrLayer.definitionExpression = null;

        pierAccessLayer.visible = true;
        viaductChartDiv.style.display = 'block';
        viaductNumberDiv.style.display = 'block';

        pnrLayer.visible = true;
        buildingLayer.visible = false;

        updateSummary(value);
        timeSeriesChartViaduct(value);

        zoomToLayer(pierAccessLayer);

      } else if (value === "CP105") {
        lotLayer.definitionExpression = cpExpression;
        structureLayer.definitionExpression = cpExpression;
        nloLayer.definitionExpression = cpExpression;
        occupancyLayer.definitionExpression = cpExpression;
        strucOwnershipLayer.definitionExpression = cpExpression;
        treeCuttingLayer.definitionExpression = cpExpression;
        treeCompensationLayer.definitionExpression = cpExpression;
        utilityPointLayer.definitionExpression = cpExpression;
        utilityPointLayer1.definitionExpression = cpExpression;
        utilityLineLayer.definitionExpression = cpExpression;
        utilityLineLayer1.definitionExpression = cpExpression;

        pierAccessLayer.visible = false;
        pnrLayer.definitionExpression = false;

        buildingLayer.visible = false;

        // Viaduct layer has no CP105 so need to hide its chart
        viaductLayer.visible = false;
        viaductChartDiv.style.display = 'none';
        viaductNumberDiv.style.display = 'none';

        updateSummary(value);
        timeSeriesChartViaduct(value);

        zoomToLayer(lotLayer);

      } else {
        lotLayer.definitionExpression = cpExpression;
        structureLayer.definitionExpression = cpExpression;
        nloLayer.definitionExpression = cpExpression;
        occupancyLayer.definitionExpression = cpExpression;
        strucOwnershipLayer.definitionExpression = cpExpression;
        treeCuttingLayer.definitionExpression = cpExpression;
        treeCompensationLayer.definitionExpression = cpExpression;
        utilityPointLayer.definitionExpression = cpExpression;
        utilityPointLayer1.definitionExpression = cpExpression;
        utilityLineLayer.definitionExpression = cpExpression;
        utilityLineLayer1.definitionExpression = cpExpression;
        pierAccessLayer.definitionExpression = cpExpression;
        viaductLayer.definitionExpression = cpExpression;
        pnrLayer.definitionExpression = cpExpression;

        viaductChartDiv.style.display = 'block';
        viaductNumberDiv.style.display = 'block';

        stationStructuresRendererCP(value);
        
        updateSummary(value);
        timeSeriesChartViaduct(value);

        zoomToLayer(pierAccessLayer);
      }
    }



    // Contents including chart
    // Total Number
    // Thousand separators function
    function thousands_separators(num) {
      var num_parts = num.toString().split(".");
      num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return num_parts.join(".");
    }

    var highlightSelect;

    const lotNumberDiv = document.getElementById("lotNumberDiv");
    const pteLotNumberDiv = document.getElementById("pteLotNumberDiv");
    const structureNumberDiv = document.getElementById("structureNumberDiv");
    const pteStructureNumberDiv = document.getElementById("pteStructureNumberDiv");
    const nloNumberDiv = document.getElementById("nloNumberDiv");
    const treeNumberDiv = document.getElementById("treeNumberDiv");
    const utilityNumberDiv = document.getElementById("utilityNumberDiv");
    const viaductNumberDiv = document.getElementById("viaductNumberDiv");

    document.getElementById("utilityPointChartDiv").innerHTML = `<br>UTILITY POINT`;
    document.getElementById("utilityLineChartDiv").innerHTML = `<br><br><br>UTILITY LINE`;

    // 1. Total Number of Lots
    function totalNumberOfLots(){
      var totalLot = {
        onStatisticField: "CASE WHEN StatusLA >= 0 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalLot",
        statisticType: "sum"
      };
      var query = lotLayer.createQuery();
      query.outStatistics = [totalLot];
      query.returnGeometry = true;

      lotLayer.queryFeatures(query).then(function(response){
        var stats = response.features[0].attributes;
        const LOT_TOTAL = thousands_separators(stats.totalLot);

        lotNumberDiv.innerHTML = `TOTAL LOTS<br><br><b>${LOT_TOTAL}</b>`;
      });
    }

    totalNumberOfLots();

    // Total number of handed-over lots
    function pteNumberLot(){
        var total_pte_lot = {
            onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_pte_lot",
            statisticType: "sum"
        };

        var total_lot_N = {
            onStatisticField: "CASE WHEN StatusLA >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lot_N",
            statisticType: "sum"
        };
        var query = lotLayer.createQuery();
        query.outStatistics = [total_pte_lot, total_lot_N];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const pte = stats.total_pte_lot;
            const totalN = stats.total_lot_N;
            const percPTE = ((pte/totalN)*100).toFixed(0);

            const value = percPTE == "Infinity" ? "N/A" : percPTE + "% (" + pte + ")";
            pteLotNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
        });
    }
    pteNumberLot();

    // Total number of structures
    function totalNumberOfStructures(){
      var totalStructure = {
        onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalStructure",
        statisticType: "count"
      };
      var query = structureLayer.createQuery();
      query.outStatistics = [totalStructure];
      query.returnGeometry = true;

      structureLayer.queryFeatures(query).then(function(response){
        var stats = response.features[0].attributes;

        const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
        structureNumberDiv.innerHTML = `TOTAL STRUCTURES<br><br><b>${STRUCTURE_TOTAL}</b>`;
      });
    }
    totalNumberOfStructures();

    // Total number of PTE for structure
    function pteNumberStructure() {
        var total_pte_structure = {
            onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_pte_structure",
            statisticType: "sum"
        };

        var total_struc_N = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_struc_N",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_pte_structure,total_struc_N];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const pte = stats.total_pte_structure;
            const totalN = stats.total_struc_N;
            const percPTE = ((pte/totalN)*100).toFixed(0);

            const value = percPTE + "% (" + pte + ")";
            pteStructureNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
        });
    }
    pteNumberStructure();

      // Total progress for both points and lines combined
  function totalProgressPt() {
    var total_util_number = {
      onStatisticField: "Status",
      outStatisticFieldName: "total_util_number",
      statisticType: "count"
    };

    var total_prog_util = {
      onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_prog_util",
      statisticType: "sum"
    };

    var query = utilityPointLayer.createQuery();
    query.outStatistics = [total_util_number, total_prog_util];
    query.returnGeometry = true;

    return utilityPointLayer.queryFeatures(query).then(function(response) {
      var stats = response.features[0].attributes;
      const progress = stats.total_prog_util;
      const total = stats.total_util_number;
      const perc = (progress/total)*100;

      const compileArray = [total, progress];
      return compileArray;
    });
  }

  function totalProgressLine(compileArray) {
    var total_util_number = {
      onStatisticField: "Status",
      outStatisticFieldName: "total_util_number",
      statisticType: "count"
    };

    var total_prog_util = {
      onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_prog_util",
      statisticType: "sum"
    };

    var query = utilityLineLayer.createQuery();
    query.outStatistics = [total_util_number, total_prog_util];
    query.returnGeometry = true;

    utilityLineLayer.queryFeatures(query).then(function(response) {
      var stats = response.features[0].attributes;
      const progress = stats.total_prog_util;
      const total = stats.total_util_number;
      const perc = (progress/total)*100;

      const totalAll = total + compileArray[0];
      const progressAll = progress + compileArray[1];

      const total_count = thousands_separators(totalAll);
      const totalperc = (progressAll/totalAll)*100;
      const total_utility = totalperc.toFixed(1);
      utilityNumberDiv.innerHTML = `TOTAL PROGRESS<br><br><b>${total_utility} %</b><br><br>(${total_count})`;
    });
  }

  function totalProgressUtility(){
    totalProgressPt().then(totalProgressLine)
  };
  totalProgressUtility();

  function totalProgressViaduct(){
      var total_viaduct_comp = {
        onStatisticField: "CASE WHEN Status1 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_viaduct_comp",
        statisticType: "sum"
      };

      var total_viaduct_all = {
        onStatisticField: "Status1",
        outStatisticFieldName: "total_viaduct_all",
        statisticType: "count"
      };

      var query = viaductLayer.createQuery();
      query.outStatistics = [total_viaduct_all, total_viaduct_comp];
      query.returnGeometry = true;

      viaductLayer.queryFeatures(query).then(function(response){
        var stats = response.features[0].attributes;
        const viaduct_total = stats.total_viaduct_all;
        const viaduct_comp = stats.total_viaduct_comp;

        const PROGRESS = ((viaduct_comp / viaduct_total)*100).toFixed(1);
        const total = thousands_separators(viaduct_total); 

        viaductNumberDiv.innerHTML = `TOTAL PROGRESS<br><br><b>${PROGRESS} %</b><br><br>(${total})`;;
      });
    }
    totalProgressViaduct();

    // CHART PANEL FOR LOT
    const LEGEND_FONT_SIZE = "0.9em";
    var root = am5.Root.new("landPieChartDiv");
    root._logo.dispose();

    const statusLot = ["Handed-Over", "Paid", "For Payment Processing",
                       "For Legal Pass", "For Appraisal/Offer to Buy",
                       "For Expro"];

    function updateChartLot(cpValue) {
        root.container.children.clear();
        // First, define statuses
        var total_handedover_lot = {
            onStatisticField: "CASE WHEN StatusLA = 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_handedover_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusLA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusLA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusLA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otb_lot = {
            onStatisticField: "CASE WHEN StatusLA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otb_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN StatusLA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_handedover_lot, total_paid_lot, total_payp_lot,
                                total_legalpass_lot, total_otb_lot, total_expro_lot];
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const handedover = stats.total_handedover_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otb = stats.total_otb_lot;
            const expro = stats.total_expro_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusLot[0]) {
            selectedStatus = 0;
          } else if (SELECTED == statusLot[1]) {
            selectedStatus = 1;
          } else if (SELECTED == statusLot[2]) {
            selectedStatus = 2;
          } else if (SELECTED == statusLot[3]) {
            selectedStatus = 3;
          } else if (SELECTED == statusLot[4]) {
            selectedStatus = 4;
          } else if (SELECTED == statusLot[5]) {
            selectedStatus = 5;
          } else {
            selectedStatus = null;
          }

          var query = lotLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "StatusLA = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 

          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              //chartLayerView = layerView;

              lotLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusLA = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusLot[0],
              value: handedover,
              sliceSettings: {
                fill: am5.color("#00c5ff")
              }
            },
            {
              category: statusLot[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70ad47")
              }
            },
            {
              category: statusLot[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070ff")
              }
            },
            {
              category: statusLot[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#ffff00")
              }
            },
            {
              category: statusLot[4],
              value: otb,
              sliceSettings: {
                fill: am5.color("#ffaa00")
              }
            },
            {
              category: statusLot[5],
              value: expro,
              sliceSettings: {
                fill: am5.color("#ff0000")
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
        }); // End of queryFeatures
    } // End of updateChartLot()
    updateChartLot();

    var root2 = am5.Root.new("chartMoaLotDiv");
    root2._logo.dispose();
        var myTheme = am5.Theme.new(root2);

        myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });
        const statusMOA = ["For Negotiation",
                            "Expropriation",
                            "Donation",
                            "CA 141",
                            "No Need to Acquire"
                          ];

    function updateMoaChartLot(cpValue) {
        root2.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_ca141_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ca141_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nego = stats.total_nego_lot;
            const expro = stats.total_expro_lot;
            const donate = stats.total_donate_lot;
            const ca141 = stats.total_ca141_lot;
            const noneed = stats.total_noneed_lot;

                              // Set themes
         // https://www.amcharts.com/docs/v5/concepts/themes/
        root2.setThemes([
          am5themes_Animated.new(root2),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root2.container.children.push(
          am5xy.XYChart.new(root2, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,

          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root2, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root2, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root2, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root2, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);

        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
          fontSize: 10
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root2, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root2, {
            locationY: 1,
            sprite: am5.Label.new(root2, {
              text: "{value}",
              fill: root2.interfaceColors.get("alternativeText"),
              centerY: 3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
           if (SELECTED == statusMOA[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusMOA[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusMOA[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusMOA[3]) {
            selectedStatus = 4;
          }  else if (SELECTED == statusMOA[4]) {
            selectedStatus = 5;
          }

          var query = lotLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 
          
          view.whenLayerView(lotLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          lotLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
          where: "MoA = " + selectedStatus
          //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerView
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root2, {
          text: "MODE OF ACQUISITION",
          fontSize: 16,
          fontWeight: "normal",
          textAlign: "left",
          fill: am5.color("#f7f5f7"),
          paddingTop: -15,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
            {
                category: statusMOA[0],
                value: nego
            },
            {
                category: statusMOA[1],
                value: expro
            },
            {
                category: statusMOA[2],
                value: donate
            },
            {
                category: statusMOA[3],
                value: ca141
            },
            {
                category: statusMOA[4],
                value: noneed
            },
        ]; // End of chart

        yAxis.data.setAll(data);
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);


        }); // End of queryFeatures
       
    } // End of updateMOAChartLot
    updateMoaChartLot();

    // CHART PANEL FOR STRUCTURE
    var root3 = am5.Root.new("structurePieChartDiv");
    root3._logo.dispose();

    class MyTheme extends am5.Theme {
          setupDefaultRules() {
            var theme = this;

            const gap = 4;
            const rotation = 135;
            const strokeWidth = 1.1;
            const fillOpacity = 0;
            const width = 10;
            const height = 10;


            this.patterns = [
              am5.LinePattern.new(this._root, {
                color: am5.color("#00C5FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#70AD47"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#0070FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FFFF00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height

              }),
              am5.LinePattern.new(this._root, {
                color: am5.color("#FFAA00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FF0000"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              })
            ];

            this.currentPattern = 0;
            this.rule("Slice").setAll({
              fillOpacity: 1
            });

            this.rule("Slice").setup = function(target) {
              target.set("fillPattern", theme.patterns[theme.currentPattern]);
              theme.currentPattern++;
              if (theme.currentPattern == theme.patterns.length) {
                theme.currentPattern = 0;
              }
            };
          }
        }

        const statusStructure = ["Dismantling/Clearing", "Paid", "For Payment Processing",
                                 "For Legal Pass", "For Appraisal/Offer to Compensate",
                                "LBP Account Opening"];

    async function updateChartStructure(cpValue) {
        root3.container.children.clear();

        var total_clear_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_clear_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = structureLayer.createQuery();
        query.outStatistics = [total_clear_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_clear_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root3.setThemes([
          am5themes_Animated.new(root3),
          am5themes_Responsive.new(root3),
          MyTheme.new(root3)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root3.container.children.push(
          am5percent.PieChart.new(root3, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root3.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root3, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          //fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          tooltipText: "{category}: {value}",
          tooltipY: am5.percent(10),
          //fill: am5.color("#1e8553")//root3.interfaceColors.get("alternativeText"),
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusStructure[0]) {
          selectedStatus = 1;
          } else if (SELECTED == statusStructure[1]) {
          selectedStatus = 2;
          } else if (SELECTED == statusStructure[2]) {
          selectedStatus = 3;
          } else if (SELECTED == statusStructure[3]) {
          selectedStatus = 4;
          } else if (SELECTED == statusStructure[4]) {
          selectedStatus = 5;
          } else if (SELECTED == statusStructure[5]) {
          selectedStatus = 6;
          } else {
          selectedStatus = null;
          }

          var query = structureLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "StatusStruc = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 

          // Zoom, filter, and highlight selected chart categories 
          view.when(function() {
          view.whenLayerView(structureLayer).then(function (layerView) {

          structureLayer.queryFeatures(query).then(function(results) {
            const RESULT_LENGTH= results.features;
            const ROW_N = RESULT_LENGTH.length;

            let objID = [];
            for (var i=0; i < ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
            }
            
            var queryExt = new Query({
              objectIds: objID
            });
            
            structureLayer.queryExtent(queryExt).then(function(result) {
              if (result.extent) {
                view.goTo(result.extent)
              }
            });
            
            if (highlightSelect) {
              highlightSelect.remove();
            }
            highlightSelect = layerView.highlight(objID);
            
            view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
            });
          }); // End of queryFeatures

          layerView.filter = {
            where: "StatusStruc = " + selectedStatus
          }
          }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusStructure[0],
              value: clear,
            },
            {
              category:  statusStructure[1],
              value: paid,
            },
            {
              category:  statusStructure[2],
              value: payp,
            },
            {
              category:  statusStructure[3],
              value: legalpass,
            },
            {
              category:  statusStructure[4],
              value: otc,
            },
            {
              category:  statusStructure[5],
              value: lbp,
            }
          ]
        );

                // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root3, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root3.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff"),

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box2');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 1.1,
        });

        pieSeries.appear(1000, 100);

        });  // End of queryFeature       
    } // End of updateChartStructure()
    updateChartStructure();


    var root4 = am5.Root.new("chartMoaStructureDiv");
    root4._logo.dispose();

    var myTheme = am5.Theme.new(root4);
    myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });

    const statusMoaStructure = ["For Negotiation",
                                "Expropriation",
                                "Donation",
                                "No Need to Acquire"
                                ];

    async function updateMoaChartStructure(cpValue) {
        root4.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_noneed_lot];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
          var stats = response.features[0].attributes;

          const nego = stats.total_nego_lot;
          const expro = stats.total_expro_lot;
          const donate = stats.total_donate_lot;
          const noneed = stats.total_noneed_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root4.setThemes([
          am5themes_Animated.new(root4),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root4.container.children.push(
          am5xy.XYChart.new(root4, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,
          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root4, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root4, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root4, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root4, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);


        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root4, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root4, {
            locationY: 1,
            sprite: am5.Label.new(root4, {
              text: "{value}",
              fill: root4.interfaceColors.get("alternativeText"),
              centerY: 1.3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusMoaStructure[0]) {
                selectedStatus = 1;
            } else if (SELECTED == statusMoaStructure[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusMoaStructure[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusMoaStructure[3]) {
                selectedStatus = 4;
            } else {
                selectedStatus = null;
            }

          var query = structureLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 

          view.whenLayerView(structureLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          structureLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              structureLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
            where: "MoA = " + selectedStatus
            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerVie
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root4, {
          text: "MODE OF ACQUISITION",
          fontSize: 14,
          fontWeight: "normal",
          textAlign: "left",
          fill: am5.color("#f7f5f7"),
          paddingTop: -15,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
                {
                    category: statusMoaStructure[0],
                    value: nego
                },
                {
                    category: statusMoaStructure[1],
                    value: expro
                },
                {
                    category: statusMoaStructure[2],
                    value: donate
                },
                {
                    category: statusMoaStructure[3],
                    value: noneed
                }
      ];

        yAxis.data.setAll(data);
        series.data.setAll(data);


        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);

        }); // End of queryFeatures
    } // End of updateS_MOAChartStructure
    updateMoaChartStructure();

    var root5 = am5.Root.new("nloPieChartDiv");
    root5._logo.dispose();

    const statusISF = ["Relocated", "Paid", "For Payment Processing",
                      "For Legal Pass", "For Appraisal/OtC/Requirements for Other Entitlements",
                    "LBP Account Opening"]

    async function updateChartNLO(cpValue) {
        root5.container.children.clear();

        var total_relocated_lot = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_relocated_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusRC = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusRC = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusRC = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = nloLayer.createQuery();
        query.outStatistics = [total_relocated_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return nloLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_relocated_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

            const total_nlo = thousands_separators(clear + paid + payp + legalpass + otc + lbp);
            nloNumberDiv.innerHTML = `TOTAL NLOs<br><br><b>${total_nlo}</b>`;
            
                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root5.setThemes([
          am5themes_Animated.new(root5),
          am5themes_Responsive.new(root5)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root5.container.children.push(
          am5percent.PieChart.new(root5, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root5.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root5, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // To set slice color, you need to add this before data.setAll
        /*
        pieSeries.get("colors").set("colors", [
          am5.color("#70ad47"),
          am5.color("#0070FF"),
          am5.color("#FFFF00"),
          am5.color("#FFAA00"),
          am5.color("#FF0000"),
          am5.color("#00734C"),
        ]);
        */

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);


        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          if (SELECTED == statusISF[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusISF[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusISF[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusISF[3]) {
            selectedStatus = 4;
          } else if (SELECTED == statusISF[4]) {
            selectedStatus = 5;
          } else if (SELECTED == statusISF[5]) {
            selectedStatus = 6;
          } else {
            selectedStatus = null;
          }

          var query = nloLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "StatusRC = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 

          view.when(function() {
            view.whenLayerView(nloLayer).then(function (layerView) {
              //chartLayerView = layerView;

              nloLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                nloLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusRC = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusISF[0],
              value: clear,
              sliceSettings: {
                fill: am5.color("#00C5FF")
              }
            },
            {
              category: statusISF[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70AD47")
              }
            },
            {
              category: statusISF[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070FF")
              }
            },
            {
              category: statusISF[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#FFFF00")
              }
            },
            {
            category: statusISF[4],
              value: otc,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
              category: statusISF[5],
            value: lbp,
            sliceSettings: {
                fill: am5.color("#FF0000")
              }
            }
          ]
        );


        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root5, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root5.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box3');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);

        });  // End of queryFeature                 
    } // End of updateChartNLO()
    updateChartNLO();

    var root6 = am5.Root.new("treeCuttingPieChartDiv");
    root6._logo.dispose();

    const treeCutStatus = ["Cut/Earthballed", "Permit Acquired", "Submitted to DENR",
                    "Ongoing Acquisition of Application Documents"];

    function updateChartCutting(cpValue) {
        root6.container.children.clear();

        var total_cutearthb = {
            onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_cutearthb",
            statisticType: "sum"
        };

        var total_permit = {
            onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_permit",
            statisticType: "sum"
        };

        var total_denr = {
            onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_denr",
            statisticType: "sum"
        };

        var total_ongoing = {
            onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ongoing",
            statisticType: "sum"
        };

        var query = treeCuttingLayer.createQuery();
        query.outStatistics = [total_cutearthb, total_permit, total_denr, total_ongoing];
        query.returnGeometry = true;

        treeCuttingLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const cutEarthb = stats.total_cutearthb;
        const permit = stats.total_permit;
        const denr = stats.total_denr;
        const ongoing = stats.total_ongoing;

        const total_trees = thousands_separators(cutEarthb + permit + denr + ongoing);

        treeNumberDiv.innerHTML = `TOTAL TREEs<br><br><b>${total_trees}</b>`;

                // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root6.setThemes([
          am5themes_Animated.new(root6),
          am5themes_Responsive.new(root6)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root6.container.children.push(
        am5percent.PieChart.new(root6, {

        //centerY: am5.percent(-2), //-10
        //y: am5.percent(-30), // -30
        layout: root6.verticalLayout
        })
        );

        // Add image in the middle
        chart.children.push(am5.Picture.new(root6, {
          width: 39,
          height: 39,
          x: am5.percent(50),
          y: am5.percent(50),
          centerX: am5.percent(50),
          centerY: am5.percent(220),
          src: "https://EijiGorilla.github.io/Symbols/Tree_Cutting_Logo.svg"
        }));

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
        am5percent.PieSeries.new(root6, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
            scale: 0.8
        })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
        const SELECTED = ev.target.dataItem.dataContext.category;
   
        if (SELECTED == treeCutStatus[0]) {
            selectedStatus = 1;
        } else if (SELECTED == treeCutStatus[1]) {
            selectedStatus = 2;
        } else if (SELECTED == treeCutStatus[2]) {
            selectedStatus = 3;
        } else if (SELECTED == treeCutStatus[3]) {
            selectedStatus = 4;
        } else {
            selectedStatus = null;
        }

        var query = treeCuttingLayer.createQuery();
          const cpExpression = "CP = '" + cpValue + "'";
          const statusExpression = "Status = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = statusExpression;
          } else {
            query.where = cpExpression + " AND " + statusExpression;
          } 

        view.when(function() {
            view.whenLayerView(treeCuttingLayer).then(function (layerView) {
            //chartLayerView = layerView;

            treeCuttingLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                objectIds: objID
                });

                treeCuttingLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                layerView.filter = null;
                highlightSelect.remove();
                });
            }); // End of queryFeatures
            layerView.filter = {
                where: "Status = " + selectedStatus
            }
            }); // End of view.whenLayerView
        }); // End of view.when
        });

        pieSeries.data.setAll(
        [
            {
            category: treeCutStatus[0],
            value: cutEarthb,
            sliceSettings: {
                fill: am5.color("#71AB48")
            }
            },
            {
            category: treeCutStatus[1],
            value: permit,
            sliceSettings: {
                fill: am5.color("#FFFF00")
            }
            },
            {
            category: treeCutStatus[2],
            value: denr,
            sliceSettings: {
                fill: am5.color("#FFAA00")
            }
            },
            {
            category: treeCutStatus[3],
            value: ongoing,
            sliceSettings: {
                fill: am5.color("#FF0000")
            }
            },
        ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root6, {
        centerX: am5.percent(50),
        x: am5.percent(50),
        layout: root6.verticalLayout,
        marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
        width: 18,
        height: 18,
        strokeWidth: 1,
        strokeOpacity: 1,
        stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
        cornerRadiusTL: 10,
        cornerRadiusTR: 10,
        cornerRadiusBL: 10,
        cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
        let box = document.querySelector('.box4');
        const boxWidth = box.offsetWidth;
        var availableSpace = Math.max(width - chart.width() - 150, 180);
        //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
        legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
        });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
        oversizedBehavior: "truncate",
        fill: am5.color("#ffffff")
        //textDecoration: "underline"
        //width: am5.percent(200)
        //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
        textAlign: "right",
        width: valueLabelsWidth,
        fill: am5.color("#ffffff")
        //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
        // set space between legend items
        paddingTop: 1.1,
        paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
    }); // End of queryFeatures
    } // End of //updateChart
    updateChartCutting();

    var root7 = am5.Root.new("treeCompensationPieChartDiv");
    root7._logo.dispose();

    const treeCompen = ["Non-Compensable", "For Processing", "Compensated"];

    function updateChartTreeComp(cpValue) {
        root7.container.children.clear();

        var total_noncompen = {
            onStatisticField: "CASE WHEN Compensation = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noncompen",
            statisticType: "sum"
        };

        var total_processing = {
            onStatisticField: "CASE WHEN Compensation = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_processing",
            statisticType: "sum"
        };

        var total_comp = {
            onStatisticField: "CASE WHEN Compensation = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_comp",
            statisticType: "sum"
        };

        var query = treeCompensationLayer.createQuery();
        query.outStatistics = [total_noncompen, total_processing, total_comp];
        query.returnGeometry = true;

        treeCompensationLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nonComp = stats.total_noncompen;
            const processing = stats.total_processing;
            const compensated = stats.total_comp;

                // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root7.setThemes([
        am5themes_Animated.new(root7),
        am5themes_Responsive.new(root7)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root7.container.children.push(
        am5percent.PieChart.new(root7, {

        //centerY: am5.percent(-2), //-10
        //y: am5.percent(-30), // -30
        layout: root7.verticalLayout
        })
        );

        // Add image in the middle
        chart.children.push(am5.Picture.new(root7, {
          width: 37,
          height: 37,
          x: am5.percent(50),
          y: am5.percent(50),
          centerX: am5.percent(50),
          centerY: am5.percent(200),
          src: "https://EijiGorilla.github.io/Symbols/Money_Logo.svg"
        }));

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
        am5percent.PieSeries.new(root7, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
            scale: 0.8
        })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
            fillOpacity: 0.9,
            stroke: am5.color("#ffffff"),
            strokeWidth: 1,
            strokeOpacity: 1,
            templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
            const SELECTED = ev.target.dataItem.dataContext.category;
             
                if (SELECTED == treeCompen[0]) {
                    selectedStatus = 1;
                } else if (SELECTED == treeCompen[1]) {
                    selectedStatus = 2;
                } else if (SELECTED == treeCompen[2]) {
                    selectedStatus = 3;
                } else {
                    selectedStatus = null;
                }

                var query = treeCompensationLayer.createQuery();
                const cpExpression = "CP = '" + cpValue + "'";
                const statusExpression = "Compensation = " + selectedStatus;

                if (cpValue === undefined || cpValue === "All") {
                  query.where = statusExpression;
                } else {
                  query.where = cpExpression + " AND " + statusExpression;
                } 

            view.when(function() {
                view.whenLayerView(treeCompensationLayer).then(function (layerView) {
                //chartLayerView = layerView;

                treeCompensationLayer.queryFeatures(query).then(function(results) {
                    const RESULT_LENGTH = results.features;
                    const ROW_N = RESULT_LENGTH.length;

                    let objID = [];
                    for (var i=0; i < ROW_N; i++) {
                        var obj = results.features[i].attributes.OBJECTID;
                        objID.push(obj);
                    }

                    var queryExt = new Query({
                    objectIds: objID
                    });

                    treeCompensationLayer.queryExtent(queryExt).then(function(result) {
                        if (result.extent) {
                            view.goTo(result.extent)
                        }
                    });

                    if (highlightSelect) {
                        highlightSelect.remove();
                    }
                    highlightSelect = layerView.highlight(objID);

                    view.on("click", function() {
                    layerView.filter = null;
                    highlightSelect.remove();
                    });
                }); // End of queryFeatures
                layerView.filter = {
                    where: "Compensation = " + selectedStatus
                }
                }); // End of view.whenLayerView
            }); // End of view.when
            });

            pieSeries.data.setAll(
            [
                {
                    category: treeCompen[0],
                    value: nonComp,
                    sliceSettings: {
                        fill: am5.color("#0070FF")
                    }
                },
                {
                    category: treeCompen[1],
                    value: processing,
                    sliceSettings: {
                        fill: am5.color("#FFFF00")
                    }
                },
                {
                    category: treeCompen[2],
                    value: compensated,
                    sliceSettings: {
                        fill: am5.color("#71AB48")
                    }
                },
            ]
            );

            // Legend
            // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
            var legend = chart.children.push(am5.Legend.new(root7, {
                centerX: am5.percent(50),
                x: am5.percent(50),
                layout: root7.verticalLayout,
                marginBottom: 10
            }));
            legend.data.setAll(pieSeries.dataItems);

            // Change the size of legend markers
            legend.markers.template.setAll({
                width: 18,
                height: 18,
                strokeWidth: 1,
                strokeOpacity: 1,
                stroke: am5.color("#ffffff")
            });

            // Change the marker shape
            legend.markerRectangles.template.setAll({
                cornerRadiusTL: 10,
                cornerRadiusTR: 10,
                cornerRadiusBL: 10,
                cornerRadiusBR: 10,
            });

            // To align legend items: valueLabels right, labels to left
            // 1. fix width of valueLabels
            // 2. dynamically change width of labels by screen size

            const valueLabelsWidth = 50;

            // Responsive legend 
            // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
            chart.onPrivate("width", function(width) {
                let box = document.querySelector('.box5');
                const boxWidth = box.offsetWidth;
                var availableSpace = Math.max(width - chart.width() - 150, 180);
                //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
                legend.labels.template.setAll({
                    width: availableSpace,
                    maxWidth: availableSpace
                });
            });

            // Change legend labelling properties
            // To have responsive font size, do not set font size
            legend.labels.template.setAll({
                oversizedBehavior: "truncate",
                fill: am5.color("#ffffff")
                //textDecoration: "underline"
                //width: am5.percent(200)
                //fontWeight: "300"
            });

            legend.valueLabels.template.setAll({
                textAlign: "right",
                width: valueLabelsWidth,
                fill: am5.color("#ffffff")
                //fontSize: LEGEND_FONT_SIZE,
            })

            legend.itemContainers.template.setAll({
                // set space between legend items
                paddingTop: 1.1,
                paddingBottom: 2,
            });
            
            pieSeries.appear(1000, 100);
        }); // End of queryFeatures
    } // End of //updateChart
    updateChartTreeComp();

    // UTILITY RELOCATION
    const type = [
      {
        "category": "Telecom",
        "value": 1
      },
      {
        "category": "Water",
        "value": 2
      },
      {
        "category": "Sewage",
        "value": 3
      },
      {
        "category": "Power",
        "value": 4
      },
    ]

    const marginTop = 0;
    const marginLeft = 0;
    const marginRight = 0;
    const marginBottom = 0;
    const paddingTop = 10;
    const paddingLeft = 5;
    const paddingRight = 5;
    const paddingBottom = 0;

    const xAxisNumberFormat = "#'%'";
    const seriesBulletLabelFontSize = "1vw";

    // series line fill pattern
    const linePatternColorComplete = "#0070ff";
    const linePatternColorOpacityComplete = 0;
    const linePatternFillOpacityComplete = 0;

    const linePatternColorOpacityIncomplet = 0;
    const linePatternFillOpacityIncomplet = 1;
    const linePatternStrokeOpacityIncomplet = 0;

    // axis label
    const yAxisLabelFontSize = "0.8vw";
    const xAxisLabelFontSize = "0.8vw"
    const legendFontSize = "0.8vw"

    // 1.1. Point
    const chartIconWidth = 35;
    const chartIconHeight = 35;
    const chartIconPositionX = -21;
    const chartPaddingRightIconLabel = 45;

    var root_pt = am5.Root.new("utilityPointChartDiv");
    root_pt._logo.dispose();

    function updateChartUtilityPoint(cpValue) {
      root_pt.container.children.clear();
      var total_telecom_incomp = {
        onStatisticField: "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_telecom_incomp",
        statisticType: "sum"
      };

      var total_telecom_comp = {
        onStatisticField: "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_telecom_comp",
        statisticType: "sum"  
      };

      var total_water_incomp = {
        onStatisticField: "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_water_incomp",
        statisticType: "sum"
      };

      var total_water_comp = {
        onStatisticField: "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_water_comp",
        statisticType: "sum"  
      };

      var total_sewage_incomp = {
        onStatisticField: "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_sewage_incomp",
        statisticType: "sum"
      };

      var total_sewage_comp = {
        onStatisticField: "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_sewage_comp",
        statisticType: "sum"  
      };

      var total_power_incomp = {
        onStatisticField: "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_power_incomp",
        statisticType: "sum"
      };

      var total_power_comp = {
        onStatisticField: "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_power_comp",
        statisticType: "sum"  
      };


      // Query
      var query = utilityPointLayer.createQuery();
      query.outStatistics = [
        total_telecom_incomp, total_telecom_comp,
        total_water_incomp, total_water_comp,
        total_sewage_incomp, total_sewage_comp,
        total_power_incomp, total_power_comp
      ];
      query.returnGeometry = true;

      utilityPointLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
        const telecom_incomp = stats.total_telecom_incomp;
        const telecom_comp = stats.total_telecom_comp;
        const water_incomp = stats.total_water_incomp;
        const water_comp = stats.total_water_comp;
        const sewage_incomp = stats.total_sewage_incomp;
        const sewage_comp = stats.total_sewage_comp;
        const power_incomp = stats.total_power_incomp;
        const power_comp = stats.total_power_comp;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root_pt.setThemes([
          am5themes_Animated.new(root_pt),
          am5themes_Responsive.new(root_pt),
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root_pt.container.children.push(am5xy.XYChart.new(root_pt, {
          panX: false,
          panY: false,
          layout: root_pt.verticalLayout,
          marginTop: marginTop,
          marginLeft: marginLeft,
          marginRight: marginRight,
          marginBottom: marginBottom,
          paddingTop: paddingTop,
          paddingLeft: paddingLeft,
          paddingRight: paddingRight,
          paddingBottom: paddingBottom,
          scale: 1,
          height: am5.percent(100)
        }));

          var data = [
            {
              "category": type[Object.keys(type)[0]].category,
              "comp": telecom_comp,
              "incomp": telecom_incomp,
              "icon": "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
            },
            {
              "category": type[Object.keys(type)[1]].category,
              "comp": water_comp,
              "incomp": water_incomp,
              "icon": "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
            },
            {
              "category": type[Object.keys(type)[2]].category,
              "comp": sewage_comp,
              "incomp": sewage_incomp,
              "icon": "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
            },
            {
              "category": type[Object.keys(type)[3]].category,
              "comp": power_comp,
              "incomp": power_incomp,
              "icon": "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
            },
          ];

    // Create axes
    // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
    var yRenderer = am5xy.AxisRendererY.new(root_pt, {
      inversed: true,
    });

    var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_pt, {
      categoryField: "category",
      renderer: yRenderer,
      bullet: function(root_pt, axis, dataItem) {
        return am5xy.AxisBullet.new(root_pt, {
          location: 0.5,
          sprite: am5.Picture.new(root_pt, {
            width: chartIconWidth,
            height: chartIconHeight,
            centerY: am5.p50,
            centerX: am5.p50,
            x: chartIconPositionX,
            src: dataItem.dataContext.icon
          })
        });
      },
      tooltip: am5.Tooltip.new(root_pt, {})
    }));

    yRenderer.labels.template.setAll({
      paddingRight: chartPaddingRightIconLabel
    });

    yRenderer.grid.template.setAll({
      location: 1
    })

    // Label properties Y axis
    yAxis.get("renderer").labels.template.setAll({
      oversizedBehavior: "wrap",
      textAlign: "center",
      fill: am5.color("#ffffff"),
      //maxWidth: 150,
      fontSize: yAxisLabelFontSize,
    });

    yAxis.data.setAll(data);

    var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_pt, {
      min: 0,
      max: 100,
      strictMax: true,
      numberFormat: xAxisNumberFormat,
      calculateTotals: true,
      renderer: am5xy.AxisRendererX.new(root_pt, {
        strokeOpacity: 0,
        strokeWidth: 1,
        stroke: am5.color("#ffffff"),
      })
    }));


    // Label properties for yAxis (category axis)
    xAxis.get("renderer").labels.template.setAll({
      //oversizedBehavior: "wrap",
      textAlign: "center",
      fill: am5.color("#ffffff"),
      //maxWidth: 150,
      fontSize: xAxisLabelFontSize
    });

    chart.get("colors").set("colors", [
      am5.color("#008c1a"), //
      am5.color("#000000"),
    ]);

    // Add series
    // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
    function makeSeries(name, fieldName) {
      var series = chart.series.push(am5xy.ColumnSeries.new(root_pt, {
        name: name,
        stacked: true,
        xAxis: xAxis,
        yAxis: yAxis,
        baseAxis: yAxis,
        valueXField: fieldName,
        valueXShow: "valueXTotalPercent",
        categoryYField: "category"
      }));

      series.columns.template.setAll({
        tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
        tooltipY: am5.percent(90),
        //fill: am5.color("#ffffff")
        // 100% transparent for incomplete
        fillOpacity: fieldName == "incomp" ? 0 : 1,
        strokeOpacity: 0,
      });
      series.data.setAll(data);

      // Make stuff animate on load
      // https://www.amcharts.com/docs/v5/concepts/animations/
      series.appear();

      series.bullets.push(function() {
        return am5.Bullet.new(root_pt, {
          sprite: am5.Label.new(root_pt, {
            text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
            fill: root_pt.interfaceColors.get("alternativeText"),
            opacity: fieldName == "incomp" ? 0 : 1,
            fontSize: seriesBulletLabelFontSize,
            centerY: am5.p50,
            centerX: am5.p50,
            populateText: true
          })
        });
      });

      series.columns.template.events.on("click", function(ev) {
        // Layer
        const SELECTED = ev.target.dataItem.dataContext.category;
        const find = type.find((emp) => emp.category === SELECTED);
        const typeSelect = find.value;
    
        const selectedStatus = fieldName == 'incomp' ? 0 : 1;

        const sqlExpressionWithCP = "CP = '" + cpValue + "'" + " AND " + "UtilType = " + typeSelect + " AND " +  "Status = " + selectedStatus;
        const sqlExpression = "UtilType = " + typeSelect + " AND " +  "Status = " + selectedStatus;

        var query = utilityLineLayer.createQuery();
        if (cpValue === undefined || cpValue === "All") {
          query.where = sqlExpression;
        } else {
          query.where = sqlExpressionWithCP;
        }

        var highlight = null;
        view.when(() => {
          let arrLviews = [];
          view.whenLayerView(utilityPointLayer).then(function (layerView) {
            utilityPointLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
                var obj = results.features[i].attributes.OBJECTID;
                objID.push(obj);
              }
              
              var queryExt = new Query({
                objectIds: objID
              });

              utilityPointLayer.queryExtent(queryExt).then(function(result) {
                if (result.extent) {
                  view.goTo(result.extent)
                }
              });

              if (highlight) {
                highlightSelect.remove();
              }
              highlight = layerView.highlight(objID);

              view.on("click", function() {
                layerView.filter = null;
                highlight.remove();
              });
            });
            layerView.filter = {
              where: sqlExpression
              //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
            };
          }); // End of whenLayerView

          view.whenLayerView(utilityPointLayer1).then(function (layerView) {
            utilityPointLayer1.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
                var obj = results.features[i].attributes.OBJECTID;
                objID.push(obj);
              }

              view.on("click", function() {
                layerView.filter = null;
              });
            });
            layerView.filter = {
              where: sqlExpression
              //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
            };
          }); // End of whenLayerView
        });
     
      });// End of filterByChart

      //legend.data.push(series);
    }// end of makeSeries
    makeSeries("Complete", "comp");
    makeSeries("Incomplete", "incomp");
    // Make stuff animate on load
    // https://www.amcharts.com/docs/v5/concepts/animations/
    chart.appear(1000, 100);
    }); // End of queryFeatures function
    }
    updateChartUtilityPoint();

  // 1.2. Line
  var root_line = am5.Root.new("utilityLineChartDiv");
  root_line._logo.dispose();

  function updateChartUtilityLine(cpValue) {
    root_line.container.children.clear();
    var total_telecom_incomp = {
      onStatisticField: "CASE WHEN (UtilType = 1 and Status = 0) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_telecom_incomp",
      statisticType: "sum"
    };

    var total_telecom_comp = {
      onStatisticField: "CASE WHEN (UtilType = 1 and Status = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_telecom_comp",
      statisticType: "sum"  
    };

    var total_water_incomp = {
      onStatisticField: "CASE WHEN (UtilType = 2 and Status = 0) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_water_incomp",
      statisticType: "sum"
    };

    var total_water_comp = {
      onStatisticField: "CASE WHEN (UtilType = 2 and Status = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_water_comp",
      statisticType: "sum"  
    };

    var total_sewage_incomp = {
      onStatisticField: "CASE WHEN (UtilType = 3 and Status = 0) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_sewage_incomp",
      statisticType: "sum"
    };

    var total_sewage_comp = {
      onStatisticField: "CASE WHEN (UtilType = 3 and Status = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_sewage_comp",
      statisticType: "sum"  
    };

    var total_power_incomp = {
      onStatisticField: "CASE WHEN (UtilType = 4 and Status = 0) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_power_incomp",
      statisticType: "sum"
    };

    var total_power_comp = {
      onStatisticField: "CASE WHEN (UtilType = 4 and Status = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_power_comp",
      statisticType: "sum"  
    };


    // Query
    var query = utilityLineLayer.createQuery();
    query.outStatistics = [
      total_telecom_incomp, total_telecom_comp,
      total_water_incomp, total_water_comp,
      total_sewage_incomp, total_sewage_comp,
      total_power_incomp, total_power_comp
    ];
    query.returnGeometry = true;

    utilityLineLayer.queryFeatures(query).then(function(response) {
      var stats = response.features[0].attributes;
      const telecom_incomp = stats.total_telecom_incomp;
      const telecom_comp = stats.total_telecom_comp;
      const water_incomp = stats.total_water_incomp;
      const water_comp = stats.total_water_comp;
      const sewage_incomp = stats.total_sewage_incomp;
      const sewage_comp = stats.total_sewage_comp;
      const power_incomp = stats.total_power_incomp;
      const power_comp = stats.total_power_comp;

      // Set themes
      // https://www.amcharts.com/docs/v5/concepts/themes/
      root_line.setThemes([
        am5themes_Animated.new(root_line),
        am5themes_Responsive.new(root_line),
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root_line.container.children.push(am5xy.XYChart.new(root_line, {
        panX: false,
        panY: false,
        layout: root_line.verticalLayout,
        marginTop: marginTop,
        marginLeft: marginLeft,
        marginRight: marginRight,
        marginBottom: marginBottom,
        paddingTop: paddingTop,
        paddingLeft: paddingLeft,
        paddingRight: paddingRight,
        paddingBottom: paddingBottom,
        scale: 1,
        height: am5.percent(100)
      }));

        var data = [
          {
            "category": type[Object.keys(type)[0]].category,
            "comp": telecom_comp,
            "incomp": telecom_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Telecom_Logo2.svg",
          },
          {
            "category": type[Object.keys(type)[1]].category,
            "comp": water_comp,
            "incomp": water_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Water_Logo2.svg",
          },
          {
            "category": type[Object.keys(type)[2]].category,
            "comp": sewage_comp,
            "incomp": sewage_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Sewage_Logo2.svg",
          },
          {
            "category": type[Object.keys(type)[3]].category,
            "comp": power_comp,
            "incomp": power_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Power_Logo2.svg",
          },
        ];

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var yRenderer = am5xy.AxisRendererY.new(root_line, {
        inversed: true,
      });
      var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_line, {
        categoryField: "category",
        renderer: yRenderer,
        bullet: function(root_line, axis, dataItem) {
          return am5xy.AxisBullet.new(root_line, {
            location: 0.5,
            sprite: am5.Picture.new(root_line, {
              width: chartIconWidth,
              height: chartIconHeight,
              centerY: am5.p50,
              centerX: am5.p50,
              x: chartIconPositionX,
              src: dataItem.dataContext.icon
            })
          });
        },
        tooltip: am5.Tooltip.new(root_line, {})
      }));

      yRenderer.labels.template.setAll({
        paddingRight: chartPaddingRightIconLabel
      });

      yRenderer.grid.template.setAll({
        location: 1
      })

      // Label properties Y axis
      yAxis.get("renderer").labels.template.setAll({
        oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: yAxisLabelFontSize,
      });

      yAxis.data.setAll(data);

      var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_line, {
        min: 0,
        max: 100,
        strictMax: true,
        numberFormat: xAxisNumberFormat,
        calculateTotals: true,
        renderer: am5xy.AxisRendererX.new(root_line, {
          strokeOpacity: 0,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));


      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: xAxisLabelFontSize
      });

      chart.get("colors").set("colors", [
        am5.color("#008c1a"), //
        am5.color("#000000"),
      ]);

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root_line, {
          name: name,
          stacked: true,
          xAxis: xAxis,
          yAxis: yAxis,
          baseAxis: yAxis,
          valueXField: fieldName,
          valueXShow: "valueXTotalPercent",
          categoryYField: "category"
        }));

        series.columns.template.setAll({
          tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
          tooltipY: am5.percent(90),
          //fill: am5.color("#ffffff")
          // 100% transparent for incomplete
          fillOpacity: fieldName == "incomp" ? 0 : 1,
          strokeOpacity: 0,
        });
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear();

        series.bullets.push(function() {
          return am5.Bullet.new(root_line, {
            sprite: am5.Label.new(root_line, {
              text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
              fill: root_line.interfaceColors.get("alternativeText"),
              opacity: fieldName == "incomp" ? 0 : 1,
              fontSize: seriesBulletLabelFontSize,
              centerY: am5.p50,
              centerX: am5.p50,
              populateText: true
            })
          });
        });

        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          const find = type.find((emp) => emp.category === SELECTED);
          const typeSelect = find.value;
      
          const selectedStatus = fieldName == 'incomp' ? 0 : 1;

          const sqlExpressionWithCP = "CP = '" + cpValue + "'" + " AND " + "UtilType = " + typeSelect + " AND " +  "Status = " + selectedStatus;
          const sqlExpression = "UtilType = " + typeSelect + " AND " +  "Status = " + selectedStatus;

          var query = utilityLineLayer.createQuery();
          if (cpValue === undefined || cpValue === "All") {
            query.where = sqlExpression;
          } else {
            query.where = sqlExpressionWithCP;
          }

          var highlight = null;
          view.when(() => {
            let arrLviews = [];
            view.whenLayerView(utilityLineLayer).then(function (layerView) {
              utilityLineLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH= results.features;
                const ROW_N= RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i< ROW_N; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
                }
                
                var queryExt = new Query({
                  objectIds: objID
                });

                utilityLineLayer.queryExtent(queryExt).then(function(result) {
                  if (result.extent) {
                    view.goTo(result.extent)
                  }
                });

                if (highlight) {
                  highlightSelect.remove();
                }
                highlight = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlight.remove();
                });
              });
              layerView.filter = {
                where: sqlExpression
                //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
              };
            }); // End of whenLayerView

            view.whenLayerView(utilityLineLayer1).then(function (layerView) {
              utilityLineLayer1.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH= results.features;
                const ROW_N= RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i< ROW_N; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
                }

                view.on("click", function() {
                  layerView.filter = null;
                });
              });
              layerView.filter = {
                where: sqlExpression
                //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
              };
            }); // End of whenLayerView
          });


        });// End of filterByChart

        //legend.data.push(series);
      }// end of makeSeries
      makeSeries("Complete", "comp");
      makeSeries("Incomplete", "incomp");
      // Make stuff animate on load
      // https://www.amcharts.com/docs/v5/concepts/animations/
      chart.appear(1000, 100);
    }); // End of queryFeatures function
  }
      updateChartUtilityLine();

    // VIADUCT
    const viaductType = [
    {
      "category": "Bored Pile",
      "value": 1
    },
    {
      "category": "Pile Cap",
      "value": 2
    },
    {
      "category": "Pier",
      "value": 3
    },
    {
      "category": "Pier Head",
      "value": 4
    },
    {
      "category": "Precast",
      "value": 5
    },
  ]
  var root_via = am5.Root.new("viaductChartDiv");
  root_via._logo.dispose();

  function updateChartViaduct(cpValue) {
    root_via.container.children.clear();
    var total_pile_incomp = {
      onStatisticField: "CASE WHEN (Type = 1 and Status1 = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pile_incomp",
      statisticType: "sum"
    };

    var total_pile_comp = {
      onStatisticField: "CASE WHEN (Type = 1 and Status1 = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pile_comp",
      statisticType: "sum"  
    };

    var total_pilecap_incomp = {
      onStatisticField: "CASE WHEN (Type = 2 and Status1 = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pilecap_incomp",
      statisticType: "sum"
    };

    var total_pilecap_comp = {
      onStatisticField: "CASE WHEN (Type = 2 and Status1 = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pilecap_comp",
      statisticType: "sum"  
    };

    var total_pier_incomp = {
      onStatisticField: "CASE WHEN (Type = 3 and Status1 = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pier_incomp",
      statisticType: "sum"
    };

    var total_pier_comp = {
      onStatisticField: "CASE WHEN (Type = 3 and Status1 = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pier_comp",
      statisticType: "sum"  
    };

    var total_pierhead_incomp = {
      onStatisticField: "CASE WHEN (Type = 4 and Status1 = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pierhead_incomp",
      statisticType: "sum"
    };

    var total_pierhead_comp = {
      onStatisticField: "CASE WHEN (Type = 4 and Status1 = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_pierhead_comp",
      statisticType: "sum"  
    };

    var total_precast_incomp = {
      onStatisticField: "CASE WHEN (Type = 5 and Status1 = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_precast_incomp",
      statisticType: "sum"
    };

    var total_precast_comp = {
      onStatisticField: "CASE WHEN (Type = 5 and Status1 = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_precast_comp",
      statisticType: "sum"  
    };


    // Query
    var query = viaductLayer.createQuery();
    query.outStatistics = [
      total_pile_incomp, total_pile_comp,
      total_pilecap_incomp, total_pilecap_comp,
      total_pier_incomp, total_pier_comp,
      total_pierhead_incomp, total_pierhead_comp,
      total_precast_incomp, total_precast_comp,
    ];
    query.returnGeometry = true;

    viaductLayer.queryFeatures(query).then(function(response) {
      var stats = response.features[0].attributes;
      const pile_incomp = stats.total_pile_incomp;
      const pile_comp = stats.total_pile_comp;
      const pilecap_incomp = stats.total_pilecap_incomp;
      const pilecap_comp = stats.total_pilecap_comp;
      const pier_incomp = stats.total_pier_incomp;
      const pier_comp = stats.total_pier_comp;
      const pierhead_incomp = stats.total_pierhead_incomp;
      const pierhead_comp = stats.total_pierhead_comp;
      const precast_incomp = stats.total_precast_incomp;
      const precast_comp = stats.total_precast_comp;

      // Set themes
      // https://www.amcharts.com/docs/v5/concepts/themes/
      root_via.setThemes([
        am5themes_Animated.new(root_via),
        am5themes_Responsive.new(root_via),
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root_via.container.children.push(am5xy.XYChart.new(root_via, {
        panX: false,
        panY: false,
        layout: root_via.verticalLayout,
        marginTop: marginTop,
        marginLeft: marginLeft,
        marginRight: marginRight,
        marginBottom: marginBottom,
        paddingTop: paddingTop,
        paddingLeft: paddingLeft,
        paddingRight: paddingRight,
        paddingBottom: paddingBottom,
        scale: 1,
        height: am5.percent(100)
      }));

        var data = [
          {
            "category": viaductType[Object.keys(viaductType)[0]].category,
            "comp": pile_comp,
            "incomp": pile_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pile_Logo.svg",
          },
          {
            "category": viaductType[Object.keys(viaductType)[1]].category,
            "comp": pilecap_comp,
            "incomp": pilecap_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pilecap_Logo.svg",
          },
          {
            "category": viaductType[Object.keys(viaductType)[2]].category,
            "comp": pier_comp,
            "incomp": pier_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pier_Logo.svg",
          },
          {
            "category": viaductType[Object.keys(viaductType)[3]].category,
            "comp": pierhead_comp,
            "incomp": pierhead_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Pierhead_Logo.svg",
          },
          {
            "category": viaductType[Object.keys(viaductType)[4]].category,
            "comp": pierhead_comp,
            "incomp": pierhead_incomp,
            "icon": "https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_Precast_Logo.svg",
          },
        ];

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var yRenderer = am5xy.AxisRendererY.new(root_via, {
        inversed: true,
      });
      var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root_via, {
        categoryField: "category",
        renderer: yRenderer,
        bullet: function(root_via, axis, dataItem) {
          return am5xy.AxisBullet.new(root_via, {
            location: 0.5,
            sprite: am5.Picture.new(root_via, {
              width: 40,
              height: 40,
              centerY: am5.p50,
              centerX: am5.p50,
              x: -28,
              src: dataItem.dataContext.icon
            })
          });
        },
        tooltip: am5.Tooltip.new(root_via, {})
      }));

      yRenderer.labels.template.setAll({
        paddingRight: 55
      });

      yRenderer.grid.template.setAll({
        location: 1
      })

      // Label properties Y axis
      yAxis.get("renderer").labels.template.setAll({
        oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: yAxisLabelFontSize,
      });

      yAxis.data.setAll(data);

      var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root_via, {
        min: 0,
        max: 100,
        strictMax: true,
        numberFormat: xAxisNumberFormat,
        calculateTotals: true,
        renderer: am5xy.AxisRendererX.new(root_via, {
          strokeOpacity: 0,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));


      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: xAxisLabelFontSize
      });

      chart.get("colors").set("colors", [
        am5.color("#0070ff"), //
        am5.color("#000000"),
      ]);

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root_via, {
          name: name,
          stacked: true,
          xAxis: xAxis,
          yAxis: yAxis,
          baseAxis: yAxis,
          valueXField: fieldName,
          valueXShow: "valueXTotalPercent",
          categoryYField: "category"
        }));

        series.columns.template.setAll({
          tooltipText: "{name}: {valueX}",// "{categoryY}: {valueX}",
          tooltipY: am5.percent(90),
          //fill: am5.color("#ffffff")
          // 100% transparent for incomplete
          fillOpacity: fieldName == "incomp" ? 0 : 1,
          strokeOpacity: 0,
        });
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear();

        series.bullets.push(function() {
          return am5.Bullet.new(root_via, {
            sprite: am5.Label.new(root_via, {
              text: "{valueX}" === 0 ? "" : "{valueXTotalPercent.formatNumber('#.')}%", //"{valueX}",
              fill: root_via.interfaceColors.get("alternativeText"),
              opacity: fieldName == "incomp" ? 0 : 1,
              fontSize: seriesBulletLabelFontSize,
              centerY: am5.p50,
              centerX: am5.p50,
              populateText: true
            })
          });
        });

        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          const find = viaductType.find((emp) => emp.category === SELECTED);
          const typeSelect = find.value;
      
          const selectedStatus = fieldName == 'incomp' ? 1 : 4;
          
          var highlight = null;
          var query = viaductLayer.createQuery();
          query.outFields = ["*"]
          const sqlExpression = "Type = " + typeSelect + " AND " +  "Status1 = " + selectedStatus;
          const cpExpression = "CP = '" + cpValue + "'" + " AND " + "Type = " + typeSelect + " AND " +  "Status1 = " + selectedStatus;

          if (cpValue === undefined || cpValue === "All") {
            query.where = sqlExpression;
          } else {
            query.where = cpExpression;
          } 
            // Update layerView based on viaduct components being selected
            view.whenLayerView(viaductLayer).then(function (viaductLayerView) {

                
              viaductLayerView.queryFeatures(query).then(function(results) {
                const ggg = results.features;
                const rowN = ggg.length;
                
                // Extract and obtain OBJECTID
                let objID = [];
                for (var i=0; i< rowN; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
                }

                if (highlight) {
                  highlightSelect.remove();
                }
                highlight = viaductLayerView.highlight(objID);

                view.on("click", function() {
                  viaductLayerView.filter = null;
                  highlight.remove();
                });
              });
              viaductLayerView.filter = {
                  where: "Type = " + typeSelect + " AND " +  "Status1 = " + selectedStatus
                  //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
              };
            }); // whenLayerView
        });// End of filterByChart

        //legend.data.push(series);
      }// end of makeSeries
      makeSeries("Complete", "comp");
      makeSeries("Incomplete", "incomp");
      // Make stuff animate on load
      // https://www.amcharts.com/docs/v5/concepts/animations/
      chart.appear(1000, 100);
    }); // End of queryFeatures function
  }
  updateChartViaduct();

  var root_ts = am5.Root.new("timeSeriesChartViaduct");
  root_ts._logo.dispose();

  function timeSeriesChartViaduct(cpValue) {
    root_ts.container.children.clear();

    var total_complete_pile = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 1) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pile",
      statisticType: "sum"
    };
  
    var total_complete_pilecap = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 2) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pilecap",
      statisticType: "sum"
    };

    var total_complete_pier = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 3) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pier",
      statisticType: "sum"
    };

    var total_complete_pierhead = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 4) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_pierhead",
      statisticType: "sum"
    };

    var total_complete_precast = {
      onStatisticField: "CASE WHEN (Status1 = 4 and Type = 5) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_precast",
      statisticType: "sum"
    };

    var query = viaductLayer.createQuery();

    const defaulExpression = "end_date IS NOT NULL";
    if (cpValue === "All") {
      query.where = defaulExpression;

    } else {
      query.where = defaulExpression + " AND " + "CP = '" + cpValue + "'";
    }
    
    query.outStatistics = [total_complete_pile, total_complete_pilecap,
                           total_complete_pier, total_complete_pierhead, total_complete_precast];
    query.outFields = ["end_date"];
    query.orderByFields = ["end_date"];
    query.groupByFieldsForStatistics = ["end_date"];

      const pile = [];
      const pilecap = [];
      const pier = [];
      const pierhead = [];
      const precast = [];

    viaductLayer.queryFeatures(query).then(function(response) {
      var stats = response.features;

      // collect all dates for each viaduct type
      const data = stats.map((result, index) => {
        const attributes = result.attributes;
        const date = attributes.end_date;
        
        const pileCount = attributes.total_complete_pile;
        const pilecapCount = attributes.total_complete_pilecap;
        const pierCount = attributes.total_complete_pier;
        const pierheadCount = attributes.total_complete_pierhead;
        const precastCount = attributes.total_complete_precast;

        // compile in object
        return Object.assign({}, {
          date,
          pile: pileCount,
          pilecap: pilecapCount,
          pier: pierCount,
          piearhead: pierheadCount,
          precast: precastCount
        });
      });

     

      // 6. Add to Chart

      // set themes
      root_ts.setThemes([
        am5themes_Animated.new(root_ts)
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root_ts.container.children.push(am5xy.XYChart.new(root_ts, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX",
        layout: root_ts.verticalLayout
      }));

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var xRenderer = am5xy.AxisRendererX.new(root_ts, {
        //minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
      });
      var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root_ts, {
        // When you group data for series 
        // Note you need to baseInterval timeUnit is 'day'
        // and groupIntervals timeUnit is 'month'
        maxDeviation: 0,
        groupData: true,
        baseInterval: {
          timeUnit: "day",
          count: 1
        },
        // count: 
       groupIntervals: [{timeUnit: "month", count: 1}],
        
        categoryField: "date",
        renderer: xRenderer,
        tooltip: am5.Tooltip.new(root_ts, {})
      }));

      xRenderer.grid.template.setAll({
        location: 1
      })

      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      xAxis.data.setAll(data);

      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root_ts, {
        min: 0,
        renderer: am5xy.AxisRendererY.new(root_ts, {
          strokeOpacity: 0.1,
          minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));

    // Add yaxix title
    yAxis.children.unshift(
      am5.Label.new(root_ts, {
        rotation: -90,
        text: "Count",
        y: am5.p50,
        centerX: am5.p50,
        fill: am5.color("#ffffff"),
        fontSize: 11
      })
    );

      yAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      // Add legend
      // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
      var legend = chart.children.push(am5.Legend.new(root_ts, {
        centerX: am5.p50,
        x: am5.p50
      }));

      legend.labels.template.setAll({
        oversizedBehavior: "truncate",
        fill: am5.color("#ffffff"),
        fontSize: 17,
        scale: 0.8,
        //textDecoration: "underline"
        //width: am5.percent(200)
        //fontWeight: "300"
      });

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root_ts, {
          name: name,
          stacked: true,
          xAxis: xAxis,
          yAxis: yAxis,
          valueYField: fieldName,
          valueXField: "date",
          valueYGrouped: "sum"
        }));

        series.columns.template.setAll({
          tooltipText: "{name}, {categoryX}: {valueY}",
          tooltipY: am5.percent(10)
        });
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear();

        series.bullets.push(function() {
          return am5.Bullet.new(root_ts, {
            sprite: am5.Label.new(root_ts, {
              text: "{valueY}",
              fill: root_ts.interfaceColors.get("alternativeText"),
              centerY: am5.p50,
              centerX: am5.p50,
              populateText: true
            })
          });
        });

        legend.data.push(series);
      }

      makeSeries("Bored Pile", "pile");
      makeSeries("Pile Cap", "pilecap");
      makeSeries("Pier", "pier");
      makeSeries("Pier Head", "pierhead");
      makeSeries("Precast", "precast");

      chart.appear(1000, 100);


    });
  }
  timeSeriesChartViaduct("All");


  //----------------------------------------------------------------------------------//
    /// Time series chart EXPERIMENT
    var root8 = am5.Root.new("timeSeriesChartLand");
    root8._logo.dispose();

    function timeSeriesChartLand(cpValue) {
      root8.container.children.clear();

      var query = lotLayer.createQuery();
      const cpExpression = "CP = '" + cpValue + "'";
      const statusExpression = "HandedOverDate IS NOT NULL";

      if (cpValue === 'All' || cpValue === undefined) {
        query.where = statusExpression;

      } else {
        query.where = cpExpression + " AND " + statusExpression;
      }

      var total_count_handedOver_private = {
        onStatisticField: "CASE WHEN (LandOwner <> 'BASES CONVERSION DEVELOPMENT AUTHORITY' and LandOwner <> 'MANILA RAILROAD COMPANY') THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_count_handedOver_private",
        statisticType: "sum"
      }

      var total_count_handedOver_public = {
        onStatisticField: "CASE WHEN (LandOwner = 'BASES CONVERSION DEVELOPMENT AUTHORITY' or LandOwner = 'MANILA RAILROAD COMPANY') THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_count_handedOver_public",
        statisticType: "sum"
      }

      query.outStatistics = [total_count_handedOver_private, total_count_handedOver_public];
      query.outFields = ["HandedOverDate"];
      query.orderByFields = ["HandedOverDate"];
      query.groupByFieldsForStatistics = ["HandedOverDate"];

      const private = [];
      const public = [];

      lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features;
        ////
        // collect all dates
        const data = stats.map((result, index) => {
          const attributes = result.attributes;
          const date = attributes.HandedOverDate;

          const privateCount = attributes.total_count_handedOver_private;
          const publicCount = attributes.total_count_handedOver_public;

          // compile in object array
          return Object.assign({}, {
            date,
            private: privateCount,
            public: publicCount
          });
        });

        // set themes
        root8.setThemes([
          am5themes_Animated.new(root8)
        ]);

      // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root8.container.children.push(am5xy.XYChart.new(root8, {
          panX: false,
          panY: false,
          wheelX: "panX",
          wheelY: "zoomX",
          paddingBottom: 35,
        }));

        chart.get("colors").set("colors", [
          am5.color("#e8ff00"),
          am5.color("#4a99ff"),
        ]);

        // Chart title
        chart.children.unshift(am5.Label.new(root8, {
          text: "Monthly Progress of Handed-Over Lots",
          fontSize: 14,
          fontWeight: "bold",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          x: am5.percent(50),
          centerX: am5.percent(50),
          paddingTop: 0,
          paddingBottom: 0,
        }));

        // Add cursor
        // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
        var cursor = chart.set("cursor", am5xy.XYCursor.new(root8, {
          behavior: "zoomX"
        }));
        cursor.lineY.set("visible", false);

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root8, {
          maxDeviation: 0,
          groupData: true,
          baseInterval: {
            timeUnit: "day",
            count: 1
          },
          groupIntervals: [{timeUnit: "month", count: 1}],
          renderer: am5xy.AxisRendererX.new(root8, {
            minGridDistance: 60,
            strokeOpacity: 1,
            strokeWidth: 1,
            stroke: am5.color("#ffffff"),
          }),
          //tooltip: am5.Tooltip.new(root8, {})
        }));

        // Label properties for yAxis (category axis)
        xAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root8, {
          calculateTotals: true,
          min: 0,
          renderer: am5xy.AxisRendererY.new(root8, {
            minGridDistance: 60,
            strokeOpacity: 1,
            strokeWidth: 1,
            stroke: am5.color("#ffffff"),
          })
        }));

        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        // Add yaxix title
        yAxis.children.unshift(
          am5.Label.new(root8, {
            rotation: -90,
            text: "No. of handed-over lots",
            y: am5.p50,
            centerX: am5.p50,
            fill: am5.color("#ffffff"),
            fontSize: 11
          })
        );

      // Add legend
      // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
      var legend = chart.children.push(am5.Legend.new(root8, {
        centerX: am5.p50,
        centerY: am5.percent(50),
        x: am5.p50,
        y: am5.percent(108),

      }));

      legend.labels.template.setAll({
        oversizedBehavior: "truncate",
        fill: am5.color("#ffffff"),
        fontSize: 17,
        scale: 0.8,
        //textDecoration: "underline"
        //width: am5.percent(200)
        //fontWeight: "300"
      });


      function makeSeries(name, fieldName) {
        // Add series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(am5xy.ColumnSeries.new(root8, {
          name: name,
          stacked: true,
          xAxis: xAxis,
          yAxis: yAxis,
          valueYField: fieldName,
          valueXField: "date",
          valueYGrouped: "sum"
        }));

        series.columns.template.setAll({
          tooltipText: "{name}, {categoryX}: {valueY}",
          tooltipY: am5.percent(10),
          strokeOpacity: 0 
        });
        series.data.setAll(data);
        series.appear(1000);

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root8, {
            locationY: 1,
            locationX: 0.5,
            sprite: am5.Label.new(root8, {
              text: "{valueYTotal}",
              fill: root8.interfaceColors.get("alternativeText"),
              centerY: 0,
              centerX: am5.p50,
              populateText: true,
              fontSize: 10
            })
          });
        });
        legend.data.push(series);
      }
      makeSeries("Private Land", "private");
      makeSeries("Public Land", "public");
      
      chart.appear(1000, 100);
      }); 
    }
    timeSeriesChartLand();
    /////////////////// END Of LAYER IMPORT ////////////////////////////

    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }

    view.ui.empty("top-left");
    
  //Search Widget 
  var searchWidget = new Search({
    view: view,
    locationEnabled: false,
    allPlaceholder: "Chainage or Pier No.",
    includeDefaultSources: false,
    sources: [
      {
        layer: chainageLayer,
        searchFields: ["KmSpot"],
        displayField: "KmSpot",
        exactMatch: false,
        outFields: ["KmSpot"],
        name: "Main KM",
        placeholder: "example: 80+400"
      },
      {
        layer: pierAccessLayer,
        searchFields: ["PIER"],
        displayField: "PIER",
        exactMatch: false,
        outFields: ["PIER"],
        name: "Pier No.",
        placeholder: "example: PLK-01"
      },
    ]
  });
    
    const searchExpand = new Expand({
      view: view,
      content: searchWidget,
      expandIconClass: "esri-icon-search"
    });
    view.ui.add(searchExpand, {
      position: "top-right"
    });
    
    searchExpand.watch("expanded", function() {
      if(!searchExpand.expanded) {
        searchWidget.searchTerm = null;
      }
    });

    // Legend
    var legend_land = new Legend({
      view,
      container: "land-legend",
      layerInfos: [
        {
          layer: lotLayer,
          title: ""
        }
      ]
    });

    var legend_structure = new Legend({
      view,
      container: "structure-legend",
      layerInfos: [
        {
          layer: structureLayer,
          title: ""
        }
      ]
    });

    var legend_nlo = new Legend({
      view,
      container: "nlo-legend",
      layerInfos: [
        {
          layer: nloLayer,
          title: ""
        }
      ]
    });

    var legend_strucOwnership = new Legend({
      view,
      container: "strucOwnership-legend",
      layerInfos: [
        {
          layer: strucOwnershipLayer,
          title: ""
        }
      ]
    });

    var legend_occupancy = new Legend({
      view,
      container: "occupancy-legend",
      layerInfos: [
        {
          layer: occupancyLayer,
          title: ""
        }
      ]
    });

    var legend_pierAccess = new Legend({
      view,
      container: "pierAccess-legend",
      layerInfos: [
        {
          layer: pierAccessLayer,
          title: ""
        }
      ]
    });

    var legend_stationBox = new Legend({
      view,
      container: "stationBox-legend",
      layerInfos: [
        {
          layer: stationBoxLayer,
          title: ""
        }
      ]
    });

    var legend_pnr = new Legend({
      view,
      container: "pnr-legend",
      layerInfos: [
        {
          layer: pnrLayer,
          title: ""
        }
      ]
    });

    var legend_treeCut = new Legend({
      view,
      container: "treeCutting-legend",
      layerInfos: [
        {
          layer: treeCuttingLayer,
          title: ""
        }
      ]
    });

    var legend_treeCompen = new Legend({
      view,
      container: "treeCompensation-legend",
      layerInfos: [
        {
          layer: treeCompensationLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPoint = new Legend({
      view,
      container: "utilityPoint-legend",
      layerInfos: [
        {
          layer: utilityPointLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPointStatus = new Legend({
      view,
      container: "utilityPointStatus-legend",
      layerInfos: [
        {
          layer: utilityPointLayer1,
          title: ""
        }
      ]
    });

    var legend_utilityLine = new Legend({
      view,
      container: "utilityLine-legend",
      layerInfos: [
        {
          layer: utilityLineLayer,
          title: ""
        }
      ]
    });

    var legend_utilityLineStatus = new Legend({
      view,
      container: "utilityLineStatus-legend",
      layerInfos: [
        {
          layer: utilityLineLayer1,
          title: ""
        }
      ]
    });

    var legend_prowBox = new Legend({
      view,
      container: "prow-legend",
      layerInfos: [
        {
          layer: prowLayer,
          title: ""
        }
      ]
    });

    var legend_chainage = new Legend({
      view,
      container: "chainage-legend",
      layerInfos: [
        {
          layer: chainageLayer,
          title: ""
        }
      ]
    });

    var legend_viaduct = new Legend({
      view,
      container: "viaduct-legend",
      layerInfos: [
        {
          layer: viaductLayer,
          title: ""
        }
      ]
    });

    var legend_stationstructure = new Legend({
      view,
      container: "stationstructure-legend",
      layerInfos: [
        {
          layer: buildingLayer,
          title: ""
        }
      ]
    });

    // Default setting
    lotLayer.visible = true;
    structureLayer.visible = false;
    nloLayer.visible = false;
    occupancyLayer.visible = false;
    strucOwnershipLayer.visible = false;
    pnrLayer.visible = true;
    treeCuttingLayer.visible = false;
    treeCompensationLayer.visible = false;
    utilityPointLayer.visible = false;
    utilityPointLayer1.visible = false;
    utilityLineLayer.visible = false;
    utilityLineLayer1.visible = false;
    pierAccessLayer.visible = true;
    stationBoxLayer.visible = true;
    prowLayer.visible = true;
    chainageLayer.visible = false;
    viaductLayer.visible = false;
    buildingLayer.visible = false;

    // Hide and Unhide of Legend + layerList + lotLayer
    // 1. Checkbox
    const landCheckbox = document.getElementById("land-check");
    const structureCheckbox = document.getElementById("structure-check");
    const nloCheckbox = document.getElementById("NLO-check");
    const occupancyCheckbox = document.getElementById("occupancy-check");
    const strucOwnershipCheckbox = document.getElementById("strucOwnership-check");
    const fncCheckbox = document.getElementById("fnc-check");
    const pnrCheckbox = document.getElementById("pnr-check");
    const treeCuttingCheckbox = document.getElementById("treeCutting-check");
    const treeCompensationCheckbox = document.getElementById("treeCompensation-check");
    const utilityPointCheckbox = document.getElementById("utilityPoint-check");
    const utilityPointStatusCheckbox = document.getElementById("utilityPointStatus-check");
    const utilityLineCheckbox = document.getElementById("utilityLine-check");
    const utilityLineStatusCheckbox = document.getElementById("utilityLineStatus-check");
    const pierAccessCheckbox = document.getElementById("pierAccess-check");
    const stationBoxCheckbox = document.getElementById("stationBox-check");
    const prowCheckbox = document.getElementById("prow-check");
    const chainageCheckbox = document.getElementById("chainage-check");
    const viaductCheckbox = document.getElementById("viaduct-check");
    const stationStructureCheckbox = document.getElementById("stationstructure-check");

    // 2. Legend
    const landLegend = document.getElementById("land-legend");
    const structureLegend = document.getElementById("structure-legend");
    const nloLegend = document.getElementById("nlo-legend");
    const occupancyLegend = document.getElementById("occupancy-legend");
    const strucOwnershipLegend = document.getElementById("strucOwnership-legend");
    const fncLegend = document.getElementById("fnc-legend");
    const pnrLegend = document.getElementById("pnr-legend");
    const treeCuttingLegend = document.getElementById("treeCutting-legend");
    const treeCompensationLegend = document.getElementById("treeCompensation-legend");
    const utilityPointLegend = document.getElementById("utilityPoint-legend");
    const utilityPointStatusLegend = document.getElementById("utilityPointStatus-legend");
    const utilityLineLegend = document.getElementById("utilityLine-legend");
    const utilityLineStatusLegend = document.getElementById("utilityLineStatus-legend");
    const pierAccessLegend = document.getElementById("pierAccess-legend");
    const stationBoxLegend = document.getElementById("stationBox-legend");
    const prowLegend = document.getElementById("prow-legend");
    const chainageLegend = document.getElementById("chainage-legend");
    const viaductLegend = document.getElementById("viaduct-legend");
    const stationStructureLegend = document.getElementById("stationstructure-legend");

    // Lot Layer
    view.when(() => {
      
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        landLegend.hidden = !landLegend.hidden;
        
        // Visible/Unvisible Lot Layer
        if (activeWidget) {
          lotLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          lotLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      } 
      landCheckbox.addEventListener("click", checkBoxClick);
    });

    // Structure Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        structureLegend.hidden = !structureLegend.hidden;
        
        // Visible/unvisible structure layer
        if (activeWidget) {
          structureLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          structureLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      structureCheckbox.addEventListener("click", checkBoxClick);
    });

    // NLO Layer (ISF)
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        nloLegend.hidden = !nloLegend.hidden;
        
        // Visible/unvisible nlo layer
        if (activeWidget) {
          nloLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          nloLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      nloCheckbox.addEventListener("click", checkBoxClick);
    });

    // Occupancy Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        occupancyLegend.hidden = !occupancyLegend.hidden;
        
        // Visible/unvisible occupancy layer
        if (activeWidget) {
          occupancyLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          occupancyLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      occupancyCheckbox.addEventListener("click", checkBoxClick);
    });

    // Structure Ownership (NLO/LO) Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        strucOwnershipLegend.hidden = !strucOwnershipLegend.hidden;
        
        // Visible/unvisible strucOwnership layer
        if (activeWidget) {
          strucOwnershipLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          strucOwnershipLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      strucOwnershipCheckbox.addEventListener("click", checkBoxClick);
    });

    // PNR Land Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        pnrLegend.hidden = !pnrLegend.hidden;
        
        // Visible/unvisible pnr layer
        if (activeWidget) {
          pnrLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          pnrLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      pnrCheckbox.addEventListener("click", checkBoxClick);
    });

    // Tree Cutting layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
        
        // Visible/unvisible treeCutting layer
        if (activeWidget) {
          treeCuttingLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCuttingLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      treeCuttingCheckbox.addEventListener("click", checkBoxClick);
    });

    // Tree Compensation Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
        
        // Visible/unvisible treeCompensation layer
        if (activeWidget) {
          treeCompensationLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCompensationLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      treeCompensationCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointLegend.hidden = !utilityPointLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointStatusLegend.hidden = !utilityPointStatusLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineLegend.hidden = !utilityLineLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineStatusLegend.hidden = !utilityLineStatusLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // Pier Access point Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        pierAccessLegend.hidden = !pierAccessLegend.hidden;
        
        // Visible/unvisible pierAccess layer
        if (activeWidget) {
          pierAccessLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          pierAccessLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      pierAccessCheckbox.addEventListener("click", checkBoxClick);
    });


    // Station Box Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        stationBoxLegend.hidden = !stationBoxLegend.hidden;
        
        // Visible/unvisible stationBox layer
        if (activeWidget) {
          stationBoxLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          stationBoxLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      stationBoxCheckbox.addEventListener("click", checkBoxClick);
    });

    // PROW Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        prowLegend.hidden = !prowLegend.hidden;
        
        // Visible/unvisible prow layer
        if (activeWidget) {
          prowLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          prowLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      prowCheckbox.addEventListener("click", checkBoxClick);
    });

    // Chainage layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        chainageLegend.hidden = !chainageLegend.hidden;
        
        // Visible/unvisible chainage layer
        if (activeWidget) {
          chainageLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          chainageLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      chainageCheckbox.addEventListener("click", checkBoxClick);
    });

    // Viaduct layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        viaductLegend.hidden = !viaductLegend.hidden;
        
        // Visible/unvisible chainage layer
        if (activeWidget) {
          viaductLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          viaductLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      viaductCheckbox.addEventListener("click", checkBoxClick);
    });

    // Building layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        stationStructureLegend.hidden = !stationStructureLegend.hidden;
        
        // Visible/unvisible chainage layer
        if (activeWidget) {
          buildingLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          buildingLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      stationStructureCheckbox.addEventListener("click", checkBoxClick);
    });
 
    // view.when
    view.when(() => {
      document.querySelector("#header-title").textContent = "N2 WORK PROGRESS";
      document.querySelector("#item-description").innerHTML = `
                                                                 1. This web app shows key progress on:<br>
                                                                 <ul><li>Land acquisition including structures and NLOs (non-land owners),</li><br>
                                                                     <li>Tree cutting and compensation,</li><br>
                                                                     <li>Utility relocation</li></ul><br>
                                                                 2. <b>Click tabs</b> under the contract packages list in the right side of the header to view progress on pre-construction and construction works.<br>
                                                                 <br>3. <b>Click series in pie charts</b> to view progress on the respective items on the map.<br>
                                                                 <br>4. Click/unclick widget icons for viewing:<br>
                                                                  <ul><li>Layer list with legend,</li><br>
                                                                      <li>Basemaps,</li><br>
                                                                      <li>Underground (underground navigation)</li><br>
                                                                      <li>Links to individual web apps,</li><br>
                                                                      <li>Progress charts for land acquisition and viaduct construction,</li></ul>
                                                                 `
                                                                 ;

      let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;

            // Open the time series chart when chart widget is opened.
            if (`${activeWidget}` === "animation") {
              initialization();
            }

          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });

        // IMPORTANT NOTE:
        // You need to include progress chart and see-through-ground inside widget calcite-panel; otherwise,
        // when you click the checkbox, toggling action will be reversed for this activation.
        
        // Progress Chart
        document.getElementById("viaduct-checkbox").addEventListener("click", function(event) {
          const checked = event;
          timeSeriesChartViaductDiv.hidden = !timeSeriesChartViaductDiv.hidden;
        });

        document.getElementById("land-checkbox").addEventListener("click", function(event) {
          const timeSeriesChartLandDiv = document.getElementById("timeSeriesChartLand");
          const checked = event;
          timeSeriesChartLandDiv.hidden = !timeSeriesChartLandDiv.hidden;
        });

        // See-through-Ground
        view.when(function() {
          // allow navigation above and below the ground
          map.ground.navigationConstraint = {
            type: "none"
          };
          // the webscene has no basemap, so set a surfaceColor on the ground
          map.ground.surfaceColor = "#fff";
                  
          // to see through the ground, set the ground opacity to 0.4
          map.ground.opacity = 1;
        });
                  
        document.getElementById("myLink").addEventListener("click", function(event) {
          const checked = event.srcElement.checked;
          map.ground.opacity = event.srcElement.checked ? 0 : 0.8;
          view.environment.atmosphereEnabled = false;
        });
      // Switch theme
      document.querySelector("calcite-shell").hidden = false;
      document.querySelector("calcite-loader").hidden = true;

    });

    // Measurement Widgets
  // To modify analysis objects we will temporarily store the corresponding widget in this variable.
  let analysisWidget = null;

  view.when(async () => {
    // Create the analysis objects
    const directLineMeasurementAnalysis = createDirectLineMeasurementAnalysis();
    const areaMeasurementAnalysis = createAreaMeasurementAnalysis();
    const sliceAnalysis = createSliceAnalysis();
    const lineOfSightAnalysis = createLineOfSightAnalysis();

    // Wait for the view to load before adding analysis objects
    await reactiveUtils.whenOnce(() => !view.updating);

    // Add analysis object to the view to show them
    view.analyses.addMany([
      directLineMeasurementAnalysis,
      areaMeasurementAnalysis,
      sliceAnalysis,
      lineOfSightAnalysis
    ]);

    // Configure buttons to interact with the analysis objects
    const areaMeasurementAnalysisButton = setupAnalysisButton(
      "areaMeasurementAnalysisButton",
      () => new AreaMeasurement3D({ view, analysis: areaMeasurementAnalysis })
    );

    const directLineMeasurementAnalysisButton = setupAnalysisButton(
      "directLineMeasurementAnalysisButton",
      () => new DirectLineMeasurement3D({ view, analysis: directLineMeasurementAnalysis })
    );

    const lineOfSightAnalysisButton = setupAnalysisButton(
      "lineOfSightAnalysisButton",
      () => new LineOfSight({ view, analysis: lineOfSightAnalysis })
    );

    const sliceAnalysisButton = setupAnalysisButton(
      "sliceAnalysisButton",
      () => new Slice({ view, analysis: sliceAnalysis })
    );

    // Remove button is a bit special
    document.getElementById("removeWidgetButton").addEventListener("click", () => {
      removeActiveWidget();
    });

    function setupAnalysisButton(elementId, widgetFactotry) {
      const button = document.getElementById(elementId);

      button.addEventListener("click", () => {
        // remove current widget (if any)
        removeActiveWidget();

        // install a suitable widget in the `analysisWidget` variable
        analysisWidget = widgetFactotry();

        // highlight this button as the currently active one and add the remove widget button
        button.appearance = "outline";
        document.getElementById("removeWidgetButton").style.display = "block";

        // show the analysisWidget in the lower right corner
        view.ui.add(analysisWidget, "bottom-right");
      });
      return button;
    }

    function removeActiveWidget() {
      // remove the analysisWidget if one exists
      if (analysisWidget) {
        analysisWidget.destroy();
        analysisWidget = null;
      }

      // hide remove button
      document.getElementById("removeWidgetButton").style.display = "none";

      // reset appearance of the analysis buttons
      areaMeasurementAnalysisButton.appearance = "solid";
      directLineMeasurementAnalysisButton.appearance = "solid";
      lineOfSightAnalysisButton.appearance = "solid";
      sliceAnalysisButton.appearance = "solid";
    }
  });

  function createDirectLineMeasurementAnalysis() {
    return new DirectLineMeasurementAnalysis({
      startPoint: newPoint(-8238827, 4971466, 3),
      endPoint: newPoint(-8238819, 4971537, 3)
    });
  }

  function createAreaMeasurementAnalysis() {
    const roofPolygon = new Polygon({
      rings: [
        [
          [-8238931, 4971381, 50],
          [-8238926, 4971426, 50],
          [-8238835, 4971415, 50],
          [-8238841, 4971369, 50],
          [-8238931, 4971381, 50]
        ]
      ],
      spatialReference: SpatialReference.WebMercator
    });

    return new AreaMeasurementAnalysis({
      geometry: roofPolygon
    });
  }

  function createSliceAnalysis() {
    return new SliceAnalysis({
      shape: {
        position: newPoint(-8238840, 4971700, 21),
        tilt: 0,
        width: 70,
        height: 100,
        heading: 278
      }
    });
  }

  function createLineOfSightAnalysis() {
    return new LineOfSightAnalysis({
      observer: { position: newPoint(-8238825, 4971538, 48) },
      targets: [
        { position: newPoint(-8238903, 4971649, 2) },
        { position: newPoint(-8238866, 4971629, 19) },
        { position: newPoint(-8238825, 4971880, 2) },
        { position: newPoint(-8238791, 4971784, 2) }
      ]
    });
  }

  function newPoint(x, y, z) {
    // convenience function to have all points in the same spatial reference
    return new Point({ x, y, z, spatialReference: SpatialReference.WebMercator });
  }

  //view.ui.add("measurementToolMenu", "bottom-left");

  const measurementToolMenuExpand = new Expand({
    view,
    content: document.getElementById("measurementToolMenu"),
    expandIconClass: "esri-icon-measure-line"
  });
  view.ui.add(measurementToolMenuExpand, "top-right");

    });
  </script>
</html>