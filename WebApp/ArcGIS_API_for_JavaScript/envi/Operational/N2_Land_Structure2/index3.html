<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>N2 Land Acquisition</title>
    
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.3/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.3/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.25/"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tabs {
      width: 18vw;
      margin-right: 4.5vw;
      height: 100%;
    }

    calcite-tab {
      width: 17vw;
        height: 100%;
        padding-left: 3;
        padding-right: 3;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    
    #chartPanel {
        background-color: rgb(0, 0, 0, 0);
        padding: 10;
    }
    
    #pieChartLotDiv,
    #pieChartLotDiv2,
    #pieChartStructureDiv,
    #pieChartIsfDiv {
        height: 45%;
      margin-bottom: 5;
    }

    
    #lotNumberDiv,
    #pteLotNumberDiv,
    #structureNumberDiv,
    #pteStructureNumberDiv {
      color: rgb(0, 197, 255);
      color: rgb(0, 197, 255);
      text-align: center;
      font-weight: normal;
      font-size: 1.5vw;
      border: solid 0.5px gray;
      padding-top: 1%;
      padding-bottom: 4%;
    }

    #lotNumberDiv b,
    #pteLotNumberDiv b,
    #structureNumberDiv b,
    #pteStructureNumberDiv b {
      font-size: 1.0vw;
      font-family: 'Calibri';
      font-weight: bold;
      color:rgb(250, 246, 246);
    }

    br {
      content: "";
      margin: 2em;
      display: block;
      font-size: 24%;
    }

    b {
        color: orange;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    /* Expropriation List */
    /** clear background color of list box **/
    .panel-side {
      background-color: rgb(0, 0, 0, 0);
      margin-top: 1%;
    }

    /** adjust line height between texts **/
    .panel-side li {
      padding: 1% 1%;
    }

    /** adjust lot ID's font size and color **/
    .panel-side li b{
      color: red;
      font-size: 0.8vw;
    }

    .panel-result {
      cursor: pointer;
      margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
      background-color: rgba(73, 72, 72, 0.5);
    }

    #expropriationListDiv {
      list-style: none;
      padding: 0.5%;
      padding-right: 5%;
      font-size: 0.8vw;
      width: 17vw;
    }

    /* MOA Chart */
    #chartMoaLotDiv,
    #chartMoaStructureDiv {
        width: 100%;
        height: 30%;
        align-items: center;
        padding: 1%;
        margin-bottom: 5;
    }

    /* Dropdown list */
    #dropdownDiv {
      background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: white;
        text-align: right;
        margin: auto;
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
    
    /*  */
    .esri-legend__layer-caption {
      display: none;
    }

  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      
       <!--  Header slot  -->
      <div slot="header" id="header">
        
      <!-- Title -->
      <h2 id="header-title" slot="header"></h2>

      <div id="dateDiv">March 1, 2023</div>

      <!-- Dropdown Lists -->
      <div id="dropdownDiv" class="esri-widget">
        <label id="dropdownMunicipalLabel">
            City/Municipality:
            <select id="municipalSelect" class="esri-widget"></select>
        </label>
        <label id="dropdownBarangayLabel">
            Barangay:
            <select  style="width: 10vw" id="barangaySelect" class="esri-widget"></select>
        </label>
      </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="viewDiv">
        <!-- Chart Panel -->
        <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
        <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
        <calcite-tabs>
            <div id="chartPanel">
                <calcite-tab-nav slot="tab-nav" id="thetabs">
                    <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                    <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                    <calcite-tab-title class="ISF">ISF</calcite-tab-title>
                    <calcite-tab-title class="ExproList">Expro List</calcite-tab-title>
                </calcite-tab-nav>
                <calcite-tab>
                    <calcite-switch class="chartChange"></calcite-switch>
                    <div class="box" id="pieChartLotDiv"></div>
                    <div class="box2" id="pieChartLotDiv2" hidden></div>
                    <div id="lotNumberDiv"></div>
                    <div id="chartMoaLotDiv"></div>
                    <div id="pteLotNumberDiv"></div>
                </calcite-tab>
                <calcite-tab>
                  <div class="boxStructure" id="pieChartStructureDiv"></div>
                  <div id="structureNumberDiv"></div>
                  <div id="chartMoaStructureDiv"></div>
                  <div id="pteStructureNumberDiv"></calcite-label>
                  </div>
                </calcite-tab>
                <calcite-tab>
                    <div class="boxIsf" id="pieChartIsfDiv"></calcite-label>
                    </div>
                </calcite-tab>
                <calcite-tab>
                  <div class="panel-side esri-widget">
                    <ul id="expropriationListDiv">
                      <li>Loading&hellip;</li>
                    </ul>
                  </div>
                </calcite-tab>
            </div>
        </calcite-tabs>
       </div>

    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/layers/SceneLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer",
      "esri/core/reactiveUtils",
      "esri/popup/support/FieldInfoFormat"
    ], function(WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer, reactiveUtils, 
                FieldInfoFormat
                 ) {
      
    // Reference link
    // 2D to 3D
    //https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/

    // 3D Extrusion using point, line, and polygon
    // https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/3d-visualization-working-with-objects-paths-and-extrusion/?rmedium=redirect&rsource=blogs.esri.com/esri/arcgis/2016/01/25/3d-visualization-working-with-objects-paths-and-extrusion


    var map = new Map({
        basemap: "dark-gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    /*
    var view = new MapView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });
    */
    var view = new SceneView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        viewingMode: "local",
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    function colorLotReqs(){
        return {
            0: [0, 197, 255], 
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,0,0,0]
        }
    }

    let lotLayerRenderer = {
        type: "unique-value",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusLA == 0, '0',$feature.StatusLA == 1, '1', $feature.StatusLA == 2, '2', \
                               $feature.StatusLA == 3, '3', $feature.StatusLA == 4, '4', \
                               $feature.StatusLA == 5, '5', $feature.StatusLA)",
        uniqueValueInfos: [
            {
                value: "0",
                label: "Handed-Over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[0],
                }
            },
            {
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            }
        ]
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        renderer:lotLayerRenderer,
        outFields: ["*"],
        title: "Status of Land Acquisition",
        labelsVisible: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    map.add(lotLayer, 1);

    /// Popup for lot layer
    const lotStatusArray = [
        "Handed-Over",
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro"
    ];

    const landUseArray = [
        "Agricultural",
        "Agricultural & Commercial",
        "Agricultural / Residential",
        "Commercial",
        "Industrial",
        "Irrigation",
        "Residential",
        "Road",
        "Road Lot",
        "Special Exempt"
    ]

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked PierNoLayer
            const lotNo = event.graphic.attributes.LotID;
            const handOverDate = event.graphic.attributes.HandOverDate;
            const handOverArea = event.graphic.attributes.percentHandedOver;
            const statusLot = event.graphic.attributes.StatusLA;
            const landUse = event.graphic.attributes.LandUse;
            const municipal = event.graphic.attributes.Municipality;
            const barangay = event.graphic.attributes.Barangay;
            const landOwner = event.graphic.attributes.LandOwner;
            const cpNo = event.graphic.attributes.CP;

            // Convert numeric to date format

            var date = new Date(handOverDate);
            var DATES = dateFormat(date, 'MM-dd-yyyy');

            if (DATES === '01-01-1970') {
                var finalDate = "Undefined"
            } else {
                var finalDate = dateFormat(date, 'MM-dd-yyyy');
            }
            // Convert domain code to domain name
            /// 1. Status
            if (statusLot >= 0) {
                //headerTitleDiv.innerHTML = lotStatusArray[statusLot];
                var statusLotTemp = lotStatusArray[statusLot];
            }

            if (landUse >=1 ) {
                var landUseTemp = landUseArray[landUse - 1];
            }

            return `<ul><li>Hand-Over Date:   <b>${finalDate}</b></li><br>
                    <li>Handed-Over Area: <b>${handOverArea} %</b></li><br>
                    <li>Status:           <b>${statusLotTemp}</b></li><br>
                    <li>Land Use:         <b>${landUseTemp}</b></li><br>
                    <li>Municipality:     <b>${municipal}</b></li><br>
                    <li>Barangay:         <b>${barangay}</b></li><br>
                    <li>Land Owner:       <b>${landOwner}</b>
                    <li>CP:               <b>${cpNo}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{LotID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


    // Structure Layer
    // Polygon 3D extrution
    const height = 5;
    const edgeSize = 0.3;
    const dismantled = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 197, 255, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const paid = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [112, 173, 71, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const payp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 112, 255, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const legalpass = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 255, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const otc = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 170, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const lbp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 0, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const structureRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: [0, 0, 0, 0.4]
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: edgeSize
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "StatusStruc",
      legendOptions: {
        title: "Status of Structure"
      },
      uniqueValueInfos: [
        {
          value: 1,
          symbol: dismantled,
          label: "Dismantling/Clearing"
        },
        {
          value: 2,
          symbol: paid,
          label: "Paid"
        },
        {
          value: 3,
          symbol: payp,
          label: "For Payment Processing"
        },
        {
          value: 4,
          symbol: legalpass,
          label: "For Legal Pass"
        },
        {
          value: 5,
          symbol: otc,
          label: "For Appraisal/Offer to Compensation"
        },
        {
          value: 6,
          symbol: lbp,
          label: "LBP Account Opening"
        },
      ]
    }

    var structureLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 6,
      title: "Structure",
      renderer: structureRenderer,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      },
      popupTemplate: {
        title: "<p>{StrucID}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "StrucOwner",
                label: "Structure Owner"
              },
              {
                fieldName: "StatusStruc",
                label: "<p>Status of Structure</p>"
              },               
              {
                fieldName: "LotID",
                label: "Lot ID"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              }
            ]
          }
        ]
      }
    });
    map.add(structureLayer);

    /*
    const colors = {
        1: [0, 197, 255], // Dismantling/Clearing (original: 255, 0, 197)
        2: [112, 173, 71], // Paid
        3: [0, 112, 255], // For Payment Processing
        4: [255, 255, 0], // For Legal Pass 
        5: [255, 170, 0],// For Appraisal/Offer to Compensate
        6: [255, 0, 0] //LBP Account Opening
    };

    function renderStructureLayer() {
        const renderer = new UniqueValueRenderer({
            field: "StatusStruc"
        });
        for (let property in colors) {
            if (colors.hasOwnProperty(property)) {
                renderer.addUniqueValueInfo({
                    value: property,
                    symbol: {
                        type: "simple-fill",
                        color: colors[property],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7
                        }
                    }
                });
            }
        }
        structureLayer.renderer = renderer;
    }
    
    renderStructureLayer();
*/
    // Structure (NLO/LO)
    let NLOLORenderer = {
        type: "unique-value",
        field: "Status",
        uniqueValueInfos:[
            {
                value: 1,
                label: "LO (Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "forward-diagonal",
                    color: [128, 128, 128, 0.8],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            },
            {
                value: 2,
                label: "NLO (Non-Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "vertical",
                    color: [128, 128, 128, 0.8],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            }
        ]
    };

    var structureNLOLOLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        renderer: NLOLORenderer,
        layerId: 3,
        title: "NLO/LO (Structure)",
        outFields: ["*"],
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    map.add(structureNLOLOLayer);

    // Status of Relocation (Occupancy)
    var relocationPtLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        outFields: ["*"],
        title: "Occupancy (Structure)",
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "StrucOwner",
                    label: "Structure Owner"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                {
                    fieldName: "Occupancy",
                    label: "<p>Status for Relocation(structure)</p>"
                },
                {
                    fieldName: "Name",
                },
                {
                    fieldName: "Status",
                    label: "Status of NLO/LO"
                }
                ]
            }
            ]
        }
    });
    map.add(relocationPtLayer);

    // Priority Lots
    var priorityLabel = new LabelClass({
        labelExpressionInfo: {expression: "$feature.LotID"},
        symbol: {
            type: "text",
            color: "black",
            haloColor: "white",
            haloSize: 0.5,
            font: {
                size: 12,
                weight: "bold"
            }
        }
    });

    // ISF
    const isfSymbolColor = {
        1: [0, 197, 255], // Relocated  (original: 255, 0, 197)
        2: [112, 173, 71], // Paid
        3: [0, 112, 255], // For Payment Processing
        4: [255, 255, 0], // For Legal Pass 
        5: [255, 170, 0], // For Appraisal/OtC/Requirements for Other Entitlements
        6: [255, 0, 0] //LBP Account Opening
    }
    const outlineColor = "gray";

    var verticalOffsetExisting = {
      screenLength: 80,
        maxWorldLength: 500,
        minWorldLength: 30
    };

    function getUniqueValueSymbol(name, size) {
      return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: size,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        /*
        verticalOffset: verticalOffsetExisting,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
        */
      };
    }

    const symbolSize = 30;
    let isfRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.StatusRC == 1, 'relocated', \
                        $feature.StatusRC == 2, 'paid', $feature.StatusRC == 3, 'payp', \
                        $feature.StatusRC == 4, 'legalpass', $feature.StatusRC == 5, 'otc', \
                        $feature.StatusRC == 6, 'lbp', $feature.StatusRC)",
        uniqueValueInfos: [
            {
              value: "relocated",
              label: "Relocated",
              symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Relocated.svg", symbolSize),
            },
            {
              value: "paid",
              label: "Paid",
              symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Paid.svg", symbolSize),
            },
            {
                value: "payp",
                label: "For Payment Processing",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_PaymentProcess.svg", symbolSize),
            },
            {
                value: "legalpass",
                label: "For Legal Pass",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LegalPass.svg", symbolSize),
            },
            {
                value: "otc",
                label: "For Appraisal/OtC/Reqs for Other Entitlements",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_OtC.svg", symbolSize),
            },
            {
                value: "lbp",
                label: "LBP Account Opening",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LBP.svg", symbolSize),
            }
        ]
    };

    var reloISFLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        renderer: isfRenderer,
        outFields: ["*"],
        title: "ISF (Informatl Settlers Families)",
        elevationInfo: {
          mode: "relative-to-scene"
        },
        minScale: 10000,
        maxScale: 0,
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "StrucOwner",
                    label: "Structure Owner"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                {
                    fieldName: "StatusRC",
                    label: "<p>Status for Relocation(ISF)</p>"
                },
                {
                    fieldName: "Name",
                },
                {
                    fieldName: "Status",
                    label: "Status of NLO/LO"
                }
                ]
            }
            ]
        }
    });
    //reloISFLayer.listMode = "hide";
    map.add(reloISFLayer);

    // Chainage
    var labelChainage = new LabelClass({
        labelExpressionInfo: {expression: "$feature.KmSpot"},
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 15,
                    weight: "bold"
                }
            }
    });

    var chainageRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    };

    var chainageLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "Chainage",
        elevationInfo: {
            mode: "relative-to-ground"
        },
        labelingInfo: [labelChainage],
        minScale: 150000,
        maxScale: 0,
        renderer: chainageRenderer,
        outFields: ["*"],
        popupEnabled: false
    });
    map.add(chainageLayer);

    // Pier Head and Column

    // Polygon 3D extrution
    const pHeight = 0;

    const pierColumn = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [78, 78, 78, 0.5]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 0.3
          }
        }
      ]
    };

    const pierHead = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [169, 169, 169, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    };

    const pileCap = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 3,
          material: {
            color: [200, 200, 200, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    }

    const pierHeadRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: "#E1E1E1"
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: 1.0
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "Layer",
      legendOptions: {
        title: "Pier Head/Pier Column/Pile Cap"
      },
      uniqueValueInfos: [
        {
          value: "Pier_Column",
          symbol: pierColumn,
          label: "Pier Column"
        },
        /*
        {
          value: "Pier_Head",
          symbol: pierHead,
          label: "Pier Head"
        },
        */
        {
          value: "Pile_Cap",
          symbol: pileCap,
          label: "Pile Cap"
        },
      ]
    }

    var pierHeadColumnLayerLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        title: "Pier Head/Column",
        outFields: ["*"],
        minScale: 150000,
        maxScale: 0,
        renderer: pierHeadRenderer,
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    //pierHeadColumnLayerLayer.listMode = "hide";
    map.add(pierHeadColumnLayerLayer, 1);

    // Pier No (point)

    var pierNoRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    }

      // labels
      // for multiple label class to a layer:
      // https://developers.arcgis.com/javascript/latest/sample-code/labels-multiple-classes/
      const pierAccessReadyDateLabel = new LabelClass({
      symbol: {
        type: "label-3d", // autocast as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text",
            material: {
              color: "#00ff00"
            },
            size: 15,
            color: "#00ff00",
            haloColor: "#00ff00",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "bold"
            },
          }
        ],
        verticalOffset: {
          screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7]
          }
        }
      },
      labelExpressionInfo: {
        expression: "$feature.PIER"
        //'DefaultValue($feature.GeoTechName, "no data")'
        //"IIF($feature.Score >= 13, '', '')"
        //value: "{Type}"
      },
      labelPlacement: "above-center",
      where: "AccessDate <= date'2022-07-31'"
    });

    const pierAccessNotYetLabel =  new LabelClass({
      symbol: {
        type: "label-3d", // autocast as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text",
            material: {
              color: "#cccccc"
            },
            size: 10,
            color: "#cccccc",
            haloColor: "#cccccc",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "normal"
            },
          }
        ],
        verticalOffset: {
          screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7]
          }
        }
      },
      labelExpressionInfo: {
        expression: "$feature.PIER"
        //'DefaultValue($feature.GeoTechName, "no data")'
        //"IIF($feature.Score >= 13, '', '')"
        //value: "{Type}"
      },
      labelPlacement: "above-center",
      where: "AccessDate > date'2022-08-01'"
    });

    var PierNoLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 6,
        labelingInfo: [pierAccessReadyDateLabel, pierAccessNotYetLabel],
        renderer: pierNoRenderer,
        title: "Pier Access Date",
        minScale: 150000,
        maxScale: 0,
        outFields: ["*"],
        elevationInfo: {
          model: "on-the-ground"
        }
    },{utcOffset: 300});
    map.add(PierNoLayer, 3);

    /// Define popup template on dates for pier no
    // Date Format function
    function dateFormat(inputDate, format) {
        //parse the input date
        const date = new Date(inputDate);

        //extract the parts of the date
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();    

        //replace the month
        format = format.replace("MM", month.toString().padStart(2,"0"));        

        //replace the year
        if (format.indexOf("yyyy") > -1) {
            format = format.replace("yyyy", year.toString());
        } else if (format.indexOf("yy") > -1) {
            format = format.replace("yy", year.toString().substr(2,2));
        }

        //replace the day
        format = format.replace("dd", day.toString().padStart(2,"0"));

        return format;
    }

    // Custom Popup Content for PierNoLayer
    let customContent = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked PierNoLayer
            const stats = event.graphic.attributes.AccessDate;
            const pierNo = event.graphic.attributes.PIER;

            // Convert numeric to date format
            var date = new Date(stats);
            const dateValue = dateFormat(date, 'MM-dd-yyyy');

            // If the date is before current date, popupContent should be "AVAILABLE"
            const d1 = new Date('08-31-2022');

            if (date < d1) {
                DATES = "AVAILABLE";
            } else {
                DATES = dateValue;
            }

            //return `Access Date: <b>${DATES}</b>`;
            return `Access Date: <b>${DATES}</b>`;

        }
    });

    const template = new PopupTemplate({
        outFields: ["*"],
        title: "Pier No: <b>{PIER}</b>",
        lastEditInfoEnabled: false,
        content: [customContent]
    });
    PierNoLayer.popupTemplate = template;

    // Station Box
    let stationBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
            {
                value: "00_Platform",
                label: "Platform",
                    symbol: {
                    type: "simple-fill",
                    color: [160, 160, 160],
                    style: "backward-diagonal",
                    outline: {
                        width: 1,
                        color: "black"
                    }
                }
            },
            {
                value: "00_Platform 10car",
                label: "Platform 10car",
                symbol: {
                    type: "simple-fill",
                    color: [104, 104, 104],
                    style: "cross",
                    outline: {
                        width: 1,
                        color: "black",
                        style: "short-dash"
                    }
                }
            },
            {
            value: "00_Station",
            label: "Station Box",
            symbol: {
                type: "simple-fill",
                color: [0, 0, 0, 0],
                outline: {
                    width: 2,
                    color: [115, 0, 0]
                }
            }
            }
        ]
    };

    var stationBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        renderer: stationBoxRenderer,
        minScale: 150000,
        maxScale: 0,
        title: "Station Box",
        outFields: ["*"],
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    //stationBoxLayer.listMode = "hide";
    map.add(stationBoxLayer, 2);

    // ROW //
    var rowLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "PROW",
        popupEnabled: false
    });
    map.add(rowLayer,2);

    // Free and Clear Lot
    var fncLayer = new FeatureLayer ({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "Free-and-Clear Area",
        //popupEnabled: false
    });
    map.add(fncLayer,1);

    // PNR
    let pnrRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.LandOwner == 'BASES CONVERSION DEVELOPMENT AUTHORITY', 'BCDA', \
                        $feature.LandOwner == 'MANILA RAILROAD COMPANY' || $feature.LandOwner == 'Manila Railroad Company','PNR',$feature.LandOwner)",
        uniqueValueInfos: [
            {
                value: "BCDA",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            },
            {
                value: "PNR",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            }
        ]
    };

    var pnrLayer = new FeatureLayer({
      portalItem: {
          id: "dca1d785da0f458b8f87638a76918496",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
      },
      layerId: 10,
      title: "Land (PNR)",
      definitionExpression: "LandOwner IN ('BASES CONVERSION DEVELOPMENT AUTHORITY','MANILA RAILROAD COMPANY')",
      outFields: ["*"],
      title: "PNR",
      elevationInfo: {
          model: "on-the-ground"
        },
      labelsVisible: false,
      renderer: pnrRenderer,
      popupTemplate: {
        title: "<p>{LandOwner} ({LotID})</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "HandOverDate",
                label: "Hand-Over Date"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              },
              {
                fieldName: "LandOwner",
                label: "Land Owner"
              }
            ]
          }
        ] 
      }
    });
    map.add(pnrLayer, 1);

  // Station point feature
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: [255, 170, 0]
          },
          size: 20,
          color: "black",
          haloColor: "black",
          haloSize: 1,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 40,
        maxWorldLength: 100,
        minWorldLength: 20
      },
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
              //value: "{TEXTSTRING}"
    }
  });

  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  // Station Layer
  var stationLayer = new SceneLayer({
    portalItem: {
      id: "207cb34b8a324b40985b5805862c4b29",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    labelingInfo: [labelClass],
    renderer: stationsRenderer,
    elevationInfo: {
      mode: "relative-to-ground"
    },
    definitionExpression: "Extension = 'N2'"
                //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);


    // Lot layer centroid for 3D extrusion to display hand-over dates

    // define color and size
    // color: HandOverDate
    // 1672444800000: 2022/12/32
    // 1677542400000: 2023/2/28
    // 1682812800000: 2023/4/30
    // 1690761600000: 2023/7/31
    /*
    // Point 3D extrusion
    const handOverRenderer = {
      type: "simple",
      symbol: {
        type: "point-3d",
        symbolLayers: [
          {
            type: "object",
            resource: {
              primitive: "cylinder"
            },
            width: 10 // in meters
          }
        ]
      },
      label: "Hand-Over Date",
      visualVariables: [
        {
          type: "color",
          field: "HandOverDate",
          stops: [
            {
              value: 1690761600000,
              color: "blue"
            },
            {
              value: 1682812800000,
              color: "yellow"
            },
            {
              value: 1677542400000,
              color: "orange"
            },
            {
              value: 1672444800000,
              color: "red"
            },
          ]
        },
        {
          type: "size",
          field: "HandOverDate",
          stops: [
            {
              value: 1672444800000, // 2022/12/31
              size: 700
            },
            {
              value: 1677542400000, // 2022/12/31
              size: 500
            },
            {
              value: 1682812800000, // 2022/12/31
              size: 300
            },
            {
              value: 1690761600000, // 2022/12/31
              size: 100
            },
          ],
          axis: "height"
        },
        {
          type: "size",
          axis: "width-and-depth",
          useSymbolValue: true // uses the width value defined in the symbol layer (10)
        }

      ]
    }

    var lot_centroid = new FeatureLayer({
      portalItem: {
        id: "c6deb463b3cb4056a76e84cda147fff4",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      renderer: handOverRenderer,
      title: "Hand-Over Dates 3D",
      definitionExpression: "HandOver <> 1"
    });
    map.add(lot_centroid);
*/


    /////////////////// END Of LAYER IMPORT ////////////////////////////

    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      
zoomToLayer(stationLayer);
      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;
      
      const lotNumberDiv = document.getElementById("lotNumberDiv");
      const pteLotNumberDiv = document.getElementById("pteLotNumberDiv");
      const structureNumberDiv = document.getElementById("structureNumberDiv");
      const pteStructureNumberDiv = document.getElementById("pteStructureNumberDiv");

      var municipalSelect = document.getElementById("municipalSelect");
      var barangaySelect = document.getElementById("barangaySelect");
      
      am5.ready(function() {
        // Default
        reloISFLayer.visible = false;



        // Expropriation List----------------------------------
     
        view.when(function() {
            var expropriationList = document.getElementById("expropriationListDiv");
            
            // Obtain a list of Owner's names and status
            view.whenLayerView(lotLayer).then(function(exprolayerView) {
                exprolayerView.watch("updating", function(val) {
                    if (!val) {
                        // Query for only Expropriation lots
                        var query = new Query();
                        query.outFields = ["*"];
                        query.where = "StatusLA = 5";
                        exprolayerView.queryFeatures(query).then(function(result) {
                            expropriationList.innerHTML = "";
                            result.features.forEach(function(feature) {
                                var attributes = feature.attributes;
                                
                                var li = document.createElement("li");
                                li.setAttribute("class", "panel-result");
                                
                                const status = attributes.StatusLA;
                                if (status == 5) {
                                    statusla = "Expropriation"
                                }
                                
                                // Add Expropriation lots to list
                                li.innerHTML = "Lot ID: " + "<b>" + attributes.LotID + "</b>" + "<br>" + attributes.LandOwner;

                                li.addEventListener("click", function(event) {
                                    var target = event.target;
                                    var objectId = feature.attributes.OBJECTID;
                                    var queryExtent = new Query({
                                        objectIds: [objectId]
                                    });
                                    
                                    // Query extent for selected expropriation lot in the list
                                    exprolayerView.queryExtent(queryExtent).then(function(result) {
                                        if (result.extent) {
                                            view.goTo({
                                                target: result.extent,
                                                speedFactor: 2,
                                                zoom: 17})
                                                .catch(function(error) {
                                                    if (error.name != "AbortError") {
                                                        console.error(error);
                                                    }
                                                }); // End of catch
                                            } // End of if (result.extent)
                                        }); // End of layerView.queryExtent
                                        
                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function() {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    expropriationList.appendChild(li);
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()

        // Thousand separators function
        function thousands_separators(num) {
          var num_parts = num.toString().split(".");
          num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return num_parts.join(".");
        }
        
        // 1. Total Number of Lots
        function totalNumberOfLots(){
          var totalLot = {
            onStatisticField: "CASE WHEN StatusLA >= 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalLot",
            statisticType: "sum"
          };
          var query = lotLayer.createQuery();
          query.outStatistics = [totalLot];
          query.returnGeometry = true;

          lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;
            const LOT_TOTAL = thousands_separators(stats.totalLot);

            lotNumberDiv.innerHTML = `<b>Number of Lots</b><br><br>${LOT_TOTAL}`;
          });
        }

        totalNumberOfLots();

        // Total number of handed-over lots
        function pteNumberLot(){
            var total_pte_lot = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_lot",
                statisticType: "sum"
            };

            var total_lot_N = {
                onStatisticField: "CASE WHEN StatusLA >= 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_lot_N",
                statisticType: "sum"
            };
            var query = lotLayer.createQuery();
            query.outStatistics = [total_pte_lot, total_lot_N];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function(response){
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_lot;
                const totalN = stats.total_lot_N;
                const percPTE = ((pte/totalN)*100).toFixed(0);

                const values = percPTE == "Infinity" ? "N/A" : percPTE + "% (" + pte + ")";
                pteLotNumberDiv.innerHTML = `<b>Number of PTE</b><br><br>${values}`;
            });
        }
        pteNumberLot();

        // Total number of structures
        function totalNumberOfStructures(){
          var totalStructure = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalStructure",
            statisticType: "count"
          };
          var query = structureLayer.createQuery();
          query.outStatistics = [totalStructure];
          query.returnGeometry = true;

          structureLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
            structureNumberDiv.innerHTML = `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;
          });
        }
        totalNumberOfStructures();

        // Total number of PTE for structure
        function pteNumberStructure() {
            var total_pte_structure = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_structure",
                statisticType: "sum"
            };

            var total_struc_N = {
                onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_struc_N",
                statisticType: "sum"
            };

            var query = structureLayer.createQuery();
            query.outStatistics = [total_pte_structure,total_struc_N];
            query.returnGeometry = true;

            structureLayer.queryFeatures(query).then(function(response) {
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_structure;
                const totalN = stats.total_struc_N;
                const percPTE = ((pte/totalN)*100).toFixed(0);

                const value = percPTE + "% (" + pte + ")";
                pteStructureNumberDiv.innerHTML = `<b>Number of PTE</b><br><br>${value}`;
            });
        }
        pteNumberStructure();


        // Dropdown List
        view.when(function() {
            return lotLayer.when(function() {
                var query = lotLayer.createQuery();
                return lotLayer.queryFeatures(query);
            });
        })
        .then(getValues)
        .then(getUniqueValues)
        .then(addToSelect)

        function queryForLotGeometries() {
            var lotQuery = lotLayer.createQuery();

            return lotLayer.queryFeatures(lotQuery).then(function(response) {
                lotGeometries = response.features.map(function(feature) {
                    return feature.geometry;
                });
                return lotGeometries;
            });
        }

    // 1. Get values and return to drop down list
    // 1.1. Municipality
    function getValues(response) {
        var features = response.features;
        var values = features.map(function(feature) {
            return feature.attributes.Municipality;
        });
        return values;
    }
    
    // Return an array of unique values in the 'Municipality' field of the lot Layer
    function getUniqueValues(values) {
        var uniqueValues = [];
    
        values.forEach(function(item, i) {
            if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
                uniqueValues.push(item);
            }
        });
        return uniqueValues;
    }
    
    // Add the unique values to the municipalility select element. this will allow the user
    // to filter lot layer by municipality.
    function addToSelect(values) {
        values.sort();
        values.unshift('None'); // Add 'None' to the array and place it to the beginning of the array
        values.forEach(function(value) {
            var option = document.createElement("option");
            option.text = value;
            municipalSelect.add(option);
        });
    }
    
    // 1.2. Barangay
    function barangayFilterList(municipalValue) {
        var barangayArray = [];

        function barangayQuery() {
            var query = lotLayer.createQuery();
            if (municipalValue === undefined || municipalValue === 'None') {
                query.where = "1=1";
            } else if (municipalValue !== 'None') {
                query.where = "Municipality = '" + municipalValue + "'";
            }
        
            return lotLayer.queryFeatures(query).then(function(response) {
                stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const barangay = attributes.Barangay;
                    barangayArray.push(barangay);
                });
                return barangayArray;
            });
        }

        function getUniqueValues2(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
                if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                    uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
        }

        function addToSelectQuery2(query2Values) {
            barangaySelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                barangaySelect.add(option);
            });
        }

        barangayQuery()
        .then(getUniqueValues2)
        .then(addToSelectQuery2)
    }
    barangayFilterList();


    // Set the definition expression on the lot layer
    // to reflect the selecction of the user
    // Only for Municipality
    function setMunicipalExpression(municipal) {
        const municipalityExpression = "Municipality = '" + municipal + "'";
        if (municipal == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            reloISFLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            relocationPtLayer.definitionExpression = null;

        } else {
            lotLayer.definitionExpression = municipalityExpression;
            structureLayer.definitionExpression = municipalityExpression;
            reloISFLayer.definitionExpression = municipalityExpression;
            pnrLayer.definitionExpression = municipalityExpression;
            relocationPtLayer.definitionExpression = municipalityExpression;
        }
        zoomToLayer(lotLayer);

        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }


 
    // for Municipcality + Barangay + Priority
    function setMunicipalBarangayPriorityExpression(municipal, barangay) {
        //var municipal = municipalSelect.options[municipalSelect.selectedIndex].value;
        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        const barangayExpression = "Barangay = '" + barangay + "'";
        const municipalityExpression = "Municipality = '" + municipal + "'";

        // all = 'None'
        if (municipal == 'None' && barangay == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            reloISFLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            relocationPtLayer.definitionExpression = null;

        } else if (municipal == 'None' && barangay !== 'None') {
            lotLayer.definitionExpression = barangayExpression;
            structureLayer.definitionExpression = barangayExpression;
            reloISFLayer.definitionExpression = barangayExpression;
            pnrLayer.definitionExpression = barangayExpression;
            relocationPtLayer.definitionExpression = barangayExpression;

        } else if (municipal !== 'None' && barangay == 'None') {
            lotLayer.definitionExpression = municipalityExpression;
            structureLayer.definitionExpression = municipalityExpression;
            reloISFLayer.definitionExpression = municipalityExpression;
            pnrLayer.definitionExpression = municipalityExpression;
            relocationPtLayer.definitionExpression = municipalityExpression;

        } else if (municipal !== 'None' && barangay !== 'None') {
            lotLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            structureLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            reloISFLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            pnrLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            relocationPtLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;

        }

        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }

    // When CP is changed, Type is reset to 'None'
    const changeSelected = (e) => {
        const $select = document.querySelector('#barangaySelect');
        $select.value = 'None'
    };


    // Dropdown List
    // Select Municipality from dropdown list
    municipalSelect.addEventListener("change", function() {
        var municipal = event.target.value;
        var barangay = barangaySelect.value;

        setMunicipalExpression(municipal);
        changeSelected();

        barangayFilterList(municipal);

        totalNumberOfLots();
        pteNumberLot();
        totalNumberOfStructures();
        pteNumberStructure();
        updateChartLot(municipal, barangay);
        updateMoaChartLot(municipal, barangay);
        updateChartStructure(municipal, barangay);
        updateMoaChartStructure(municipal, barangay);
        updateChartISF(municipal, barangay);

        zoomToLayer(lotLayer);
    });

        barangaySelect.addEventListener("change", function() {
            var municipal = municipalSelect.value;
            var barangay = event.target.value;

            setMunicipalBarangayPriorityExpression(municipal, barangay);

            //barangayFilterList(municipal);

            totalNumberOfLots();
            pteNumberLot();
            totalNumberOfStructures();
            pteNumberStructure();
            updateChartLot(municipal, barangay);
            updateMoaChartLot(municipal, barangay);
            updateChartStructure(municipal, barangay);
            updateMoaChartStructure(municipal, barangay);
            updateChartISF(municipal, barangay);

            zoomToLayer(lotLayer);
        //relocationObjectID(reloStatusLayer);
    });

    // Charts for Lot and Structure
    // Lot Chart
    const LEGEND_FONT_SIZE = "0.9em";
    var root = am5.Root.new("pieChartLotDiv");

    const statusLot = ["Handed-Over", "Paid", "For Payment Processing",
                       "For Legal Pass", "For Appraisal/Offer to Buy",
                       "For Expro"];

    function updateChartLot(municipal, barangay) {
        root.container.children.clear();
        // First, define statuses
        var total_handedover_lot = {
            onStatisticField: "CASE WHEN StatusLA = 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_handedover_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusLA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusLA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusLA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otb_lot = {
            onStatisticField: "CASE WHEN StatusLA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otb_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN StatusLA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_handedover_lot, total_paid_lot, total_payp_lot,
                                total_legalpass_lot, total_otb_lot, total_expro_lot];
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const handedover = stats.total_handedover_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otb = stats.total_otb_lot;
            const expro = stats.total_expro_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusLot[0]) {
            selectedStatus = 0;
          } else if (SELECTED == statusLot[1]) {
            selectedStatus = 1;
          } else if (SELECTED == statusLot[2]) {
            selectedStatus = 2;
          } else if (SELECTED == statusLot[3]) {
            selectedStatus = 3;
          } else if (SELECTED == statusLot[4]) {
            selectedStatus = 4;
          } else if (SELECTED == statusLot[5]) {
            selectedStatus = 5;
          } else {
            selectedStatus = null;
          }

          var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusLA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = "1=1";

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 
          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              //chartLayerView = layerView;

              lotLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusLA = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusLot[0],
              value: handedover,
              sliceSettings: {
                fill: am5.color("#00c5ff")
              }
            },
            {
              category: statusLot[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70ad47")
              }
            },
            {
              category: statusLot[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070ff")
              }
            },
            {
              category: statusLot[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#ffff00")
              }
            },
            {
              category: statusLot[4],
              value: otb,
              sliceSettings: {
                fill: am5.color("#ffaa00")
              }
            },
            {
              category: statusLot[5],
              value: expro,
              sliceSettings: {
                fill: am5.color("#ff0000")
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
        }); // End of queryFeatures
    } // End of updateChartLot()
    updateChartLot();

    /*
    am5.array.each(am5.registry.rootElements, function(root) {
        if (root) {
        if (root.dom.id == "pieChartLotDiv") {
            root.dispose();
        }
        }
    });
    */

    // ----------------- BAR CHART FOR MOA LOT ----------------- //
    var root2 = am5.Root.new("chartMoaLotDiv");
        var myTheme = am5.Theme.new(root2);

        myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });
        const statusMOA = ["For Negotiation",
                            "Expropriation",
                            "Donation",
                            "CA 141",
                            "No Need to Acquire"
                          ];

    function updateMoaChartLot(municipal, barangay) {
        root2.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_ca141_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ca141_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nego = stats.total_nego_lot;
            const expro = stats.total_expro_lot;
            const donate = stats.total_donate_lot;
            const ca141 = stats.total_ca141_lot;
            const noneed = stats.total_noneed_lot;

                              // Set themes
         // https://www.amcharts.com/docs/v5/concepts/themes/
        root2.setThemes([
          am5themes_Animated.new(root2),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root2.container.children.push(
          am5xy.XYChart.new(root2, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,

          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root2, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root2, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root2, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root2, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);

        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
          fontSize: 10
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root2, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root2, {
            locationY: 1,
            sprite: am5.Label.new(root2, {
              text: "{value}",
              fill: root2.interfaceColors.get("alternativeText"),
              centerY: 3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
           if (SELECTED == statusMOA[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusMOA[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusMOA[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusMOA[3]) {
            selectedStatus = 4;
          }  else if (SELECTED == statusMOA[4]) {
            selectedStatus = 5;
          }

          var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 
          
          view.whenLayerView(lotLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          lotLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
          where: "MoA = " + selectedStatus
          //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerView
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root2, {
          text: "Mode of Acquisition",
          fontSize: 14,
          fontWeight: "bold",
          textAlign: "center",
          fill: am5.color("#3ce00a"),
          x: am5.percent(50),
          centerX: am5.percent(50),
          paddingTop: -10,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
            {
                category: statusMOA[0],
                value: nego
            },
            {
                category: statusMOA[1],
                value: expro
            },
            {
                category: statusMOA[2],
                value: donate
            },
            {
                category: statusMOA[3],
                value: ca141
            },
            {
                category: statusMOA[4],
                value: noneed
            },
        ]; // End of chart

        yAxis.data.setAll(data);
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);


        }); // End of queryFeatures
       
    } // End of updateMOAChartLot
    updateMoaChartLot();

    // ------------------ PIE CHART FOR STRUCTURE ----------------------//
    var root3 = am5.Root.new("pieChartStructureDiv");
    class MyTheme extends am5.Theme {
          setupDefaultRules() {
            var theme = this;

            const gap = 4;
            const rotation = 135;
            const strokeWidth = 1.1;
            const fillOpacity = 0;
            const width = 10;
            const height = 10;


            this.patterns = [
              am5.LinePattern.new(this._root, {
                color: am5.color("#00C5FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#70AD47"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#0070FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FFFF00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height

              }),
              am5.LinePattern.new(this._root, {
                color: am5.color("#FFAA00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FF0000"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              })
            ];

            this.currentPattern = 0;
            this.rule("Slice").setAll({
              fillOpacity: 1
            });

            this.rule("Slice").setup = function(target) {
              target.set("fillPattern", theme.patterns[theme.currentPattern]);
              theme.currentPattern++;
              if (theme.currentPattern == theme.patterns.length) {
                theme.currentPattern = 0;
              }
            };
          }
        }

        const statusStructure = ["Dismantling/Clearing", "Paid", "For Payment Processing",
                                 "For Legal Pass", "For Appraisal/Offer to Compensate",
                                "LBP Account Opening"];

    async function updateChartStructure(municipal, barangay) {
        root3.container.children.clear();

        var total_clear_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_clear_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = structureLayer.createQuery();
        query.outStatistics = [total_clear_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_clear_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root3.setThemes([
          am5themes_Animated.new(root3),
          am5themes_Responsive.new(root3),
          MyTheme.new(root3)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root3.container.children.push(
          am5percent.PieChart.new(root3, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root3.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root3, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(90), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          //fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          tooltipText: "{category}: {value}",
          tooltipY: am5.percent(10),
          //fill: am5.color("#1e8553")//root3.interfaceColors.get("alternativeText"),
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusStructure[0]) {
          selectedStatus = 1;
          } else if (SELECTED == statusStructure[1]) {
          selectedStatus = 2;
          } else if (SELECTED == statusStructure[2]) {
          selectedStatus = 3;
          } else if (SELECTED == statusStructure[3]) {
          selectedStatus = 4;
          } else if (SELECTED == statusStructure[4]) {
          selectedStatus = 5;
          } else if (SELECTED == statusStructure[5]) {
          selectedStatus = 6;
          } else {
          selectedStatus = null;
          }

          var query = structureLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusStruc = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 

          // Zoom, filter, and highlight selected chart categories 
          view.when(function() {
          view.whenLayerView(structureLayer).then(function (layerView) {

          structureLayer.queryFeatures(query).then(function(results) {
            const RESULT_LENGTH= results.features;
            const ROW_N = RESULT_LENGTH.length;

            let objID = [];
            for (var i=0; i < ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
            }
            
            var queryExt = new Query({
              objectIds: objID
            });
            
            structureLayer.queryExtent(queryExt).then(function(result) {
              if (result.extent) {
                view.goTo(result.extent)
              }
            });
            
            if (highlightSelect) {
              highlightSelect.remove();
            }
            highlightSelect = layerView.highlight(objID);
            
            view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
            });
          }); // End of queryFeatures

          layerView.filter = {
            where: "StatusStruc = " + selectedStatus
          }
          }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusStructure[0],
              value: clear,
            },
            {
              category:  statusStructure[1],
              value: paid,
            },
            {
              category:  statusStructure[2],
              value: payp,
            },
            {
              category:  statusStructure[3],
              value: legalpass,
            },
            {
              category:  statusStructure[4],
              value: otc,
            },
            {
              category:  statusStructure[5],
              value: lbp,
            }
          ]
        );

                // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root3, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root3.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff"),

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.boxStructure');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 1.1,
        });

        pieSeries.appear(1000, 100);

        });  // End of queryFeature       
    } // End of updateChartStructure()
    updateChartStructure();

    // ----------------- BAR CHART FOR MOA STRUCTURE ----------------- //
    var root4 = am5.Root.new("chartMoaStructureDiv");
    var myTheme = am5.Theme.new(root4);
    myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });

    const statusMoaStructure = ["For Negotiation",
                                "Expropriation",
                                "Donation",
                                "No Need to Acquire"
                                ];

    async function updateMoaChartStructure(municipal, barangay) {
        root4.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_noneed_lot];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
          var stats = response.features[0].attributes;

          const nego = stats.total_nego_lot;
          const expro = stats.total_expro_lot;
          const donate = stats.total_donate_lot;
          const noneed = stats.total_noneed_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root4.setThemes([
          am5themes_Animated.new(root4),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root4.container.children.push(
          am5xy.XYChart.new(root4, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,
          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root4, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root4, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root4, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root4, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);


        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root4, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root4, {
            locationY: 1,
            sprite: am5.Label.new(root4, {
              text: "{value}",
              fill: root4.interfaceColors.get("alternativeText"),
              centerY: 1.3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusMoaStructure[0]) {
                selectedStatus = 1;
            } else if (SELECTED == statusMoaStructure[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusMoaStructure[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusMoaStructure[3]) {
                selectedStatus = 4;
            } else {
                selectedStatus = null;
            }

          var query = structureLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;
          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }
          
          view.whenLayerView(structureLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          structureLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              structureLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
            where: "MoA = " + selectedStatus
            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerVie
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root4, {
          text: "Mode of Acquisition",
          fontSize: 14,
          fontWeight: "bold",
          textAlign: "center",
          fill: am5.color("#3ce00a"),
          x: am5.percent(50),
          centerX: am5.percent(50),
          paddingTop: -10,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
                {
                    category: statusMoaStructure[0],
                    value: nego
                },
                {
                    category: statusMoaStructure[1],
                    value: expro
                },
                {
                    category: statusMoaStructure[2],
                    value: donate
                },
                {
                    category: statusMoaStructure[3],
                    value: noneed
                }
      ];

        yAxis.data.setAll(data);
        series.data.setAll(data);


        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);

        }); // End of queryFeatures
    } // End of updateS_MOAChartStructure
    updateMoaChartStructure();

    // ISF Chart
    var root5 = am5.Root.new("pieChartIsfDiv");
    const statusISF = ["Relocated", "Paid", "For Payment Processing",
                      "For Legal Pass", "For Appraisal/OtC/Requirements for Other Entitlements",
                    "LBP Account Opening"]

    async function updateChartISF(municipal, barangay) {
        root5.container.children.clear();

        var total_relocated_lot = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_relocated_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusRC = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusRC = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusRC = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = reloISFLayer.createQuery();
        query.outStatistics = [total_relocated_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return reloISFLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_relocated_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root5.setThemes([
          am5themes_Animated.new(root5),
          am5themes_Responsive.new(root5)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root5.container.children.push(
          am5percent.PieChart.new(root5, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root5.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root5, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // To set slice color, you need to add this before data.setAll
        /*
        pieSeries.get("colors").set("colors", [
          am5.color("#70ad47"),
          am5.color("#0070FF"),
          am5.color("#FFFF00"),
          am5.color("#FFAA00"),
          am5.color("#FF0000"),
          am5.color("#00734C"),
        ]);
        */

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);


        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          if (SELECTED == statusISF[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusISF[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusISF[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusISF[3]) {
            selectedStatus = 4;
          } else if (SELECTED == statusISF[4]) {
            selectedStatus = 5;
          } else if (SELECTED == statusISF[5]) {
            selectedStatus = 6;
          } else {
            selectedStatus = null;
          }

          var query = reloISFLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusRC = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;
          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }

          view.when(function() {
            view.whenLayerView(reloISFLayer).then(function (layerView) {
              //chartLayerView = layerView;

              reloISFLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                reloISFLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusRC = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusISF[0],
              value: clear,
              sliceSettings: {
                fill: am5.color("#00C5FF")
              }
            },
            {
              category: statusISF[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70AD47")
              }
            },
            {
              category: statusISF[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070FF")
              }
            },
            {
              category: statusISF[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#FFFF00")
              }
            },
            {
            category: statusISF[4],
              value: otc,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
              category: statusISF[5],
            value: lbp,
            sliceSettings: {
                fill: am5.color("#FF0000")
              }
            }
          ]
        );


        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root5, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root5.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.boxIsf');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);

        });  // End of queryFeature                 
    } // End of updateChartISF()
    updateChartISF();

    // Handed-Over Area Bar chart
    function n01AffectedHandedOverArea(){
        var total_n01_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n01_affected",
            statisticType: "sum"
        };

        var total_n01_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n01_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n01_affected, total_n01_handedover];
        query.where = "CP = 'N-01'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n01_affected;
            const handedover = stats.total_n01_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray1 = [perc]
            return compileArray1
        });
    }

    function n02AffectedHandedOverArea(compileArray1){
        var total_n02_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n02_affected",
            statisticType: "sum"
        };

        var total_n02_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n02_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n02_affected, total_n02_handedover];
        query.where = "CP = 'N-02'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n02_affected;
            const handedover = stats.total_n02_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray2 = [compileArray1[0], perc]
            return compileArray2
        });
    }

    function n03AffectedHandedOverArea(compileArray2){
        var total_n03_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n03_affected",
            statisticType: "sum"
        };

        var total_n03_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n03_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n03_affected, total_n03_handedover];
        query.where = "CP = 'N-03'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n03_affected;
            const handedover = stats.total_n03_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray3 = [compileArray2[0], compileArray2[1], perc]; // handedover

            return compileArray3
        });
    }

    function n04AffectedHandedOverArea(compileArray3){
        var total_n04_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n04_affected",
            statisticType: "sum"
        };

        var total_n04_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n04_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n04_affected, total_n04_handedover];
        query.where = "CP = 'N-04'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n04_affected;
            const handedover = stats.total_n04_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray4 = [compileArray3[0], compileArray3[1], compileArray3[2], perc]; // handedover

            return compileArray4
        });
    }

    function n05AffectedHandedOverArea(compileArray4){
        var total_n05_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n05_affected",
            statisticType: "sum"
        };

        var total_n05_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n05_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n05_affected, total_n05_handedover];
        query.where = "CP = 'N-05'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n05_affected;
            const handedover = stats.total_n05_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray5 = [compileArray4[0], compileArray4[1], compileArray4[2], compileArray4[3], perc]; // handedover

            return compileArray5
        });
    }
    
    
    // Now use the above compiled values
    var root6 = am5.Root.new("pieChartLotDiv2");
    var myTheme = am5.Theme.new(root6);

    myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });

    function percentHandedOverLotByCPChart(compileArray5) {
        root6.container.children.clear();

        // N-01
        const n01_perc = compileArray5[0];
        const n01_other = 0;

        // N-02
        const n02_perc = compileArray5[1];
        const n02_other = 0;

        // N-03
        const n03_perc = compileArray5[2];
        const n03_other = 0;

        // N-04
        const n04_perc = compileArray5[3];
        const n04_other = 0;

        // N-05
        const n05_perc = compileArray5[4];
        const n05_other = 0;

        myTheme.rule("Grid", ["base"]).setAll({
        strokeOpacity: 0.1
        });

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root6.setThemes([
        am5themes_Animated.new(root6),
        myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root6.container.children.push(am5xy.XYChart.new(root6, {
        panX: false,
        panY: false,
        wheelX: "panY",
        wheelY: "zoomY",
        layout: root6.verticalLayout
        }));

        var data = [
            {
                category: "N-05",
                "value": n05_perc,
            },
            {
                category: "N-04",
                "value": n04_perc,
            },
            {
                category: "N-03",
                "value": n03_perc,
            },
            {
                category: "N-02",
                "value": n02_perc,
            },
            {
                category: "N-01",
                "value": n01_perc,
            }
        ];



        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root6, {
            strokeOpacity: 1,
            strokeWidth: 1,
            stroke: am5.color("#ffffff"),
        });

        var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root6, {
        categoryField: "category",
        renderer: yRenderer,
        tooltip: am5.Tooltip.new(root6, {})
        }));

        // Label properties Y axis
        yAxis.get("renderer").labels.template.setAll({
            //oversizedBehavior: "wrap",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            //maxWidth: 150,
            fontSize: 14
        });

        yRenderer.grid.template.setAll({
        location: 1
        })

        yAxis.data.setAll(data);

        // Set xaxis
        var xRenderer = am5xy.AxisRendererX.new(root6, {
            strokeOpacity: 1,
            strokeWidth: 1,
            stroke: am5.color("#ffffff"),
        });

        // Remove xaxis labels
        xRenderer.labels.template.set('visible', false);

        var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root6, {
        min: 0,
        max: 100,
        strictMinMax: true,
        calculateTotals: true,
        renderer: xRenderer
        }));

        // Chart title
        chart.children.unshift(am5.Label.new(root6, {
            text: "Handed-Over Area",
            fontSize: 15,
            fontWeight: "bold",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            x: am5.percent(50),
            centerX: am5.percent(50),
            paddingTop: -5,
            paddingBottom: 0,
        }));

        // Add series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        function makeSeries(name, fieldName) {
        var series = chart.series.push(am5xy.ColumnSeries.new(root6, {
            name: name,
            stacked: true,
            xAxis: xAxis,
            yAxis: yAxis,
            baseAxis: yAxis,
            valueXShow: "valueXTotalPercent",
            valueXField: fieldName,
            categoryYField: "category",
            fill: am5.color("#0070ff")
        }));

        series.columns.template.setAll({
            //tooltipText: "{name}, {categoryY}: {valueX}%",
            //tooltipY: am5.percent(90)
        });
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear();

        series.bullets.push(function() {
            return am5.Bullet.new(root6, {
            sprite: am5.Label.new(root6, {
                text: "{valueX}%",
                fill: am5.color("#ffffff"),//root6.interfaceColors.get("alternativeText"),
                centerY: am5.p50,
                centerX: am5.p50,
                populateText: true,
                fontSize: 17
            })
            });
        });
        }
        makeSeries("Value", "value");
        chart.appear(1000, 100);
    } // end of updateChart()  
    combinedAffectedHandedOverAreaChart();
        async function combinedAffectedHandedOverAreaChart() {
            n01AffectedHandedOverArea()
            .then(n02AffectedHandedOverArea)
            .then(n03AffectedHandedOverArea)
            .then(n04AffectedHandedOverArea)
            .then(n05AffectedHandedOverArea)
            .then(percentHandedOverLotByCPChart)
        }

      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "N2 LAND ACQUISITION";
        document.querySelector("#item-description").innerHTML = `
                                                                 1. You can <b>filter the data</b> by City and Barangy using dropdown lists.<br>
                                                                 2. <b>Click a tab</b> below the dropdown lists to view progress on land, structure, or ISF in charts.<br>
                                                                 3. <b>Click series in pie charts</b> to view progress on the corresponding lots/structures/ISF on the map.<br>
                                                                 4. <b>Lots under expropriation</b> are available in the 'Expro List' tab.<br>
                                                                 5. Click/unclick widgets icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                                 6. <b>Toggle a checkbox</b> above the Land pie chart to view <b>handed-over areas</b> (m2) of Contract Packages.`
                                                                 ;
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;
     
    // chart switch between land acquisition pie chart and handed-over area bar graph
    const pieChartLotDiv = document.getElementById("pieChartLotDiv");
    const pieChartLotDiv2 = document.getElementById("pieChartLotDiv2");
    const toggleChart = () => {
        pieChartLotDiv.hidden = !pieChartLotDiv.hidden;
        pieChartLotDiv2.hidden = !pieChartLotDiv2.hidden;

    };
    document.querySelector(".chartChange").addEventListener("calciteSwitchChange", toggleChart);

    // Switch between Occupancy (structure) and ISF point features
    document.querySelector("#thetabs").addEventListener("click", tabChange);
    function tabChange(event) {
        const value = event.target.className;
        
        if (value === 'ISF') {
            reloISFLayer.visible = true;
            relocationPtLayer.visible = false;
            updateChartISF();
        } else if (value === 'Land' || value === 'Structure' || value === 'ExproList' ){
            reloISFLayer.visible = false;
            relocationPtLayer.visible = true;
        }
    }
    }); // end of view.when

      });// End of am5

      
      // Widgets
      
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "Chainage" || item.title === "Pier Access Date" || item.title === "Free-and-Clear Area" ||
              item.title === "Occupancy (Structure)" || item.title === "NLO/LO (Structure)"){
            item.visible = false
          }
        }
      });
      
      const legend = new Legend({
        view,
        container: "legend-container"
      });

      const locate = new Locate({
        view: view,
        container: "locate-container"
      });

      var searchWidget = new Search({
        view: view,
        container: "search-container",
        locationEnabled: false,
        allPlaceholder: "LotID, StructureID, Chainage",
        includeDefaultSources: false,
        sources: [
            {
                layer: lotLayer,
                searchFields: ["LotID"],
                displayField: "LotID",
                exactMatch: false,
                outFields: ["LotID"],
                name: "Lot ID",
                placeholder: "example: 10083"
            },
            {
                layer: structureLayer,
                searchFields: ["StrucID"],
                displayField: "StrucID",
                exactMatch: false,
                outFields: ["StrucID"],
                name: "Structure ID",
                placeholder: "example: MCRP-01-02-ML022"
            },
            {
                layer: chainageLayer,
                searchFields: ["KmSpot"],
                displayField: "KmSpot",
                exactMatch: false,
                outFields: ["*"],
                name: "Main KM",
                placeholder: "example: 80+400"
            },
            {
                layer: PierNoLayer,
                searchFields: ["PIER"],
                displayField: "PIER",
                exactMatch: false,
                outFields: ["PIER"],
                name: "Pier No",
                zoomScale: 1000,
                placeholder: "example: P-288"
            }
        ]
        });

        view.ui.empty("top-left");

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",
            group: "top-right"
        });
        view.ui.add(searchExpand, {
            position: "top-right"
        });

        searchExpand.watch("expanded", function() {
            if(!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });


    });
  </script>
</html>