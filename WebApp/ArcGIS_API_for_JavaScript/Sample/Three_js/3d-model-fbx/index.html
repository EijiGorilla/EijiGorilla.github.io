<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Use three.js from an external renderer - 4.24</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/css/main.css">

    <script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.144.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://unpkg.com/three@0.144.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>


    <script src="https://js.arcgis.com/4.24/"></script>

    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #paneDiv {
            position: absolute;
            top: 18px;
            right: 18px;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
        }
    </style>

    <!-- Our application -->
    <script>
        require([
          "esri/core/Accessor",
          "esri/Map",
          "esri/views/SceneView",
          "esri/geometry/Point",
          "esri/geometry/Polyline",
          "esri/views/3d/externalRenderers",
          "esri/geometry/SpatialReference",
          "esri/rest/route",
          "esri/rest/support/RouteParameters",
          "esri/rest/support/FeatureSet",
          "esri/layers/GraphicsLayer",
          "esri/Graphic",
          "esri/symbols/SimpleMarkerSymbol",
          "esri/symbols/SimpleLineSymbol",
          "esri/Color",
          "esri/geometry/geometryEngine",
          "esri/core/urlUtils",
          "esri/layers/TileLayer",
          "esri/layers/VectorTileLayer",
          "dojo/on",
          "dojo/query",
          "dojo/domReady!"
        ],
        function (
        Accessor,
          Map,
          SceneView,
          Point,
          Polyline,
          externalRenderers,
          SpatialReference,
          route,
          RouteParameters,
          FeatureSet,
          GraphicsLayer,
          Graphic,
          SimpleMarkerSymbol,
          SimpleLineSymbol,
          Color,
          geometryEngine,
          urlUtils,
          TileLayer,
          VectorTileLayer,
          on,
          query
        ) {
            // The stops and route result will be stored in this layer
            var routeLyr = new GraphicsLayer();

            // Setup the route parameters
            var routeParams = new RouteParameters({
                stops: new FeatureSet(),
                outSpatialReference: { // autocasts as new SpatialReference()
                    wkid: 3857
                }
            });

            // Define the symbology used to display the stops
            var stopSymbol = new SimpleMarkerSymbol({
                style: "cross",
                size: 15,
                outline: { // autocasts as new SimpleLineSymbol()
                    width: 4
                }
            });

            // Define the symbology used to display the route
            var routeSymbol = new SimpleLineSymbol({
                color: [0, 0, 255, 0.5],
                width: 5
            });
            // Create a map
            //////////////////////////////////////////////////////////////////////////////////////

          
          var map = new Map({
    basemap: {
              baseLayers: [
                new TileLayer({
                  portalItem: {
                    id: "1b243539f4514b6ba35e7d995890db1d" // world hillshade
                  }
                }),
                new VectorTileLayer({
                  portalItem: {
                    id: "0a0d74b5fbc0431fa0f6c938d0b04505" // community style vector tiles
                  },
                  blendMode: "multiply"
                })
              ]
            },
            ground: "world-elevation",
            layers: [routeLyr],
            optimizePanAnimation: false
    
    }); 
    map.ground.surfaceColor = '#004C73';

            // Create a SceneView
            //////////////////////////////////////////////////////////////////////////////////////
            var view = new SceneView({
                container: "viewDiv",
                map: map,
                viewingMode: "local",
                camera: {
                    position: {
                        x: 120.98522,
                        y: 14.6029,
                        z: 10000,
                        spatialReference: SpatialReference.WGS84
                    },
                    heading: 0,
                    tilt: 35
                },
                environment: {
                    background: {
                        type: "color", // autocasts as new ColorBackground()
                        color: [0, 0, 0, 1]
                    }
                }
            });
            // Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
            //on(view, "click", addStop);
            view.on("click", function() {
                addStop();

            });

            function addStop(event) {

                // Add a point at the location of the map click
                //var stop = new Graphic({
                //    geometry: event.mapPoint,
                //    symbol: stopSymbol
                //});

                var stop1 = new Graphic({
                    geometry: new Point({x: 13454614.5302, y: 1875100.131099999, z: 1271.7033999999985, spatialReference: SpatialReference.WebMercator}),
                    symbol: stopSymbol
                });
                routeLyr.add(stop1);

                var stop2 = new Graphic({
                    geometry: new Point({x: 13456515.4102, y: 1874957.5956000015, z: 2312.0752000000066, spatialReference: SpatialReference.WebMercator }),
                    symbol: stopSymbol
                });
                routeLyr.add(stop2);

                routeParams.stops.features.push(stop1);
                routeParams.stops.features.push(stop2);

                // Execute the route task if 2 or more stops are input
                //routeParams.stops.features.push(stop);
                if (routeParams.stops.features.length >= 2) {
                    //routeTask.solve(routeParams).then(showRoute);
                    showRoute();
                }
            }

            // Adds the solved route to the map as a graphic
            function showRoute(data) {
                
                //var routeResult = data.routeResults[0].route;

                var polyline = new Polyline([[13454609.733, 1875101.5406999998, 1271.4486000000034],
[13454614.5302, 1875100.131099999, 1271.7033999999985],
[13454619.330200002, 1875098.7313, 1272.3193000000028],
[13454624.1369, 1875097.3542000018, 1273.7792999999947],
[13454628.943500001, 1875095.9770999998, 1275.2391999999963],
[13454633.750100002, 1875094.6000999995, 1276.699099999998],
[13454638.5519, 1875093.2062, 1278.6601999999984],
[13454643.3479, 1875091.7927, 1281.2053000000014],
[13454648.144000001, 1875090.3792999983, 1283.7504000000044],
[13454650.7694, 1875086.545400001, 1285.0687999999936],
[13454652.6871, 1875081.9277999997, 1286.017399999997],
[13454654.593600001, 1875077.3055000007, 1287.0035999999964],
[13454656.572299998, 1875074.7432999983, 1287.9832000000024],
[13454658.868500002, 1875079.1843000017, 1289.9159999999974],
[13454661.223299999, 1875083.5951000005, 1291.5129000000015],
[13454663.6074, 1875087.9899999984, 1293.0440999999992],
[13454666.007199999, 1875092.3764000013, 1294.3744000000006],
[13454668.375999998, 1875096.7793999985, 1295.4642000000022],
[13454672.358399998, 1875098.811900001, 1297.3255999999965],
[13454677.3173, 1875099.4516999982, 1300.0289000000048],
[13454678.1646, 1875095.4505000003, 1301.5565999999963],
[13454678.1624, 1875090.4505000003, 1302.1812999999966],
[13454678.1602, 1875085.4505000003, 1302.8061000000016],
[13454678.158, 1875080.4505000003, 1303.430800000002],
[13454681.1622, 1875076.683699999, 1305.904800000004],
[13454684.656100001, 1875073.1072999984, 1308.681500000006],
[13454688.103799999, 1875069.4860999994, 1311.4328999999998],
[13454692.544599999, 1875067.2062, 1315.366399999999],
[13454697.014600001, 1875064.9659999982, 1319.3347000000067],
[13454701.5405, 1875062.8410999998, 1323.6487000000052],
[13454706.0704, 1875060.7243999988, 1327.9873999999982],
[13454710.6003, 1875058.6077999994, 1332.3261999999959],
[13454715.106800001, 1875056.442400001, 1336.2966000000015],
[13454719.878899999, 1875055.4472999983, 1340.1402999999991],
[13454724.878899999, 1875055.4221, 1344.1107000000047],
[13454729.878800001, 1875055.3968999982, 1348.0812000000005],
[13454734.8787, 1875055.3717, 1352.0516999999963],
[13454739.864300001, 1875055.5348000005, 1355.878899999996],
[13454744.8024, 1875056.3192999996, 1359.2333000000071],
[13454749.740400001, 1875057.1039000005, 1362.587599999999],
[13454754.6785, 1875057.8883999996, 1365.9419999999955],
[13454759.6166, 1875058.6728999987, 1369.2964000000065],
[13454763.6607, 1875061.4257000014, 1372.2746000000043],
[13454767.5026, 1875064.6257000007, 1375.1745999999985],
[13454771.383000001, 1875067.7787999995, 1378.2272999999986],
[13454776.260699999, 1875067.6711999997, 1380.6735000000044],
[13454781.239, 1875067.2051, 1383.0099000000046],
[13454785.465, 1875069.2457999997, 1385.899900000004],
[13454789.563299999, 1875071.8830999993, 1389.1184999999969],
[13454794.4877, 1875072.7492000014, 1392.1726999999955],
[13454799.431499999, 1875073.4899999984, 1395.1836999999941],
[13454801.881000001, 1875074.9998000003, 1397.139200000005],
[13454798.430799998, 1875078.6165999994, 1396.4853000000003],
[13454800.601, 1875079.2967000008, 1397.8588000000018],
[13454803.9575, 1875080.2595000006, 1399.9602000000014],
[13454803.9542, 1875085.2595000006, 1401.3583000000071],
[13454803.715, 1875090.2501999997, 1402.6181999999972],
[13454803.324499998, 1875095.2349000014, 1403.7893999999942],
[13454803.5781, 1875099.3200999983, 1404.4088000000047],
[13454808.200399999, 1875097.4136000015, 1406.822199999995],
[13454812.804299999, 1875095.4633000009, 1408.474900000001],
[13454817.404399998, 1875093.5040999986, 1410.0007999999943],
[13454822.0007, 1875091.5357000008, 1411.4569999999949],
[13454826.737, 1875090.1031999998, 1413.0485000000044],
[13454831.708500002, 1875089.5702, 1414.8668999999936],
[13454836.676600002, 1875089.006099999, 1416.6138999999966],
[13454841.643800002, 1875088.434799999, 1418.3445000000065],
[13454844.657900002, 1875089.420400001, 1419.608699999997],
[13454842.9934, 1875094.1352999993, 1419.7562999999936],
[13454841.2736, 1875098.8297999986, 1419.6370000000024],
[13454839.5055, 1875103.5067999996, 1419.285600000003],
[13454839.9419, 1875107.1393, 1419.629700000005],
[13454844.6811, 1875108.7331999987, 1421.3312000000005],
[13454849.420200001, 1875110.3271000013, 1423.032600000006],
[13454854.1593, 1875111.921, 1424.7341000000015],
[13454858.4606, 1875110.2060000002, 1426.2378000000026],
[13454862.6221, 1875107.4343999997, 1427.6782999999996],
[13454866.7806, 1875104.6581000015, 1429.2253999999957],
[13454870.3484, 1875101.1656999998, 1430.8083000000042],
[13454872.743700001, 1875102.4965000004, 1432.0032999999967],
[13454874.357299998, 1875107.2289999984, 1432.9287999999942],
[13454876.6635, 1875108.4670999981, 1434.0782000000036],
[13454879.9602, 1875104.7078999989, 1435.5475000000006],
[13454883.257, 1875100.9486999996, 1437.0169000000024],
[13454886.567699999, 1875097.2018, 1438.7228999999934],
[13454889.8972, 1875093.4717000015, 1440.7473000000027],
[13454893.8548, 1875094.7621, 1443.4582999999984],
[13454897.897300001, 1875097.7038000003, 1446.176999999996],
[13454901.8603, 1875100.5744000003, 1448.717399999994],
[13454904.413199998, 1875096.2752999999, 1450.5133999999962],
[13454906.7894, 1875091.8770000003, 1452.0099000000046],
[13454909.2714, 1875087.5377999991, 1453.525800000003],
[13454912.7911, 1875089.3753000014, 1456.159400000004],
[13454916.552099999, 1875092.4536999986, 1459.0418999999965],
[13454920.5997, 1875089.5212999992, 1461.7085999999981],
[13454924.731199998, 1875086.8414999992, 1464.3545000000013],
[13454929.730999999, 1875086.7912000008, 1467.626099999994],
[13454934.730700001, 1875086.7410000004, 1470.8977000000014],
[13454939.730500001, 1875086.6906999983, 1474.169299999994],
[13454944.7133, 1875086.3693000004, 1477.0062000000034],
[13454949.680100001, 1875085.7958000004, 1479.295100000003],
[13454954.160100002, 1875083.9739000015, 1481.199900000007],
[13454958.218600001, 1875081.0535000004, 1482.768299999996],
[13454962.2771, 1875078.133200001, 1484.3368000000046],
[13454966.8974, 1875078.7520000003, 1486.5895000000019],
[13454971.622900002, 1875080.3792000003, 1488.9600999999966],
[13454975.5922, 1875078.7208999991, 1490.7014000000054],
[13454979.2852, 1875075.3511000015, 1492.0856000000058],
[13454982.867600001, 1875073.6721, 1493.4661999999953],
[13454986.358600002, 1875077.2498999983, 1495.6486000000004],
[13454989.240400001, 1875078.2573999986, 1496.982600000003],
[13454990.8946, 1875073.5397999994, 1497.2372999999934],
[13454993.6336, 1875069.9389999993, 1498.0026999999973],
[13454998.426199999, 1875068.5139000006, 1500.1232000000018],
[13455003.188499998, 1875066.9910999984, 1502.1674000000057],
[13455004.7181, 1875071.6922000013, 1503.4057999999932],
[13455007.661600001, 1875075.3607, 1505.1377999999968],
[13455012.017299999, 1875077.5960999988, 1507.1698000000033],
[13455017.002799999, 1875077.9769000001, 1509.3432999999932],
[13455021.9769, 1875078.482999999, 1511.4195000000036],
[13455026.9245, 1875079.1576999985, 1513.4796999999962],
[13455031.8019, 1875080.2580000013, 1515.534599999999],
[13455036.6794, 1875081.3583000004, 1517.5896000000066],
[13455041.483199999, 1875082.7239999995, 1519.696100000001],
[13455046.2304, 1875084.2934999987, 1521.8421999999991],
[13455050.774099998, 1875082.6191000007, 1523.823199999999],
[13455055.2879, 1875080.4682999998, 1525.7799999999988],
[13455059.098000001, 1875079.7076000012, 1527.491599999994],
[13455060.2689, 1875084.5051999986, 1528.3203999999969],
[13455063.6523, 1875085.1842, 1530.110799999995],
[13455067.144699998, 1875081.6059999987, 1531.7007000000012],
[13455070.617400002, 1875078.0088, 1533.2041999999929],
[13455074.157900002, 1875078.2457000017, 1535.0323999999964],
[13455077.000999998, 1875077.2745999992, 1536.4563999999955],
[13455079.525400002, 1875072.9605999999, 1537.3378999999986],
[13455081.945500001, 1875068.5852999985, 1538.1322999999975],
[13455085.5838, 1875071.1413000003, 1540.6349999999948],
[13455089.350699998, 1875074.429200001, 1543.318100000004],
[13455093.168499999, 1875072.5383000001, 1545.304999999993],
[13455094.972800002, 1875074.9824, 1546.6970000000001],
[13455095.600900002, 1875079.9415999986, 1547.6154999999999],
[13455098.223700002, 1875084.0254000016, 1549.7344000000012],
[13455101.443799999, 1875087.8504999988, 1552.2176000000036],
[13455101.835099999, 1875092.4239000008, 1552.9060999999929],
[13455100.8482, 1875097.3242000006, 1552.626900000003],
[13455101.3013, 1875101.697900001, 1553.101999999999],
[13455104.9835, 1875105.0804000013, 1555.6912000000011],
[13455108.735100001, 1875107.0111000016, 1558.287400000001],
[13455112.131700002, 1875103.3418999985, 1560.3799],
[13455115.5539, 1875099.696800001, 1562.6002000000008],
[13455119.016600002, 1875096.0898999982, 1565.0225999999966],
[13455121.846, 1875092.0438, 1566.827999999994],
[13455123.829999998, 1875087.4543000013, 1567.912400000001],
[13455125.8906, 1875083.605799999, 1569.127800000002],
[13455128.7707, 1875087.6928999983, 1571.7470999999932],
[13455131.6508, 1875091.7800999992, 1574.3662999999942],
[13455134.554200001, 1875095.8388999999, 1577.0038000000059],
[13455139.120299999, 1875097.8762000017, 1580.9397000000026],
[13455140.8371, 1875094.6372999996, 1582.4909999999945],
[13455142.734700002, 1875090.3242999986, 1583.8006000000023],
[13455146.599100001, 1875087.1513999999, 1586.9787999999971],
[13455150.463399999, 1875083.978599999, 1590.1570999999967],
[13455152.015299998, 1875087.3570999987, 1591.8292999999976],
[13455154.840599999, 1875086.9547000006, 1594.4005999999936],
[13455158.638799999, 1875083.7029, 1597.643200000006],
[13455161.862, 1875086.8015, 1600.8022999999957],
[13455165.276700001, 1875090.1246999986, 1604.1514000000025],
[13455170.2764, 1875090.0777000003, 1608.7100999999966],
[13455173.4764, 1875093.8542000018, 1611.7140999999974],
[13455176.6948, 1875097.680300001, 1614.2265999999945],
[13455178.533599999, 1875096.8552, 1615.993300000002],
[13455179.579300001, 1875093.1044999994, 1617.0320000000065],
[13455182.687800001, 1875097.0205999985, 1619.5761000000057],
[13455184.8953, 1875097.2602000013, 1621.4406000000017],
[13455185.6173, 1875092.3134999983, 1622.3089999999938],
[13455188.0946, 1875088.0766000003, 1624.4728000000032],
[13455191.0051, 1875084.011, 1627.0215000000026],
[13455193.868299998, 1875079.9118999988, 1629.263300000006],
[13455196.7247, 1875075.8082000017, 1631.3285000000033],
[13455199.3486, 1875071.5582000017, 1632.772100000002],
[13455201.7925, 1875067.1961999983, 1634.159599999999],
[13455204.2361, 1875062.8339999989, 1635.7866000000067],
[13455206.353100002, 1875061.8707000017, 1637.538400000005],
[13455207.9212, 1875066.6184, 1639.3785999999964],
[13455209.9327, 1875069.9323000014, 1641.385699999999],
[13455213.956999999, 1875066.9657000005, 1643.6013999999996],
[13455217.3059, 1875065.8533999994, 1645.4994000000006],
[13455218.5434, 1875070.6977999993, 1646.4836000000068],
[13455220.706500001, 1875072.7899000011, 1647.8641999999963],
[13455224.6197, 1875069.6774999984, 1649.994399999996],
[13455228.6413, 1875067.1964000016, 1652.2195999999967],
[13455233.488499999, 1875068.4151000008, 1654.4980000000069],
[13455236.8396, 1875070.6427000016, 1656.1052999999956],
[13455236.2753, 1875075.6108000018, 1656.1373000000021],
[13455235.657900002, 1875080.5725000016, 1656.0801000000065],
[13455235.0363, 1875085.5335999988, 1655.9850000000006],
[13455237.144000001, 1875088.9633999988, 1657.1897999999928],
[13455241.6899, 1875091.0414000005, 1659.596399999995],
[13455246.159000002, 1875093.2835999988, 1662.0277999999962],
[13455250.6989, 1875095.3739, 1664.304099999994],
[13455255.2097, 1875097.5300000012, 1666.3652000000002],
[13455259.7322, 1875099.6623999998, 1668.4263999999966],
[13455264.2603, 1875101.7826999985, 1670.5023999999976],
[13455268.9032, 1875103.5872000009, 1672.4857000000047],
[13455273.746, 1875104.8310999982, 1674.246100000004],
[13455278.588799998, 1875106.0749000013, 1676.0065000000031],
[13455283.452, 1875107.234000001, 1677.7695999999996],
[13455288.3173, 1875108.3849, 1679.4891000000061],
[13455293.164, 1875109.613400001, 1681.148199999996],
[13455298.010699999, 1875110.8418999985, 1682.8073000000004],
[13455300.5154, 1875115.0793000013, 1684.0815000000002],
[13455304.3552, 1875117.711100001, 1685.3396000000066],
[13455309.149500001, 1875119.1306999996, 1686.9939000000013],
[13455313.9437, 1875120.5504, 1688.648199999996],
[13455318.7379, 1875121.9699999988, 1690.3025000000052],
[13455323.5321, 1875123.3896000013, 1691.9569000000047],
[13455328.440299999, 1875124.2688999996, 1693.8510999999999],
[13455333.3997, 1875124.9048999995, 1695.8533000000025],
[13455338.359000001, 1875125.5408999994, 1697.8555000000051],
[13455343.3184, 1875126.1768999994, 1699.8576999999932],
[13455348.3116, 1875126.2963999994, 1702.0158999999985],
[13455353.3116, 1875126.311900001, 1704.2054999999964],
[13455358.311500002, 1875126.3275000006, 1706.3950999999943],
[13455363.0174, 1875127.4886000007, 1708.617499999993],
[13455367.4067, 1875129.883299999, 1710.875199999995],
[13455372.3996, 1875129.8194000013, 1713.4478999999992],
[13455377.3988, 1875129.7298999988, 1716.0237999999954],
[13455382.378199998, 1875129.980799999, 1718.6659000000072],
[13455387.333299998, 1875130.6495999992, 1721.389200000005],
[13455392.310400002, 1875130.9604999982, 1724.1146000000008],
[13455397.3101, 1875130.9052999988, 1726.8421999999991],
[13455402.309799999, 1875130.9562, 1729.4544000000024],
[13455407.199900001, 1875130.109000001, 1731.6821000000054],
[13455412.028299998, 1875128.8101999983, 1733.909400000004],
[13455416.8779, 1875127.5949000008, 1736.1995000000024],
[13455421.725499999, 1875126.3713999987, 1738.3025000000052],
[13455426.5867, 1875125.2049999982, 1740.1068999999989],
[13455431.463, 1875124.0993999988, 1741.878899999996],
[13455436.322299998, 1875122.9417000003, 1743.6569000000018],
[13455440.8488, 1875120.8297999986, 1745.313599999994],
[13455445.235399999, 1875118.430300001, 1746.5417000000016],
[13455450.125999998, 1875118.080600001, 1747.5427999999956],
[13455455.1065, 1875117.7835999988, 1748.5623999999953],
[13455459.962299999, 1875116.6393, 1750.1440000000002],
[13455464.677099999, 1875115.2762999982, 1752.7146000000066],
[13455468.3669, 1875111.9023000002, 1754.635500000004],
[13455472.035500001, 1875108.5051000006, 1756.5390000000043],
[13455476.1919, 1875105.7619999982, 1758.7820999999967],
[13455480.542399999, 1875103.2978999987, 1761.6852000000072],
[13455484.8812, 1875100.8128999993, 1764.822199999995],
[13455489.210900001, 1875098.3121999986, 1767.9722000000038],
[13455493.535300002, 1875095.8026, 1771.1064999999944],
[13455498.1873, 1875094.1015999988, 1774.170499999993],
[13455503.046500001, 1875092.9232, 1777.4639000000025],
[13455507.9056, 1875091.7448000014, 1780.7572999999975],
[13455512.8125, 1875091.8244000003, 1784.279899999994],
[13455517.751600001, 1875092.6011999995, 1787.8781000000017],
[13455522.698600002, 1875093.327399999, 1791.3880999999965],
[13455527.474399999, 1875092.7703999989, 1794.516300000003],
[13455532.017700002, 1875090.6854000017, 1797.131699999998],
[13455535.529599998, 1875087.2291, 1798.617299999998],
[13455538.823800001, 1875083.4677999988, 1799.6725000000006],
[13455542.118099999, 1875079.7063999996, 1800.727700000003],
[13455546.627799999, 1875078.9481000006, 1803.347299999994],
[13455551.6109, 1875079.3592999987, 1806.5763000000006],
[13455556.471700002, 1875079.5905000009, 1809.695200000002],
[13455557.8658, 1875074.7892000005, 1809.5515000000014],
[13455560.4289, 1875071.3293999992, 1810.526899999997],
[13455565.3532, 1875070.4626999982, 1814.0939000000071],
[13455570.2775, 1875069.5960000008, 1817.6607999999978],
[13455573.585, 1875072.1437, 1821.0267000000022],
[13455576.0121, 1875076.5150000006, 1824.234500000006],
[13455578.2559, 1875078.4772999994, 1826.520399999994],
[13455580.111499999, 1875073.8343999982, 1826.557799999995],
[13455582.0482, 1875069.2250999995, 1826.6523000000016],
[13455586.895100001, 1875070.2553999983, 1830.6974000000046],
[13455591.774999999, 1875071.3438000008, 1834.7799999999988],
[13455596.7254, 1875071.993999999, 1838.4418000000005],
[13455601.719700001, 1875072.2325000018, 1841.9572999999946],
[13455606.714000002, 1875072.4710000008, 1845.4728000000032],
[13455611.7086, 1875072.7019000016, 1848.9235000000044],
[13455616.702799998, 1875072.7300000004, 1851.9927000000025],
[13455621.6888, 1875072.3572000004, 1854.9679000000033],
[13455626.6587, 1875071.809700001, 1857.9138999999996],
[13455631.6169, 1875071.1975000016, 1860.809699999998],
[13455636.366799999, 1875069.6904999986, 1863.1947999999975],
[13455640.9179, 1875067.6198999994, 1865.5375000000058],
[13455645.469, 1875065.5491999984, 1867.8803000000044],
[13455650.0198, 1875063.4778999984, 1870.2225999999937],
[13455654.543000001, 1875061.3469999991, 1872.5292000000045],
[13455659.0662, 1875059.2160999998, 1874.8358000000007],
[13455663.3983, 1875058.8376000002, 1877.020399999994],
[13455667.355999999, 1875061.893199999, 1878.9658000000054],
[13455671.841899998, 1875060.8011000007, 1881.2572999999975],
[13455676.4228, 1875058.7994000018, 1883.6184999999969],
[13455680.9905, 1875056.773600001, 1885.853099999993],
[13455685.6188, 1875054.8828999996, 1887.9784999999974],
[13455690.197299998, 1875052.8735000007, 1890.1046999999962],
[13455694.991700001, 1875051.7206000015, 1892.4511000000057],
[13455699.975499999, 1875051.3189999983, 1894.9906999999948],
[13455704.959399998, 1875050.9173000008, 1897.5301999999938],
[13455709.944699999, 1875050.5590000004, 1900.0571000000054],
[13455714.9443, 1875050.6215000004, 1902.460500000001],
[13455719.9439, 1875050.6838999987, 1904.8640000000014],
[13455724.943500001, 1875050.7463999987, 1907.267399999997],
[13455729.9065, 1875051.0606000014, 1909.653999999995],
[13455734.717099998, 1875052.423799999, 1911.9706000000006],
[13455738.7795, 1875055.0364000015, 1913.628899999996],
[13455742.9688, 1875055.763799999, 1915.5806000000011],
[13455747.7231, 1875054.2155999988, 1918.204700000002],
[13455752.465300001, 1875052.6306999996, 1921.015499999994],
[13455754.1908, 1875049.1645000018, 1922.837400000004],
[13455754.0284, 1875044.3279, 1924.1453000000038],
[13455756.853100002, 1875040.2021999992, 1927.0562999999966],
[13455759.6688, 1875036.0872999988, 1929.7353000000003],
[13455762.488499999, 1875031.9677000009, 1932.2780000000057],
[13455765.945300002, 1875028.3585, 1935.069199999998],
[13455769.460299999, 1875024.8029999994, 1937.779800000004],
[13455773.4056, 1875021.8830000013, 1940.6581000000006],
[13455777.955200002, 1875019.8090000004, 1943.7369000000035],
[13455782.521499999, 1875017.7745999992, 1946.5035000000062],
[13455787.0335, 1875015.6622000001, 1948.7351999999955],
[13455790.6932, 1875012.2553999983, 1950.4753999999957],
[13455794.352899998, 1875008.8486000001, 1952.215599999996],
[13455798.043000001, 1875005.4747000001, 1953.9694000000018],
[13455801.824700002, 1875002.2063000016, 1955.818100000004],
[13455805.664099999, 1874999.003899999, 1957.6022999999986],
[13455809.4597, 1874995.7490999997, 1959.104600000006],
[13455813.2845, 1874992.5289999992, 1960.7458000000042],
[13455817.341200002, 1874989.6173, 1962.8144999999931],
[13455821.5134, 1874986.8618, 1965.0430000000051],
[13455825.569600001, 1874983.9398999996, 1966.954700000002],
[13455829.7683, 1874981.2291, 1969.037400000001],
[13455834.071600001, 1874978.6832999997, 1970.4477999999945],
[13455838.3356, 1874976.0724, 1971.843399999998],
[13455842.589899998, 1874973.4453999996, 1973.1585999999952],
[13455846.8488, 1874970.8260000013, 1974.2912999999971],
[13455851.0359, 1874968.0942000002, 1975.669200000004],
[13455855.1992, 1874965.3253999986, 1977.1282000000065],
[13455859.396899998, 1874962.6088000014, 1979.0314999999973],
[13455863.5797, 1874959.8696999997, 1981.2197000000015],
[13455867.741999999, 1874957.0991999991, 1983.7372000000032],
[13455871.904199999, 1874954.3286999986, 1986.2546000000002],
[13455876.1089, 1874951.6240999997, 1988.9694000000018],
[13455880.2628, 1874948.8440000005, 1991.7981],
[13455884.346, 1874945.9589999989, 1994.4737000000023],
[13455888.4707, 1874943.1328000017, 1997.244200000001],
[13455892.621, 1874940.3445999995, 1999.965200000006],
[13455896.614999998, 1874937.3630000018, 2002.649099999995],
[13455900.081, 1874933.7635999992, 2005.0427999999956],
[13455903.5772, 1874930.1917999983, 2007.278600000005],
[13455907.016800001, 1874926.563000001, 2009.4590000000026],
[13455905.6563, 1874921.8399999999, 2009.420100000003],
[13455907.363699999, 1874918.7683999985, 2010.2403999999951],
[13455912.1406, 1874917.2914000005, 2012.3469999999943],
[13455916.9175, 1874915.8145000003, 2014.4535999999935],
[13455921.7009, 1874914.3597000018, 2016.3637000000017],
[13455926.5929, 1874913.4321000017, 2018.323900000003],
[13455931.571600001, 1874912.9715000018, 2020.3417000000045],
[13455936.5504, 1874912.5108000003, 2022.3595999999961],
[13455941.5291, 1874912.0500999987, 2024.3775000000023],
[13455946.507800002, 1874911.5894000009, 2026.395399999994],
[13455950.997299999, 1874911.9717999995, 2028.1869000000006],
[13455953.067499999, 1874916.5230999999, 2028.8594000000012],
[13455956.673500001, 1874917.6574000008, 2030.494000000006],
[13455961.451499999, 1874916.1840000004, 2032.8626999999979],
[13455966.2548, 1874914.879999999, 2035.256699999998],
[13455971.2548, 1874914.8907999992, 2037.847299999994],
[13455976.2548, 1874914.9015999995, 2040.4377999999997],
[13455979.420400001, 1874914.1882999986, 2042.1331000000064],
[13455975.761, 1874910.7811000012, 2040.4974999999977],
[13455972.101599999, 1874907.3740000017, 2038.8617999999988],
[13455975.4014, 1874906.6955999993, 2040.8637000000017],
[13455980.4014, 1874906.6838999987, 2043.7541999999958],
[13455985.401299998, 1874906.6722000018, 2046.6447000000044],
[13455990.401299998, 1874906.6603999995, 2049.5351999999984],
[13455995.401299998, 1874906.6486999989, 2052.425700000007],
[13455996.16, 1874910.8715000004, 2052.176099999997],
[13455998.454999998, 1874910.4310999997, 2053.6754999999976],
[13456002.0651, 1874906.9726999998, 2056.4915000000037],
[13456005.7249, 1874903.5700999983, 2059.2494000000006],
[13456009.9014, 1874901.0960000008, 2062.1398999999947],
[13456014.674199998, 1874899.6059000008, 2065.360400000005],
[13456019.447, 1874898.115699999, 2068.580900000001],
[13456024.2198, 1874896.625500001, 2071.8013999999966],
[13456028.262600001, 1874893.7663999982, 2074.6120999999985],
[13456032.348000001, 1874890.9017999992, 2077.4223000000056],
[13456036.276299998, 1874887.8125, 2079.962799999994],
[13456039.9366, 1874889.3751999997, 2082.346399999995],
[13456043.542, 1874892.8394999988, 2084.722099999999],
[13456047.1474, 1874896.3037, 2087.097800000003],
[13456051.4943, 1874898.563099999, 2089.9734000000026],
[13456056.1043, 1874900.4990000017, 2092.2988999999943],
[13456060.600499999, 1874901.5859999992, 2094.5242],
[13456064.5376, 1874898.503899999, 2096.2580000000016],
[13456068.474800002, 1874895.4219000004, 2097.9916999999987],
[13456072.411899999, 1874892.3398000002, 2099.7255000000005],
[13456076.349, 1874889.2578000017, 2101.4593000000023],
[13456079.8493, 1874885.7153999992, 2103.160600000003],
[13456083.133299999, 1874881.9450999983, 2104.8459000000003],
[13456086.420400001, 1874878.1774999984, 2106.537599999996],
[13456089.798799999, 1874874.4915000014, 2108.425000000003],
[13456093.1772, 1874870.8055999987, 2110.3123999999953],
[13456096.250300001, 1874866.9629999995, 2112.063500000004],
[13456097.313900001, 1874862.078499999, 2112.9165000000066],
[13456098.614100002, 1874857.250500001, 2113.8641999999963],
[13456099.914299998, 1874852.4224999994, 2114.8119000000006],
[13456101.214499999, 1874847.5945000015, 2115.759699999995],
[13456103.987399999, 1874843.4437000006, 2118.1987999999983],
[13456106.8059, 1874839.3137999997, 2120.6840999999986],
[13456105.699499998, 1874834.492800001, 2121.6370000000024],
[13456101.8578, 1874831.7144999988, 2120.8399999999965],
[13456097.4844, 1874829.2963000014, 2119.7103999999963],
[13456093.210099999, 1874826.7019000016, 2118.6676000000007],
[13456088.935800001, 1874824.1075999998, 2117.6248999999953],
[13456086.614300001, 1874819.9497000016, 2117.8223],
[13456085.399999999, 1874815.1708000004, 2118.640499999994],
[13456085.9615, 1874810.202399999, 2120.204800000007],
[13456086.491999999, 1874805.2307000011, 2121.2195000000065],
[13456088.4529, 1874800.6673999988, 2122.5791000000027],
[13456090.627099998, 1874796.1647999994, 2124.002900000007],
[13456092.8013, 1874791.6623000018, 2125.426800000001],
[13456096.450800002, 1874788.4864999987, 2126.893599999996],
[13456099.5865, 1874784.5918999985, 2127.9005999999936],
[13456102.7221, 1874780.6972999983, 2128.907500000001],
[13456107.3484, 1874779.070700001, 2130.430500000002],
[13456112.1673, 1874777.7371999994, 2132.0200999999943],
[13456116.986200001, 1874776.4037999995, 2133.6098000000056],
[13456121.805100001, 1874775.0703000017, 2135.1993999999977],
[13456126.6164, 1874774.8993000016, 2137.0562999999966],
[13456131.4175, 1874776.295499999, 2139.2733000000007],
[13456135.6296, 1874778.2391999997, 2141.338300000003],
[13456136.6717, 1874783.1294, 2142.5850999999966],
[13456137.713799998, 1874788.0196000002, 2143.8319000000047],
[13456138.690299999, 1874792.737300001, 2144.718399999998],
[13456143.6411, 1874792.0388000011, 2147.3561999999947],
[13456146.3845, 1874788.6444000006, 2148.3910000000033],
[13456148.3387, 1874784.6081000008, 2148.4225000000006],
[13456153.3002, 1874785.2272999994, 2150.666100000002],
[13456158.2617, 1874785.8465000018, 2152.909700000004],
[13456160.190000001, 1874790.065200001, 2155.038499999995],
[13456161.877099998, 1874794.7709, 2156.862599999993],
[13456164.1714, 1874798.9741000012, 2158.998800000001],
[13456168.867400002, 1874800.6721, 2161.5967999999993],
[13456173.6063, 1874802.2666000016, 2164.214699999997],
[13456178.348299999, 1874803.8520999998, 2166.8378999999986],
[13456182.271499999, 1874806.9470999986, 2169.868199999997],
[13456186.872000001, 1874808.5987000018, 2172.0871000000043],
[13456191.764899999, 1874809.6279999986, 2173.9581000000035],
[13456196.6578, 1874810.6574000008, 2175.828999999998],
[13456201.550700001, 1874811.6867000014, 2177.699900000007],
[13456206.3129, 1874813.0172000006, 2179.605800000005],
[13456210.4065, 1874815.8880999982, 2181.690300000002],
[13456212.8284, 1874819.7578000017, 2183.811300000001],
[13456213.913400002, 1874824.2758000009, 2185.908599999995],
[13456218.789299998, 1874825.3830000013, 2187.517900000006],
[13456220.337499999, 1874830.0954999998, 2189.516499999998],
[13456221.693799999, 1874834.9079999998, 2190.9513000000006],
[13456225.0843, 1874837.4101000018, 2192.1101999999955],
[13456230.0299, 1874838.1460000016, 2193.0580000000045],
[13456234.9754, 1874838.8817999996, 2194.005799999999],
[13456239.934799999, 1874839.5045999996, 2194.872099999993],
[13456244.9122, 1874839.9789000005, 2195.631500000003],
[13456249.8897, 1874840.4532999992, 2196.3910000000033],
[13456254.8671, 1874840.9277000017, 2197.1503999999986],
[13456259.8446, 1874841.4019999988, 2197.9098999999987],
[13456260.838, 1874844.0108000003, 2198.7975000000006],
[13456258.4756, 1874848.4175000004, 2199.793000000005],
[13456257.115400001, 1874851.8801999986, 2200.6609000000026],
[13456261.655299999, 1874849.7851999998, 2200.7773000000016],
[13456266.1952, 1874847.690200001, 2200.8937000000005],
[13456270.735100001, 1874845.5951000005, 2201.0100999999995],
[13456275.5883, 1874845.0883000009, 2201.747399999993],
[13456280.583700001, 1874845.3026, 2202.766499999998],
[13456284.5839, 1874842.519200001, 2202.779800000004],
[13456288.4593, 1874839.3599000014, 2202.6670000000013],
[13456292.2551, 1874837.3412999995, 2203.0102999999945],
[13456295.653700002, 1874841.0086000003, 2205.627600000007],
[13456299.052299999, 1874844.675999999, 2208.2448000000004],
[13456303.7989, 1874845.2754999995, 2211.1977000000043],
[13456308.7989, 1874845.2985000014, 2214.213699999993],
[13456311.111699998, 1874841.3794, 2214.0332000000053],
[13456312.4155, 1874836.5854999982, 2212.9040999999997],
[13456313.440299999, 1874832.5395000018, 2211.9189999999944],
[13456317.0704, 1874835.9778999984, 2215.5139000000054],
[13456320.700399999, 1874839.4164000005, 2219.108800000002],
[13456324.2824, 1874842.8938000016, 2222.6919000000053],
[13456326.8985, 1874847.1548000015, 2226.039300000004],
[13456329.5145, 1874851.4158000015, 2229.3867000000027],
[13456332.130600002, 1874855.6768000014, 2232.7342000000062],
[13456334.7467, 1874859.9378000014, 2236.081600000005],
[13456336.5614, 1874864.5650000013, 2238.9719999999943],
[13456338.0704, 1874869.3317999989, 2241.6880999999994],
[13456339.883499999, 1874873.9853000008, 2244.3399000000063],
[13456341.865400001, 1874878.5757, 2246.9560000000056],
[13456345.237599999, 1874881.6330999993, 2249.5969999999943],
[13456349.9993, 1874883.1585000008, 2252.2629000000015],
[13456354.473499998, 1874885.2778000012, 2254.705400000006],
[13456358.624200001, 1874888.0654999986, 2256.8965999999928],
[13456362.774999999, 1874890.8531999998, 2259.087799999994],
[13456367.352699999, 1874891.4989, 2260.7642999999953],
[13456372.2551, 1874890.5157000013, 2262.0494999999937],
[13456377.1336, 1874889.8456000015, 2263.3552000000054],
[13456381.8303, 1874891.5606000014, 2264.8178000000044],
[13456386.526999999, 1874893.2754999995, 2266.2802999999985],
[13456389.186900001, 1874897.1314000003, 2267.893100000001],
[13456391.133699998, 1874901.7368, 2269.558499999999],
[13456391.888300002, 1874906.4142999984, 2270.7361999999994],
[13456390.5103, 1874911.2206000015, 2271.041200000007],
[13456391.5968, 1874915.9200999998, 2271.9958999999944],
[13456393.396200001, 1874920.582800001, 2273.1345],
[13456396.6967, 1874924.3387000002, 2274.087499999994],
[13456399.997200001, 1874928.0945000015, 2275.040399999998],
[13456403.2978, 1874931.8504000008, 2275.9934000000067],
[13456406.8726, 1874935.2897999994, 2276.975000000006],
[13456411.058600001, 1874938.0243999995, 2278.0204999999987],
[13456415.2445, 1874940.7589000016, 2279.066000000006],
[13456419.4305, 1874943.4935000017, 2280.111499999999],
[13456423.616500001, 1874946.2280000001, 2281.1570000000065],
[13456428.0792, 1874948.4688000008, 2282.212799999994],
[13456432.5964, 1874950.6121999994, 2283.2706999999937],
[13456437.219500002, 1874952.1385999992, 2284.467199999999],
[13456442.192699999, 1874951.6217, 2286.122900000002],
[13456447.1659, 1874951.104699999, 2287.778600000005],
[13456452.1391, 1874950.5877999999, 2289.4342999999935],
[13456457.112300001, 1874950.0709000006, 2291.0899999999965],
[13456461.985100001, 1874950.1752999984, 2292.7497000000003],
[13456466.5423, 1874952.2322999984, 2294.422000000006],
[13456471.099599998, 1874954.2892999984, 2296.094299999997],
[13456474.756299999, 1874953.4741000012, 2297.436499999996],
[13456478.047400001, 1874950.6037999988, 2298.6569000000018],
[13456483.0277, 1874951.0472000018, 2300.524900000004],
[13456487.7313, 1874952.3861999996, 2302.3141999999934],
[13456492.093899999, 1874954.829, 2304.006500000003],
[13456496.581, 1874956.8315999992, 2305.6986999999936],
[13456501.576900002, 1874957.0342999995, 2307.390599999999],
[13456506.5728, 1874957.2369999997, 2309.0823999999993],
[13456511.5687, 1874957.4397, 2310.7743000000046],
[13456515.4102, 1874957.5956000015, 2312.0752000000066]]);
                polyline.spatialReference = SpatialReference.WebMercator;

                var routeResult = new Graphic({
                    geometry: polyline,
                    symbol: routeSymbol
                });
                routeResult.symbol = routeSymbol;

                routeLyr.add(routeResult);
              
              // the speed of the object becomes low with maximum segment of length
              var pl = geometryEngine.densify(routeResult.geometry, 0.1, "meters");
     console.log(pl.paths[0]);
                // register the external renderer
                const myExternalRenderer = new skeletonRenderer(view, pl);
                externalRenderers.add(view, myExternalRenderer);

            }
            // Disable lighting based on the current camera position.
            // We want to display the lighting according to the current time of day.
            view.environment.lighting.cameraTrackingEnabled = false;

            // Create our custom external renderer
            //////////////////////////////////////////////////////////////////////////////////////
            //https://github.nicogis.it/externalRendererSkeleton/
            var skeletonRenderer = Accessor.createSubclass({ // if '|| {}' is not added beside null,
            // you will receive the following error 'Cannot destructure property of xx of 'null' as it is null'
                view: null,
                //pl: null,
                renderer: null,     // three.js renderer
                camera: null,       // three.js camera
                scene: null,        // three.js scene
                vertexIdx: 0,
                ambient: null,      // three.js ambient light source
                sun: null,          // three.js sun light source
                mixer: null,
                clock: null,
                clips: null,
                animate: null,
                light: null,
                iss: null,                                                    // ISS model
                issScale: 2,                                     // scale for the iss model
                path: null,
              count: null,
              up: null,
              timeDelta: null,

                cameraPositionInitialized: false, // we focus the view on the ISS once we receive our first data point
                positionHistory: [],
              
                constructor: function (view, pl) {
                  this.view = view;
                    this.path = pl.paths[0]; //pl.paths[0];
                },
                /**
                 * Setup function, called once by the ArcGIS JS API.
                 */
                setup: function (context) {

                    // initialize the three.js renderer
                    //////////////////////////////////////////////////////////////////////////////////////
                    this.renderer = new THREE.WebGLRenderer({
                        context: context.gl,
                        premultipliedAlpha: false
                    });
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    this.renderer.setSize(context.camera.fullWidth, context.camera.fullHeight);
                    this.renderer.setViewport(0, 0, view.width, view.height);

                    // prevent three.js from clearing the buffers provided by the ArcGIS JS API.
                    this.renderer.autoClearDepth = false;
                    this.renderer.autoClearStencil = false;
                    this.renderer.autoClearColor = false;

                    // The ArcGIS JS API renders to custom offscreen buffers, and not to the default framebuffers.
                    // We have to inject this bit of code into the three.js runtime in order for it to bind those
                    // buffers instead of the default ones.
                    var originalSetRenderTarget = this.renderer.setRenderTarget.bind(this.renderer);
                    this.renderer.setRenderTarget = function (target) {
                        originalSetRenderTarget(target);
                        if (target == null) {
                            context.bindRenderTarget();
                        }
                    }

                    // setup the three.js scene
                    //////////////////////////////////////////////////////////////////////////////////////         
                    this.scene = new THREE.Scene();

                    // setup the camera
                    this.camera = new THREE.PerspectiveCamera();

                    // setup scene lighting
                    this.ambient = new THREE.AmbientLight(0xffffff, 0.5);
                    this.scene.add(this.ambient);
                    this.sun = new THREE.DirectionalLight(0xffffff, 0.5);
                    this.scene.add(this.sun);

                    this.clock = new THREE.Clock();

                    var issMeshUrl = "https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Running.fbx"; 
                        
                        //"https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/externalRendererSkeleton/models/train_locomotive.glb"
                   //     "https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Truck.gltf";
                    //"https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Wraith_Animated.glb";
                    // "https://EijiGorilla.github.io/glTF/canoe.glb"

                    var loaderGLTF = new THREE.FBXLoader(); // check this: https://qgenhate.hatenablog.com/ [object not an instance of THREE.Object3D]
                    let example = new THREE.Object3D();
      
                    loaderGLTF.load(issMeshUrl,
                    function(gltf) {
                        console.log("ISS mesh loaded.");
                       
                        //example = gltf.scene;
                        this.iss = gltf.scene;
                        
                        // apply ISS material to all nodes in the geometry
                        //this.iss.traverse( function ( child ) {
                        //  if ( child instanceof THREE.Mesh ) {
                        //    child.material = this.issMaterial;
                        //  }
                        //}.bind(this));
                       
                        // set the specified scale for the model
                        this.iss.scale.set(this.issScale, this.issScale, this.issScale);
                        
                        // add the model
                        this.scene.add(this.iss); // original: this.iss
                        console.log("ISS mesh added.");

                        // Mixer for animation
                        this.mixer = new THREE.AnimationMixer(this.iss);
                        this.mixer.clipAction(gltf.animations[0]).play();

                       //this.iss.update(stepSize);
                        //this.clips = this.iss.animations;
                        // update animated object
                        // requestAnimationFrame();
                    
                    }.bind(this), undefined, function(error) {
                        console.error("Error loading ISS mesh. ", error);
                    });

                    this.light = new THREE.DirectionalLight(0xffffff, 1);
                    this.light.position.set(2,2,5);
                    this.scene.add(this.light);
                  
                  // rotation 
                      this.up = new THREE.Vector3(0, 0, 1); // used with lookAt: look at the next point at x-axis
                      this.axis = new THREE.Vector3();
                      this.n  = new THREE.Vector3( ); // normal,
                      this.b  = new THREE.Vector3( ); // binormal
                      this.M3 = new THREE.Matrix3( );
                      this.M4 = new THREE.Matrix4( );
                      this.pp = new THREE.Vector3( );
                      this.quaternion = new THREE.Quaternion();

                    // cleanup after ourselfs
                    context.resetWebGLState();
                },
                render: function (context) {

                    // update camera parameters
                    ///////////////////////////////////////////////////////////////////////////////////
                    var cam = context.camera;

                    this.camera.position.set(cam.eye[0], cam.eye[1], cam.eye[2]);
                    this.camera.up.set(cam.up[0], cam.up[1], cam.up[2]);
                    this.camera.lookAt(new THREE.Vector3(cam.center[0], cam.center[1], cam.center[2]));

                    // Projection matrix can be copied directly
                    this.camera.projectionMatrix.fromArray(cam.projectionMatrix);
                  

                    if (this.iss) {
                             
                        // Add this.mixer.update first; otherwise, the object will not be animated.s
                        if (this.mixer) {
                            var scale = 0.0001; //this.gui.getTimeScale();
                            var delta = this.clock.getDelta();

                          this.mixer.update(delta);         
                        }
   
                            if (this.path.length == (this.vertexIdx + 1))
                        {
                            this.vertexIdx = 0;
                        }
                      
                        var p = this.path[this.vertexIdx]; // vertexIdx = 0
                      var p1 = this.path[this.vertexIdx + 1];
                      
                    
                      // Define Z:
                      // It is important that the same Z values are set for both current (pt) and next points (pt1)
                      // Otherwise, the object will be tilted.
                      const changeZ = 0;
                      const offsetZ = 2;

                        var pt = new Point({
                            x: p[0], // longitude
                            y: p[1], // latitude
                            z: p[2] + offsetZ
                        });

                        pt.spatialReference = SpatialReference.WebMercator;

                        //z = offsetZ; // view.basemapTerrain.getElevation(p);

                        pos = [pt.x, pt.y, pt.z];

                        this.vertexIdx++;

                        if (this.path.length == (this.vertexIdx)) {
                            this.vertexIdx--;
                        }
                      
   
                        var transform = new THREE.Matrix4();
                        transform.fromArray(externalRenderers.renderCoordinateTransformAt(view, pos, SpatialReference.WebMercator, new Array(16)));

                       this.iss.position.set(transform.elements[12], transform.elements[13], transform.elements[14]);
                      
                      this.count ++;
                        if (this.count === 1) {
                          console.log(transform.elements[12], transform.elements[13], transform.elements[14]);
                        }

                        var p0;
                        var p1;

                        if ((this.path.length - 1) == (this.vertexIdx))
                        {
                            p0 = this.path[--this.vertexIdx];
                            p1 = this.path[this.vertexIdx];
                        }
                        else
                        {
                            p0 = this.path[this.vertexIdx];
                            p1 = this.path[++this.vertexIdx];
                        }
                      
                     // Option 1: use lookAt 
                      
                      var rotation = new THREE.Matrix4();
                      
                        var pt1 = new Point({
                            x: p1[0], // longitude
                            y: p1[1], // latitude
                            z: p1[2] + offsetZ
                        });
                      posR = [pt1.x, pt1.y, pt1.z];
                      rotation.fromArray(externalRenderers.renderCoordinateTransformAt(view, posR, SpatialReference.WebMercator, new Array(16)));
                      // https://answers.unity.com/questions/36255/lookat-to-only-rotate-on-y-axis-how.html
                      // how to use '.up' with lookAt?
                      //geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( Math.PI / 2 ) );
                      this.iss.up = this.up;
                      
                      this.iss.lookAt(rotation.elements[12], rotation.elements[13], rotation.elements[14]);
              
                      // transformation matrix for rotation
                      /*
                        var rotation = new THREE.Matrix4();
                        var m1 = new THREE.Matrix4(); // transformation matrix for x axis
                        var m2 = new THREE.Matrix4(); // transformation matrix for y axis
                        var m3 = new THREE.Matrix4(); // transformation matrix for z axis
                     
                      // 
                      // https://stackoverflow.com/questions/11179327/orient-objects-rotation-to-a-spline-point-tangent-in-three-js
                      // tangent = spline.getTangent(t).normalize();
                      // axis.crossVectors(up, tangent).normalize();
                      // radians = Math.acos(up.dot(tangent));
                      // marker.quaternion.setFromAxisAngle(axis, radians);
                      // keyword: motion along curve (https://hofk.de/main/discourse.threejs/2021/MotionAlongCurve/MotionAlongCurve.html)
                      // https://hofk.de/main/discourse.threejs/2021/MovementOnCurve/MovementOnCurve.html
                   //https://observablehq.com/@rveciana/three-js-object-moving-object-along-path
                  // https://stackoverflow.com/questions/13757483/three-js-lookat-seems-to-be-flipped
                  
                      //console.log(newHeading);                     
                        m1.makeRotationX(THREE.MathUtils.degToRad(90)); // 90
                        m2.makeRotationY(THREE.MathUtils.degToRad(10)); // 10
                        m3.makeRotationZ(THREE.MathUtils.degToRad(315)); // 315

                        rotation.multiplyMatrices(m1, m2);
                        rotation.multiply(m3);

                       this.iss.setRotationFromMatrix(rotation);
                    */

                        var scale = 0.1; //this.gui.getTimeScale();
                        var delta = this.clock.getDelta();
                        var stepSize = delta * scale;
                       //this.iss.update(stepSize);
                        
                    }

                    // update lighting
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                    view.environment.lighting.date = Date.now();

                    var l = context.sunLight;
                    this.sun.position.set(
                      l.direction[0],
                      l.direction[1],
                      l.direction[2]
                    );
                    this.sun.intensity = l.diffuse.intensity;
                    this.sun.color = new THREE.Color(l.diffuse.color[0], l.diffuse.color[1], l.diffuse.color[2]);

                    this.ambient.intensity = l.ambient.intensity;
                    this.ambient.color = new THREE.Color(l.ambient.color[0], l.ambient.color[1], l.ambient.color[2]);

                    // draw the scene
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                    this.renderer.resetState();
                    context.bindRenderTarget();
                    this.renderer.render(this.scene, this.camera);
                    externalRenderers.requestRender(view);

                    // cleanup
                    context.resetWebGLState();
                },
            })
            externalRenderers.add(view, skeletonRenderer);

            view.when(function() {
                // allow navigation above and below the ground
                map.ground.navigationConstraint = {
                    type: "none"
                };
                // the webscene has no basemap, so set a surfaceColor on the ground
                map.ground.surfaceColor = "#fff";
        
                // to see through the ground, set the ground opacity to 0.4
                map.ground.opacity = 0.9;
            });
        });
    </script>
</head>
<body>
    <div id="viewDiv"></div>
</body>
</html>