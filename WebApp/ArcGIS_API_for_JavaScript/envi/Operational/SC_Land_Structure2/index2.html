<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>SC Land Acquisition</title>
    
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.3/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.3/calcite.css" />

    <script src="https://js.arcgis.com/4.25/"></script>
    <link disabled id="arcgis-maps-sdk-theme-dark" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css" />
    <link id="arcgis-maps-sdk-theme-light" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tab {
        height: 83vh;
        width: 90%;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    
    #chartPanel {
        background-color: rgb(0, 0, 0, 0);
        padding: 10;
    }
    
    #pieChartLotDiv,
    #pieChartStructureDiv,
    #pieChartIsfDiv {
      width: 100%;
      height: 45%;
      align-items: center;
      padding: 1%;
    }

    
    #lotNumberDiv,
    #pteLotNumberDiv,
    #structureNumberDiv,
    #pteStructureNumberDiv {
      color: rgb(0, 197, 255);
      text-align: center;
      font-weight: normal;
      font-size: 1.5vw;
      border: solid 0.5px gray;
      padding-top: 1%;
      padding-bottom: 4%;
    }

    #lotNumberDiv b,
    #pteLotNumberDiv b,
    #structureNumberDiv b,
    #pteStructureNumberDiv b {
      font-size: 1.0vw;
      font-family: 'Calibri';
      font-weight: bold;
      color:rgb(250, 246, 246);
    }

    br {
      content: "";
      margin: 2em;
      display: block;
      font-size: 24%;
    }

    b {
        color: orange;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    /* Expropriation List */
    /** clear background color of list box **/
    .panel-side {
      background-color: rgb(0, 0, 0, 0);
      margin-top: 1%;
    }

    /** adjust line height between texts **/
    .panel-side li {
      padding: 1% 1%;
    }

    /** adjust lot ID's font size and color **/
    .panel-side li b{
      color: red;
      font-size: 0.8vw;
    }

    .panel-result {
      cursor: pointer;
      margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
      background-color: rgba(73, 72, 72, 0.5);
    }

    #expropriationListDiv {
      list-style: none;
      padding: 0.5%;
      padding-right: 5%;
      font-size: 0.8vw;
      width: 17vw;
    }

    /* MOA Chart */
    #chartMoaLotDiv,
    #chartMoaStructureDiv {
        width: 100%;
        height: 35%;
        align-items: center;
        padding: 1%;
    }

    /* Dropdown list */
    #dropdownDiv {
      background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: black;
        text-align: right;
        margin: auto;
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
    
    /*  */
    .sassy-theme .esri-legend__layer-caption {
      display: none;
    }

  </style>
  <body class="sassy-theme">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      
       <!--  Header slot  -->
      <div slot="header" id="header">
        
      <!-- Title -->
      <h2 id="header-title" slot="header"></h2>

      <div id="dateDiv">February 10, 2022</div>

      <!-- Dropdown Lists -->
      <div id="dropdownDiv" class="esri-widget">
        <label id="dropdownMunicipalLabel">
            City/Municipality:
            <select id="municipalSelect" class="esri-widget"></select>
        </label>
        <label id="dropdownBarangayLabel">
            Barangay:
            <select  style="width: 10vw" id="barangaySelect" class="esri-widget"></select>
        </label>
        <label id="dropdownHandOverDateLabel">
            Hand-Over Date:
            <select id="prioritySelect" class="esri-widget"></select>
        </label>
      </div>

      <!-- Controls -->
        <div id="header-controls">
          <!-- Dark Mode Switch -->
          <calcite-label layout="inline" class="label-wrapper">
            <calcite-icon icon="brightness" scale="s" class="switch-icon"></calcite-icon>
            <calcite-switch></calcite-switch>
            <calcite-icon icon="moon" scale="s" class="switch-icon"></calcite-icon>
          </calcite-label>
        </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
          <calcite-action data-action-id="locate" icon="gps-on-f" text="My Location"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>
        <calcite-panel heading="Click the icon below" width-scale="w" data-panel-id="locate" hidden>
          <div id="locate-container"></div>
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="viewDiv">
        <!-- Chart Panel -->
        <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
        <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
        <calcite-tabs>
            <div id="chartPanel">
                <calcite-tab-nav slot="tab-nav" id="thetabs">
                    <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                    <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                    <calcite-tab-title class="ISF">ISF</calcite-tab-title>
                    <calcite-tab-title class="ExproList">Expro List</calcite-tab-title>
                </calcite-tab-nav>
                <calcite-tab>
                    <calcite-switch class="chartChange"></calcite-switch>
                    <div id="pieChartLotDiv"></div>
                    <div id="lotNumberDiv"></div>
                    <div id="chartMoaLotDiv"></div>
                    <div id="pteLotNumberDiv"></div>
                </calcite-tab>
                <calcite-tab>
                  <div id="pieChartStructureDiv"></div>
                  <div id="structureNumberDiv"></div>
                  <div id="chartMoaStructureDiv"></div>
                  <div id="pteStructureNumberDiv"></calcite-label>
                  </div>
                </calcite-tab>
                <calcite-tab>
                    <div id="pieChartIsfDiv"></calcite-label>
                    </div>
                </calcite-tab>
                <calcite-tab>
                  <div class="panel-side esri-widget">
                    <ul id="expropriationListDiv">
                      <li>Loading&hellip;</li>
                    </ul>
                  </div>
                </calcite-tab>
            </div>
        </calcite-tabs>
       </div>

    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer"
    ], function(WebMap, MapView, Map, FeatureLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer
                 ) {
      
    var map = new Map({
        basemap: "gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new MapView({
        map: map,
        center: [121.05000, 14.40],
        zoom: 12,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Tile Layer
    let tileLayer = new TileLayer({
        // URL points to a cached tiled map service hosted on ArcGIS Server
        url: "https://gis.railway-sector.com/server/rest/services/Hosted/testTileCacheImage/MapServer",
        title: "Orthophoto"
    }); 
    map.add(tileLayer);

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    function colorLotReqs(){
        return {
            0: [0, 197, 255], 
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,0,0,0]
        }
    }

    let lotLayerRenderer = {
        type: "unique-value",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusLA == 0, '0',$feature.StatusLA == 1, '1', $feature.StatusLA == 2, '2', \
                               $feature.StatusLA == 3, '3', $feature.StatusLA == 4, '4', \
                               $feature.StatusLA == 5, '5', $feature.StatusLA)",
        uniqueValueInfos: [
            {
                value: "0",
                label: "Handed-Over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[0],
                }
            },
            {
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            }
        ]
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 14,
        renderer:lotLayerRenderer,
        outFields: ["*"],
        title: "Land",
        labelsVisible: false,
    });
    map.add(lotLayer, 1);

    /// Popup for lot layer
    const lotStatusArray = [
        "Handed-Over",
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro"
    ];

    const landUseArray = [
        "Agricultural",
        "Agricultural & Commercial",
        "Agricultural / Residential",
        "Commercial",
        "Industrial",
        "Irrigation",
        "Residential",
        "Road",
        "Road Lot",
        "Special Exempt"
    ]

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked PierNoLayer
            const lotNo = event.graphic.attributes.LotID;
            const handOverDate = event.graphic.attributes.HandOverDate;
            const handOverArea = event.graphic.attributes.percentHandedOver;
            const statusLot = event.graphic.attributes.StatusLA;
            const landUse = event.graphic.attributes.LandUse;
            const municipal = event.graphic.attributes.Municipality;
            const barangay = event.graphic.attributes.Barangay;
            const landOwner = event.graphic.attributes.LandOwner;
            const cpNo = event.graphic.attributes.CP;

            // Convert numeric to date format

            var date = new Date(handOverDate);
            var DATES = dateFormat(date, 'MM-dd-yyyy');

            if (DATES === '01-01-1970') {
                var finalDate = "Undefined"
            } else {
                var finalDate = dateFormat(date, 'MM-dd-yyyy');
            }
            // Convert domain code to domain name
            /// 1. Status
            if (statusLot >= 0) {
                //headerTitleDiv.innerHTML = lotStatusArray[statusLot];
                var statusLotTemp = lotStatusArray[statusLot];
            }

            if (landUse >=1 ) {
                var landUseTemp = landUseArray[landUse - 1];
            }

            return `<ul><li>Hand-Over Date:   <b>${finalDate}</b></li><br>
                    <li>Handed-Over Area: <b>${handOverArea} %</b></li><br>
                    <li>Status:           <b>${statusLotTemp}</b></li><br>
                    <li>Land Use:         <b>${landUseTemp}</b></li><br>
                    <li>Municipality:     <b>${municipal}</b></li><br>
                    <li>Barangay:         <b>${barangay}</b></li><br>
                    <li>Land Owner:       <b>${landOwner}</b>
                    <li>CP:               <b>${cpNo}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{LotID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


    // Structure Layer
    var structureLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 13,
        title: "Structure",
        outFields: ["*"],
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "StrucOwner",
                            label: "Structure Owner"
                        },
                        {
                            fieldName: "StatusStruc",
                            label: "<p>Status of Structure</p>"
                        },               
                        {
                            fieldName: "LotID",
                            label: "Lot ID"
                        },
                        {
                            fieldName: "Municipality"
                        },
                        {
                            fieldName: "Barangay"
                        }
                    ]
                }
            ]
        }
    });
    map.add(structureLayer);

    const colors = {
        1: [0, 197, 255], // Dismantling/Clearing (original: 255, 0, 197)
        2: [112, 173, 71], // Paid
        3: [0, 112, 255], // For Payment Processing
        4: [255, 255, 0], // For Legal Pass 
        5: [255, 170, 0],// For Appraisal/Offer to Compensate
        6: [255, 0, 0] //LBP Account Opening
    };

    function renderStructureLayer() {
        const renderer = new UniqueValueRenderer({
            field: "StatusStruc"
        });
        for (let property in colors) {
            if (colors.hasOwnProperty(property)) {
                renderer.addUniqueValueInfo({
                    value: property,
                    symbol: {
                        type: "simple-fill",
                        color: colors[property],
                        style: "backward-diagonal",
                        outline: {
                            color: "#6E6E6E",
                            width: 0.7
                        }
                    }
                });
            }
        }
        structureLayer.renderer = renderer;
    }
    
    renderStructureLayer();

    // Structure (NLO/LO)
    let NLOLORenderer = {
        type: "unique-value",
        field: "Status",
        uniqueValueInfos:[
            {
                value: 1,
                label: "LO (Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "forward-diagonal",
                    color: [128, 128, 128, 0.8],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            },
            {
                value: 2,
                label: "NLO (Non-Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "vertical",
                    color: [128, 128, 128, 0.8],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            }
        ]
    };

    var structureNLOLOLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        renderer: NLOLORenderer,
        layerId: 10,
        title: "NLO/LO (Structure)",
        outFields: ["*"],
        popupEnabled: false
    });
    map.add(structureNLOLOLayer);

    // Status of Relocation (Occupancy)
    var relocationPtLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 12,
        outFields: ["*"],
        title: "Occupancy (Structure)",
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "StrucOwner",
                    label: "Structure Owner"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                {
                    fieldName: "Occupancy",
                    label: "<p>Status for Relocation(structure)</p>"
                },
                {
                    fieldName: "Name",
                },
                {
                    fieldName: "Status",
                    label: "Status of NLO/LO"
                }
                ]
            }
            ]
        }
    });
    map.add(relocationPtLayer);

    // Priority Lots
    var priorityLabel = new LabelClass({
        labelExpressionInfo: {expression: "$feature.LotID"},
        symbol: {
            type: "text",
            color: "black",
            haloColor: "white",
            haloSize: 0.5,
            font: {
                size: 12,
                weight: "bold"
            }
        }
    });

    function colorPriority() {
        return {
            1: [255, 0, 0], // Red
            2: [255, 127, 80], // Orange
            3: [255, 255, 0], // Yellow
            4: [0, 112, 255], // Blue
            5: [143, 0, 255], // violet
            6: [0, 255, 0], // Lime
            7: [112, 173, 71] // Green
        }
    }

    const priorityDates = ["December 2022", "April 2023", "July 2023"];

    let lotPriorityRenderer = {
        type: "unique-value",
        //field: "HandOverDate1", // For 3D, including this works, but for 2D we need to remove this 
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.HandOverDate1 == 'May 2023', '0', \
                        $feature.HandOverDate1 == 'June 2023', '1', \
                        $feature.HandOverDate1 == 'August 2023', '2', \
                        $feature.HandOverDate1 == 'September 2023', '3', \
                        $feature.HandOverDate1 == 'October 2023', '4', \
                        $feature.HandOverDate1 == 'November 2023', '5', \
                        $feature.HandOverDate1 == 'December 2023', '6', \ $feature.HandOverDate1)",
        uniqueValueInfos: [
            {
                value: "0",
                label: "May 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[1]
                    }
                }
            },
            {
                // All features with value of "North" will be blue
                value: "1",
                label: "June 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[2]
                    }
                }
            },
            {
                value: "2",
                label: "August 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[3]
                    }
                }
            },
            {
                value: "3",
                label: "September 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[4]
                    }
                }
            },
            {
                value: "4",
                label: "October 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[5]
                        }
                }
            },
            {
                value: "5",
                label: "November 2023",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[6]
                    }
                }
            },
            {
                value: "6",
                label: "December 2023",
                    symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[7]
                    }
                }
            },
        ]
    }

    var priorityLayer = new FeatureLayer ({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 8,
        renderer: lotPriorityRenderer,
        labelingInfo: [priorityLabel],
        definitionExpression: "HandOverDate1 IS NOT NULL",
        title: "Land with Hand-Over Dates",
        popupEnabled: false,
        minScale: 150000,
        maxScale: 0
    });
    map.add(priorityLayer,2);

    // ISF
    const isfSymbolColor = {
        1: [0, 197, 255], // Relocated  (original: 255, 0, 197)
        2: [112, 173, 71], // Paid
        3: [0, 112, 255], // For Payment Processing
        4: [255, 255, 0], // For Legal Pass 
        5: [255, 170, 0], // For Appraisal/OtC/Requirements for Other Entitlements
        6: [255, 0, 0] //LBP Account Opening
    }
    const outlineColor = "gray";

    let isfRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.StatusRC == 1, 'relocated', \
                        $feature.StatusRC == 2, 'paid', $feature.StatusRC == 3, 'payp', \
                        $feature.StatusRC == 4, 'legalpass', $feature.StatusRC == 5, 'otc', \
                        $feature.StatusRC == 6, 'lbp', $feature.StatusRC)",
        uniqueValueInfos: [
            {
                value: "relocated",
                label: "Relocated",
                type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 5,
                        color: isfSymbolColor[1], // the first two letters dictate transparency.
                        outline: {
                            width: 0.5,
                            color: outlineColor
                        }
                    }
            },
            {
                value: "paid",
                label: "Paid",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: isfSymbolColor[2], // the first two letters dictate transparency.
                    outline: {
                    width: 0.5,
                    color: outlineColor
                    }
                }
            },
            {
                value: "payp",
                label: "For Payment Processing",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: isfSymbolColor[3], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "legalpass",
                label: "For Legal Pass",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: isfSymbolColor[4], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "otc",
                label: "For Appraisal/OtC/Reqs for Other Entitlements",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: isfSymbolColor[5], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "lbp",
                label: "LBP Account Opening",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: isfSymbolColor[6], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            }
        ]
    };

    var reloISFLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 11,
        renderer: isfRenderer,
        outFields: ["*"],
        title: "ISF (Informatl Settlers Families)",
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "StrucOwner",
                    label: "Structure Owner"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                {
                    fieldName: "StatusRC",
                    label: "<p>Status for Relocation(ISF)</p>"
                },
                {
                    fieldName: "Name",
                },
                {
                    fieldName: "Status",
                    label: "Status of NLO/LO"
                }
                ]
            }
            ]
        }
    });
    //reloISFLayer.listMode = "hide";
    //map.add(reloISFLayer);

    // Chainage
    var labelChainage = new LabelClass({
        labelExpressionInfo: {expression: "$feature.KmSpot"},
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 15,
                    weight: "bold"
                }
            }
    });

    var chainageRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    };

    var chainageLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "Chainage",
        elevationInfo: {
            mode: "relative-to-ground"
        },
        labelingInfo: [labelChainage],
        minScale: 150000,
        maxScale: 0,
        renderer: chainageRenderer,
        outFields: ["*"],
        popupEnabled: false
    });
    map.add(chainageLayer);

    // Pier Head and Column
    let pierHeadColRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill" },  // autocasts as new SimpleFillSymbol()
        uniqueValueInfos: [
            {
                value: "Pier_Column",
                label: "Pier Colmn",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [78, 78, 78, 0.5],
                }
            },
            {
                value: "Pier_Head",
                label: "Pier Head",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [169, 169, 169, 0.7]
                }
            },
            {
                value: "Pile_Cap",
                label: "Pile Cap",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [200, 200, 200, 0.7]
                }
            }
        ]
    };

    var pierHeadColumnLayerLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        title: "Pier Head/Column",
        outFields: ["*"],
        minScale: 150000,
        maxScale: 0,
        renderer: pierHeadColRenderer,
        popupEnabled: false
    });
    //pierHeadColumnLayerLayer.listMode = "hide";
    map.add(pierHeadColumnLayerLayer, 1);

    // Pier No (point)
    function createTextSymbol(color) {
        return {
            type: "text", // autocasts as new TextSymbol()
            font: {
                size: 15,
                weight: "bold"
            },
            color: color,
            haloColor: "black",
            haloSize: 1
            };
    }

    var pierNoRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    }

    const alreadyAccessDate = "$feature.PIER";
    const alreadyAccessDateClass = {
        labelExpressionInfo: {
            expression: alreadyAccessDate
        },
        labelPlacement: "above-center",
        where: "AccessDate <= date'2022-07-31'"
    };
    alreadyAccessDateClass.symbol = createTextSymbol("#00c5ff");

    // when AccessDate is after '2022-08-01'
    const yetAccessDate = "$feature.PIER";
    const yetAccessDateClass = {
        labelExpressionInfo: {
            expression:yetAccessDate
        },
        labelPlacement: "above-center",
        where: "AccessDate > date'2022-08-01'"
    };
    yetAccessDateClass.symbol = createTextSymbol("#ffffff");

    var PierNoLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 6,
        labelingInfo: [alreadyAccessDateClass, yetAccessDateClass],
        renderer: pierNoRenderer,
        title: "Pier No.",
        minScale: 150000,
        maxScale: 0,
        outFields: ["*"],
    },{utcOffset: 300});
    map.add(PierNoLayer, 3);

    /// Define popup template on dates for pier no
    // Date Format function
    function dateFormat(inputDate, format) {
        //parse the input date
        const date = new Date(inputDate);

        //extract the parts of the date
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();    

        //replace the month
        format = format.replace("MM", month.toString().padStart(2,"0"));        

        //replace the year
        if (format.indexOf("yyyy") > -1) {
            format = format.replace("yyyy", year.toString());
        } else if (format.indexOf("yy") > -1) {
            format = format.replace("yy", year.toString().substr(2,2));
        }

        //replace the day
        format = format.replace("dd", day.toString().padStart(2,"0"));

        return format;
    }

    // Custom Popup Content for PierNoLayer
    let customContent = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked PierNoLayer
            const stats = event.graphic.attributes.AccessDate;
            const pierNo = event.graphic.attributes.PIER;

            // Convert numeric to date format
            var date = new Date(stats);
            const dateValue = dateFormat(date, 'MM-dd-yyyy');

            // If the date is before current date, popupContent should be "AVAILABLE"
            const d1 = new Date('08-31-2022');

            if (date < d1) {
                DATES = "AVAILABLE";
            } else {
                DATES = dateValue;
            }

            //return `Access Date: <b>${DATES}</b>`;
            return `Access Date: <b>${DATES}</b>`;

        }
    });

    const template = new PopupTemplate({
        outFields: ["*"],
        title: "Pier No: <b>{PIER}</b>",
        lastEditInfoEnabled: false,
        content: [customContent]
    });
    PierNoLayer.popupTemplate = template;

    // Station Box
    let stationBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
            {
                value: "00_Platform",
                label: "Platform",
                    symbol: {
                    type: "simple-fill",
                    color: [160, 160, 160],
                    style: "backward-diagonal",
                    outline: {
                        width: 1,
                        color: "black"
                    }
                }
            },
            {
                value: "00_Platform 10car",
                label: "Platform 10car",
                symbol: {
                    type: "simple-fill",
                    color: [104, 104, 104],
                    style: "cross",
                    outline: {
                        width: 1,
                        color: "black",
                        style: "short-dash"
                    }
                }
            },
            {
            value: "00_Station",
            label: "Station Box",
            symbol: {
                type: "simple-fill",
                color: [0, 0, 0, 0],
                outline: {
                    width: 2,
                    color: [115, 0, 0]
                }
            }
            }
        ]
    };

    var stationBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        renderer: stationBoxRenderer,
        minScale: 150000,
        maxScale: 0,
        title: "Station Box",
        outFields: ["*"],
        popupEnabled: false
    });
    //stationBoxLayer.listMode = "hide";
    map.add(stationBoxLayer, 2);

    // ROW //
    var rowLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "PROW",
        popupEnabled: false
    });
    map.add(rowLayer,2);

    // Free and Clear Lot
    var fncLayer = new FeatureLayer ({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 9,
        title: "Free-and-Clear Area",
        //popupEnabled: false
    });
    map.add(fncLayer,1);

    // PNR
    let pnrRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.LandOwner == 'BASES CONVERSION DEVELOPMENT AUTHORITY', 'BCDA', \
                        $feature.LandOwner == 'MANILA RAILROAD COMPANY' || $feature.LandOwner == 'Manila Railroad Company','PNR',$feature.LandOwner)",
        uniqueValueInfos: [
            {
                value: "BCDA",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            },
            {
                value: "PNR",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            }
        ]
    };

    var pnrLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 17,
        title: "Land (PNR)",
        outFields: ["*"],
        title: "PNR",
        labelsVisible: false,
        renderer: pnrRenderer,
        popupTemplate: {
            title: "<p>{LandOwner} ({LotID})</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "HandOverDate1",
                    label: "Hand-Over Date"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                ]
            }
            ]
        }
        //popupEnabled: false
    });
    map.add(pnrLayer, 1);

    // Station point feature
    var labelStation = new LabelClass({
        symbol: {
            type: "text",
            color: "orange",
            haloColor: "black",
            haloSize: 0.2,
            font: {
                size: 12,
                weight: "bold"
            }
        },
        labelPlacement: "above-right",
        labelExpressionInfo: {
            expression: "$feature.Station"
        }
    });

    var stationLayer = new FeatureLayer({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "Station",
        outFields: ["*"],
        popuEnabled: false,
        labelingInfo: [labelStation]
    });
    stationLayer.listMode = "hide";
    map.add(stationLayer);


    /////////////////// END Of LAYER IMPORT ////////////////////////////

    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      
zoomToLayer(stationLayer);
      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;
      
      const lotNumberDiv = document.getElementById("lotNumberDiv");
      const pteLotNumberDiv = document.getElementById("pteLotNumberDiv");
      const structureNumberDiv = document.getElementById("structureNumberDiv");
      const pteStructureNumberDiv = document.getElementById("pteStructureNumberDiv");

      var municipalSelect = document.getElementById("municipalSelect");
      var barangaySelect = document.getElementById("barangaySelect");
      var prioritySelect = document.getElementById("prioritySelect");
      
      am4core.ready(function() {
        am4core.useTheme(am4themes_animated);
        // Default
        reloISFLayer.visible = false;

        // Expropriation List----------------------------------
     
        view.when(function() {
            var expropriationList = document.getElementById("expropriationListDiv");
            
            // Obtain a list of Owner's names and status
            view.whenLayerView(lotLayer).then(function(exprolayerView) {
                exprolayerView.watch("updating", function(val) {
                    if (!val) {
                        // Query for only Expropriation lots
                        var query = new Query();
                        query.outFields = ["*"];
                        query.where = "StatusLA = 5";
                        exprolayerView.queryFeatures(query).then(function(result) {
                            expropriationList.innerHTML = "";
                            result.features.forEach(function(feature) {
                                var attributes = feature.attributes;
                                
                                var li = document.createElement("li");
                                li.setAttribute("class", "panel-result");
                                
                                const status = attributes.StatusLA;
                                if (status == 5) {
                                    statusla = "Expropriation"
                                }
                                
                                // Add Expropriation lots to list
                                li.innerHTML = "Lot ID: " + "<b>" + attributes.LotID + "</b>" + "<br>" + attributes.LandOwner;

                                li.addEventListener("click", function(event) {
                                    var target = event.target;
                                    var objectId = feature.attributes.OBJECTID;
                                    var queryExtent = new Query({
                                        objectIds: [objectId]
                                    });
                                    
                                    // Query extent for selected expropriation lot in the list
                                    exprolayerView.queryExtent(queryExtent).then(function(result) {
                                        if (result.extent) {
                                            view.goTo({
                                                target: result.extent,
                                                speedFactor: 2,
                                                zoom: 17})
                                                .catch(function(error) {
                                                    if (error.name != "AbortError") {
                                                        console.error(error);
                                                    }
                                                }); // End of catch
                                            } // End of if (result.extent)
                                        }); // End of layerView.queryExtent
                                        
                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function() {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    expropriationList.appendChild(li);
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()

        // Thousand separators function
        function thousands_separators(num) {
          var num_parts = num.toString().split(".");
          num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return num_parts.join(".");
        }
        
        // 1. Total Number of Lots
        function totalNumberOfLots(){
          var totalLot = {
            onStatisticField: "CASE WHEN StatusLA >= 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalLot",
            statisticType: "sum"
          };
          var query = lotLayer.createQuery();
          query.outStatistics = [totalLot];
          query.returnGeometry = true;

          lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;
            const LOT_TOTAL = thousands_separators(stats.totalLot);

            lotNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Lots</b><br><br>${LOT_TOTAL}` : `<b>Number of Lots</b><br><br>${LOT_TOTAL}`;
          });
        }

        totalNumberOfLots();

        // Total number of handed-over lots
        function pteNumberLot(){
            var total_pte_lot = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_lot",
                statisticType: "sum"
            };

            var total_lot_N = {
                onStatisticField: "CASE WHEN StatusLA >= 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_lot_N",
                statisticType: "sum"
            };
            var query = lotLayer.createQuery();
            query.outStatistics = [total_pte_lot, total_lot_N];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function(response){
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_lot;
                const totalN = stats.total_lot_N;
                const percPTE = ((pte/totalN)*100).toFixed(0);

                const values = percPTE == "Infinity" ? "N/A" : percPTE + "% (" + pte + ")";
                pteLotNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of PTE</b><br><br>${values}` : `<b>Number of PTE</b><br><br>${values}`;
            });
        }
        pteNumberLot();

        // Total number of structures
        function totalNumberOfStructures(){
          var totalStructure = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalStructure",
            statisticType: "count"
          };
          var query = structureLayer.createQuery();
          query.outStatistics = [totalStructure];
          query.returnGeometry = true;

          structureLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
            structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br><br>${STRUCTURE_TOTAL}` : `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;
          });
        }
        totalNumberOfStructures();

        // Total number of PTE for structure
        function pteNumberStructure() {
            var total_pte_structure = {
                onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_pte_structure",
                statisticType: "sum"
            };

            var total_struc_N = {
                onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "total_struc_N",
                statisticType: "sum"
            };

            var query = structureLayer.createQuery();
            query.outStatistics = [total_pte_structure,total_struc_N];
            query.returnGeometry = true;

            structureLayer.queryFeatures(query).then(function(response) {
                var stats = response.features[0].attributes;

                const pte = stats.total_pte_structure;
                const totalN = stats.total_struc_N;
                const percPTE = ((pte/totalN)*100).toFixed(0);

                const value = percPTE + "% (" + pte + ")";
                pteStructureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of PTE</b><br><br>${value}` : `<b>Number of PTE</b><br><br>${value}`;
            });
        }
        pteNumberStructure();


        // Dropdown List
        view.when(function() {
            return lotLayer.when(function() {
                var query = lotLayer.createQuery();
                return lotLayer.queryFeatures(query);
            });
        })
        .then(getValues)
        .then(getUniqueValues)
        .then(addToSelect)

        function queryForLotGeometries() {
            var lotQuery = lotLayer.createQuery();

            return lotLayer.queryFeatures(lotQuery).then(function(response) {
                lotGeometries = response.features.map(function(feature) {
                    return feature.geometry;
                });
                return lotGeometries;
            });
        }

    // 1. Get values and return to drop down list
    // 1.1. Municipality
    function getValues(response) {
        var features = response.features;
        var values = features.map(function(feature) {
            return feature.attributes.Municipality;
        });
        return values;
    }
    
    // Return an array of unique values in the 'Municipality' field of the lot Layer
    function getUniqueValues(values) {
        var uniqueValues = [];
    
        values.forEach(function(item, i) {
            if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
                uniqueValues.push(item);
            }
        });
        return uniqueValues;
    }
    
    // Add the unique values to the municipalility select element. this will allow the user
    // to filter lot layer by municipality.
    function addToSelect(values) {
        values.sort();
        values.unshift('None'); // Add 'None' to the array and place it to the beginning of the array
        values.forEach(function(value) {
            var option = document.createElement("option");
            option.text = value;
            municipalSelect.add(option);
        });
    }
    
    // 1.2. Barangay
    function barangayFilterList(municipalValue) {
        var barangayArray = [];

        function barangayQuery() {
            var query = lotLayer.createQuery();
            if (municipalValue === undefined || municipalValue === 'None') {
                query.where = "1=1";
            } else if (municipalValue !== 'None') {
                query.where = "Municipality = '" + municipalValue + "'";
            }
        
            return lotLayer.queryFeatures(query).then(function(response) {
                stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const barangay = attributes.Barangay;
                    barangayArray.push(barangay);
                });
                return barangayArray;
            });
        }

        function getUniqueValues2(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
                if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                    uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
        }

        function addToSelectQuery2(query2Values) {
            barangaySelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                barangaySelect.add(option);
            });
        }

        barangayQuery()
        .then(getUniqueValues2)
        .then(addToSelectQuery2)
    }
    barangayFilterList();

    // 1.3. Handover date
    function priorityFilterList(municipalValue, barangayValue) {
        var priorityArray = [];

        function priorityQuery() {
            var query = lotLayer.createQuery();
            if (municipalValue === undefined && barangayValue === undefined) {
                query.where = "1=1";
            
            // Municipality: None, barangayValue: !None
            } else if (municipalValue === 'None' && barangayValue !== 'None') {
                query.where = "Barangay = '" + barangayValue + "'";
            
            // Municipality: None, barangayValue: None
            } else if (municipalValue === 'None' && barangayValue === 'None') {
                query.where = "1=1";
            
            // Municipality: !None, barangayValue: None
            } else if (municipalValue !== 'None' && barangayValue === 'None') {
                query.where = "Municipality = '" + municipalValue + "'";
            
            // Municipality: !None, barangayValue: !None
            } else if (municipalValue !== 'None' && barangayValue !== 'None') {
                query.where = "Municipality = '" + municipalValue + "'" + " AND " + "Barangay = '" + barangayValue + "'";
            }
        
            return lotLayer.queryFeatures(query).then(function(response) {
                stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const handedOver = attributes.HandOverDate1;
                    priorityArray.push(handedOver);
                });
                return priorityArray;
            });
        }


        function getUniqueValues3(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
                if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
        }
    
        function addToSelectQuery3(query2Values) {
            prioritySelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                prioritySelect.add(option);
            });
            return query2Values;
        }

        priorityQuery()
        .then(getUniqueValues3)
        .then(addToSelectQuery3);
    }
    priorityFilterList();

    // Set the definition expression on the lot layer
    // to reflect the selecction of the user
    // Only for Municipality
    function setMunicipalExpression(municipal) {

        if (municipal == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            priorityLayer.definitionExpression = null;
            reloISFLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            relocationPtLayer.definitionExpression = null;

        } else {
            lotLayer.definitionExpression = "Municipality = '" + municipal + "'";
            structureLayer.definitionExpression = "Municipality = '" + municipal + "'";
            priorityLayer.definitionExpression = "Municipality = '" + municipal + "'";
            reloISFLayer.definitionExpression = "Municipality = '" + municipal + "'";
            pnrLayer.definitionExpression = "Municipality = '" + municipal + "'";
            relocationPtLayer.definitionExpression = "Municipality = '" + municipal + "'";
        }
        zoomToLayer(lotLayer);

        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }

    // for Municipcality + Barangay + Priority
    function setMunicipalBarangayPriorityExpression(municipal, barangay, priority) {
        //var municipal = municipalSelect.options[municipalSelect.selectedIndex].value;
        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        //var priori = prioritySelect.options[prioritySelect.selectedIndex].value;

        // all = 'None'
        if (municipal == 'None' && barangay == 'None' && priority == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            priorityLayer.definitionExpression = null;
            reloISFLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            relocationPtLayer.definitionExpression = null;

        } else if (municipal == 'None' && barangay == 'None' && priority !== 'None') {
            lotLayer.definitionExpression = "HandOverDate1 = '" + priority + "'";
            //structureLayer.definitionExpression = "HandOverDate1 = '" + priority + "'";
            priorityLayer.definitionExpression = "HandOverDate1 = '" + priority + "'";
            pnrLayer.definitionExpression = "HandOverDate1 = '" + priority + "'";

        } else if (municipal == 'None' && barangay !== 'None' && priority == 'None') {
            lotLayer.definitionExpression = "Barangay = '" + barangay + "'";
            structureLayer.definitionExpression = "Barangay = '" + barangay + "'";
            priorityLayer.definitionExpression = "Barangay = '" + barangay + "'"; 
            reloISFLayer.definitionExpression = "Barangay = '" + barangay + "'";
            pnrLayer.definitionExpression = "Barangay = '" + barangay + "'";
            relocationPtLayer.definitionExpression = "Barangay = '" + barangay + "'";

        } else if (municipal == 'None' && barangay !== 'None' && priority !== 'None') {
            lotLayer.definitionExpression = "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            structureLayer.definitionExpression = "Barangay = '" + barangay + "'";
            priorityLayer.definitionExpression = "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            pnrLayer.definitionExpression = "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            relocationPtLayer.definitionExpression = "Barangay = '" + barangay + "'";

        } else if (municipal !== 'None' && barangay == 'None' && priority == 'None') {
            lotLayer.definitionExpression = "Municipality = '" + municipal + "'";
            structureLayer.definitionExpression = "Municipality = '" + municipal + "'";
            priorityLayer.definitionExpression = "Municipality = '" + municipal + "'";
            reloISFLayer.definitionExpression = "Municipality = '" + municipal + "'";
            pnrLayer.definitionExpression = "Municipality = '" + municipal + "'";
            relocationPtLayer.definitionExpression = "Municipality = '" + municipal + "'";

        } else if (municipal !== 'None' && barangay == 'None' && priority !== 'None') {
            lotLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            structureLayer.definitionExpression = "Municipality = '" + municipal + "'";
            priorityLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            pnrLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            relocationPtLayer.definitionExpression = "Municipality = '" + municipal + "'";

        } else if (municipal !== 'None' && barangay !== 'None' && priority == 'None') {
            lotLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            structureLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            priorityLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'"; 
            reloISFLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            pnrLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            relocationPtLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";

        } else {
            lotLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            structureLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            priorityLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            pnrLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'" + " AND " + "HandOverDate1 = '" + priority + "'";
            relocationPtLayer.definitionExpressio = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
            reloISFLayer.definitionExpression = "Municipality = '" + municipal + "'" + " AND " + "Barangay = '" + barangay + "'";
        }


        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }

    ///
    function filterLot() {
        var query2 = lotLayer.createQuery();
        query2.where = lotLayer.definitionExpression; // use filtered municipality. is this correct?
    }
    
    function filterStructure() {
        var query2 = structureLayer.createQuery();
        query2.where = structureLayer.definitionExpression; // use filtered municipality. is this correct?
    }
    
    function filterPriority() {
        var query2 = pnrLayer.createQuery();
        query2.where = pnrLayer.definitionExpression; // use filtered municipality. is this correct?
    
    }
    
    function filterPNR() {
        var query2 = pnrLayer.createQuery();
        query2.where = pnrLayer.definitionExpression; // use filtered municipality. is this correct?
    }
    
    // When CP is changed, Type is reset to 'None'
    const changeSelected = (e) => {
        const $select = document.querySelector('#prioritySelect');
        $select.value = 'None'
    };


    // Dropdown List
    // Select Municipality from dropdown list
    municipalSelect.addEventListener("change", function() {
        var municipal = event.target.value;
        var barangay = barangaySelect.value;

        setMunicipalExpression(municipal);
        changeSelected();

        barangayFilterList(municipal);
        priorityFilterList(municipal, barangay);

        filterLot();
        filterStructure();
        filterPriority();
        filterPNR();


        totalNumberOfLots();
        pteNumberLot();
        totalNumberOfStructures();
        pteNumberStructure();
        updateChartLot();
        updateMoaChartLot();
        updateChartStructure();
        updateMoaChartStructure();
        //updateChartISF();

        zoomToLayer(lotLayer);
    });

        barangaySelect.addEventListener("change", function() {
            var municipal = municipalSelect.value;
            var barangay = event.target.value;
            var priority = prioritySelect.value;

            setMunicipalBarangayPriorityExpression(municipal, barangay, priority);
            changeSelected();

            priorityFilterList(municipal, barangay);

            filterLot();
            filterStructure();
            filterPriority();
            filterPNR();

            totalNumberOfLots();
            pteNumberLot();
            totalNumberOfStructures();
            pteNumberStructure();
            updateChartLot();
            updateMoaChartLot();
            updateChartStructure();
            updateMoaChartStructure();
            //updateChartISF();

            zoomToLayer(lotLayer);
        //relocationObjectID(reloStatusLayer);
    });


    prioritySelect.addEventListener("change", function() {
        var municipal = municipalSelect.value;
        var barangay = barangaySelect.value;
        var priority = event.target.value;

        setMunicipalBarangayPriorityExpression(municipal, barangay, priority);

        totalNumberOfLots();
        pteNumberLot();
        totalNumberOfStructures();
        pteNumberStructure();
        updateChartLot();
        updateMoaChartLot();
        updateChartStructure();
        updateMoaChartStructure();
        //updateChartISF();

        //zoomToLayer(lotLayer);
        //relocationObjectID(reloStatusLayer);

        let arrLviews = [];

        view.whenLayerView(lotLayer).then(function (layerView) {
            arrLviews.push(layerView);
            lotLayer.queryFeatures().then(function(results) {
                const ggg = results.features;
                const rowN = ggg.length;

                let objID = [];
                for (var i=0; i < rowN; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                    objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                    layerView.filter = null;
                    highlightSelect.remove();
                });
            }); // End of queryFeatures
        }); // End of view.whenLayerView

        view.whenLayerView(pnrLayer).then(function (layerView) {
            arrLviews.push(layerView);
            pnrLayer.queryFeatures().then(function(results) {
                const ggg = results.features;
                const rowN = ggg.length;

                let objID = [];
                for (var i=0; i < rowN; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                    objectIds: objID
                });

                pnrLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                    layerView.filter = null;
                    highlightSelect.remove();
                });
            }); // End of queryFeatures
        }); // End of view.whenLayerView

        for(var i = 0; i < arrLviews.length; i++) {
            arrLviews[i].filter = {
                where: "HandOverDate1 = '" + type + "'"
            }
        }
    });



    // Charts for Lot and Structure
    // Lot Chart
    const dark = document.querySelector("#arcgis-maps-sdk-theme-dark");
    const light = document.querySelector("#arcgis-maps-sdk-theme-light");

    // Set color in light theme
    const lightThemeColor = "#212121";
    const darkThemeColor = "#FFFFFF";
    const LEGEND_FONT_SIZE = "0.9em";

    function updateChartLot() {
        // First, define statuses
        var total_handedover_lot = {
            onStatisticField: "CASE WHEN StatusLA = 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_handedover_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusLA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusLA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusLA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otb_lot = {
            onStatisticField: "CASE WHEN StatusLA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otb_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN StatusLA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_handedover_lot, total_paid_lot, total_payp_lot,
                                total_legalpass_lot, total_otb_lot, total_expro_lot];
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const handedover = stats.total_handedover_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otb = stats.total_otb_lot;
            const expro = stats.total_expro_lot;

            var chart = am4core.create("pieChartLotDiv", am4charts.PieChart);

            // Add data
            chart.data = [
                {
                    "StatusLA": "Handed-Over",
                    "status": handedover,
                    "color": am4core.color("#00C5FF")
                },
                {
                    "StatusLA": "Paid",
                    "status": paid,
                    "color": am4core.color("#70AD47")
                },
                {
                    "StatusLA": "For Payment Processing",
                    "status": payp,
                    "color": am4core.color("#0070FF")   
                },
                {
                    "StatusLA": "For Legal Pass",
                    "status": legalpass,
                    "color": am4core.color("#FFFF00") 
                },
                {
                    "StatusLA": "For Appraisal/Offer to Buy",
                    "status": otb,
                    "color": am4core.color("#FFAA00")
                },
                {
                    "StatusLA": "For Expro",
                    "status": expro,
                    "color": am4core.color("#FF0000")    
                }
            ];

            // Set inner radius
            chart.innerRadius = am4core.percent(30);

            // Add and configure Series

            function createSlices(field, status){
                var pieSeries = chart.series.push(new am4charts.PieSeries());
                pieSeries.dataFields.value = field;
                pieSeries.dataFields.category = status;

                pieSeries.slices.template.propertyFields.fill = "color";
                pieSeries.slices.template.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
                pieSeries.slices.template.strokeWidth = 1;
                pieSeries.slices.template.strokeOpacity = 1;

                pieSeries.slices.template
                // change the cursor on hover to make it apparent the object can be interacted with
                .cursorOverStyle = [
                    {
                    "property": "cursor",
                    "value": "pointer"
                    }
                ];


                // Hover setting
                pieSeries.tooltip.label.fontSize = 12;
                pieSeries.tooltip.label.fill = dark.disabled ? lightThemeColor: darkThemeColor;

                // Pie
                //pieSeries.alignLabels = false;
                //pieSeries.labels.template.bent = false;
                pieSeries.labels.template.disabled = true;
                pieSeries.labels.template.radius = 3;
                pieSeries.labels.template.padding(0,0,0,0);
                pieSeries.labels.template.fontSize = 10;
                pieSeries.labels.template.fill = "#ffffff";

                // Ticks (a straight line)
                //pieSeries.ticks.template.disabled = true;
                pieSeries.ticks.template.fill = "#ffff00";

                // Create a base filter effect (as if it's not there) for the hover to return to
                var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
                shadow.opacity = 0;

                // Create hover state
                var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

                // Slightly shift the shadow and make it more prominent on hover
                var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
                hoverShadow.opacity = 0.7;
                hoverShadow.blur = 5;

                // Add a legend
                chart.legend = new am4charts.Legend();

                chart.legend.valueLabels.template.align = "right"
                chart.legend.valueLabels.template.textAlign = "end";  

                //chart.legend.position = "bottom";
                chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
                chart.legend.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
                chart.legend.valueLabels.template.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor); 
                chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
                pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
                chart.legend.itemContainers.template.paddingTop = "2em";
                chart.legend.itemContainers.template.paddingBottom = "2em";

                // Responsive code for chart
                chart.responsive.enabled = true;

                // Chart Title
                /*
                var title = chart.titles.create();
                title.text = "Land"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
                title.fontSize = 20;
                title.fontWeight = "bold";
                title.fill = "#ffffff";
                title.marginTop = 5;
                */

                var marker = chart.legend.markers.template.children.getIndex(0);
                var markerTemplate = chart.legend.markers.template;
                marker.cornerRadius(12, 12, 12, 12);
                marker.strokeWidth = 1;
                marker.strokeOpacity = 1;
                marker.stroke = am4core.color("#ccc");

                // Change size of legend marker
                markerTemplate.width = 18;
                markerTemplate.height = 18;
                // This creates initial animation
                //pieSeries.hiddenState.properties.opacity = 1;
                //pieSeries.hiddenState.properties.endAngle = -90;
                //pieSeries.hiddenState.properties.startAngle = -90;

                // Click chart and filter, update maps

                pieSeries.slices.template.events.on("hit", filterByChart, this);
                function filterByChart(ev) {
                    const selectedD = ev.target.dataItem.category;

                    if (selectedD == "Handed-Over") {
                        selectedStatus = 0;
                    } else if (selectedD == "Paid") {
                        selectedStatus = 1;
                    } else if (selectedD == "For Payment Processing") {
                        selectedStatus = 2;
                    } else if (selectedD == "For Legal Pass") {
                        selectedStatus = 3;
                    } else if (selectedD == "For Appraisal/Offer to Buy") {
                        selectedStatus = 4;
                    } else if (selectedD == "For Expro") {
                        selectedStatus = 5;
                    } else {
                        selectedStatus = null;
                    }

                    view.when(function() {
                        view.whenLayerView(lotLayer).then(function (layerView) {
                        chartLayerView = layerView;

                            lotLayer.queryFeatures().then(function(results) {
                                const ggg = results.features;
                                const rowN = ggg.length;

                                let objID = [];
                                for (var i=0; i < rowN; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                lotLayer.queryExtent(queryExt).then(function(result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function() {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "StatusLA = " + selectedStatus
                            }
                        }); // End of view.whenLayerView

                    }); // End of view.when
                } // End of filterByChart
            } // End of createSlices function
            createSlices("status", "StatusLA");
        }); // End of queryFeatures
    } // End of updateChartLot()
    updateChartLot();

    // ----------------- BAR CHART FOR MOA LOT ----------------- //
    function updateMoaChartLot() {
        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_ca141_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ca141_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nego = stats.total_nego_lot;
            const expro = stats.total_expro_lot;
            const donate = stats.total_donate_lot;
            const ca141 = stats.total_ca141_lot;
            const noneed = stats.total_noneed_lot;


            var chart = am4core.create("chartMoaLotDiv", am4charts.XYChart);
            chart.hiddenState.properties.opacity = 0;
            chart.padding(10, 10, 10, 10);

            var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
            categoryAxis.renderer.grid.template.location = 0;
            categoryAxis.dataFields.category = "category";
            categoryAxis.renderer.minGridDistance = 1;
            categoryAxis.renderer.inversed = true;
            categoryAxis.renderer.grid.template.disabled = true;
            categoryAxis.renderer.labels.template.fontSize = "0.85em";
            categoryAxis.renderer.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
            categoryAxis.renderer.minGridDistance = 5; //can change label
            categoryAxis.renderer.grid.template.strokeOpacity = 1;
            categoryAxis.renderer.grid.template.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
            categoryAxis.renderer.grid.template.strokeWidth = 1.5;

            //categoryAxis.renderer.cellStartLocation = 0;
            //categoryAxis.renderer.cellEndLocation = 0.7;
            /////////////////
            categoryAxis.renderer.line.strokeOpacity = 1;
            categoryAxis.renderer.line.strokeWidth = 1.5;
            categoryAxis.renderer.line.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);

            //////////////

            var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
            valueAxis.min = 0;
            valueAxis.strictMinMax = true;
            valueAxis.calculateTotals = true;
            valueAxis.renderer.minWidth = 50;
            valueAxis.renderer.labels.template.fontSize = 12;
            valueAxis.renderer.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
            valueAxis.renderer.line.strokeOpacity = 1;
            valueAxis.renderer.line.strokeWidth = 1.5;
            valueAxis.renderer.line.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);

            var series = chart.series.push(new am4charts.ColumnSeries());
            series.dataFields.categoryY = "category";
            series.dataFields.valueX = "value";
            series.tooltipText = "{valueX.value}"
            series.columns.template.strokeOpacity = 0;

            var labelBullet = series.bullets.push(new am4charts.LabelBullet())
            labelBullet.label.horizontalCenter = "left";
            labelBullet.label.text = "{values.valueX.workingValue.formatNumber('#')}"; //#.0as for 17k
            labelBullet.locationX = 0.5;
            labelBullet.label.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
            labelBullet.interactionsEnabled = false;
            labelBullet.label.fontSize = 10;

            // Responsive to screen size
            chart.responsive.enabled = true;

            // if useDefault is false, category axis stays outside the chart
            chart.responsive.useDefault = false

            // Add chart title
            var title = chart.titles.create();
            title.text = "Mode of Acquisition"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
            title.fontWeight = "bold";
            title.fontSize = "1em";
            title.fill = "#3ce00a";

            series.columns.template.adapter.add("fill", function(fill, target){
                return chart.colors.getIndex(target.dataItem.index);
            });

            chart.data = [
                {
                    category: "No Need to Acquire",
                    value: noneed
                },
                {
                    category: "CA 141",
                    value: ca141
                },
                {
                    category: "Donation",
                    value: donate
                },
                {
                    category: "Expropriation",
                    value: expro
                },
                {
                    category: "For Negotiation",
                    value: nego
                }
            ]; // End of chart
        }); // End of queryFeatures
    } // End of updateMOAChartLot
    updateMoaChartLot();

    // ------------------ PIE CHART FOR STRUCTURE ----------------------//
    async function updateChartStructure() {
        var total_clear_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_clear_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = structureLayer.createQuery();
        query.outStatistics = [total_clear_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_clear_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

            var chart = am4core.create("pieChartStructureDiv", am4charts.PieChart);

            // Add data
            chart.data = [
                {
                    "StatusStruc": "Dismantling/Clearing",
                    "status": clear,
                    "color": am4core.color("#00C5FF") // original: #FF00C5
                },
                {
                    "StatusStruc": "Paid",
                    "status": paid,
                    "color": am4core.color("#70AD47")   
                },
                {
                    "StatusStruc": "For Payment Processing",
                    "status": payp,
                    "color": am4core.color("#0070FF") 
                },
                {
                    "StatusStruc": "For Legal Pass",
                    "status": legalpass,
                    "color": am4core.color("#FFFF00")
                },
                {
                    "StatusStruc": "For Appraisal/Offer to Compensate",
                    "status": otc,
                    "color": am4core.color("#FFAA00")    
                },
                {
                    "StatusStruc": "LBP Account Opening",
                    "status": lbp,
                    "color": am4core.color("#FF0000")    
                }
            ];

                // Set inner radius
            chart.innerRadius = am4core.percent(30);

            // Add and configure Series
            function createSlices(field, status) {
                var pieSeries = chart.series.push(new am4charts.PieSeries());
                pieSeries.dataFields.value = field;
                pieSeries.dataFields.category = status;

                pieSeries.slices.template.propertyFields.fill = "color";
                pieSeries.slices.template.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
                pieSeries.slices.template.strokeWidth = 1;
                pieSeries.slices.template.strokeOpacity = 1;

                pieSeries.slices.template.adapter.add("fill", function(fill, target) {
                    var pattern = new am4core.LinePattern();
                    pattern.width = 7;
                    pattern.height = 7;
                    pattern.strokeWidth = 1.5;
                    pattern.stroke = target.dataItem.dataContext.color;
                    pattern.rotation = 135;
                    return pattern;
                });

                pieSeries.slices.template.background.adapter.add("fill", function(fill, target) {
                    return target.dataItem ? target.dataItem.dataContext.color : fill;
                });

                pieSeries.slices.template
                // change the cursor on hover to make it apparent the object can be interacted with
                .cursorOverStyle = [
                    {
                        "property": "cursor",
                        "value": "pointer"
                    }
                ];


                // Hover setting
                pieSeries.tooltip.label.fontSize = 12;
                pieSeries.tooltip.label.fill = dark.disabled ? lightThemeColor: darkThemeColor;

                // Pie
                //pieSeries.alignLabels = false;
                //pieSeries.labels.template.bent = false;
                pieSeries.labels.template.disabled = true;
                pieSeries.labels.template.radius = 3;
                pieSeries.labels.template.padding(0,0,0,0);
                pieSeries.labels.template.fontSize = 9;
                pieSeries.labels.template.fill = "#ffffff";

                // Ticks (a straight line)
                //pieSeries.ticks.template.disabled = true;
                pieSeries.ticks.template.fill = "#ffff00";

                // Create a base filter effect (as if it's not there) for the hover to return to
                var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
                shadow.opacity = 0;

                // Create hover state
                var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

                // Slightly shift the shadow and make it more prominent on hover
                var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
                hoverShadow.opacity = 0.7;
                hoverShadow.blur = 5;


                // Add a legend
                chart.legend = new am4charts.Legend();

                chart.legend.valueLabels.template.align = "right"
                chart.legend.valueLabels.template.textAlign = "end";  

                //chart.legend.position = "bottom";
                chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
                chart.legend.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
                chart.legend.valueLabels.template.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
                chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
                pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
                chart.legend.itemContainers.template.paddingTop = "2em";
                chart.legend.itemContainers.template.paddingBottom = "2em";

                chart.legend.horizontalGap = 0;
                chart.legend.marginLeft = 0;
                chart.legend.marginRight = 0;

                // Responsive code for chart
                chart.responsive.enabled = true;

                // Chart Title
                /*
                var title = chart.titles.create();
                title.text = "Structure"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
                title.fontSize = 20;
                title.fontWeight = "bold";
                title.fill = "#ffffff";
                title.marginTop = 5;
                */

                var marker = chart.legend.markers.template.children.getIndex(0);
                var markerTemplate = chart.legend.markers.template;
                marker.cornerRadius(12, 12, 12, 12);
                marker.strokeWidth = 1;
                marker.strokeOpacity = 1;
                marker.stroke = am4core.color("#ccc");

                // Change size of legend marker
                markerTemplate.width = 18;
                markerTemplate.height = 18;
                // This creates initial animation
                //pieSeries.hiddenState.properties.opacity = 1;
                //pieSeries.hiddenState.properties.endAngle = -90;
                //pieSeries.hiddenState.properties.startAngle = -90;

                // Click chart and filter, update maps
                pieSeries.slices.template.events.on("hit", filterByChart, this);
                function filterByChart(ev) {
                    const selectedD = ev.target.dataItem.category;

                    if (selectedD == "Dismantling/Clearing") {
                        selectedStatus = 1;
                    } else if (selectedD == "Paid") {
                        selectedStatus = 2;
                    } else if (selectedD == "For Payment Processing") {
                        selectedStatus = 3;
                    } else if (selectedD == "For Legal Pass") {
                        selectedStatus = 4;
                    } else if (selectedD == "For Appraisal/Offer to Compensate") {
                        selectedStatus = 5;
                    } else if (selectedD == "LBP Account Opening") {
                        selectedStatus = 6;
                    } else {
                        selectedStatus = null;
                    }

                    view.when(function() {
                        view.whenLayerView(structureLayer).then(function (layerView) {
                            chartLayerView = layerView;

                            structureLayer.queryFeatures().then(function(results) {
                                const ggg = results.features;
                                const rowN = ggg.length;

                                let objID = [];
                                for (var i=0; i < rowN; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                structureLayer.queryExtent(queryExt).then(function(result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function() {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });
                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "StatusStruc = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                } // End of filterByChart
            } // End of createSlices function
            
            createSlices("status", "StatusStruc");
        });  // End of queryFeature       
    } // End of updateChartStructure()
    updateChartStructure();

    // ----------------- BAR CHART FOR MOA STRUCTURE ----------------- //
    async function updateMoaChartStructure() {
        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_ca141_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ca141_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nego = stats.total_nego_lot;
            const expro = stats.total_expro_lot;
            const donate = stats.total_donate_lot;
            const ca141 = stats.total_ca141_lot;
            const noneed = stats.total_noneed_lot;

            var chart = am4core.create("chartMoaStructureDiv", am4charts.XYChart);
            chart.hiddenState.properties.opacity = 0;
            chart.padding(10, 10, 10, 10);

            var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
            categoryAxis.renderer.grid.template.location = 0;
            categoryAxis.dataFields.category = "category";
            categoryAxis.renderer.minGridDistance = 1;
            categoryAxis.renderer.inversed = true;
            categoryAxis.renderer.grid.template.disabled = true;
            categoryAxis.renderer.labels.template.fontSize = "0.85em";
            categoryAxis.renderer.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
            categoryAxis.renderer.minGridDistance = 5; //can change label
            categoryAxis.renderer.grid.template.strokeOpacity = 1;
            categoryAxis.renderer.grid.template.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor); 
            categoryAxis.renderer.grid.template.strokeWidth = 1.5;


            //categoryAxis.renderer.cellStartLocation = 0;
            //categoryAxis.renderer.cellEndLocation = 0.7;
            /////////////////
            categoryAxis.renderer.line.strokeOpacity = 1;
            categoryAxis.renderer.line.strokeWidth = 1.5;
            categoryAxis.renderer.line.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);

            // Create value axis

            //////////////

            var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
            valueAxis.min = 0;
            valueAxis.strictMinMax = true;
            valueAxis.calculateTotals = true;
            valueAxis.renderer.minWidth = 50;
            valueAxis.renderer.labels.template.fontSize = 12;
            valueAxis.renderer.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
            valueAxis.renderer.line.strokeOpacity = 1;
            valueAxis.renderer.line.strokeWidth = 1.5;
            valueAxis.renderer.line.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);

            var series = chart.series.push(new am4charts.ColumnSeries());
            series.dataFields.categoryY = "category";
            series.dataFields.valueX = "value";
            series.tooltipText = "{valueX.value}"
            series.columns.template.strokeOpacity = 0;

            var labelBullet = series.bullets.push(new am4charts.LabelBullet())
            labelBullet.label.horizontalCenter = "left";
            labelBullet.label.text = "{values.valueX.workingValue.formatNumber('#')}"; //#.0as for 17k
            labelBullet.locationX = 0.5;
            labelBullet.label.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
            labelBullet.interactionsEnabled = false;
            labelBullet.label.fontSize = 10;

            // Responsive to screen size
            chart.responsive.enabled = true;

            // if useDefault is false, category axis stays outside the chart
            chart.responsive.useDefault = false

            // Add chart title
            var title = chart.titles.create();
            title.text = "Mode of Acquisition"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
            title.fontWeight = "bold";
            title.fontSize = "1em";
            title.fill = "#3ce00a";

            series.columns.template.adapter.add("fill", function(fill, target){
                return chart.colors.getIndex(target.dataItem.index);
            });

            chart.data = [
                {
                    category: "No Need to Acquire",
                    value: noneed
                },
                {
                    category: "CA 141",
                    value: ca141
                },
                {
                    category: "Donation",
                    value: donate
                },
                {
                    category: "Expropriation",
                    value: expro
                },
                {
                    category: "For Negotiation",
                    value: nego
                }
            ]; // End of chart
        }); // End of queryFeatures
    } // End of updateS_MOAChartStructure
    updateMoaChartStructure();

    // ISF Chart
    document.getElementById("pieChartIsfDiv").innerHTML = `Coming Soon..`; 
    async function updateChartISF() {
        var total_relocated_lot = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_relocated_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusRC = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusRC = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusRC = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = reloISFLayer.createQuery();
        query.outStatistics = [total_relocated_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return reloISFLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_relocated_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

            var chart = am4core.create("pieChartIsfDiv", am4charts.PieChart);


            // Add data
            chart.data = [
                {
                    "StatusRC": "Relocated",
                    "status": clear,
                    "color": am4core.color("#00C5FF") //  original: #FF00C5
                },
                {
                    "StatusRC": "Paid",
                    "status": paid,
                    "color": am4core.color("#70AD47")   
                },
                {
                    "StatusRC": "For Payment Processing",
                    "status": payp,
                    "color": am4core.color("#0070FF") 
                },
                {
                    "StatusRC": "For Legal Pass",
                    "status": legalpass,
                    "color": am4core.color("#FFFF00")
                },
                {
                    "StatusRC": "For Appraisal/OtC/Requirements for Other Entitlements",
                    "status": otc,
                    "color": am4core.color("#FFAA00")    
                },
                {
                    "StatusRC": "LBP Account Opening",
                    "status": lbp,
                    "color": am4core.color("#FF0000")    
                }
            ];

                // Set inner radius
            chart.innerRadius = am4core.percent(30);

            // Add and configure Series
            function createSlices(field, status) {
                var pieSeries = chart.series.push(new am4charts.PieSeries());
                pieSeries.dataFields.value = field;
                pieSeries.dataFields.category = status;

                pieSeries.slices.template.propertyFields.fill = "color";
                pieSeries.slices.template.stroke = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);
                pieSeries.slices.template.strokeWidth = 1;
                pieSeries.slices.template.strokeOpacity = 1;

                pieSeries.slices.template.adapter.add("fill", function(fill, target) {
                    var pattern = new am4core.LinePattern();
                    pattern.width = 7;
                    pattern.height = 7;
                    pattern.strokeWidth = 1.5;
                    pattern.stroke = target.dataItem.dataContext.color;
                    pattern.rotation = 135;
                    return pattern;
                });

                pieSeries.slices.template.background.adapter.add("fill", function(fill, target) {
                    return target.dataItem ? target.dataItem.dataContext.color : fill;
                });

                pieSeries.slices.template
                // change the cursor on hover to make it apparent the object can be interacted with
                .cursorOverStyle = [
                    {
                        "property": "cursor",
                        "value": "pointer"
                    }
                ];


                // Hover setting
                pieSeries.tooltip.label.fontSize = 12;
                pieSeries.tooltip.label.fill = dark.disabled ? lightThemeColor: darkThemeColor;

                // Pie
                //pieSeries.alignLabels = false;
                //pieSeries.labels.template.bent = false;
                pieSeries.labels.template.disabled = true;
                pieSeries.labels.template.radius = 3;
                pieSeries.labels.template.padding(0,0,0,0);
                pieSeries.labels.template.fontSize = 9;
                pieSeries.labels.template.fill = "#ffffff";

                // Ticks (a straight line)
                //pieSeries.ticks.template.disabled = true;
                pieSeries.ticks.template.fill = "#ffff00";

                // Create a base filter effect (as if it's not there) for the hover to return to
                var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
                shadow.opacity = 0;

                // Create hover state
                var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

                // Slightly shift the shadow and make it more prominent on hover
                var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
                hoverShadow.opacity = 0.7;
                hoverShadow.blur = 5;


                // Add a legend
                chart.legend = new am4charts.Legend();

                chart.legend.valueLabels.template.align = "right"
                chart.legend.valueLabels.template.textAlign = "end";  

                //chart.legend.position = "bottom";
                chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
                chart.legend.labels.template.fill = dark.disabled ? lightThemeColor : darkThemeColor;
                chart.legend.valueLabels.template.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor);  
                chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
                pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
                chart.legend.itemContainers.template.paddingTop = "2em";
                chart.legend.itemContainers.template.paddingBottom = "2em";

                chart.legend.horizontalGap = 0;
                chart.legend.marginLeft = 0;
                chart.legend.marginRight = 0;

                // Responsive code for chart
                chart.responsive.enabled = true;

                // Chart Title
                /*
                var title = chart.titles.create();
                title.text = "ISF Relocation"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
                title.fontSize = 20;
                title.fontWeight = "bold";
                title.fill = "#ffffff";
                title.marginTop = 5;
                */

                var marker = chart.legend.markers.template.children.getIndex(0);
                var markerTemplate = chart.legend.markers.template;
                marker.cornerRadius(12, 12, 12, 12);
                marker.strokeWidth = 1;
                marker.strokeOpacity = 1;
                marker.stroke = am4core.color("#ccc");

                // Change size of legend marker
                markerTemplate.width = 18;
                markerTemplate.height = 18;
                // This creates initial animation
                //pieSeries.hiddenState.properties.opacity = 1;
                //pieSeries.hiddenState.properties.endAngle = -90;
                //pieSeries.hiddenState.properties.startAngle = -90;

                // Click chart and filter, update maps
                pieSeries.slices.template.events.on("hit", filterByChart, this);
                function filterByChart(ev) {
                    const selectedD = ev.target.dataItem.category;

                    if (selectedD == "Relocated") {
                        selectedStatus = 1;
                    } else if (selectedD == "Paid") {
                        selectedStatus = 2;
                    } else if (selectedD == "For Payment Processing") {
                        selectedStatus = 3;
                    } else if (selectedD == "For Legal Pass") {
                        selectedStatus = 4;
                    } else if (selectedD == "For Appraisal/OtC/Requirements for Other Entitlements") {
                        selectedStatus = 5;
                    } else if (selectedD == "LBP Account Opening") {
                        selectedStatus = 6;
                    } else {
                        selectedStatus = null;
                    }

                    view.when(function() {
                        view.whenLayerView(reloISFLayer).then(function (layerView) {
                            chartLayerView = layerView;

                            reloISFLayer.queryFeatures().then(function(results) {
                                const ggg = results.features;
                                const rowN = ggg.length;

                                let objID = [];
                                for (var i=0; i < rowN; i++) {
                                    var obj = results.features[i].attributes.OBJECTID;
                                    objID.push(obj);
                                }

                                var queryExt = new Query({
                                    objectIds: objID
                                });

                                reloISFLayer.queryExtent(queryExt).then(function(result) {
                                    if (result.extent) {
                                        view.goTo(result.extent)
                                    }
                                });

                                if (highlightSelect) {
                                    highlightSelect.remove();
                                }
                                highlightSelect = layerView.highlight(objID);

                                view.on("click", function() {
                                    layerView.filter = null;
                                    highlightSelect.remove();
                                });

                            }); // End of queryFeatures
                            layerView.filter = {
                                where: "StatusRC = " + selectedStatus
                            }
                        }); // End of view.whenLayerView
                    }); // End of view.when
                } // End of filterByChart
            } // End of createSlices function
            createSlices("status", "StatusRC");
        });  // End of queryFeature                 
    } // End of updateChartISF()
    //updateChartISF();

    // Handed-Over Area Bar chart
    function n01AffectedHandedOverArea(){
        var total_n01_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n01_affected",
            statisticType: "sum"
        };

        var total_n01_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n01_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n01_affected, total_n01_handedover];
        query.where = "CP = 'S-01'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n01_affected;
            const handedover = stats.total_n01_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray1 = [perc]
            return compileArray1
        });
    }

    function n02AffectedHandedOverArea(compileArray1){
        var total_n02_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n02_affected",
            statisticType: "sum"
        };

        var total_n02_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n02_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n02_affected, total_n02_handedover];
        query.where = "CP = 'S-02'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n02_affected;
            const handedover = stats.total_n02_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray2 = [compileArray1[0], perc]
            return compileArray2
        });
    }

    function n03AffectedHandedOverArea(compileArray2){
        var total_n03_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n03_affected",
            statisticType: "sum"
        };

        var total_n03_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n03_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n03_affected, total_n03_handedover];
        query.where = "CP = 'S-03'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n03_affected;
            const handedover = stats.total_n03_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray3 = [compileArray2[0], compileArray2[1], perc]; // handedover

            return compileArray3
        });
    }

    function n04AffectedHandedOverArea(compileArray3){
        var total_n04_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n04_affected",
            statisticType: "sum"
        };

        var total_n04_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n04_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n04_affected, total_n04_handedover];
        query.where = "CP = 'S-04'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n04_affected;
            const handedover = stats.total_n04_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray4 = [compileArray3[0], compileArray3[1], compileArray3[2], perc]; // handedover

            return compileArray4
        });
    }

    function n05AffectedHandedOverArea(compileArray4){
        var total_n05_affected = {
            onStatisticField: "AffectedArea",
            outStatisticFieldName: "total_n05_affected",
            statisticType: "sum"
        };

        var total_n05_handedover = {
            onStatisticField: "HandOverArea",
            outStatisticFieldName: "total_n05_handedover",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_n05_affected, total_n05_handedover];
        query.where = "CP = 'S-05'";
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const affected = stats.total_n05_affected;
            const handedover = stats.total_n05_handedover;
            const perc = ((handedover/affected)*100).toFixed(0);

            const compileArray5 = [compileArray4[0], compileArray4[1], compileArray4[2], compileArray4[3], perc]; // handedover

            return compileArray5
        });
    }
    
    // Now use the above compiled values
    function percentHandedOverLotByCPChart(compileArray5) {
        // S-01
        const n01_perc = compileArray5[0];
        const n01_other = 0;

        // S-02
        const n02_perc = compileArray5[1];
        const n02_other = 0;

        // S-03
        const n03_perc = compileArray5[2];
        const n03_other = 0;

        // S-04
        const n04_perc = compileArray5[3];
        const n04_other = 0;

        // S-05
        const n05_perc = compileArray5[4];
        const n05_other = 0;

        // Chart //
        var chart = am4core.create("pieChartLotDiv", am4charts.XYChart);
        chart.hiddenState.properties.opacity = 0; // this creates initial fade-in

        chart.data = [
            {
                category: "S-05",
                value1: n05_perc,
                value2: 0,
            },
            {
                category: "S-04",
                value1: n04_perc,
                value2: 0,
            },
            {
                category: "S-03",
                value1: n03_perc,
                value2: 0,
            },
            {
                category: "S-02",
                value1: n02_perc,
                value2: 0,
            },
            {
                category: "S-01",
                value1: n01_perc,
                value2: 0,
            }
        ];

        chart.colors.step = 2;
        chart.padding(10, 10, 10, 10);
        // Legend
        chart.legend = new am4charts.Legend();
        //chart.legend.labels.template.disabled = true;
        chart.legend.disabled = true;
        chart.legend.valueLabels.template.align = "right"
        chart.legend.valueLabels.template.textAlign = "end";  

        chart.legend.position = "bottom";
        chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
        chart.legend.labels.template.fill = dark.disabled ? lightThemeColor: darkThemeColor;
        chart.legend.valueLabels.template.fill = dark.disabled ? am4core.color(lightThemeColor) : am4core.color(darkThemeColor); 
        chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE;

        // Responsive to screen size
        chart.responsive.enabled = true;

        // if useDefault is false, category axis stays outside the chart
        chart.responsive.useDefault = false

        // Chart Title
        var title = chart.titles.create();
        title.text = "Handed-Over Area"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
        title.fontSize = "1.1em";
        title.fontWeight = "bold";
        title.fill = dark.disabled ? lightThemeColor: darkThemeColor;


        var marker = chart.legend.markers.template.children.getIndex(0);
        var markerTemplate = chart.legend.markers.template;
        marker.cornerRadius(12, 12, 12, 12);
        marker.strokeWidth = 1;
        marker.strokeOpacity = 1;
        marker.stroke = am4core.color("#ccc");

        // Change size of legend marker
        markerTemplate.width = 16;
        markerTemplate.height = 16;

        // Add chart title
        //  var title = chart.titles.create();
        //title.text = "Construction Progress"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
        //title.fontSize = 20;
        //title.fill = "#3ce00a";


        var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
        categoryAxis.dataFields.category = "category";
        categoryAxis.renderer.grid.template.location = 0;
        categoryAxis.renderer.labels.template.fontSize = "1em";
        categoryAxis.renderer.labels.template.fill = dark.disabled ? lightThemeColor: darkThemeColor;
        categoryAxis.renderer.minGridDistance = 5; //can change label

        var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
        valueAxis.min = 0;
        valueAxis.max = 100;
        valueAxis.strictMinMax = true;
        valueAxis.calculateTotals = true;
        valueAxis.renderer.minWidth = 50;
        valueAxis.renderer.labels.template.fontSize = 0;
        valueAxis.renderer.labels.template.fill = "#ffffff";


        function createSeries(field, name) {
        var series = chart.series.push(new am4charts.ColumnSeries());
        series.calculatePercent = true;
        series.dataFields.valueX = field;
        series.dataFields.categoryY = "category";
        series.stacked = true;
        series.dataFields.valueXShow = "totalPercent";
        //series.calculatePercent = false;
        series.dataItems.template.locations.categoryY = 0.5;

        // Bar chart line color and width
        series.columns.template.stroke = am4core.color("#ffffff");
        series.columns.template.strokeWidth = 1.5;
        series.name = name;

        var labelBullet = series.bullets.push(new am4charts.LabelBullet());

        if (name == "Handed-Over"){
            series.fill = am4core.color("#0070ff");

            labelBullet.locationX = 0.5;
            labelBullet.label.text = "{valueX.formatNumber('#.')}%";
            //labelBullet.label.fill = am4core.color("#00FFFFFF");
            labelBullet.label.fill = am4core.color("#FFFFFF");
            labelBullet.interactionsEnabled = false;
            labelBullet.label.fontSize = "1em";
            labelBullet.locationX = 0.5;

        } else if (name == "Affected Area"){
            series.fill = am4core.color("#000000");
            labelBullet.locationX = 0.5;
            labelBullet.label.text = "{valueX.totalPercent.formatNumber('#.')}%";
            labelBullet.label.fill = am4core.color("#FF000000");
            labelBullet.interactionsEnabled = false;
            labelBullet.label.fontSize = 20;
            labelBullet.locationX = 0.5;
        } 
        series.columns.template.width = am4core.percent(60);
        series.columns.template.tooltipText = "[font-size:15px]{name}: {valueX.value.formatNumber('#.')}"

        // Click chart and filter, update maps


        } // End of createSeries function

        createSeries("value1", "Handed-Over");
        createSeries("value2", "Affected Area");

    } // end of updateChart()  

        async function combinedAffectedHandedOverAreaChart() {
            n01AffectedHandedOverArea()
            .then(n02AffectedHandedOverArea)
            .then(n03AffectedHandedOverArea)
            .then(n04AffectedHandedOverArea)
            .then(n05AffectedHandedOverArea)
            .then(percentHandedOverLotByCPChart)
        }


      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "SC LAND ACQUISITION";
        document.querySelector("#item-description").innerHTML = `1. You can opt for either <b>light theme or dark theme</b> for a window screen via a switch icon in the upper right.<br>
                                                                 2. You can <b>filter the data</b> by City, Barangy, and expected hand-over date using dropdown lits.<br>
                                                                 3. You can view summary statistics and progress on acquisition of land/structure in charts.<br>
                                                                 4. <b>Click pie chart</b> to view lots/structures on the map corresponding to the selected progress.<br>
                                                                 5. <b>Lots under expropriation</b> is available in the 'Expro List' tab under the theme switch.<br>
                                                                 6. Click/unclick widgets icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                                 7. <b>Toggle a checkbox</b> above the Land pie chart to view <b>handed-over areas</b> (m2) of CPs.`
                                                                 ;
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;

        const toggleThemes = () => {
          // Calcite theme
          document.body.classList.toggle("calcite-theme-dark");
          // ArcGIS Maps SDK theme
          const dark = document.querySelector("#arcgis-maps-sdk-theme-dark");
          const light = document.querySelector("#arcgis-maps-sdk-theme-light");

          // Negate the 'disabled' attribute on both stylesheets to toggle their boolean values
          dark.disabled = !dark.disabled;
          light.disabled = !light.disabled;
          // ArcGIS Maps SDK basemap
          map.basemap = dark.disabled ? "gray-vector" : "dark-gray-vector";

          // Change the title color by theme
          totalNumberOfLots();
          updateChartLot();
          updateMoaChartLot()
          pteNumberLot();
          updateChartStructure();
          totalNumberOfStructures();
          updateMoaChartStructure();
          pteNumberStructure();
          //updateChartISF();
          

          const dropdownMunicipalLabel = document.getElementById("dropdownMunicipalLabel");
          const dropdownBarangayLabel = document.getElementById("dropdownBarangayLabel");
          const dropdownHandOverDateLabel = document.getElementById("dropdownHandOverDateLabel");

          dropdownMunicipalLabel.style.color = dark.disabled ? "black" : "white";
          dropdownBarangayLabel.style.color = dark.disabled ? "black" : "white";
          dropdownHandOverDateLabel.style.color = dark.disabled ? "black" : "white";
        };

        document.querySelector("calcite-switch").addEventListener("calciteSwitchChange", toggleThemes);
     
    // chart switch between land acquisition pie chart and handed-over area bar graph
    let CountButtonHomeClicks = 0;
    const toggleChart = () => {
        CountButtonHomeClicks += 1;

        if (CountButtonHomeClicks === 1) {
            combinedAffectedHandedOverAreaChart();
        } else {
            const result = (CountButtonHomeClicks % 2  == 0) ? "even" : "odd";
            result == "even" ? updateChartLot() : combinedAffectedHandedOverAreaChart();
        }       
    };
    document.querySelector(".chartChange").addEventListener("calciteSwitchChange", toggleChart);

    // Switch between Occupancy (structure) and ISF point features
    document.querySelector("#thetabs").addEventListener("click", tabChange);
    function tabChange(event) {
        const value = event.target.className;
        
        if (value === 'ISF') {
            reloISFLayer.visible = true;
            relocationPtLayer.visible = false;
            
        } else if (value === 'Land' || value === 'Structure' || value === 'ExproList' ){
            reloISFLayer.visible = false;
            relocationPtLayer.visible = true;
        }
    }
    }); // end of view.when

      });// End of am4chart

      
      // Widgets
      
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "Chainage" || item.title === "Pier No." || item.title === "Free-and-Clear Area" || item.title === "Orthophoto"){
            item.visible = false
          }
        }
      });
      
      const legend = new Legend({
        view,
        container: "legend-container"
      });

      const locate = new Locate({
        view: view,
        container: "locate-container"
      });

      var searchWidget = new Search({
        view: view,
        container: "search-container",
        locationEnabled: false,
        allPlaceholder: "LotID, StructureID, Chainage",
        includeDefaultSources: false,
        sources: [
            {
                layer: lotLayer,
                searchFields: ["LotID"],
                displayField: "LotID",
                exactMatch: false,
                outFields: ["LotID"],
                name: "Lot ID",
                placeholder: "example: 10083"
            },
            {
                layer: structureLayer,
                searchFields: ["StrucID"],
                displayField: "StrucID",
                exactMatch: false,
                outFields: ["StrucID"],
                name: "Structure ID",
                placeholder: "example: MCRP-01-02-ML022"
            },
            {
                layer: chainageLayer,
                searchFields: ["KmSpot"],
                displayField: "KmSpot",
                exactMatch: false,
                outFields: ["*"],
                name: "Main KM",
                placeholder: "example: 80+400"
            },
            {
                layer: PierNoLayer,
                searchFields: ["PIER"],
                displayField: "PIER",
                exactMatch: false,
                outFields: ["PIER"],
                name: "Pier No",
                zoomScale: 1000,
                placeholder: "example: P-288"
            }
        ]
        });

        view.ui.empty("top-left");

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",
            group: "top-right"
        });
        view.ui.add(searchExpand, {
            position: "top-right"
        });

        searchExpand.watch("expanded", function() {
            if(!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });


    });
  </script>
</html>