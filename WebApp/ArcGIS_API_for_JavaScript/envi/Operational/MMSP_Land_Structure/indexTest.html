<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MMSP Land Acquisition: mapping app</title>
    
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    
    <script src="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.css" />

    <script src="https://js.arcgis.com/4.25/"></script>
    <link disabled id="arcgis-maps-sdk-theme-dark" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css" />
    <link id="arcgis-maps-sdk-theme-light" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tab {
        height: 83vh;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    
    #chartPanel {
        background-color: rgb(0, 0, 0, 0);
        padding: 10;
    }
    
    #pieChartDiv {
      width: 100%;
      height: 45%;
      align-items: center;
      padding: 1%;
    }

        /* Radio Button for handed-over lots */
    #item-a {
        padding-top: 0;
        margin-left: 90%;
    }
    
    #lotStructureNumberDiv,
    #handedOverLotNumberDiv {
      color: rgb(0, 197, 255);
      text-align: center;
      font-weight: normal;
      font-size: 1.5vw;
      height: 8vh;
      margin-top: 10;
      padding-top: 5;
      border: solid 0.5px gray;
    }

    /* Expropriation List */
    .panel-side li {
      padding: 3% 5%;
    }

    .panel-side li b{
      color: red;
      font-size: 0.8vw;
    }

    .panel-result {
      cursor: pointer;
      margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
      background-color: rgba(73, 72, 72, 0.5);
    }

    #expropriationListDiv {
      list-style: none;
      padding: 3% 5%;
      font-size: 0.8vw;
      width: 17vw;
      height: 88vh;
    }


    /* MOA Chart for Lot */
    #chartMoaDiv {
        width: 100%;
        height: 28%;
        align-items: center;
        padding: 5;
    }

    b {
        font-size: 1.0vw;
        padding-top: 1%;
        font-family: 'Calibri';
        font-weight: bold;
        color:rgb(250, 246, 246);
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
    
  </style>
  <body class="sassy-theme">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      
       <!--  Header slot  -->
      <div slot="header" id="header">
        
      <!-- Title -->
      <h2 id="header-title" slot="header"></h2>
        
      <!-- Controls -->
        <div id="header-controls">
          <!-- Dark Mode Switch -->
          <calcite-label layout="inline" class="label-wrapper">
            <calcite-icon icon="brightness" scale="s" class="switch-icon"></calcite-icon>
            <calcite-switch></calcite-switch>
            <calcite-icon icon="moon" scale="s" class="switch-icon"></calcite-icon>
          </calcite-label>
        </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="bookmarks" icon="bookmark" text="Bookmarks"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>
        <calcite-panel heading="Bookmarks" height-scale="l" data-panel-id="bookmarks" hidden>
          <div id="bookmarks-container"></div>
        </calcite-panel>

        
        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Details" data-panel-id="information" hidden>
          <div id="info-content">
            <img id="item-thumbnail" alt="webmap thumbnail" />
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
            <calcite-label layout="inline">
              <b>Rating:</b>
              <calcite-rating id="item-rating" read-only>
                <!-- Dynamically populated -->
              </calcite-rating>
            </calcite-label>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="viewDiv">
        <!-- Chart Panel -->
        <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
        <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
        <calcite-tabs>
            <div id="chartPanel">
                <calcite-tab-nav slot="tab-nav">
                    <calcite-tab-title selected>Land</calcite-tab-title>
                    <calcite-tab-title>Structure</calcite-tab-title>
                    <calcite-tab-title>Expro List</calcite-tab-title>
                </calcite-tab-nav>
                <calcite-tab>
                    <div id="pieChartDiv"></div>
                    <div id="lotStructureNumberDiv"></div>
                    <div id="chartMoaDiv"></div>
                    <div id="handedOverLotNumberDiv">
                        <calcite-label html-for="item-a" layout="inline">
                            <calcite-radio-button id="item-a" name="preferred-feature" value="HandedOver" checked>
                            </calcite-radio-button>
                        </calcite-label>
                    </div>
                </calcite-tab>
                <calcite-tab>Tab 2 content</calcite-tab>
                <calcite-tab>
                  <div class="panel-side esri-widget">
                    <ul id="expropriationListDiv">
                      <li>Loading&hellip;</li>
                    </ul>
                  </div>
                </calcite-tab>
            </div>
        </calcite-tabs>
       </div>

    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
    ], function(WebMap, MapView, Map, FeatureLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle
                 ) {
      
    var map = new Map({
        basemap: "gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new MapView({
        map: map,
        center: [121.0194387, 14.6972616],
        zoom: 14,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    const LOT_LABEL_CLASS = {
        symbol: {
            type: "text",  // autocasts as new TextSymbol()
            color: "black",
            font: {  // autocast as new Font()
                family: "Gill Sans",
                size: 8
            }
        },
        labelPlacement: "always-horizontal",
        labelExpressionInfo: {
            expression: "$feature.CN"
        }
    };
      
    let lotDefaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };

    let lotLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: lotDefaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusNVS3 == 1, '1',$feature.StatusNVS3 == 2, '2', $feature.StatusNVS3 == 3, '3', \
                        $feature.StatusNVS3 == 4, '4', $feature.StatusNVS3 == 5, '5', \
                        $feature.StatusNVS3 == 6, '6', $feature.StatusNVS3)",
        uniqueValueInfos: [
            {
                // All features with value of "North" will be blue
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "6",
                label: "with WOP Fully Turned-over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[6],
                }
            }
        ]
    }
      
    function colorLotReqs(){
        return {
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,115,76]
        }
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
          id: "5a0b175a1f214b5394e26ff554bf8b79"
        },
        layerId: 15,
        outFields: ["*"],
        title: "Status of Land Acquisition",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotLayerRenderer,
        popupTemplate: {
            title: "<p>{Id}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "OWNER",
                            label: "Land Owner"
                        },
                        {
                            fieldName: "Station1"
                        },
                        {
                            fieldName: "StatusNVS3",
                            label: "<p>Status of Land Acquisition</p>"
                        }
                    ]
                }
            ]
        }
    });
    map.add(lotLayer);
      
      
      // Zoome
      /* Define Zooming Function */
      function zoomToLayer(layer) {
        return layer.queryExtent().then(function(response) {
          view.goTo(response.extent, { //response.extent
            speedFactor: 2,
            zoom: 17
          }).catch(function(error) {
            if (error.name != "AbortError") {
              console.error(error);
            }
          });
        });
      }
      
      // Structure Layer----------------------------------





      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;
      
      const lotStructureNumberDiv = document.getElementById("lotStructureNumberDiv");
      const handedOverLotNumberDiv = document.getElementById("handedOverLotNumberDiv");
      
      am4core.ready(function() {
        am4core.useTheme(am4themes_animated);
        // Expropriation List----------------------------------
        
        view.when(function() {
            var expropriationList = document.getElementById("expropriationListDiv");
            
            // Obtain a list of Owner's names and status
            view.whenLayerView(lotLayer).then(function(exprolayerView) {
                exprolayerView.watch("updating", function(val) {
                    if (!val) {
                        // Query for only Expropriation lots
                        var query = new Query();
                        query.where = "StatusNVS3 = 5";
                        exprolayerView.queryFeatures(query).then(function(result) {
                            expropriationList.innerHTML = "";
                            result.features.forEach(function(feature) {
                                var attributes = feature.attributes;
                                var li = document.createElement("li");
                                li.setAttribute("class", "panel-result");
                                
                                const status = attributes.StatusNVS3;
                                if (status == 5) {
                                    statusla = "Expropriation"
                                }
                                
                                // Add Expropriation lots to list
                                li.innerHTML = "<b>" + attributes.ID + "</b>" + "<br>" + attributes.OWNER + "</br>";

                                li.addEventListener("click", function(event) {
                                    var target = event.target;
                                    var objectId = feature.attributes.OBJECTID;
                                    var queryExtent = new Query({
                                        objectIds: [objectId]
                                    });
                                    
                                    // Query extent for selected expropriation lot in the list
                                    exprolayerView.queryExtent(queryExtent).then(function(result) {
                                        if (result.extent) {
                                            view.goTo({
                                                target: result.extent,
                                                speedFactor: 2,
                                                zoom: 17})
                                                .catch(function(error) {
                                                    if (error.name != "AbortError") {
                                                        console.error(error);
                                                    }
                                                }); // End of catch
                                            } // End of if (result.extent)
                                        }); // End of layerView.queryExtent
                                        
                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function() {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    expropriationList.appendChild(li);
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()



        // Thousand separators function
        function thousands_separators(num) {
          var num_parts = num.toString().split(".");
          num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return num_parts.join(".");
        }
        
        // 1. Total Number of Lots
        function totalNumberOfLots(){
          var totalLot = {
            onStatisticField: "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalLot",
            statisticType: "sum"
          };
          var query = lotLayer.createQuery();
          query.outStatistics = [totalLot];
          query.returnGeometry = true;

          return lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;
            const LOT_TOTAL = stats.totalLot;
            return LOT_TOTAL;
          });
        }

        // Total number of Lots
        function totalNumberOfLotsAll(totalLotValue){
         var totalLot = {
           onStatisticField: "ID",
           outStatisticFieldName: "totalLot",
           statisticType: "count"
         };
         var query = lotLayer.createQuery();
         query.outStatistics = [totalLot];
         query.returnGeometry = true;

         lotLayer.queryFeatures(query).then(function(response){
           var stats = response.features[0].attributes;
           const LOT_TOTAL = stats.totalLot;
           const totalValue = thousands_separators(LOT_TOTAL) + " (" + totalLotValue + ")";
           lotStructureNumberDiv.innerHTML = `<b>Number of Lots</b><br><br>${totalValue}`
         });
       }
        totalNumberOfLots().then(totalNumberOfLotsAll);

        // Total number of handed-over lots
        function handedOverNumberLot(){
            var totalHandedOverLot = {
                onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "totalHandedOverLot",
                statisticType: "sum"
            }
            var query = lotLayer.createQuery();
            query.outStatistics = [totalHandedOverLot];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function(response){
                var stats = response.features[0].attributes;

                const HAND_OVER_TOTAL = thousands_separators(stats.totalHandedOverLot);
                handedOverLotNumberDiv.innerHTML = `<b>Number of Handed-Over</b><br><br>${HAND_OVER_TOTAL}`;
            });
        }
        handedOverNumberLot();
        
        // Lot Chart
        
        function updateChartLot() {
        // First, define statuses
        function Status_Name_Lot(){
          return {
            1: "Paid",
            2: "For Payment Processing",
            3: "For Legal Pass",
            4: "For Appraisal/Offer to Buy",
            5: "For Expro",
            6: "with WOP Fully Turned-over"
          }
        }

        var totalPaidLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalPaidLot",
        statisticType: "sum"
        };

        var totalpaypLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalpaypLot",
        statisticType: "sum"
        };

        var totalLegalpassLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalLegalpassLot",
        statisticType: "sum"
        };

        var totalOtbLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalOtbLot",
        statisticType: "sum"
        };

        var totalExproLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalExproLot",
        statisticType: "sum"
        };

        var totalDismissalLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalDismissalLot",
        statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [totalPaidLot, totalpaypLot, totalLegalpassLot,
                           totalOtbLot, totalExproLot, totalDismissalLot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const PAID = stats.totalPaidLot;
        const PAYP = stats.totalpaypLot;
        const LEGALPASS = stats.totalLegalpassLot;
        const OTB = stats.totalOtbLot;
        const EXPRO = stats.totalExproLot;
        const DISMISSAL = stats.totalDismissalLot;

        var chart = am4core.create("pieChartDiv", am4charts.PieChart);

        // Add data
        chart.data = [
        {
          "StatusNVS3": Status_Name_Lot()[1],
          "status": PAID,
          "color": am4core.color("#70AD47")
        },
        {
          "StatusNVS3": Status_Name_Lot()[2],
          "status": PAYP,
          "color": am4core.color("#0070FF")   
        },
        {
          "StatusNVS3": Status_Name_Lot()[3],
          "status": LEGALPASS,
          "color": am4core.color("#FFFF00") 
        },
        {
          "StatusNVS3": Status_Name_Lot()[4],
          "status": OTB,
          "color": am4core.color("#FFAA00")
        },
        {
         "StatusNVS3": Status_Name_Lot()[5],
          "status": EXPRO,
          "color": am4core.color("#FF0000")    
        },
        {
          "StatusNVS3": Status_Name_Lot()[6],
         "status": DISMISSAL,
         "color": am4core.color("#00734C")    
        }
        ];

        // Set inner radius
        chart.innerRadius = am4core.percent(30);

        // Add and configure Series
        function createSlices(field, status){
        var pieSeries = chart.series.push(new am4charts.PieSeries());
        pieSeries.dataFields.value = field;
        pieSeries.dataFields.category = status;

        pieSeries.slices.template.propertyFields.fill = "color";
        pieSeries.slices.template.stroke = am4core.color("#fff");
        pieSeries.slices.template.strokeWidth = 1;
        pieSeries.slices.template.strokeOpacity = 1;
        pieSeries.slices.template
        // change the cursor on hover to make it apparent the object can be interacted with
        .cursorOverStyle = [
          {
            "property": "cursor",
            "value": "pointer"
          }
        ];

        // Hover setting
        pieSeries.tooltip.label.fontSize = 9;

        // Pie
        //pieSeries.alignLabels = false;
        //pieSeries.labels.template.bent = false;
        pieSeries.labels.template.disabled = true;
        pieSeries.labels.template.radius = 3;
        pieSeries.labels.template.padding(0,0,0,0);
        pieSeries.labels.template.fontSize = 9;
        pieSeries.labels.template.fill = "#ffffff";

        // Ticks (a straight line)
        //pieSeries.ticks.template.disabled = true;
        pieSeries.ticks.template.fill = "#ffff00";

        // Create a base filter effect (as if it's not there) for the hover to return to
        var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
        shadow.opacity = 0;

        // Chart Title
        let title = chart.titles.create();
        title.text = "Land Acquisition";
        title.fontSize = "1.2em";
        title.fontWeight = "bold";
        title.fill = am4core.color("#ffffff");
        title.marginTop = 7;

        // Create hover state
        var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

        // Slightly shift the shadow and make it more prominent on hover
        var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
        hoverShadow.opacity = 0.7;
        hoverShadow.blur = 5;

        // Add a legend
        const LEGEND_FONT_SIZE = "0.9em";
        chart.legend = new am4charts.Legend();
        chart.legend.valueLabels.template.align = "right"
        chart.legend.valueLabels.template.textAlign = "end";

        //chart.legend.position = "bottom";
        chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
        chart.legend.labels.template.fill = "#ffffff";
        chart.legend.valueLabels.template.fill = am4core.color("#ffffff"); 
        chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
        pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
        //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";
        chart.legend.itemContainers.template.paddingTop = "2em";
        chart.legend.itemContainers.template.paddingBottom = "2em";

        // Responsive code for chart
        chart.responsive.enabled = true;
 
        /// Define marker symbols properties
        var marker = chart.legend.markers.template.children.getIndex(0);
        var markerTemplate = chart.legend.markers.template;
        marker.cornerRadius(12, 12, 12, 12);
        marker.strokeWidth = 1;
        marker.strokeOpacity = 1;
        marker.stroke = am4core.color("#ccc");
        markerTemplate.width = 18;
        markerTemplate.height = 18;

        // This creates initial animation
        //pieSeries.hiddenState.properties.opacity = 1;
        //pieSeries.hiddenState.properties.endAngle = -90;
        //pieSeries.hiddenState.properties.startAngle = -90;

        // Click chart and filter, update maps
        pieSeries.slices.template.events.on("hit", filterByChart, this);
        function filterByChart(ev) {
          const SELECTED = ev.target.dataItem.category;
          if (SELECTED == Status_Name_Lot()[1]) {
            selectedStatus = 1;
          } else if (SELECTED == Status_Name_Lot()[2]) {
            selectedStatus = 2;
          } else if (SELECTED == Status_Name_Lot()[3]) {
            selectedStatus = 3;
          } else if (SELECTED == Status_Name_Lot()[4]) {
            selectedStatus = 4;
          } else if (SELECTED == Status_Name_Lot()[5]) {
            selectedStatus = 5;
          } else if (SELECTED == Status_Name_Lot()[6]) {
            selectedStatus = 6;
          } else {
            selectedStatus = null;
          }

          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              chartLayerView = layerView;

              lotLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusNVS3 = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        } // End of filterByChart
        } // End of createSlices function

        createSlices("status", "StatusNVS3");

        //return TOTAL_NUMBER_LOTS;
        }); // End of queryFeatures
        } // End of updateChartLot()
        updateChartLot();

        // ----------------- BAR CHART FOR MOA LOT ----------------- //
        function updateMoaChartLot() {
        var totalNVSLot = {
        onStatisticField: "CASE WHEN MOA = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalNVSLot",
        statisticType: "sum"
        };

        var totalExproLot = {
        onStatisticField: "CASE WHEN MOA = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalExproLot",
        statisticType: "sum"
        };

        var totalRowuaLot = {
        onStatisticField: "CASE WHEN MOA = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalRowuaLot",
        statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [totalNVSLot, totalExproLot, totalRowuaLot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const NVS = stats.totalNVSLot;
        const EXPRO = stats.totalExproLot;
        const ROWUA = stats.totalRowuaLot;

        var chart = am4core.create("chartMoaDiv", am4charts.XYChart);
        chart.hiddenState.properties.opacity = 0;
        chart.padding(10, 10, 10, 10);

        var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
        categoryAxis.renderer.grid.template.location = 0;
        categoryAxis.dataFields.category = "category";
        categoryAxis.renderer.minGridDistance = 1;
        categoryAxis.renderer.inversed = true;
        categoryAxis.renderer.grid.template.disabled = true;
        categoryAxis.renderer.labels.template.fontSize = 11;
        categoryAxis.renderer.labels.template.fill = "#ffffff";
        categoryAxis.renderer.minGridDistance = 5; //can change label
        categoryAxis.renderer.grid.template.strokeOpacity = 1;
        categoryAxis.renderer.grid.template.stroke = am4core.color("#FFFFFF");
        categoryAxis.renderer.grid.template.strokeWidth = 1.5;

        //categoryAxis.renderer.cellStartLocation = 0;
        //categoryAxis.renderer.cellEndLocation = 0.7;

        categoryAxis.renderer.line.strokeOpacity = 1;
        categoryAxis.renderer.line.strokeWidth = 1.5;
        categoryAxis.renderer.line.stroke = am4core.color("#FFFFFF");

        // Create value axis
        var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
        valueAxis.min = 0;
        valueAxis.strictMinMax = true;
        valueAxis.calculateTotals = true;
        valueAxis.renderer.minWidth = 50;
        valueAxis.renderer.labels.template.fontSize = 12;
        valueAxis.renderer.labels.template.fill = "#ffffff";
        valueAxis.renderer.line.strokeOpacity = 1;
        valueAxis.renderer.line.strokeWidth = 1.5;
        valueAxis.renderer.line.stroke = am4core.color("#FFFFFF");

        var series = chart.series.push(new am4charts.ColumnSeries());
        series.dataFields.categoryY = "category";
        series.dataFields.valueX = "value";
        series.tooltipText = "{valueX.value}"
        series.columns.template.strokeOpacity = 0;

        // Responsive code: 
        chart.responsive.enabled = true;

        // Click chart and filer 
        //const CHART_ELEMENT = document.getElementById("chartPanel");
        series.columns.template.events.on("hit", filterByChart, this);
        function filterByChart(ev) {
        const SELECTED = ev.target.dataItem.categoryY;

        if (SELECTED == "1-NVS") {
        selectedStatus = 1;
        } else if (SELECTED == "2-Expropriation") {
        selectedStatus = 2;
        } else if (SELECTED == "3-ROWUA") {
        selectedStatus = 3;
        }
        view.whenLayerView(lotLayer).then(function (layerView) {
        chartLayerView = layerView;
        //CHART_ELEMENT.style.visibility = "visible";

        lotLayer.queryFeatures().then(function(results) {
            const RESULT_LENGTH= results.features;
            const ROW_N= RESULT_LENGTH.length;

            let objID = [];
            for (var i=0; i< ROW_N; i++) {
            var obj = results.features[i].attributes.OBJECTID;
            objID.push(obj);
            }
            
            var queryExt = new Query({
            objectIds: objID
            });

            if (highlightSelect) {
            highlightSelect.remove();
            }
            highlightSelect = layerView.highlight(objID);

            view.on("click", function() {
            layerView.filter = null;
            highlightSelect.remove();
            });
        });
        }); // End of whenLayerView

        chartLayerView.filter = {
        where: "MOA = " + selectedStatus
        //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
        };
        }; // End of filterByChart

        var labelBullet = series.bullets.push(new am4charts.LabelBullet())
        labelBullet.label.horizontalCenter = "left";
        labelBullet.label.text = "{values.valueX.workingValue.formatNumber('#')}"; //#.0as for 17k
        labelBullet.locationX = 0.5;
        labelBullet.label.fill = am4core.color("#ffffff");
        labelBullet.interactionsEnabled = false;
        labelBullet.label.fontSize = 14;

        // Add chart title
        var title = chart.titles.create();
        title.text = "Mode of Acquisition"; // [#00ff00]world[/], Hello [font-size: 30px]world[/]
        title.fontWeight = "bold";
        title.fontSize = "1em";
        title.fill = "#3ce00a";

        series.columns.template.adapter.add("fill", function(fill, target){
        return chart.colors.getIndex(target.dataItem.index);
        });

        chart.data = [
        {
        category: "1-NVS",
        value: NVS
        },
        {
        category: "2-Expropriation",
        value: EXPRO
        },
        {
        category: "3-ROWUA",
        value: ROWUA
        }
        ]; // End of chart
        }); // End of queryFeatures
        } // End of updateMOAChartLot

        updateMoaChartLot();



        
      
      });// End of am4chart

      
      // Widgets
      
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const bookmarks = new Bookmarks({
        view,
        container: "bookmarks-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "BSS Boundary" || item.title === "BSS Building" || item.title === "Depot Building"){
            item.visible = false
          }
        }
      });
      
      const legend = new Legend({
        view,
        container: "legend-container"
      });
      
      /*
      const print = new Print({
        view,
        container: "print-container"
      });
      */
    
      
      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "MMSP LAND ACQUISITION";
        document.querySelector("#item-description").innerHTML = "<b>Test Description</b>";
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;

        const toggleThemes = () => {
          // Calcite theme
          document.body.classList.toggle("calcite-theme-dark");
          // ArcGIS Maps SDK theme
          const dark = document.querySelector("#arcgis-maps-sdk-theme-dark");
          const light = document.querySelector("#arcgis-maps-sdk-theme-light");
          dark.disabled = !dark.disabled;
          light.disabled = !light.disabled;
          // ArcGIS Maps SDK basemap
          map.basemap = dark.disabled ? "gray-vector" : "dark-gray-vector";
        };

        document.querySelector("calcite-switch").addEventListener("calciteSwitchChange", toggleThemes);

      }); // end of view.when



    });
  </script>
</html>