<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Get started with MapView - Create a 2D map - 4.3</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    
    .dds {
      position: absolute;
      right: 10px;
      top: 10px;
    }

    #dropdownDiv {
    background-color: black;
    opacity: 1;
    color: white;
    font-weight: bold;
}

  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/dark/main.css">
  <script src="https://js.arcgis.com/4.21/"></script>

  <script>
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/tasks/support/Query",
        "esri/tasks/QueryTask"
      ],
      function(
        Map, MapView,
        FeatureLayer,
        Query,
        QueryTask
      ) {

        var statesURL = "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/3"

        var subRegionSelect = document.getElementById("subRegion");
        var stateNameSelect = document.getElementById("stateName");

        var statesLayer = new FeatureLayer({
          url: statesURL,
          outFields: ["SUB_REGION", "STATE_NAME"],
          visible: true
        });

        var map = new Map({
          basemap: "gray",
          layers: [statesLayer]
        });

        var view = new MapView({
          container: "viewDiv", // Reference to the scene div created in step 5
          map: map, // Reference to the map object created before the scene
          zoom: 4, // Sets the zoom level based on level of detail (LOD)
          center: [-96.01956, 39.967514] // Sets the center point of view in lon/lat
        });

        view.then(function() {
            return statesLayer.when(function() {
              var subRegionQuery = statesLayer.createQuery();
              subRegionQuery.where = "1=1";
              subRegionQuery.outFields = ["SUB_REGION"];
              subRegionQuery.returnDistinctValues = true;
              subRegionQuery.orderByFields = ["SUB_REGION"];
              return statesLayer.queryFeatures(subRegionQuery);
            });
          }).then(getValues)
            .then(getUniqueValues)
            .then(addToSelect);

        function getValues(response) {
            var features = response.features;
            var values = features.map(function(feature) {
                return feature.attributes.SUB_REGION;
            });
            return values;
        }

        function getUniqueValues(values) {
    var uniqueValues = [];

    values.forEach(function(item, i) {
        if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
            uniqueValues.push(item);
        }
    });
    return uniqueValues;
}
        
        // Add the unique values to the subregion
        // select element. This will allow the user
        // to filter states by subregion.
        function addToSelect(values) {
          var option = document.createElement("option");
          option.text = "";
          subRegionSelect.add(option);

          values.features.forEach(function(value) {
            var option = document.createElement("option");
            option.text = value.attributes.SUB_REGION;
            subRegionSelect.add(option);
          });
        }

        // Add the unique values to the state
        // select element. This will allow the user
        // to filter states by state and region.
        function addToSelect2(values) {
          var option = document.createElement("option");
          option.text = "";
          stateNameSelect.add(option);

          values.features.forEach(function(value) {
            var option = document.createElement("option");
            option.text = value.attributes.STATE_NAME;
            stateNameSelect.add(option);
          });
        }

        function setDefinitionExpression() {
          var strregion = subRegionSelect.options[subRegionSelect.selectedIndex].value;
          var strstate = stateNameSelect.options[stateNameSelect.selectedIndex].value;
          if (strregion !== "" && strstate !== "") {
            statesLayer.definitionExpression = "SUB_REGION = '" + strregion + "' AND STATE_NAME = '" + strstate + "'";
          } else if (strregion !== "") {
            statesLayer.definitionExpression = "SUB_REGION = '" + strregion + "'";
          } else if (strstate !== "") {
            statesLayer.definitionExpression = "STATE_NAME = '" + strstate + "'";
          }

          if (!statesLayer.visible) {
            statesLayer.visible = true;
          }
        }

        subRegionSelect.addEventListener("change", function() {
            var type = event.target.value;

var i;
for (i = stateNameSelect.options.length - 1; i >= 0; i--) {
  stateNameSelect.remove(i);
}

var subRegionQuery = new Query();
subRegionQuery.where = "SUB_REGION = '" + type + "'";
subRegionQuery.outFields = ["STATE_NAME"];
subRegionQuery.returnDistinctValues = true;
subRegionQuery.orderByFields = ["STATE_NAME"];
return statesLayer.queryFeatures(subRegionQuery).then(addToSelect2);
setDefinitionExpression();
        });

        stateNameSelect.addEventListener("change", function() {
            var type = event.target.value;
          setDefinitionExpression();
        });



        /*
        on(subRegionSelect, "change", function(evt) {
          var type = evt.target.value;

          var i;
          for (i = stateNameSelect.options.length - 1; i >= 0; i--) {
            stateNameSelect.remove(i);
          }

          var subRegionQuery = new Query();
          subRegionQuery.where = "SUB_REGION = '" + type + "'";
          subRegionQuery.outFields = ["STATE_NAME"];
          subRegionQuery.returnDistinctValues = true;
          subRegionQuery.orderByFields = ["STATE_NAME"];
          return statesLayer.queryFeatures(subRegionQuery).then(addToSelect2);
          setDefinitionExpression();
        })

        on(stateNameSelect, "change", function(evt) {
          var type = evt.target.value;
          setDefinitionExpression();
        })
*/
      });

  </script>
</head>

<body>
  <div id="viewDiv">

  </div>
  <div class="esri-widget" id="dropdownDiv">
    <select id="subRegion" class="esri-widget"></select>
    <select id="stateName" class="esri-widget"></select>
  </div>
</body>

</html>‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍‍