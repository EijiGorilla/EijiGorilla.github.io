<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>
      Unique value groups with headings | Sample | ArcGIS Maps SDK for
      JavaScript 4.25
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"
    />
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://js.arcgis.com/4.25/"></script>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #viewDiv {
        float: left;
        padding: 0;
        margin: 0;
        height: 100%;
        width: 75%;
      }
      #legend-node {
        float: left;
        width: 25%;
        height: 100%;
        padding: 1em;
        overflow: scroll;
        max-height: 100%;
        border-width: 2px;
        border-color: #323232;
        border-style: solid;
      }

      #chartdiv {
        position: absolute;
        z-index: 99;
        top: 0;
        right: 0;
        width: 40vw;
        height: 50%;
        background-color: white;
      }

      #chartdiv1 {
        position: absolute;
        z-index: 99;
        bottom: 0;
        right: 0;
        width: 40vw;
        height: 20%;
        background-color: white;
      }
    </style>

    <script>
      require([
        "esri/views/MapView",
        "esri/WebMap",
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend"
      ], (MapView, WebMap, Map, FeatureLayer, Legend) => {

    var map = new Map({
        basemap: "osm", // "streets-night-vector"
        ground: "world-elevation" // ground: "no"
  }); 

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-123.12645, 44.06416],
          scale: 72223,
          constraints: {
            snapToZoom: false
          }
        });

        
        view.when().then(async () => {
          const osmBaseLayer = view.map.basemap.baseLayers.getItemAt(0);
          osmBaseLayer.effect = "grayscale(100%)";
        });

        function createSymbol(color) {
          return {
            type: "simple-fill",
            style: "solid",
            color,
            outline: null
          };
        }

        const renderer = {
          type: "unique-value",
          field: "zonecode",
          uniqueValueGroups: [
            {
              heading: "Commercial",
              classes: [
                {
                  label: "C-1 | Neighborhood Commercial",
                  symbol: createSymbol([189, 145, 145]),
                  values: "C-1"
                },
                {
                  label: "C-2 | Community Commercial",
                  symbol: createSymbol([255, 179, 219]),
                  values: "C-2"
                },
                {
                  label: "C-3 | Major Commercial",
                  symbol: createSymbol([255, 0, 0]),
                  values: "C-3"
                }
              ]
            },
            {
              heading: "Office",
              classes: [
                {
                  label: "GO | General Office",
                  symbol: createSymbol([176, 196, 222]),
                  values: "GO"
                },
                {
                  label: "E-1 | Campus Employment",
                  symbol: createSymbol([230, 230, 230]),
                  values: "E-1"
                },
                {
                  label: "E-2 | Mixed Use Employment",
                  symbol: createSymbol([255, 20, 255]),
                  values: "E-2"
                }
              ]
            },
            {
              heading: "Residential",
              classes: [
                {
                  label: "R-1 | Low-Density Residential",
                  symbol: createSymbol([255, 255, 224]),
                  values: "R-1"
                },
                {
                  label: "R-1.5 | Rowhouse",
                  symbol: createSymbol([255, 255, 0]),
                  values: "R-1.5"
                },
                {
                  label: "R-2 | Medium-Density Residential",
                  symbol: createSymbol([240, 230, 140]),
                  values: "R-2"
                },
                {
                  label: "R-3 | Limited High-Density Residential",
                  symbol: createSymbol([255, 214, 0]),
                  values: "R-3"
                },
                {
                  label: "R-4 | High-Density Residential",
                  symbol: createSymbol([255, 166, 0]),
                  values: "R-4"
                }
              ]
            },
            {
              heading: "Industrial",
              classes: [
                {
                  label: "I-2 | Light-Medium Industrial",
                  symbol: createSymbol([219, 112, 214]),
                  values: "I-2"
                },
                {
                  label: "I-3 | Heavy Industrial",
                  symbol: createSymbol([148, 112, 219]),
                  values: "I-3"
                }
              ]
            },
            {
              heading: "Open Space",
              classes: [
                {
                  label: "NR | Natural Resource",
                  symbol: createSymbol([125, 252, 0]),
                  values: "NR"
                },
                {
                  label: "PRO | Park, Recreation & Open Space",
                  symbol: createSymbol([0, 255, 128]),
                  values: "PRO"
                }
              ]
            },
            {
              heading: "Other",
              classes: [
                {
                  label: "AG | Agricultural",
                  symbol: createSymbol([219, 166, 33]),
                  values: "AG"
                },
                {
                  label: "PL | Public Land",
                  symbol: createSymbol([0, 191, 255]),
                  values: "PL"
                },
                {
                  label: "S | Special Area",
                  symbol: createSymbol([161, 237, 237]),
                  values: [
                    "S-DW",
                    "S-DR",
                    "S-RP",
                    "S-JW",
                    "S-RN",
                    "S-WS",
                    "S-CN",
                    "S-HB",
                    "S-F",
                    "S-W",
                    "S-E",
                    "S-C"
                  ]
                },
                {
                  label: "S-H | Historic",
                  symbol: createSymbol([0, 0, 204]),
                  values: "S-H"
                }
              ]
            }
          ]
        };

        const layer = new FeatureLayer({
          minScale: 0,
          maxScale: 0,
          portalItem: {
            id: "ebb2e1f38f274f2dbbe4cba16c6c66af"
          },
          renderer,
          blendMode: "multiply"
        });
        map.add(layer);

        // Chart

        var query = layer.createQuery();
        query.returnGeometry = true;
        query.where = "zonecode IS NOT NULL";
        query.groupByFieldsForStatistics = ["zonecode"];

        const zoneCode = [
            "AG", // [1]
            "C-1", "C-2", "C-3", //[2-4]
            "GO", // 5
            "PL", // 6
            "E-1", "E-2", // 7,8
            "I-2", "I-3", // 9,10
            "R-1", "R-2", "R-3", "R-4", // 11-14
            "NR", // 15
            "PRO", // 16
            "S-DW", "S-DR", "S-RP", "S-JW", "S-RN", "S-WS", "S-CN", "S-HB", "S-F", "S-W", "S-E", "S-C", //17-28
            "S-H" // 29
        ]

        const zoneSummaryCode = [
          "AG",
          "C",
          "GO",
          "PL",
          "E",
          "I",
          "R",
          "NR",
          "PRO",
          "S",
          "S-H"
        ]

        am4core.ready(function() {
          am4core.useTheme(am4themes_animated);
          function originalFunction() {
            return layer.queryFeatures(query).then(function(response) {
            stats = response.features;
            const codeValues = [];
            stats.forEach((result, index) => {
                const attributes = result.attributes;
                const code = attributes.zonecode;
                const INDEX = zoneCode.indexOf(code) + 1;
                codeValues.push(INDEX);
            });
            return codeValues;
         });
        }

        function getCountEachCode(codeValues) {
            const codeValueCount = {};
            for (let i = 0; i < codeValues.length; i++) {
                codeValueCount[codeValues[i]] = 1 + (codeValueCount[codeValues[i]] || 0);
            }
            const AG = codeValueCount[1];
            const C = codeValueCount[2] + codeValueCount[3] + codeValueCount[4];
            const GO = codeValueCount[5];
            const PL = codeValueCount[6];
            const E = codeValueCount[7] + codeValueCount[8];
            const I = codeValueCount[9] + codeValueCount[10];
            const R = codeValueCount[11] + codeValueCount[12] + codeValueCount[13] + codeValueCount[14];
            const NR = codeValueCount[15];
            const PRO = codeValueCount[16];
            const S = codeValueCount[17] + codeValueCount[18] + codeValueCount[19] + codeValueCount[20] +
                      codeValueCount[21] + codeValueCount[22] + codeValueCount[23] + codeValueCount[24] +
                      codeValueCount[25] + codeValueCount[26] + codeValueCount[27] + codeValueCount[28];
            const SH = codeValueCount[29];

            const codeValueCountSum = {1: AG, 2: C, 3: GO, 4: PL, 5: E, 6: I, 7: R, 8: NR, 9: PRO, 10: S, 11: SH};
            
            return [codeValueCount, codeValueCountSum];
        }

        originalFunction().then(getCountEachCode).then(codeChart2);
        function codeChart2([codeValueCount, codeValueCountSum]) {
          var chart = am4core.create("chartdiv1", am4charts.PieChart);
          // Add data
          chart.data = [ {
            "category": zoneSummaryCode[0],
            "value": codeValueCountSum[1],
            "color": am4core.color("#dc4534"),
          }, {
            "category": zoneSummaryCode[1],
            "value": codeValueCountSum[2],
            "color": am4core.color("#d7a700"),
          }, {
            "category": zoneSummaryCode[2],
            "value": codeValueCountSum[3],
            "color": am4core.color("#68ad5c"),
          }
          ];

          // Add and configure Series
          var pieSeries = chart.series.push(new am4charts.PieSeries());
          pieSeries.dataFields.value = "value";
          pieSeries.dataFields.category = "category";
          pieSeries.slices.template.stroke = am4core.color("#fff");
          pieSeries.slices.template.strokeOpacity = 1;
          pieSeries.slices.template.propertyFields.fill = "color";
          // This creates initial animation
          pieSeries.hiddenState.properties.opacity = 1;
          pieSeries.hiddenState.properties.endAngle = -90;
          pieSeries.hiddenState.properties.startAngle = -90;

          chart.hiddenState.properties.radius = am4core.percent(0);
          pieSeries.innerRadius = am4core.percent(50);

        }


        function codeChart([codeValueCount, codeValueCountSum]) {
          var data = [{
            "category": zoneSummaryCode[0],
            "value": codeValueCountSum[1],
            "color": am4core.color("#dc4534"),

          }, {
            "category": zoneSummaryCode[1],
            "value": codeValueCountSum[2],
            "color": am4core.color("#d7a700"),
            "breakdown": [{
              "category": zoneCode[1],
              "value": codeValueCount[2]
            }, {
              "category": zoneCode[2],
              "value": codeValueCount[3]
            }, {
              "category": zoneCode[3],
              "value": codeValueCount[4]
            }]
          }, {
            "category": zoneSummaryCode[2],
            "value": codeValueCountSum[3],
            "color": am4core.color("#68ad5c"),
          }]

          /**
           * Chart container
           */

          // Create chart instance
          var chart = am4core.create("chartdiv", am4core.Container);
          chart.width = am4core.percent(100);
          chart.height = am4core.percent(100);
          chart.layout = "horizontal";



          /**
           * Column chart
           */

          // Create chart instance
          var columnChart = chart.createChild(am4charts.XYChart);

          // Create axes
          var categoryAxis = columnChart.yAxes.push(new am4charts.CategoryAxis());
          categoryAxis.dataFields.category = "category";
          categoryAxis.renderer.grid.template.location = 0;
          categoryAxis.renderer.inversed = true;

          var valueAxis = columnChart.xAxes.push(new am4charts.ValueAxis());

          // Create series
          var columnSeries = columnChart.series.push(new am4charts.ColumnSeries());
          columnSeries.dataFields.valueX = "value";
          columnSeries.dataFields.categoryY = "category";
          columnSeries.columns.template.strokeWidth = 0;

          var labelBullet = columnSeries.bullets.push(new am4charts.LabelBullet());
          labelBullet.label.text = "{valueX.formatNumber('#.')}";
          columnSeries.columns.template.tooltipText = "{valueX.formatNumber('#.')}";
        
          /**
           * Pie chart
           */

          // Create chart instance
          var pieChart = chart.createChild(am4charts.PieChart);
          pieChart.data = data;
          pieChart.innerRadius = am4core.percent(50);

          // Add and configure Series
          var pieSeries = pieChart.series.push(new am4charts.PieSeries());
          pieSeries.dataFields.value = "value";
          pieSeries.dataFields.category = "category";
          pieSeries.slices.template.propertyFields.fill = "color";
          pieSeries.labels.template.disabled = true;

          // Set up labels
          var label1 = pieChart.seriesContainer.createChild(am4core.Label);
          label1.text = "";
          label1.horizontalCenter = "middle";
          label1.fontSize = 35;
          label1.fontWeight = 600;
          label1.dy = -30;

          var label2 = pieChart.seriesContainer.createChild(am4core.Label);
          label2.text = "";
          label2.horizontalCenter = "middle";
          label2.fontSize = 12;
          label2.dy = 20;

          // Auto-select first slice on load
          pieChart.events.on("ready", function(ev) {
            pieSeries.slices.getIndex(0).isActive = true;
          });

          // Set up toggling events
          pieSeries.slices.template.events.on("toggled", function(ev) {
            if (ev.target.isActive) {
              
              // Untoggle other slices
              pieSeries.slices.each(function(slice) {
                if (slice != ev.target) {
                  slice.isActive = false;
                }
              });
              
              // Update column chart
              columnSeries.appeared = false;
              columnChart.data = ev.target.dataItem.dataContext.breakdown;
              columnSeries.fill = ev.target.fill;
              columnSeries.reinit();
              
              // Update labels
              label1.text = pieChart.numberFormatter.format(ev.target.dataItem.values.value.percent, "#.'%'");
              label1.fill = ev.target.fill;
              
              label2.text = ev.target.dataItem.category;
            }
          });

        }

        originalFunction().then(getCountEachCode).then(codeChart);

        });




      

        // we need to convert {1: , 2: , 3:}. 1 = zoneCode[1]
        

        /*
        function getCountEachCode(codeValues) {
            const codeValueCount = {};
            for (let i = 0; i < codeValues.length; i++) {
                codeValueCount[codeValues[i]] = 1 + (codeValueCount[codeValues[i]] || 0);
            }
            
        }
*/
        

        new Legend({
          view,
          container: "legend-node"
        });

      });
    </script>
  </head>

  <body>
    <div id="legend-node" class="esri-widget"></div>
    <div id="chartdiv1"></div>
    <div id="viewDiv">
      <div id="chartdiv"></div>
    </div>
  </body>
</html>
