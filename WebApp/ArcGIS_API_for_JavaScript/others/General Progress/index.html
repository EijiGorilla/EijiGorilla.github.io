<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>General Progress</title>
    
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    
    <script src="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.0.0-beta.99/calcite.css" />

    <script src="https://js.arcgis.com/4.25/"></script>
    <link id="arcgis-maps-sdk-theme-light" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tab {
        height: 83vh;
        width: 90%;
    }

    calcite-action-bar {
      position: absolute;
      z-index: 99;
      bottom: 0;
      right: 0;
      margin: 1rem;
    }


    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }


    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }


    br {
      content: "";
      margin: 2em;
      display: block;
      font-size: 24%;
    }

    b {
        color: orange;
    }

    h2 {
      position: absolute;
      z-index: 99;
      top: 0;
      left: 0;
      margin: 1rem;
    }

    #dateDiv {
      position: absolute;
      z-index: 99;
      bottom: 0;
      right: 0;
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
      margin: 1rem;

    }

    /* Project list*/
    #projectList {
      color: grey;
    }

    .active, .test:hover {
      background-color: rgba(77, 75, 75, 0);
        color: black;
        font-size: 1.2rem;
        /*text-decoration: underline;*/
        font-weight: bold;
    }

    ul {
      list-style-type: none; /* remove list bullets*/
    }

    .panel {
      box-sizing: border-box;
      width: 20%;
      position: absolute;
      text-align: left;
      top: 0;
      right: 0;
      font-size: 1rem;
      color: white;
      background-color: rgb(0, 0, 0, 0);
      overflow: auto;
      z-index: 99;
      /*transition: 3;*/
      line-height: 2rem;
      margin: 6;


      }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }

    #legend-container {
      color: black;
      font-weight: bold;
      width: 100%;
      background-color:rgb(255, 255, 255, 0.7);
    }
    
    /*  */
    .sassy-theme .esri-legend__layer-caption {
      display: none;
    }
    
    .sassy-theme .esri-legend .esri-legend__layer-cell--info {
      /*background-color: black;*/
      color: black;
      font-size: 1rem;
    }  


  </style>
  <body class="sassy-theme">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <div id="viewDiv">
        <!-- Title -->
        <h2 id="header-title">GENERAL PROGRESS</h2>
        <button id="chart-progress-button"><a href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/others/N2_General_Progress/index3.html" id="myLink" target="_blank" title="View pre-construction dashboard" class="esri-widget--button esri-icon-pie-chart"></a></button>
        <div id="dateDiv">January 5, 2023</div>
        <div id="legend-container"></div>
        <div class="panel">
          <ul id="projectList">
            <li class="test active" id="N2">NSCR-Ex (Malolos-Clark)</li>
            <li class="test" id="SC">NSCR-Ex (Solis-Calamba)</li>
          </ul>
      </div>
      </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/Basemap",
      "esri/layers/VectorTileLayer",
      "esri/WebMap",
      "esri/views/MapView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer"
    ], function(Basemap, VectorTileLayer, WebMap, MapView, Map, FeatureLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Graphic, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer
                 ) {
                  
                  
    var basemap = new Basemap({
      baseLayers: [
          new VectorTileLayer({
          portalItem: {
              id: "a56c8ba20f4c4a54a0b1440bbf631911" // 3a62040541b84f528da3ac7b80cf4a63
          }
          })
      ]
    });
    var map = new Map({
        basemap: basemap, // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new MapView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Centerline
        // Chnage line color 
        const lineColor = {
          procurement_hex: "#d92b30",
          procurement_rgb: [],
          
          awarded_hex: "#0070ff",
          awarded_rgb: [],

          construction_hex: "#38A800",
          construction_rgb: [56, 168, 0]
        }

    const lineWidth = "10px";
    let centerLineSymbol = {
      type: "unique-value",
      valueExpression: "When($feature.Status == 'Procurement', 'procurement', \
                            $feature.Status == 'Awarded', 'awarded', \
                            $feature.Status == 'Construction', 'construction', $feature.Status)",
      uniqueValueInfos: [
        {
          value: "procurement",
          label: "Procurement",
          symbol: {
            type: "simple-line",
            color: lineColor.procurement_hex,
            width: lineWidth,
            style: "solid"
          }
        },
        {
          value: "awarded",
          label: "Awarded",
          symbol: {
            type: "simple-line",
            color: lineColor.awarded_hex,
            width: lineWidth,
            style: "solid"
          }
        },
        {
          value: "construction",
          label: "Construction",
          symbol: {
            type: "simple-line",
            color: lineColor.construction_hex,
            width: lineWidth,
            style: "solid"
          }
        },
      ]
    }

    var n2CenterlineLayer = new FeatureLayer({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        title: "N2 Centerline",
        renderer: centerLineSymbol,
        outFields: ["*"],
        popuEnabled: false,
    });
    map.add(n2CenterlineLayer);

    var scCenterlineLayer = new FeatureLayer({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        title: "SC Centerline",
        renderer: centerLineSymbol,
        outFields: ["*"],
        popuEnabled: false,
    });
    map.add(scCenterlineLayer);


    // Beak points between individua CPs
    var n2BreakPointsCP = new FeatureLayer({
        portalItem: {
            id: "95bd8e4739af45189f2238faf626e5a0",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "N2 Break Points",
        definitionExpression: "Extension = 'N2'" + " AND " + "Id >= 1",
        outFields: ["*"],
        popuEnabled: false
    });
    n2BreakPointsCP.listMode = "hide";
    map.add(n2BreakPointsCP);

    var scBreakPointsCP = new FeatureLayer({
        portalItem: {
            id: "95bd8e4739af45189f2238faf626e5a0",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "SC Break Points",
        definitionExpression: "Extension = 'SC'" + " AND " + "Id >= 1",
        outFields: ["*"],
        popuEnabled: false
    });
    scBreakPointsCP.listMode = "hide";
    map.add(scBreakPointsCP);

    // Station point feature
    var labelStation = new LabelClass({
        symbol: {
            type: "text",
            color: "blue",
            haloColor: "black",
            haloSize: 0.1,
            font: {
                size: 12,
                //weight: "bold"
            }
        },
        labelPlacement: "center-left",
        labelExpressionInfo: {
            expression: "$feature.Station"
        }
    });

    var n2StationLayer = new FeatureLayer({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "Station",
        outFields: ["*"],
        popuEnabled: false,
        definitionExpression: "Station <> 'NCC'",
        labelingInfo: [labelStation]
    });
    n2StationLayer.listMode = "hide";
    map.add(n2StationLayer);

    var scStationLayer = new FeatureLayer({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "SC Station",
        outFields: ["*"],
        popuEnabled: false,
        labelingInfo: [labelStation]
    });
    scStationLayer.listMode = "hide";
    map.add(scStationLayer);


    /////////////////// END Of LAYER IMPORT ////////////////////////////
    // Default Display
    function defaultDisplay() {
      n2StationLayer.visible = true;
      scStationLayer.visible = false;

      n2BreakPointsCP.definitionExpression = "Extension = 'N2'" + " AND " + "Id >= 1";

      n2CenterlineLayer.visible = true;
      scCenterlineLayer.visible = false;

      zoomToLayer(n2StationLayer);
    }
    defaultDisplay();


    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
          zoom: 17
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }

    // Project list
    // Open general progress of pre-constructions
    const mapSource = [
                  "https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/others/MMSP_General_Progress/index3.html",
                  "https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/others/N2_General_Progress/index3.html",

                  ]

    var selectedLink = document.getElementById("myLink");
    view.ui.add("chart-progress-button", "bottom-right");

    // Project List selection
    var projectList = document.getElementById("projectList");
    var ttt = projectList.getElementsByClassName("test");

    for(var i = 0; i < ttt.length; i ++) {
      ttt[i].addEventListener("click", filterByP);
    }

      function filterByP(event) {
        var current = document.getElementsByClassName("active");
        current[0].className = current[0].className.replace(" active","");
        this.className += " active";

        const selectedID = event.target.id;
        if(selectedID === 'N2') {
          n2StationLayer.visible = true;
          scStationLayer.visible = false;

          n2BreakPointsCP.definitionExpression = "Extension = 'N2'" + " AND " + "Id >= 1";
  
          n2CenterlineLayer.visible = true;
          scCenterlineLayer.visible = false;

          zoomToLayer(n2StationLayer);

          selectedLink.style.display = 'block';
          selectedLink.setAttribute('href', mapSource[1])

        } else if(selectedID === 'SC'){
          n2StationLayer.visible = false;
          scStationLayer.visible = true;

          scBreakPointsCP.definitionExpression = "Extension = 'SC'" + " AND " + "Id >= 1";
  
          n2CenterlineLayer.visible = false;
          scCenterlineLayer.visible = true;

          zoomToLayer(scStationLayer);

          selectedLink.style.display = 'none';
          selectedLink.setAttribute('href', mapSource[0])
        }

      }

    // Draw CP break line on the map
    const graphicsLayer = new GraphicsLayer();
    graphicsLayer.listMode = "hide";
    map.add(graphicsLayer);

    // Point and Line feature
    const cpLineColor = [128,128,128];
    const cpLabelColor = [0, 0, 0];

    const cpLineWidth = 1;
    const cpFontSize = 15;

    // N2
    var query = n2BreakPointsCP.createQuery();
    query.orderByFields = ["Id"];
    n2BreakPointsCP.queryFeatures(query).then(function(response) {
        var stats = response.features;
        const paths = [];
        const points = [];
        const CPs = [];

        stats.forEach((result, index) => {
            const attributes = result.attributes;
            const cp = attributes.CP;
            CPs.push(cp);

            // Collect geometry of each break point
            const pointX0 = result.geometry.longitude;
            const pointY0 = result.geometry.latitude;

            // Calculate end poins and store it in a path for line generation
            const pointX1 = pointX0 + 0.05;
            const path = [
                [pointX0, pointY0],
                [pointX1, pointY0]
            ]

            // Append each path to paths
            paths.push(path);

            // Calculate a point for text symbol
            const point = [pointX1, pointY0];
            points.push(point);
        });

        // 1. Draw a horizontal line at break points of individual CPs
        // Define polyline paths and type
        const polyline = {
            type: "polyline",
            paths: paths
        };

        // Set line properties
        const simpleLineSymbol = {
            type: "simple-line",
            color: cpLineColor,
            width: cpLineWidth
        };

        // Add to Graphic
        const polylineGraphic = new Graphic({
            geometry: polyline,
            symbol: simpleLineSymbol
        });

        // Dispaly grapchicsLayer
        graphicsLayer.add(polylineGraphic);


        // 2. Add text symbol
        for(var i=0; i < points.length; i++){
            if(i <= points.length-2){
                const pointTextX = points[i][0] + 0.03;
                const pointTextY0 = points[i][1];
                const pointTextY1 = points[i+1][1];
                const pointTextY = (pointTextY0 + pointTextY1) / 2;

                const point = {
                    type: "point",
                    longitude: pointTextX,
                    latitude: pointTextY
                };

                let textSymbol = {
                    type: "text",  // autocasts as new TextSymbol()
                    color: cpLabelColor,
                    //haloColor: "black",
                    //haloSize: "1px",
                    text: CPs[i],
                    //xoffset: 3,
                    //yoffset: -5,
                    font: {  // autocasts as new Font()
                        size: cpFontSize,
                        //family: "Josefin Slab",
                        weight: "bold"
                    }
                };

                const simpleMarkerSymbol = {
                    type: "simple-marker",
                    color: [226, 119, 40],
                    size: 12,
                    style: "circle",
                    outline: {
                        width: 1,
                        color: [255, 255, 255, 1]
                    }
                };

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: textSymbol
                });
                graphicsLayer.add(pointGraphic);
            }
        }
    });


    // SC
    var query = scBreakPointsCP.createQuery();
    query.orderByFields = ["Id"];
    scBreakPointsCP.queryFeatures(query).then(function(response) {
        var stats = response.features;
        const paths = [];
        const points = [];
        const CPs = [];

        stats.forEach((result, index) => {
            // Collect geometry of each break point
            const attributes = result.attributes;
            const cp = attributes.CP;
            CPs.push(cp);
            const pointX0 = result.geometry.longitude;
            const pointY0 = result.geometry.latitude;

            // Calculate end poins and store it in a path for line generation
            const pointX1 = pointX0 + 0.05;
            const path = [
                [pointX0, pointY0],
                [pointX1, pointY0]
            ]

            // Append each path to paths
            paths.push(path);

            // Calculate a point for text symbol
            const point = [pointX1, pointY0];
            points.push(point);
        });

        // 1. Draw a horizontal line at break points of individual CPs
        // Define polyline paths and type
        const polyline = {
            type: "polyline",
            paths: paths
        };

        // Set line properties
        const simpleLineSymbol = {
            type: "simple-line",
            color: cpLineColor,
            width: cpLineWidth
        };

        // Add to Graphic
        const scPolylineGraphic = new Graphic({
            geometry: polyline,
            symbol: simpleLineSymbol
        });

        // Dispaly grapchicsLayer
        graphicsLayer.add(scPolylineGraphic);


        // 2. Add text symbol
        for(var i=0; i < points.length; i++){
            //console.log(i);
            if(i <= points.length-2 && i !== 8){
                const pointTextX = points[i][0] + 0.03;
                const pointTextY0 = points[i][1];
                const pointTextY1 = points[i+1][1];
                const pointTextY = (pointTextY0 + pointTextY1) / 2;

                const point = {
                    type: "point",
                    longitude: pointTextX,
                    latitude: pointTextY
                };

                let textSymbol = {
                    type: "text",  // autocasts as new TextSymbol()
                    color: cpLabelColor,
                    //haloColor: "black",
                    //haloSize: "1px",
                    text: CPs[i],
                    //xoffset: 3,
                    //yoffset: -5,
                    font: {  // autocasts as new Font()
                        size: cpFontSize,
                        //family: "Josefin Slab",
                        weight: "bold"
                    }
                };

                const simpleMarkerSymbol = {
                    type: "simple-marker",
                    color: [226, 119, 40],
                    size: 12,
                    style: "circle",
                    outline: {
                        width: 1,
                        color: [255, 255, 255, 1]
                    }
                };

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: textSymbol
                });
                graphicsLayer.add(pointGraphic);
            }
        }
    });

    view.ui.empty("top-left");

      // Widgets
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        /*
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "Chainage" || item.title === "Pier No." || item.title === "Free-and-Clear Area"){
            item.visible = false
          }
        }
        */
      });
      
      const legend = new Legend({
        view,
        container: "legend-container",
        layerInfos: [
          {
            layer: n2CenterlineLayer,
            title: "LEGEND"
          },
          {
            layer: scCenterlineLayer,
            title: "LEGEND"
          }
        ]
      });
      view.ui.add(legend, "bottom-left");

      const locate = new Locate({
        view: view,
        container: "locate-container"
      });



    });
  </script>
</html>