<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      Sample
    </title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #legendDiv {
        background-color: rgb(0, 0, 0, 0.5);
        z-index: 99;
        position: absolute;
        display: none;
      }


      #titleDiv {
        position: absolute;
        font-style: normal;
        font-weight: bold;
        font-size: 3.8vw;
        color: white;
        background-color: rgb(0, 0, 0, 0);
        width: 35vw;
        z-index: 99;
        top: 70;
        left: 30;

      }

      #applicationDiv {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;         
      }

      
      #messageDiv {
        padding-left: 10px;
        padding-right: 10px;
      }

      #chartPanelDiv {
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        z-index: 99;
        position: absolute;
        right: 0;
        margin-top: 8%;
      }

      #chartdiv {
          width: 59vh;
          height: 47vh;
          align-items: center;
          font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
          padding: 0;
          margin: 0;
      }

    /* Esris Setting */
    .esri-layer-list__item-toggle-icon,
      .esri-layer-list__item-title {
        color: white;
     }

      .sassy-theme .esri-popup__header-title {
        width: 17vw;
        background-color: rgba(0, 0, 0, 0.8);
      }
      
      .sassy-theme .esri-menu,
      .sassy-theme .esri-popup__main-container,
      .sassy-theme .esri-popup .esri-popup__pointer-direction,
      .sassy-theme .esri-popup .esri-popup__button,
      .sassy-theme .esri-button,
      .sassy-theme .esri-input,
      .sassy-theme .esri-layer-list,
      .sassy-theme .esri-widget {
        background-color: rgb(0, 0, 0, 0.5);
        color: #fff;
      }
      


      .sassy-theme .esri-legend--card__carousel-indicator-container,
      .sassy-theme .esri-legend__group-layer-child,
      .sassy-theme .esri-legend__layer-body {
      background-color: rgba(0, 0, 0, 0.5);
    }
      .sassy-theme .esri-legend__layer-caption {
        display: none;
      }

    /* Browser Setting */
      ::-webkit-scrollbar {
        display: none;
      }

    </style>

    <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.23/esri/themes/dark/main.css"
    />
<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://js.arcgis.com/4.23/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/TileLayer",
        "esri/Graphic",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/layers/GroupLayer",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/tasks/support/Query",
        "esri/tasks/QueryTask",
        "esri/widgets/Fullscreen",
        "esri/symbols/TextSymbol"
      ], function(
        Map,
        MapView,
        TileLayer,
        Graphic,
        FeatureLayer,
        GraphicsLayer,
        GroupLayer,
        Expand,
        Legend,
        Query,
        QueryTask,
        Fullscreen,
        TextSymbol

      ) {
        const worldImagery = new TileLayer({
          portalItem: {
            id: "10df2279f9684e4a9f6a7f08febac2a9" // world imagery
          }
        });

        worldImagery.when(() => {
          worldImagery.sublayers.forEach((layer) => {
            if (layer.popupEnabled === true) {
              layer.popupEnabled = false;
            }
          });
        });

       // https://developers.arcgis.com/javascript/latest/sample-code/effect-blur-shadow/
        // Ukraine - hospital layer

const labelClass = {  // autocasts as new LabelClass()
  symbol: {
    type: "text",  // autocasts as new TextSymbol()
    color: "white",
    //haloColor: "blue",
    //haloSize: 1,
    font: {  // autocast as new Font()
       size: 20,
       weight: "bold"
     }
  },
  labelPlacement: "above-right",
  labelExpressionInfo: {
    expression: "$feature.Name"
  },
  maxScale: 0,
  minScale: 25000000
};

let textSymbol = {
  type: "text",  // autocasts as new TextSymbol()
  color: "white",
  haloColor: "black",
  haloSize: "1px",
  text: "Ukraine",
  xoffset: 160,
  yoffset: 170,
  font: {  // autocasts as new Font()
    size: 30,
    weight: "bold"
  }
};


        var hospitalLayer = new FeatureLayer({
            portalItem: {
                id:"a14823a46cf04c0dbf1047a9bb2bd2ee"
            },
            layerId: 4,
            outFields: ["*"]
        });

        var ukrainBoundary = new FeatureLayer({
          portalItem: {
                id:"a14823a46cf04c0dbf1047a9bb2bd2ee"
            },
            //labelingInfo: [textSymbol],
            layerId: 1,
            outFields: ["*"]
        });

        ukrainBoundary.renderer = {
type: "simple", // autocasts as new SimpleRenderer()
symbol: textSymbol
};


        // this layer is only used to query for the intersecting country when the map is clicked
        const countries = new FeatureLayer({
          portalItem: {
            id: "53a1e68de7e4499cad77c80daba46a94"
          },
          outFields: ["*"]
        });

        // clicked country feature will be added to this layer
        const graphicsLayer = new GraphicsLayer({
          blendMode: "destination-in",
          title: "layer"
        });

        const tileLayer = new TileLayer({
          portalItem: {
            // bottom layer in the group layer
            id: "10df2279f9684e4a9f6a7f08febac2a9" // world imagery
          }
        });
        tileLayer.when(() => {
          tileLayer.sublayers.forEach((layer) => {
            if (layer.popupEnabled === true) {
              layer.popupEnabled = false;
            }
          });
        });

        // this grouplayer has two layers
        // destination-in blendMode set on the graphics layer
        // country from the world imagery layer will show when user clicks on a country
        const groupLayer = new GroupLayer({
          layers: [
            tileLayer,
            // world imagery layer will show where it overlaps with the graphicslayer
            graphicsLayer
          ],
          opacity: 0 // initially this layer will be transparent
        });

        var map = new Map({
          layers: [worldImagery, groupLayer, hospitalLayer,ukrainBoundary]
        });

        var view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 6,
          center: [32.1021672, 48.7944170],
          popup: null,
          constraints: {
            snapToZoom: false,
            minScale: 147914381
          }
        });

        view.when(() => {
          const query = {
            geometry: view.center,
            returnGeometry: true,
            outFields: ["*"]
          };
          highlightCountry(query, view.center);
        });

        // listen to the view's click event
        view.on("click", async (event) => {
          const query = {
            geometry: view.toMap(event),
            returnGeometry: true,
            outFields: ["*"]
          };
          highlightCountry(query, query.geometry);
        });

        async function highlightCountry(query, zoomGeometry) {
          // country symbol - when user clicks on a country
          // we will query the country from the countries featurelayer
          // add the country feature to the graphics layer.
          const symbol = {
            type: "simple-fill",
            color: "rgba(255, 255, 255, 1)",
            outline: null
          };

          // query the countries layer for a country that intersects the clicked point
          const {
            features: [feature]
          } = await countries.queryFeatures(query);
          // user clicked on a country and the feature is returned
          if (feature) {
            graphicsLayer.graphics.removeAll();
            feature.symbol = symbol;
            // add the country to the graphics layer
            graphicsLayer.graphics.add(feature);
            // zoom to the highlighted country
            view.goTo(
              {
                target: zoomGeometry,
                extent: feature.geometry.extent.clone().expand(1.8)
              },
              { duration: 1000 }
            );
            // blur the world imagery basemap so that the clicked country can be highlighted
            worldImagery.effect = "blur(8px) brightness(1.2) grayscale(0.8)";
            // set the group layer transparency to 1.
            // also increase the layer brightness and add drop-shadow to make the clicked country stand out.
            groupLayer.effect = "brightness(1.5) drop-shadow(0, 0px, 12px)";
            groupLayer.opacity = 1;
          }
          // did not click on a country. remove effects
          else {
            worldImagery.effect = null;
            groupLayer.effect = null;
          }
        }


    // Pier Chart to summarize damage ratings of hospitals in Ukraine
    let chartLayerView;
var highlightSelect;
        var titleDiv = document.getElementById("titleDiv");
        const chartPanelDiv = document.getElementById("chartPanelDiv");

// Call amCharts 4
am4core.ready(function() {
am4core.useTheme(am4themes_animated);

async function updateChart() {
    function DamageRating(){
  return {
    1: "Total Destruction",
    2: "Damaged Beyond Repair",
    3: "Seriously Damaged-Not Repairable",
    4: "Seriously Damaged-Repairable",
    5: "No Damage"
  }
}

        var total_destruction = {
            onStatisticField: "CASE WHEN Damage = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_destruction",
            statisticType: "sum"
        }

        var total_damaged = {
            onStatisticField: "CASE WHEN Damage = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_damaged",
            statisticType: "sum"
        }
        
        var total_nonrepair = {
            onStatisticField: "CASE WHEN Damage = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nonrepair",
            statisticType: "sum"
        }

        var total_repair = {
            onStatisticField: "CASE WHEN Damage = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_repair",
            statisticType: "sum"
        }

        var total_notdamaged = {
            onStatisticField: "CASE WHEN Damage = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_notdamaged",
            statisticType: "sum"
        }

        var query = hospitalLayer.createQuery();
        query.outStatistics = [total_destruction, total_damaged, total_nonrepair, 
                               total_repair, total_notdamaged];

        query.returnGeometry = true;

        hospitalLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const TOTAL_DESTRUCTION = stats.total_destruction;
            const DAMAGED_NOREPAIR = stats.total_damaged;
            const DAMAGED_SERIOUS = stats.total_nonrepair;
            const DAMAGED_REPAIRABLE = stats.total_repair;
            const NO_DAMAGE = stats.total_notdamaged;
            
            var chart = am4core.create("chartdiv", am4charts.PieChart);
                // Add data
    chart.data = [
      {
        "Damage": DamageRating()[1],
        "status": TOTAL_DESTRUCTION,
        "color": am4core.color("#000000")
      },
      {
        "Damage": DamageRating()[2],
        "status": DAMAGED_NOREPAIR,
        "color": am4core.color("#C500FF")   
      },
      {
        "Damage": DamageRating()[3],
        "status": DAMAGED_SERIOUS,
        "color": am4core.color("#FF0000") 
      },
      {
        "Damage": DamageRating()[4],
        "status": DAMAGED_REPAIRABLE,
        "color": am4core.color("#FFAA00")
      },
      {
       "Damage": DamageRating()[5],
        "status": NO_DAMAGE,
        "color": am4core.color("#89CD66")    
     }
    ];
    // Set inner radius
    chart.innerRadius = am4core.percent(30);
    
    // Add and configure Series
    function createSlices(field, status){
      var pieSeries = chart.series.push(new am4charts.PieSeries());
      pieSeries.dataFields.value = field;
      pieSeries.dataFields.category = status;
      
      pieSeries.slices.template.propertyFields.fill = "color";
      pieSeries.slices.template.stroke = am4core.color("#fff");
      pieSeries.slices.template.strokeWidth = 1;
      pieSeries.slices.template.strokeOpacity = 1;
      pieSeries.slices.template
      // change the cursor on hover to make it apparent the object can be interacted with
      .cursorOverStyle = [
        {
          "property": "cursor",
          "value": "pointer"
        }
      ];
      
      // Hover setting
      pieSeries.tooltip.label.fontSize = 9;
      
      // Pie
      //pieSeries.alignLabels = false;
      //pieSeries.labels.template.bent = false;
      pieSeries.labels.template.disabled = true;
      pieSeries.labels.template.radius = 3;
      pieSeries.labels.template.padding(0,0,0,0);
      pieSeries.labels.template.fontSize = 9;
      pieSeries.labels.template.fill = "#ffffff";

      // Ticks (a straight line)
      //pieSeries.ticks.template.disabled = true;
      pieSeries.ticks.template.fill = "#ffff00";
      
      // Create a base filter effect (as if it's not there) for the hover to return to
      var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
      shadow.opacity = 0;
      
      // Chart Title

      // Create hover state
      var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

      // Slightly shift the shadow and make it more prominent on hover
      var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
      hoverShadow.opacity = 0.7;
      hoverShadow.blur = 5;
      
      // Add a legend
      const LEGEND_FONT_SIZE = 17;
      chart.legend = new am4charts.Legend();
      chart.legend.valueLabels.template.align = "right"
      chart.legend.valueLabels.template.textAlign = "end";
      
      //chart.legend.position = "bottom";
      chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
      chart.legend.labels.template.fill = "#ffffff";
      chart.legend.labels.template.fontWeight = "bold";

      chart.legend.valueLabels.template.fill = am4core.color("#ffffff"); 
      chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
      pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
      //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";
      
      /// Define marker symbols properties
      var marker = chart.legend.markers.template.children.getIndex(0);
      var markerTemplate = chart.legend.markers.template;
      marker.cornerRadius(12, 12, 12, 12);
      marker.strokeWidth = 1;
      marker.strokeOpacity = 1;
      marker.stroke = am4core.color("#ccc");
      markerTemplate.width = 18;
      markerTemplate.height = 18;
      
      // This creates initial animation
      //pieSeries.hiddenState.properties.opacity = 1;
      //pieSeries.hiddenState.properties.endAngle = -90;
      //pieSeries.hiddenState.properties.startAngle = -90;
      
      // Click chart and filter, update maps
            
      // Click chart and filter, update maps
      pieSeries.slices.template.events.on("hit", filterByChart, this);
      function filterByChart(ev) {
        const SELECTED = ev.target.dataItem.category;
        if (SELECTED == DamageRating()[1]) {
          selectedStatus = 1;
        } else if (SELECTED == DamageRating()[2]) {
          selectedStatus = 2;
        } else if (SELECTED == DamageRating()[3]) {
          selectedStatus = 3;
        } else if (SELECTED == DamageRating()[4]) {
          selectedStatus = 4;
        } else if (SELECTED == DamageRating()[5]) {
          selectedStatus = 5;
        } else {
          selectedStatus = null;
        }
        
        view.when(function() {
          view.whenLayerView(hospitalLayer).then(function (layerView) {
            chartLayerView = layerView;
            chartPanelDiv.style.visibility = "visible";
            
            hospitalLayer.queryFeatures().then(function(results) {
              const RESULT_LENGTH = results.features;
              const ROW_N = RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i < ROW_N; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
              }

              var queryExt = new Query({
                 objectIds: objID
              });

              hospitalLayer.queryExtent(queryExt).then(function(result) {
                  if (result.extent) {
                      view.goTo(result.extent)
                  }
              });

              if (highlightSelect) {
                  highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
                layerView.filter = null;
                highlightSelect.remove();
              });
            }); // End of queryFeatures
            layerView.filter = {
              where: "Damage = " + selectedStatus
            }
          }); // End of view.whenLayerView
        }); // End of view.when
      } // End of filterByChart

    } // End of createSlices function

    createSlices("status", "Damage");
 
        }); // End of queryFeatures
    } // End of updateChart()
    updateChart();

}); // End of am4core.ready
view.ui.empty("top-left");

// Full screen logo
view.ui.add(
  new Fullscreen({
    view: view,
    element: viewDiv
  }),
  "bottom-left"
  );

  /*
var legend = new Legend({
  view: view,
  container: legendDiv,
  layerInfos: [
  {
    layer: hospitalLayer,
    title: "Hospital Damage Rating"
  }
]
});
view.ui.add(legend, {
  position: "bottom-left"
});
*/



      });
    </script>
  </head>
  <body class="sassy-theme">
      <div id="legendDiv" class="esri-widget"></div>
    <div id="viewDiv">
      <div id="titleDiv" class="esri-widget">HOSPITAL DAMAGE RATING MAP</div>
    <div id="chartPanelDiv">
      <div id="chartdiv"></div>
  </div>
</div>
  </body>
</html>
