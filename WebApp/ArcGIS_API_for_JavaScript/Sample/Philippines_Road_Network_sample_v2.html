<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      Sample
    </title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #legendDiv {
        background-color: rgb(0, 0, 0, 0.5);
        z-index: 99;
        position: absolute;
        display: none;
      }


      #titleDiv {
        position: absolute;
        font-style: normal;
        font-weight: bold;
        font-size: 3.8vw;
        color: white;
        background-color: rgb(0, 0, 0, 0);
        width: 35vw;
        z-index: 99;
        top: 30;
        left: 30;
      }

      #applicationDiv {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;         
      }

      #menu {
  padding: 3px 3px 3px 3px;
  background-color: rgb(0,0,0,0.3);
  color: white;
}
      #messageDiv {
        padding-left: 10px;
        padding-right: 10px;
      }

      #dropdownDiv {
        background-color: rgb(0, 0, 0 ,0);
        font-size: 1.1vw;
        opacity: 1;
        color: white;
        font-weight: bold;
        padding-right: 5;
        padding-top: 6;
        right: 100;
        top: 19;
        z-index: 99;
        position: absolute;
        
      }

      #chartPanelDiv {
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        z-index: 99;
        position: absolute;
        left: 5;
        bottom: 25;
        background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        background-color: rgb(0,0,0,0.5);
        width: 15%;
        height: 40%;
      }

      #chartdiv {
          align-items: center;
          font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
          padding: 0;
          margin: 0;
      }

      /*-Major Road Damage List-*/
      .panel-side {
        z-index: 99;
        position: absolute;
        right: 5px;
        top: 30%;
        padding: 0px;
        box-sizing: border-box;
        width: 12vw;
        height: 60%;
        position: fixed;
        margin: 1 3 3 1;
        color: #fff;
        background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
        border-color: white;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        background-color: rgb(0,0,0,0.5);
        overflow-y: scroll;
        overflow-x: auto;
      }

    .panel-side h2 {
      padding-bottom: 10px;
        margin: 0;
        width: 12.25vw;
        font-size: 1.1vw;
        font-weight: 600;
        text-align: center;
        color: white;
        background-color: rgb(0, 0, 0);
        position: sticky;
        top: 0;
      }

      .panel-side h2 b {
        color: white;
        padding-left: 10px;
      }

      .panel-side img {
        padding-top: 5%;
        width: 28;
        height: 28;
        animation: fadeIn 5s infinite;
      }

      @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }


      .panel-side ul {
        list-style: none;
        margin: 0;
        padding: 0;
        font-weight: 100;
        color: white;
        font-size: 1.2vw;
        background-color: rgb(0, 0, 0, 0.4);
      }

      .panel-side li {
        list-style: none;
        padding: 3% 5%;
        font-size: 0.8vw;
        background-color: rgb(0, 0, 0, 0);
      }

      .panel-side li b{
        color: red;
        font-size: 0.8vw;
      }

      .panel-result {
        cursor: pointer;
        margin: 0px 0;
        background-color: rgb(0, 0, 0, 0.4);
      }

      .panel-result:hover,
      .panel-result:focus,
      .panel-result.selected {
        background-color: rgba(73, 72, 72, 0.4);
      }
      
      #majorRoadDamageList {
        background-color: rgb(0, 0, 0, 0.4);
        width: 16vw;
        height: 88vh;
      }



    /*-General-*/
    h6 {
        color: rgb(0, 197, 255);
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        text-align: center;
        font-weight: normal;
        font-size: 1vw;
        }
    
    .active, .test:hover {
      background-color: rgba(77, 75, 75, 0);
        color: orange;
        font-size: 2.3vw;
}

    /* Esris Setting */
    .esri-layer-list__item-toggle-icon,
      .esri-layer-list__item-title {
        color: white;
     }

      .sassy-theme .esri-popup__header-title {
        width: 17vw;
        background-color: rgba(0, 0, 0, 0.8);
      }
      
      .sassy-theme .esri-menu,
      .sassy-theme .esri-popup__main-container,
      .sassy-theme .esri-popup .esri-popup__pointer-direction,
      .sassy-theme .esri-popup .esri-popup__button,
      .sassy-theme .esri-button,
      .sassy-theme .esri-input,
      .sassy-theme .esri-layer-list,
      .sassy-theme .esri-widget a {
        background-color: rgb(0, 0, 0, 0.5);
        color: #fff;
      }
      
      .sassy-theme .esri-legend .esri-legend__layer-cell--info {
        background-color: black;
        color: white;
        font-size: 0.85vw;
      }

      .sassy-theme .esri-legend__layer-caption {
        display: none;
      }

    /* Browser Setting */
      ::-webkit-scrollbar {
        display: none;
      }

    </style>

    <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.24/esri/themes/dark/main.css"
    />
<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://js.arcgis.com/4.24/"></script>

    <script>
      require([
      "esri/Basemap",
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/TileLayer",
        "esri/layers/FeatureLayer",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/rest/support/Query",
        "esri/widgets/Fullscreen",
        "esri/symbols/TextSymbol",
        "esri/views/SceneView",
        "esri/widgets/LayerList",
        "esri/layers/VectorTileLayer",
        "esri/widgets/BasemapToggle",
        "esri/layers/SceneLayer",
        "esri/layers/support/LabelClass"

      ], function(
        Basemap,
        Map,
        MapView,
        TileLayer,
        FeatureLayer,
        Expand,
        Legend,
        Query,
        Fullscreen,
        TextSymbol,
        SceneView,
        LayerList,
        VectorTileLayer,
        BasemapToggle,
        SceneLayer,
        LabelClass

      ) {
// Basemap
var basemap = new Basemap({
  baseLayers: [
    new VectorTileLayer({
      portalItem: {
        id: "0a0d74b5fbc0431fa0f6c938d0b04505"
      }
    })
  ]
});

// Add Map
var map = new Map({
  basemap: basemap, // "streets-night-vector"
  //ground: "world-elevation"

}); 
//map.ground.surfaceColor = "#FFFF";
//map.ground.opacity = 0.5;


// Add scene view
var view = new SceneView({
  map: map,
  container: "viewDiv",
  viewingMode: "local",
  camera: {
    position: {
      x: 121.01,
      y: 14.61,
      z: 60000
    },
    tilt: 50
  },
  environment: {
    background: {
      type: "color", // autocasts as new ColorBackground()
      color: [0, 0, 0, 1]
    },
    
    // disable stars
    starsEnabled: false,
          
    //disable atmosphere
    atmosphereEnabled: false
  }
});

// Basemap Toggle
const toggle = new BasemapToggle({
  view: view,
  nextBaseMap: "hybrid"
});
view.ui.add(toggle, "top-right");

function catchAbortError(error) {
  if (error.name != "AbortError") {
    console.error(error);
  }
}

// OpenStreetMap 3D Buildings
let osmSymbol = {
  type: "mesh-3d",
  symbolLayers: [
    {
      type: "fill",
      material: {
        color: [74, 80, 87, 0.5],
        colorMixMode: "replace"
      },
      edges: {
        type: "solid", // autocasts as new SolidEdges3D()
        color: [225, 225, 225, 0.3]
      }
  }
]
};


var osm3D = new SceneLayer({
  portalItem: {
    id: "ca0470dbbddb4db28bad74ed39949e25"
  },
  title: "OpenStreetMap 3D Buildings"
});
map.add(osm3D);
osm3D.renderer = {
  type: "simple",
  symbol: osmSymbol
}


// Major Road network
var majorRoadRenderer = {
  type: "unique-value",
  valueExpression: "When($feature.ROAD_SEC_CLASS == 'Primary', 'Primary', \
                           $feature.ROAD_SEC_CLASS == 'Secondary', 'Secondary', \
                           $feature.ROAD_SEC_CLASS)",
  uniqueValueInfos: [
    {
      value: 'Primary',
      label: 'Primary',
      symbol: {
        type: "simple-line",
        color: [236, 76, 0],
        width: "4px",
        style: "solid"
      }
    },
    {
      value: 'Secondary',
      label: 'Secondary',
      symbol: {
        type: "simple-line",
        color: [0, 169, 230],
        width: "2px",
        style: "solid"
      }
    }
  ]
}
var majorRoadLayer = new FeatureLayer({
  portalItem: {
                id:"ab0e0cd5e38d471ba24c5177a4f7279a"
            },
            title: "Major Road",
            outFields: ["*"],
            popupEnabled: false,
            layerId: 2,
            elevationInfo: {
              mode: "on-the-ground"
            },
            renderer: majorRoadRenderer,
            minScale: 1200000,
    maxScale: 0,
            returnGeometry: true

});
map.add(majorRoadLayer);

// Expressway
var expressRoadRenderer = {
  type: "simple",
  symbol: {
        type: "simple-line",
        color: [56, 168, 0],
        width: "4px",
        style: "solid"
      }
};

var expressRoad = new FeatureLayer({
    portalItem: {
        id: "ab0e0cd5e38d471ba24c5177a4f7279a"
    },
    title: "Expressway",
    layerId: 3,
    elevationInfo: {
              mode: "on-the-ground"
            },
    outFields: ["*"],
    renderer: expressRoadRenderer,
    popupEnabled: false,
    returnGeometry: true,
    minScale: 1200000,
    maxScale: 0,
});
map.add(expressRoad);

// Municipal Boundary
var municialLabelClass = {
  symbol: {
            type: "label-3d",// autocasts as new LabelSymbol3D()
            symbolLayers: [
              {
                type: "text", // autocasts as new TextSymbol3DLayer()
                material: {
                  color: "white"
                },
                size: 10,
                color: "black",
                haloColor: "black",
                haloSize: 1,
                font: {
                  family: "Ubuntu Mono",
                  //weight: "bold"
                },
              }
            ],
            verticalOffset: {
              screenLength: 100,
              maxWorldLength: 600,
              minWorldLength: 300
            },
            callout: {
              type: "line", // autocasts as new LineCallout3D()
              color: "white",
              size: 0.7,
              border: {
                color: "grey"
              }
            }
          },
          labelPlacement: "above-center",
          labelExpressionInfo: {
            expression: "$feature.MUNICIPALITY"
            //value: "{TEXTSTRING}"
        }
      }

      //NO__OF_BGYS_
let ngcpDpwhRoadRenderer = {
  type: "simple",
  symbol: {
      type: "simple-fill",
      color: [0, 197, 255, 0.05],
      style: "solid",
      outline: {
        color: "white",
        width: 3,
        style: "short-dot"
      }
    }
}
var municipalBoundary = new FeatureLayer({
    portalItem: {
        id: "ab0e0cd5e38d471ba24c5177a4f7279a"
    },
    title: "Municipal Boundary",
    layerId: 4,
    renderer: ngcpDpwhRoadRenderer,
    outFields: ["*"],
    labelingInfo: [municialLabelClass],
    popupEnabled: false,
    returnGeometry: true
});
map.add(municipalBoundary,0);


// Damage points
var verticalOffsetMajorDamage = {
  screenLength: 100,
  maxWorldLength: 700,
  minWorldLength: 100
};

var verticalOffsetOtherDamage = {
  screenLength: 100,
  maxWorldLength: 500,
  minWorldLength: 100
};

function getUniqueValueSymbol(name, sizeS, damage) {
    if (damage === 'Major') {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
            {
                type: "icon", // autocasts as new IconSymbol3DLayer()
                resource: {
                  href: name
                },
                size: sizeS,
                outline: {
                  color: "white",
                  size: 2
                }
              }
            ],
            verticalOffset: verticalOffsetMajorDamage,

            callout: {
              type: "line", // autocasts as new LineCallout3D()
              color: "white",
              size: 1,
              border: {
                color: "grey"
              }
            }
        }
    } else {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
            {
                type: "icon", // autocasts as new IconSymbol3DLayer()
                resource: {
                  href: name
                },
                size: sizeS,
                outline: {
                  color: "white",
                  size: 2
                }
              }
            ],
            verticalOffset: verticalOffsetOtherDamage,

            callout: {
              type: "line", // autocasts as new LineCallout3D()
              color: "white",
              size: 1,
              border: {
                color: "grey"
              }
            }
        }
    }

    }


var damageRatingSymbol = {
    type: "unique-value",
    valueExpression: "When($feature.Rating == 1, 'Basic', \
                           $feature.Rating == 2, 'Minor', \
                           $feature.Rating == 3, 'Moderate', \
                           $feature.Rating == 4, 'Major', $feature.Rating)",

    uniqueValueInfos: [
        {
            value: "Basic",
            label: "Basic",
            symbol: getUniqueValueSymbol(
                "https://EijiGorilla.github.io/Symbols/Warning Symbol/Basic.svg",
                30,
                "Basic"
            )
        },
        {
            value: "Minor",
            label: "Minor",
            symbol: getUniqueValueSymbol(
                "https://EijiGorilla.github.io/Symbols/Warning Symbol/Minor.svg",
                30,
                "Minor"
            )
        },
        {
            value: "Moderate",
            label: "Moderate",
            symbol: getUniqueValueSymbol(
                "https://EijiGorilla.github.io/Symbols/Warning Symbol/Moderate.svg",
                30,
                "Moderate"
            )
        },
        {
            value: "Major",
            label: "Major",
            symbol: getUniqueValueSymbol(
                "https://EijiGorilla.github.io/Symbols/Warning Symbol/Major.svg",
                30,
                "Major"
            )
        }
    ]
}


var damagePoints = new FeatureLayer({
    portalItem: {
        id: "ab0e0cd5e38d471ba24c5177a4f7279a"
    },
    title: "Damage Ratings of Road",
    layerId: 0,
    renderer: damageRatingSymbol,
    outFields: ["*"],
    popupEnabled: false,
    minScale: 1200000,
    maxScale: 0,
    returnGeometry: true
})
map.add(damagePoints,1);

// Coundary Boundary
var phpBoundary = new FeatureLayer({
          portalItem: {
                id:"ab0e0cd5e38d471ba24c5177a4f7279a"
            },
            layerId: 8,
            title: "Boundary",
            outFields: ["*"],
            labelsVisible: false,
            popupEnabled: false
        });
map.add(phpBoundary);


        // listen to the view's click event
        
    // Pier Chart to summarize damage ratings of hospitals in Ukraine
let chartLayerView;
var highlightSelect;

var titleDiv = document.getElementById("titleDiv");
const chartPanelDiv = document.getElementById("chartPanelDiv");
var municipalSelect = document.getElementById("municipalSelect");


/* Function for zooming to selected layers */
function zoomToLayer(layer) {
  return layer.queryExtent().then(function(response) {
    view.goTo(response.extent, { //response.extent
      speedFactor: 2
    }).catch(function(error) {
      if (error.name != "AbortError") {
        console.error(error);
      }
    });
  });
}

// Chart
// Call amCharts 4
am4core.ready(function() {
am4core.useTheme(am4themes_animated);

// Default Setting
zoomToLayer(damagePoints);
updateChart();

// Create dropdown list for Municipality
view.when(function() {
    return damagePoints.when(function() {
        var query = damagePoints.createQuery();
        return damagePoints.queryFeatures(query);
    });
})
.then(getValues)
.then(getUniqueValues)
.then(addToSelect)

/// 1.3. Query for geometry
function queryForLotGeometries() {
    var municipalQuery = damagePoints.createQuery();

    return damagePoints.queryFeatures(municipalQuery).then(function(response) {
        municipalGeometries = response.features.map(function(feature) {
            return feature.geometry;
        });
        return municipalGeometries;
    });
  }

  /// 2.1. Land Type
function getValues(response) {
    var features = response.features;
    var values = features.map(function(feature) {
        return feature.attributes.MUNICIPALITY;
    });
    return values;
}

// Return an array of unique values in Type field of the lot Layer
function getUniqueValues(values) {
    var uniqueValues = [];

    values.forEach(function(item, i) {
        if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
            uniqueValues.push(item);
            //headerTitleDiv.innerHTML = uniqueValues;
        }
    });
    return uniqueValues;
}

// Add the unique values to Land Type select element
function addToSelect(values) {
    values.sort();
    values.unshift('None'); // Add 'None' to the array and place it to the beginning of the array
    values.forEach(function(value) {
        var option = document.createElement("option");
        option.text = value;
        municipalSelect.add(option);
    });
}

function municipalExpression(value) {
  if (value === 'None') {
    municipalBoundary.definitionExpression = null;
    damagePoints.definitionExpression = null;
    municipalBoundary.visible = false;
    zoomToLayer(municipalBoundary);

  } else {
    municipalBoundary.definitionExpression = "MUNICIPALITY = '" + value + "'";
    damagePoints.definitionExpression = "MUNICIPALITY = '" + value + "'";
    zoomToLayer(municipalBoundary);
    municipalBoundary.visible = true;
  }


  return queryForLotGeometries();

}

municipalSelect.addEventListener("change", function() {
  var type = event.target.value;

  municipalExpression(type);
  updateChart();

  filterDamagePoints();
  filterMunicipalBoundary();

});


function filterDamagePoints() {
  var query2 = damagePoints.createQuery();
  query2.where = damagePoints.definitionExpression; // use filtered stations
}

function filterMunicipalBoundary() {
  var query2 = municipalBoundary.createQuery();
  query2.where = municipalBoundary.definitionExpression; // use filtered stations
}


//------------- list of Major Road Damage ------------------//
view.when(function() {
  //reloStatusLayer.outFields = ["Name", "StatusRC", "Status"];
  
  var majorRoadDamageList = document.getElementById("majorRoadDamageList");
  
  // Obtain a list of Owner's names and status
  view.whenLayerView(damagePoints).then(function(damagelayerView) {
    damagelayerView.watch("updating", function(val) {
      if (!val) {

        // Query for only Expropriation lots
        var query = new Query();
        query.where = "Rating = 4";
        damagelayerView.queryFeatures(query).then(function(result) {
          majorRoadDamageList.innerHTML = "";
          result.features.forEach(function(feature) {
            var attributes = feature.attributes;
            var li = document.createElement("li");
            li.setAttribute("class", "panel-result");

            // Add Expropriation lots to list
            li.innerHTML = "<b>" + attributes.SECTION_ID + "</b>" + "<br>" + attributes.ROAD_SEC_CLASS + "</br>" + attributes.ROAD_NAME;
            li.addEventListener("click", function(event) {
              var target = event.target;
              var objectId = feature.attributes.OBJECTID;
              var queryExtent = new Query({
                objectIds: [objectId]
              });
              
              // Query extent for selected expropriation lot in the list
              damagelayerView.queryExtent(queryExtent).then(function(result) {
                if (result.extent) {
                  view.goTo({
                    target: result.extent,
                    speedFactor: 2,
                    zoom: 17})
                    .catch(function(error) {
                      if (error.name != "AbortError") {
                        console.error(error);
                      }
                    }); // End of catch
                  } // End of if (result.extent)
                }); // End of layerView.queryExtent
                
                // Highlight selected lots
                if (highlightSelect) {
                  highlightSelect.remove();
                }
                highlightSelect = damagelayerView.highlight([objectId]);
                
                view.on("click", function() {
                  damagelayerView.filter = null;
                  highlightSelect.remove();
                });
              
              }); // End of li.addEventListener
              majorRoadDamageList.appendChild(li);
            }); // End of result.features.forEach
          }); // End of layerView.queryFeatures
        } // End of if (!val)
     }); // End of layerView.watch
  }); // End of view.whenLayerView
}); // End of view.when()




// Road Damage Chart:-------------------------------------------------------
async function updateChart() {
    function DamageRating(){
  return {
    1: "Basic",
    2: "Minor",
    3: "Moderate",
    4: "Major"
  }
}

        var total_basic = {
            onStatisticField: "CASE WHEN Rating = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_basic",
            statisticType: "sum"
        }

        var total_minor = {
            onStatisticField: "CASE WHEN Rating = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_minor",
            statisticType: "sum"
        }
        
        var total_moderate = {
            onStatisticField: "CASE WHEN Rating = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_moderate",
            statisticType: "sum"
        }

        var total_major = {
            onStatisticField: "CASE WHEN Rating = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_major",
            statisticType: "sum"
        }

        var query = damagePoints.createQuery();
        query.outStatistics = [total_basic, total_minor, total_moderate, 
                               total_major];

        query.returnGeometry = true;

        damagePoints.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const TOTAL_BASIC = stats.total_basic;
            const TOTAL_MINOR = stats.total_minor;
            const TOTAL_MODERATE = stats.total_moderate;
            const TOTAL_MAJOR = stats.total_major;
            
            var chart = am4core.create("chartdiv", am4charts.PieChart);
                // Add data
    chart.data = [
      {
        "Damage": DamageRating()[1],
        "status": TOTAL_BASIC,
        "color": am4core.color("#00B050")
      },
      {
        "Damage": DamageRating()[2],
        "status": TOTAL_MINOR,
        "color": am4core.color("#FFFF00")   
      },
      {
        "Damage": DamageRating()[3],
        "status": TOTAL_MODERATE,
        "color": am4core.color("#FFAA00") 
      },
      {
        "Damage": DamageRating()[4],
        "status": TOTAL_MAJOR,
        "color": am4core.color("#FF0000")
      }
    ];
    // Set inner radius
    chart.innerRadius = am4core.percent(30);
    
    // Add and configure Series
    function createSlices(field, status){
      var pieSeries = chart.series.push(new am4charts.PieSeries());
      pieSeries.dataFields.value = field;
      pieSeries.dataFields.category = status;
      
      pieSeries.slices.template.propertyFields.fill = "color";
      pieSeries.slices.template.stroke = am4core.color("#fff");
      pieSeries.slices.template.strokeWidth = 1;
      pieSeries.slices.template.strokeOpacity = 1;
      pieSeries.slices.template
      // change the cursor on hover to make it apparent the object can be interacted with
      .cursorOverStyle = [
        {
          "property": "cursor",
          "value": "pointer"
        }
      ];
      
      // Hover setting
      pieSeries.tooltip.label.fontSize = 9;
      
      // Pie
      //pieSeries.alignLabels = false;
      //pieSeries.labels.template.bent = false;
      pieSeries.labels.template.disabled = true;
      pieSeries.labels.template.radius = 3;
      pieSeries.labels.template.padding(0,0,0,0);
      pieSeries.labels.template.fontSize = 9;
      pieSeries.labels.template.fill = "#ffffff";

      // Ticks (a straight line)
      //pieSeries.ticks.template.disabled = true;
      pieSeries.ticks.template.fill = "#ffff00";
      
      // Create a base filter effect (as if it's not there) for the hover to return to
      var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
      shadow.opacity = 0;
      
      // Chart Title

      // Create hover state
      var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

      // Slightly shift the shadow and make it more prominent on hover
      var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
      hoverShadow.opacity = 0.7;
      hoverShadow.blur = 5;
      
      // Add a legend
      const LEGEND_FONT_SIZE = 13;
      chart.legend = new am4charts.Legend();
      chart.legend.valueLabels.template.align = "right"
      chart.legend.valueLabels.template.textAlign = "end";
      
      //chart.legend.position = "bottom";
      chart.legend.labels.template.fontSize = LEGEND_FONT_SIZE;
      chart.legend.labels.template.fill = "#ffffff";
      //chart.legend.labels.template.fontWeight = "bold";

      chart.legend.valueLabels.template.fill = am4core.color("#ffffff"); 
      chart.legend.valueLabels.template.fontSize = LEGEND_FONT_SIZE; 
      pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.')}% ({value})";
      //pieSeries.legendSettings.labelText = "Series: [bold {color}]{category}[/]";
      
      /// Define marker symbols properties
      var marker = chart.legend.markers.template.children.getIndex(0);
      var markerTemplate = chart.legend.markers.template;
      marker.cornerRadius(12, 12, 12, 12);
      marker.strokeWidth = 1;
      marker.strokeOpacity = 1;
      marker.stroke = am4core.color("#ccc");
      markerTemplate.width = 18;
      markerTemplate.height = 18;
      
      // This creates initial animation
      //pieSeries.hiddenState.properties.opacity = 1;
      //pieSeries.hiddenState.properties.endAngle = -90;
      //pieSeries.hiddenState.properties.startAngle = -90;
      
      // Click chart and filter, update maps
            
      // Click chart and filter, update maps
      pieSeries.slices.template.events.on("hit", filterByChart, this);
      function filterByChart(ev) {
        const SELECTED = ev.target.dataItem.category;
        if (SELECTED == DamageRating()[1]) {
          selectedStatus = 1;
        } else if (SELECTED == DamageRating()[2]) {
          selectedStatus = 2;
        } else if (SELECTED == DamageRating()[3]) {
          selectedStatus = 3;
        } else if (SELECTED == DamageRating()[4]) {
          selectedStatus = 4;
        } else {
          selectedStatus = null;
        }
        
        view.when(function() {
          view.whenLayerView(damagePoints).then(function (layerView) {
            chartLayerView = layerView;
            chartPanelDiv.style.visibility = "visible";
            
            damagePoints.queryFeatures().then(function(results) {
              const RESULT_LENGTH = results.features;
              const ROW_N = RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i < ROW_N; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
              }

              var queryExt = new Query({
                 objectIds: objID
              });

              damagePoints.queryExtent(queryExt).then(function(result) {
                  if (result.extent) {
                      view.goTo(result.extent)
                  }
              });

              if (highlightSelect) {
                  highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
                layerView.filter = null;
                highlightSelect.remove();
              });
            }); // End of queryFeatures
            layerView.filter = {
              where: "Rating = " + selectedStatus
            }
          }); // End of view.whenLayerView
        }); // End of view.when
      } // End of filterByChart

    } // End of createSlices function

    createSlices("status", "Damage");
 
        }); // End of queryFeatures
    } // End of updateChart()


}); // End of am4core.ready

/////////////////////////////////////////////////////////
view.ui.empty("top-left");

// Full screen logo
view.ui.add(
  new Fullscreen({
    view: view,
    element: viewDiv
  }),
  "top-right"
  );


var legend = new Legend({
  view: view,
  container: legendDiv,
  layerInfos: [
    {
        layer: damagePoints,
        title: "Damage Ratings of Road"
    },
  {
    layer: majorRoadLayer,
    title: "Major Raod"
  },
  {
    layer: expressRoad,
    title: "Expressway"
  },
  {
    layer: municipalBoundary,
    title: "Municipal Boundary"
  },
  {
    layer: phpBoundary,
    title: "Country Boundary"
  }
]
});

var legendExpand = new Expand({
    view: view,
    content: legend,
    expandIconClass: "esri-icon-legend",
    group: "bottom-right"
});
view.ui.add(legendExpand, {
    position: "top-right"
});


// LayerList and Add legend to the LayerList
var layerList = new LayerList({
  view: view,
  listItemCreatedFunction: function(event) {
    const item = event.item;
    if (item.title === "Municipal Boundary" || item.title === "Boundary"){
      item.visible = false
    }
  }
});

var layerListExpand = new Expand ({
    view: view,
    content: layerList,
    expandIconClass: "esri-icon-visible",
    group: "top-right"
});
view.ui.add(layerListExpand, {
    position: "top-right"
});

// See-through-Ground
view.when(function() {
  // allow navigation above and below the ground
  map.ground.navigationConstraint = {
    type: "none"
  };
  // the webscene has no basemap, so set a surfaceColor on the ground
  map.ground.surfaceColor = "#fff";
          
  // to see through the ground, set the ground opacity to 0.4
  map.ground.opacity = 0.9;
});
document.getElementById("opacityInput")
        .addEventListener("change", function(event) {
          map.ground.opacity = event.target.checked ? 0.1 : 0.6;
        });
view.ui.add("menu", "bottom-right");

      });
    </script>
  </head>
  <body class="sassy-theme">
    <div id="viewDiv">
      <div id="titleDiv" class="esri-widget">ROAD DAMAGE</div>
      <div class="esri-widget" id="dropdownDiv">
        <label for="sel-options">Municipality</label>
        <select id="municipalSelect" class="esri-widget"></select>
      </div>
      <div id="chartPanelDiv">
        <div id="chartdiv"></div>
      </div>
      <div id="menu" class="esri-widget">
        <input type="checkbox" id="opacityInput" unchecked />
        <label for="opacityInput">See through ground</label>
      </div>
      <div id="legendDiv" class="esri-widget"></div>
      <div class="panel-side esri-widget">
        <h2><img id="listImage" src="https://EijiGorilla.github.io/Symbols/Warning Symbol/Major.svg"><b>Major Damage</b></h2>
        <ul id="majorRoadDamageList">
          <li>Loading&hellip;</li>
        </ul>
      </div>
    </div>
  </body>
</html>
