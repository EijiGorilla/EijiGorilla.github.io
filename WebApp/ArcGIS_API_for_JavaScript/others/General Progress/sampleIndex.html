<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Sample</title>
    
        <!-- https://www.esri.com/arcgis-blog/products/arcgis-living-atlas/public-safety/wildfire-aware-app-design-and-implementation/-->

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.26/"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
    }

    #container {
      display: grid;
      flex-wrap: wrap;
      box-sizing: border-box;
      grid-template-columns: 1fr 0.25fr;
      width: 100%;
      height: 100%;
    }

    calcite-tab {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-button {
      display: block;
      margin: 20;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #contractPackageDiv {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }

    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    #layerListContainer {
      width: 230px;
      max-height: 87%;
      overflow-y: auto;
      position: absolute;
      z-index: 1;
      bottom: 1rem;
      left: 0px;
      background-color: transparent;
    }

    /* CHART AND CONTENT PANEL */
    #chartPanel {
      background-color: rgb(0, 0, 0, 0);
      padding: 8;
      width: 100%;
      height: 100%;
    }
    
    #landPieChartDiv,
    #structurePieChartDiv,
    #nloPieChartDiv {
      height: 45%;
      margin-bottom: 5;
    }


    .lotNumber-container,
    .structureNumber-container,
    .nloNumber-container,
    .pteLot-container,
    .pteStructure-container {
      display: flex;
    }

    #lotNumberDiv,
    #structureNumberDiv,
    #nloNumberDiv,
    #pteLotNumberDiv,
    #pteStructureNumberDiv {
      width: 50%;
      height: 10%;
      padding-top: 2%;
      padding-left: 15px;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #pteLotNumberDiv b,
    #pteStructureNumberDiv b {
      font-size: 2vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #landImage,
    #landNumberImage,
    #nloNumberImage,
    #structureImage,
    #structureNumberImage {
      width: 23%;
      height: auto;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      margin-bottom: -10;
    }

    #lotNumberDiv b,
    #nloNumberDiv b,
    #structureNumberDiv b {
      font-size: 2.5vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #chartMoaLotDiv,
    #chartMoaStructureDiv {
      width: 100%;
      height: 30%;
      align-items: center;
      padding: 1%;
      margin-top: 10%;
    }

    b {
        color: orange;
    }

    /* SCROLL BAR */
    ::-webkit-scrollbar {
      width: 5px;
      
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #00032235; /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #FFBA1F;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
      }

    /*
    .esri-legend__layer-cell--info {
      background-color: black;
      color: white;
      font-size: 0.85vw;
    }
    */

    .esri-legend {
      overflow: hidden;
      overflow-y: auto;
      margin-left: -10;
    }



    /*
    .esri-legend__layer-cell {
      min-width: 100px;
      word-break: break-word;
      padding: 0;
      vertical-align: middle;
      margin: 0;
    }
    */

  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">

        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>
        <div id="dateDiv"></div>

        <!-- Dropdown Lists -->
        <div id="contractPackageDiv">
          <calcite-segmented-control>
            <calcite-segmented-control-item id="All" value="all" checked>All</calcite-segmented-control-item>
            <calcite-segmented-control-item id="N-01" value="n-01">N-01</calcite-segmented-control-item>
            <calcite-segmented-control-item id="N-02" value="n-02">N-02</calcite-segmented-control-item>
            <calcite-segmented-control-item id="N-03" value="n-03">N-03</calcite-segmented-control-item>
            <calcite-segmented-control-item id="N-04" value="n-04">N-04</calcite-segmented-control-item>
            <calcite-segmented-control-item id="N-05" value="n-05">N-05</calcite-segmented-control-item>
          </calcite-segmented-control>
        </div>
      </div>
      <div id="container">
      <div id="viewDiv">
        <div id="layerListContainer" class="esri-widget">
          <div id = "layer-List-Container-background" style = "margin: auto 0; background: none;" hidden>
            <calcite-list>
              <calcite-list-item label="Land Acquisition" description="" value="land-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="land-check" style="margin-left: 5px" checked></calcite-checkbox>
                <div id="land-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
              </calcite-list-item>
              <calcite-list-item label="Existing Structure" description="" value="structure-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="structure-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="structure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Non-Land Owner" description="" value="NLO-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="NLO-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="nlo-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Occupancy (Structure)" description="" value="occupancy-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="occupancy-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="occupancy-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="NLO/LO Ownership (Structure)" description="" value="strucOwnership-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="strucOwnership-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="strucOwnership-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Free-and-Clear Land" description="" value="fnc-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="fnc-check" style="margin-left: 5px" checked></calcite-checkbox>
                  <div id="fnc-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
                </calcite-list-item>
                <calcite-list-item label="PNR Land" description="" value="pnr-acquisition">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="pnr-check" style="margin-left: 5px" checked></calcite-checkbox>
                  <div id="pnr-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
                </calcite-list-item>
                <calcite-list-item label="Tree Cutting" description="" value="treeCutting">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="treeCutting-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="treeCutting-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Tree Compensation" description="" value="treeCompensation">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="treeCompensation-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="treeCompensation-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Utility Relocation (Point Sybmol)" description="" value="utility-point">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="utilityPoint-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="utilityPoint-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Utility Relocation (Point Status)" description="" value="utility-pointStatus">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="utilityPointStatus-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="utilityPointStatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Utility Relocation (Line Symbol)" description="" value="utility-line">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="utilityLine-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="utilityLine-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Utility Relocation (Line Status)" description="" value="utility-lineStatus">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="utilityLineStatus-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="utilityLineStatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Pier with Access Date" description="" value="pierAccess-date">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="pierAccess-check" style="margin-left: 5px" checked></calcite-checkbox>
                  <div id="pierAccess-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
                </calcite-list-item>
                <calcite-list-item label="Station Box" description="" value="stationBox">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="stationBox-check" style="margin-left: 5px" checked></calcite-checkbox>
                  <div id="stationBox-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
                </calcite-list-item>
                <calcite-list-item label="PROW" description="" value="prow">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="prow-check" style="margin-left: 5px" checked></calcite-checkbox>
                  <div id="prow-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
                </calcite-list-item>
                <calcite-list-item label="Chainage" description="" value="chainage">
                <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="chainage-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="chainage-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
                <calcite-list-item label="Viaduct" description="" value="viaduct">
                  <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                  <calcite-checkbox slot="actions-start" id="viaduct-check" style="margin-left: 5px"></calcite-checkbox>
                  <div id="viaduct-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                </calcite-list-item>
              </div>
          <calcite-button
          icon-end="launch"
          id="layer-list-button"
        >
          MAP LAYERS
        </calcite-button>
        </div>
      </div>
      <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
      <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
      <calcite-tabs>
        <div id="chartPanel">
            <calcite-tab-nav slot="tab-nav" id="thetabs">
                <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                <calcite-tab-title class="ISF">NLO</calcite-tab-title>
                <calcite-tab-title class="ExproList">Expro List</calcite-tab-title>
            </calcite-tab-nav>
            <calcite-tab>
              <div class="lotNumber-container">
                <div id="lotNumberDiv"></div>
                <img id="landNumberImage" src="https://EijiGorilla.github.io/Symbols/Land_logo.png">
              </div>
              <div class="box" id="landPieChartDiv"></div>
              <div class="pteLot-container">
                <div id="pteLotNumberDiv"></div>
                <img id="landImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaLotDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="structureNumber-container">
                <div id="structureNumberDiv"></div>
                <img id="structureNumberImage" src="https://EijiGorilla.github.io/Symbols/House_Logo.svg">
              </div>
              <div class="box2" id="structurePieChartDiv"></div>
              <div class="pteStructure-container">
                <div id="pteStructureNumberDiv"></div>
                <img id="structureImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaStructureDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="nloNumber-container">
                <div id="nloNumberDiv"></div>
                <img id="nloNumberImage" src="https://EijiGorilla.github.io/Symbols/NLO_Logo.svg">
              </div>
              <div class="box3" id="nloPieChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="panel-side esri-widget">
                <ul id="expropriationListDiv">
                  <li>Loading&hellip;</li>
                </ul>
              </div>
            </calcite-tab>
      </calcite-tabs>
    </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/layers/SceneLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer",
      "esri/core/reactiveUtils",
      "esri/popup/support/FieldInfoFormat"
    ], function(WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer, reactiveUtils, 
                FieldInfoFormat
                 ) {
      
    const mapLayers = document.getElementById("layer-list-button");

    // Label Change: MAP LAYERS <-> CLOSE
    const layerListContainer = document.getElementById("layerListContainer");
    let activeMapLayers;
    const openCloseMapLayerClick = ({ target }) => {
      const layerListContainerBackground = document.getElementById("layer-List-Container-background");
      layerListContainerBackground.hidden = !layerListContainerBackground.hidden;

      if (activeMapLayers) {
        mapLayers.innerHTML = "MAP LAYERS"
        layerListContainer.style.backgroundColor = "transparent";
      }

      const nextMapLayers = target.id;
      if (nextMapLayers !== activeMapLayers) {
        mapLayers.innerHTML = "CLOSE";
        layerListContainer.style.backgroundColor = "#2f2f2f"
        activeMapLayers = nextMapLayers
      } else {
        activeMapLayers = null;
      }
    }
    mapLayers.addEventListener("click", openCloseMapLayerClick);



    // Reference link
    // 2D to 3D
    //https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/

    // 3D Extrusion using point, line, and polygon
    // https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/3d-visualization-working-with-objects-paths-and-extrusion/?rmedium=redirect&rsource=blogs.esri.com/esri/arcgis/2016/01/25/3d-visualization-working-with-objects-paths-and-extrusion


    var map = new Map({
        basemap: "dark-gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    /*
    var view = new MapView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });
    */
    var view = new SceneView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        viewingMode: "local",
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    function colorLotReqs(){
        return {
            0: [0, 197, 255], 
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,0,0,0]
        }
    }

    let lotLayerRenderer = {
        type: "unique-value",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusLA == 0, '0',$feature.StatusLA == 1, '1', $feature.StatusLA == 2, '2', \
                               $feature.StatusLA == 3, '3', $feature.StatusLA == 4, '4', \
                               $feature.StatusLA == 5, '5', $feature.StatusLA)",
        uniqueValueInfos: [
            {
                value: "0",
                label: "Handed-Over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[0],
                }
            },
            {
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            }
        ]
    }

    var lotIdLabel = new LabelClass({
        labelExpressionInfo: {expression: "$feature.LotID"},
        symbol: {
            type: "text",
            color: "black",
            haloColor: "white",
            haloSize: 0.5,
            font: {
                size: 11,
                weight: "bold"
            }
        }
    });

    var lotLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 7,
      renderer:lotLayerRenderer,
      labelingInfo: [lotIdLabel],
      outFields: ["*"],
      title: "Status of Land Acquisition",
      minScale: 150000,
      maxScale: 0,
      //labelsVisible: false,
      elevationInfo: {
        model: "on-the-ground"
      }
    });
    map.add(lotLayer, 1);

    /// Popup for lot layer
    const lotStatusArray = [
        "Handed-Over",
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro"
    ];

    const landUseArray = [
        "Agricultural",
        "Agricultural & Commercial",
        "Agricultural / Residential",
        "Commercial",
        "Industrial",
        "Irrigation",
        "Residential",
        "Road",
        "Road Lot",
        "Special Exempt"
    ]

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked pierAccessLayer
            const lotNo = event.graphic.attributes.LotID;
            const handOverDate = event.graphic.attributes.HandOverDate;
            const handOverArea = event.graphic.attributes.percentHandedOver;
            const statusLot = event.graphic.attributes.StatusLA;
            const landUse = event.graphic.attributes.LandUse;
            const municipal = event.graphic.attributes.Municipality;
            const barangay = event.graphic.attributes.Barangay;
            const landOwner = event.graphic.attributes.LandOwner;
            const cpNo = event.graphic.attributes.CP;

            // Convert numeric to date format

            var date = new Date(handOverDate);
            var DATES = dateFormat(date, 'MM-dd-yyyy');

            if (DATES === '01-01-1970') {
                var finalDate = "Undefined"
            } else {
                var finalDate = dateFormat(date, 'MM-dd-yyyy');
            }
            // Convert domain code to domain name
            /// 1. Status
            if (statusLot >= 0) {
                //headerTitleDiv.innerHTML = lotStatusArray[statusLot];
                var statusLotTemp = lotStatusArray[statusLot];
            }

            if (landUse >=1 ) {
                var landUseTemp = landUseArray[landUse - 1];
            }

            return `<ul><li>Handed-Over Area: <b>${handOverArea} %</b></li><br>
                    <li>Status:           <b>${statusLotTemp}</b></li><br>
                    <li>Land Use:         <b>${landUseTemp}</b></li><br>
                    <li>Municipality:     <b>${municipal}</b></li><br>
                    <li>Barangay:         <b>${barangay}</b></li><br>
                    <li>Land Owner:       <b>${landOwner}</b>
                    <li>CP:               <b>${cpNo}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{LotID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


    // Structure Layer 
    // Polygon 3D extrution
    const height = 5;
    const edgeSize = 0.3;
    const dismantled = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 197, 255, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const paid = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [112, 173, 71, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const payp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 112, 255, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const legalpass = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 255, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const otc = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 170, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const lbp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 0, 0, 0.3]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const structureRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: [0, 0, 0, 0.4]
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: edgeSize
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "StatusStruc",
      legendOptions: {
        title: "Status of Structure"
      },
      uniqueValueInfos: [
        {
          value: 1,
          symbol: dismantled,
          label: "Dismantling/Clearing"
        },
        {
          value: 2,
          symbol: paid,
          label: "Paid"
        },
        {
          value: 3,
          symbol: payp,
          label: "For Payment Processing"
        },
        {
          value: 4,
          symbol: legalpass,
          label: "For Legal Pass"
        },
        {
          value: 5,
          symbol: otc,
          label: "For Appraisal/Offer to Compensation"
        },
        {
          value: 6,
          symbol: lbp,
          label: "LBP Account Opening"
        },
      ]
    }

    var structureLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 6,
      title: "Structure",
      renderer: structureRenderer,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      },
      popupTemplate: {
        title: "<p>{StrucID}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "FamilyNumber",
                label: "<b>Number of Families</b>"
              },
              {
                fieldName: "StrucOwner",
                label: "Structure Owner"
              },
              {
                fieldName: "StatusStruc",
                label: "<p>Status of Structure</p>"
              },
              {
                fieldName: "LotID",
                label: "Lot ID"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              }
            ]
          }
        ]
      }
    });
    map.add(structureLayer);


    // Structure (NLO/LO)
    let NLOLORenderer = {
        type: "unique-value",
        field: "Status",
        uniqueValueInfos:[
            {
                value: 1,
                label: "LO (Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "forward-diagonal",
                    color: [128, 128, 128, 1],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            },
            {
                value: 2,
                label: "NLO (Non-Land Owner)",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    style: "vertical",
                    color: [128, 128, 128, 1],
                    outline: {
                        color: "#6E6E6E",
                        width: 0.3
                    }
                }
            }
        ]
    };

    var strucOwnershipLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        renderer: NLOLORenderer,
        layerId: 3,
        title: "NLO/LO Ownership (Structure)",
        outFields: ["*"],
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    map.add(strucOwnershipLayer);

    // Status of Relocation (Occupancy)
    const outlineColorOccupancy = "gray";

    var verticalOffsetExistingOccupancy = {
      screenLength: 10,
        maxWorldLength: 10,
        minWorldLength: 10
    };

    function getUniqueValueSymbolOccupancy(name, size) {
      return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: size,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetExistingOccupancy,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.6],
          size: 0.4,
          border: {
            color: "grey"
          }
        }
      };
    }
    const occupancyPointSize = 20;
    let occupancyRenderer = {
      type: "unique-value",
      valueExpression: "When($feature.Occupancy == 0, 'Occupied', \
                      $feature.Occupancy == 1, 'Relocated', $feature.Occupancy)",
      uniqueValueInfos: [
        {
          value: "Occupied",
          label: "Occupied",
          symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/Demolished.png", occupancyPointSize),
        },
        {
          value: "Relocated",
          label: "Relocated",
          symbol: getUniqueValueSymbolOccupancy("https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png", occupancyPointSize),
        },
      ]
    };

    var occupancyLayer = new FeatureLayer({
        portalItem: {
            id: "dca1d785da0f458b8f87638a76918496",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        outFields: ["*"],
        title: "Occupancy (Structure)",
        renderer: occupancyRenderer,
        elevationInfo: {
          mode: "relative-to-scene"
        },
        popupTemplate: {
            title: "<p>{StrucID}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
            {
                type: "fields",
                fieldInfos: [
                {
                    fieldName: "StrucOwner",
                    label: "Structure Owner"
                },
                {
                    fieldName: "Municipality"
                },
                {
                    fieldName: "Barangay"
                },
                {
                    fieldName: "Occupancy",
                    label: "<p>Status for Relocation(structure)</p>"
                },
                {
                    fieldName: "Name",
                },
                {
                    fieldName: "Status",
                    label: "NLO/LO Ownership"
                }
                ]
            }
            ]
        }
    });
    map.add(occupancyLayer);

    // ISF
    const outlineColor = "gray";

    var verticalOffsetExisting = {
      screenLength: 80,
        maxWorldLength: 500,
        minWorldLength: 30
    };

    function getUniqueValueSymbol(name, size) {
      return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: size,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        /*
        verticalOffset: verticalOffsetExisting,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
        */
      };
    }

    const symbolSize = 30;
    let isfRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.StatusRC == 1, 'relocated', \
                        $feature.StatusRC == 2, 'paid', $feature.StatusRC == 3, 'payp', \
                        $feature.StatusRC == 4, 'legalpass', $feature.StatusRC == 5, 'otc', \
                        $feature.StatusRC == 6, 'lbp', $feature.StatusRC)",
        uniqueValueInfos: [
            {
              value: "relocated",
              label: "Relocated",
              symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Relocated.svg", symbolSize),
            },
            {
              value: "paid",
              label: "Paid",
              symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Paid.svg", symbolSize),
            },
            {
                value: "payp",
                label: "For Payment Processing",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_PaymentProcess.svg", symbolSize),
            },
            {
                value: "legalpass",
                label: "For Legal Pass",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LegalPass.svg", symbolSize),
            },
            {
                value: "otc",
                label: "For Appraisal/OtC/Reqs for Other Entitlements",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_OtC.svg", symbolSize),
            },
            {
                value: "lbp",
                label: "LBP Account Opening",
                symbol: getUniqueValueSymbol("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LBP.svg", symbolSize),
            }
        ]
    };

    var nloLayer = new FeatureLayer({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 4,
      renderer: isfRenderer,
      outFields: ["*"],
      title: "NLO (Non-Land Owner)",
      elevationInfo: {
        mode: "relative-to-scene"
      },
      minScale: 10000,
      maxScale: 0,
      popupTemplate: {
        title: "<p>{StrucID}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "StrucOwner",
                label: "Structure Owner"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              },
              {
                fieldName: "StatusRC",
                label: "<p>Status for Relocation</p>"
              },
              {
                fieldName: "Name",
              },
              {
                fieldName: "Status",
                label: "NLO/LO Ownership (structure) "
              }
            ]
          }
        ]
      }
    });
    //nloLayer.listMode = "hide";
    map.add(nloLayer);

    // Chainage
    var labelChainage = new LabelClass({
        labelExpressionInfo: {expression: "$feature.KmSpot"},
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 15,
                    weight: "bold"
                }
            }
    });

    var chainageRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    };

    var chainageLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "Chainage",
        elevationInfo: {
            mode: "relative-to-ground"
        },
        labelingInfo: [labelChainage],
        minScale: 150000,
        maxScale: 0,
        renderer: chainageRenderer,
        outFields: ["*"],
        popupEnabled: false
    });
    map.add(chainageLayer);

    // Pier Head and Column

    // Polygon 3D extrution
    const pHeight = 0;

    const pierColumn = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [78, 78, 78, 0.5]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 0.3
          }
        }
      ]
    };

    const pierHead = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [169, 169, 169, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    };

    const pileCap = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 3,
          material: {
            color: [200, 200, 200, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    }

    const pierHeadRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: "#E1E1E1"
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: 1.0
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "Layer",
      legendOptions: {
        title: "Pier Head/Pier Column/Pile Cap"
      },
      uniqueValueInfos: [
        {
          value: "Pier_Column",
          symbol: pierColumn,
          label: "Column"
        },
        /*
        {
          value: "Pier_Head",
          symbol: pierHead,
          label: "Pier Head"
        },
        */
        {
          value: "Pile_Cap",
          symbol: pileCap,
          label: "Pile Cap"
        },
      ]
    }

    /*
    var pilecapPierLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        title: "Pier Head/Column",
        definitionExpression: "Layer <> 'Pier_Head'",
        outFields: ["*"],
        minScale: 150000,
        maxScale: 0,
        renderer: pierHeadRenderer,
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    //pilecapPierLayer.listMode = "hide";
    map.add(pilecapPierLayer, 1);
*/
    // Pier No (point)
    // Renderer
    // 0. Define colors for unique values
    const pierAccessDateColor = {
      0: [0, 255, 0, 0.9],// Accessible (green)
      1: [255, 127, 80],// Orange
      2: [255, 255, 0],// Yellow
      3: [0, 112, 255], // Blue
      4: [143, 0, 255], // violet
      5: [255, 255, 255, 0.9],
      6: [255, 0, 0, 0.9] // Dates are missing
    }

    var defaultPointSymbol = {
        type: "simple",
        label: "Accessible",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: pierAccessDateColor[0],
            outline: {
                width: 0,
                color: "black"
            }
        }
    }

      // labels
      // for multiple label class to a layer:
      // https://developers.arcgis.com/javascript/latest/sample-code/labels-multiple-classes/
      
      const cutOffDateAccess = 1636070400000;
      // make sure to update numerical date values in 'pierAccessRenderer'
  
      const pierAccessReadyDateLabel = new LabelClass({
        symbol: {
          type: "label-3d", // autocast as new LabelSymbol3D()
          symbolLayers: [
            {
              type: "text",
              material: {
                color: pierAccessDateColor[0]
              },
              size: 15,
              color: pierAccessDateColor[0],
              haloColor: pierAccessDateColor[0],
              haloSize: 1,
              font: {
                family: "Ubuntu Mono",
                weight: "bold"
              },
            }
          ],
          verticalOffset: {
            screenLength: 80,
            maxWorldLength: 500,
            minWorldLength: 30
          },
          callout: {
            type: "line",
            size: 0.5,
            color: [0, 0, 0],
            border: {
              color: [255, 255, 255, 0.7]
            }
          }
        },
        labelExpressionInfo: {
          expression: "$feature.PIER"
          //'DefaultValue($feature.GeoTechName, "no data")'
          //"IIF($feature.Score >= 13, '', '')"
          //value: "{Type}"
        },
        labelPlacement: "above-center",
        where: "AccessDate <= '" + cutOffDateAccess + "'"
    });

    const pierAccessNotYetLabel =  new LabelClass({
      symbol: {
        type: "label-3d", // autocast as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text",
            material: {
              color: "#cccccc"
            },
            size: 10,
            color: "#cccccc",
            haloColor: "#cccccc",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "normal"
            },
          }
        ],
        verticalOffset: {
          screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7]
          }
        }
      },
      labelExpressionInfo: {
        expression: "$feature.PIER"
        //'DefaultValue($feature.GeoTechName, "no data")'
        //"IIF($feature.Score >= 13, '', '')"
        //value: "{Type}"
      },
      labelPlacement: "above-center",
      where: "AccessDate > '" + cutOffDateAccess + "'" + " OR " + "AccessDate IS NULL"
    });

    const pierAccessDateMissingLabel =  new LabelClass({
      symbol: {
        type: "label-3d", // autocast as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text",
            material: {
              color: "#ff0000"
            },
            size: 10,
            color: "#cccccc",
            haloColor: "#cccccc",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "normal"
            },
          }
        ],
        verticalOffset: {
          screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7]
          }
        }
      },
      labelExpressionInfo: {
        expression: "$feature.PIER"
        //'DefaultValue($feature.GeoTechName, "no data")'
        //"IIF($feature.Score >= 13, '', '')"
        //value: "{Type}"
      },
      labelPlacement: "above-center",
      where: "AccessDate IS NULL"
    });

    // 1. Get unique dates
    const numberDate = new Date(cutOffDateAccess);
    const cutDate = numberDate.toLocaleDateString('en-US');

    var pierAccessLayer = new FeatureLayer ({
      portalItem: {
        id: "590680d19f2e48fdbd8bcddce3aaedb5",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 6,
      labelingInfo: [pierAccessDateMissingLabel, pierAccessReadyDateLabel, pierAccessNotYetLabel],
      title: "Pier with Access Date",
      minScale: 150000,
      maxScale: 0,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      }
    },{utcOffset: 300});
    map.add(pierAccessLayer, 3);

    // we first need to obtain unique values of date because valueExpression does not allow
    // date'2021-10-01' notation
    const queryDate = "AccessDate IS NOT NULL";

    function DateValues() {
        const dates = [];
        var query = pierAccessLayer.createQuery();

        query.where = queryDate;
        return pierAccessLayer.queryFeatures(query).then(function(response) {
            var stats = response.features;
            stats.forEach((result, index) => {
                const attributes = result.attributes;
                const date = attributes.AccessDate;
                dates.push(date);
            });
            return dates;
        });
    }

    function uniqueDateValues(values) {
        var uniqueValues = [];
        values.forEach((item, index) => {
            if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
                uniqueValues.push(item);
            }
        });
        const sortedDates = uniqueValues.sort();
        return sortedDates;
    }

    function uniqueValuesInfos(sortedDates) {
      const dates = sortedDates.map((date, index) => {
            const temp = new Date(date);
            const labelDate = temp.toLocaleDateString('en-US');
            return Object.assign({}, {
                value: date, // make sure to use 'number'. you cannot add 'date'
                label: labelDate,
            });
        });
        console.log(dates);
    }
    DateValues().then(uniqueDateValues).then(uniqueValuesInfos);

    const pierAccessRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      field: "AccessDate",
      defaultSymbol: defaultPointSymbol,
      
      valueExpression: "When(IsEmpty($feature.AccessDate), 'empty', \
                            $feature.AccessDate <= 1636070400000, 'accessible', \
                            $feature.AccessDate > 1636070400000, 'others',$feature.AccessDate)", 
      uniqueValueInfos: [
        {
          value: "empty",
          label: "Dates are missing",
          type: "simple",
          symbol: {
              type: "simple-marker",
              size: 5,
              color: pierAccessDateColor[6],
              outline: {
                  width: 0.1,
                  color: "white"
              }
          }
        },
        {
          value: "accessible",
          label: "Accessible",
          type: "simple",
          symbol: {
              type: "simple-marker",
              size: 5,
              color: pierAccessDateColor[0],
              outline: {
                  width: 0.1,
                  color: "white"
              }
          }
        },
        {
          value: "others",
          label: "Others",
          type: "simple",
          symbol: {
              type: "simple-marker",
              size: 5,
              color: pierAccessDateColor[5],
              outline: {
                  width: 0.1,
                  color: "white"
              }
          }
        },
      ]
    }
    pierAccessLayer.renderer = pierAccessRenderer;

    // Popup Template

    /// Define popup template on dates for pier no
    // Date Format function
    function dateFormat(inputDate, format) {
        //parse the input date
        const date = new Date(inputDate);

        //extract the parts of the date
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();    

        //replace the month
        format = format.replace("MM", month.toString().padStart(2,"0"));        

        //replace the year
        if (format.indexOf("yyyy") > -1) {
            format = format.replace("yyyy", year.toString());
        } else if (format.indexOf("yy") > -1) {
            format = format.replace("yy", year.toString().substr(2,2));
        }

        //replace the day
        format = format.replace("dd", day.toString().padStart(2,"0"));

        return format;
    }

    // Custom Popup Content for pierAccessLayer
    let customContent = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked pierAccessLayer
            const stats = event.graphic.attributes.AccessDate;
            const pierNo = event.graphic.attributes.PIER;

            // Convert numeric to date format
            var date = new Date(stats);
            dateValue = dateFormat(date, 'MM-dd-yyyy');

            const ddd = new Date(cutOffDateAccess);
            dddValue = dateFormat(ddd, 'MM-dd-yyyy')

            //console.log(dateValue + "; " + dddValue);
            
            // If the date is before current date, popupContent should be "AVAILABLE"
            if (dateValue === '01-01-1970') { // Empty date is entered as this
              DATES = "NO DATES AVAILABLE"
            } else if (date <= cutOffDateAccess) {
              DATES = "ACCESSIBLE";
            } else if (date > cutOffDateAccess) {
              DATES = dateValue;
            }

            //return `Access Date: <b>${DATES}</b>`;
            return `Access Date: <b>${DATES}</b>`;

        }
    });

    const template = new PopupTemplate({
        outFields: ["*"],
        title: "Pier No: <b>{PIER}</b>",
        lastEditInfoEnabled: false,
        content: [customContent]
    });
    pierAccessLayer.popupTemplate = template;

    // Station Box
    let stationBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
            {
                value: "00_Platform",
                label: "Platform",
                    symbol: {
                    type: "simple-fill",
                    color: [160, 160, 160],
                    style: "backward-diagonal",
                    outline: {
                        width: 1,
                        color: "black"
                    }
                }
            },
            {
                value: "00_Platform 10car",
                label: "Platform 10car",
                symbol: {
                    type: "simple-fill",
                    color: [104, 104, 104],
                    style: "cross",
                    outline: {
                        width: 1,
                        color: "black",
                        style: "short-dash"
                    }
                }
            },
            {
            value: "00_Station",
            label: "Station Box",
            symbol: {
                type: "simple-fill",
                color: [0, 0, 0, 0],
                outline: {
                    width: 2,
                    color: [115, 0, 0]
                }
            }
            }
        ]
    };

    var stationBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        renderer: stationBoxRenderer,
        minScale: 150000,
        maxScale: 0,
        title: "Station Box",
        outFields: ["*"],
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    //stationBoxLayer.listMode = "hide";
    map.add(stationBoxLayer, 2);

    // ROW //
    var prowLayer = new FeatureLayer ({
        portalItem: {
            id: "590680d19f2e48fdbd8bcddce3aaedb5",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "PROW",
        popupEnabled: false
    });
    map.add(prowLayer,2);

    // Free and Clear Lot
    var fncLayer = new FeatureLayer ({
      portalItem: {
        id: "dca1d785da0f458b8f87638a76918496",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 2,
      title: "Free-and-Clear Area",
      //popupEnabled: false
    });
    map.add(fncLayer,1);

    // PNR
    let pnrRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.LandOwner == 'BASES CONVERSION DEVELOPMENT AUTHORITY', 'BCDA', \
                        $feature.LandOwner == 'MANILA RAILROAD COMPANY' || $feature.LandOwner == 'Manila Railroad Company','PNR',$feature.LandOwner)",
        uniqueValueInfos: [
            {
                value: "BCDA",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            },
            {
                value: "PNR",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            }
        ]
    };

    var pnrLayer = new FeatureLayer({
      portalItem: {
          id: "dca1d785da0f458b8f87638a76918496",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
      },
      layerId: 10,
      title: "Land (PNR)",
      definitionExpression: "LandOwner IN ('BASES CONVERSION DEVELOPMENT AUTHORITY','MANILA RAILROAD COMPANY')",
      outFields: ["*"],
      title: "PNR",
      elevationInfo: {
          model: "on-the-ground"
        },
      labelsVisible: false,
      renderer: pnrRenderer,
      popupTemplate: {
        title: "<p>{LandOwner} ({LotID})</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "HandOverDate",
                label: "Hand-Over Date"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              },
              {
                fieldName: "LandOwner",
                label: "Land Owner"
              }
            ]
          }
        ] 
      }
    });
    map.add(pnrLayer, 1);

  // Station point feature
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "#d4ff33"
          },
          size: 15,
          color: "black",
          haloColor: "black",
          haloSize: 0.5,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 100,
        maxWorldLength: 300,
        minWorldLength: 80
      },

      callout: {
        type: "line", // autocasts as new LineCallout3D()
        color: [128,128,128,0.5],
        size: 0.2,
        border: {
          color: "grey"
        }
      }
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
              //value: "{TEXTSTRING}"
    }
  });

  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  // Station Layer

  var stationLayer = new SceneLayer({
    portalItem: {
      id: "207cb34b8a324b40985b5805862c4b29",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    title: "N2 Stations",
    labelingInfo: [labelClass],
    //renderer: stationsRenderer,
    elevationInfo: {
      mode: "relative-to-ground"
    },
    definitionExpression: "Extension = 'N2'"
                //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);


    // Tree Cutting
    function colorsCut(){
        return {
            1: [113, 171, 72, 0.8],
            2: [0, 115, 255, 0.8],
            3: [255, 255, 0, 0.8],
            4: [255, 170, 0, 0.8],
            5: [255, 0, 0, 0.8]
        }
    }

    let treeCuttingRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.Status == 1, 'cutearthb', \
                        $feature.Status == 2, 'permit', $feature.Status == 3, 'submit', \
                        $feature.Status == 4, 'ongoing', $feature.Status)",
        uniqueValueInfos: [
            {
                value: "cutearthb",
                label: "Cut/Earthballed",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCut()[1], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "permit",
                label: "Permit Acquired",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCut()[3], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "submit",
                label: "Submitted to DENR",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 4,
                    color: colorsCut()[4], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "ongoing",
                label: "Ongoing Acquisition of Application Documents",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCut()[5], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            }
        ]
    };

    var treeCuttingLayer = new FeatureLayer ({
        portalItem: {
            id: "4da5697d684f4babad15aedfe74c5b36",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        outFields: ["*"],
        title: "Status of Tree Cutting",
        renderer: treeCuttingRenderer,
        popupTemplate: {
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "ScientificName",
                            label: "Scientific Name"
                        },
                        {
                            fieldName: "CommonName",
                            label: "Common Name"
                        },
                        {
                            fieldName: "Province"
                        },
                        {
                            fieldName: "Municipality"
                        },
                        {
                            fieldName: "TreeNo",
                            label: "Tree No."
                        },
                        {
                            fieldName: "CP",
                            label: "<h5>CP</h5>"
                        },
                        {
                            fieldName: "Compensation",
                            label: "Status of Tree Compensation"
                        },
                        {
                            fieldName: "Conservation",
                            label: "Conservation Status"
                        },
                    ]
                }
            ]
        }
    });
    map.add(treeCuttingLayer,2);

    // Tree Compensation
    function colorsCompen(){
        return {
            1: [0, 112, 255, 0.8],
            2: [255, 255, 0, 0.8],
            3: [113, 171, 72, 0.8]
        }
    }


    let treeCompensationRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.Compensation == 1, 'nonCompensable', $feature.Compensation == 2, 'payp', \
                        $feature.Compensation == 3, 'compensated', $feature.Compensation)",
        uniqueValueInfos: [ //[1:Non-Compensable, 2:For Processing, 3:Compensated]
            {
                value: "nonCompensable",
                label: "Non-Compensable",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCompen()[1], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "payp",
                label: "For Processing",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCompen()[2], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            },
            {
                value: "compensated",
                label: "Compensated",
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    size: 5,
                    color: colorsCompen()[3], // the first two letters dictate transparency.
                    outline: {
                        width: 0.5,
                        color: outlineColor
                    }
                }
            }
        ]
    };

    var treeCompensationLayer = new FeatureLayer ({
        portalItem: {
            id: "4da5697d684f4babad15aedfe74c5b36",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        outFields: ["*"],
        title: "Status of Tree Compensation",
        renderer: treeCompensationRenderer,
        popupTemplate: {
            title: "<h5>{Compensation}</h5>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "ScientificName",
                            label: "Scientific Name"
                        },
                        {
                            fieldName: "CommonName",
                            label: "Common Name"
                        },
                        {
                            fieldName: "Province"
                        },
                        {
                            fieldName: "Municipality"
                        },
                        {
                            fieldName: "TreeNo",
                            label: "Tree No."
                        },
                        {
                            fieldName: "CP",
                            label: "<h5>CP</h5>"
                        },
                        {
                            fieldName: "Status",
                            label: "Status of Tree Cutting"
                        },
                        {
                            fieldName: "Conservation",
                            label: "Conservation Status"
                        },
                    ]
                }
            ]
        }
    });
    map.add(treeCompensationLayer,1);



    // UTILITY RELOCATIOIN
    // 1. Utility Point
    var labelUtilPtSymbol = {
      type: "label-3d", // autocasts as new LabelSymbol3D()
      labelPlacement: "above-center",
      labelExpressionInfo: {
        //value: "{Company}",
        expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')" //$feature.Comp_Agency
      },
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "black"
          },
          halo: {
            color: [255, 255, 255, 0.7],
            size: 2
          },
          size: 10
        }
      ],
    };

    // Esri Icon Symbol
    function IconSymbol(name) {
      return {
        type: "web-style", // autocasts as new WebStyleSymbol()
        name: name,
        styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
      };
    }

    // Utility Point Symbol
    /// https://developers.arcgis.com/javascript/latest/guide/esri-web-style-symbols-3d/
    function utilPtSymbolInfra(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriInfrastructureStyle"
      };
    }

    function utilPtSymbolStreet(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriRealisticStreetSceneStyle"
      };
    }

    function utilPtSymbolIcons(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriIconsStyle"
      };
    }

    /* custom 3D Web Style for Utility Pole */
    // Choice: 3D_Electric_Pole, 3D_Drain_Box, 3D_Water_Valve, 3D_Telecom_BTS, 3D_TelecomCATV_Pole
    function customSymbol3D(name) {
      return {
        type: "web-style",
        portal: "https://www.maps.arcgis.com",

        // IMPORTANT: Your browser needs to be able to open the following link. It will say insecure so need to go to advanced.
        styleUrl: "https://www.maps.arcgis.com/sharing/rest/content/items/c04d4d4145f64f8fa38407dd5331dd1f/data",
        name: name
      };
    }

    /* Company and Utilty Relocation Status Symbols with Callout */
    var verticalOffsetExisting = {
      screenLength: 10,
      maxWorldLength: 10,
      minWorldLength: 15
    };

    var verticalOffsetRelocation = {
      screenLength: 10,
      maxWorldLength: 30,
      minWorldLength: 35
    };


    // Function that automatically creates the symbol for the points of interest
    function getUniqueValueSymbol(name, color, sizeS, util) {
      // The point symbol is visualized with an icon symbol. To clearly see the location of the point
      // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
      // of the point feature.
      if (util == "Existing") {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetExisting,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
      };
      } else {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetRelocation,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1],
          size: 0.2,
          border: {
            color: "grey"
          }
        }
      };
      }
    }

    var utilTypePtRenderer = {
      type: "unique-value", //"unique-value", "simple"
      //Field: "UtilType2",
      //defaultSymbol: ,
      //valueExpression: "When($feature.UtilType == 1, 'Telecom', $feature.UtilType == 2, 'Water',$feature.UtilType == 3, 'Power', $feature.UtilType)",
      valueExpression: "When($feature.UtilType2 == 1, 'Telecom Pole (BTS)', \
                            $feature.UtilType2 == 2, 'Telecom Pole (CATV)', \
                            $feature.UtilType2 == 3, 'Water Meter', \
                            $feature.UtilType2 == 4, 'Water Valve', \
                            $feature.UtilType2 == 5, 'Manhole', \
                            $feature.UtilType2 == 6, 'Drain Box', \
                            $feature.UtilType2 == 7, 'Electric Pole', \
                            $feature.UtilType2 == 8, 'Street Light', \
                            $feature.UtilType2 == 9, 'Junction Box', \
                            $feature.UtilType2 == 10, 'Coupling', \
                            $feature.UtilType2 == 11, 'Fitting', \
                            $feature.UtilType2 == 12, 'Transformer', \
                            $feature.UtilType2 == 13, 'Truss Guy', \
                            $feature.UtilType2 == 14, 'Concrete Pedestal', \
                            $feature.UtilType2 == 15, 'Ground', \
                            $feature.UtilType2 == 16, 'Down Guy', \
                            $feature.UtilType2 == 17, 'Entry/Exit Pit', \
                            $feature.UtilType2 == 18, 'Handhole', \
                            $feature.UtilType2 == 19, 'Transmission Tower', \
                            $feature.UtilType)",
      uniqueValueInfos: [
        {
          value: "Telecom Pole (BTS)",
          symbol: customSymbol3D("3D_Telecom_BTS")
        },
        {
          value: "Telecom Pole (CATV)",
          symbol: customSymbol3D("3D_TelecomCATV_Pole")
        },
        {
          value: "Manhole",
          symbol: utilPtSymbolStreet("Storm_Drain")
        },
        {
          value: "Electric Pole",
          //symbol: utilPtSymbolInfra("Powerline_Pole")
          symbol: customSymbol3D("3D_Electric_Pole")
        },
        {
          value: "Street Light",
          symbol: utilPtSymbolStreet("Overhanging_Street_and_Sidewalk_-_Light_on")
        },
        {
          value: "Junction Box",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Coupling",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Fitting",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Transformer",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Truss Guy",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Concrete Pedestal",
          symbol: customSymbol3D("Concrete Pedestal")
        },
        {
          value: "Ground",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Down Guy",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Entry/Exit Pit",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Handhole",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Transmission Tower",
          symbol: utilPtSymbolInfra("Powerline_Pole")
        }
      ],
      visualVariables: [
        {
          type: "size",
          axis: "height",
          field: "SIZE",
          valueUnit: "meters"
        },
        {
          type: "rotation",
          field: "ROTATION"
        },
        /*
        {
          type: "opacity",
          valueExpression: "($feature.Status * $feature.LAYER) / 2",
          // when utility is demolished, it becomes transparent
          //valueExpression: "When($feature.Status == 1 && $feature.LAYER == 1, 0, 1)",
          //field: "SIZE",
          stops: [
            {value: 0, opacity: 0.005}, //  want to delete
            {value: 1, opacity: 1}, // want to visualize
          ],
          legendOptions: {
            showLegend: false
          }
        }
  */
      ]
    };

    var utilReloSymbolRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      valueExpression: "When($feature.Remarks == 'pending', 'NoAction', \
                            $feature.Status == 1 && $feature.LAYER == 1, 'DemolishComplete',\
                            $feature.Status == 0 && $feature.LAYER == 1, 'DemolishIncomplete',\
                            $feature.Status == 0 && $feature.LAYER == 2, 'RelocIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 2, 'RelocComplete', \
                            $feature.Status == 0 && $feature.LAYER == 3, 'NewlyAdded', \
                            $feature.Status == 1 && $feature.LAYER == 3, 'NewlyAddedComplete',$feature.Comp_Agency)", 
      //field: "Company",
      uniqueValueInfos: [
        {
          value: "DemolishIncomplete",
          label: "To be Demolished",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Demolished.png",
            "#D13470",
            20,
            "Relocation"
          )
        },
        {
          value: "DemolishComplete",
          label: "Demolision Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png",
            "#D13470",
            25,
            "Relocation"
            )
        },
        {
          value: "RelocIncomplete",
          label: "Proposed Relocation",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Relocatd.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "RelocComplete",
          label: "Relocation Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Utility_Relocated_Completed_Symbol.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "NewlyAdded",
          label: "Add New Utility",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "NewlyAddedComplete",
          label: "Newly Utility Added",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded_Completed.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "NoAction",
          label: "Require Data Checking",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
            "#D13470",
            35,
            "Relocation"
            )
        }
      ]
    };

    var utilityPointLayer = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 1,
      title: "Relocation Plan (Point)",
      outFields: ["*"],
      renderer: utilTypePtRenderer,
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.Height"
        },
      unit: "meters"
      //offset: 0
      },
      popupTemplate: {
        title: "<h5>{Comp_Agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated",
            title: "Go to Relocated"
          }
          ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(utilityPointLayer, 3);

    /* Symbols with callout */
    // To locate a symbol with callout on the ground, 
    // If basemap elevation layer is on, use "relative-to-scene"
    // If basemap elevatio layer is off, use "absolute-height"

    var utilityPointLayer1 = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 1,
      title: "Utility 3D Render Test",
      outFields: ["*"],
      renderer: utilReloSymbolRenderer,
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.Height"
        },
        unit: "meters"
      //offset: 0
      },
      labelingInfo: [labelUtilPtSymbol],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    utilityPointLayer1.listMode = "hide";
    map.add(utilityPointLayer1);



    // 2. Utilit Line
    var utilityLineLayerLabelClass = {
      type: "label-3d", // autocasts as new LabelSymbol3D()
      labelPlacement: "above-center", // Polyline has not choice
      labelExpressionInfo: {
        expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')"
      },
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "black"
          },
          halo: {
            color: [255, 255, 255, 0.7],
            size: 2
          },
          size: 10
        }
      ],
    };

    const options = { // Circle
      profile: "circle",
      cap: "none",
      join: "miter",
      width: 0.5,
      height: 0.5,
      //color: [200, 200, 200],
      profileRotation: "all"
    };

    const options1 = { // rectangular
      profile: "quad",
      cap: "none",
      join: "miter",
      width: 0.5,
      height: 0.5,
      color: [200, 200, 200],
      profileRotation: "heading"
    };

    /* The colors used for the each transit line */

    const colorsRelocation = {
      1: [32,178,170, 0.5], //Telecom Line
      2: [112,128,144, 0.5], // Internet Cable Line
      3: [0, 128, 255, 0.5], // Water Distribution Pipe
      4: [224, 224, 224, 0.5], // Sewage
      5: [105,105,105, 0.5], // Drainage
      6: [205,133,63, 0.5], // Canal
      7: [139,69,19, 0.5], // Creek
      8: [211,211,211, 0.5] // Elecric Line
    };

    const colorsExisting = {
      1: [229, 229, 229, 0.1], //Telecom/CA (Utility TYpe)
      2: [229, 229, 229, 0.1], // Water
      3: [229, 229, 229, 0.1], // Power
    };

    var utilityLineLayer = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 2,
      title: "Relocation Plan (Line)",
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.height"
        },
        unit: "meters"
        //offset: 0
      },
      outFields: ["*"],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated-line",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(utilityLineLayer, 4);

    /* Utility Line rendnerer*/
    function lineSizeShapeSymbolLayers(profile, cap, join, width, height, profileRotation, property){
      return {
        type: "line-3d",
        symbolLayers: [
          {
            type: "path",
              profile: profile,
              material: {
                color: colorsRelocation[property]
              },
              width: width,
              height: height,
              join: join,
              cap: cap,
              anchor: "bottom",
              profileRotation: profileRotation
          }
        ]
      }
    }

    function renderutilityLineLayer() {
      const renderer = new UniqueValueRenderer({
        field: "utiltype2"
      });

      for (let property in colorsRelocation) { // For each utility type 2
        if (property == 1) { // If utility type2 === Telecom Line
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.5,0.5,"all", property)
          });

        } else if (property == 2) { // "Internet Cable Line"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.4,0.4,"all", property)
          });

        } else if (property == 3) { // "Water Distributin Pipe"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1, "all", property)
          });

        } else if (property == 4) { // "Sewerage"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });

        } else if (property == 5) { // "Drainage"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });
        
        } else if (property == 6) { // "Canal"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("quad","none","miter", 2, 2,"all", property)
          });

        } else if (property == 7) { // "Creek"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
          });

        } else if (property == 8) { // "Electric Line"
            renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.3, 0.3,"all", property)
          });

        } else {// end of 'property == '1'
          renderer.addUniqueValueInfo({
            value: property,
            symbol: lineSizeShapeSymbolLayers("quad","none","miter", 0.3, 0.3,"all", property)

          });
        }
      }
      utilityLineLayer.renderer = renderer;
    }

    renderutilityLineLayer();

    /*Line for Symbols */
    var utilityLineLayer1 = new FeatureLayer({
      portalItem: {
        id: "109d4ef09fd946d1bda17396f35deb94",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 2,
      title: "utilityLineLayer",
      elevationInfo: {
        mode: "relative-to-ground", // original was "relative-to-scene"
        featureExpressionInfo: {
          expression: "$feature.height"
        },
        unit: "meters"
        //offset: 0
      },
      outFields: ["*"],
      renderer: utilReloSymbolRenderer,
      labelingInfo: [utilityLineLayerLabelClass],
      popupTemplate: {
        title: "<h5>{comp_agency}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        actions: [
          {
            id: "find-relocated-line",
            title: "Go to Relocated"
          }
        ],
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Id"
              },
              {
                fieldName: "UtilType",
                label: "Utility Type"
              },
              {
                fieldName: "UtilType2",
                label: "Utility Name"
              },
              {
                fieldName: "LAYER",
                label: "<h5>Action</h5>"
              },
              {
                fieldName: "Status",
                label: "<h5>Status</h5>"
              },
              {
                fieldName: "CP"
              },
              {
                fieldName: "Remarks"
              }
            ]
          }
        ]
      }
    });
    utilityLineLayer1.listMode = "hide";
    map.add(utilityLineLayer1);


    // Viaduct Layer
    const colors = {
      1: [225, 225, 225, 0.1], // To be Constructed (white)
      2: [130, 130, 130, 0.5], // Under Construction
      3: [255, 0, 0, 0.8], // Delayed
      4: [0, 112, 255, 0.8], // Completed
    };

    let viaductRenderer = {
      type: "unique-value",
      defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
      valueExpression: "When($feature.Status1 == 1, 'toBeConstructed',$feature.Status1 == 4, 'Completed', $feature.Status1)",
      uniqueValueInfos: [
        {
          value: "toBeConstructed",
          label: "To be Constructed",
          symbol: {
          type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: colors[1],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
        },
        {
          value: "Completed",
          label: "Completed",
          symbol: {
          type: "mesh-3d",
            symbolLayers: [
              {
                type: "fill",
                material: {
                  color: colors[4],
                  colorMixMode: "replace"
                },
                edges: {
                  type: "solid", // autocasts as new SolidEdges3D()
                  color: [225, 225, 225, 0.3]
                }
              }
            ]
          }
        },
      ]
    }

    var viaductLayer = new SceneLayer({
      portalItem: {
        id: "a9c0878766964fa794cc67bbf38b7a09",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      // popupTemplate: viadTemplate,
      elevationInfo: {
        mode: "absolute-height" //absolute-height, relative-to-ground
      },
      title: "Viaduct",
      outFields: ["*"],
      renderer: viaductRenderer
    });
    map.add(viaductLayer);
    
  // Filter by Contract Package

  function updateSummary() {
    totalNumberOfLots();
    totalNumberOfStructures();

    pteNumberLot();
    pteNumberStructure();

    updateChartLot();
    updateChartStructure();
    updateChartNLO();

    updateMoaChartLot();
    updateMoaChartStructure();
  }

  document.getElementById("contractPackageDiv").addEventListener("click", changeProject);
    function changeProject(event) {
      const value = event.srcElement.id;

      const cpExpression = "CP = '" + value + "'";

      if (value === "All") {
        lotLayer.definitionExpression = null;
        structureLayer.definitionExpression = null;
        nloLayer.definitionExpression = null;
        occupancyLayer.definitionExpression = null;
        strucOwnershipLayer.definitionExpression = null;
        treeCuttingLayer.definitionExpression = null;
        treeCompensationLayer.definitionExpression = null;
        utilityPointLayer.definitionExpression = null;
        utilityPointLayer1.definitionExpression = null;
        utilityLineLayer.definitionExpression = null;
        utilityLineLayer1.definitionExpression = null;
        pierAccessLayer.definitionExpression = null;
        viaductLayer.definitionExpression = null;
        pnrLayer.definitionExpression = null;

        pierAccessLayer.visible = true;
        viaductLayer.visible = true;
        pnrLayer.visible = true;

        updateSummary();

        zoomToLayer(pierAccessLayer);

      } else if (value === "N-05") {
        lotLayer.definitionExpression = cpExpression;
        structureLayer.definitionExpression = cpExpression;
        nloLayer.definitionExpression = cpExpression;
        occupancyLayer.definitionExpression = cpExpression;
        strucOwnershipLayer.definitionExpression = cpExpression;
        treeCuttingLayer.definitionExpression = cpExpression;
        treeCompensationLayer.definitionExpression = cpExpression;
        utilityPointLayer.definitionExpression = cpExpression;
        utilityPointLayer1.definitionExpression = cpExpression;
        utilityLineLayer.definitionExpression = cpExpression;
        utilityLineLayer1.definitionExpression = cpExpression;
        pierAccessLayer.visible = false;
        viaductLayer.visible = false;
        pnrLayer.definitionExpression = false;

        updateSummary();

        zoomToLayer(lotLayer);

      } else {
        lotLayer.definitionExpression = cpExpression;
        structureLayer.definitionExpression = cpExpression;
        nloLayer.definitionExpression = cpExpression;
        occupancyLayer.definitionExpression = cpExpression;
        strucOwnershipLayer.definitionExpression = cpExpression;
        treeCuttingLayer.definitionExpression = cpExpression;
        treeCompensationLayer.definitionExpression = cpExpression;
        utilityPointLayer.definitionExpression = cpExpression;
        utilityPointLayer1.definitionExpression = cpExpression;
        utilityLineLayer.definitionExpression = cpExpression;
        utilityLineLayer1.definitionExpression = cpExpression;
        pierAccessLayer.definitionExpression = cpExpression;
        viaductLayer.definitionExpression = cpExpression;
        pnrLayer.definitionExpression = cpExpression;

        pierAccessLayer.visible = true;
        viaductLayer.visible = true;
        pnrLayer.visible = true;

        updateSummary();

        zoomToLayer(pierAccessLayer);
      }
    }



    // Contents including chart
    // Total Number
    // Thousand separators function
    function thousands_separators(num) {
      var num_parts = num.toString().split(".");
      num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return num_parts.join(".");
    }

    const lotNumberDiv = document.getElementById("lotNumberDiv");
    const pteLotNumberDiv = document.getElementById("pteLotNumberDiv");
    const structureNumberDiv = document.getElementById("structureNumberDiv");
    const pteStructureNumberDiv = document.getElementById("pteStructureNumberDiv");
    const nloNumberDiv = document.getElementById("nloNumberDiv");


    // 1. Total Number of Lots
    function totalNumberOfLots(){
      var totalLot = {
        onStatisticField: "CASE WHEN StatusLA >= 0 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalLot",
        statisticType: "sum"
      };
      var query = lotLayer.createQuery();
      query.outStatistics = [totalLot];
      query.returnGeometry = true;

      lotLayer.queryFeatures(query).then(function(response){
        var stats = response.features[0].attributes;
        const LOT_TOTAL = thousands_separators(stats.totalLot);

        lotNumberDiv.innerHTML = `TOTAL LOTS<br><br><b>${LOT_TOTAL}</b>`;
      });
    }

    totalNumberOfLots();

    // Total number of handed-over lots
    function pteNumberLot(){
        var total_pte_lot = {
            onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_pte_lot",
            statisticType: "sum"
        };

        var total_lot_N = {
            onStatisticField: "CASE WHEN StatusLA >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lot_N",
            statisticType: "sum"
        };
        var query = lotLayer.createQuery();
        query.outStatistics = [total_pte_lot, total_lot_N];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const pte = stats.total_pte_lot;
            const totalN = stats.total_lot_N;
            const percPTE = ((pte/totalN)*100).toFixed(0);

            const value = percPTE == "Infinity" ? "N/A" : percPTE + "% (" + pte + ")";
            pteLotNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
        });
    }
    pteNumberLot();

    // Total number of structures
    function totalNumberOfStructures(){
      var totalStructure = {
        onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalStructure",
        statisticType: "count"
      };
      var query = structureLayer.createQuery();
      query.outStatistics = [totalStructure];
      query.returnGeometry = true;

      structureLayer.queryFeatures(query).then(function(response){
        var stats = response.features[0].attributes;

        const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
        structureNumberDiv.innerHTML = `TOTAL STRUCTURES<br><br><b>${STRUCTURE_TOTAL}</b>`;
      });
    }
    totalNumberOfStructures();

    // Total number of PTE for structure
    function pteNumberStructure() {
        var total_pte_structure = {
            onStatisticField: "CASE WHEN PTE = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_pte_structure",
            statisticType: "sum"
        };

        var total_struc_N = {
            onStatisticField: "CASE WHEN StatusStruc >=1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_struc_N",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_pte_structure,total_struc_N];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const pte = stats.total_pte_structure;
            const totalN = stats.total_struc_N;
            const percPTE = ((pte/totalN)*100).toFixed(0);

            const value = percPTE + "% (" + pte + ")";
            pteStructureNumberDiv.innerHTML = `PERMIT-TO-ENTER<br><br><b>${value}</b>`;
        });
    }
    pteNumberStructure();

     
    // CHART PANEL FOR LOT
    const LEGEND_FONT_SIZE = "0.9em";
    var root = am5.Root.new("landPieChartDiv");

    const statusLot = ["Handed-Over", "Paid", "For Payment Processing",
                       "For Legal Pass", "For Appraisal/Offer to Buy",
                       "For Expro"];

    function updateChartLot(municipal, barangay) {
        root.container.children.clear();
        // First, define statuses
        var total_handedover_lot = {
            onStatisticField: "CASE WHEN StatusLA = 0 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_handedover_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusLA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusLA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusLA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otb_lot = {
            onStatisticField: "CASE WHEN StatusLA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otb_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN StatusLA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_handedover_lot, total_paid_lot, total_payp_lot,
                                total_legalpass_lot, total_otb_lot, total_expro_lot];
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const handedover = stats.total_handedover_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otb = stats.total_otb_lot;
            const expro = stats.total_expro_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusLot[0]) {
            selectedStatus = 0;
          } else if (SELECTED == statusLot[1]) {
            selectedStatus = 1;
          } else if (SELECTED == statusLot[2]) {
            selectedStatus = 2;
          } else if (SELECTED == statusLot[3]) {
            selectedStatus = 3;
          } else if (SELECTED == statusLot[4]) {
            selectedStatus = 4;
          } else if (SELECTED == statusLot[5]) {
            selectedStatus = 5;
          } else {
            selectedStatus = null;
          }

          var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusLA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = "1=1";

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 
          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              //chartLayerView = layerView;

              lotLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusLA = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusLot[0],
              value: handedover,
              sliceSettings: {
                fill: am5.color("#00c5ff")
              }
            },
            {
              category: statusLot[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70ad47")
              }
            },
            {
              category: statusLot[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070ff")
              }
            },
            {
              category: statusLot[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#ffff00")
              }
            },
            {
              category: statusLot[4],
              value: otb,
              sliceSettings: {
                fill: am5.color("#ffaa00")
              }
            },
            {
              category: statusLot[5],
              value: expro,
              sliceSettings: {
                fill: am5.color("#ff0000")
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
        }); // End of queryFeatures
    } // End of updateChartLot()
    updateChartLot();

    var root2 = am5.Root.new("chartMoaLotDiv");
        var myTheme = am5.Theme.new(root2);

        myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });
        const statusMOA = ["For Negotiation",
                            "Expropriation",
                            "Donation",
                            "CA 141",
                            "No Need to Acquire"
                          ];

    function updateMoaChartLot(municipal, barangay) {
        root2.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_ca141_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_ca141_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_ca141_lot, total_noneed_lot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const nego = stats.total_nego_lot;
            const expro = stats.total_expro_lot;
            const donate = stats.total_donate_lot;
            const ca141 = stats.total_ca141_lot;
            const noneed = stats.total_noneed_lot;

                              // Set themes
         // https://www.amcharts.com/docs/v5/concepts/themes/
        root2.setThemes([
          am5themes_Animated.new(root2),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root2.container.children.push(
          am5xy.XYChart.new(root2, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,

          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root2, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root2, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root2, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root2, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);

        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
          fontSize: 10
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root2, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root2, {
            locationY: 1,
            sprite: am5.Label.new(root2, {
              text: "{value}",
              fill: root2.interfaceColors.get("alternativeText"),
              centerY: 3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
           if (SELECTED == statusMOA[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusMOA[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusMOA[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusMOA[3]) {
            selectedStatus = 4;
          }  else if (SELECTED == statusMOA[4]) {
            selectedStatus = 5;
          }

          var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 
          
          view.whenLayerView(lotLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          lotLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
          where: "MoA = " + selectedStatus
          //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerView
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root2, {
          text: "MODE OF ACQUISITION",
          fontSize: 14,
          fontWeight: "normal",
          textAlign: "left",
          fill: am5.color("#f7f5f7"),
          paddingTop: -15,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
            {
                category: statusMOA[0],
                value: nego
            },
            {
                category: statusMOA[1],
                value: expro
            },
            {
                category: statusMOA[2],
                value: donate
            },
            {
                category: statusMOA[3],
                value: ca141
            },
            {
                category: statusMOA[4],
                value: noneed
            },
        ]; // End of chart

        yAxis.data.setAll(data);
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);


        }); // End of queryFeatures
       
    } // End of updateMOAChartLot
    updateMoaChartLot();

    // CHART PANEL FOR STRUCTURE
    var root3 = am5.Root.new("structurePieChartDiv");
    class MyTheme extends am5.Theme {
          setupDefaultRules() {
            var theme = this;

            const gap = 4;
            const rotation = 135;
            const strokeWidth = 1.1;
            const fillOpacity = 0;
            const width = 10;
            const height = 10;


            this.patterns = [
              am5.LinePattern.new(this._root, {
                color: am5.color("#00C5FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#70AD47"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#0070FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FFFF00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height

              }),
              am5.LinePattern.new(this._root, {
                color: am5.color("#FFAA00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FF0000"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              })
            ];

            this.currentPattern = 0;
            this.rule("Slice").setAll({
              fillOpacity: 1
            });

            this.rule("Slice").setup = function(target) {
              target.set("fillPattern", theme.patterns[theme.currentPattern]);
              theme.currentPattern++;
              if (theme.currentPattern == theme.patterns.length) {
                theme.currentPattern = 0;
              }
            };
          }
        }

        const statusStructure = ["Dismantling/Clearing", "Paid", "For Payment Processing",
                                 "For Legal Pass", "For Appraisal/Offer to Compensate",
                                "LBP Account Opening"];

    async function updateChartStructure(municipal, barangay) {
        root3.container.children.clear();

        var total_clear_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_clear_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusStruc = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = structureLayer.createQuery();
        query.outStatistics = [total_clear_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_clear_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root3.setThemes([
          am5themes_Animated.new(root3),
          am5themes_Responsive.new(root3),
          MyTheme.new(root3)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root3.container.children.push(
          am5percent.PieChart.new(root3, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root3.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root3, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(90), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          //fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          tooltipText: "{category}: {value}",
          tooltipY: am5.percent(10),
          //fill: am5.color("#1e8553")//root3.interfaceColors.get("alternativeText"),
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusStructure[0]) {
          selectedStatus = 1;
          } else if (SELECTED == statusStructure[1]) {
          selectedStatus = 2;
          } else if (SELECTED == statusStructure[2]) {
          selectedStatus = 3;
          } else if (SELECTED == statusStructure[3]) {
          selectedStatus = 4;
          } else if (SELECTED == statusStructure[4]) {
          selectedStatus = 5;
          } else if (SELECTED == statusStructure[5]) {
          selectedStatus = 6;
          } else {
          selectedStatus = null;
          }

          var query = structureLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusStruc = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } 

          // Zoom, filter, and highlight selected chart categories 
          view.when(function() {
          view.whenLayerView(structureLayer).then(function (layerView) {

          structureLayer.queryFeatures(query).then(function(results) {
            const RESULT_LENGTH= results.features;
            const ROW_N = RESULT_LENGTH.length;

            let objID = [];
            for (var i=0; i < ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
            }
            
            var queryExt = new Query({
              objectIds: objID
            });
            
            structureLayer.queryExtent(queryExt).then(function(result) {
              if (result.extent) {
                view.goTo(result.extent)
              }
            });
            
            if (highlightSelect) {
              highlightSelect.remove();
            }
            highlightSelect = layerView.highlight(objID);
            
            view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
            });
          }); // End of queryFeatures

          layerView.filter = {
            where: "StatusStruc = " + selectedStatus
          }
          }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusStructure[0],
              value: clear,
            },
            {
              category:  statusStructure[1],
              value: paid,
            },
            {
              category:  statusStructure[2],
              value: payp,
            },
            {
              category:  statusStructure[3],
              value: legalpass,
            },
            {
              category:  statusStructure[4],
              value: otc,
            },
            {
              category:  statusStructure[5],
              value: lbp,
            }
          ]
        );

                // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root3, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root3.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff"),

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box2');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 1.1,
        });

        pieSeries.appear(1000, 100);

        });  // End of queryFeature       
    } // End of updateChartStructure()
    updateChartStructure();


    var root4 = am5.Root.new("chartMoaStructureDiv");
    var myTheme = am5.Theme.new(root4);
    myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });

    const statusMoaStructure = ["For Negotiation",
                                "Expropriation",
                                "Donation",
                                "No Need to Acquire"
                                ];

    async function updateMoaChartStructure(municipal, barangay) {
        root4.container.children.clear();

        var total_nego_lot = {
            onStatisticField: "CASE WHEN MoA = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_nego_lot",
            statisticType: "sum"
        };

        var total_expro_lot = {
            onStatisticField: "CASE WHEN MoA = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_expro_lot",
            statisticType: "sum"
        };

        var total_donate_lot = {
            onStatisticField: "CASE WHEN MoA = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_donate_lot",
            statisticType: "sum"
        };

        var total_noneed_lot = {
            onStatisticField: "CASE WHEN MoA = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_noneed_lot",
            statisticType: "sum"
        };

        var query = structureLayer.createQuery();
        query.outStatistics = [total_nego_lot, total_expro_lot, total_donate_lot, total_noneed_lot];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
          var stats = response.features[0].attributes;

          const nego = stats.total_nego_lot;
          const expro = stats.total_expro_lot;
          const donate = stats.total_donate_lot;
          const noneed = stats.total_noneed_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root4.setThemes([
          am5themes_Animated.new(root4),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root4.container.children.push(
          am5xy.XYChart.new(root4, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,
          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root4, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root4, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root4, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root4, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);


        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root4, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root4, {
            locationY: 1,
            sprite: am5.Label.new(root4, {
              text: "{value}",
              fill: root4.interfaceColors.get("alternativeText"),
              centerY: 1.3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });


        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusMoaStructure[0]) {
                selectedStatus = 1;
            } else if (SELECTED == statusMoaStructure[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusMoaStructure[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusMoaStructure[3]) {
                selectedStatus = 4;
            } else {
                selectedStatus = null;
            }

          var query = structureLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "MoA = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;
          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }
          
          view.whenLayerView(structureLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          structureLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              structureLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
            where: "MoA = " + selectedStatus
            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerVie
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root4, {
          text: "MODE OF ACQUISITION",
          fontSize: 14,
          fontWeight: "normal",
          textAlign: "left",
          fill: am5.color("#f7f5f7"),
          paddingTop: -15,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
                {
                    category: statusMoaStructure[0],
                    value: nego
                },
                {
                    category: statusMoaStructure[1],
                    value: expro
                },
                {
                    category: statusMoaStructure[2],
                    value: donate
                },
                {
                    category: statusMoaStructure[3],
                    value: noneed
                }
      ];

        yAxis.data.setAll(data);
        series.data.setAll(data);


        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);

        }); // End of queryFeatures
    } // End of updateS_MOAChartStructure
    updateMoaChartStructure();

    var root5 = am5.Root.new("nloPieChartDiv");
    const statusISF = ["Relocated", "Paid", "For Payment Processing",
                      "For Legal Pass", "For Appraisal/OtC/Requirements for Other Entitlements",
                    "LBP Account Opening"]

    async function updateChartNLO(municipal, barangay) {
        root5.container.children.clear();

        var total_relocated_lot = {
            onStatisticField: "CASE WHEN StatusRC = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_relocated_lot",
            statisticType: "sum"
        };

        var total_paid_lot = {
            onStatisticField: "CASE WHEN StatusRC = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_paid_lot",
            statisticType: "sum"
        };

        var total_payp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_payp_lot",
            statisticType: "sum"
        };

        var total_legalpass_lot = {
            onStatisticField: "CASE WHEN StatusRC = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_legalpass_lot",
            statisticType: "sum"
        };

        var total_otc_lot = {
            onStatisticField: "CASE WHEN StatusRC = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_otc_lot",
            statisticType: "sum"
        };

        var total_lbp_lot = {
            onStatisticField: "CASE WHEN StatusRC = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_lbp_lot",
            statisticType: "sum"
        };  

        var query = nloLayer.createQuery();
        query.outStatistics = [total_relocated_lot, total_paid_lot, total_payp_lot,
                        total_legalpass_lot, total_otc_lot, total_lbp_lot];
        query.returnGeometry = true;

        return nloLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const clear = stats.total_relocated_lot;
            const paid = stats.total_paid_lot;
            const payp = stats.total_payp_lot;
            const legalpass = stats.total_legalpass_lot;
            const otc = stats.total_otc_lot;
            const lbp = stats.total_lbp_lot;

            const total_nlo = thousands_separators(clear + paid + payp + legalpass + otc + lbp);
            nloNumberDiv.innerHTML = `TOTAL NLOs<br><br><b>${total_nlo}</b>`;
            
                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root5.setThemes([
          am5themes_Animated.new(root5),
          am5themes_Responsive.new(root5)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root5.container.children.push(
          am5percent.PieChart.new(root5, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root5.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root5, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // To set slice color, you need to add this before data.setAll
        /*
        pieSeries.get("colors").set("colors", [
          am5.color("#70ad47"),
          am5.color("#0070FF"),
          am5.color("#FFFF00"),
          am5.color("#FFAA00"),
          am5.color("#FF0000"),
          am5.color("#00734C"),
        ]);
        */

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);


        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          if (SELECTED == statusISF[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusISF[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusISF[2]) {
            selectedStatus = 3;
          } else if (SELECTED == statusISF[3]) {
            selectedStatus = 4;
          } else if (SELECTED == statusISF[4]) {
            selectedStatus = 5;
          } else if (SELECTED == statusISF[5]) {
            selectedStatus = 6;
          } else {
            selectedStatus = null;
          }

          var query = nloLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay ='" + barangay + "'";
          const statusExpression = "StatusRC = " + selectedStatus;

          if (municipal === undefined && barangay === undefined) {
            query.where = statusExpression;
          } else if (municipal !== 'None' && barangay === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;
          } else if (municipal === 'None' && barangay === 'None') {
            query.where = statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          } else if (municipal !== 'None' && barangay !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }

          view.when(function() {
            view.whenLayerView(nloLayer).then(function (layerView) {
              //chartLayerView = layerView;

              nloLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                nloLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusRC = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusISF[0],
              value: clear,
              sliceSettings: {
                fill: am5.color("#00C5FF")
              }
            },
            {
              category: statusISF[1],
              value: paid,
              sliceSettings: {
                fill: am5.color("#70AD47")
              }
            },
            {
              category: statusISF[2],
              value: payp,
              sliceSettings: {
                fill: am5.color("#0070FF")
              }
            },
            {
              category: statusISF[3],
              value: legalpass,
              sliceSettings: {
                fill: am5.color("#FFFF00")
              }
            },
            {
            category: statusISF[4],
              value: otc,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
              category: statusISF[5],
            value: lbp,
            sliceSettings: {
                fill: am5.color("#FF0000")
              }
            }
          ]
        );


        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root5, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root5.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box3');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);

        });  // End of queryFeature                 
    } // End of updateChartNLO()
    updateChartNLO();

    /////////////////// END Of LAYER IMPORT ////////////////////////////

    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }

    view.ui.empty("top-left");
      

    // Legend
    var legend_land = new Legend({
      view,
      container: "land-legend",
      layerInfos: [
        {
          layer: lotLayer,
          title: ""
        }
      ]
    });

    var legend_structure = new Legend({
      view,
      container: "structure-legend",
      layerInfos: [
        {
          layer: structureLayer,
          title: ""
        }
      ]
    });

    var legend_nlo = new Legend({
      view,
      container: "nlo-legend",
      layerInfos: [
        {
          layer: nloLayer,
          title: ""
        }
      ]
    });

    var legend_strucOwnership = new Legend({
      view,
      container: "strucOwnership-legend",
      layerInfos: [
        {
          layer: strucOwnershipLayer,
          title: ""
        }
      ]
    });

    var legend_occupancy = new Legend({
      view,
      container: "occupancy-legend",
      layerInfos: [
        {
          layer: occupancyLayer,
          title: ""
        }
      ]
    });

    var legend_pierAccess = new Legend({
      view,
      container: "pierAccess-legend",
      layerInfos: [
        {
          layer: pierAccessLayer,
          title: ""
        }
      ]
    });

    var legend_stationBox = new Legend({
      view,
      container: "stationBox-legend",
      layerInfos: [
        {
          layer: stationBoxLayer,
          title: ""
        }
      ]
    });

    var legend_fnc = new Legend({
      view,
      container: "fnc-legend",
      layerInfos: [
        {
          layer: fncLayer,
          title: ""
        }
      ]
    });

    var legend_pnr = new Legend({
      view,
      container: "pnr-legend",
      layerInfos: [
        {
          layer: pnrLayer,
          title: ""
        }
      ]
    });

    var legend_treeCut = new Legend({
      view,
      container: "treeCutting-legend",
      layerInfos: [
        {
          layer: treeCuttingLayer,
          title: ""
        }
      ]
    });

    var legend_treeCompen = new Legend({
      view,
      container: "treeCompensation-legend",
      layerInfos: [
        {
          layer: treeCompensationLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPoint = new Legend({
      view,
      container: "utilityPoint-legend",
      layerInfos: [
        {
          layer: utilityPointLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPointStatus = new Legend({
      view,
      container: "utilityPointStatus-legend",
      layerInfos: [
        {
          layer: utilityPointLayer1,
          title: ""
        }
      ]
    });

    var legend_utilityLine = new Legend({
      view,
      container: "utilityLine-legend",
      layerInfos: [
        {
          layer: utilityLineLayer,
          title: ""
        }
      ]
    });

    var legend_utilityLineStatus = new Legend({
      view,
      container: "utilityLineStatus-legend",
      layerInfos: [
        {
          layer: utilityLineLayer1,
          title: ""
        }
      ]
    });

    var legend_prowBox = new Legend({
      view,
      container: "prow-legend",
      layerInfos: [
        {
          layer: prowLayer,
          title: ""
        }
      ]
    });

    var legend_chainage = new Legend({
      view,
      container: "chainage-legend",
      layerInfos: [
        {
          layer: chainageLayer,
          title: ""
        }
      ]
    });

    var legend_viaduct = new Legend({
      view,
      container: "viaduct-legend",
      layerInfos: [
        {
          layer: viaductLayer,
          title: ""
        }
      ]
    });

    // Default setting
    lotLayer.visible = true;
    structureLayer.visible = false;
    nloLayer.visible = false;
    occupancyLayer.visible = false;
    strucOwnershipLayer.visible = false;
    fncLayer.visible = true;
    pnrLayer.visible = true;
    treeCuttingLayer.visible = false;
    treeCompensationLayer.visible = false;
    utilityPointLayer.visible = false;
    utilityPointLayer1.visible = false;
    utilityLineLayer.visible = false;
    utilityLineLayer1.visible = false;
    pierAccessLayer.visible = true;
    stationBoxLayer.visible = true;
    prowLayer.visible = true;
    chainageLayer.visible = false;
    viaductLayer.visible = false;

    // Hide and Unhide of Legend + layerList + lotLayer
    // 1. Checkbox
    const landCheckbox = document.getElementById("land-check");
    const structureCheckbox = document.getElementById("structure-check");
    const nloCheckbox = document.getElementById("NLO-check");
    const occupancyCheckbox = document.getElementById("occupancy-check");
    const strucOwnershipCheckbox = document.getElementById("strucOwnership-check");
    const fncCheckbox = document.getElementById("fnc-check");
    const pnrCheckbox = document.getElementById("pnr-check");
    const treeCuttingCheckbox = document.getElementById("treeCutting-check");
    const treeCompensationCheckbox = document.getElementById("treeCompensation-check");
    const utilityPointCheckbox = document.getElementById("utilityPoint-check");
    const utilityPointStatusCheckbox = document.getElementById("utilityPointStatus-check");
    const utilityLineCheckbox = document.getElementById("utilityLine-check");
    const utilityLineStatusCheckbox = document.getElementById("utilityLineStatus-check");
    const pierAccessCheckbox = document.getElementById("pierAccess-check");
    const stationBoxCheckbox = document.getElementById("stationBox-check");
    const prowCheckbox = document.getElementById("prow-check");
    const chainageCheckbox = document.getElementById("chainage-check");
    const viaductCheckbox = document.getElementById("viaduct-check");

    // 2. Legend
    const landLegend = document.getElementById("land-legend");
    const structureLegend = document.getElementById("structure-legend");
    const nloLegend = document.getElementById("nlo-legend");
    const occupancyLegend = document.getElementById("occupancy-legend");
    const strucOwnershipLegend = document.getElementById("strucOwnership-legend");
    const fncLegend = document.getElementById("fnc-legend");
    const pnrLegend = document.getElementById("pnr-legend");
    const treeCuttingLegend = document.getElementById("treeCutting-legend");
    const treeCompensationLegend = document.getElementById("treeCompensation-legend");
    const utilityPointLegend = document.getElementById("utilityPoint-legend");
    const utilityPointStatusLegend = document.getElementById("utilityPointStatus-legend");
    const utilityLineLegend = document.getElementById("utilityLine-legend");
    const utilityLineStatusLegend = document.getElementById("utilityLineStatus-legend");
    const pierAccessLegend = document.getElementById("pierAccess-legend");
    const stationBoxLegend = document.getElementById("stationBox-legend");
    const prowLegend = document.getElementById("prow-legend");
    const chainageLegend = document.getElementById("chainage-legend");
    const viaductLegend = document.getElementById("viaduct-legend");

    // Lot Layer
    view.when(() => {
      
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        landLegend.hidden = !landLegend.hidden;
        
        // Visible/Unvisible Lot Layer
        if (activeWidget) {
          lotLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          lotLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      } 
      landCheckbox.addEventListener("click", checkBoxClick);
    });

    // Structure Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        structureLegend.hidden = !structureLegend.hidden;
        
        // Visible/unvisible structure layer
        if (activeWidget) {
          structureLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          structureLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      structureCheckbox.addEventListener("click", checkBoxClick);
    });

    // NLO Layer (ISF)
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        nloLegend.hidden = !nloLegend.hidden;
        
        // Visible/unvisible nlo layer
        if (activeWidget) {
          nloLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          nloLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      nloCheckbox.addEventListener("click", checkBoxClick);
    });


    // Occupancy Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        occupancyLegend.hidden = !occupancyLegend.hidden;
        
        // Visible/unvisible occupancy layer
        if (activeWidget) {
          occupancyLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          occupancyLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      occupancyCheckbox.addEventListener("click", checkBoxClick);
    });

    // Structure Ownership (NLO/LO) Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        strucOwnershipLegend.hidden = !strucOwnershipLegend.hidden;
        
        // Visible/unvisible strucOwnership layer
        if (activeWidget) {
          strucOwnershipLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          strucOwnershipLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      strucOwnershipCheckbox.addEventListener("click", checkBoxClick);
    });

    // Free-and-Clear Land Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        fncLegend.hidden = !fncLegend.hidden;
        
        // Visible/unvisible fnc layer
        if (activeWidget) {
          fncLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          fncLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      fncCheckbox.addEventListener("click", checkBoxClick);
    });

    // PNR Land Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        pnrLegend.hidden = !pnrLegend.hidden;
        
        // Visible/unvisible pnr layer
        if (activeWidget) {
          pnrLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          pnrLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      pnrCheckbox.addEventListener("click", checkBoxClick);
    });

    // Tree Cutting layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
        
        // Visible/unvisible treeCutting layer
        if (activeWidget) {
          treeCuttingLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCuttingLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      treeCuttingCheckbox.addEventListener("click", checkBoxClick);
    });

    // Tree Compensation Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
        
        // Visible/unvisible treeCompensation layer
        if (activeWidget) {
          treeCompensationLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCompensationLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      treeCompensationCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointLegend.hidden = !utilityPointLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointStatusLegend.hidden = !utilityPointStatusLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineLegend.hidden = !utilityLineLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineStatusLegend.hidden = !utilityLineStatusLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // Pier Access point Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        pierAccessLegend.hidden = !pierAccessLegend.hidden;
        
        // Visible/unvisible pierAccess layer
        if (activeWidget) {
          pierAccessLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          pierAccessLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      pierAccessCheckbox.addEventListener("click", checkBoxClick);
    });


    // Station Box Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        stationBoxLegend.hidden = !stationBoxLegend.hidden;
        
        // Visible/unvisible stationBox layer
        if (activeWidget) {
          stationBoxLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          stationBoxLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      stationBoxCheckbox.addEventListener("click", checkBoxClick);
    });

    // PROW Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        prowLegend.hidden = !prowLegend.hidden;
        
        // Visible/unvisible prow layer
        if (activeWidget) {
          prowLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          prowLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      prowCheckbox.addEventListener("click", checkBoxClick);
    });

    // Chainage layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        chainageLegend.hidden = !chainageLegend.hidden;
        
        // Visible/unvisible chainage layer
        if (activeWidget) {
          chainageLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          chainageLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      chainageCheckbox.addEventListener("click", checkBoxClick);
    });

    // Viaduct layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        viaductLegend.hidden = !viaductLegend.hidden;
        
        // Visible/unvisible chainage layer
        if (activeWidget) {
          viaductLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          viaductLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      viaductCheckbox.addEventListener("click", checkBoxClick);
    });

      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "N2 WORK PROGRESS";
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;
      });
    });
  </script>
</html>