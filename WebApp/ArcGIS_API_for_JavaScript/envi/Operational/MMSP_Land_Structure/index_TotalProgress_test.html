<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
<title>Progress Summary (MMSP)</title>

<script type="module" src="https://js.arcgis.com/calcite-components/1.0.3/calcite.esm.js"></script>
<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.3/calcite.css" />
<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>
<link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
<script src="https://js.arcgis.com/4.25/"></script>

  </head>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <calcite-tabs>
        <div id="applicationDiv">
          <div id="headerDiv">
            <div id="headerTitleDiv">Status of Land Acquisition (MMSP)</div>
          </div>
          <calcite-tab-nav slot="tab-nav" id="thetabs">
            <calcite-tab-title class="Stations" selected>Stations</calcite-tab-title>
            <calcite-tab-title class="Subterranean">Subterranean</calcite-tab-title>
          </calcite-tab-nav>
          <calcite-tab>
            <div class="contentBox">
              <div class="container">
                <div class="landStrucIsfBox">
                  <div id="legalpChartDiv"></div>
                  <div id="appraisalChartDiv"></div>
                  <div id="exproChartDiv"></div>
                </div>
                <div class="treeBox">
                  <div id="paypChartDiv"></div>
                  <div id="handedOverChartDiv"></div>
                  <div id="wopChartDiv"></div>
                </div>
                <div class="utilityBox">
                  <div id="paidChartDiv"></div>
                  <div id="utilityLineChartDiv"></div>
                  <div id="structureChartDiv"></div>
                </div> 
            </div>
            </div>
          </calcite-tab>
          <calcite-tab>
            <div class="contentBox2">
              <div class="container2">
                <div class="landStrucIsfBox2">
                  <div id="legalpChartDiv2"></div>
                  <div id="appraisalChartDiv2"></div>
                  <div id="exproChartDiv2"></div>
                </div>
                <div class="treeBox2">
                  <div id="paypChartDiv2"></div>
                  <div id="handedOverChartDiv2"></div>
                  <div id="wopChartDiv2"></div>
                </div>
                <div class="utilityBox2">
                  <div id="paidChartDiv2"></div>
                  <div id="utilityLineChartDiv2"></div>
                  <div id="structureChartDiv2"></div>
                </div>      
            </div>
            </div>
          </calcite-tab>
          <div id="infoIcon">
            <calcite-action-bar slot="action-bar">
              <calcite-action class="inforClass" data-action-id="information" icon="information" text="Information"></calcite-action>
            </calcite-action-bar>
            <calcite-panel heading="Description" data-panel-id="information" hidden>
              <div id="info-content">
                <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
                <div id="item-description">
                  <!-- Dynamically populated -->
                </div>
              </div>
            </calcite-panel>
          </div>
            <div id="legendChartDiv"></div>
            <div id="legendChartDiv2"></div>
          <div class="dateDiv">February 6, 2023</div> 
          <div id="informationDiv"></div>
          <calcite-button
            href="https://www.arcgis.com/apps/mapviewer/index.html?marker=142.1994;11.3498;4326;Mariana Trench;https://clipart.world/wp-content/uploads/2021/07/Target-clipart-transparent-background-4.png&level=6"
            icon-end="launch"
            label="Open Process Flow Chart"
            target="_blank">
            Open Process Flow Chart
        </calcite-button>
        </div>
      </calcite-tabs>
    </calcite-shell>
  </body>
</html>

<style>
html,
body {
  padding: 0;
  margin: 0;
  /*background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.3));*/
  /*border-color: white;*/
  /*box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);*/
  /*background-color: rgb(0,0,0,0.5);*/
}

#applicationDiv {
  display: flex;
  flex-wrap: wrap;
  height: 100%;
  padding: 10px;
  margin: 0 auto;
  box-sizing: border-box;

}

#item-description {
  padding: 0.5rem;

}

#item-description b {
  color: orange;
}

calcite-button {
  position: absolute;
  z-index: 99;
  bottom: 50;
  right: 10;
}

calcite-action-bar {
  position: absolute;
  z-index: 99;
  top: 0;
  right: 0;
  margin: 1rem;
}

calcite-panel {
  position: absolute;
  z-index: 1;
  bottom: 10px;
  right: 300px;
  width: 30vw;
  height: 50%;
}

calcite-loader {
  align-self: center;
  justify-self: center;
}

calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tab-nav {
      margin: auto;
      width: 20vw;
    }


calcite-rating {
      margin-top: 0.25rem;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

#informationDiv {
  position: absolute;
  z-index: 99;
  width: 30vw;
  height: 10vh;
  color: white;
  bottom: 190;
  right: 5;
  font-size: 1rem;
}

#informationDiv b {
  font-size: 1rem;
  color: orange;
  margin: 0;
  padding: 0;
}

.contentBox,
.contentBox2 {
  display: grid;
  grid-template-columns: 80vw 17.8vw;
  width: 100%;
  height: 100%;
}

.container,
.container2 {
  display: grid;
  flex-wrap: wrap;
  height: 88vh;
  box-sizing: border-box;
  border-right: 0;
}


.containerB {
  font-size: 1.5vw;
  color: white;
  padding-top: 40%;
}


#headerDiv {
  margin-bottom: 3px;
  display: grid;
  grid-template-columns: 2fr 150px;
  margin: 0.5%;
}

#headerTitleDiv {
  color: white;
  font-weight: bold;
  font-size: 1.8vw;

}

.dateDiv {
  z-index: 99;
  position: absolute;
  padding-bottom: 10;
  font-size: 1vw;
  color: rgb(0, 197, 255);
  right:10;
  bottom: 10;
}

.landStrucIsfBox,
.treeBox,
.landStrucIsfBox2,
.treeBox2 {
  display: inline-flex;
  height: 29vh;
  width: 100%;
  box-sizing: border-box;
  border-top: 0;
  border-bottom: 0;
  margin: 0;
  padding: 0;
  border-bottom: 0.7px solid rgb(185, 171, 171);
}

.utilityBox,
.utilityBox2 {
  display: inline-flex;
  height: 29vh;
  width: 100%;
  box-sizing: border-box;
  border-top: 0;
  border-bottom: 0;
  margin: 0;
  padding: 0;
}

#legendChartDiv {
  position: absolute;
  z-index: 99;
  right: 80;
  margin: 0;
  padding: 0;
  top: 0;
  background-color: rgba(0, 0, 0, 0);
  height: 50vh;
  width: 10vw;
}

#legendChartDiv2 {
  position: absolute;
  z-index: 99;
  right: 80;
  margin: 0;
  padding: 0;
  top: 0;
  background-color: rgba(0, 0, 0, 0);
  height: 50vh;
  width: 10vw;
}

#paidChartDiv,
#structureChartDiv,
#paypChartDiv,
#exproChartDiv,
#utilityLineChartDiv,
#wopChartDiv,
#paidChartDiv2,
#structureChartDiv2,
#paypChartDiv2,
#legalpChartDiv2,
#exproChartDiv2,
#utilityLineChartDiv2,
#appraisalChartDiv2,
#wopChartDiv2 {
    width: 35%;
    height: 32vh;
    align-items: center;
    margin: 0;
    padding: 0;
    }

    #legalpChartDiv,
    #appraisalChartDiv {
      position: absolute;
      z-index: 99;
      width: 70%;
      height: 50vh;
      align-items: center;
      margin: 0;
      padding: 0;
      top: 50;
      left: 20;
    }

#handedOverChartDiv,
#handedOverChartDiv2 {
    width: 35%;
    height: 32vh;
    align-items: center;
    margin: 0;
    padding: 0;
    
    }

a {
  font-size: 1.2vw;
  color: white;
  font-weight: bold;
}

a:hover,
a:focus {
  color: rgb(185, 171, 171);
  font-size: 1.2vw;
}

ul {
list-style: none;
padding-left: 10;
line-height: 3rem;
}
â€‹



p {
  font-size: 1rem;
  width: auto;
  vertical-align: text-bottom;
  padding: 0;
  margin-top: 0;
}


h2 {
  font-weight: 400;
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  font-style: normal;
  font-size: 23px;
  color: white;
  padding:3px;
  margin: 0px;
  width: 470px;
  vertical-align: text-top;
}



h3 {
  color: white;
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  padding: 10;
  width: 100%;

}

h4 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: left;
  font-weight: normal;
  font-size: 16px;
  padding-top: 20px;
  margin: 0;
  width: 160px;
  vertical-align: text-bottom;
}

h5 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  padding: 3;
  margin: 10;
}

h6 {
  color: rgb(0, 197, 255);
  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
  text-align: center;
  font-weight: normal;
  font-size: 30px;
  padding: 0px 0px 0px 0px;
  }


    .sassy-theme .esri-menu,
.sassy-theme .esri-popup__main-container,
.sassy-theme .esri-popup .esri-popup__pointer-direction,
.sassy-theme .esri-popup .esri-popup__button,
.sassy-theme .esri-button,
.sassy-theme .esri-input,
.sassy-theme .esri-legend,
.sassy-theme .esri-layer-list,
.sassy-theme .esri-widget a {
  background-color: rgb(0, 0, 0, 0.7);
  color: #fff;
}

.sassy-theme .esri-legend__layer-caption {
display: none;
}

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    require([
  "esri/Basemap",
  "esri/Map",
  "esri/views/MapView",
  "esri/views/SceneView",
  "esri/layers/FeatureLayer",
  "esri/layers/support/FeatureFilter",
  "esri/layers/SceneLayer",
  "esri/layers/Layer",
  "esri/layers/TileLayer",
  "esri/layers/VectorTileLayer",
  "esri/layers/support/LabelClass",
  "esri/symbols/LabelSymbol3D",
  "esri/WebMap",
  "esri/WebScene",
  "esri/portal/PortalItem",
  "esri/portal/Portal",
  "esri/widgets/TimeSlider",
  "esri/widgets/Legend",
  "esri/widgets/LayerList",
  "esri/widgets/Fullscreen",
  "esri/rest/geometryService",
  "esri/rest/support/Query",
  "esri/rest/support/StatisticDefinition",
  "esri/symbols/WebStyleSymbol",
  "esri/TimeExtent",
  "esri/widgets/Expand",
  "esri/widgets/Editor",
  "esri/renderers/UniqueValueRenderer",
  "esri/widgets/support/DatePicker",
  "esri/widgets/FeatureTable",
  "esri/widgets/Compass",
  "esri/layers/ElevationLayer",
  "esri/Ground",
  "esri/layers/GraphicsLayer",
  "esri/widgets/Search",
], function(Basemap, Map, MapView, SceneView, 
            FeatureLayer, FeatureFilter,
            SceneLayer, Layer, TileLayer, VectorTileLayer,
            LabelClass, LabelSymbol3D, WebMap,
            WebScene, PortalItem, Portal,
            TimeSlider, Legend, LayerList, Fullscreen,
            geometryService, Query,
            StatisticDefinition, WebStyleSymbol,
            TimeExtent, Expand, Editor, UniqueValueRenderer, DatePicker,
            FeatureTable, Compass, ElevationLayer, Ground,
            GraphicsLayer, Search) {

////////////////////////////////////////////////////
var basemap = new Basemap({
  baseLayers: [
    new VectorTileLayer({
      portalItem: {
        id: "8a9ef2a144e8423786f6139408ac3424" // 3a62040541b84f528da3ac7b80cf4a63
      }
    })
  ]
});

   var map = new Map({
        basemap: basemap, //"gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation"
  }); 
  //map.ground.surfaceColor = "#FFFF";
  //map.ground.opacity = 0.5;


  // Setup UI




//*******************************//
// Import Layers                 //
//*******************************//
var lotLayer = new FeatureLayer({
    portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
  outFields: ["*"],
  title: "Status of Land Acquisition",
  labelsVisible: false,
});
const statusNames = ["Paid", "For Payment Processing", "For Legal Pass",
                       "For Appraisal/Offer to Buy", "For Expro","with WOP Fully Turned-over"]
// Stacked bar chart
var root = am5.Root.new("legalpChartDiv");

function stackedBarChart() {
  root.container.children.clear();

  var query = lotLayer.createQuery();
  query.where = "StatusNVS3 IS NOT NULL";
  query.groupByFieldsForStatistics = ["StatusNVS3"];

  const paid = [];
  const payp = [];
  const legalpass = [];
  const otb = [];
  const expro = [];
  const wop = [];

  // this format is needed:
  // data = [{category: "Paid", cp101: 46, cp102: 45,..}]

  lotLayer.queryFeatures(query).then(function(response) {
    var stats = response.features;
    // for each statusNVS3,
    stats.forEach((result, index) => {
      const attributes = result.attributes;
      const status = attributes.StatusNVS3;
      const cps = attributes.Package;

      if (status === 1) {
        paid.push(cps);
      } else if (status === 2) {
        payp.push(cps);
      } else if (status === 3) {
        legalpass.push(cps);
      } else if (status === 4) {
        otb.push(cps);
      } else if (status === 5) {
        expro.push(cps);
      } else if (status === 6) {
        wop.push(cps);
      }
    });

    // count the number of values per Package for each status
    //e.g., for Paid,  {"CP101": 56, .....}
    const countPaid = {};
    const countPayp = {};
    const countLegalpass = {};
    const countOtb = {};
    const countExpro = {};
    const countWop = {};

    for (let i = 0; i < paid.length; i++) {
      countPaid[paid[i]] = 1 + (countPaid[paid[i]] || 0);
    }
    for (let i = 0; i < payp.length; i++) {
      countPayp[payp[i]] = 1 + (countPayp[payp[i]] || 0);
    }
    for (let i = 0; i < legalpass.length; i++) {
      countLegalpass[legalpass[i]] = 1 + (countLegalpass[legalpass[i]] || 0);
    }
    for (let i = 0; i < otb.length; i++) {
      countOtb[otb[i]] = 1 + (countOtb[otb[i]] || 0);
    }
    for (let i = 0; i < expro.length; i++) {
      countExpro[expro[i]] = 1 + (countExpro[expro[i]] || 0);
    }
    for (let i = 0; i < wop.length; i++) {
      countWop[wop[i]] = 1 + (countWop[wop[i]] || 0);
    }

    // Convert array to object array
    // [{"category": "Paid", "CP101": 45,...}]
    // 1. Paid
    const categoryPaid = [];
    const valuePaid = [];
    for (let i = 0; i < Object.keys(countPaid).length; i++) {
      const category = Object.keys(countPaid)[i];
      const values = countPaid[Object.keys(countPaid)[i]];
      categoryPaid.push(category);
      valuePaid.push(values);
    }

    const categoriesPaid = categoryPaid.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[0],
        cp101: valuePaid[index] == undefined ? 0 : valuePaid[index],
        cp102: valuePaid[index + 1] == undefined ? 0 : valuePaid[index + 1],
        cp103: valuePaid[index + 2] == undefined ? 0 : valuePaid[index + 2],
        cp104: valuePaid[index + 3] == undefined ? 0 : valuePaid[index + 3],
        cp105: valuePaid[index + 4] == undefined ? 0 : valuePaid[index + 4],
        cp108: valuePaid[index + 5] == undefined ? 0 : valuePaid[index + 5],
        cp109: valuePaid[index + 6] == undefined ? 0 : valuePaid[index + 6]
      });
    });

   // 2. Payment Process
   const categoryPayp = [];
    const valuePayp = [];
    for (let i = 0; i < Object.keys(countPayp).length; i++) {
      const category = Object.keys(countPayp)[i];
      const values = countPayp[Object.keys(countPayp)[i]];
      categoryPayp.push(category);
      valuePayp.push(values);
    }

    const categoriesPayp = categoryPayp.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[1],
        cp101: valuePayp[index] == undefined ? 0 : valuePayp[index],
        cp102: valuePayp[index + 1] == undefined ? 0 : valuePayp[index + 1],
        cp103: valuePayp[index + 2] == undefined ? 0 : valuePayp[index + 2],
        cp104: valuePayp[index + 3] == undefined ? 0 : valuePayp[index + 3],
        cp105: valuePayp[index + 4] == undefined ? 0 : valuePayp[index + 4],
        cp108: valuePayp[index + 5] == undefined ? 0 : valuePayp[index + 5],
        cp109: valuePayp[index + 6] == undefined ? 0 : valuePayp[index + 6]
      });
    });

   // 3. For Legal pass
   const categoryLegalpass = [];
    const valueLegalpass = [];
    for (let i = 0; i < Object.keys(countLegalpass).length; i++) {
      const category = Object.keys(countLegalpass)[i];
      const values = countLegalpass[Object.keys(countLegalpass)[i]];
      categoryLegalpass.push(category);
      valueLegalpass.push(values);
    }

    const categoriesLegalpass = categoryLegalpass.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[2],
        cp101: valueLegalpass[index] == undefined ? 0 : valueLegalpass[index],
        cp102: valueLegalpass[index + 1] == undefined ? 0 : valueLegalpass[index + 1],
        cp103: valueLegalpass[index + 2] == undefined ? 0 : valueLegalpass[index + 2],
        cp104: valueLegalpass[index + 3] == undefined ? 0 : valueLegalpass[index + 3],
        cp105: valueLegalpass[index + 4] == undefined ? 0 : valueLegalpass[index + 4],
        cp108: valueLegalpass[index + 5] == undefined ? 0 : valueLegalpass[index + 5],
        cp109: valueLegalpass[index + 6] == undefined ? 0 : valueLegalpass[index + 6]
      });
    });

   // 4. Otb
   const categoryOtb = [];
    const valueOtb = [];
    for (let i = 0; i < Object.keys(countOtb).length; i++) {
      const category = Object.keys(countOtb)[i];
      const values = countOtb[Object.keys(countOtb)[i]];
      categoryOtb.push(category);
      valueOtb.push(values);
    }

    const categoriesOtb = categoryOtb.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[3],
        cp101: valueOtb[index] == undefined ? 0 : valueOtb[index],
        cp102: valueOtb[index + 1] == undefined ? 0 : valueOtb[index + 1],
        cp103: valueOtb[index + 2] == undefined ? 0 : valueOtb[index + 2],
        cp104: valueOtb[index + 3] == undefined ? 0 : valueOtb[index + 3],
        cp105: valueOtb[index + 4] == undefined ? 0 : valueOtb[index + 4],
        cp108: valueOtb[index + 5] == undefined ? 0 : valueOtb[index + 5],
        cp109: valueOtb[index + 6] == undefined ? 0 : valueOtb[index + 6]
      });
    });

   // 5. Expro
   const categoryExpro = [];
    const valueExpro = [];
    for (let i = 0; i < Object.keys(countExpro).length; i++) {
      const category = Object.keys(countExpro)[i];
      const values = countExpro[Object.keys(countExpro)[i]];
      categoryExpro.push(category);
      valueExpro.push(values);
    }

    const categoriesExpro = categoryExpro.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[4],
        cp101: valueExpro[index] == undefined ? 0 : valueExpro[index],
        cp102: valueExpro[index + 1] == undefined ? 0 : valueExpro[index + 1],
        cp103: valueExpro[index + 2] == undefined ? 0 : valueExpro[index + 2],
        cp104: valueExpro[index + 3] == undefined ? 0 : valueExpro[index + 3],
        cp105: valueExpro[index + 4] == undefined ? 0 : valueExpro[index + 4],
        cp108: valueExpro[index + 5] == undefined ? 0 : valueExpro[index + 5],
        cp109: valueExpro[index + 6] == undefined ? 0 : valueExpro[index + 6]
      });
    });

   // 6. WOP
   const categoryWop = [];
    const valueWop = [];
    for (let i = 0; i < Object.keys(countWop).length; i++) {
      const category = Object.keys(countWop)[i];
      const values = countWop[Object.keys(countWop)[i]];
      categoryWop.push(category);
      valueWop.push(values);
    }

    const categoriesWop = categoryWop.map((category, index) => {
      return Object.assign({}, {
        category: statusNames[5],
        cp101: valueWop[index] == undefined ? 0 : valueWop[index],
        cp102: valueWop[index + 1] == undefined ? 0 : valueWop[index + 1],
        cp103: valueWop[index + 2] == undefined ? 0 : valueWop[index + 2],
        cp104: valueWop[index + 3] == undefined ? 0 : valueWop[index + 3],
        cp105: valueWop[index + 4] == undefined ? 0 : valueWop[index + 4],
        cp108: valueWop[index + 5] == undefined ? 0 : valueWop[index + 5],
        cp109: valueWop[index + 6] == undefined ? 0 : valueWop[index + 6]
      });
    });

   // Compile to object array
   const data = [];
   data.push(categoriesOtb[[0]], categoriesLegalpass[[0]], categoriesPayp[[0]], categoriesPaid[[0]],categoriesExpro[[0]], categoriesWop[[0]]);
  console.log(data);

  // set themes
  root.setThemes([
    am5themes_Animated.new(root)
  ]);

  // Create chart
  // https://www.amcharts.com/docs/v5/charts/xy-chart/
  var chart = root.container.children.push(am5xy.XYChart.new(root, {
    panX: false,
    panY: false,
    wheelX: "panX",
    wheelY: "zoomX",
    paddingBottom: 50
  }));

  // Create axes
  // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
  var xRenderer = am5xy.AxisRendererX.new(root, {
    strokeOpacity: 1,
    strokeWidth: 1,
    stroke: am5.color("#ffffff"),
  });

  var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
    categoryField: "category",
    renderer: xRenderer,
    tooltip: am5.Tooltip.new(root, {})
  }));

  xRenderer.grid.template.setAll({
    location: 1
  })

  // Label properties for yAxis (category axis)
  xAxis.get("renderer").labels.template.setAll({
    //oversizedBehavior: "wrap",
    textAlign: "center",
    fill: am5.color("#ffffff"),
    //maxWidth: 150,
    fontSize: 14
});

  xAxis.data.setAll(data);

  var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
    min: 0,
    renderer: am5xy.AxisRendererY.new(root, {
      strokeOpacity: 1,
      strokeWidth: 1,
      stroke: am5.color("#ffffff"),
    })
  }));

  // Label properties Y axis
  yAxis.get("renderer").labels.template.setAll({
    //oversizedBehavior: "wrap",
    textAlign: "center",
    fill: am5.color("#ffffff"),
    //maxWidth: 150,
    fontSize: 12
  });


  // Add legend
  // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
  var legend = chart.children.push(am5.Legend.new(root, {
    centerX: am5.p50,
    x: am5.p50,
    centerY: am5.percent(-20),
    y: am5.p100,
    //paddingBottom: -50
  }));

  legend.labels.template.setAll({
    oversizedBehavior: "truncate",
    fill: am5.color("#ffffff"),
    //textDecoration: "underline"
    //width: am5.percent(200)
    //fontWeight: "300"
  });

  // Esri color ramps - Candy Shop
// #1e8553,#c44296,#d9bf0d,#d97f00,#00b6f1,#9933cc,#3abf66
const colors = ["#1e8553", "#c44296", "#d9bf0d", "#d97f00", "#00b6f1", "#9933cc", "#3abf66"];
chart.get("colors").set("colors", [
  am5.color(colors[0]),
  am5.color(colors[1]),
  am5.color(colors[2]),
  am5.color(colors[3]),
  am5.color(colors[4]),
  am5.color(colors[5]),
  am5.color(colors[6]),
]);

  // Add series
  // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
  function makeSeries(name, fieldName) {
    var series = chart.series.push(am5xy.ColumnSeries.new(root, {
      name: name,
      stacked: true,
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: fieldName,
      categoryXField: "category"
    }));

    series.columns.template.setAll({
      tooltipText: "{name}, {categoryX}: {valueY}",
      tooltipY: am5.percent(10)
    });

    series.data.setAll(data);

    // Make stuff animate on load
    // https://www.amcharts.com/docs/v5/concepts/animations/
    series.appear();

    series.bullets.push(function() {
      return am5.Bullet.new(root, {
        sprite: am5.Label.new(root, {
          text: "{valueY}",
          fill: root.interfaceColors.get("alternativeText"),
          centerY: am5.p50,
          centerX: am5.p50,
          populateText: true
        })
      });
    });

    legend.data.push(series);
  }

  makeSeries("CP101", "cp101");
  makeSeries("CP102", "cp102");
  makeSeries("CP103", "cp103");
  makeSeries("CP104", "cp104");
  makeSeries("CP105", "cp105");
  makeSeries("CP108", "cp108");
  makeSeries("CP109", "cp109");



  // Make stuff animate on load
  // https://www.amcharts.com/docs/v5/concepts/animations/
  chart.appear(1000, 100);
  });
}


/////////////////////////////////////////////////////////////////
var root2 = am5.Root.new("appraisalChartDiv");

function stackedBarChart2() {
  root2.container.children.clear();

  const cpNames = ["CP101", "CP102", "CP103", "CP104", "CP105", "CP108", "CP109"]

  var query = lotLayer.createQuery();
  query.where = "StatusNVS3 >= 1";
  query.groupByFieldsForStatistics = ["Package"];

  const cp101 = [];
  const cp102 = [];
  const cp103 = [];
  const cp104 = [];
  const cp105 = [];
  const cp108 = [];
  const cp109 = [];

  // this format is needed:
  // data = [{category: "Paid", cp101: 46, cp102: 45,..}]

  lotLayer.queryFeatures(query).then(function(response) {
    var stats = response.features;
    // for each statusNVS3,
    stats.forEach((result, index) => {
      const attributes = result.attributes;
      const status = attributes.StatusNVS3;
      const cps = attributes.Package;

      if (cps === 'CP101') {
        cp101.push(status);
      } else if (cps === 'CP102') {
        cp102.push(status);
      } else if (cps === 'CP103') {
        cp103.push(status);
      } else if (cps === 'CP104') {
        cp104.push(status);
      } else if (cps === 'CP105') {
        cp105.push(status);
      } else if (cps === 'CP108') {
        cp108.push(status);
      } else if (cps === 'CP109') {
        cp109.push(status);
      }
    });

    // count the number of values per Package for each status
    //e.g., for Paid,  {"CP101": 56, .....}
    const countCP101 = {};
    const countCP102 = {};
    const countCP103 = {};
    const countCP104 = {};
    const countCP105 = {};
    const countCP108 = {};
    const countCP109 = {};

    for (let i = 0; i < cp101.length; i++) {
      countCP101[cp101[i]] = 1 + (countCP101[cp101[i]] || 0);
    }
    for (let i = 0; i < cp102.length; i++) {
      countCP102[cp102[i]] = 1 + (countCP102[cp102[i]] || 0);
    }
    for (let i = 0; i < cp103.length; i++) {
      countCP103[cp103[i]] = 1 + (countCP103[cp103[i]] || 0);
    }
    for (let i = 0; i < cp104.length; i++) {
      countCP104[cp104[i]] = 1 + (countCP104[cp104[i]] || 0);
    }
    for (let i = 0; i < cp105.length; i++) {
      countCP105[cp105[i]] = 1 + (countCP105[cp105[i]] || 0);
    }
    for (let i = 0; i < cp108.length; i++) {
      countCP108[cp108[i]] = 1 + (countCP108[cp108[i]] || 0);
    }
    for (let i = 0; i < cp109.length; i++) {
      countCP109[cp109[i]] = 1 + (countCP109[cp109[i]] || 0);
    }
  
    // Convert array to object array
    // [{"category": "CP101", "CP101": 45,...}]
    // 1. CP101
    const categoryCP101 = [];
    const valueCP101 = [];
    for (let i = 0; i < Object.keys(countCP101).length; i++) {
      const category = Object.keys(countCP101)[i];
      const values = countCP101[Object.keys(countCP101)[i]];
      categoryCP101.push(category);
      valueCP101.push(values);
    }

  const categoriesCP101 = categoryCP101.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[0],
        paid: valueCP101[index] == undefined ? 0 : valueCP101[index],
        payp: valueCP101[index + 1] == undefined ? 0 : valueCP101[index + 1],
        legalp: valueCP101[index + 2] == undefined ? 0 : valueCP101[index + 2],
        otb: valueCP101[index + 3] == undefined ? 0 : valueCP101[index + 3],
        expro: valueCP101[index + 4] == undefined ? 0 : valueCP101[index + 4],
        wop: valueCP101[index + 5] == undefined ? 0 : valueCP101[index + 5],
      });
    });
  // console.log(categoriesCP101[[0]]);

   // 2. CP102
   const categoryCP102 = [];
    const valueCP102 = [];
    for (let i = 0; i < Object.keys(countCP102).length; i++) {
      const category = Object.keys(countCP102)[i];
      const values = countCP102[Object.keys(countCP102)[i]];
      categoryCP102.push(category);
      valueCP102.push(values);
    }

    const categoriesCP102 = categoryCP102.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[1],
        paid: valueCP102[index] == undefined ? 0 : valueCP102[index],
        payp: valueCP102[index + 1] == undefined ? 0 : valueCP102[index + 1],
        legalp: valueCP102[index + 2] == undefined ? 0 : valueCP102[index + 2],
        otb: valueCP102[index + 3] == undefined ? 0 : valueCP102[index + 3],
        expro: valueCP102[index + 4] == undefined ? 0 : valueCP102[index + 4],
        wop: valueCP102[index + 5] == undefined ? 0 : valueCP102[index + 5],
      });
    });
   //console.log(categoriesCP102[[0]]);

   // 3. CP103
   const categoryCP103 = [];
    const valueCP103 = [];
    for (let i = 0; i < Object.keys(countCP103).length; i++) {
      const category = Object.keys(countCP103)[i];
      const values = countCP103[Object.keys(countCP103)[i]];
      categoryCP103.push(category);
      valueCP103.push(values);
    }

    const categoriesCP103 = categoryCP103.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[2],
        paid: valueCP103[index] == undefined ? 0 : valueCP103[index],
        payp: valueCP103[index + 1] == undefined ? 0 : valueCP103[index + 1],
        legalp: valueCP103[index + 2] == undefined ? 0 : valueCP103[index + 2],
        otb: valueCP103[index + 3] == undefined ? 0 : valueCP103[index + 3],
        expro: valueCP103[index + 4] == undefined ? 0 : valueCP103[index + 4],
        wop: valueCP103[index + 5] == undefined ? 0 : valueCP103[index + 5],
      });
    });
   //console.log(categoriesCP103[[0]]);

   // 4. CP104
   const categoryCP104 = [];
    const valueCP104 = [];
    for (let i = 0; i < Object.keys(countCP104).length; i++) {
      const category = Object.keys(countCP104)[i];
      const values = countCP104[Object.keys(countCP104)[i]];
      categoryCP104.push(category);
      valueCP104.push(values);
    }

    if (categoryCP104.length === 0) {
      var categoriesCP104 = [
        {
          category: cpNames[3],
          paid: 0,
          payp: 0,
          legalp: 0,
          otb: 0,
          expro: 0,
          wop: 0,
        }
      ]
      
    } else {
      var categoriesCP104 = categoryCP104.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[3],
        paid: valueCP104[index] == undefined ? 0 : valueCP104[index],
        payp: valueCP104[index + 1] == undefined ? 0 : valueCP104[index + 1],
        legalp: valueCP104[index + 2] == undefined ? 0 : valueCP104[index + 2],
        otb: valueCP104[index + 3] == undefined ? 0 : valueCP104[index + 3],
        expro: valueCP104[index + 4] == undefined ? 0 : valueCP104[index + 4],
        wop: valueCP104[index + 5] == undefined ? 0 : valueCP104[index + 5],
      });
    });
    }

   //console.log(categoriesCP104[[0]]);

   // 5. CP105
   const categoryCP105 = [];
    const valueCP105 = [];
    for (let i = 0; i < Object.keys(countCP105).length; i++) {
      const category = Object.keys(countCP105)[i];
      const values = countCP105[Object.keys(countCP105)[i]];
      categoryCP105.push(category);
      valueCP105.push(values);
    }

    if (categoryCP105.length === 0) {
      var categoriesCP105 = [
        {
          category: cpNames[4],
          paid: 0,
          payp: 0,
          legalp: 0,
          otb: 0,
          expro: 0,
          wop: 0,
        }
      ]
      
    } else {
      var categoriesCP105 = categoryCP105.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[4],
        paid: valueCP105[index] == undefined ? 0 : valueCP105[index],
        payp: valueCP105[index + 1] == undefined ? 0 : valueCP105[index + 1],
        legalp: valueCP105[index + 2] == undefined ? 0 : valueCP105[index + 2],
        otb: valueCP105[index + 3] == undefined ? 0 : valueCP105[index + 3],
        expro: valueCP105[index + 4] == undefined ? 0 : valueCP105[index + 4],
        wop: valueCP105[index + 5] == undefined ? 0 : valueCP105[index + 5],
      });
    });
    }
 

   // 6. CP108
   const categoryCP108 = [];
    const valueCP108 = [];
    for (let i = 0; i < Object.keys(countCP108).length; i++) {
      const category = Object.keys(countCP108)[i];
      const values = countCP108[Object.keys(countCP108)[i]];
      categoryCP108.push(category);
      valueCP108.push(values);
    }

    if (categoryCP108.length === 0) {
      var categoriesCP108 = [
        {
          category: cpNames[5],
          paid: 0,
          payp: 0,
          legalp: 0,
          otb: 0,
          expro: 0,
          wop: 0,
        }
      ]
      
    } else {
      var categoriesCP108 = categoryCP108.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[5],
        paid: valueCP108[index] == undefined ? 0 : valueCP108[index],
        payp: valueCP108[index + 1] == undefined ? 0 : valueCP108[index + 1],
        legalp: valueCP108[index + 2] == undefined ? 0 : valueCP108[index + 2],
        otb: valueCP108[index + 3] == undefined ? 0 : valueCP108[index + 3],
        expro: valueCP108[index + 4] == undefined ? 0 : valueCP108[index + 4],
        wop: valueCP108[index + 5] == undefined ? 0 : valueCP108[index + 5],
      });
    });
    }

   //console.log(categoriesCP108[[0]]);

   // CP109
   const categoryCP109 = [];
    const valueCP109 = [];
    for (let i = 0; i < Object.keys(countCP109).length; i++) {
      const category = Object.keys(countCP109)[i];
      const values = countCP109[Object.keys(countCP109)[i]];
      categoryCP109.push(category);
      valueCP109.push(values);
    }

    if (categoryCP109.length === 0) {
      var categoriesCP109 = [
        {
          category: cpNames[6],
          paid: 0,
          payp: 0,
          legalp: 0,
          otb: 0,
          expro: 0,
          wop: 0,
        }
      ]
      
    } else {
      var categoriesCP109 = categoryCP109.map((category, index) => {
      return Object.assign({}, {
        category: cpNames[6],
        paid: valueCP109[index] == undefined ? 0 : valueCP109[index],
        payp: valueCP109[index + 1] == undefined ? 0 : valueCP109[index + 1],
        legalp: valueCP109[index + 2] == undefined ? 0 : valueCP109[index + 2],
        otb: valueCP109[index + 3] == undefined ? 0 : valueCP109[index + 3],
        expro: valueCP109[index + 4] == undefined ? 0 : valueCP109[index + 4],
        cp109: valueCP109[index + 5] == undefined ? 0 : valueCP109[index + 5],
      });
    });
    }

   //console.log(categoriesCP109[[0]]);

   // Compile to object array
   const data = [];
   data.push(categoriesCP101[[0]], categoriesCP102[[0]], categoriesCP103[[0]],
             categoriesCP104[[0]], categoriesCP105[[0]], categoriesCP108[[0]], categoriesCP109[[0]]);
  console.log(data);

  // set themes
  root2.setThemes([
    am5themes_Animated.new(root2)
  ]);

  // Create chart
  // https://www.amcharts.com/docs/v5/charts/xy-chart/
  var chart = root2.container.children.push(am5xy.XYChart.new(root2, {
    panX: false,
    panY: false,
    wheelX: "panX",
    wheelY: "zoomX",
    layout: root2.verticalLayout
  }));

  const colors2 = ["#1e8553", "#c44296", "#d9bf0d", "#d97f00", "#00b6f1", "#9933cc"];
chart.get("colors").set("colors", [
  am5.color(colors2[0]),
  am5.color(colors2[1]),
  am5.color(colors2[2]),
  am5.color(colors2[3]),
  am5.color(colors2[4]),
  am5.color(colors2[5]),
]);

  // Create axes
  // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
  var xRenderer = am5xy.AxisRendererX.new(root2, {
    strokeOpacity: 1,
    strokeWidth: 1,
    stroke: am5.color("#ffffff"),
    //marginBottom: 100
  });

  var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root2, {
    categoryField: "category",
    renderer: xRenderer,
    tooltip: am5.Tooltip.new(root2, {})
  }));

  xRenderer.grid.template.setAll({
    location: 1
  })

  // Label properties for yAxis (category axis)
  xAxis.get("renderer").labels.template.setAll({
    //oversizedBehavior: "wrap",
    textAlign: "center",
    fill: am5.color("#ffffff"),
    //maxWidth: 150,
    fontSize: 14
});

  xAxis.data.setAll(data);

  var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root2, {
    min: 0,
    renderer: am5xy.AxisRendererY.new(root2, {
      strokeOpacity: 1,
      strokeWidth: 1,
      stroke: am5.color("#ffffff"),
    })
  }));

  // Label properties Y axis
  yAxis.get("renderer").labels.template.setAll({
    //oversizedBehavior: "wrap",
    textAlign: "center",
    fill: am5.color("#ffffff"),
    //maxWidth: 150,
    fontSize: 12
  });


  // Add legend
  // https://www.amcharts.com/docs/v5/charts/xy-chart/legend-xy-series/
  var legend = chart.children.push(am5.Legend.new(root2, {
    centerX: am5.percent(50),
    x: am5.percent(55),
    layout: root2.horizontalLayout,
  }));

  legend.labels.template.setAll({
    oversizedBehavior: "truncate",
    fill: am5.color("#ffffff"),
    fontSize: 15,
    scale: 0.8
    //textDecoration: "underline"
    //width: am5.percent(200)
    //fontWeight: "300"
  });

  // Esri color ramps - Candy Shop
// #1e8553,#c44296,#d9bf0d,#d97f00,#00b6f1,#9933cc,#3abf66
const colors = ["#1e8553", "#c44296", "#d9bf0d", "#d97f00", "#00b6f1", "#9933cc", "#3abf66"];
chart.get("colors").set("colors", [
  am5.color(colors[0]),
  am5.color(colors[1]),
  am5.color(colors[2]),
  am5.color(colors[3]),
  am5.color(colors[4]),
  am5.color(colors[5]),
  am5.color(colors[6]),
]);

  // Add series
  // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
  function makeSeries(name, fieldName) {
    var series = chart.series.push(am5xy.ColumnSeries.new(root2, {
      name: name,
      stacked: true,
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: fieldName,
      categoryXField: "category"
    }));

    series.columns.template.setAll({
      tooltipText: "{name}, {categoryX}: {valueY}",
      tooltipY: am5.percent(10)
    });

    series.data.setAll(data);

    // Make stuff animate on load
    // https://www.amcharts.com/docs/v5/concepts/animations/
    series.appear();

    series.bullets.push(function() {
      return am5.Bullet.new(root2, {
        sprite: am5.Label.new(root2, {
          text: "{valueY}",
          fill: root2.interfaceColors.get("alternativeText"),
          centerY: am5.p50,
          centerX: am5.p50,
          populateText: true
        })
      });
    });

    legend.data.push(series);
  }

  makeSeries(statusNames[0], "paid");
  makeSeries(statusNames[1], "payp");
  makeSeries(statusNames[2], "legalp");
  makeSeries(statusNames[3], "otb");
  makeSeries(statusNames[4], "expro");
  makeSeries(statusNames[5], "wop");



  // Make stuff animate on load
  // https://www.amcharts.com/docs/v5/concepts/animations/
  chart.appear(1000, 100);
  });
}
stackedBarChart2();



});
</script>