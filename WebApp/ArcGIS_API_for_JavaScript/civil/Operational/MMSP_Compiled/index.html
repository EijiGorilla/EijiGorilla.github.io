<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MMSP Compiled</title>
    
        <!-- https://www.esri.com/arcgis-blog/products/arcgis-living-atlas/public-safety/wildfire-aware-app-design-and-implementation/-->

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.4.2/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.4.2/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <!-- Resources -->
    <script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.144.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
    <script src="https://js.arcgis.com/4.27/"></script>
    <script src="js/animepoint.js"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
    }


    #container {
      display: grid;
      flex-wrap: wrap;
      box-sizing: border-box;
      grid-template-columns: 1fr 0.25fr;
      width: 100%;
      height: 100%;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    calcite-list {
      overflow-y: auto;
    }


    calcite-tab {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }



    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #contractPackageDiv {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;

    }

    calcite-segmented-control {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;
    }

    calcite-button {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: auto;
    }

    #info-content {
      padding: 0.75rem;
      overflow-y: auto;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }

    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    /* CHART AND CONTENT PANEL */
    #chartPanel {
      background-color: rgb(0, 0, 0, 0);
      padding: 8;
      width: 100%;
      height: 100%;
    }
    
    #landPieChartDiv,
    #structurePieChartDiv,
    #nloPieChartDiv,
    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
      height: 45%;
      margin-bottom: 5;
    }

    #treeCuttingPieChartDiv,
    #treeCompensationPieChartDiv {
      height: 40%;
      margin-bottom: 5;
    }


    .lotNumber-container,
    .structureNumber-container,
    .nloNumber-container,
    .pteLot-container,
    .pteStructure-container,
    .treeNumber-container,
    .utilityNumber-container,
    .tbmShaftNumber-container {
      display: flex;
    }

    #lotNumberDiv,
    #structureNumberDiv,
    #nloNumberDiv,
    #pteLotNumberDiv,
    #pteStructureNumberDiv,
    #treeNumberDiv,
    #utilityNumberDiv,
    #tbmShaftNumberDiv {
      width: 50%;
      height: 10%;
      padding-top: 2%;
      padding-left: 15px;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #pteLotNumberDiv b,
    #pteStructureNumberDiv b {
      font-size: 2vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #landImage,
    #landNumberImage,
    #nloNumberImage,
    #structureImage,
    #structureNumberImage,
    #treeNumberImage,
    #utilityNumberImage {
      width: 17.5%;
      height: auto;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      margin-bottom: -10;
    }

    #tbmShaftNumberImage {
      width: 17%;
      height: 17%;
      margin-left: auto;
      margin-right: auto;
      margin-top: 5;
      margin-bottom: -30;
    }

    #lotNumberDiv b,
    #nloNumberDiv b,
    #structureNumberDiv b,
    #treeNumberDiv b,
    #utilityNumberDiv b,
    #tbmShaftNumberDiv b {
      font-size: 2.5vw;
      font-family: 'Calibri';
      font-weight: bold;
      color: #6ede00; /*#d4ff33;*/
      margin: auto;
    }

    #chartMoaLotDiv,
    #chartMoaStructureDiv {
      width: 100%;
      height: 30%;
      align-items: center;
      padding: 1%;
      margin-top: 5%;
    }

    #utilityPointChartDiv,
    #utilityLineChartDiv {
      padding-left: 12px;
      align-items: center;
      width: 91%;
      height: 38%;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #tbmShaftChartDiv {
      padding-left: 12px;
      align-items: center;
      width: 91%;
      height: 50%;
      font-size: 1vw;
      color: #f7f5f7;
    }

    #timeSeriesChartTbmTunnelViaduct,
    #timeSeriesChartTbmTunnelLand {
      position: absolute;
      z-index: 1;
      height: 40vh;
      width: 60vw;
      bottom: 20%;
      left: 8vw;
      background-color: rgb(37, 37, 37);
    }

    /* See Through Label */
    #see-through-label,
    #tbmShaft-checkbox,
    #land-checkbox {
      padding: 10;
    }

    b {
        color: orange;
    }

    /* TRAIN ANIMATION BUTTON */
    .overlay {
      position: fixed;
      z-index: 1;
      width: 2%;
      bottom: 0;
      right: 7;
      background-color: rgba(80, 80, 80, 0);
      padding: 0;
      /*text-align: center;*/
    }
  
    .button {
      cursor: pointer;
      font-size: 1vw !important;
      font-weight: bold !important;
      color: rgb(230, 230, 230);
      padding: 0;
    }
    
    .button:hover, #label {
      color: white;
    }
    
    .button, #label {
      margin: 15px;
    }

    /* SCROLL BAR */
    /* ESRI POPUP */

    ::-webkit-scrollbar {
      width: 5px;
      
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #00032235; /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #FFBA1F;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
      }

    /*
    .esri-legend__layer-cell--info {
      background-color: black;
      color: white;
      font-size: 0.85vw;
    }
    */

    .esri-legend {
      overflow: hidden;
      overflow-y: auto;
      margin-left: -10;
    }



    #image {
      width: 50px;
      height: 50px;
    }

    /*
    .esri-legend__layer-cell {
      min-width: 100px;
      word-break: break-word;
      padding: 0;
      vertical-align: middle;
      margin: 0;
    }
    */

  #measurementToolMenu {
    padding: 0.8em;
    max-width: 180px;
    width: 250px;
  }

  #measurementToolLabel {
    color: white;
  }

  #sliceContainer {
    width: inherit;
  }

  #sliceOptions {
    margin: 0 15px;
  }

  #sliceOptions>button {
    margin-bottom: 15px;
  }

  #sliceContainer {
    max-width: 228px;
  }

  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">

        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>
        <div id="dateDiv">As of June 26, 2023</div>

        <!-- Dropdown Lists -->
        <div id="contractPackageDiv">
          <calcite-segmented-control>
            <calcite-segmented-control-item id="All" value="all" checked>All</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP101" value="cp-01">CP101</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP102" value="cp-02">CP102</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP103" value="cp-03">CP103</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP104" value="cp-04">CP104</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP105" value="cp-05">CP105</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP108" value="cp-08">CP108</calcite-segmented-control-item>
            <calcite-segmented-control-item id="CP109" value="cp-09">CP109</calcite-segmented-control-item>
          </calcite-segmented-control>
        </div>
      </div>

            <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" display-mode="float" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="seethrough" icon="transparency" text="Underground"></calcite-action>
          <calcite-action data-action-id="charts" icon="graph-time-series" text="Progree Chart"></calcite-action>
          <calcite-action data-action-id="smartmaps" icon="collection" text="Smart Map Link"></calcite-action>
          <calcite-action data-action-id="animation" icon="play" text="Animation"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <calcite-list>
            <calcite-list-item label="Land Acquisition" description="" value="land-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="land-check" style="margin-left: 5px" checked></calcite-checkbox>
              <div id="land-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
            </calcite-list-item>
            <calcite-list-item label="Existing Structure" description="" value="structure-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="structure-check" style="margin-left: 5px"></calcite-checkbox>
                <div id="structure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Demolished Structure" description="" value="demolished-structure-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="demolished-structure-check" style="margin-left: 5px"></calcite-checkbox>
                <div id="demolished-structure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Informal Settlers Families (ISF)" description="" value="isf-acquisition">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="isf-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="isf-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Depot Building" description="" value="depot-building">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="depotbuilding-check" style="margin-left: 5px" checked></calcite-checkbox>
                <div id="depotbuilding-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
              </calcite-list-item>
              <calcite-list-item label="BSS Depot Building" description="" value="bss-depot-building">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="bss-depotbuilding-check" style="margin-left: 5px" checked></calcite-checkbox>
                <div id="bss-depotbuilding-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
              </calcite-list-item>
              <calcite-list-item label="East Valenzuela Station" description="" value="evs-acquisition">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="evs-check" style="margin-left: 5px"></calcite-checkbox>
                <div id="evs-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
              </calcite-list-item>
              <calcite-list-item label="Senate-DepEd Boundary" description="" value="senate-boundary">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="senateboundary-check" style="margin-left: 5px"></calcite-checkbox>
                <div id="senateboundary-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
              </calcite-list-item>
              <calcite-list-item label="PO Section Box" description="" value="po-sectionbox">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                <calcite-checkbox slot="actions-start" id="posectionbox-check" style="margin-left: 5px" checked></calcite-checkbox>
                <div id="posectionbox-legend" class="esri-widget" style="margin-bottom: 0px;"></div>
              </calcite-list-item>


              <calcite-list-item label="Trees" description="" value="treesall">
                <calcite-checkbox slot="actions-start" id="treesall-check" style="margin-left: 5px"></calcite-checkbox>
                <calcite-list-item label="Tree Cutting" description="" value="treeCutting">
                  <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                    <calcite-checkbox slot="actions-start" id="treecutting-check" style="margin-left: 5px"></calcite-checkbox>
                    <div id="treecutting-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                  </calcite-list-item>
                  <calcite-list-item label="Tree Compensation" description="" value="treeCompensation">
                  <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
                    <calcite-checkbox slot="actions-start" id="treecompensation-check" style="margin-left: 5px"></calcite-checkbox>
                    <div id="treecompensation-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
                  </calcite-list-item>
              </calcite-list-item>



            <calcite-list-item label="Utility Relocation (Point Sybmol)" description="" value="utility-point">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilitypoint-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilitypoint-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Point Status)" description="" value="utility-pointStatus">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilitypointstatus-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilitypointstatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Line Symbol)" description="" value="utility-line">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilityline-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilityline-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation (Line Status)" description="" value="utility-lineStatus">
            <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="utilitylinestatus-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="utilitylinestatus-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="River" description="" value="river-affected">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="river-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="river-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="TBM Tunnel" description="" value="tbm-tunnel">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="tbmtunnel-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="tbmtunnel-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Muckpit" description="" value="muckpit-tunnel">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="muckpit-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="muckpit-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="TBM Shaft" description="" value="tbm-shaft">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="tbmshaft-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="tbmshaft-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
            <calcite-list-item label="Station Structure" description="" value="stationstructure">
              <!-- <calcite-action slot="actions-start" icon="layer" text="Land layer"></calcite-action> -->
              <calcite-checkbox slot="actions-start" id="stationstructure-check" style="margin-left: 5px"></calcite-checkbox>
              <div id="stationstructure-legend" class="esri-widget" style="margin-bottom: 0px;" hidden></div>
            </calcite-list-item>
          </calcite-list>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="View Underground" height-scale="l" data-panel-id="seethrough" hidden>
          <calcite-label layout="inline" id="see-through-label">
            <calcite-checkbox id="myLink"></calcite-checkbox> Ground color becomes transparent
          </calcite-label>
        </calcite-panel>

        <calcite-panel class="timeSeries-panel" heading="Progress Chart" height-scale="l" data-panel-id="charts" hidden>
          <calcite-label layout="inline" id="tbmTunnel-timeSeries-label">
            <calcite-checkbox id="tbmTunnel-checkbox"></calcite-checkbox>Viaduct
          </calcite-label>
          <calcite-label layout="inline" id="land-timeSeries-label">
            <calcite-checkbox id="land-checkbox"></calcite-checkbox>Handed-Over Lot
          </calcite-label>
        </calcite-panel>

        <calcite-panel heading="Links to Individual Smart Maps" height-scale="l" data-panel-id="smartmaps" hidden>
          <calcite-list>
            <calcite-list-item label="Land Acqusition" description="Structure/NLO included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Land_Structure2/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="Tree Cutting/Compensation" description="Tree conservation status included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/envi/Operational/N2_Tree_Cutting/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="Utility Relocation" description="Major utility companies included">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Utility_Relocation/index.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
            <calcite-list-item label="TBM Shaft" description="Construction progress on main tbmShaft">
              <calcite-link
              slot="actions-start"
              href="https://eijigorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/civil/Operational/N2_Viaduct/index2.html"
              icon-start="launch"
              target="_blank">
            </calcite-link>
            </calcite-list-item>
          </calcite-list>
        </calcite-panel>

        <calcite-panel class="animation-panel"  height-scale="l" data-panel-id="animation" hidden></calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="container">
        <div id="timeSeriesChartTbmTunnelDiv" hidden></div>
        <div id="timeSeriesChartLandDiv" hidden></div>
      <div id="viewDiv">
        <div id="measurementToolMenu" class="esri-widget">
          <calcite-label>
            <div id="measurementToolLabel">
              Click one of the buttons below to open the corresponding analysis widget and interact with the analysis.
            </div>
          </calcite-label>
          <calcite-button
            id="directLineMeasurementAnalysisButton"
            icon-start="measure-line"
            title="Interact with direct line measurement"
          >
          </calcite-button>
          <calcite-button
            id="areaMeasurementAnalysisButton"
            icon-start="measure-area"
            title="Interact with area measurement"
          >
          </calcite-button>
          <calcite-button id="sliceAnalysisButton" icon-start="slice" title="Interact with slice plane"> </calcite-button>
          <calcite-button
            id="lineOfSightAnalysisButton"
            icon-start="line-of-sight"
            title="Interact with line of sight analysis"
          >
          </calcite-button>
          <calcite-label></calcite-label>
          <calcite-button id="removeWidgetButton" title="Remove Widget" style="display: none; width: 140px"
            >Remove Widget
          </calcite-button>
        </div>
      </div>
      <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
      <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
      <calcite-tabs>
        <div id="chartPanel">
            <calcite-tab-nav slot="tab-nav" id="thetabs">
                <calcite-tab-title class="Land" selected>Land</calcite-tab-title>
                <calcite-tab-title class="Structure">Structure</calcite-tab-title>
                <calcite-tab-title class="ISF">ISF</calcite-tab-title>
                <calcite-tab-title class="Trees">Tree</calcite-tab-title>
                <calcite-tab-title class="Utility">Utility</calcite-tab-title>
                <calcite-tab-title class="Tunnel">Tunnel</calcite-tab-title>
            </calcite-tab-nav>
            <calcite-tab>
              <div class="lotNumber-container">
                <div id="lotNumberDiv"></div>
                <img id="landNumberImage" src="https://EijiGorilla.github.io/Symbols/Land_logo.png">
              </div>
              <div class="box" id="landPieChartDiv"></div>
              <div class="pteLot-container">
                <div id="pteLotNumberDiv"></div>
                <img id="landImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaLotDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="structureNumber-container">
                <div id="structureNumberDiv"></div>
                <img id="structureNumberImage" src="https://EijiGorilla.github.io/Symbols/House_Logo.svg">
              </div>
              <div class="box2" id="structurePieChartDiv"></div>
              <div class="pteStructure-container">
                <div id="pteStructureNumberDiv"></div>
                <img id="structureImage" src="https://EijiGorilla.github.io/Symbols/Permit-To-Enter.png">
              </div>
              <div id="chartMoaStructureDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="nloNumber-container">
                <div id="nloNumberDiv"></div>
                <img id="nloNumberImage" src="https://EijiGorilla.github.io/Symbols/NLO_Logo.svg">
              </div>
              <div class="box3" id="nloPieChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="treeNumber-container">
                <div id="treeNumberDiv"></div>
                <img id="treeNumberImage" src="https://EijiGorilla.github.io/Symbols/Tree_Logo.svg">
              </div>
              <div class="box4" id="treeCuttingPieChartDiv"></div>
              <div class="box5" id="treeCompensationPieChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="utilityNumber-container">
                <div id="utilityNumberDiv"></div>
                <img id="utilityNumberImage" src="https://EijiGorilla.github.io/Symbols/Utility_Logo.png">
              </div>
              <div class="box6" id="utilityPointChartDiv">UTILITY POINT</div>
              <div class="box7" id="utilityLineChartDiv">UTILITY LINE</div>
            </calcite-tab>
            <calcite-tab>
              <div class="tbmShaftNumber-container">
                <div id="tbmShaftNumberDiv"></div>
                <img id="tbmShaftNumberImage" src="https://EijiGorilla.github.io/Symbols/Viaduct_Images/Viaduct_All_Logo.svg">
              </div>
              <div class="box8" id="tbmShaftChartDiv"></div>
            </calcite-tab>
            <calcite-tab>
              <div class="panel-side esri-widget">
                <ul id="expropriationListDiv">
                  <li>Loading&hellip;</li>
                </ul>
              </div>
            </calcite-tab>
      </calcite-tabs>
    </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/layers/SceneLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
      "esri/layers/TileLayer",
      "esri/core/reactiveUtils",
      "esri/popup/support/FieldInfoFormat",
      "esri/geometry/geometryEngine",
      "esri/rest/route",
      "esri/rest/support/RouteParameters",
      "esri/core/Accessor",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/geometry/Polyline",
      "esri/views/3d/externalRenderers",
      "esri/rest/support/FeatureSet",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol",
      "esri/geometry/SpatialReference",
      "esri/layers/BuildingSceneLayer",
      "esri/analysis/DirectLineMeasurementAnalysis",
      "esri/widgets/DirectLineMeasurement3D",
      "esri/analysis/AreaMeasurementAnalysis",
      "esri/widgets/AreaMeasurement3D",
      "esri/analysis/SliceAnalysis",
      "esri/widgets/Slice",
      "esri/analysis/LineOfSightAnalysis",
      "esri/widgets/LineOfSight",
      "esri/geometry/Polygon",
    ], function(WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent, TileLayer, reactiveUtils, 
                FieldInfoFormat, geometryEngine, route, RouteParameters, Accessor, Graphic,
                Point, Polyline, externalRenderers, FeatureSet, SimpleMarkerSymbol, SimpleLineSymbol,
                SpatialReference, BuildingSceneLayer,
                DirectLineMeasurementAnalysis, DirectLineMeasurement3D, 
                AreaMeasurementAnalysis, AreaMeasurement3D, SliceAnalysis, Slice,
                LineOfSightAnalysis, LineOfSight, Polygon
                 ) {
      


    // Reference link
    // 2D to 3D
    //https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/

    // 3D Extrusion using point, line, and polygon
    // https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/3d-visualization-working-with-objects-paths-and-extrusion/?rmedium=redirect&rsource=blogs.esri.com/esri/arcgis/2016/01/25/3d-visualization-working-with-objects-paths-and-extrusion


    var map = new Map({
        basemap: "dark-gray-vector",//"dark-gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new SceneView({
        map: map,
        center: [120.57930, 15.18],
        zoom: 12,
        viewingMode: "local",
        container: "viewDiv",
        camera: {
          position: {
            x: 120.75200,
            y: 14.90,
            z: 2500
          },
          tilt: 65
        },
        environment: {
          background: {
            type: "color", // autocasts as new ColorBackground()
            color: [0, 0, 0, 1]
          },
          starsEnabled: false,
          
        }
    });

    view.ui.components = [];

    const basemaps = new BasemapGallery({
      view,
      container: "basemaps-container"
    });


    // TRAIN ANIMATION //
////// Train Animation using externalRenderers
// Route Layer for animatioin
      // The stops and route result will be stored in this layer
      var routeLyr = new GraphicsLayer();
  
      // Setup the route parameters
      var routeParams = new RouteParameters({
          stops: new FeatureSet(),
          outSpatialReference: { // autocasts as new SpatialReference()
              wkid: 3857
          }
      });
  
      // Define the symbology used to display the stops
      var stopSymbol = new SimpleMarkerSymbol({
          style: "cross",
          size: 0, // 15
          outline: { // autocasts as new SimpleLineSymbol()
              width: 0 // 4
          }
      });
  
      // Define the symbology used to display the route
      var routeSymbol = new SimpleLineSymbol({
          color: [0, 0, 255, 0], // [0, 0, 255, 0.5]
          width: 5
      });
  
      // Adds a graphic when the user clicks the map. If 2 or more points exist, route is solved.
      //on(view, "click", addStop);
      /*
      view.on("click", function() {
        addStop();

    });
    */

    function addStop(event) {

        // Add a point at the location of the map click
        //var stop = new Graphic({
        //    geometry: event.mapPoint,
        //    symbol: stopSymbol
        //});

        var stop1 = new Graphic({
            geometry: new Point({x: 13422812.716400001, y: 1710317.0639999993, z: 115.65110000000277, spatialReference: SpatialReference.WebMercator}),
            symbol: stopSymbol
        });
        routeLyr.add(stop1);

        var stop2 = new Graphic({
            geometry: new Point({x: 13422004.020599999, y: 1713789.0846000016, z: 105.54970000000321, spatialReference: SpatialReference.WebMercator }),
            symbol: stopSymbol
        });
        routeLyr.add(stop2);

        routeParams.stops.features.push(stop1);
        routeParams.stops.features.push(stop2);

        // Execute the route task if 2 or more stops are input
        //routeParams.stops.features.push(stop);
        if (routeParams.stops.features.length >= 2) {
            //routeTask.solve(routeParams).then(showRoute);
            showRoute();
        }
    }

    // Adds the solved route to the map as a graphic
    function showRoute(data) {
        
        //var routeResult = data.routeResults[0].route;

        var polyline = new Polyline(polylinePoints);
        polyline.spatialReference = SpatialReference.WebMercator;

        var routeResult = new Graphic({
            geometry: polyline,
            symbol: routeSymbol
        });
        routeResult.symbol = routeSymbol;

        routeLyr.add(routeResult);
      
      // the speed of the object becomes low with maximum segment of length
      var pl = geometryEngine.densify(routeResult.geometry, 0.5, "meters");
        // register the external renderer
        const myExternalRenderer = new skeletonRenderer(view, pl);
        externalRenderers.add(view, myExternalRenderer);

    }
    // Disable lighting based on the current camera position.
    // We want to display the lighting according to the current time of day.
    //view.environment.lighting.cameraTrackingEnabled = false;

    // Create our custom external renderer
   //////////////////////////////////////////////////////////////////////////////////////
    //https://github.nicogis.it/externalRendererSkeleton/
    var skeletonRenderer = Accessor.createSubclass({ // if '|| {}' is not added beside null,
    // you will receive the following error 'Cannot destructure property of xx of 'null' as it is null'
        view: null,
        //pl: null,
        renderer: null,     // three.js renderer
        camera: null,       // three.js camera
        scene: null,        // three.js scene
        vertexIdx: 0,
        ambient: null,      // three.js ambient light source
        sun: null,          // three.js sun light source
        mixer: null,
        mixer2: null,
        clock: null,
        clips: null,
        animate: null,
        light: null,
        iss: null, 
        iss2: null,                                                   // ISS model
        issScale: 3,                                     // scale for the iss model
        issScale2: 10,
        path: null,
      count: null,
      up: null,
      timeDelta: null,
      markerMaterial: null,    // material for the markers left by the ISS
      markerGeometry: null,    // geometry for the markers left by the ISS
      //issMaterial: new THREE.MeshLambertMaterial({ color: 0x2194ce, transparent: true, opacity: 0.1 }), 

        cameraPositionInitialized: false, // we focus the view on the ISS once we receive our first data point
        positionHistory: [],
      
        constructor: function (view, pl) {
          this.view = view;
            this.path = pl.paths[0]; //pl.paths[0];
        },
        /**
         * Setup function, called once by the ArcGIS JS API.
         */
        setup: function (context) {

            // initialize the three.js renderer
            /////////////////////////////////////////////////////////////////////////////////////
            this.renderer = new THREE.WebGLRenderer({
                context: context.gl,
                premultipliedAlpha: false
            });
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.setSize(context.camera.fullWidth, context.camera.fullHeight);
            this.renderer.setViewport(0, 0, view.width, view.height);

            // prevent three.js from clearing the buffers provided by the ArcGIS JS API.
            this.renderer.autoClearDepth = false;
            this.renderer.autoClearStencil = false;
            this.renderer.autoClearColor = false;

            // The ArcGIS JS API renders to custom offscreen buffers, and not to the default framebuffers.
            // We have to inject this bit of code into the three.js runtime in order for it to bind those
            // buffers instead of the default ones.
            var originalSetRenderTarget = this.renderer.setRenderTarget.bind(this.renderer);
            this.renderer.setRenderTarget = function (target) {
                originalSetRenderTarget(target);
                if (target == null) {
                    context.bindRenderTarget();
                }
            }

            // setup the three.js scene
            //////////////////////////////////////////////////////////////////////////////////////         
            this.scene = new THREE.Scene();

            // setup the camera
            this.camera = new THREE.PerspectiveCamera();

            // setup scene lighting
            this.ambient = new THREE.AmbientLight(0xffffff, 0.5);
            this.scene.add(this.ambient);
            this.sun = new THREE.DirectionalLight(0xffffff, 0.5);
            this.scene.add(this.sun);

          // setup markers
            this.markerGeometry = new THREE.SphereBufferGeometry(12*1000, 16, 16);
            this.markerMaterial = new THREE.MeshBasicMaterial({ color: 0xe03110, transparent: true, opacity: 0.5});

            this.clock = new THREE.Clock();

            var issMeshUrl = "https://EijiGorilla.github.io/WebApp/ArcGIS_API_for_JavaScript/Sample/Three_js/3d-model-gltf/assets/Locomotive_rev.glb"; 
            var loaderGLTF = new THREE.GLTFLoader(); // check this: https://qgenhate.hatenablog.com/ [object not an instance of THREE.Object3D]
            let example = new THREE.Object3D();

            loaderGLTF.load(issMeshUrl,
            function(gltf) {
                console.log("ISS mesh loaded.");
               
                example = gltf.scene;
                this.iss = example;

                // set the specified scale for the model
                this.iss.scale.set(this.issScale, this.issScale, this.issScale);
                
                // add the model
                this.scene.add(this.iss); // original: this.iss
                console.log("ISS mesh added.");

                // Mixer for animation
                this.mixer = new THREE.AnimationMixer(this.iss);
                this.mixer.clipAction(gltf.animations[0]).play();
            
            }.bind(this), undefined, function(error) {
                console.error("Error loading ISS mesh. ", error);
            });

            this.light = new THREE.DirectionalLight(0xffffff, 1);
            this.light.position.set(0, 1, 0);
            this.scene.add(this.light);
          
          // rotation 
              this.up = new THREE.Vector3(0, 0, 1); // used with lookAt: look at the next point at x-axis
              this.axis = new THREE.Vector3();
              this.n  = new THREE.Vector3( ); // normal,
              this.b  = new THREE.Vector3( ); // binormal
              this.M3 = new THREE.Matrix3( );
              this.M4 = new THREE.Matrix4( );
              this.pp = new THREE.Vector3( );
              this.quaternion = new THREE.Quaternion();

            // cleanup after ourselfs
            context.resetWebGLState();
        },
        render: function (context) {

            // update camera parameters
            ///////////////////////////////////////////////////////////////////////////////////
            var cam = context.camera;

            this.camera.position.set(cam.eye[0], cam.eye[1], cam.eye[2]);
            this.camera.up.set(cam.up[0], cam.up[1], cam.up[2]);
            this.camera.lookAt(new THREE.Vector3(cam.center[0], cam.center[1], cam.center[2]));

            // Projection matrix can be copied directly
            this.camera.projectionMatrix.fromArray(cam.projectionMatrix);
          
            if (this.iss) {
                     
                // Add this.mixer.update first; otherwise, the object will not be animated.s
                if (this.mixer) {
                    var scale = 0.0001; //this.gui.getTimeScale();
                    var delta = this.clock.getDelta();

                  this.mixer.update(delta);         
                }

                    if (this.path.length == (this.vertexIdx + 1))
                {
                    this.vertexIdx = 0;
                }
              
                var p = this.path[this.vertexIdx]; // vertexIdx = 0
              var p1 = this.path[this.vertexIdx + 1];
              
            
              // Define Z:
              // It is important that the same Z values are set for both current (pt) and next points (pt1)
              // Otherwise, the object will be tilted.
              const changeZ = 0;
              const offset = 0;
              const offsetZ = 0;

                var pt = new Point({
                    x: p[0] + offset, // longitude
                    y: p[1], // latitude
                    z: p[2] + offsetZ
                });

                pt.spatialReference = SpatialReference.WebMercator;

                //z = offsetZ; // view.basemapTerrain.getElevation(p);

                pos = [pt.x, pt.y, pt.z];

                this.vertexIdx++;

                if (this.path.length == (this.vertexIdx)) {
                    this.vertexIdx--;
                }
              
                var transform = new THREE.Matrix4();
                transform.fromArray(externalRenderers.renderCoordinateTransformAt(view, pos, SpatialReference.WebMercator, new Array(16)));

               this.iss.position.set(transform.elements[12], transform.elements[13], transform.elements[14]);
              
                this.count ++;
                if (this.count === 1) {
                  console.log(transform.elements[12], transform.elements[13], transform.elements[14]);
                }

                var p0;
                var p1;

                if ((this.path.length - 1) == (this.vertexIdx))
                {
                    p0 = this.path[--this.vertexIdx];
                    p1 = this.path[this.vertexIdx];
                }
                else
                {
                    p0 = this.path[this.vertexIdx];
                    p1 = this.path[++this.vertexIdx];
                }
                            
              var rotation = new THREE.Matrix4();
              
                var pt1 = new Point({
                    x: p1[0] + offset, // longitude
                    y: p1[1], // latitude
                    z: p1[2] + offsetZ
                });
              posR = [pt1.x, pt1.y, pt1.z];
              rotation.fromArray(externalRenderers.renderCoordinateTransformAt(view, posR, SpatialReference.WebMercator, new Array(16)));
              // https://answers.unity.com/questions/36255/lookat-to-only-rotate-on-y-axis-how.html
              // how to use '.up' with lookAt?
              //geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( Math.PI / 2 ) );
              this.iss.up = this.up;
              
              this.iss.lookAt(rotation.elements[12], rotation.elements[13], rotation.elements[14]);
            }


            // update lighting
            /////////////////////////////////////////////////////////////////////////////////////////////////////
            //view.environment.lighting.date = Date.now();

            var l = context.sunLight;
            this.sun.position.set(
              l.direction[0],
              l.direction[1],
              l.direction[2]
            );
            this.sun.intensity = l.diffuse.intensity;
            this.sun.color = new THREE.Color(l.diffuse.color[0], l.diffuse.color[1], l.diffuse.color[2]);

            this.ambient.intensity = l.ambient.intensity;
            this.ambient.color = new THREE.Color(l.ambient.color[0], l.ambient.color[1], l.ambient.color[2]);

            // draw the scene
            /////////////////////////////////////////////////////////////////////////////////////////////////////
            this.renderer.resetState();
            context.bindRenderTarget();
            this.renderer.render(this.scene, this.camera);
            externalRenderers.requestRender(view);

            // cleanup
            context.resetWebGLState();
        },
    })
    externalRenderers.add(view, skeletonRenderer);
    // End of externalRenderers

    /// Camera animation
    const camera = view.camera.clone();

    const pt1 = {x: 120.58066534, y: 15.18190446, z: 193.6964};
    const pt2 = {x: 120.57976213, y: 15.1870787, z: 128.02725};
    const pt3 = {x: 120.57975569, y: 15.19070198, z: 138.165};
    const pt4 = {x: 120.57831507, y: 15.19802226, z: 183.82172};
    const pt5 = {x: 120.57478353, y: 15.20799639, z: 145.15981};
    const pt6 = {x: 120.57369966, y: 15.21207364, z: 138.33217};

    const comp_pts = [pt1, pt2, pt3, pt4, pt5, pt6];
    const heading_pts = [331.62, 334.31, 336.19, 323.47, 311.74, 289.63];
    const tilt_pts = [72.29, 81.91, 78.58, 72.66, 72.48, 73.59];

    let abort = false;
    async function startAnimation(slideNo) {
        if (!view.interacting && !abort) {

            if (slideNo < comp_pts.length) {
                if (slideNo === 0) {
                    camera.heading = heading_pts[slideNo];
                    camera.tilt = tilt_pts[slideNo];
                } else {
                    camera.heading = heading_pts[slideNo];
                }
                camera.tilt = tilt_pts[slideNo];
                camera.position = comp_pts[slideNo];
        
                await view.goTo(camera, {animate: true, speedFactor: 0.265, easing: "linear"});
                //requestAnimationFrame(startAnimation);
                window.setTimeout(function() {
                    startAnimation(slideNo + 1);
                }, 0);
            }
        } else {
            abort = true;
        }
    }

    // Initialization

    async function initialization() {
      abort = false;

      tbmShaftLayer.visible = true;
      tbmShaftLayer.renderer = tbmShaftForAnimationRenderer;
      tbmShaftLayer.definitionExpression = "CP = 'CP104'";
      map.basemap = "satellite";
      lotLayer.visible = false;
      structureLayer.visible = false;
      nloLayer.visible = false;
      pierAccessLayer.visible = false;
      utilityPointLayer.visible = false;
      utilityPointLayer1.visible = false;
      utilityLineLayer.visible = false;
      utilityLineLayer1.visible = false;
      pnrLayer.visible = false;

      addStop();
      await startAnimation(0);
      /*
        window.setTimeout(function() {
            startAnimation(0);
        }, 1)
        */
    }
    // TRAIN ANIMATION END //



    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    const LOT_LABEL_CLASS = {
        symbol: {
            type: "text",  // autocasts as new TextSymbol()
            color: "black",
            /*
            font: {  // autocast as new Font()
                family: "Gill Sans",
                size: 8
            }
            */
        },
        labelPlacement: "always-horizontal",
        labelExpressionInfo: {
            expression: "$feature.CN"
        }
    };
      
    let lotDefaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };

    let lotDefaultRenderer = {
      type: "simple",
      symbol: lotDefaultSymbol
    };

    let lotLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: lotDefaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusNVS3 == 1, '1',$feature.StatusNVS3 == 2, '2', $feature.StatusNVS3 == 3, '3', \
                        $feature.StatusNVS3 == 4, '4', $feature.StatusNVS3 == 5, '5', \
                        $feature.StatusNVS3 == 6, '6', $feature.StatusNVS3 == 7, '7', $feature.StatusNVS3)",
        uniqueValueInfos: [
            {
              // All features with value of "North" will be blue
              value: "1",
              label: "Paid",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[1],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "2",
              label: "For Payment Processing",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[2],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "3",
              label: "For Legal Pass",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[3],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "4",
              label: "For Appraisal/Offer to Buy",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[4],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "5",
              label: "For Expro",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[5],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "6",
              label: "with WOP Fully Turned-over",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[6],
              }
            },
            {
              // All features with value of "North" will be blue
              value: "7",
              label: "ROWUA/TUA",
              symbol: {
                  type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                  color: colorLotReqs()[7],
              }
            }
        ]
    }
      
    function colorLotReqs(){
        return {
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,115,76],
            7: "#55FF00"
        }
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        title: "Land Acquisition",
        elevationInfo: {
          model: "on-the-ground"
        },
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotLayerRenderer,
        popupTemplate: {
            title: "<p>{Id}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                      {
                        fieldName: "Issue",
                        label: "Remarks"
                      },
                      {
                          fieldName: "OWNER",
                          label: "Land Owner"
                      },
                      {
                          fieldName: "Station1",
                          label: "Station"
                      },
                      {
                          fieldName: "StatusNVS3",
                          label: "<p>Status of Land Acquisition</p>"
                      }
                    ]
                }
            ]
        }
    });
    map.add(lotLayer);

    // Handed-Over Layer
    const handedOverRenderer = {
      type: "simple",
      field: "HandedOver",
      symbol: {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: "#FF00C5",
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.5
        }
      }
    }
    
    var handedOverLotLayer = new FeatureLayer({
      portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "HandedOver = 1",
        title: "Handed-Over Lots",
        renderer: handedOverRenderer,
        popupEnabled: false
    });
    map.add(handedOverLotLayer);
    handedOverLotLayer.visible = false;


    // Delete this layer later. temporary used to experiment time series chart
    var handedOverLotBackgroundLayer = new FeatureLayer({
        portalItem: {
          id: "032432d931624de9bf5ff03f1f9d7016",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "HandedOver IS NULL",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotDefaultRenderer,
        popupTemplate: {
          title: "<p>{Id}</p>",
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "Issue",
                    label: "Remarks"
                  },
                  {
                      fieldName: "OWNER",
                      label: "Land Owner"
                  },
                  {
                      fieldName: "Station1",
                      label: "Station"
                  },
                  {
                      fieldName: "StatusNVS3",
                      label: "<p>Status of Land Acquisition</p>"
                  }
                ]
            }
          ]
        }
    });
    handedOverLotBackgroundLayer.visible = false;
    map.add(handedOverLotBackgroundLayer);

    // Handed-Over subterranean lots
    var pteLotSubteLayer = new FeatureLayer({
      portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 1",
        title: "PTE Subterranean Lots",
        renderer: handedOverRenderer,
        popupEnabled: false
    });
    map.add(pteLotSubteLayer);
    pteLotSubteLayer.visible = false;

    var pteLotSubteBackgroundLayer = new FeatureLayer({
        portalItem: {
          id: "032432d931624de9bf5ff03f1f9d7016",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        layerId: 1,
        outFields: ["*"],
        definitionExpression: "Type = 'Subterranean'" + " AND " + "PTE = 0",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotDefaultRenderer,
        popupTemplate: {
          title: "<p>{Id}</p>",
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "Issue",
                    label: "Remarks"
                  },
                  {
                      fieldName: "OWNER",
                      label: "Land Owner"
                  },
                  {
                      fieldName: "Station1",
                      label: "Station"
                  },
                  {
                      fieldName: "StatusNVS3",
                      label: "<p>Status of Land Acquisition</p>"
                  }
                ]
            }
          ]
        }
    });
    pteLotSubteBackgroundLayer.visible = false;
    map.add(pteLotSubteBackgroundLayer);
    
      
    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
          zoom: 17
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      

      // Structure demolished
      let structureDemolishedRenderer = {
        type: "unique-value",
        field: "REMARKS",
        defaultSymbol: defaultLotSymbolBoundary,  // autocasts as new SimpleFillSymbol()
        uniqueValueInfos: [
          {
            // All features with value of "North" will be blue
            value: "Demolished",
            label: "Demolished",
            symbol: {
              type: "simple-fill",
              color: "#FFAA00",
              style: "solid", // "backward-diagonal"
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "Not Yet",
            label: "Occupied",
            symbol: {
              type: "simple-fill",
              color: "#99A5A2",
              style: "solid",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          }
        ]
      }

      var structureDemolishedLayer = new FeatureLayer({
        portalItem: {
          id: "ec9dac0c16af4797bb917a0babc735e9",
          portal: {
              url: "https://gis.railway-sector.com/portal"
          }
        },
        title: "Demolished Structure",
        outFields: ["*"],
        renderer: structureDemolishedRenderer,
        popupTemplate: {
          title: "Structure ID: <b>{STRUCTURE_TAG_NO_}</b>" ,
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "STATION",
                  label: "Station"
                },
                {
                  fieldName: "Status",
                  label: "<b>Status of Structure</b>"
                },
                {
                  fieldName: "LOT_OWNER",
                  label: "Lot Owner"
                }
              ]
            }
          ]
        }
      });
      map.add(structureDemolishedLayer);

      // ISF Layer----------------------------------
      const outlineColor = "gray";

      var verticalOffsetExisting = {
        screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
      };

      var verticalOffsetNLO = {
        screenLength: 0,
          maxWorldLength: 0,
          minWorldLength: 0
      };

      function getUniqueValueSymbolNLO(name, size) {
        return {
          type: "point-3d", // autocasts as new PointSymbol3D()
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              resource: {
                href: name
              },
              size: size,
              outline: {
                color: "white",
                size: 2
              }
            }
          ],

          verticalOffset: verticalOffsetNLO,

          callout: {
            type: "line", // autocasts as new LineCallout3D()
            color: [128,128,128,0.6],
            size: 0.4,
            border: {
              color: "grey"
            }
          }
        };
      }

      const symbolSize = 30;
      let isfRenderer = {
        type: "unique-value",
        field: "RELOCATION",
        uniqueValueInfos: [
            {
              value: 'RELOCATED',
              label: "Relocated",
              symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_Relocated.svg", symbolSize),
            },
            {
                value: 'FOR RELOCATION',
                label: "For Relocation",
                symbol: getUniqueValueSymbolNLO("https://EijiGorilla.github.io/Symbols/3D_Web_Style/ISF/ISF_LBP.svg", symbolSize),
            }
        ]
      };

      var isfLayer = new FeatureLayer ({
        portalItem: {
            id: "a2e32eb82db84b3a8006e1c1e2cd7874",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "ISF (Informal Settlers Families)",
        outFields: ["*"],
        returnGeometry: true,
        renderer: isfRenderer,
        labelsVisible: false
      });
      map.add(isfLayer);

      // Construction Boundary----------------------------------
      let ConstructionBoundaryFill = {
        type: "unique-value",
        valueExpression: "When($feature.MappingBoundary == 1, 'Boundary', $feature.MappingBoundary)",
        uniqueValueInfos: [
          {
            value: "Boundary",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0,0],
              outline: {
                width: 1.5,
                color: [255,255, 255],
                style: "short-dash"
              }
            }
          }
        ]
      };

      var constBoundary = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        outFields: ["*"],
        renderer: ConstructionBoundaryFill,
        elevationInfo: {
          model: "on-the-ground"
        },
        definitionExpression: "MappingBoundary = 1",
        title: "Construction Boundary",
        popupEnabled: false
      });
      map.add(constBoundary);

      // Alignment----------------------------------
      var alignmentLine = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 13,
        outFields: ["*"],
        title: "Alignment",
        elevationInfo: {
          model: "on-the-ground"
        },
        popupEnabled: false
      });
      map.add(alignmentLine);

      // Segment DPWH----------------------------------
      var dpwhSegmentLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        elevationInfo: {
          model: "on-the-ground"
        },
        title: "DPWH Segment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(dpwhSegmentLayer);

      // BSS Boundary----------------------------------
      /*
      var bssDepotLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        title: "BSS Boundary",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotLayer);
*/
      // Creek Diversion----------------------------------
      var creekDivLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 10,
        elevationInfo: {
          model: "on-the-ground"
        },
        title: "Creek Diversion",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(creekDivLayer);

      // Depot Building----------------------------------
      const buildingLayerRenderer = {
      type: "simple",
      symbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 15, // in meters
            material: {
              color: [255, 255, 255, 0.6]
            },
            edges: {
              type: "solid",
              color: "#999",
              size: 0.6
            }
          }
        ]
      }
    }

      var depotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 6,
        title: "Depot Building",
        renderer: buildingLayerRenderer,
        elevationInfo: {
          model: "relative-to-ground"
        },
        outFields: ["*"],
        //popupEnabled: false
      });
      map.add(depotBuildingLayer);

      // BSS Building----------------------------------
      var bssDepotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        title: "BSS Building",
        elevationInfo: {
          model: "relative-to-ground"
        },
        renderer: buildingLayerRenderer,
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotBuildingLayer);

      // East Valenzuela----------------------------------
      var evsLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 9,
        title: "East Valenzuela",
        elevationInfo: {
          model: "on-the-ground"
        },
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(evsLayer);

      // NNC Construction boundary (Senate)----------------------------------
      var senateBoundaryLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "NCC Property",
        elevationInfo: {
          model: "on-the-ground"
        },
        outFields: ["*"],
        popupEnabled: false
      });
      //senateBoundaryLayer.list = "hide";
      map.add(senateBoundaryLayer);

      // Station1 box----------------------------------
      let poSectionBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
          {
            value: "U-Shape Retaining Wall",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "Cut & Cover Box",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM Shaft",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "black"
              }
            }
          },
          {
            value: "Station Platform",
            symbol: {
              type: "simple-fill",
              color: [240, 204, 230],
              style: "backward-diagonal",
              outline: {
                width: 0.4,
                color: "black"
              }
            }
          },
          {
            value: "Station Box",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0, 0],
              outline: {
                width: 2,
                color: "red"
              }
            }
          },
          {
            value: "NATM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "grey"
              }
            }
          }
        ]
      };

      var poSectionBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 8,
        renderer: poSectionBoxRenderer,
        elevationInfo: {
          model: "on-the-ground"
        },
        title: "Alignment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(poSectionBoxLayer);





      // Get last edited date
      const month = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      function getEditedDateValue() {
        var tempDates = [];

        var query = lotLayer.createQuery();
        //query.fields = ["enddate"];
        query.where = "last_edited_date IS NOT NULL";
        return lotLayer.queryFeatures(query).then(function(response) {
          var stats = response.features;
          stats.forEach((result, index) => {
            var attributes = result.attributes;
            const dates = attributes.last_edited_date;
            tempDates.push(dates);
          });
          const lastDate = Math.max(...tempDates);
          const lastEdit = new Date(lastDate);
          const yyyy = lastEdit.getFullYear();
          const mm = month[lastEdit.getMonth()];
          const dd = lastEdit.getDate();
          const lastEditedDate = `As of ${mm} ${dd}, ${yyyy}`;
          document.getElementById("dateDiv").innerHTML = "As of July 15, 2023";
        });
      }
      getEditedDateValue();

      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;


    /// Popup for lot layer
    const lotStatusArray = [
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro",
        "With FOP Fully Turned-over",
        "ROWUA/TUA"
    ];

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked pierAccessLayer
            const lotNo = event.graphic.attributes.ID;
            const remarks = event.graphic.attributes.Remarks;
            const landOwner = event.graphic.attributes.OWNER;
            const station = event.graphic.attributes.Station1;
            const status = event.graphic.attributes.StatusNVS3;
            const cp = event.graphic.attributes.Package;

            // Convert numeric to date format
            return `<ul><li>Lot No: <b>${lotNo} %</b></li><br>
                    <li>Land Owner:           <b>${landOwner}</b></li><br>
                    <li>Status:         <b>${status}</b></li><br>
                    <li>Station:     <b>${station}</b></li><br>
                    <li>Remarks:               <b>${remarks}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{ID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


    // Structure Layer 
    // Polygon 3D extrution
    const height = 5;
    const edgeSize = 0.5;
    const opacity = 0.6;

    const paid = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [112, 173, 71, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const payp = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 112, 255, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const legalpass = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 255, 0, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const otb = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 170, 0, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const expro = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 0, 0, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const quitclaim = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 115, 76, opacity]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const structureRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: [0, 0, 0, opacity]
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: edgeSize
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "Status",
      legendOptions: {
        title: "Status of Structure"
      },
      uniqueValueInfos: [
        {
          value: 1,
          symbol: paid,
          label: "Paid"
        },
        {
          value: 2,
          symbol: payp,
          label: "For Payment Processing"
        },
        {
          value: 3,
          symbol: legalpass,
          label: "For Legal Pass"
        },
        {
          value: 4,
          symbol: otb,
          label: "For Appraisal/Offer to Buy"
        },
        {
          value: 5,
          symbol: expro,
          label: "For Expro"
        },
        {
          value: 6,
          symbol: quitclaim,
          label: "Quit Claim"
        },
      ]
    }

    var structureLayer = new FeatureLayer({
      portalItem: {
        id: "ec9dac0c16af4797bb917a0babc735e9",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      title: "Affected Structure",
      renderer: structureRenderer,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      },
      popupTemplate: {
        title: "Structure ID: <p>{STRUCTURE_TAG_NO_}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "REMARKS",
                label: "Demolition"
              },
              {
                fieldName: "Status",
                label: "<b>Status of Structure</b>"
              },
              {
                fieldName: "LOT_OWNER",
                label: "Lot Owner"
              }
            ]
          }
        ]
      }
    });
    map.add(structureLayer);


    
  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  // Station Layer
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: "#d4ff33"
          },
          size: 15,
          color: "black",
          haloColor: "black",
          haloSize: 0.5,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 100,
        maxWorldLength: 300,
        minWorldLength: 80
      },

      callout: {
        type: "line", // autocasts as new LineCallout3D()
        color: [128,128,128,0.5],
        size: 0.2,
        border: {
          color: "grey"
        }
      }
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
              //value: "{TEXTSTRING}"
    }
  });

  var stationLayer = new SceneLayer({
    portalItem: {
      id: "26d8f953c71d440bad2daccb8f8c41a6",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    title: "MMSP Stations",
    labelingInfo: [labelClass],
    //renderer: stationsRenderer,
    elevationInfo: {
      mode: "relative-to-ground"
    },
                //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);


  // Tree Cutting Layer
  const cutStatus = {
    tcpapp: "For TCP Application",
    denr: "Submitted to DENR",
    permitc: "With Permit-Not Yet Cut",
    permite: "With Permit-Not Yet Earthballed",
    cut: "Cut",
    earthb: "Earthballed",
    expro: "TCP Expired"
  }

    const cutColor = {
      tcpapp_hex: "#71AB48",
      tcpapp_rgb: [113, 171, 72],

      denr_hex: "#5E4FA2",
      denr_rgb: [94, 79, 162],

      permitc_hex: "#FFFF00",
      permitc_rgb: [255, 255, 0],

      permite_hex: "#FFAA00",
      permite_rgb: [255, 170, 0],

      cut_hex: "#0073FF",
      cut_rgb: [0, 115, 255],

      earthb_hex: "#3288BD",
      earthb_rgb: [50, 136, 189],

      exp_hex: "#FF0000",
      exp_rgb: [255, 0, 0]
    }

    function treeCutting3DSymbol(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriThematicTreesStyle"
      };
    }

    const treeCuttingRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.TCP_Proces == 1, 'tcpapp', $feature.TCP_Proces == 2, 'denr', \
                        $feature.TCP_Proces == 3, 'permitcut', $feature.TCP_Proces == 4, 'permitearthb', \
                        $feature.TCP_Proces == 5, 'cut', $feature.TCP_Proces == 6, 'earthb', \
                        $feature.TCP_Proces == 7, 'tcpexp', 'other')",
        uniqueValueInfos: [
          {
              value: "tcpapp",
              label: "For TCP Application",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")

          },
          {
              value: "denr",
              label: "Submitted to DENR",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
          {
              value: "permitcut",
              label: "With Permit-Not Yet Cut",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
          {
              value: "permitearthb",
              label: "With Permit-Not Yet Earthballed",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
          {
              value: "cut",
              label: "Cut",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
          {
              value: "earthb",
              label: "Earthballed",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
          {
              value: "tcpexp",
              label: "TCP Expired",
              type: "simple",
              symbol: treeCutting3DSymbol("Larix")
          },
        ],
        visualVariables: [
          {
            type: "size",
            axis: "height",
            valueExpression: "When($feature.TCP_Proces >= 1, 7, 0)",
            valueUnit: "meters"
          },
          {
            type: "color",
            valueExpression: "$feature.TCP_Proces",
            valueExpressionTitle: "Status Color",
            stops: [
              { value:1, color: cutColor.tcpapp_hex},
              { value:2, color: cutColor.denr_hex},
              { value:3, color: cutColor.permitc_hex},
              { value:4, color: cutColor.permite_hex},
              { value:5, color: cutColor.cut_hex},
              { value:6, color: cutColor.earthb_hex},
              { value:7, color: cutColor.exp_hex},
            ],
            legendOptions: {
              showLegend: false
            }
          },
      ]
    };

    var treeCuttingLayer = new FeatureLayer ({
      portalItem: {
        id: "30cdb9f9775146308a05dd17cfbfa87a",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 1,
      outFields: ["*"],
      title: "Status of Tree Cutting",
      renderer: treeCuttingRenderer,
      elevationInfo: {
        mode: "relative-to-ground",
        //offset: 0
      },
      popupTemplate: {
        title: "<b>{TCP_Proces}</b>",
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "Scientific",
                  label: "Scientific Name"
                },
                {
                  fieldName: "Common_Nam",
                  label: "Common Name"
                },
                {
                  fieldName: "TreeStatus",
                  label: "Tree Status"
                },
                {
                  fieldName: "Recom",
                  label: "Recommendation"
                },
                {
                  fieldName: "City"
                },
                {
                  fieldName: "Id",
                  label: "Tree ID"
                },
                {
                  fieldName: "TCP_Proces",
                  label: "Tree Cutting"
                },
                {
                  fieldName: "Remarks2",
                  label: "Remarks"
                }
              ]
            }
          ]
        }
    });
    map.add(treeCuttingLayer,2);

    // Tree Compensation
    const compenStatus = {
      appraisal: "For Appraisal",
      serving: "For Serving of RfD/OtC",
      served: "Served RfD/OtC",
      legalp: "For Legal Pass",
      payp: "For Payment Processing/Obligation/Signing of ACRCT",
      check: "For Check Issuance",
      paid: "Paid",
      nocompen: "No Compensation",
      donation: "For Donation",
      expro: "Expro",
      row: "Right of Way Usage Agreement (ROWUA)"
    }

    const compenColor = {
      appraisal_hex: "#FFFF00",
      appraisal_rgb: [255, 255, 0],

      serving_hex: "#FF5500",
      serving_rgb: [255, 85, 0],

      served_hex: "#FF73DF",
      served_rgb: [255, 115, 223],

      legalp_hex: "#00A884",
      legalp_rgb: [0, 168, 132],

      payp_hex: "#FFAA00",
      payp_rgb: [255, 170, 0],

      check_hex: "#3288BD",
      check_rgb: [50, 136, 189],

      paid_hex: "#71AB48",
      paid_rgb: [113, 171, 72],

      nocompen_hex: "#0073FF",
      nocompen_rgb: [0, 115, 255],

      donation_hex: "#5E4FA2",
      donation_rgb: [94, 79, 162],

      expro_hex: "#FF0000",
      expro_rgb: [255, 0, 0],

      row_hex: "#E1E1E1",
      row_rgb: [225, 225, 225]
    }

    const treeCompensationRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.Tree_Compe == 1, 'appraisal', $feature.Tree_Compe == 2, 'serving', \
                        $feature.Tree_Compe == 3, 'served', $feature.Tree_Compe == 4, 'legalp', \
                        $feature.Tree_Compe == 5, 'payp', $feature.Tree_Compe == 6, 'check', \
                        $feature.Tree_Compe == 7, 'paid', $feature.Tree_Compe == 8, 'nocompen', $feature.Tree_Compe == 9, 'donation', \
                        $feature.Tree_Compe == 10, 'expro', $feature.Tree_Compe == 11, 'row', $feature.Tree_Compe)",
        uniqueValueInfos: [
          {
            value: "appraisal",
            label: compenStatus.appraisal,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")

          },
          {
            value: "serving",
            label: compenStatus.serving,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "served",
            label: compenStatus.served,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "legalp",
            label: compenStatus.legalp,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "payp",
            label: compenStatus.payp,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "check",
            label: compenStatus.check,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "paid",
            label: compenStatus.paid,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "nocompen",
            label: compenStatus.nocompen,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "donation",
            label: compenStatus.donation,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "expro",
            label: compenStatus.expro,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
          {
            value: "row",
            label: compenStatus.row,
            type: "simple",
            symbol: treeCutting3DSymbol("Larix")
          },
        ],
        visualVariables: [
        {
          type: "size",
          axis: "height",
          valueExpression: "When($feature.Tree_Compe >= 1, 11, 0)",
          valueUnit: "meters"
        },
        {
          type: "color",
          valueExpression: "$feature.Tree_Compe",
          valueExpressionTitle: "Status Color",
          stops: [
            { value:1, color: compenColor.appraisal_hex},
            { value:2, color: compenColor.serving_hex},
            { value:3, color: compenColor.served_hex},
            { value:4, color: compenColor.legalp_hex},
            { value:5, color: compenColor.payp_hex},
            { value:6, color: compenColor.check_hex},
            { value:7, color: compenColor.paid_hex},
            { value:8, color: compenColor.nocompen_hex},
            { value:9, color: compenColor.donation_hex},
            { value:10, color: compenColor.expro_hex},
            { value:11, color: compenColor.row_hex},
          ],
          legendOptions: {
            showLegend: false
          }
        },
      ]
    };

    var treeCompensationLayer = new FeatureLayer ({
      portalItem: {
        id: "30cdb9f9775146308a05dd17cfbfa87a",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      outFields: ["*"],
      layerId: 1,
      elevationInfo: {
          mode: "relative-to-ground",
          //offset: 0
        },
      title: "Status of Tree Compensation",
      renderer: treeCompensationRenderer,
      popupTemplate: {
        title: "<h5>{Tree_Compe}</h5>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Scientific",
                label: "Scientific Name"
              },
              {
                fieldName: "Common_Nam",
                label: "Common Name"
              },
              {
                fieldName: "TreeStatus",
                label: "Tree Status"
              },
              {
                fieldName: "Recom",
                label: "Recommendation"
              },
              {
                fieldName: "City"
              },
              {
                fieldName: "Id",
                label: "Tree ID"
              },
              {
                fieldName: "Remarks2",
                label: "Remarks"
              }
            ]
          }
        ]
      }
    });
    map.add(treeCompensationLayer,1);


    // UTILITY RELOCATIOIN

  // Esri Icon Symbol
  function IconSymbol(name) {
      return {
        type: "web-style", // autocasts as new WebStyleSymbol()
        name: name,
        styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
      };
    }

    function stationsSymbol(name) {
      return {
        type: "web-style", // autocasts as new WebStyleSymbol()
        name: name,
        styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
      };
    }

  // Utility Point Symbol
  /// https://developers.arcgis.com/javascript/latest/guide/esri-web-style-symbols-3d/
    function utilPtSymbolInfra(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriInfrastructureStyle"
      };
    }

    function utilPtSymbolStreet(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriRealisticStreetSceneStyle"
      };
    }

    function utilPtSymbolSignal(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriRealisticSignsandSignalsStyle"
      };
    }

    function utilPtSymbolIcons(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriIconsStyle"
      };
    }

    function utilPtSymbolSafety(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriRealisticSignsandSignalsStyle"
      }
    }

    function utilPtSymbolOthers(name) {
      return {
        type: "web-style",
        name: name,
        styleName: "EsriThematicTreesStyle"
      }
    }


    /* custom 3D Web Style for Utility Pole */
    // Choice: 3D_Electric_Pole, 3D_Drain_Box, 3D_Water_Valve, 3D_Telecom_BTS, 3D_TelecomCATV_Pole
    function customSymbol3D(name) {
      return {
        type: "web-style",
        styleUrl: "https://www.maps.arcgis.com/sharing/rest/content/items/c04d4d4145f64f8fa38407dd5331dd1f/data", //https://www.maps.arcgis.com/sharing/rest/content/items/7cc86329dd2e46229c52d292e660957b/data
        name: name
      };
    }

    /* Company and Utilty Relocation Status Symbols with Callout */
    var verticalOffsetExisting = {
      screenLength: 10,
      maxWorldLength: 10,
      minWorldLength: 15
    };

    var verticalOffsetRelocation = {
      screenLength: 10,
      maxWorldLength: 30,
      minWorldLength: 35
    };


      // Function that automatically creates the symbol for the points of interest
      function getUniqueValueSymbol(name, color, sizeS, util) {
      // The point symbol is visualized with an icon symbol. To clearly see the location of the point
      // we displace the icon vertically and add a callout line. The line connects the offseted symbol with the location
      // of the point feature.
      if (util == "Existing") {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetExisting,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: "grey",
          size: 0.4,
          border: {
            color: "grey"
          }
        }
      };
      } else {
        return {
        type: "point-3d", // autocasts as new PointSymbol3D()
        symbolLayers: [
          {
            type: "icon", // autocasts as new IconSymbol3DLayer()
            resource: {
              href: name
            },
            size: sizeS,
            outline: {
              color: "white",
              size: 2
            }
          }
        ],

        verticalOffset: verticalOffsetRelocation,

        callout: {
          type: "line", // autocasts as new LineCallout3D()
          color: [128,128,128,0.1], //"grey",
          size: 0.1,
          border: {
            color: "grey"
          }
        }
      };
      }
    }

  /* 3D Web Style */
  var utilTypePtRenderer = {
      type: "unique-value", //"unique-value", "simple"
      Field: "UtilType2",
      //valueExpression: "When($feature.UtilType == 1, 'Telecom', $feature.UtilType == 2, 'Water',$feature.UtilType == 3, 'Power', $feature.UtilType)",
      valueExpression: "When($feature.UtilType2 == 1, 'Telecom Pole (BTS)', \
                            $feature.UtilType2 == 2, 'Telecom Pole (CATV)', \
                            $feature.UtilType2 == 3, 'Telecom Pole', \
                            $feature.UtilType2 == 4, 'Sluice Gate', \
                            $feature.UtilType2 == 5, 'Air Valve', \
                            $feature.UtilType2 == 6, 'District Meter', \
                            $feature.UtilType2 == 7, 'Water Meter', \
                            $feature.UtilType2 == 8, 'Gate Valve', \
                            $feature.UtilType2 == 9, 'Valve', \
                            $feature.UtilType2 == 10, 'STC', \
                            $feature.UtilType2 == 11, 'Drain Box', \
                            $feature.UtilType2 == 12, 'Manhole', \
                            $feature.UtilType2 == 13, 'Electric Pole', \
                            $feature.UtilType2 == 14, 'Street Light', \
                            $feature.UtilType2 == 15, 'Traffic Light', \
                            $feature.UtilType2 == 16, 'Road Safety Signs', \
                            $feature.UtilType2 == 17, 'Junction Box', \
                            $feature.UtilType2 == 18, 'Pedestal', \
                            $feature.UtilType2 == 19, 'Transvault', \
                            $feature.UtilType2 == 20, 'Fire Hydrant', \
                            $feature.UtilType2 == 21, 'Handhole', $feature.UtilType)",
      uniqueValueInfos: [
        {
          value: "Telecom Pole (BTS)",
          symbol: customSymbol3D("3D_Telecom_BTS")
        },
        {
          value: "Telecom Pole (CATV)",
          symbol: customSymbol3D("3D_TelecomCATV_Pole")
        },
        {
          value: "Telecom Pole",
          symbol: customSymbol3D("3D_TelecomCATV_Pole")
        },
        {
          value: "Sluice Gate", // update later
          symbol: utilPtSymbolStreet("Jersey_Barrier")
        },
        {
          value: "Air Valve", // update later
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "District Meter", // update later
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Water Meter", // update later
          symbol: customSymbol3D("3D_Water_Meter")
        },
        {
          value: "Gate Valve", // update later
          symbol: customSymbol3D("3D_Water_Valve")
        },
        {
          value: "Valve", // update later
          symbol: customSymbol3D("3D_Water_Valve")
        },
        {
          value: "STC", // update later
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Drain Box", // update later
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Manhole",
          symbol: utilPtSymbolStreet("Storm_Drain")
        },
        {
          value: "Electric Pole",
          //symbol: utilPtSymbolInfra("Powerline_Pole")
          symbol: customSymbol3D("3D_Electric_Pole")
        },
        {
          value: "Street Light",
          symbol: utilPtSymbolStreet("Overhanging_Street_and_Sidewalk_-_Light_on")
        },
        {
          value: "Traffic Light",
          symbol: utilPtSymbolSignal("Traffic_Light_4")
        },
        {
            value: "Road Safety Signs",
            symbol: utilPtSymbolSafety("Pedestrian_Crossing")
        },
        {
          value: "Junction Box",
          symbol: customSymbol3D("3D_Drain_Box")
        },
        {
          value: "Pedestal",
          symbol: utilPtSymbolOthers("Sansevieria")
        }
      
        
      ],
      visualVariables: [
        {
          type: "size",
          axis: "height",
          field: "SIZE",
          valueUnit: "meters"
        },
        {
          type: "rotation",
          field: "ROTATION"
        },
        /*
        {
          type: "opacity",
          //valueExpression: "($feature.Status * $feature.LAYER) / 2",
          // When utility point to be demolished is completed, the point SIZE becomes 0 else 1.
          valueExpression: "When($feature.Status == 1 && $feature.LAYER == 1, 0, 1)",
          field: "SIZE",
          stops: [
            {value: 0, opacity: 0.005}, //  want to delete
            {value: 1, opacity: 1}, // want to visualize
          ],
          legendOptions: {
            showLegend: false
          }
        }
  */
      ]
    };

  /* Company and Utilty Relocation Status Symbols with Callout */
  /// Symbol for Utility Existing feature layer
  var utilExistSymbolRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      field: "Company",
      uniqueValueInfos: [
        {
          value: "Meralco",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Meralco_Gray.png",
            "#D13470",
            10,
            "Existing"
          )
        },
        {
          value: "Globe",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/GlobeGray.png",
            "#D13470",
            10,
            "Existing"
            )
        }
      ],
      visualVariables: [         
        {
          type: "opacity",
          valueExpression: "($feature.Status * $feature.LAYER) / 2",
          //field: "SIZE",
          stops: [
            {value: 0, opacity: 0.5},
            {value: 20, opacity: 0.5},
          ],
          legendOptions: {
            showLegend: false
          }
        }
        
      ]
    };

  /// Symbol for Utility Relocated feature layer
  var utilReloSymbolRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      // Note that 'Retained' status is always 'Complete'
      valueExpression: "When($feature.Checks == 1, 'NeedCheck',\
                            $feature.Status == 1 && $feature.LAYER == 1, 'DemolishComplete',\
                            $feature.Status == 0 && $feature.LAYER == 1, 'DemolishIncomplete',\
                            $feature.Status == 0 && $feature.LAYER == 2, 'RelocIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 2, 'RelocComplete', \
                            $feature.Status == 0 && $feature.LAYER == 3, 'NewlyAdded', \
                            $feature.Status == 1 && $feature.LAYER == 3, 'NewlyAddedComplete', \
                            $feature.Status == 1 && $feature.LAYER == 4, 'Retained', \
                            $feature.Status == 0 && $feature.LAYER == 5, 'Replaced', \
                            $feature.Status == 1 && $feature.LAYER == 5, 'ReplaceComplete', \
                            $feature.Status == 0 && $feature.LAYER == 6, 'TemporaryDivertIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 6, 'TemporaryDivertComplete', \
                            $feature.Status == 0 && $feature.LAYER == 7, 'ReturnedIncomplete', \
                            $feature.Status == 1 && $feature.LAYER == 7, 'ReturnedComplete', \
                            $feature.Comp_Agency)",
      //field: "Company",
      uniqueValueInfos: [
      {
          value: "NeedCheck",
          label: "Need to Check",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
            "#D13470",
            20,
            "Relocation"
          )
        },
        {
          value: "DemolishIncomplete",
          label: "To be Demolished",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Demolished.png",
            "#D13470",
            20,
            "Relocation"
          )
        },
        {
          value: "DemolishComplete",
          label: "Demolision Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/DemolishComplete_v2.png",
            "#D13470",
            25,
            "Relocation"
            )
        },
        {
          value: "RelocIncomplete",
          label: "Proposed Relocation",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Relocatd.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "RelocComplete",
          label: "Relocation Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Utility_Relocated_Completed_Symbol.png",
            "#D13470",
            30,
            "Relocation"
            )
        },
        {
          value: "NewlyAdded",
          label: "Add New Utility",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "NewlyAddedComplete",
          label: "Newly Utility Added",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/NewlyAdded_Completed.png",
            "#D13470",
            35,
            "Relocation"
            )
        },
        {
          value: "Replaced",
          label: "To be Replaced",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/UL_Replace_icomplete_symbol.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "ReplaceComplete",
          label: "Replacement Complete",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/UL_Replace_complete.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "Retained",
          label: "Retained",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/UL_Retained.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "TemporaryDivertIncomplete",
          label: "To be Temporary Diverted",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Temp_Diversion_Incomplete_Logo.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "TemporaryDivertComplete",
          label: "Temporary Diversion Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Temp_Diversion_Complete_Logo.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "ReturnedIncomplete",
          label: "To be Returned",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Returned_Incomplete_Logo.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "ReturnedComplete",
          label: "Returned Completed",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Returned_Complete_Logo.png",
            "#D13470",
            30,
            "Relocation"
          )
        },
        {
          value: "NoAction",
          label: "Require Data Checking",
          symbol: getUniqueValueSymbol(
            "https://EijiGorilla.github.io/Symbols/Unknown_v2.png",
            "#D13470",
            30,
            "Relocation"
            )
        }
      ]
    };


  // Existing Points

  // Utility Line
  /* UniqueValueRenderer for line3D: color, width, and line type*/
  const options = { // Circle
    profile: "circle",
    cap: "none",
    join: "miter",
    width: 0.5,
    height: 0.5,
    //color: [200, 200, 200],
    profileRotation: "all"
  };

  const options1 = { // rectangular
    profile: "quad",
    cap: "none",
    join: "miter",
    width: 0.5,
    height: 0.5,
    color: [200, 200, 200],
    profileRotation: "heading"
  };

  /* The colors used for the each transit line */

  const colorsRelocation = {
    1: [32,178,170, 0.5], //Telecom Line
    2: [112,128,144, 0.5], // Internet Cable TV Line
    3: [230, 0, 169, 0.5], // Duct Bank
    4: [0, 128, 255, 0.5], // Water Distribution Pipe
    5: [0, 197, 255, 0.5], // Main Line
    6: [0, 197, 254, 0.5], // Sub-Main Line
    7: [205,133,63, 0.5], // Canal
    8: [224, 224, 224, 0.5], // Sewer Pipeline
    9: [224, 224, 223, 0.5], // Sewer Drainage
    10: [139,69,19, 0.5], // Creek
    11: [211,211,211, 0.5], // Elecric Line
    12: [105,105,105, 0.5], // Storm Drainage
    13: [105,105,104, 0.5], // Drainage
    14: [197,0,255,0.5] // Gas line
  };

  const colorsExisting = {
    1: [229, 229, 229, 0.1], //Telecom/CA (Utility TYpe)
    2: [229, 229, 229, 0.1], // Water
    3: [229, 229, 229, 0.1], // Power
  }; 


  var utilityPointLayer = new FeatureLayer({
    portalItem: {
      id: "ff7177760e1c43478c1ad6088c48cfa8",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 4,
    title: "Relocation Plan (Point)",
    outFields: ["*"],
    labelsVisible: false,
    renderer: utilTypePtRenderer,
    elevationInfo: {
      mode: "relative-to-ground",
      featureExpressionInfo: {
        expression: "$feature.Height"
      },
      unit: "meters"
      //offset: 0
    },
    popupTemplate: {
      title: "<h5>{Comp_Agency}</h5>",
      lastEditInfoEnabled: false,
      returnGeometry: true,
      actions: [
        {
          id: "find-relocated",
          title: "Go to Relocated"
        }
      ],
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Id"
            },
            {
              fieldName: "UtilType",
              Label: "Type"
            },
            {
              fieldName: "UtilType2",
              Label: "Type2"
            },
            {
              fieldName: "LAYER",
              label: "<h5>Action</h5>"
            },
            {
              fieldName: "Status",
              label: "<h5>Status</h5>"
            },
            {
              fieldName: "Station1"
            },
            {
              fieldName: "Remarks"
            }
          ]
        }
      ]
    }
  });
  utilityPointLayer.listMode = "hide";
  map.add(utilityPointLayer);
  utilityPointLayer.visible = true;

  /* Symbols with callout */
  // To locate a symbol with callout on the ground, 
  // If basemap elevation layer is on, use "relative-to-ground"
  // If basemap elevatio layer is off, use "absolute-height"
  var labelUtilPtSymbol = {
    type: "label-3d", // autocasts as new LabelSymbol3D()
    labelPlacement: "above-center",
    labelExpressionInfo: {
    //value: "{Company}",
      expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')" //$feature.Comp_Agency
    },
    symbolLayers: [
      {
      type: "text", // autocasts as new TextSymbol3DLayer()
      material: {
        color: "black"
      },
      halo: {
        color: [255, 255, 255, 0.7],
        size: 2
      },
      size: 9
      }
    ],
  };

  var utilityPointLayer1 = new FeatureLayer({
    portalItem: {
      id: "ff7177760e1c43478c1ad6088c48cfa8",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 4,
    title: "Utility Point - Status Symbol",
    elevationInfo: {
      mode: "relative-to-ground",
      featureExpressionInfo: {
        expression: "$feature.Height"
      },
      unit: "meters"
      //offset: 0
    },
    outFields: ["*"],
    renderer: utilReloSymbolRenderer,
    labelingInfo: [labelUtilPtSymbol],
    popupTemplate: {
      title: "<h5>{Comp_Agency}</h5>",
      lastEditInfoEnabled: false,
      returnGeometry: true,
      actions: [
        {
          id: "find-relocated",
          title: "Go to Relocated"
        }
      ],
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Id"
            },
            {
              fieldName: "UtilType",
              Label: "Type"
            },
            {
              fieldName: "UtilType2",
              Label: "Type2"
            },
            {
              fieldName: "LAYER",
              label: "<h5>Action</h5>"
            },
            {
              fieldName: "Status",
              label: "<h5>Status</h5>"
            },
            {
              fieldName: "Station1"
            },
            {
              fieldName: "Remarks"
            }
          ]
        }
      ]
    }
  });
  map.add(utilityPointLayer1);
  utilityPointLayer1.visible = true;


  // Utility Line
  var utilityLineLayer = new FeatureLayer({
    portalItem: {
      id: "ff7177760e1c43478c1ad6088c48cfa8",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 5,
    title: "Relocation Plan (Line)",
    elevationInfo: {
      mode: "relative-to-ground",
      featureExpressionInfo: {
        expression: "$feature.Height"
      },
      unit: "meters"
      //offset: 0
    },
    outFields: ["*"],
    popupTemplate: {
      title: "<h5>{Comp_Agency}</h5>",
      lastEditInfoEnabled: false,
      returnGeometry: true,
      actions: [
        {
          id: "find-relocated-line",
          title: "Go to Relocated"
        }
      ],
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Id"
            },
            {
              fieldName: "UtilType",
              Label: "Type"
            },
            {
              fieldName: "UtilType2",
              Label: "Type2"
            },
            {
              fieldName: "LAYER",
              label: "<h5>Action</h5>"
            },
            {
              fieldName: "Status",
              label: "<h5>Status</h5>"
            },
            {
              fieldName: "Station1"
            },
            {
              fieldName: "Remarks"
            }
          ]
        }
      ]
    }
  });
  utilityLineLayer.listMode = "hide";
  map.add(utilityLineLayer, 4);

  /* Utility Line rendnerer*/
  function lineSizeShapeSymbolLayers(profile, cap, join, width, height, profileRotation, property){
    return {
      type: "line-3d",
      symbolLayers: [
        {
          type: "path",
          profile: profile,
          material: {
            color: colorsRelocation[property]
          },
          width: width,
          height: height,
          join: join,
          cap: cap,
          anchor: "bottom",
          profileRotation: profileRotation
        }
      ]
    }
  }

  function renderutilityLineLayer() {
    const renderer = new UniqueValueRenderer({
      field: "UtilType2"
    });

    for (let property in colorsRelocation) { // For each utility type 2
      if (property == 1) { // If utility type2 === Telecom Line
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.2,0.2,"all", property)
      });

      } else if (property == 2) { // "Internet Cable Line"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.2,0.2,"all", property)
      });

      } else if (property == 3) { // "Duct Bank"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter",0.2,0.2,"all", property)
      });

      } else if (property == 4) { // "Water Distributin Pipe"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5, "all", property)
      });

      } else if (property == 5) { // "Main Line"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5, "all", property)
      });

      } else if (property == 6) { // "Sub-Main Line"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5, "all", property)
      });

      } else if (property == 7) { // "Canal"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("quad","none","miter", 2, 2,"all", property)
      });

      } else if (property == 8) { // "Sewer Pipeline"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
      });

      } else if (property == 9) { // "Sewer Drainage"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 1, 1,"all", property)
      });

      } else if (property == 10) { // "Creek"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5,"all", property)
      });

      } else if (property == 11) { // "Electric Line"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.2, 0.2,"all", property)
      });

      } else if (property == 12) { // "Storm Drainage"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5,"all", property)
      });
      
      } else if (property == 13) { // "Drainage"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5,"all", property)
      });

      } else if (property == 14) { // "Gas line"
        renderer.addUniqueValueInfo({
        value: property,
        symbol: lineSizeShapeSymbolLayers("circle","none","miter", 0.5, 0.5,"all", property)
      });

      } else {// end of 'property == '1'
        renderer.addUniqueValueInfo({
          value: property,
          symbol: lineSizeShapeSymbolLayers("quad","none","miter", 0.5, 0.5,"all", property)
        });
      }
    }
    utilityLineLayer.renderer = renderer;
  }
  renderutilityLineLayer();

  /*Line for Symbols */
  var utilityLineLayerLabelClass = {
    type: "label-3d", // autocasts as new LabelSymbol3D()
    labelPlacement: "above-center", // Polyline has not choice
    labelExpressionInfo: {
      expression: "When($feature.Status >= 0, DomainName($feature, 'Comp_Agency'), '')"
    },
    symbolLayers: [
      {
      type: "text", // autocasts as new TextSymbol3DLayer()
      material: {
        color: "black"
      },
      halo: {
        color: [255, 255, 255, 0.7],
        size: 2
      },
      size: 9
      }
    ],
  };

  var utilityLineLayer1 = new FeatureLayer({
    portalItem: {
      id: "ff7177760e1c43478c1ad6088c48cfa8",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 5,
    title: "Utility Line - Status Symbol",
    elevationInfo: {
      mode: "relative-to-ground",
      featureExpressionInfo: {
        expression: "$feature.Height"
      },
      unit: "meters"
      //offset: 0
    },
    outFields: ["*"],
    renderer: utilReloSymbolRenderer,
    labelingInfo: [utilityLineLayerLabelClass],
    popupTemplate: {
      title: "<h5>{Comp_Agency}</h5>",
      lastEditInfoEnabled: false,
      returnGeometry: true,
      actions: [
      {
        id: "find-relocated-line",
        title: "Go to Relocated"
      }
      ],
      content: [
        {
          type: "fields",
          fieldInfos: [
            {
              fieldName: "Id"
            },
            {
              fieldName: "UtilType",
              Label: "Type"
            },
            {
              fieldName: "UtilType2",
              Label: "Type2"
            },
            {
              fieldName: "LAYER",
              label: "<h5>Action</h5>"
            },
            {
              fieldName: "Status",
              label: "<h5>Status</h5>"
            },
            {
              fieldName: "Station1"
            },
            {
              fieldName: "Remarks"
            }
          ]
        }
      ]
    }
  });
  map.add(utilityLineLayer1);

  // TBM segmented line:-------------------
    // TBM Alignment:-------------------
    const tbmOptions = {
    profile: "circle",
    cap: "butt", // butt
    join: "miter",
    width: 5,
    height: 5,
    color: [200, 200, 200, 0.3],
    profileRotation: "all"
  };

  /* The colors used for the each transit line */
  const tbmColors = {
    1: [225, 225, 225, 0.1], // To be Constructed (white)
    2: [232, 54, 24, 1], // Excavated
    3: [0, 112, 255, 0.8], // Completed
  };

  let tbmStatusRenderer = {
    type: "unique-value",
    field: "status",
    uniqueValueInfos: [
      {
        value: 1,
        label: 'To be Constructed',
        symbol: {
          type: "line-3d",
          symbolLayers: [
            {
              type: "path",
              profile: tbmOptions.profile,
              material: {
                color: tbmColors[1]
              },
              width: tbmOptions.width,
              height: tbmOptions.height,
              join: tbmOptions.join,
              cap: tbmOptions.cap,
              anchor: "bottom",
              profileRotation: tbmOptions.profileRotation
            }
          ]
        }
      },
      {
        value: 2,
        label: 'Excavating (Cutter Head)',
        symbol: {
          type: "line-3d",
          symbolLayers: [
            {
              type: "path",
              profile: tbmOptions.profile,
              material: {
                color: tbmColors[2]
              },
              width: tbmOptions.width,
              height: tbmOptions.height,
              join: tbmOptions.join,
              cap: tbmOptions.cap,
              anchor: "bottom",
              profileRotation: tbmOptions.profileRotation
            }
          ]
        }
      },
      {
        value: 3,
        label: 'Segmented',
        symbol: {
          type: "line-3d",
          symbolLayers: [
            {
              type: "path",
              profile: tbmOptions.profile,
              material: {
                color: tbmColors[3]
              },
              width: tbmOptions.width,
              height: tbmOptions.height,
              join: tbmOptions.join,
              cap: tbmOptions.cap,
              anchor: "bottom",
              profileRotation: tbmOptions.profileRotation
            }
          ]
        }
      }
    ]
  }

  var tbmTunnelLayer = new FeatureLayer({
    portalItem: {
      id: "af9539f5e41e4bd8b694973972e3faf4",
      portal: {
    url: "https://gis.railway-sector.com/portal"
  }
    },
    elevationInfo: {
      mode: "absolute-height",//"on-the-ground", relative-to-ground, absolute-height
      offset: -2
    },
    hasZ: true,
    layerId: 2,
    renderer: tbmStatusRenderer,
    //labelingInfo: [tbmSpotLabel2],
     title: "TBM Segment",
     outFields: ["*"],
     popupTemplate: {
        title: "Ring No.: <b>{segmentno}</b> (<b>{line}</b>)",
        lastEditInfoEnabled: false,
        returnGeometry: true,
      }

    });
    map.add(tbmTunnelLayer);

    // Muck Pit
    const muckPitRenderer = {
      type: "simple",
      symbol: {
        type: "mesh-3d",  // autocasts as new MeshSymbol3D()
        symbolLayers: [
          {
          type: "fill",  // autocasts as new FillSymbol3DLayer()
          material: { color: [0, 112, 255, 0.5] },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1
          }
          }
        ]
      }
    };

    const muckPitLayer = new SceneLayer({
      portalItem: {
        id: "a55358f858994df69f3dea4246a37020",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      title: "Muck Pit",
      renderer: muckPitRenderer
    });
    map.add(muckPitLayer);
  

  // River Layer:-------------------
    const riverLayer = new FeatureLayer({
      portalItem: {
        id: "5ebdee597f3540d1baed240034532883",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        },
      },
      layerId: 1,
    elevationInfo: {
      mode: "on-the-ground",
      offset: 0
    },
    renderer: {
        type: "simple",
        symbol: {
            type: "polygon-3d",
            symbolLayers: [
                {
                    type: "water",
                    waveDirection: 260,
                    color: "#005B66", //#005B66, #25427c
                    waveStrength: "moderate",
                    waterbodySize: "medium"
                }
            ]
        }
    }
    });
    riverLayer.listMode = "hide";
    map.add(riverLayer, 0);
  
  // Station structure: reference only
  const colors3D = {
      1: [225, 225, 225, 0.1], // To be Constructed (white)
      2: [225, 225, 225, 0.1], // Under Construction
      3: [225, 225, 225, 0.1], // Delayed
      4: [225, 225, 225, 0.1], // Completed
    };
  
  var stationStructure = new SceneLayer({ //structureLayer
      portalItem: {
        id: "09f1e6d86cf34567bebcd22afcad8b4b",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      definitionExpression: "Type = 1",
      popupEnabled: false,
        elevationInfo: {
            mode: "absolute-height",
            offset: 0
        },
        title: "Station Structure",
        outFields: ["*"]
        // when filter using date, example below. use this format
        //definitionExpression: "EndDate = date'2020-6-3'"
    });
    //stationStructure.listMode = "hide";
    map.add(stationStructure, 1);
  
    function renderStructureLayer() {
      const renderer = new UniqueValueRenderer({
        field: "Status"
      });
  
      for (let property in colors3D) {
        if (colors3D.hasOwnProperty(property)) {
          renderer.addUniqueValueInfo({
            value: property,
            symbol: {
              type: "mesh-3d",
              symbolLayers: [
                {
                  type: "fill",
                  material: {
                    color: colors3D[property],
                    colorMixMode: "replace"
                  },
                  edges: {
                    type: "solid", // autocasts as new SolidEdges3D()
                    color: [225, 225, 225, 0.8]
                    }
                }
              ]
             }
          });
        }
      }
  
      stationStructure.renderer = renderer;
    }
  
    renderStructureLayer();

    // TBM Shaft
    var tbmShaftLayer = new SceneLayer({ //structureLayer
      portalItem: {
        id: "0bba3bc8c087412b89a3d72a47a1c6aa",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      popupEnabled: false,
        elevationInfo: {
            mode: "absolute-height",
            offset: 0
        },
        title: "TBM Shaft"
        // when filter using date, example below. use this format
        //definitionExpression: "EndDate = date'2020-6-3'"
    });
    map.add(tbmShaftLayer, 1);
  
    function renderTbmShaftLayer() {
      const renderer = new UniqueValueRenderer({
        field: "Status"
      });
  
      for (let property in colors3D) {
        if (colors3D.hasOwnProperty(property)) {
          renderer.addUniqueValueInfo({
            value: property,
            symbol: {
              type: "mesh-3d",
              symbolLayers: [
                {
                  type: "fill",
                  material: {
                    color: colors3D[property],
                    colorMixMode: "replace"
                  },
                  edges: {
                    type: "solid", // autocasts as new SolidEdges3D()
                    color: [225, 225, 225, 0.8], //225, 225, 225, 0.3
                    size: 1
                    }
                }
              ]
             }
          });
        }
      }
  
      tbmShaftLayer.renderer = renderer;
    }
  
    renderTbmShaftLayer();
  

////////////////////////////// CHART /////////////////////////////////////////////////

// TIME SERIES
// 1. Land Acquisition
var root5 = am5.Root.new("timeSeriesChartLandDiv");
        root5._logo.dispose();

        function timeSeriesChartLand(cpValue, landTypeValue, sectionValue) {
          root5.container.children.clear();

          var query = lotLayer.createQuery();
          const cpExpression = "Package = '" + cpValue + "'";
          const landtypeExpression = "Type = '" + landTypeValue + "'";
          const sectionExpression = "Station1 = '" + sectionValue + "'";
          const statusExpression = "HandOverDate IS NOT NULL";

          if (cpValue === 'None' && (landTypeValue === 'None' || landTypeValue === undefined) && sectionValue === 'None') {
            query.where = statusExpression;

          } else if (cpValue === undefined && landTypeValue === undefined && sectionValue === undefined) {
            query.where = statusExpression;

          } else if (cpValue === 'None' && (landTypeValue === 'None' || landTypeValue === undefined) && sectionValue !== 'None') {
            query.where = sectionExpression + " AND " + statusExpression;

          } else if (cpValue === 'None' && (landTypeValue !== 'None' || landTypeValue === undefined) && sectionValue === 'None') {
            query.where = landtypeExpression + " AND " + statusExpression;

          } else if (cpValue === 'None' && (landTypeValue !== 'None' || landTypeValue === undefined) && sectionValue !== 'None') {
            query.where = landtypeExpression + " AND " + sectionExpression + " AND " + statusExpression;

          } else if (cpValue !== 'None' && (landTypeValue === 'None' || landTypeValue === undefined) && sectionValue === 'None') {
            query.where = cpExpression + " AND " + statusExpression;

          } else if (cpValue !== 'None' && (landTypeValue === 'None' || landTypeValue === undefined) && sectionValue !== 'None') {
            query.where = cpExpression + " AND " + sectionExpression + " AND " + statusExpression;

          } else if (cpValue !== 'None' && (landTypeValue !== 'None' || landTypeValue === undefined) && sectionValue === 'None') {
            query.where = cpExpression + " AND " + landtypeExpression + " AND " + statusExpression;

          } else if (cpValue !== 'None' && (landTypeValue !== 'None' || landTypeValue === undefined) && sectionValue !== 'None') {
            query.where = cpExpression + " AND " + landtypeExpression + " AND " + sectionExpression + " AND " + statusExpression;
          
          } else {
            query.where = statusExpression;
          }

          var total_count_handedOVer = {
            onStatisticField: "HandOverDate",
            outStatisticFieldName: "total_count_handedOVer",
            statisticType: "count"
          }

          query.outStatistics = [total_count_handedOVer];
          query.outFields = ["HandOverDate"];
          query.orderByFields = ["HandOverDate"];
          query.groupByFieldsForStatistics = ["HandOverDate"];

          lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features;
            ////
            // collect all dates
            const data = stats.map((result, index) => {
              const attributes = result.attributes;
              const date = attributes.HandOverDate;
              const count = attributes.total_count_handedOVer;

              // compile in object array
              return Object.assign({}, {
                date,
                value: count
              });
            });

            console.log(data);
            // set themes
            root5.setThemes([
              am5themes_Animated.new(root5)
            ]);

          // Create chart
            // https://www.amcharts.com/docs/v5/charts/xy-chart/
            var chart = root5.container.children.push(am5xy.XYChart.new(root5, {
              panX: false,
              panY: false,
              wheelX: "panX",
              wheelY: "zoomX"
            }));

            // Chart title
            chart.children.unshift(am5.Label.new(root5, {
              text: "Monthly Progress of Handed-Over Lots",
              fontSize: 14,
              fontWeight: "bold",
              textAlign: "center",
              fill: am5.color("#ffffff"),
              x: am5.percent(50),
              centerX: am5.percent(50),
              paddingTop: 0,
              paddingBottom: 0,
            }));

            // Add cursor
            // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
            var cursor = chart.set("cursor", am5xy.XYCursor.new(root5, {
              behavior: "zoomX"
            }));
            cursor.lineY.set("visible", false);

            // Create axes
            // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
            var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root5, {
              maxDeviation: 0,
              groupData: true,
              baseInterval: {
                timeUnit: "day",
                count: 1
              },
              groupIntervals: [{timeUnit: "month", count: 1}],
              renderer: am5xy.AxisRendererX.new(root5, {
                minGridDistance: 60,
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: am5.color("#ffffff"),
              }),
              //tooltip: am5.Tooltip.new(root5, {})
            }));

            // Label properties for yAxis (category axis)
            xAxis.get("renderer").labels.template.setAll({
              //oversizedBehavior: "wrap",
              textAlign: "center",
              fill: am5.color("#ffffff"),
              //maxWidth: 150,
              fontSize: 12
            });

            var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root5, {
              calculateTotals: true,
              min: 0,
              renderer: am5xy.AxisRendererY.new(root5, {
                minGridDistance: 60,
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: am5.color("#ffffff"),
              })
            }));

            yAxis.get("renderer").labels.template.setAll({
              //oversizedBehavior: "wrap",
              textAlign: "center",
              fill: am5.color("#ffffff"),
              //maxWidth: 150,
              fontSize: 12
            });

            // Add yaxix title
            yAxis.children.unshift(
              am5.Label.new(root5, {
                rotation: -90,
                text: "No. of handed-over lots",
                y: am5.p50,
                centerX: am5.p50,
                fill: am5.color("#ffffff"),
                fontSize: 11
              })
            );

            // Add series
            // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
            var series = chart.series.push(am5xy.ColumnSeries.new(root5, {
              name: "Series",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              valueYGrouped: "sum"
            }));

            // Add Label bullet
            series.bullets.push(function () {
              return am5.Bullet.new(root5, {
                locationY: 1,
                locationX: 0.5,
                sprite: am5.Label.new(root5, {
                  text: "{valueYTotal}",
                  fill: root5.interfaceColors.get("alternativeText"),
                  centerY: 0,
                  centerX: am5.p50,
                  populateText: true,
                  fontSize: 10
                })
              });
            });

            series.columns.template.setAll({ strokeOpacity: 0 })

            // Add scrollbar
            /*
            // https://www.amcharts.com/docs/v5/charts/xy-chart/scrollbars/
            chart.set("scrollbarX", am5.Scrollbar.new(root5, {
              orientation: "horizontal",
              fillOpacity: 0.5
            }));
*/
            series.data.setAll(data);

            // Make stuff animate on load
            // https://www.amcharts.com/docs/v5/concepts/animations/
            series.appear(1000);
            chart.appear(1000, 100);
          }); 
        }
        timeSeriesChartLand();



// 2. TBM Tunnel
  var root2 = am5.Root.new("timeSeriesChartTbmTunnelDiv");
  root2._logo.dispose();
  
  function timeSeriesChartTbmTunnel() {
    root2.container.children.clear();

    var total_complete_segment = {
      onStatisticField: "CASE WHEN status = 3 THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_segment",
      statisticType: "sum"
    };

    var query = tbmTunnelLayer.createQuery();
    query.where = "enddate IS NOT NULL";
    query.outStatistics = [total_complete_segment];
    query.outFields = ["enddate"];
    query.orderByFields = ["enddate"];
    query.groupByFieldsForStatistics = ["enddate"];

    tbmTunnelLayer.queryFeatures(query).then(function(response) {
      var stats = response.features;

      // collect all dates for each viaduct type
      const data = stats.map((result, index) => {
        const attributes = result.attributes;
        const date = attributes.enddate;
        const value = attributes.total_complete_segment;
 
        // compile in object
        return Object.assign({}, {
          date: date,
          value: value,
        });
      });

      console.log(data);

      // 6. Add to Chart
      // set themes
      // set themes
      root2.setThemes([
        am5themes_Animated.new(root2)
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root2.container.children.push(am5xy.XYChart.new(root2, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX"
      }));

      // Chart title
      chart.children.unshift(am5.Label.new(root2, {
        text: "Monthly Progress of Segmentation",
        fontSize: 14,
        fontWeight: "bold",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        x: am5.percent(50),
        centerX: am5.percent(50),
        paddingTop: 0,
        paddingBottom: 0,
      }));

      // Add cursor
      // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
      var cursor = chart.set("cursor", am5xy.XYCursor.new(root2, {
        behavior: "zoomX"
      }));
      cursor.lineY.set("visible", false);

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root2, {
        maxDeviation: 0,
        groupData: true,
        baseInterval: {
          timeUnit: "day",
          count: 1
        },
        groupIntervals: [{timeUnit: "month", count: 1}],
        categoryField: "date",
        renderer: am5xy.AxisRendererX.new(root2, {
          //minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        }),
        tooltip: am5.Tooltip.new(root2, {})
      }));

      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root2, {
        renderer: am5xy.AxisRendererY.new(root2, {
          minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));

      yAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      // Add yaxix title
      yAxis.children.unshift(
        am5.Label.new(root2, {
          rotation: -90,
          text: "No. of Segmented Rings",
          y: am5.p50,
          centerX: am5.p50,
          fill: am5.color("#ffffff"),
          fontSize: 11
        })
      );

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      var series = chart.series.push(am5xy.ColumnSeries.new(root2, {
        name: "Series",
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        valueXField: "date",
        valueYGrouped: "sum",
        tooltip: am5.Tooltip.new(root2, {
          labelText: "{valueY}"
        })
      }));

      series.bullets.push(function() {
        return am5.Bullet.new(root2, {
          sprite: am5.Label.new(root2, {
            text: "{valueY}",
            fill: root2.interfaceColors.get("alternativeText"),
            centerY: am5.p50,
            centerX: am5.p50,
            populateText: true
          })
        });
      });

      series.columns.template.setAll({ strokeOpacity: 0 })

      // Add scrollbar
      /*
      // https://www.amcharts.com/docs/v5/charts/xy-chart/scrollbars/
      chart.set("scrollbarX", am5.Scrollbar.new(root2, {
        orientation: "horizontal",
        fillOpacity: 0.5
      }));
  */
      series.data.setAll(data);

      // Make stuff animate on load
      // https://www.amcharts.com/docs/v5/concepts/animations/
      series.appear(1000);
      chart.appear(1000, 100);
    }); 
  }
  timeSeriesChartTbmTunnel();





////////////////////////////// CHART /////////////////////////////////////////////////

    // Legend
    var legend_land = new Legend({
      view,
      container: "land-legend",
      layerInfos: [
        {
          layer: lotLayer,
          title: ""
        }
      ]
    });

    var legend_structure = new Legend({
      view,
      container: "structure-legend",
      layerInfos: [
        {
          layer: structureLayer,
          title: ""
        }
      ]
    });

    var legend_isf = new Legend({
      view,
      container: "isf-legend",
      layerInfos: [
        {
          layer: isfLayer,
          title: ""
        }
      ]
    });

    var legend_demolished_structure = new Legend({
      view,
      container: "demolished-structure-legend",
      layerInfos: [
        {
          layer: structureDemolishedLayer,
          title: ""
        }
      ]
    });

    var legend_depotBuilding = new Legend({
      view,
      container: "depotbuilding-legend",
      layerInfos: [
        {
          layer: depotBuildingLayer,
          title: ""
        }
      ]
    });

    var legend_bssDepotBuilding = new Legend({
      view,
      container: "bss-depotbuilding-legend",
      layerInfos: [
        {
          layer: bssDepotBuildingLayer,
          title: ""
        }
      ]
    });

    var legend_evs = new Legend({
      view,
      container: "evs-legend",
      layerInfos: [
        {
          layer: evsLayer,
          title: ""
        }
      ]
    });

    var legend_senateBoundary = new Legend({
      view,
      container: "senateboundary-legend",
      layerInfos: [
        {
          layer: senateBoundaryLayer,
          title: ""
        }
      ]
    });

    var legend_poSectionBox = new Legend({
      view,
      container: "posectionbox-legend",
      layerInfos: [
        {
          layer: poSectionBoxLayer,
          title: ""
        }
      ]
    });

    var legend_treeCut = new Legend({
      view,
      container: "treecutting-legend",
      layerInfos: [
        {
          layer: treeCuttingLayer,
          title: ""
        }
      ]
    });

    var legend_treeCompen = new Legend({
      view,
      container: "treecompensation-legend",
      layerInfos: [
        {
          layer: treeCompensationLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPoint = new Legend({
      view,
      container: "utilitypoint-legend",
      layerInfos: [
        {
          layer: utilityPointLayer,
          title: ""
        }
      ]
    });

    var legend_utilityPointStatus = new Legend({
      view,
      container: "utilitypointstatus-legend",
      layerInfos: [
        {
          layer: utilityPointLayer1,
          title: ""
        }
      ]
    });

    var legend_utilityLine = new Legend({
      view,
      container: "utilityline-legend",
      layerInfos: [
        {
          layer: utilityLineLayer,
          title: ""
        }
      ]
    });

    var legend_utilityLineStatus = new Legend({
      view,
      container: "utilitylinestatus-legend",
      layerInfos: [
        {
          layer: utilityLineLayer1,
          title: ""
        }
      ]
    });

    var legend_river = new Legend({
      view,
      container: "river-legend",
      layerInfos: [
        {
          layer: riverLayer,
          title: ""
        }
      ]
    });

    var legend_tbmTunnel = new Legend({
      view,
      container: "tbmtunnel-legend",
      layerInfos: [
        {
          layer: tbmTunnelLayer,
          title: ""
        }
      ]
    });

    var legend_muckPit = new Legend({
      view,
      container: "muckpit-legend",
      layerInfos: [
        {
          layer: muckPitLayer,
          title: ""
        }
      ]
    });

    var legend_tbmShaft = new Legend({
      view,
      container: "tbmshaft-legend",
      layerInfos: [
        {
          layer: tbmShaftLayer,
          title: ""
        }
      ]
    });

    var legend_stationstructure = new Legend({
      view,
      container: "stationstructure-legend",
      layerInfos: [
        {
          layer: stationStructure,
          title: ""
        }
      ]
    });

    // Default setting
    function defaultRenderer() {
      lotLayer.visible = true;
      structureLayer.visible = false;
      isfLayer.visible = false;
      depotBuildingLayer.visible = true;
      structureDemolishedLayer.visible = false;
      senateBoundaryLayer.visible = true;
      poSectionBoxLayer.visible = true;
      treeCuttingLayer.visible = false;
      treeCompensationLayer.visible = false;
      utilityPointLayer.visible = false;
      utilityPointLayer1.visible = false;
      utilityLineLayer.visible = false;
      utilityLineLayer1.visible = false;
      bssDepotBuildingLayer.visible = true;
      evsLayer.visible = true;
      riverLayer.visible = false;
      tbmTunnelLayer.visible = false;
      muckPitLayer.visible = false;
      tbmShaftLayer.visible = false;
      stationStructure.visible = false;

      zoomToLayer(lotLayer);
    }
    defaultRenderer();

    // Hide and Unhide of Legend + layerList + lotLayer
    // 1. Checkbox
    const landCheckbox = document.getElementById("land-check");
    const structureCheckbox = document.getElementById("structure-check");
    const isfCheckbox = document.getElementById("isf-check");
    const depotBuildingCheckbox = document.getElementById("depotbuilding-check");
    const demolished_structureCheckbox = document.getElementById("demolished-structure-check");
    const senateBoundaryCheckbox = document.getElementById("senateboundary-check");
    const poSectionBoxCheckbox = document.getElementById("posectionbox-check");
    const treeCuttingCheckbox = document.getElementById("treecutting-check");
    const treeCompensationCheckbox = document.getElementById("treecompensation-check");
    const utilityPointCheckbox = document.getElementById("utilitypoint-check");
    const utilityPointStatusCheckbox = document.getElementById("utilitypointstatus-check");
    const utilityLineCheckbox = document.getElementById("utilityline-check");
    const utilityLineStatusCheckbox = document.getElementById("utilitylinestatus-check");
    const bssDepotBuildingCheckbox = document.getElementById("bss-depotbuilding-check");
    const evsCheckbox = document.getElementById("evs-check");
    const riverCheckbox = document.getElementById("river-check");
    const tbmTunnelCheckbox = document.getElementById("tbmtunnel-check");
    const muckPitCheckbox = document.getElementById("muckpit-check");
    const tbmShaftCheckbox = document.getElementById("tbmshaft-check");
    const stationStructureCheckbox = document.getElementById("stationstructure-check");

    // 2. Legend
    const landLegend = document.getElementById("land-legend");
    const structureLegend = document.getElementById("structure-legend");
    const isfLegend = document.getElementById("isf-legend");
    const depotBuildingLegend = document.getElementById("depotbuilding-legend");
    const demolished_structureLegend = document.getElementById("demolished-structure-legend");
    const senateBoundaryLegend = document.getElementById("senateboundary-legend");
    const posectionboxLegend = document.getElementById("posectionbox-legend");
    const treeCuttingLegend = document.getElementById("treecutting-legend");
    const treeCompensationLegend = document.getElementById("treecompensation-legend");
    const utilityPointLegend = document.getElementById("utilitypoint-legend");
    const utilityPointStatusLegend = document.getElementById("utilitypointstatus-legend");
    const utilityLineLegend = document.getElementById("utilityline-legend");
    const utilityLineStatusLegend = document.getElementById("utilitylinestatus-legend");
    const bssDepotBuildingLegend = document.getElementById("bss-depotbuilding-legend");
    const evsLegend = document.getElementById("evs-legend");
    const riverLegend = document.getElementById("river-legend");
    const tbmTunnelLegend = document.getElementById("tbmtunnel-legend");
    const muckPitLegend = document.getElementById("muckpit-legend");
    const tbmShaftLegend = document.getElementById("tbmshaft-legend");
    const stationStructureLegend = document.getElementById("stationstructure-legend");

    // Lot Layer
    view.when(() => {
      
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        landLegend.hidden = !landLegend.hidden;
        
        // Visible/Unvisible Lot Layer
        if (activeWidget) {
          lotLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          lotLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      } 
      landCheckbox.addEventListener("click", checkBoxClick);
    });

    // Structure Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        structureLegend.hidden = !structureLegend.hidden;
        
        // Visible/unvisible structure layer
        if (activeWidget) {
          structureLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          structureLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      structureCheckbox.addEventListener("click", checkBoxClick);
    });

    // ISF Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        isfLegend.hidden = !isfLegend.hidden;
        
        // Visible/unvisible isf layer
        if (activeWidget) {
          isfLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          isfLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      isfCheckbox.addEventListener("click", checkBoxClick);
    });

    // Depot Building Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        depotBuildingLegend.hidden = !depotBuildingLegend.hidden;
        
        // Visible/unvisible depotBuilding layer
        if (activeWidget) {
          depotBuildingLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          depotBuildingLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      depotBuildingCheckbox.addEventListener("click", checkBoxClick);
    });

    // Demolished Structure Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        demolished_structureLegend.hidden = !demolished_structureLegend.hidden;
        
        // Visible/unvisible demolished_structure layer
        if (activeWidget) {
          structureDemolishedLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          structureDemolishedLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      demolished_structureCheckbox.addEventListener("click", checkBoxClick);
    });

    // Senate Boundary Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        senateBoundaryLegend.hidden = !senateBoundaryLegend.hidden;
        
        // Visible/unvisible senateBoundary layer
        if (activeWidget) {
          senateBoundaryLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          senateBoundaryLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      senateBoundaryCheckbox.addEventListener("click", checkBoxClick);
    });

    // PO Sectin Box Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        posectionboxLegend.hidden = !posectionboxLegend.hidden;
        
        // Visible/Unvisible Lot Layer
        if (activeWidget) {
          poSectionBoxLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          poSectionBoxLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      } 
      poSectionBoxCheckbox.addEventListener("click", checkBoxClick);
    });


    // Group checkbox for tree cutting and compensation layers //--------------------------------
    function treeCuttingRendererCheckBoxTrueFalse() {
      if (document.querySelector(`[id="treecutting-check"]`).checked) {
        treeCuttingLayer.visible = true;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;

      } else if (!document.querySelector(`[id="treecutting-check"]`).checked) {
        treeCuttingLayer.visible = false;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
      }
    }

    function treeCuttingRendererCheckBoxFalseFalse() {
      if (document.querySelector(`[id="treecutting-check"]`).checked) {
        treeCuttingLayer.visible = false;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;

      } else if (!document.querySelector(`[id="treecutting-check"]`).checked) {
        treeCuttingLayer.visible = false;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
      }
    }

    function treeCuttingGroupRendererCheckBox() {
      if (document.querySelector(`[id="treesall-check"]`).checked) {
        treeCuttingLayer.visible = true;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;

      } else if (!document.querySelector(`[id="treecutting-check"]`).checked) {
        treeCuttingLayer.visible = false;
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;

      }
    }

    function treeCompensationRendererCheckBoxTrueFalse() {
      if (document.querySelector(`[id="treecompensation-check"]`).checked) {
        treeCompensationLayer.visible = true;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;

      } else if (!document.querySelector(`[id="treecompensation-check"]`).checked) {
        treeCompensationLayer.visible = false;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
      }
    }

    function treeCompensationRendererCheckBoxFalseFalse() {
      if (document.querySelector(`[id="treecompensation-check"]`).checked) {
        treeCompensationLayer.visible = false;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;

      } else if (!document.querySelector(`[id="treecompensation-check"]`).checked) {
        treeCompensationLayer.visible = false;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
      }
    }

    function treeCompensationGroupRendererCheckBox() {
      if (document.querySelector(`[id="treesall-check"]`).checked) {
        treeCompensationLayer.visible = true;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;

      } else if (!document.querySelector(`[id="treecompensation-check"]`).checked) {
        treeCompensationLayer.visible = false;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
      }
    }

    const treesAllCheckbox = document.getElementById("treesall-check");
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {
        //treeCuttingRendererCheckBoxTrueFalse();

        // Hide/Unhide legend
        treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
        treeCompensationLegend.hidden = !treeCompensationLegend.hidden;

        // When checked box is turned off, 
        if (activeWidget) {
          treeCuttingRendererCheckBoxTrueFalse();
          treeCompensationRendererCheckBoxTrueFalse();
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCuttingRendererCheckBoxTrueFalse();
          treeCompensationRendererCheckBoxTrueFalse();
          activeWidget = nextWidget

        } else {
          activeWidget = null;
          treeCuttingRendererCheckBoxFalseFalse();
          treeCompensationRendererCheckBoxFalseFalse();
        }
      }
      treesAllCheckbox.addEventListener("click", checkBoxClick);
    });

    
    // Tree Cutting layer
      view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {
        // Hide/Unhide legend
        //treeCuttingLegend.hidden = !treeCuttingLegend.hidden;

        // Visible/unvisible treeCutting layer
        if (activeWidget) {
          treeCuttingLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCuttingGroupRendererCheckBox();
          activeWidget = nextWidget

        } else {
          activeWidget = null;
          treeCuttingLegend.hidden = !treeCuttingLegend.hidden;
        }
      }
      treeCuttingCheckbox.addEventListener("click", checkBoxClick);
    });



    // Tree Compensation Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        //treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
        
        // Visible/unvisible treeCompensation layer
        if (activeWidget) {
          treeCompensationLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          treeCompensationGroupRendererCheckBox();
          activeWidget = nextWidget

        } else {
          activeWidget = null;
          treeCompensationLegend.hidden = !treeCompensationLegend.hidden;
        }
      }
      treeCompensationCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointLegend.hidden = !utilityPointLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Point Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityPointStatusLegend.hidden = !utilityPointStatusLegend.hidden;
        
        // Visible/unvisible utilityPoint layer
        if (activeWidget) {
          utilityPointLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityPointLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityPointStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineLegend.hidden = !utilityLineLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineCheckbox.addEventListener("click", checkBoxClick);
    });

    // Utility Line Status Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        utilityLineStatusLegend.hidden = !utilityLineStatusLegend.hidden;
        
        // Visible/unvisible utilityLine layer
        if (activeWidget) {
          utilityLineLayer1.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          utilityLineLayer1.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      utilityLineStatusCheckbox.addEventListener("click", checkBoxClick);
    });

    // BSS Depot building Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        bssDepotBuildingLegend.hidden = !bssDepotBuildingLegend.hidden;
        
        // Visible/unvisible bssDepotBuilding layer
        if (activeWidget) {
          bssDepotBuildingLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          bssDepotBuildingLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      bssDepotBuildingCheckbox.addEventListener("click", checkBoxClick);
    });


    // EVS Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        evsLegend.hidden = !evsLegend.hidden;
        
        // Visible/unvisible evs layer
        if (activeWidget) {
          evsLayer.visible = true;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          evsLayer.visible = false;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      evsCheckbox.addEventListener("click", checkBoxClick);
    });

    // River Layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        riverLegend.hidden = !riverLegend.hidden;
        
        // Visible/unvisible river layer
        if (activeWidget) {
          riverLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          riverLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      riverCheckbox.addEventListener("click", checkBoxClick);
    });

    // TBM Tunnel layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        tbmTunnelLegend.hidden = !tbmTunnelLegend.hidden;
        
        // Visible/unvisible tbmTunnel layer
        if (activeWidget) {
          tbmTunnelLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          tbmTunnelLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      tbmTunnelCheckbox.addEventListener("click", checkBoxClick);
    });

    // Muckpit layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        muckPitLegend.hidden = !muckPitLegend.hidden;
        
        // Visible/unvisible muckPit layer
        if (activeWidget) {
          muckPitLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          muckPitLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      muckPitCheckbox.addEventListener("click", checkBoxClick);
    });

    // TBM Shaft layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        tbmShaftLegend.hidden = !tbmShaftLegend.hidden;
        
        // Visible/unvisible tbmTunnel layer
        if (activeWidget) {
          tbmShaftLayer.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          tbmShaftLayer.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      tbmShaftCheckbox.addEventListener("click", checkBoxClick);
    });

    // Station Structure layer
    view.when(() => {
      let activeWidget;
      const checkBoxClick = ({ target }) => {

        // Hide/Unhide legend
        stationStructureLegend.hidden = !stationStructureLegend.hidden;
        
        // Visible/unvisible tbmTunnel layer
        if (activeWidget) {
          stationStructure.visible = false;
        }

        const nextWidget = target.id;
        if (nextWidget !== activeWidget) {
          stationStructure.visible = true;
          activeWidget = nextWidget
        } else {
          activeWidget = null;
        }
      }
      stationStructureCheckbox.addEventListener("click", checkBoxClick);
    });

    const timeSeriesChartTbmTunnelDiv = document.getElementById("timeSeriesChartTbmTunnelDiv");
    const timeSeriesChartLandDiv = document.getElementById("timeSeriesChartLandDiv");

    // view.when
    view.when(() => {
      document.querySelector("#header-title").textContent = "MMSP WORK PROGRESS";
      document.querySelector("#item-description").innerHTML = `
                                                                 1. This web app shows key progress on:<br>
                                                                 <ul><li>Land acquisition including structures and NLOs (non-land owners),</li><br>
                                                                     <li>Tree cutting and compensation,</li><br>
                                                                     <li>Utility relocation</li></ul><br>
                                                                 2. <b>Click tabs</b> under the contract packages list in the right side of the header to view progress on pre-construction and construction works.<br>
                                                                 <br>3. <b>Click series in pie charts</b> to view progress on the respective items on the map.<br>
                                                                 <br>4. Click/unclick widget icons for viewing:<br>
                                                                  <ul><li>Layer list with legend,</li><br>
                                                                      <li>Basemaps,</li><br>
                                                                      <li>Underground (underground navigation)</li><br>
                                                                      <li>Links to individual web apps,</li><br>
                                                                      <li>Progress charts for land acquisition and viaduct construction,</li></ul>
                                                                 `
                                                                 ;

      let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;

            // Open the time series chart when chart widget is opened.
            if (`${activeWidget}` === "animation") {
              initialization();
            }

          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });

        // IMPORTANT NOTE:
        // You need to include progress chart and see-through-ground inside widget calcite-panel; otherwise,
        // when you click the checkbox, toggling action will be reversed for this activation.
        
        // Progress Chart
        document.getElementById("tbmTunnel-checkbox").addEventListener("click", function(event) {
          const checked = event;
          timeSeriesChartTbmTunnelDiv.hidden = !timeSeriesChartTbmTunnelDiv.hidden;
        });

        document.getElementById("land-checkbox").addEventListener("click", function(event) {
          const timeSeriesChartTbmTunnelLandDiv = document.getElementById("timeSeriesChartTbmTunnelLand");
          const checked = event;
          timeSeriesChartLandDiv.hidden = !timeSeriesChartLandDiv.hidden;
        });

        // See-through-Ground
        view.when(function() {
          // allow navigation above and below the ground
          map.ground.navigationConstraint = {
            type: "none"
          };
          // the webscene has no basemap, so set a surfaceColor on the ground
          map.ground.surfaceColor = "#fff";
                  
          // to see through the ground, set the ground opacity to 0.4
          map.ground.opacity = 1;
        });
                  
        document.getElementById("myLink").addEventListener("click", function(event) {
          const checked = event.srcElement.checked;
          map.ground.opacity = event.srcElement.checked ? 0 : 0.8;
          view.environment.atmosphereEnabled = false;
        });
      // Switch theme
      document.querySelector("calcite-shell").hidden = false;
      document.querySelector("calcite-loader").hidden = true;

    });


    
  // Measurement Widgets
  // To modify analysis objects we will temporarily store the corresponding widget in this variable.
  let analysisWidget = null;

  view.when(async () => {
    // Create the analysis objects
    const directLineMeasurementAnalysis = createDirectLineMeasurementAnalysis();
    const areaMeasurementAnalysis = createAreaMeasurementAnalysis();
    const sliceAnalysis = createSliceAnalysis();
    const lineOfSightAnalysis = createLineOfSightAnalysis();

    // Wait for the view to load before adding analysis objects
    await reactiveUtils.whenOnce(() => !view.updating);

    // Add analysis object to the view to show them
    view.analyses.addMany([
      directLineMeasurementAnalysis,
      areaMeasurementAnalysis,
      sliceAnalysis,
      lineOfSightAnalysis
    ]);

    // Configure buttons to interact with the analysis objects
    const areaMeasurementAnalysisButton = setupAnalysisButton(
      "areaMeasurementAnalysisButton",
      () => new AreaMeasurement3D({ view, analysis: areaMeasurementAnalysis })
    );

    const directLineMeasurementAnalysisButton = setupAnalysisButton(
      "directLineMeasurementAnalysisButton",
      () => new DirectLineMeasurement3D({ view, analysis: directLineMeasurementAnalysis })
    );

    const lineOfSightAnalysisButton = setupAnalysisButton(
      "lineOfSightAnalysisButton",
      () => new LineOfSight({ view, analysis: lineOfSightAnalysis })
    );

    const sliceAnalysisButton = setupAnalysisButton(
      "sliceAnalysisButton",
      () => new Slice({ view, analysis: sliceAnalysis })
    );

    // Remove button is a bit special
    document.getElementById("removeWidgetButton").addEventListener("click", () => {
      removeActiveWidget();
    });

    function setupAnalysisButton(elementId, widgetFactotry) {
      const button = document.getElementById(elementId);

      button.addEventListener("click", () => {
        // remove current widget (if any)
        removeActiveWidget();

        // install a suitable widget in the `analysisWidget` variable
        analysisWidget = widgetFactotry();

        // highlight this button as the currently active one and add the remove widget button
        button.appearance = "outline";
        document.getElementById("removeWidgetButton").style.display = "block";

        // show the analysisWidget in the lower right corner
        view.ui.add(analysisWidget, "bottom-right");
      });
      return button;
    }

    function removeActiveWidget() {
      // remove the analysisWidget if one exists
      if (analysisWidget) {
        analysisWidget.destroy();
        analysisWidget = null;
      }

      // hide remove button
      document.getElementById("removeWidgetButton").style.display = "none";

      // reset appearance of the analysis buttons
      areaMeasurementAnalysisButton.appearance = "solid";
      directLineMeasurementAnalysisButton.appearance = "solid";
      lineOfSightAnalysisButton.appearance = "solid";
      sliceAnalysisButton.appearance = "solid";
    }
  });

  function createDirectLineMeasurementAnalysis() {
    return new DirectLineMeasurementAnalysis({
      startPoint: newPoint(-8238827, 4971466, 3),
      endPoint: newPoint(-8238819, 4971537, 3)
    });
  }

  function createAreaMeasurementAnalysis() {
    const roofPolygon = new Polygon({
      rings: [
        [
          [-8238931, 4971381, 50],
          [-8238926, 4971426, 50],
          [-8238835, 4971415, 50],
          [-8238841, 4971369, 50],
          [-8238931, 4971381, 50]
        ]
      ],
      spatialReference: SpatialReference.WebMercator
    });

    return new AreaMeasurementAnalysis({
      geometry: roofPolygon
    });
  }

  function createSliceAnalysis() {
    return new SliceAnalysis({
      shape: {
        position: newPoint(-8238840, 4971700, 21),
        tilt: 0,
        width: 70,
        height: 100,
        heading: 278
      }
    });
  }

  function createLineOfSightAnalysis() {
    return new LineOfSightAnalysis({
      observer: { position: newPoint(-8238825, 4971538, 48) },
      targets: [
        { position: newPoint(-8238903, 4971649, 2) },
        { position: newPoint(-8238866, 4971629, 19) },
        { position: newPoint(-8238825, 4971880, 2) },
        { position: newPoint(-8238791, 4971784, 2) }
      ]
    });
  }

  function newPoint(x, y, z) {
    // convenience function to have all points in the same spatial reference
    return new Point({ x, y, z, spatialReference: SpatialReference.WebMercator });
  }

  //view.ui.add("measurementToolMenu", "bottom-left");

  const measurementToolMenuExpand = new Expand({
    view,
    content: document.getElementById("measurementToolMenu"),
    expandIconClass: "esri-icon-measure-line"
  });
  view.ui.add(measurementToolMenuExpand, "top-right");

    });
  </script>
</html>