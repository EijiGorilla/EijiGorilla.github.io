<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>SC1 Land Acquisition</title>
    
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

    <script src="https://js.arcgis.com/4.26/"></script>

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    #container {
      display: grid;
      flex-wrap: wrap;
      box-sizing: border-box;
      grid-template-columns: 1fr 0.25fr;
      width: 100%;
      height: 100%;
    }

    calcite-tabs {
      width: 100%;
      height: 100%;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    
    #chartPanel {
      background-color: rgb(0, 0, 0, 0);
      padding: 8;
      width: 100%;
      height: 100%;
    }
    
    #pieChartLotDiv,
    #pieChartStructureDiv,
    #pieChartBarangayDiv {
      width: 100%;
      height: 48%;
      align-items: center;
      padding: 1%;
      margin-bottom: 10;
    }

    
    #lotNumberDiv,
    #structureNumberDiv {
      color: rgb(0, 197, 255); 
      text-align: center;
      font-weight: normal;
      font-size: 1.5vw;
      border: solid 0.5px gray;
      padding-top: 1%;
      padding-bottom: 4%;
    }

    #lotNumberDiv b,
    #structureNumberDiv b {
      font-size: 1.0vw;
      font-family: 'Calibri';
      font-weight: bold;
      color:rgb(250, 246, 246);
    }

    br {
      content: "";
      margin: 2em;
      display: block;
      font-size: 24%;
    }

    b {
        color: orange;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    /* Expropriation List */
    /** clear background color of list box **/
    .panel-side {
      background-color: rgb(0, 0, 0, 0);
      margin-top: 1%;
    }

    /** adjust line height between texts **/
    .panel-side li {
      padding: 1% 1%;
    }

    /** adjust lot ID's font size and color **/
    .panel-side li b{
      color: red;
      font-size: 0.8vw;
    }

    .panel-result {
      cursor: pointer;
      margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
      background-color: rgba(73, 72, 72, 0.5);
    }

    #refusedListDiv,
    #refusedListBarangayDiv {
      list-style: none;
      padding: 0.5%;
      padding-right: 5%;
      font-size: 0.8vw;
      width: 17vw;
    }

    /* MOA Chart */
    #chartPriorityLotDiv {
        width: 100%;
        height: 35%;
        align-items: center;
        padding: 1%;
    }

    /* Dropdown list */
    #dropdownDiv {
      background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: white;
        text-align: right;
        margin: auto;
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
    
    /*  */
    .esri-legend__layer-caption {
      display: none;
    }

  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      
       <!--  Header slot  -->
      <div slot="header" id="header">
        
      <!-- Title -->
      <h2 id="header-title" slot="header"></h2>

      <div id="dateDiv">August 1, 2022</div>

      <!-- Dropdown Lists -->
      <div id="dropdownDiv" class="esri-widget">
        <label id="dropdownMunicipalLabel">
            City/Municipality:
            <select id="municipalSelect" class="esri-widget"></select>
        </label>
        <label id="dropdownBarangayLabel">
            Barangay:
            <select  style="width: 10vw" id="barangaySelect" class="esri-widget"></select>
        </label>
        <label id="dropdownHandOverDateLabel">
            Priority:
            <select id="prioritySelect" class="esri-widget"></select>
        </label>
      </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
          <calcite-action data-action-id="locate" icon="gps-on-f" text="My Location"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>
        <calcite-panel heading="Click the icon below" width-scale="w" data-panel-id="locate" hidden>
          <div id="locate-container"></div>
        </calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="container">
        <div id="viewDiv"></div>
        <!-- Chart Panel -->
        <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
        <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
        <calcite-tabs>
            <div id="chartPanel">
                <calcite-tab-nav slot="tab-nav">
                    <calcite-tab-title selected>Land</calcite-tab-title>
                    <calcite-tab-title>Structure</calcite-tab-title>
                    <calcite-tab-title>Barangay</calcite-tab-title>
                    <calcite-tab-title>Refused</calcite-tab-title>
                </calcite-tab-nav>
                <calcite-tab>
                    <div class="box" id="pieChartLotDiv"></div>
                    <div id="lotNumberDiv"></div>
                    <div id="chartPriorityLotDiv"></div>
                </calcite-tab>
                <calcite-tab>
                  <div class="box2" id="pieChartStructureDiv"></div>
                  <div id="structureNumberDiv"></calcite-label>
                  </div>
                </calcite-tab>
                <calcite-tab>
                    <div class="box3" id="pieChartBarangayDiv"></calcite-label>
                    </div>
                  </calcite-tab>
                <calcite-tab>
                  <div class="panel-side esri-widget">
                    <ul id="refusedListDiv">
                      <li>Loading&hellip;</li>
                    </ul>
                  </div>
                </calcite-tab>
            </div>
        </calcite-tabs>
      </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/layers/SceneLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/PopupTemplate",
      "esri/layers/support/LabelClass",
      "esri/popup/content/CustomContent",
    ], function(WebMap, MapView, SceneView, Map, FeatureLayer, SceneLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, PopupTemplate,
                LabelClass, CustomContent
                 ) {
      
    var map = new Map({
        basemap: "dark-gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new SceneView({
        map: map,
        center: [121.0477729, 14.4136156],
        zoom: 10,
        viewingMode: "local",
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    function colorLotReqs(){
        return {
            1: [76,230,0],
            2: [49,149,183],
            3: [68,85,90],
            4: [255,170,0],
            5: [255,255,0],
            6: [255,255,255],
            7: [255,0,0],
            8: [0,0,0,0.5]
        }
    }

    const lotRenderer = {
        type: "unique-value",
        field: "Reqs",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        uniqueValueInfos: [
            {
                value: 1,
                label: "Complete",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                value: 2,
                label: "Incomplete Documents",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                value: 3,
                label: "Surveyed and with plan",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                value: 4,
                label: "Surveyed and for drafting",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                value: 5,
                label: "Researched",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            },
            {
                value: 6,
                label: "For Survey & Research",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[6],
                }
            },
            {
                value: 7,
                label: "Refused",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[7],
                }
            },
            {
                value: 8,
                label: "NA",
                symbol: {
                    type: "simple-fill",
                    color: colorLotReqs()[8],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "grey"
                    }
                }
            }
        ]
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 14,
        renderer: lotRenderer ,
        definitionExpression: "ContSubm = 1",
        outFields: ["*"],
        title: "Land",
        labelsVisible: false,
        returnGeometry: true,
        popupTemplate: {
    title: "<p>{LotID}</p>",
    lastEditInfoEnabled: false,
    content: [
      {
        type: "fields",
        fieldInfos: [
          {
            fieldName: "LandOwner",
            label: "Land Owner"
          },
          {
            fieldName: "Municipality"
          },
          {
            fieldName: "Barangay"
          },
          {
            fieldName: "Reqs",
            label: "<p>Requirements</p>"
          },
          {
            fieldName: "Priority1",
            label: "<p>Priority</p>"
          }
        ]
      }
    ]
  }
    });
    map.add(lotLayer, 1);


    // Structure Layer
    const height = 5;
    const edgeSize = 0.5;
    const completed = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [76, 230, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const surveyed = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [115, 223, 255, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    };

    const forSurvey = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 170, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const reschedule = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 255, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const missing = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [197, 0, 255, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const refused = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [255, 0, 0, 0.4]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const na = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: height,
          material: {
            color: [0, 0, 0, 0.5]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: edgeSize
          }
        }
      ]
    }

    const structureRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: [0, 0, 0, 0.4]
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: edgeSize
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "BasicPlan",
      legendOptions: {
        title: "Status of Structure"
      },
      uniqueValueInfos: [
        {
          value: 1,
          symbol: completed,
          label: "Completed"
        },
        {
          value: 2,
          symbol: surveyed,
          label: "Surveyed and for drafting"
        },
        {
          value: 3,
          symbol: forSurvey,
          label: "For Survey"
        },
        {
          value: 4,
          symbol: reschedule,
          label: "For Reschedule"
        },
        {
          value: 5,
          symbol: missing,
          label: "Missing tag or structure or owner"
        },
        {
          value: 6,
          symbol: refused,
          label: "Refused"
        },
        {
          value: 7,
          symbol: na,
          label: "NA"
        },
      ]
    }

    var structureLayer = new FeatureLayer({
      portalItem: {
        id: "c38a7320b34b45b580778d7363f4e4c3",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 13,
      definitionExpression: "ContSubm = 1",
      renderer: structureRenderer,
      title: "Structure Basic Plan",
      popupTemplate: {
        title: "<p>{StrucID}</p>",
        lastEditInfoEnabled: false,
        returnGeometry: true,
        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "StrucOwner",
                label: "Structure Owner"
              },
              {
                fieldName: "BasicPlan",
                label: "<p>Status of Structure</p>"
              },               
              {
                fieldName: "LotID", 
                label: "Lot ID"
              },
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Barangay"
              }
            ]
          }
        ]
      }
        });
        map.add(structureLayer);


    // Priority Lots
    var priorityLabel = new LabelClass({
        labelExpressionInfo: {expression: "$feature.LotID"},
        symbol: {
            type: "text",
            color: "black",
            haloColor: "white",
            haloSize: 0.5,
            font: {
                size: 12,
                weight: "bold"
            }
        }
    });

    function colorPriority() {
        return {
            1: [255, 0, 0], // Red
            2: [255, 127, 80], // Orange
            3: [255, 255, 0], // Yellow
            4: [0, 112, 255], // Blue
            5: [143, 0, 255], // violet
            6: [0, 255, 0], // Lime
            7: [112, 173, 71] // Green
        }
    }

    const priorityDates = ["December 2022", "April 2023", "July 2023"];

    let lotPriorityRenderer = {
        type: "unique-value",
        field: "Priority1",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.Priority1 == 1, '1', $feature.Priority1 == 2, '2', \
                        $feature.Priority1 == 3, '3', $feature.Priority1)",
        uniqueValueInfos: [
            {
                value: "1",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[1]
                    }
                }   
            },
            {
                value: "2",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[2]
                    }
                }
            },
            {
                value: "3",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: [0,0,0,0],
                    outline: {
                        width: 4,
                        color: colorPriority()[3]
                    }
                }
            },
        ]
    }

    var priorityLayer = new FeatureLayer ({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 8,
        renderer: lotPriorityRenderer,
        labelingInfo: [priorityLabel],
        definitionExpression: "ContSubm = 1",
        title: "Priority Lot",
        popupEnabled: false,
        minScale: 200000,
        maxScale: 0
        });
        map.add(priorityLayer,0);

    // Barangay
    function colorBarangay() {
        return {
            1: [76, 230, 0, 0.9],
            2: [115, 178, 255, 0.9],
            3: [255, 255, 255, 0.9],
            4: [255, 170, 0, 0.9],
            5: [255, 0, 0, 0.9],
            6: [0, 0, 0, 0.9]
        }
    }

    const barangayRenderer = {
      type: "unique-value",
      field: "Coop",
      defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
      uniqueValueInfos: [
        {
          value: 1,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[1]
            }
          }
        },
        {
          value: 2,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[2]
            }
          }
        },
        {
          value: 3,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[3]
            }
          }
        },
        {
          value: 4,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[4]
            }
          }
        },
        {
          value: 5,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[5]
            }
          }
        },
        {
          value: 6,
          symbol: {
            type: "simple-fill",  // autocasts as new SimpleFillSymbol()
            color: [0,0,0,0],
            outline: {
                width: 2,
                color: colorBarangay()[6]
            }
          }
        },
      ]
    }

    var barangayLayer = new FeatureLayer({
      portalItem: {
        id: "21212e2402314a88abc95f6b2780276e",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      renderer: barangayRenderer,
      outFields: ["*"],
      title: "Barangay",
      elevationInfo: {
        mode: "on-the-ground"
      },
      popupTemplate: {
        title: "<p>{Barangay}</p>",

        content: [
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "Municipality"
              },
              {
                fieldName: "Subcon",
                label: "Subcontractors"
              },
              {
                fieldName: "Coop",
                label: "<p>Cooperation</p>"
              }
            ]
          }
        ]
      }
      //labelsVisible: false,
      //popuEnabled: false,
    });
    map.add(barangayLayer);


    // Chainage
    var labelChainage = new LabelClass({
        labelExpressionInfo: {expression: "$feature.KmSpot"},
            symbol: {
                type: "text",
                color: [85, 255, 0],
                haloColor: "black",
                haloSize: 0.5,
                font: {
                    size: 15,
                    weight: "bold"
                }
            }
    });

    var chainageRenderer = {
        type: "simple",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: [255, 255, 255, 0.9],
            outline: {
                width: 0.2,
                color: "black"
            }
        }
    };

    var chainageLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "Chainage",
        elevationInfo: {
            mode: "relative-to-ground"
        },
        labelingInfo: [labelChainage],
        minScale: 150000,
        maxScale: 0,
        renderer: chainageRenderer,
        outFields: ["*"],
        popupEnabled: false
    });
    map.add(chainageLayer);

    // Pier Head and Column
    const pHeight = 0;

    const pierColumn = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [78, 78, 78, 0.5]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 0.3
          }
        }
      ]
    };

    const pierHead = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 10,
          material: {
            color: [169, 169, 169, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    };

    const pileCap = {
      type: "polygon-3d",
      symbolLayers: [
        {
          type: "extrude",
          size: pHeight + 3,
          material: {
            color: [200, 200, 200, 0.7]
          },
          edges: {
            type: "solid",
            color: "#4E4E4E",
            size: 1.0
          }
        }
      ]
    }

    const pierHeadRenderer = {
      type: "unique-value",
      defaultSymbol: {
        type: "polygon-3d",
        symbolLayers: [
          {
            type: "extrude",
            size: 5, // in meters
            material: {
              color: "#E1E1E1"
            },
            edges: {
              type: "solid",
              color: "#4E4E4E",
              size: 1.0
            }
          }
        ]
      },
      defaultLabel: "Other",
      field: "Layer",
      legendOptions: {
        title: "Pier Head/Pier Column/Pile Cap"
      },
      uniqueValueInfos: [
        {
          value: "Pier_Column",
          symbol: pierColumn,
          label: "Pier Column"
        },
        /*
        {
          value: "Pier_Head",
          symbol: pierHead,
          label: "Pier Head"
        },
        */
        {
          value: "Pile_Cap",
          symbol: pileCap,
          label: "Pile Cap"
        },
      ]
    }

    var pierHeadColumnLayerLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        title: "Pier Head/Column",
        definitionExpression: "Layer <> 'Pier_Head'",
        outFields: ["*"],
        minScale: 150000,
        maxScale: 0,
        renderer: pierHeadRenderer,
        popupEnabled: false,
        elevationInfo: {
          model: "on-the-ground"
        }
    });
    //pierHeadColumnLayerLayer.listMode = "hide";
    map.add(pierHeadColumnLayerLayer, 1);

    // Pier No (point)
    // Renderer
    // 0. Define colors for unique values
    const pierAccessDateColor = {
      0: [0, 255, 0, 0.9],// Accessible (green)
      1: [255, 127, 80],// Orange
      2: [255, 255, 0],// Yellow
      3: [0, 112, 255], // Blue
      4: [143, 0, 255], // violet
      5: [255, 255, 255, 0.9]
    }

    var defaultPointSymbol = {
        type: "simple",
        label: "Accessible",
        symbol: {
            type: "simple-marker",
            size: 5,
            color: pierAccessDateColor[0],
            outline: {
                width: 0,
                color: "black"
            }
        }
    }

      // labels
      // for multiple label class to a layer:
      // https://developers.arcgis.com/javascript/latest/sample-code/labels-multiple-classes/
      
      const cutOffDateAccess = 1636070400000;
      // make sure to update numerical date values in 'pierAccessRenderer'
  
      const pierAccessReadyDateLabel = new LabelClass({
        symbol: {
          type: "label-3d", // autocast as new LabelSymbol3D()
          symbolLayers: [
            {
              type: "text",
              material: {
                color: pierAccessDateColor[0]
              },
              size: 15,
              color: pierAccessDateColor[0],
              haloColor: pierAccessDateColor[0],
              haloSize: 1,
              font: {
                family: "Ubuntu Mono",
                weight: "bold"
              },
            }
          ],
          verticalOffset: {
            screenLength: 80,
            maxWorldLength: 500,
            minWorldLength: 30
          },
          callout: {
            type: "line",
            size: 0.5,
            color: [0, 0, 0],
            border: {
              color: [255, 255, 255, 0.7]
            }
          }
        },
        labelExpressionInfo: {
          expression: "$feature.PIER"
          //'DefaultValue($feature.GeoTechName, "no data")'
          //"IIF($feature.Score >= 13, '', '')"
          //value: "{Type}"
        },
        labelPlacement: "above-center",
        where: "AccessDate <= '" + cutOffDateAccess + "'"
    });

    const pierAccessNotYetLabel =  new LabelClass({
      symbol: {
        type: "label-3d", // autocast as new LabelSymbol3D()
        symbolLayers: [
          {
            type: "text",
            material: {
              color: "#cccccc"
            },
            size: 10,
            color: "#cccccc",
            haloColor: "#cccccc",
            haloSize: 1,
            font: {
              family: "Ubuntu Mono",
              weight: "normal"
            },
          }
        ],
        verticalOffset: {
          screenLength: 80,
          maxWorldLength: 500,
          minWorldLength: 30
        },
        callout: {
          type: "line",
          size: 0.5,
          color: [0, 0, 0],
          border: {
            color: [255, 255, 255, 0.7]
          }
        }
      },
      labelExpressionInfo: {
        expression: "$feature.PIER"
        //'DefaultValue($feature.GeoTechName, "no data")'
        //"IIF($feature.Score >= 13, '', '')"
        //value: "{Type}"
      },
      labelPlacement: "above-center",
      where: "AccessDate > '" + cutOffDateAccess + "'"
    });

    // 1. Get unique dates
    const numberDate = new Date(cutOffDateAccess);
    const cutDate = numberDate.toLocaleDateString('en-US');

    var pierNoLayer = new FeatureLayer ({
      portalItem: {
        id: "d3926383cf3548569372216edb808996",
        portal: {
          url: "https://gis.railway-sector.com/portal"
        }
      },
      layerId: 6,
      labelingInfo: [pierAccessReadyDateLabel, pierAccessNotYetLabel],
      title: "Pier Access Date",
      minScale: 150000,
      maxScale: 0,
      outFields: ["*"],
      elevationInfo: {
        model: "on-the-ground"
      }
    },{utcOffset: 300});
    //map.add(pierNoLayer, 3);

    // we first need to obtain unique values of date because valueExpression does not allow
    // date'2021-10-01' notation
    const queryDate = "AccessDate IS NOT NULL";

    function DateValues() {
      const dates = [];
      var query = pierNoLayer.createQuery();

      query.where = queryDate;
      return pierNoLayer.queryFeatures(query).then(function(response) {
        var stats = response.features;
        stats.forEach((result, index) => {
          const attributes = result.attributes;
          const date = attributes.AccessDate;
          dates.push(date);
        });
        return dates;
      });
    }

    function uniqueDateValues(values) {
      var uniqueValues = [];
      values.forEach((item, index) => {
        if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
          uniqueValues.push(item);
        }
      });
      const sortedDates = uniqueValues.sort();
      return sortedDates;
    }

    function uniqueValuesInfos(sortedDates) {
      const dates = sortedDates.map((date, index) => {
        const temp = new Date(date);
        const labelDate = temp.toLocaleDateString('en-US');
        return Object.assign({}, {
          value: date, // make sure to use 'number'. you cannot add 'date'
          label: labelDate,
        });
      });
      console.log(dates);
    }
    DateValues().then(uniqueDateValues).then(uniqueValuesInfos);

    const pierAccessRenderer = {
      type: "unique-value", // autocasts as new UniqueValueRenderer()
      field: "AccessDate",
      defaultSymbol: defaultPointSymbol,
      
      valueExpression: "When($feature.AccessDate <= 1636070400000, 'accessible', \
                            $feature.AccessDate > 1636070400000, 'others',$feature.AccessDate)", 
      uniqueValueInfos: [
        {
          value: "accessible",
          label: "Accessible",
          type: "simple",
          symbol: {
              type: "simple-marker",
              size: 5,
              color: pierAccessDateColor[0],
              outline: {
                  width: 0.1,
                  color: "white"
              }
          }
        },
        {
          value: "others",
          label: "Others",
          type: "simple",
          symbol: {
              type: "simple-marker",
              size: 5,
              color: pierAccessDateColor[5],
              outline: {
                  width: 0.1,
                  color: "white"
              }
          }
        },
      ]
    }
    pierNoLayer.renderer = pierAccessRenderer;

    // Popup Template

    /// Define popup template on dates for pier no
    // Date Format function
    function dateFormat(inputDate, format) {
      //parse the input date
      const date = new Date(inputDate);

      //extract the parts of the date
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();    

      //replace the month
      format = format.replace("MM", month.toString().padStart(2,"0"));        

      //replace the year
      if (format.indexOf("yyyy") > -1) {
          format = format.replace("yyyy", year.toString());
      } else if (format.indexOf("yy") > -1) {
          format = format.replace("yy", year.toString().substr(2,2));
      }

      //replace the day
      format = format.replace("dd", day.toString().padStart(2,"0"));

      return format;
    }

    // Custom Popup Content for pierNoLayer
    let customContent = new CustomContent({
      outFields: ["*"],
      creator: function(event) {

        // Extract AsscessDate of clicked pierNoLayer
        const stats = event.graphic.attributes.AccessDate;
        const pierNo = event.graphic.attributes.PIER;

        // Convert numeric to date format
        var date = new Date(stats);
        dateValue = dateFormat(date, 'MM-dd-yyyy');

        const ddd = new Date(cutOffDateAccess);
        dddValue = dateFormat(ddd, 'MM-dd-yyyy')

        //console.log(dateValue + "; " + dddValue);
        
        // If the date is before current date, popupContent should be "AVAILABLE"
        if (date <= cutOffDateAccess) {
            DATES = "ACCESSIBLE";
        } else {
            DATES = dateValue;
        }

        //return `Access Date: <b>${DATES}</b>`;
        return `Access Date: <b>${DATES}</b>`;

      }
    });

    const template = new PopupTemplate({
        outFields: ["*"],
        title: "Pier No: <b>{PIER}</b>",
        lastEditInfoEnabled: false,
        content: [customContent]
    });
    pierNoLayer.popupTemplate = template;

    // Station Box
    let stationBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
            {
                value: "00_Platform",
                label: "Platform",
                    symbol: {
                    type: "simple-fill",
                    color: [160, 160, 160],
                    style: "backward-diagonal",
                    outline: {
                        width: 1,
                        color: "black"
                    }
                }
            },
            {
                value: "00_Platform 10car",
                label: "Platform 10car",
                symbol: {
                    type: "simple-fill",
                    color: [104, 104, 104],
                    style: "cross",
                    outline: {
                        width: 1,
                        color: "black",
                        style: "short-dash"
                    }
                }
            },
            {
            value: "00_Station",
            label: "Station Box",
            symbol: {
                type: "simple-fill",
                color: [0, 0, 0, 0],
                outline: {
                    width: 2,
                    color: [115, 0, 0]
                }
            }
            }
        ]
    };

    var stationBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        renderer: stationBoxRenderer,
        minScale: 150000,
        maxScale: 0,
        title: "Station Box",
        outFields: ["*"],
        popupEnabled: false
    });
    //stationBoxLayer.listMode = "hide";
    map.add(stationBoxLayer, 2);

    // ROW //
    var rowLayer = new FeatureLayer ({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "PROW",
        popupEnabled: false
    });
    map.add(rowLayer,2);

    // Free and Clear Lot
    var fncLayer = new FeatureLayer ({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 9,
        title: "Free-and-Clear Area",
        //popupEnabled: false
    });
    map.add(fncLayer,1);

    // PNR
    let pnrRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.LandOwner == 'BASES CONVERSION DEVELOPMENT AUTHORITY', 'BCDA', \
                        $feature.LandOwner == 'MANILA RAILROAD COMPANY' || $feature.LandOwner == 'Manila Railroad Company','PNR',$feature.LandOwner)",
        uniqueValueInfos: [
            {
                value: "BCDA",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            },
            {
                value: "PNR",
                symbol: {
                    type: "simple-fill",
                    color: [225,225,225],
                    style: "diagonal-cross",
                    outline: {
                        width: 0.5,
                        color: "black"
                    }
                }
            }
        ]
    };

    var pnrLayer = new FeatureLayer({
        portalItem: {
            id: "c38a7320b34b45b580778d7363f4e4c3",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 17,
        title: "Land (PNR)",
        outFields: ["*"],
        title: "PNR",
        labelsVisible: false,
        renderer: pnrRenderer,
        popupEnabled: false
    });
    map.add(pnrLayer, 1);

    // Station point feature
    var labelStation = new LabelClass({
        symbol: {
            type: "text",
            color: "orange",
            haloColor: "black",
            haloSize: 0.7,
            font: {
                size: 20,
                weight: "bold"
            }
        },
        labelPlacement: "above-right",
        labelExpressionInfo: {
            expression: "$feature.Station"
        }
    });

    var stationLayer = new FeatureLayer({
        portalItem: {
            id: "d3926383cf3548569372216edb808996",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "Station",
        outFields: ["*"],
        popuEnabled: false,
        labelingInfo: [labelStation]
    });
    stationLayer.listMode = "hide";
    map.add(stationLayer);


    /////////////////// END Of LAYER IMPORT ////////////////////////////

    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
          zoom: 17
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      

      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;
      
      const lotNumberDiv = document.getElementById("lotNumberDiv");
      const structureNumberDiv = document.getElementById("structureNumberDiv");

      var municipalSelect = document.getElementById("municipalSelect");
      var barangaySelect = document.getElementById("barangaySelect");
      var prioritySelect = document.getElementById("prioritySelect");
      
      am5.ready(function() {
            // Charts for Lot and Structure
    // Lot Chart
    const LEGEND_FONT_SIZE = "0.9em";
    var root = am5.Root.new("pieChartLotDiv");

    const statusLot = [
        "Complete", "Incomplete Documents", "Surveyed and with plan",
        "Surveyed and for drafting", "Researched", "For Survey & Research",
        "Refused", "NA"
    ];

    function updateChartLot(municipal, barangay, priority) {
        root.container.children.clear();
        // First, define statuses
        var total_survdraft_struc = {
            onStatisticField: "CASE WHEN Reqs = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survdraft_struc",
            statisticType: "sum"
        };

        var total_survey_struc = {
            onStatisticField: "CASE WHEN Reqs = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survey_struc",
            statisticType: "sum"
        };

        var total_resche_struc = {
            onStatisticField: "CASE WHEN Reqs = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_resche_struc",
            statisticType: "sum"
        };

        var total_survdraft_lot = {
            onStatisticField: "CASE WHEN Reqs = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survdraft_lot",
            statisticType: "sum"
        };

        var total_second_lot = {
            onStatisticField: "CASE WHEN Reqs = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_second_lot",
            statisticType: "sum"
        };

        var total_survres_lot = {
            onStatisticField: "CASE WHEN Reqs = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survres_lot",
            statisticType: "sum"
        };

        var total_refuse_lot = {
            onStatisticField: "CASE WHEN Reqs = 7 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_refuse_lot",
            statisticType: "sum"
        };

        var total_na_lot = {
            onStatisticField: "CASE WHEN Reqs = 8 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_na_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_survdraft_struc, total_survey_struc, total_resche_struc,
                               total_survdraft_lot, total_second_lot, total_survres_lot,
                               total_refuse_lot, total_na_lot];
        query.returnGeometry = true;

        return lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const comp = stats.total_survdraft_struc;
            const incomp = stats.total_survey_struc;
            const survplan = stats.total_resche_struc;
            const survdraft = stats.total_survdraft_lot;
            const research = stats.total_second_lot;
            const survres = stats.total_survres_lot;
            const refuse = stats.total_refuse_lot;
            const nna = stats.total_na_lot;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {
            paddingBottom: 10,

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          console.log(SELECTED)
          if (SELECTED == statusLot[0]) {
            selectedStatus = 1;
            } else if (SELECTED == statusLot[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusLot[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusLot[3]) {
                selectedStatus = 4;
            } else if (SELECTED == statusLot[4]) {
                selectedStatus = 5;
            } else if (SELECTED == statusLot[5]) {
                selectedStatus = 6;
            } else if (SELECTED == statusLot[6]) {
                selectedStatus = 7;
            } else if (SELECTED == statusLot[7]) {
                selectedStatus = 8;
            } else {
                selectedStatus = null;
            }

            var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay = '" + barangay + "'";
          const priorityExpression = "Priority1_1 = '" + priority + "'";
          const statusExpression = "Reqs = " + selectedStatus;

          if (municipal === 'None' && barangay === 'None' && priority === 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay === 'None' && priority !== 'None') {
            query.where = priorityExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority === 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = barangayExpression + " AND " + priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + priorityExpression + " AND " + statusExpression;
          }

          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              //chartLayerView = layerView;

              lotLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "Reqs = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusLot[0],
              value: comp,
              sliceSettings: {
                fill: am5.color("#4CE600")
              }
            },
            {
              category: statusLot[1],
              value: incomp,
              sliceSettings: {
                fill: am5.color("#3196B7")
              }
            },
            {
              category: statusLot[2],
              value: survplan,
              sliceSettings: {
                fill: am5.color("#44555A")
              }
            },
            {
              category: statusLot[3],
              value: survdraft,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
              category: statusLot[4],
              value: research,
              sliceSettings: {
                fill: am5.color("#FFFF00")
              }
            },
            {
              category: statusLot[5],
              value: survres,
              sliceSettings: {
                fill: am5.color("#FFFFFF")
              }
            },
            {
              category: statusLot[6],
              value: refuse,
              sliceSettings: {
                fill: am5.color("#FF0000")
              }
            },
            {
              category: statusLot[7],
              value: nna,
              sliceSettings: {
                fill: am5.color("#FFFF0000"),
                fillOpacity: 0
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // chart title
        chart.children.unshift(am5.Label.new(root, {
            text: "Lot Requirements",
            fontSize: "1em",
            fontWeight: "bold",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            x: am5.percent(50),
            centerX: am5.percent(50),
        }));

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);


        }); // End of queryFeatures
    } // End of updateChartLot()

    // ----------------- BAR CHART FOR PRIORITY LOT ----------------- //
    var root2 = am5.Root.new("chartPriorityLotDiv");
        var myTheme = am5.Theme.new(root2);

        myTheme.rule("Grid", ["base"]).setAll({
          strokeOpacity: 0,
        });
        const statusMOA = ["1st Priority", "2nd Priority", "3rd Priority"];

    function updatePriorityChartLot(municipal, barangay, priority) {
        root2.container.children.clear();
        var total_first_lot = {
            onStatisticField: "CASE WHEN Priority1 = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_first_lot",
            statisticType: "sum"
        };

        var total_second_lot = {
            onStatisticField: "CASE WHEN Priority1 = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_second_lot",
            statisticType: "sum"
        };

        var total_third_lot = {
            onStatisticField: "CASE WHEN Priority1 = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_third_lot",
            statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [total_first_lot, total_second_lot, total_third_lot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const first = stats.total_first_lot;
            const second = stats.total_second_lot;
            const third = stats.total_third_lot;

                              // Set themes
         // https://www.amcharts.com/docs/v5/concepts/themes/
         root2.setThemes([
          am5themes_Animated.new(root2),
          myTheme
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/xy-chart/
        var chart = root2.container.children.push(
          am5xy.XYChart.new(root2, {
            panX: false,
            panY: false,
            wheelX: "none",
            wheelY: "none",
            paddingLeft: 0,
          })
        );

        // Create axes
        // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
        var yRenderer = am5xy.AxisRendererY.new(root2, {
          minGridDistance: 5,
          strokeOpacity: 1,
          strokeWidth: 1,
          inversed: true,
          stroke: am5.color("#ffffff")
        });
        yRenderer.grid.template.set("location", 1);

        var yAxis = chart.yAxes.push(
          am5xy.CategoryAxis.new(root2, {
            maxDeviation: 0,
            categoryField: "category",
            renderer: yRenderer,
          })
        );

        // Remove grid lines
        yAxis.get("renderer").grid.template.set("forceHidden", true);

        var xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root2, {
            maxDeviation: 0,
            min: 0,
            renderer: am5xy.AxisRendererX.new(root2, {
              visible: true,
              strokeOpacity: 1,
              strictMinMax: true,
              calculateTotals: true,
              strokeWidth: 1,
              stroke: am5.color("#ffffff"),
            })
          })
        );
        // Remove grid lines
        xAxis.get("renderer").grid.template.set("forceHidden", true);

        // Label properties for yAxis (category axis)
        yAxis.get("renderer").labels.template.setAll({
          //oversizedBehavior: "wrap",
          textAlign: "center",
          fill: am5.color("#ffffff"),
          //maxWidth: 150,
          fontSize: 12
        });

        xAxis.get("renderer").labels.template.setAll({
          fill: am5.color("#ffffff"),
          fontSize: 10
        });

        // Create series
        // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
        var series = chart.series.push(
          am5xy.ColumnSeries.new(root2, {
            name: "Series 1",
            xAxis: xAxis,
            yAxis: yAxis,
            valueXField: "value",
            sequencedInterpolation: true,
            categoryYField: "category",
          })
        );

        var columnTemplate = series.columns.template;

        columnTemplate.setAll({
          draggable: true,
          cursorOverStyle: "pointer",
          tooltipText: "{value}",
          cornerRadiusBR: 10,
          cornerRadiusTR: 10,
          strokeOpacity: 0
        });

        // Add Label bullet
        series.bullets.push(function () {
          return am5.Bullet.new(root2, {
            locationY: 1,
            sprite: am5.Label.new(root2, {
              text: "{value}",
              fill: root2.interfaceColors.get("alternativeText"),
              centerY: 3,
              centerX: am5.p50,
              fontSize: 14,
              populateText: true
            })
          });
        });

        // Use different color by column
        columnTemplate.adapters.add("fill", (fill, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        columnTemplate.adapters.add("stroke", (stroke, target) => {
          return chart.get("colors").getIndex(series.columns.indexOf(target));
        });

        series.columns.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          console.log(SELECTED);

          if (SELECTED == statusMOA[0]) {
            selectedStatus = 1;
          } else if (SELECTED == statusMOA[1]) {
            selectedStatus = 2;
          } else if (SELECTED == statusMOA[2]) {
            selectedStatus = 3;
          }

          var query = lotLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay = '" + barangay + "'";
          const priorityExpression = "Priority1_1 = '" + priority + "'";
          const statusExpression = "Priority1 = " + selectedStatus;

          if (municipal === 'None' && barangay === 'None' && priority === 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay === 'None' && priority !== 'None') {
            query.where = priorityExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority === 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = barangayExpression + " AND " + priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + priorityExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + priorityExpression + " AND " + statusExpression;
          }

          
          view.whenLayerView(lotLayer).then(function (layerView) {
          //CHART_ELEMENT.style.visibility = "visible";

          lotLayer.queryFeatures(query).then(function(results) {
              const RESULT_LENGTH= results.features;
              const ROW_N= RESULT_LENGTH.length;

              let objID = [];
              for (var i=0; i< ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
              }
              
              var queryExt = new Query({
              objectIds: objID
              });

              lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

              if (highlightSelect) {
              highlightSelect.remove();
              }
              highlightSelect = layerView.highlight(objID);

              view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
              });
          });
          layerView.filter = {
            where: "Priority1 = " + selectedStatus
            //where: "Status1 = '" + selectedC + "'" + " AND " + "Layer = '" + selectedStatus + "'" 
          };
          }); // End of whenLayerView
        });

        // Chart title
        chart.children.unshift(am5.Label.new(root2, {
          text: "Priority Lot",
          fontSize: 14,
          fontWeight: "bold",
          textAlign: "center",
          fill: am5.color("#3ce00a"),
          x: am5.percent(50),
          centerX: am5.percent(50),
          paddingTop: -10,
          paddingBottom: 0,
        }));
        // Set data
        var data = [
            {
                category: statusMOA[0],
                value: first
            },
            {
                category: statusMOA[1],
                value: second
            },
            {
                category: statusMOA[2],
                value: third
            },
        ]; // End of chart

        yAxis.data.setAll(data);
        series.data.setAll(data);

        // Make stuff animate on load
        // https://www.amcharts.com/docs/v5/concepts/animations/
        series.appear(1000);
        chart.appear(1000, 100);


        }); // End of queryFeatures
    } // End of updateMOAChartLot

    // ------------------ PIE CHART FOR STRUCTURE ----------------------//
    var root3 = am5.Root.new("pieChartStructureDiv");
    class MyTheme extends am5.Theme {
          setupDefaultRules() {
            var theme = this;

            const gap = 4;
            const rotation = 135;
            const strokeWidth = 1.1;
            const fillOpacity = 0;
            const width = 10;
            const height = 10;


            this.patterns = [
              am5.LinePattern.new(this._root, {
                color: am5.color("#4CE600"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#73DFFF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FFAA00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FFFF00"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height

              }),
              am5.LinePattern.new(this._root, {
                color: am5.color("#C500FF"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#FF0000"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              }),

              am5.LinePattern.new(this._root, {
                color: am5.color("#000000"),
                gap: gap,
                rotation: rotation,
                strokeWidth: strokeWidth,
                fillOpacity: fillOpacity,
                width: width,
                height: height
              })
            ];

            this.currentPattern = 0;
            this.rule("Slice").setAll({
              fillOpacity: 1
            });

            this.rule("Slice").setup = function(target) {
              target.set("fillPattern", theme.patterns[theme.currentPattern]);
              theme.currentPattern++;
              if (theme.currentPattern == theme.patterns.length) {
                theme.currentPattern = 0;
              }
            };
          }
        }

        const statusStructure = [
            "Complete", "Survey and for drafting", "For Survey",
            "For Reschedule", "Missing tag or structure or owner",
            "Refused", "NA"
        ];

    function updateChartStructure(municipal, barangay, priority) {
        root3.container.children.clear();
        var total_complete_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_complete_struc",
            statisticType: "sum"
        };

        var total_survdraft_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survdraft_struc",
            statisticType: "sum"
        };

        var total_survey_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_survey_struc",
            statisticType: "sum"
        };

        var total_resche_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_resche_struc",
            statisticType: "sum"
        };

        var total_miss_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_miss_struc",
            statisticType: "sum"
         };

        var total_refuse_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_refuse_struc",
            statisticType: "sum"
        };

        var total_na_struc = {
            onStatisticField: "CASE WHEN BasicPlan = 7 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_na_struc",
            statisticType: "sum"
        };  

        var query = structureLayer.createQuery();
        query.outStatistics = [total_complete_struc, total_survdraft_struc, total_survey_struc,
                               total_resche_struc, total_miss_struc, total_refuse_struc, total_na_struc];
        query.returnGeometry = true;

        structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const complete = stats.total_complete_struc;
            const survdraft = stats.total_survdraft_struc;
            const survey = stats.total_survey_struc;
            const resche = stats.total_resche_struc;
            const miss = stats.total_miss_struc;
            const refuse = stats.total_refuse_struc;
            const nna = stats.total_na_struc;

                    // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root3.setThemes([
          am5themes_Animated.new(root3),
          am5themes_Responsive.new(root3),
          MyTheme.new(root3)
        ]);

        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root3.container.children.push(
          am5percent.PieChart.new(root3, {
            paddingBottom: 10,
          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root3.verticalLayout
          })
        );

        // chart title
        chart.children.unshift(am5.Label.new(root3, {
            text: "Structure Basic Plan",
            fontSize: "1em",
            fontWeight: "bold",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            x: am5.percent(50),
            centerX: am5.percent(50),
        }));

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root3, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          //fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          tooltipText: "{category}: {value}",
          tooltipY: am5.percent(10),
          //fill: am5.color("#1e8553")//root3.interfaceColors.get("alternativeText"),
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;

          if (SELECTED == statusStructure[0]) {
            selectedStatus = 1;
            } else if (SELECTED == statusStructure[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusStructure[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusStructure[3]) {
                selectedStatus = 4;
            } else if (SELECTED == statusStructure[4]) {
                selectedStatus = 5;
            } else if (SELECTED == statusStructure[5]) {
                selectedStatus = 6;
            } else if (SELECTED == statusStructure[6]) {
                selectedStatus = 7;
            } else {
                selectedStatus = null;
            }

            var query = structureLayer.createQuery();
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay = '" + barangay + "'";
          const priorityExpression = "Priority1_1 = '" + priority + "'";
          const statusExpression = "BasicPlan = " + selectedStatus;

          if (municipal === 'None' && barangay === 'None' && priority === 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay === 'None' && priority !== 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority === 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }


          // Zoom, filter, and highlight selected chart categories 
          view.when(function() {
          view.whenLayerView(structureLayer).then(function (layerView) {

          structureLayer.queryFeatures(query).then(function(results) {
            const RESULT_LENGTH= results.features;
            const ROW_N = RESULT_LENGTH.length;

            let objID = [];
            for (var i=0; i < ROW_N; i++) {
              var obj = results.features[i].attributes.OBJECTID;
              objID.push(obj);
            }
            
            var queryExt = new Query({
              objectIds: objID
            });
            
            structureLayer.queryExtent(queryExt).then(function(result) {
              if (result.extent) {
                view.goTo(result.extent)
              }
            });
            
            if (highlightSelect) {
              highlightSelect.remove();
            }
            highlightSelect = layerView.highlight(objID);
            
            view.on("click", function() {
              layerView.filter = null;
              highlightSelect.remove();
            });
          }); // End of queryFeatures

          layerView.filter = {
            where: "BasicPlan = " + selectedStatus
          }
          }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusStructure[0],
              value: complete,
            },
            {
              category:  statusStructure[1],
              value: survdraft,
            },
            {
              category:  statusStructure[2],
              value: survey,
            },
            {
              category:  statusStructure[3],
              value: resche,
            },
            {
              category:  statusStructure[4],
              value: miss,
            },
            {
              category:  statusStructure[5],
              value: refuse,
            },
            {
              category:  statusStructure[6],
              value: nna,
            }
          ]
        );

                // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root3, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root3.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff"),

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box2');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(width - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 1.1,
        });

        pieSeries.appear(1000, 100);
        });  // End of queryFeature       
    } // End of updateChartStructure()


    // ------------------ PIE CHART FOR Brangay ----------------------//
    var root4 = am5.Root.new("pieChartBarangayDiv");

        const statusBarangay = [
            "Cooperative w/ assistance", "Cooperative w/out assistance", "For Coordination",
            "Quarantine/Reschedule", "Refused", "NA"
        ];

    function updateChartBarangay(municipal, barangay, priority) {
        root4.container.children.clear();
        var total_coopassist_barang = {
            onStatisticField: "CASE WHEN Coop = 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_coopassist_barang",
            statisticType: "sum"
        };

        var total_coopnoassist_barang = {
            onStatisticField: "CASE WHEN Coop = 2 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_coopnoassist_barang",
            statisticType: "sum"
        };

        var total_coord_barang = {
            onStatisticField: "CASE WHEN Coop = 3 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_coord_barang",
            statisticType: "sum"
        };

        var total_quaran_barang = {
            onStatisticField: "CASE WHEN Coop = 4 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_quaran_barang",
            statisticType: "sum"
        };

        var total_refuse_barang = {
            onStatisticField: "CASE WHEN Coop = 5 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_refuse_barang",
            statisticType: "sum"
        };

        var total_na_barang = {
            onStatisticField: "CASE WHEN Coop = 6 THEN 1 ELSE 0 END",
            outStatisticFieldName: "total_na_barang",
            statisticType: "sum"
        };  

        var query = barangayLayer.createQuery();
        query.outStatistics = [total_coopassist_barang, total_coopnoassist_barang, total_coord_barang,
                   total_quaran_barang, total_refuse_barang, total_na_barang];
        query.returnGeometry = true;

        barangayLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const coopassist = stats.total_coopassist_barang;
            const coopnoassist = stats.total_coopnoassist_barang;
            const coord = stats.total_coord_barang;
            const quaran = stats.total_quaran_barang;
            const refuse = stats.total_refuse_barang;
            const nna = stats.total_na_barang;

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root4.setThemes([
          am5themes_Animated.new(root4),
          am5themes_Responsive.new(root4)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root4.container.children.push(
          am5percent.PieChart.new(root4, {
            paddingBottom: 10,
          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root4.verticalLayout
          })
        );

        // chart title
        chart.children.unshift(am5.Label.new(root4, {
            text: "Cooperation (Barangay)",
            fontSize: "1em",
            fontWeight: "bold",
            textAlign: "center",
            fill: am5.color("#ffffff"),
            x: am5.percent(50),
            centerX: am5.percent(50),
        }));

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root4, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(85), // outer radius
            innerRadius: am5.percent(40),
          })
        );

        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color("#ffffff"),
          strokeWidth: 1,
          strokeOpacity: 1,
          templateField: "sliceSettings"
        });

        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);

        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          console.log(SELECTED)
          if (SELECTED == statusBarangay[0]) {
            selectedStatus = 1;
            } else if (SELECTED == statusBarangay[1]) {
                selectedStatus = 2;
            } else if (SELECTED == statusBarangay[2]) {
                selectedStatus = 3;
            } else if (SELECTED == statusBarangay[3]) {
                selectedStatus = 4;
            } else if (SELECTED == statusBarangay[4]) {
                selectedStatus = 5;
            } else if (SELECTED == statusBarangay[5]) {
                selectedStatus = 6;
            }

            var query = barangayLayer.createQuery();
            console.log(municipal + "; " + barangay + "; " + priority);
          const municipalExpression = "Municipality = '" + municipal + "'";
          const barangayExpression = "Barangay = '" + barangay + "'";
          const priorityExpression = "Priority1_1 = '" + priority + "'";
          const statusExpression = "Coop = " + selectedStatus;

          if (municipal === 'None' && barangay === 'None' && priority === 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay === 'None' && priority !== 'None') {
            query.where = statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority === 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal === 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay === 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority === 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;

          } else if (municipal !== 'None' && barangay !== 'None' && priority !== 'None') {
            query.where = municipalExpression + " AND " + barangayExpression + " AND " + statusExpression;
          }

          view.when(function() {
            view.whenLayerView(barangayLayer).then(function (layerView) {
              //chartLayerView = layerView;

              barangayLayer.queryFeatures(query).then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                barangayLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "Coop = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: statusBarangay[0],
              value: coopassist,
              sliceSettings: {
                fill: am5.color("#4CE600")
              }
            },
            {
              category: statusBarangay[1],
              value: coopnoassist,
              sliceSettings: {
                fill: am5.color("#73b2ff")
              }
            },
            {
              category: statusBarangay[2],
              value: coord,
              sliceSettings: {
                fill: am5.color("#FFFFFF")
              }
            },
            {
              category: statusBarangay[3],
              value: quaran,
              sliceSettings: {
                fill: am5.color("#FFAA00")
              }
            },
            {
              category: statusBarangay[4],
              value: refuse,
              sliceSettings: {
                fill: am5.color("#FF0000")
              }
            },
            {
              category: statusBarangay[5],
              value: nna,
              sliceSettings: {
                fill: am5.color("#000000")
              }
            },
          ]
        );

        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root4, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root4.verticalLayout,
          marginBottom: 10
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ffffff")

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        // To align legend items: valueLabels right, labels to left
        // 1. fix width of valueLabels
        // 2. dynamically change width of labels by screen size

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box3');
          const boxWidth = box.offsetWidth;
          var availableSpace = Math.max(boxWidth - chart.width() - 150, 180);
          //var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate",
          fill: am5.color("#ffffff")
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          fill: am5.color("#ffffff")
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 2,
        });
        
        pieSeries.appear(1000, 100);
        });  // End of queryFeature       
    } // End of updateChartBarangay()

        // Expropriation List----------------------------------
        const refusedListDiv = document.getElementById("refusedListDiv");
        
        refusedListLot();
        function refusedListLot() {
            // Obtain a list of Owner's names and status
            view.whenLayerView(lotLayer).then(function(lotlayerView) {
                lotlayerView.watch("updating", function(val) {
                    if (!val) {
                        // Query for only Expropriation lots
                        var query = new Query();
                        query.where = "Reqs = 7";
                        lotlayerView.queryFeatures(query).then(function(result) {
                            refusedListDiv.innerHTML = "";
                            result.features.forEach(function(feature) {
                                var attributes = feature.attributes;
                                
                                var li = document.createElement("li");
                                li.setAttribute("class", "panel-result");
                                
                                const status = attributes.Reqs;
                                if (status == 7) {
                                    statusla = "Refused"
                                }
                                
                                // Add Expropriation lots to list
                                li.innerHTML = "Lot ID: " + "<b>" + attributes.LotID + "</b>" + "<br>" + attributes.LandOwner + "</br>" + "<p>" + statusla + "</p>";

                                li.addEventListener("click", function(event) {
                                    var target = event.target;
                                    var objectId = feature.attributes.OBJECTID;
                                    var queryExtent = new Query({
                                        objectIds: [objectId]
                                    });
                                    
                                    // Query extent for selected expropriation lot in the list
                                    lotlayerView.queryExtent(queryExtent).then(function(result) {
                                        if (result.extent) {
                                            view.goTo({
                                                target: result.extent,
                                                speedFactor: 2,
                                                zoom: 17})
                                                .catch(function(error) {
                                                    if (error.name != "AbortError") {
                                                        console.error(error);
                                                    }
                                                }); // End of catch
                                            } // End of if (result.extent)
                                        }); // End of layerView.queryExtent
                                        
                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = lotlayerView.highlight([objectId]);
                                        view.on("click", function() {
                                            lotlayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    refusedListDiv.appendChild(li);
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
        }


        function refusedListBarangay() {
        
        // Obtain a list of Owner's names and status
        view.whenLayerView(barangayLayer).then(function(barangaylayerView) {
            barangaylayerView.watch("updating", function(val) {
                if (!val) {
                    // Query for only Expropriation lots
                    var query = new Query();
                    query.where = "Coop = 5";
                    barangaylayerView.queryFeatures(query).then(function(result) {
                        refusedListDiv.innerHTML = "";
                        result.features.forEach(function(feature) {
                            var attributes = feature.attributes;
                            
                            var li = document.createElement("li");
                            li.setAttribute("class", "panel-result");
                            
                            const status = attributes.Coop;
                            if (status == 5) {
                                statusla = "Refused"
                            }
                            
                            // Add Expropriation lots to list
                            li.innerHTML = "Municipality: " + "<b>" + attributes.Municipality + "</b>" + "<br>" + "Barangay: " + attributes.Barangay + "</br>" + "<p>" + statusla + "</p>";

                            li.addEventListener("click", function(event) {
                                var target = event.target;
                                var objectId = feature.attributes.OBJECTID;
                                var queryExtent = new Query({
                                    objectIds: [objectId]
                                });
                                
                                // Query extent for selected expropriation lot in the list
                                barangaylayerView.queryExtent(queryExtent).then(function(result) {
                                    if (result.extent) {
                                        view.goTo({
                                            target: result.extent,
                                            speedFactor: 2,
                                            zoom: 17})
                                            .catch(function(error) {
                                                if (error.name != "AbortError") {
                                                    console.error(error);
                                                }
                                            }); // End of catch
                                        } // End of if (result.extent)
                                    }); // End of layerView.queryExtent
                                    
                                    // Highlight selected lots
                                    if (highlightSelect) {
                                        highlightSelect.remove();
                                    }
                                    highlightSelect = barangaylayerView.highlight([objectId]);
                                    view.on("click", function() {
                                        barangaylayerView.filter = null;
                                        highlightSelect.remove();
                                    });
                                }); // End of li.addEventListener
                                refusedListDiv.appendChild(li);
                            }); // End of result.features.forEach
                        }); // End of layerView.queryFeatures
                    } // End of if (!val)
                }); // End of layerView.watch
            }); // End of view.whenLayerView
        }


        // Thousand separators function
        function thousands_separators(num) {
          var num_parts = num.toString().split(".");
          num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return num_parts.join(".");
        }
        
        // 1. Total Number of Lots
        function totalNumberOfLots(){
          var totalLot = {
            onStatisticField: "CASE WHEN Reqs >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalLot",
            statisticType: "sum"
          };
          var query = lotLayer.createQuery();
          query.outStatistics = [totalLot];
          query.returnGeometry = true;

          lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;
            const LOT_TOTAL = thousands_separators(stats.totalLot);

            lotNumberDiv.innerHTML = `<b>Number of Lots</b><br><br>${LOT_TOTAL}`;
          });
        }

        totalNumberOfLots();

        // Total number of structures
        function totalNumberOfStructures(){
          var totalStructure = {
            onStatisticField: "CASE WHEN BasicPlan >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalStructure",
            statisticType: "count"
          };
          var query = structureLayer.createQuery();
          query.outStatistics = [totalStructure];
          query.returnGeometry = true;

          structureLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
            structureNumberDiv.innerHTML = `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;
          });
        }
        totalNumberOfStructures();

        // Dropdown List
        view.when(function() {
            return lotLayer.when(function() {
                var query = lotLayer.createQuery();
                return lotLayer.queryFeatures(query);
            });
        })
        .then(getValues)
        .then(getUniqueValues)
        .then(addToSelect)

        function queryForLotGeometries() {
            var lotQuery = lotLayer.createQuery();

            return lotLayer.queryFeatures(lotQuery).then(function(response) {
                lotGeometries = response.features.map(function(feature) {
                    return feature.geometry;
                });
                return lotGeometries;
            });
        }

    // 1. Get values and return to drop down list
    // 1.1. Municipality
    function getValues(response) {
        var features = response.features;
        var values = features.map(function(feature) {
            return feature.attributes.Municipality;
        });
        return values;
    }
    
    // Return an array of unique values in the 'Municipality' field of the lot Layer
    function getUniqueValues(values) {
        var uniqueValues = [];
    
        values.forEach(function(item, i) {
            if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
                uniqueValues.push(item);
            }
        });
        return uniqueValues;
    }
    
    // Add the unique values to the municipalility select element. this will allow the user
    // to filter lot layer by municipality.
    function addToSelect(values) {
        values.sort();
        values.unshift('None'); // Add 'None' to the array and place it to the beginning of the array
        values.forEach(function(value) {
            var option = document.createElement("option");
            option.text = value;
            municipalSelect.add(option);
        });
    }
    
    // 1.2. Barangay
    function barangayFilterList(municipalValue) {
        var barangayArray = [];

        function barangayQuery() {
            var query = lotLayer.createQuery();
            if (municipalValue === undefined || municipalValue === 'None') {
                query.where = "1=1";
            } else if (municipalValue !== 'None') {
                query.where = "Municipality = '" + municipalValue + "'";
            }
        
            return lotLayer.queryFeatures(query).then(function(response) {
                stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const barangay = attributes.Barangay;
                    barangayArray.push(barangay);
                });
                return barangayArray;
            });
        }

        function getUniqueValues2(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
                if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                    uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
        }

        function addToSelectQuery2(query2Values) {
            barangaySelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                barangaySelect.add(option);
            });
        }

        barangayQuery()
        .then(getUniqueValues2)
        .then(addToSelectQuery2)
    }
    barangayFilterList();

    // 1.3. Handover date
    function priorityFilterList(municipalValue, barangayValue) {
        var priorityArray = [];

        function priorityQuery() {
            var query = lotLayer.createQuery();
            if (municipalValue === undefined && barangayValue === undefined) {
                query.where = "1=1";
            
            // Municipality: None, barangayValue: !None
            } else if (municipalValue === 'None' && barangayValue !== 'None') {
                query.where = "Barangay = '" + barangayValue + "'";
            
            // Municipality: None, barangayValue: None
            } else if (municipalValue === 'None' && barangayValue === 'None') {
                query.where = "1=1";
            
            // Municipality: !None, barangayValue: None
            } else if (municipalValue !== 'None' && barangayValue === 'None') {
                query.where = "Municipality = '" + municipalValue + "'";
            
            // Municipality: !None, barangayValue: !None
            } else if (municipalValue !== 'None' && barangayValue !== 'None') {
                query.where = "Municipality = '" + municipalValue + "'" + " AND " + "Barangay = '" + barangayValue + "'";
            }
        
            return lotLayer.queryFeatures(query).then(function(response) {
                stats = response.features;
                stats.forEach((result, index) => {
                    const attributes = result.attributes;
                    const priority = attributes.Priority1_1;
                    priorityArray.push(priority);
                });
                return priorityArray;
            });
        }


        function getUniqueValues3(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
                if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
        }
    
        function addToSelectQuery3(query2Values) {
            prioritySelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                prioritySelect.add(option);
            });
            return query2Values;
        }

        priorityQuery()
        .then(getUniqueValues3)
        .then(addToSelectQuery3);
    }
    priorityFilterList();

    // Set the definition expression on the lot layer
    // to reflect the selecction of the user
    // Only for Municipality
    function setMunicipalExpression(municipal) {
        const municipalityExpression = "Municipality = '" + municipal + "'";
        if (municipal == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            priorityLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            barangayLayer.definitionExpression = null;

        } else {
            lotLayer.definitionExpression = municipalityExpression;
            structureLayer.definitionExpression = municipalityExpression;
            priorityLayer.definitionExpression = municipalityExpression;
            pnrLayer.definitionExpression = municipalityExpression;
            barangayLayer.definitionExpression = municipalityExpression;
        }
        zoomToLayer(lotLayer);

        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }

    // for Municipcality + Barangay + Priority
    function setMunicipalBarangayPriorityExpression(municipal, barangay, priority) {
        //var municipal = municipalSelect.options[municipalSelect.selectedIndex].value;
        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        //var priori = prioritySelect.options[prioritySelect.selectedIndex].value;
        const priorityExpression = "Priority1_1 = '" + priority + "'";
        const municipalityExpression = "Municipality = '" + municipal + "'";
        const barangayExpression = "Barangay = '" + barangay + "'";

        // all = 'None'
        if (municipal == 'None' && barangay == 'None' && priority == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            priorityLayer.definitionExpression = null;
            pnrLayer.definitionExpression = null;
            barangaylayer.definition = null;

        } else if (municipal == 'None' && barangay == 'None' && priority !== 'None') {
            lotLayer.definitionExpression = priorityExpression;
            //structureLayer.definitionExpression = priorityExpression;
            priorityLayer.definitionExpression = priorityExpression;
            pnrLayer.definitionExpression = priorityExpression;

        } else if (municipal == 'None' && barangay !== 'None' && priority == 'None') {
            lotLayer.definitionExpression = barangayExpression;
            structureLayer.definitionExpression = barangayExpression;
            priorityLayer.definitionExpression = barangayExpression; 
            pnrLayer.definitionExpression = barangayExpression;
            barangayLayer.definitionExpression = barangayExpression;

        } else if (municipal == 'None' && barangay !== 'None' && priority !== 'None') {
            lotLayer.definitionExpression = barangayExpression + " AND " + priorityExpression;
            structureLayer.definitionExpression = barangayExpression;
            priorityLayer.definitionExpression = barangayExpression + " AND " + priorityExpression;
            pnrLayer.definitionExpression = barangayExpression + " AND " + priorityExpression;
            barangayLayer.definitionExpression = barangayExpression; 

        } else if (municipal !== 'None' && barangay == 'None' && priority == 'None') {
            lotLayer.definitionExpression = municipalityExpression;
            structureLayer.definitionExpression = municipalityExpression;
            priorityLayer.definitionExpression = municipalityExpression;
            pnrLayer.definitionExpression = municipalityExpression;
            barangayLayer.definitionExpression = municipalityExpression;

        } else if (municipal !== 'None' && barangay == 'None' && priority !== 'None') {
            lotLayer.definitionExpression = municipalityExpression + " AND " + priorityExpression;
            structureLayer.definitionExpression = municipalityExpression;
            priorityLayer.definitionExpression = municipalityExpression + " AND " + priorityExpression;
            pnrLayer.definitionExpression = municipalityExpression + " AND " + priorityExpression;
            barangayLayer.definitionExpression = municipalityExpression;

        } else if (municipal !== 'None' && barangay !== 'None' && priority == 'None') {
            lotLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            structureLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            priorityLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression; 
            pnrLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            barangayLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;

        } else {
            lotLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression + " AND " + priorityExpression;
            structureLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
            priorityLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression + " AND " + priorityExpression;
            pnrLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression + " AND " + priorityExpression;
            barangayLayer.definitionExpression = municipalityExpression + " AND " + barangayExpression;
        }


        //var barang = barangaySelect.options[barangaySelect.selectedIndex].value;
        if (!lotLayer.visible) {
            lotLayer.visible = true;
        }
        return queryForLotGeometries();
    }


    
    // When CP is changed, Type is reset to 'None'
    const changeSelected = (e) => {
        const $select = document.querySelector('#prioritySelect');
        $select.value = 'None'
    };


    // Dropdown List
    // Select Municipality from dropdown list
    municipalSelect.addEventListener("change", function() {
        const municipal = event.target.value;
        const barangay = barangaySelect.value;
        const priority = prioritySelect.value;

        setMunicipalExpression(municipal);
        changeSelected();

        barangayFilterList(municipal);
        priorityFilterList(municipal, barangay);

        totalNumberOfLots();
        totalNumberOfStructures();
        updateChartLot(municipal, barangay, priority);
        updatePriorityChartLot(municipal, barangay, priority);
        updateChartStructure(municipal, barangay, priority);
        updateChartBarangay(municipal, barangay, priority);

        zoomToLayer(lotLayer);
    });

        barangaySelect.addEventListener("change", function() {
            const municipal = municipalSelect.value;
            const barangay = event.target.value;
            const priority = prioritySelect.value;

            setMunicipalBarangayPriorityExpression(municipal, barangay, priority);
            changeSelected();

            priorityFilterList(municipal, barangay);
            
            totalNumberOfLots();
            totalNumberOfStructures();
            updateChartLot(municipal, barangay, priority);
            updatePriorityChartLot(municipal, barangay, priority);
            updateChartStructure(municipal, barangay, priority);
            updateChartBarangay(municipal, barangay, priority);

            zoomToLayer(lotLayer);
        //relocationObjectID(reloStatusLayer);
    });


    prioritySelect.addEventListener("change", function() {
        const municipal = municipalSelect.value;
        const barangay = barangaySelect.value;
        const priority = event.target.value;

        setMunicipalBarangayPriorityExpression(municipal, barangay, priority);

        totalNumberOfLots();
        totalNumberOfStructures();
        updateChartLot(municipal, barangay, priority);
        updatePriorityChartLot(municipal, barangay, priority);
        updateChartStructure(municipal, barangay, priority);
        updateChartBarangay(municipal, barangay, priority);

        //zoomToLayer(lotLayer);
        //relocationObjectID(reloStatusLayer);

        let arrLviews = [];

        view.whenLayerView(lotLayer).then(function (layerView) {
            arrLviews.push(layerView);
            lotLayer.queryFeatures().then(function(results) {
                const ggg = results.features;
                const rowN = ggg.length;

                let objID = [];
                for (var i=0; i < rowN; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                    objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                    layerView.filter = null;
                    highlightSelect.remove();
                });
            }); // End of queryFeatures
        }); // End of view.whenLayerView

        view.whenLayerView(pnrLayer).then(function (layerView) {
            arrLviews.push(layerView);
            pnrLayer.queryFeatures().then(function(results) {
                const ggg = results.features;
                const rowN = ggg.length;

                let objID = [];
                for (var i=0; i < rowN; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                    objectIds: objID
                });

                pnrLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                    layerView.filter = null;
                    highlightSelect.remove();
                });
            }); // End of queryFeatures
        }); // End of view.whenLayerView

        for(var i = 0; i < arrLviews.length; i++) {
            arrLviews[i].filter = {
                where: "Priority1_1 = '" + type + "'"
            }
        }
    });


    updateChartLot('None', 'None', 'None');
    updatePriorityChartLot('None', 'None', 'None');
    updateChartBarangay('None', 'None', 'None');
    updateChartStructure('None', 'None', 'None');

      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "SC1 SUBCONTRACTOR";
        document.querySelector("#item-description").innerHTML = `1. You can opt for either <b>light theme or dark theme</b> for a window screen via a switch icon in the upper right.<br>
                                                                 2. You can <b>filter the data</b> by City, Barangy, and Priority Lots using dropdown lits.<br>
                                                                 3. You can view summary statistics and progress on acquisition of land/structure/Barangay in charts.<br>
                                                                 4. <b>Click pie chart</b> to view lots/structures on the map corresponding to the selected progress.<br>
                                                                 5. <b>Lots under refusal</b> is available in the 'Refusing List' tab under the theme switch.<br>
                                                                 6. Click/unclick widgets icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                                 7. <b>Toggle a checkbox</b> in 'Refuse' tab to switch the list of refused lots or Barangay.`
                                                                 ;
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;

    }); // end of view.when

      });// End of am4chart

      
      // Widgets
      
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "Chainage" ||
              item.title === "Pier Access Date" ||
              item.title === "Free-and-Clear Area" ||
              item.title === "Station Box"){
            item.visible = false
          }
        }
      });
      
      const legend = new Legend({
        view,
        container: "legend-container"
      });

      const locate = new Locate({
        view: view,
        container: "locate-container"
      });

      var searchWidget = new Search({
        view: view,
        container: "search-container",
        locationEnabled: false,
        allPlaceholder: "LotID, StructureID, Chainage",
        includeDefaultSources: false,
        sources: [
          {
            layer: lotLayer,
            searchFields: ["LotID"],
            displayField: "LotID",
            exactMatch: false,
            outFields: ["LotID"],
            name: "Lot ID",
            placeholder: "example: 10083"
          },
          {
            layer: structureLayer,
            searchFields: ["StrucID"],
            displayField: "StrucID",
            exactMatch: false,
            outFields: ["StrucID"],
            name: "Structure ID",
            placeholder: "example: MCRP-01-02-ML022"
          },
          {
            layer: chainageLayer,
            searchFields: ["KmSpot"],
            displayField: "KmSpot",
            exactMatch: false,
            outFields: ["*"],
            name: "Main KM",
            placeholder: "example: 80+400"
          },
          {
            layer: pierNoLayer,
            searchFields: ["PIER"],
            displayField: "PIER",
            exactMatch: false,
            outFields: ["PIER"],
            name: "Pier No",
            zoomScale: 1000,
            placeholder: "example: P-288"
          }
        ]
        });

        view.ui.empty("top-left");

        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search",
            group: "top-right"
        });
        view.ui.add(searchExpand, {
            position: "top-right"
        });

        searchExpand.watch("expanded", function() {
            if(!searchExpand.expanded) {
                searchWidget.searchTerm = null;
            }
        });


    });
  </script>
</html>