<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about working on Building Scene Layer
  https://pro.arcgis.com/en/pro-app/2.7/help/mapping/layer-properties/maintain-and-work-with-a-building-scene-layer.html
  https://www.youtube.com/watch?v=maEXHMI9ddQ

  # BuildingFiler
  https://developers.arcgis.com/javascript/latest/api-reference/esri-layers-support-BuildingFilter.html

  -->
<title>Station Structure (N2)</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
<script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

<!-- Resources -->
<script src="https://unpkg.com/three@0.144.0/build/three.js"></script>
<script src="https://unpkg.com/three@0.144.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
<script src="https://js.arcgis.com/4.26/"></script>

  </head>

  <style>
  html,
  body,
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }

  calcite-button {
    position: fixed;
    z-index: 1;
    bottom: 5%;
    right: 1%;
  }

  calcite-label {
    position: fixed;
    z-index: 1;
    bottom: 1%;
    right: 1%;
    vertical-align: middle;
    background-color: rgb(52, 52, 52);
    text-align: center;
    padding: 7;
  }

  #headerTitleDiv {
    font-size: 2vw;
    vertical-align: middle;
    padding-top: 3px;
    z-index: 99;
    position: absolute;
    left: 13;
    top: 18;
    color: white;
  }

  #see-through-label {
    padding-top: 10;
    padding-bottom: 0;
    display: flex;
    align-self: center;
    position: absolute;
    z-index: 1;
    bottom: 2vw;
    right: 10;
  }


  #chartPanel {
    display: inline-block;
    width: 100%;
    height: 100%;
  }

  #chartdiv {
    width: 20vw;
    height: 37vh;
    align-items: center;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    padding: 0;
    margin: 0;
  }

  .labelStFraming,
  .labelStFoundation,
  .labelStColumn,
  .labelFloors,
  .labelWalls,
  .labelColumns {
    color: white;
    font-size: 1.3vw;
    margin: 0;
    padding-top: 5;
    float: right;
    background-color: rgb(0, 0, 0, 0);
    height: 4vh;
    text-align: center;
  }
  
  #labelTotalDiv {
    color: white;
    font-size: 1.5vw;
    width: 100%;
    height: 3.5vh;
    padding-top: 6;
    text-align: center;
  }
  
  #boxStFoundation {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 0.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxStColumn {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 11.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxStFraming {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 22.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxFloors {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 33.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxWalls {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 44.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxColumns {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 55.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #boxTotal {
    display: grid;
    position: fixed;
    z-index: 99;
    background-image: linear-gradient(rgb(0,0,0,0), rgb(0,185,242,0.4));
    border-color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    background-color: rgb(0,0,0,0.5);
    bottom: 1%;
    left: 66.5%;
    color: white;
    font-size: 2vw;
    width: 10.8vw;
    height: 14vh;
    text-align: center;
  }
  
  #chartStFramingDiv,
  #chartStFoundationDiv,
  #chartStColumnDiv,
  #chartFloorsDiv,
  #chartWallsDiv,
  #chartColumnsDiv {
    padding: 0;
    margin: 0;
    align-items: center;
    background-color: rgb(0,0,0,0);
    width: 100%;
    height: 11vh;
  }
  
  #totalProgressDiv {
    color: rgb(0, 197, 255);
    font-size: 2.5vw;
    width: 100%;
    height: 100%;
    background-color: rgb(0, 0, 0, 0);
    text-align: center;
  }

  .panel {
    padding: 0px;
    margin:0;
    box-sizing: border-box;
    width: 13vw;
    height: 40vh;
    position: fixed;
    top: 12vw;
    right: 1;
    font-size: 1.3vw;
    color: white;
    background-color: rgb(0, 0, 0, 0);
    z-index: 1;
    transition: 3;
    line-height: 2;
  }

  .active, .test:hover {
    background-color: rgba(77, 75, 75, 0);
    color: orange;
    font-size: 1.7vw;
  }


  .dateDiv {
    color: rgb(0, 197, 255);
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    text-align: left;
    font-weight: normal;
    font-size: 1.1vw;
    padding-top: 20px;
    margin: 0;
    z-index:99;
    top: 55;
    left: 20;
    position:absolute;
  }

  #menu {
    position: absolute;
    padding: 0.8em;
    max-width: 250px;
    background-color: rgb(0, 0, 0, 0);
    z-index: 99;
    bottom: 13rem;
    right: 5;
  }

  #menu1 {
    padding: 0.8em;
    width: 250px;
    z-index: 99;
    position: absolute;
    right: 0;
  }

  #sliceContainer {
    width: inherit;
  }

  #sliceOptions {
    margin: 0 15px;
  }

  #sliceOptions>button {
    margin-bottom: 15px;
  }

  #sliceContainer {
    max-width: 228px;
  }

  br{content:' ';}
  br:after{content:' ';}

  .esri-layer-list__item-toggle-icon,
  .esri-layer-list__item-title {
    color: white;
  }

    .sassy-theme .esri-menu,
    .sassy-theme .esri-building-explorer,
    .sassy-theme .esri-popup__main-container,
    .sassy-theme .esri-popup .esri-popup__pointer-direction,
    .sassy-theme .esri-popup .esri-popup__button,
    .sassy-theme .esri-button,
    .sassy-theme .esri-input,
    .sassy-theme .esri-legend,
    .sassy-theme .esri-layer-list,
    .sassy-theme .esri-widget a {
      background-color: rgb(0, 0, 0, 0.5);
      color: #fff;
    }

  ::-webkit-scrollbar {
    display: none;
  }

  .sassy-theme .esri-legend__layer-caption {
    display: none;
  }

  .overlay {
    position: absolute;
    z-index: 1;
    top: 11.5vw;
    right: 7;
    background-color: rgba(80, 80, 80, 0);
    /*text-align: center;*/
  }

  .button {
    cursor: pointer;
    font-size: 12pt !important;
    font-weight: bold !important;
    color: rgb(230, 230, 230);
  }

  .button:hover, #label {
    color: white;
  }

  .button, #label {
    margin: 15px;
  }

  .esri-view-surface--inset-outline:focus::after {
    outline: none !important;
  }

  ::-webkit-scrollbar {
      width: 5px;
      
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #00032235; /*#032235*/
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #FFBA1F;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #b98816;
    }

    .esri-legend__layer-caption {
        display: none;
      }


  #basemaps-pos {
    position: absolute;
    z-index: 1;
    top: 100;
    left: 10;
    overflow-y: auto;
  }


  </style>

  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <div id="viewDiv">
        <div class="dateDiv">As of May 31, 2023</div>
        <div class="panel">
          <ul id="stationList">
            <li style="display:block" class="test active" id="Calumpit">Calumpit</li>
            <li style="display:block" class="test" id="Apalit">Apalit</li>
            <li style="display:block" class="test" id="San Fernando">San Fernando</li>
            <li style="display:block" class="test" id="Angeles">Angeles</li>
            <li style="display:block" class="test" id="Clark">Clark</li>
            <li style="display:block" class="test" id="CIA">CIA</li>
          </ul>
        </div>
        <div id="headerTitleDiv">N2 STATION STRUCTURE</div>
        <div id="boxStFoundation">
          <label class="labelStFoundation">St.Foundation</label>
          <div id="chartPanel">
              <div id="chartStFoundationDiv"></div>
          </div>
        </div>
        <div id="boxStColumn">
          <label class="labelStColumn">St.Column</label>
          <div id="chartPanel">
            <div id="chartStColumnDiv"></div>
        </div>
        </div>
        <div id="boxStFraming">
            <label class="labelStFraming">St.Framing</label>
            <div id="chartPanel">
              <div id="chartStFramingDiv"></div>
          </div>
        </div>
        <div id="boxFloors">
            <label class="labelFloors">Floors</label>
            <div id="chartPanel">
              <div id="chartFloorsDiv"></div>
          </div>
        </div>
        <div id="boxWalls">
            <label class="labelWalls">Walls</label>
            <div id="chartPanel">
              <div id="chartWallsDiv"></div>
          </div>
        </div>
        <div id="boxColumns">
            <label class="labelColumns">Columns</label>
            <div id="chartPanel">
              <div id="chartColumnsDiv"></div>
          </div>
        </div>
        <div id="boxTotal">
            <div id="labelTotalDiv">TOTAL</div>
            <div id="totalProgressDiv"></div>
        </div>
        <calcite-label layout="inline" id="see-through-label">
          <calcite-checkbox id="myLink"></calcite-checkbox>See-through-Ground
        </calcite-label>
        <div class="overlay">
          <div>
            <span id="play" class="button esri-icon-play" style="display: block;" />
          </div>
          <div>
            <span id="pause" class="button esri-icon-pause" style="display: none;" />
          </div>
        </div>
      </div>
    </calcite-shell>
  </body>

  <script>
    require([
      "esri/Basemap",
      "esri/Map",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/widgets/BasemapGallery",
      "esri/layers/FeatureLayer",
      "esri/layers/support/FeatureFilter",
      "esri/layers/SceneLayer",
      "esri/layers/Layer",
      "esri/layers/TileLayer",
      "esri/layers/VectorTileLayer",
      "esri/layers/support/LabelClass",
      "esri/symbols/LabelSymbol3D",
      "esri/WebMap",
      "esri/WebScene",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/widgets/TimeSlider",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/Fullscreen",
      "esri/rest/geometryService",
      "esri/rest/support/Query",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/TimeExtent",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/support/DatePicker",
      "esri/widgets/FeatureTable",
      "esri/widgets/Compass",
      "esri/layers/ElevationLayer",
      "esri/Ground",
      "esri/layers/BuildingSceneLayer",
      "esri/widgets/BuildingExplorer",
      "esri/widgets/Slice",
      "esri/analysis/SlicePlane",
      "esri/renderers/SimpleRenderer",
      "esri/symbols/MeshSymbol3D",
      "esri/symbols/edges/SolidEdges3D",
      "esri/layers/GroupLayer",
      "esri/geometry/Point",
      "esri/Camera",
      "esri/core/reactiveUtils"
      ], function(Basemap, Map, MapView, SceneView, BasemapGallery,
                FeatureLayer, FeatureFilter,
                SceneLayer, Layer, TileLayer, VectorTileLayer,
                LabelClass, LabelSymbol3D, WebMap,
                WebScene, PortalItem, Portal,
                TimeSlider, Legend, LayerList, Fullscreen,
                geometryService, Query,
                StatisticDefinition, WebStyleSymbol,
                TimeExtent, Expand, Editor, UniqueValueRenderer, DatePicker,
                FeatureTable, Compass, ElevationLayer, Ground,
                BuildingSceneLayer, BuildingExplorer, Slice, SlicePlane,
                SimpleRenderer, MeshSymbol3D, SolidEdges3D, GroupLayer, Point, Camera, reactiveUtils) {


////////////////////////////////////////////////////
const webscene = new WebScene({
  portalItem: {
    id: "88913adb6161401fbe070d6aa86e45f3"
  }
});

  var view = new SceneView({
    map: webscene,
    container: "viewDiv",
    viewingMode: "local",
    camera: {
      position: {
        x: 120.770421,
        y: 14.902323,
        z: 500
      },
      tilt: 65
    },
    environment: {
      background: {
        type: "color", // autocasts as new ColorBackground()
        color: [0, 0, 0, 1]
      },
      // disable stars
      starsEnabled: false,
      //disable atmosphere
      atmosphereEnabled: false
    }
  });

  view.ui.components = [];

    
  // Station structures
  const buildingLayer = new BuildingSceneLayer({ 
    portalItem: {
      id: "19fcf150d0474029a49643408a7c17dc", 
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
  outFields: ["*"],
  title: "N2 Station Structures"
  });
  webscene.layers.add(buildingLayer);
  view.ui.empty("top-left");

  const buildingExplorer = new BuildingExplorer({
    view: view,
    layers: [buildingLayer]
  });

  const buildingExplorerExpand = new Expand({
    view,
    content: buildingExplorer,
    expandIconClass: "esri-icon-layers",
    expandTooltip: "Building Explorer"
  });
  view.ui.add(buildingExplorerExpand, "top-right")
  //view.ui.add(buildingExplorer, "bottom-right");

  // only display the building levels filter
  buildingExplorer.visibleElements = {
    phases: false,
    disciplines: false
  };

  // Discipline: Architectural
  var columnsLayer = null;
  var floorsLayer = null;
  var wallsLayer = null;

  // Discipline: Structural
  var stFramingLayer = null;
  var stColumnLayer = null;
  var stFoundationLayer = null;

  const excludedLayers = [];

  buildingLayer.when(() => {
    // Iterate through the flat array of sublayers and extract the ones
    // that should be excluded from the slice widget
    buildingLayer.allSublayers.forEach((layer) => {
      // modelName is standard accross all BuildingSceneLayer,
      // use it to identify a certain layer
      switch (layer.modelName) {
        // Because of performance reasons, the Full Model view is
        // by default set to false. In this scene the Full Model should be visible.
        case "FullModel":
          layer.visible = true;
          break;
        
        case "ExteriorShell":
          layer.visible = false;
          excludedLayers.push(layer);
          break;
        
          case "Columns":
            columnsLayer = layer;
            //excludedLayers.push(layer);
            break;

          case "Floors":
            floorsLayer = layer;
            //excludedLayers
            break;

          case "Walls":
            wallsLayer = layer;
            break;
                
          case "StructuralFraming":
            stFramingLayer = layer;
            break;
          
          case "StructuralColumns":
            stColumnLayer = layer;
            break;
          
          case "StructuralFoundation":
            stFoundationLayer = layer;
            break;
            
          default:
            layer.visible = true;
        }
    });
    // setSliceWidget();
  });

  buildingLayer.when(() => {
      const defaultStation = "Station = 8";
      columnsLayer.definitionExpression = defaultStation;
      floorsLayer.definitionExpression = defaultStation;
      wallsLayer.definitionExpression = defaultStation;
    
      stFramingLayer.definitionExpression = defaultStation;
      stColumnLayer.definitionExpression = defaultStation;
      stFoundationLayer.definitionExpression = defaultStation;
    
      columnsLayer.visible = true;
      floorsLayer.visible = true;
      wallsLayer.visible = true;
      //windowsLayer.visible = true;
    
      stFramingLayer.visible = true;
      stColumnLayer.visible = true;
      stFoundationLayer.visible = true;
    
      zoomToLayer(stFramingLayer);
    });

  /* Function for zooming to selected layers */
  function zoomToLayer(layer) {
    return layer.queryExtent().then(function(response) {
      view.goTo(response.extent, { //response.extent
        speedFactor: 2
      }).catch(function(error) {
        if (error.name != "AbortError") {
          console.error(error);
        }
      });
    });
  }


  // See-through-Ground
  view.when(function() {
    // allow navigation above and below the ground
    webscene.ground.navigationConstraint = {
      type: "none"
    };
    // the webscene has no basemap, so set a surfaceColor on the ground
    webscene.ground.surfaceColor = "#fff";
            
    // to see through the ground, set the ground opacity to 0.4
    webscene.ground.opacity = 0.9;
  });
            
  document.getElementById("myLink").addEventListener("click", function(event) {
      const checked = event.srcElement.checked;
      webscene.ground.opacity = event.srcElement.checked ? 0.1 : 0.6;
  });

  var layerList = new LayerList({
    view: view,
    listItemCreatedFunction: function(event) {
      const item = event.item;
      if (item.title === "Architectural" ||
          item.title === "ExteriorShell"){
        item.visible = false
      }
    }
  });

  var layerListExpand = new Expand ({
    view: view,
    content: layerList,
    expandIconClass: "esri-icon-visible",
    group: "top-right"
  });

  view.ui.add(layerListExpand, {
    position: "top-right"
  });


  let basemapGallery = new BasemapGallery({
    view: view
  });

  const basemapGalleryExpand = new Expand({
    view,
    content: basemapGallery,
    expandIconClass: "esri-icon-basemap",
    group: "top-right"
  });
  // Add widget to the top right corner of the view
  view.ui.add(basemapGalleryExpand, {
    position: "top-right"
  });

  // Full screen logo
  view.ui.add(
    new Fullscreen({
    view: view,
    element: viewDiv
  }),
  "top-right"
  );
  });
  </script>
</html>