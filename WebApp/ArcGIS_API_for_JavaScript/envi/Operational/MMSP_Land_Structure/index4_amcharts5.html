<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>MMSP Land Acquisition</title>
    
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>
    
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.3/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.3/calcite.css" />

    <script src="https://js.arcgis.com/4.25/"></script>
    <link disabled id="arcgis-maps-sdk-theme-dark" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css" />
    <link id="arcgis-maps-sdk-theme-light" rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />

  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      display: flex;
    }

    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    
    calcite-label {
      --calcite-label-margin-bottom: 0px;
    }

    calcite-tabs {
      width: 17vw;
      margin-right: 3.3rem;
    }

    calcite-tab {
      width: 17vw;
        height: 83vh;
    }

    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
    }

    #info-content {
      padding: 0.75rem;
    }

    calcite-rating {
      margin-top: 0.25rem;
    }
    
    #header {
      display: flex;
      padding: 0 1rem;
      background-color: var(--calcite-ui-foreground-1);
    }

    #header-controls {
      display: flex;
      margin-inline-start: auto;
      align-self: center;
    }

    .label-wrapper {
      display: flex;
      margin-inline: 1rem;
      padding: 0.5rem;
      border: 1px solid var(--calcite-ui-border-1);
      cursor: pointer;
    }

    calcite-switch {
      margin: 0 0.5rem;
    }

    

    #pieChartLotDiv,
    #pieChartStructureDiv {
      height: 45%;
    }

    /* Radio Button for handed-over lots */
    #handedOverButton {
      position: fixed;

    }

    
    #lotNumberDiv,
    #handedOverLotNumberDiv,
    #structureNumberDiv,
    #isfNumberDiv {
      color: rgb(0, 197, 255);
      text-align: center;
      font-weight: normal;
      font-size: 1.5vw;
      border: solid 0.5px gray;
      padding-top: 1%;
      padding-bottom: 4%;
    }

    #lotNumberDiv b,
    #handedOverLotNumberDiv b,
    #structureNumberDiv b,
    #isfNumberDiv b {
      font-size: 1.0vw;
      font-family: 'Calibri';
      font-weight: bold;
      color:rgb(250, 246, 246);
    }

    br {
      content: "";
      margin: 2em;
      display: block;
      font-size: 24%;
    }

    b {
        color: orange;
    }

    #dateDiv {
      font-size: 0.85vw;
      text-align: right;
      display: flex;
      align-items: flex-end;
      font-weight: bold;
    }

    /* Expropriation List */
    /** clear background color of list box **/
    .panel-side {
      background-color: rgb(0, 0, 0, 0);
      margin-top: 1%;
    }

    /** adjust line height between texts **/
    .panel-side li {
      padding: 1% 1%;
    }

    /** adjust lot ID's font size and color **/
    .panel-side li b{
      color: red;
      font-size: 0.8vw;
    }

    .panel-result {
      cursor: pointer;
      margin: 0px 0;
    }

    .panel-result:hover,
    .panel-result:focus,
    .panel-result.selected {
      background-color: rgba(73, 72, 72, 0.5);
    }

    #expropriationListDiv {
      list-style: none;
      padding: 0.5%;
      padding-right: 5%;
      font-size: 0.8vw;
      width: 17vw;

    }

    /* MOA Chart */
    #chartMoaLotDiv,
    #chartMoaStructureDiv {
        width: 100%;
        height: 35%;
        align-items: center;
        padding: 1%;
    }

    /* Dropdown list */
    #dropdownDiv {
      background-color: rgb(0, 0, 0, 0);
        width: 50%;
        opacity: 1;
        color: black;
        text-align: right;
        margin: auto;
    }

    /* Browser Setting */
    ::-webkit-scrollbar {
        display: none;
    }
    
    /*  */
    .sassy-theme .esri-legend__layer-caption {
      display: none;
    }

  </style>
  <body class="sassy-theme">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      
       <!--  Header slot  -->
      <div slot="header" id="header">
        
      <!-- Title -->
      <h2 id="header-title" slot="header"></h2>

      <div id="dateDiv">February 6, 2023</div>

      <!-- Dropdown Lists -->
      <div id="dropdownDiv" class="esri-widget">
        <label id="dropdownContractPackageLabel">
          CP:
          <select id="packageSelect" class="esri-widget"></select>
        </label>
        <label id="dropdownLandTypeLabel">
          Land Type:
          <select id="landTypeSelect" class="esri-widget"></select>
        </label>
        <label id="dropdownStationTypeLabel">
          Section:
          <select id="stationSelect" class="esri-widget"></select>
        </label>
      </div>

      <!-- Controls -->
        <div id="header-controls">
          <!-- Dark Mode Switch -->
          <calcite-label layout="inline" class="label-wrapper">
            <calcite-icon icon="brightness" scale="s" class="switch-icon"></calcite-icon>
            <calcite-switch></calcite-switch>
            <calcite-icon icon="moon" scale="s" class="switch-icon"></calcite-icon>
          </calcite-label>
        </div>
      </div>

      <!-- Icon -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="locate" icon="gps-on-f" text="My Location"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>
        <calcite-panel heading="Click the icon below" width-scale="w" data-panel-id="locate" hidden>
          <div id="locate-container"></div>
        </calcite-panel>

        
        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <div id="viewDiv">
                <!-- Chart Panel -->
        <!-- Tabs "https://esri.github.io/calcite-web/documentation/patterns/#tabs" -->
        <!-- Tabs "https://developers.arcgis.com/calcite-design-system/components/tabs/" -->
        <calcite-tabs>
          <div id="chartPanel">
              <calcite-tab-nav slot="tab-nav">
                  <calcite-tab-title selected>Land</calcite-tab-title>
                  <calcite-tab-title>Structure</calcite-tab-title>
                  <calcite-tab-title>Expro List</calcite-tab-title>
              </calcite-tab-nav>
              <calcite-tab>
                  <div class="box" id="pieChartLotDiv"></div>
                  <div id="lotNumberDiv"></div>
                  <div id="chartMoaLotDiv"></div>
                  <input id="handedOverButton" type="checkbox" id="opacityInput" unchecked />
                  <div id="handedOverLotNumberDiv"></div>
              </calcite-tab>
              <calcite-tab>
                <div id="pieChartStructureDiv"></div>
                <div id="structureNumberDiv"></div>
                <div id="chartMoaStructureDiv"></div>
                <div id="isfNumberDiv"></calcite-label>
                </div>
              </calcite-tab>
              <calcite-tab>
                <div class="panel-side esri-widget">
                  <ul id="expropriationListDiv">
                    <li>Loading&hellip;</li>
                  </ul>
                </div>
              </calcite-tab>
          </div>
      </calcite-tabs>
      </div>
    </calcite-shell>
  </body>
  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/widgets/Bookmarks",
      "esri/widgets/BasemapGallery",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/rest/support/Query",
      "esri/widgets/Fullscreen",
      "esri/layers/support/FeatureFilter",
      "esri/widgets/TableList",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/rest/geometryService",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/widgets/Expand",
      "esri/renderers/UniqueValueRenderer",
      "esri/Ground",
      "esri/rest/support/RelationshipQuery",
      "esri/layers/GraphicsLayer",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Print"
    ], function(WebMap, MapView, Map, FeatureLayer, Bookmarks, BasemapGallery, LayerList, Legend, 
                Query, Fullscreen, FeatureFilter, TableList, PortalItem, Portal, geometryService,
                StatisticDefinition, WebStyleSymbol, Expand, UniqueValueRenderer, Ground,
                RelationshipQuery, GraphicsLayer, Search, Locate, BasemapToggle, Print
                 ) {
      
    var map = new Map({
        basemap: "gray-vector", // "streets-night-vector", basemap
        ground: "world-elevation",
    }); 

    var view = new MapView({
        map: map,
        center: [121.0194387, 14.6972616],
        zoom: 14,
        container: "viewDiv",
        environment: {
          background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
          },
        }
    });

    // Default Renderer for Polygon------------
    let defaultLotSymbolBoundary = {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      style: "solid",
      outline: {
        style: "short-dash",
        color: [215, 215, 158],
        width: 1.5
      }
    };
      
    //------------- Layer ----------------------------- /
    // Lot Layer----------------------------------
    const LOT_LABEL_CLASS = {
        symbol: {
            type: "text",  // autocasts as new TextSymbol()
            color: "black",
            font: {  // autocast as new Font()
                family: "Gill Sans",
                size: 8
            }
        },
        labelPlacement: "always-horizontal",
        labelExpressionInfo: {
            expression: "$feature.CN"
        }
    };
      
    let lotDefaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };

    let lotLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: lotDefaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusNVS3 == 1, '1',$feature.StatusNVS3 == 2, '2', $feature.StatusNVS3 == 3, '3', \
                        $feature.StatusNVS3 == 4, '4', $feature.StatusNVS3 == 5, '5', \
                        $feature.StatusNVS3 == 6, '6', $feature.StatusNVS3)",
        uniqueValueInfos: [
            {
                // All features with value of "North" will be blue
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            },
            {
                // All features with value of "North" will be blue
                value: "6",
                label: "with WOP Fully Turned-over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[6],
                }
            }
        ]
    }
      
    function colorLotReqs(){
        return {
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,115,76]
        }
    }

    var lotLayer = new FeatureLayer({
        portalItem: {
            id: "032432d931624de9bf5ff03f1f9d7016",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        outFields: ["*"],
        title: "Land Acquisition",
        labelingInfo: [LOT_LABEL_CLASS],
        renderer: lotLayerRenderer,
        popupTemplate: {
            title: "<p>{Id}</p>",
            lastEditInfoEnabled: false,
            returnGeometry: true,
            content: [
                {
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "OWNER",
                            label: "Land Owner"
                        },
                        {
                            fieldName: "Station1",
                            label: "Station"
                        },
                        {
                            fieldName: "StatusNVS3",
                            label: "<p>Status of Land Acquisition</p>"
                        }
                    ]
                }
            ]
        }
    });
    map.add(lotLayer);
      
    // Zoom
    function zoomToLayer(layer) {
      return layer.queryExtent().then(function(response) {
        view.goTo(response.extent, { //response.extent
          speedFactor: 2,
          zoom: 17
        }).catch(function(error) {
          if (error.name != "AbortError") {
            console.error(error);
          }
        });
      });
    }
      
      // Structure Layer----------------------------------
      function colorStructureReqs(){
        return {
          1: [112, 173, 71], // Paid #70AD47
          2: [0, 112, 255], // For Payment Processing #0070FF
          3: [255, 255, 0], // For Legal Pass #FFFF00
          4: [255, 170, 0], // For Appraisal/Offer to Compensate #FFAA00
          5: [255, 0, 0], // For Expro #FF0000
          6: [0, 115, 76] //Quit Claim #00734C
        }
      }

      let structureLayerRenderer = {
        type: "unique-value",
        //field: "StatusLA",
        defaultSymbol: defaultLotSymbolBoundary,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.Status == 1, '1',$feature.Status == 2, '2', \
                          $feature.Status == 3, '3', \
                          $feature.Status == 4, '4', $feature.Status == 5, '5', \
                          $feature.Status == 6, '6', $feature.Status)",
        uniqueValueInfos: [
          {
            // All features with value of "North" will be blue
            value: "1",
            label: "Paid",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[1],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "2",
            label: "For Payment Processing",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[2],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "3",
            label: "For Legal Pass",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[3],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "4",
            label: "For Appraisal/Offer to Buy",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[4],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
        {
            // All features with value of "North" will be blue
            value: "5",
            label: "For Expro",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[5],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          },
          {
            // All features with value of "North" will be blue
            value: "6",
            label: "Quit Claim",
            symbol: {
              type: "simple-fill",
              color: colorStructureReqs()[6],
              style: "backward-diagonal",
              outline: {
                color: "#6E6E6E",
                width: 0.7
              }
            }
          }
        ]
      }

      var structureLayer = new FeatureLayer({
        portalItem: {
            id: "ec9dac0c16af4797bb917a0babc735e9",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "Existing Structure",
        outFields: ["*"],
        renderer: structureLayerRenderer,
        popupTemplate: {
          title: "<p>Structure ID: {Id_1}</p>" ,
          lastEditInfoEnabled: false,
          returnGeometry: true,
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "CN",
                  label: "Lot No."
                },
                {
                  fieldName: "Status",
                  label: "<p>Status of Structure</p>"
                }
              ]
            }
          ]
        }
      });
      map.add(structureLayer);
      structureLayer.visible = true;

      // ISF Layer----------------------------------
      const ISF_COLOR = ["#267300", "#FF0000"];
      const OUTLINE_COLOR = "white";

      let isfRenderer = {
        type: "unique-value",
        valueExpression: "When($feature.RELOCATION == 'RELOCATED', 'Relocated', \
                               $feature.RELOCATION == 'FOR RELOCATION', 'Unrelocated', $feature.RELOCATION)",
        uniqueValueInfos: [ //[1:Non-Compensable, 2:For Processing, 3:Compensated]
          {
            value: "Relocated",
            label: "Relocated",
            type: "simple",
            symbol: {
              type: "simple-marker",
              size: 9,
              color: ISF_COLOR[0], // the first two letters dictate transparency.
              outline: {
                width: 1.5,
                color: OUTLINE_COLOR
              }
            }
          },
          {
            value: "Unrelocated",
            label: "For Relocation",
            type: "simple",
            symbol: {
              type: "simple-marker",
              size: 9,
              color: ISF_COLOR[1], // the first two letters dictate transparency.
              outline: {
                width: 1.5,
                color: OUTLINE_COLOR
              }
            }
          }
        ]
      }

      var isfLayer = new FeatureLayer ({
        portalItem: {
            id: "a2e32eb82db84b3a8006e1c1e2cd7874",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        title: "ISF (Informal Settlers Families)",
        outFields: ["*"],
        returnGeometry: true,
        renderer: isfRenderer,
        labelsVisible: false
      });
      map.add(isfLayer);

      // Construction Boundary----------------------------------
      let ConstructionBoundaryFill = {
        type: "unique-value",
        valueExpression: "When($feature.MappingBoundary == 1, 'Boundary',$feature.MappingBoundary)",
        uniqueValueInfos: [
          {
            value: "Boundary",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0,0],
              outline: {
                width: 1.5,
                color: [104, 104, 104],
                style: "short-dash"
              }
            }
          }
        ]
      };

      var constBoundary = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 4,
        outFields: ["*"],
        renderer: ConstructionBoundaryFill,
        definitionExpression: "MappingBoundary = 1",
        title: "Construction Boundary",
        popupEnabled: false
      });
      map.add(constBoundary);

      // Alignment----------------------------------
      var alignmentLine = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 13,
        outFields: ["*"],
        title: "Alignment",
        popupEnabled: false
      });
      map.add(alignmentLine);

      // Segment DPWH----------------------------------
      var dpwhSegmentLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 2,
        title: "DPWH Segment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(dpwhSegmentLayer);

      // BSS Boundary----------------------------------
      /*
      var bssDepotLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 3,
        title: "BSS Boundary",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotLayer);
*/
      // Creek Diversion----------------------------------
      var creekDivLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 10,
        title: "Creek Diversion",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(creekDivLayer);

      // Depot Building----------------------------------
      var depotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 6,
        title: "Depot Building",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(depotBuildingLayer);

      // BSS Building----------------------------------
      var bssDepotBuildingLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 7,
        title: "BSS Building",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(bssDepotBuildingLayer);

      // East Valenzuela----------------------------------
      var evsLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 9,
        title: "East Valenzuela",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(evsLayer);

      // NNC Construction boundary (Senate)----------------------------------
      var senateBoundaryLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 5,
        title: "NCC Property",
        outFields: ["*"],
        popupEnabled: false
      });
      //senateBoundaryLayer.list = "hide";
      map.add(senateBoundaryLayer);

      // Station1 box----------------------------------
      let poSectionBoxRenderer = {
        type: "unique-value",
        field: "Layer",
        defaultSymbol: { type: "simple-fill"},
        uniqueValueInfos: [
          {
            value: "U-Shape Retaining Wall",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "Cut & Cover Box",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM Shaft",
            symbol: {
              type: "simple-fill",
              color: [104, 104, 104],
              style: "backward-diagonal",
              outline: {
                width: 1,
                color: "black"
              }
            }
          },
          {
            value: "TBM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "black"
              }
            }
          },
          {
            value: "Station Platform",
            symbol: {
              type: "simple-fill",
              color: [240, 204, 230],
              style: "backward-diagonal",
              outline: {
                width: 0.4,
                color: "black"
              }
            }
          },
          {
            value: "Station Box",
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0, 0],
              outline: {
                width: 2,
                color: "red"
              }
            }
          },
          {
            value: "NATM",
            symbol: {
              type: "simple-fill",
              color: [178, 178, 178],
              style: "backward-diagonal",
              outline: {
                width: 0.5,
                color: "grey"
              }
            }
          }
        ]
      };

      var poSectionBoxLayer = new FeatureLayer ({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 8,
        renderer: poSectionBoxRenderer,
        title: "Alignment",
        outFields: ["*"],
        popupEnabled: false
      });
      map.add(poSectionBoxLayer);



      // Station Point----------------------------------
      var stationLayer = new FeatureLayer({
        portalItem: {
            id: "b0cf28b499a54de7b085725bca08deee",
            portal: {
                url: "https://gis.railway-sector.com/portal"
            }
        },
        layerId: 1,
        title: "Station",
        definitionExpression: "Project = 'MMSP'"
                    //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
      });
      stationLayer.listMode = "hide";
      map.add(stationLayer, 0);

      // Chart-----------------------------------------------
      let chartLayerView;
      var highlightSelect;
      
      const lotNumberDiv = document.getElementById("lotNumberDiv");
      const handedOverLotNumberDiv = document.getElementById("handedOverLotNumberDiv");
      const structureNumberDiv = document.getElementById("structureNumberDiv");
      const isfNumberDiv = document.getElementById("isfNumberDiv");
      const handedOverButton = document.getElementById("handedOverButton");

      var stationSelect = document.getElementById("stationSelect");
      var landTypeSelect = document.getElementById("landTypeSelect");
      var packageSelect = document.getElementById("packageSelect");
      
      am5.ready(function() {
        


        // Expropriation List----------------------------------
        
        view.when(function() {
            var expropriationList = document.getElementById("expropriationListDiv");
            
            // Obtain a list of Owner's names and status
            view.whenLayerView(lotLayer).then(function(exprolayerView) {
                exprolayerView.watch("updating", function(val) {
                    if (!val) {
                        // Query for only Expropriation lots
                        var query = new Query();
                        query.where = "StatusNVS3 = 5";
                        exprolayerView.queryFeatures(query).then(function(result) {
                            expropriationList.innerHTML = "";
                            result.features.forEach(function(feature) {
                                var attributes = feature.attributes;
                                var li = document.createElement("li");
                                li.setAttribute("class", "panel-result");
                                
                                const status = attributes.StatusNVS3;
                                if (status == 5) {
                                    statusla = "Expropriation"
                                }
                                
                                // Add Expropriation lots to list
                                li.innerHTML = "<b>" + attributes.ID + "</b>" + "<br>" + attributes.OWNER + "</br>";

                                li.addEventListener("click", function(event) {
                                    var target = event.target;
                                    var objectId = feature.attributes.OBJECTID;
                                    var queryExtent = new Query({
                                        objectIds: [objectId]
                                    });
                                    
                                    // Query extent for selected expropriation lot in the list
                                    exprolayerView.queryExtent(queryExtent).then(function(result) {
                                        if (result.extent) {
                                            view.goTo({
                                                target: result.extent,
                                                speedFactor: 2,
                                                zoom: 17})
                                                .catch(function(error) {
                                                    if (error.name != "AbortError") {
                                                        console.error(error);
                                                    }
                                                }); // End of catch
                                            } // End of if (result.extent)
                                        }); // End of layerView.queryExtent
                                        
                                        // Highlight selected lots
                                        if (highlightSelect) {
                                            highlightSelect.remove();
                                        }
                                        highlightSelect = exprolayerView.highlight([objectId]);
                                        view.on("click", function() {
                                            exprolayerView.filter = null;
                                            highlightSelect.remove();
                                        });
                                    }); // End of li.addEventListener
                                    expropriationList.appendChild(li);

                                    // Hover a mouse over the list and highlight
                                    li.addEventListener("mouseenter", function(event) {
                                      var objectId = feature.attributes.OBJECTID;

                                      if (highlightSelect) {
                                        highlightSelect.remove();
                                      }
                                      highlightSelect = exprolayerView.highlight([objectId]);

                                      view.on("click", function() {
                                        exprolayerView.filter = null;
                                        highlightSelect.remove();
                                      });

                                    }); // End of mouse hover highlight
                                }); // End of result.features.forEach
                            }); // End of layerView.queryFeatures
                        } // End of if (!val)
                    }); // End of layerView.watch
                }); // End of view.whenLayerView
            }); // End of view.when()

        // Thousand separators function
        function thousands_separators(num) {
          var num_parts = num.toString().split(".");
          num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          return num_parts.join(".");
        }
        
        // 1. Total Number of Lots
        function totalNumberOfLots(){
          var totalLot = {
            onStatisticField: "CASE WHEN StatusNVS3 >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalLot",
            statisticType: "sum"
          };
          var query = lotLayer.createQuery();
          query.outStatistics = [totalLot];
          query.returnGeometry = true;

          return lotLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;
            const LOT_TOTAL = stats.totalLot;
            return LOT_TOTAL;
          });
        }

        // Total number of Lots
        function totalNumberOfLotsAll(totalLotValue){
         var totalLot = {
           onStatisticField: "ID",
           outStatisticFieldName: "totalLot",
           statisticType: "count"
         };
         var query = lotLayer.createQuery();
         query.outStatistics = [totalLot];
         query.returnGeometry = true;

         lotLayer.queryFeatures(query).then(function(response){
           var stats = response.features[0].attributes;
           const LOT_TOTAL = stats.totalLot;
           const totalValue = thousands_separators(LOT_TOTAL) + " (" + totalLotValue + ")";
           lotNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Lots</b><br>${totalValue}` : `<b>Number of Lots</b><br>${totalValue}`;
         });
       }
        totalNumberOfLots().then(totalNumberOfLotsAll);

        // Total number of handed-over lots
        function handedOverNumberLot(){
            var totalHandedOverLot = {
                onStatisticField: "CASE WHEN HandedOver = 1 THEN 1 ELSE 0 END",
                outStatisticFieldName: "totalHandedOverLot",
                statisticType: "sum"
            }
            var query = lotLayer.createQuery();
            query.outStatistics = [totalHandedOverLot];
            query.returnGeometry = true;

            lotLayer.queryFeatures(query).then(function(response){
                var stats = response.features[0].attributes;

                const HAND_OVER_TOTAL = thousands_separators(stats.totalHandedOverLot);
                handedOverLotNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Handed-Over</b><br><br>${HAND_OVER_TOTAL}` : `<b>Number of Handed-Over</b><br><br>${HAND_OVER_TOTAL}`;
            });
        }
        handedOverNumberLot();

        // Total number of structures
        function totalNumberOfStructures(){
          var totalStructure = {
            onStatisticField: "CASE WHEN Status >= 1 THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalStructure",
            statisticType: "sum"
          };
          var query = structureLayer.createQuery();
          query.outStatistics = [totalStructure];
          query.returnGeometry = true;

          return structureLayer.queryFeatures(query).then(function(response){
            var stats = response.features[0].attributes;

            const STRUCTURE_TOTAL = thousands_separators(stats.totalStructure);
           // structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br><br>${STRUCTURE_TOTAL}` : `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;

            return STRUCTURE_TOTAL; 
          });
        }
   

        function totalNumberOfStructureAll(structureValue) {
          var totalStructureAll = {
            onStatisticField: "Id",
            outStatisticFieldName: "totalStructureAll",
            statisticType: "count"
          }

          var query = structureLayer.createQuery();
          query.outStatistics = [totalStructureAll];
          query.returnGeometry = true;

          structureLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;

            const total = thousands_separators(stats.totalStructureAll);
            const totalValue = thousands_separators(total) + " (" + structureValue + ")";
            structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br>${totalValue}` : `<b>Number of Structures</b><br>${totalValue}`;
            //structureNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Number of Structures</b><br><br>${STRUCTURE_TOTAL}` : `<b>Number of Structures</b><br><br>${STRUCTURE_TOTAL}`;

          })
        }
        totalNumberOfStructures().then(totalNumberOfStructureAll);

        // Total number of ISF
        function isfNumber() {
          var totalRelo = {
            onStatisticField: "CASE WHEN RELOCATION = 'RELOCATED' THEN 1 ELSE 0 END",
            outStatisticFieldName: "totalRelo",
            statisticType: "sum"
          };
          var totalIsf = {
            onStatisticField: "RELOCATION",
            outStatisticFieldName: "totalIsf",
            statisticType: "count"
          };

          var query = isfLayer.createQuery();
          query.outStatistics = [totalRelo, totalIsf];
          query.returnGeometry = true;

          isfLayer.queryFeatures(query).then(function(response) {
            var stats = response.features[0].attributes;
            const ISF_RELO = stats.totalRelo;
            const ISF_TOTAL = stats.totalIsf;
            const PERCENT = (ISF_RELO/ISF_TOTAL)*100;

            if (ISF_RELO == null) {
              const isf_null = 0 + " (" + 0 + " %" + ")";
              isfNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Relocated ISF</b><br><br>${isf_null}` : `<b>Relocated ISF</b><br><br>${isf_null}`;
            } else {
              const isf_total = ISF_RELO + " (" + PERCENT + "%" + ")";
              isfNumberDiv.innerHTML = dark.disabled ? `<b style="color:black">Relocated ISF</b><br><br>${isf_total}` : `<b>Relocated ISF</b><br><br>${isf_total}`;
            }

          });
        }
        isfNumber();


        // Dropdown List
        // 1. Define Query
        // 1.1. Query all features from lot layer
        view.when(function() {
          return lotLayer.when(function() {
            var query = lotLayer.createQuery();
            return lotLayer.queryFeatures(query);
          });
        })
        .then(getValues)
        .then(getUniqueValues)
        .then(addToSelect)

        function queryForLotGeometries() {
        var lotQuery = lotLayer.createQuery();

        return lotLayer.queryFeatures(lotQuery).then(function(response) {
          lotGeometries = response.features.map(function(feature) {
              return feature.geometry;
          });
          return lotGeometries;
        });
        }

        // 1. Contract Package:--------------------------------
        function getValues(response) {
          var features = response.features;
          var values = features.map(function(feature) {
            return feature.attributes.Package;
          });
        return values;
        }
    
        // Return an array of unique values in the 'Municipality' field of the lot Layer
        function getUniqueValues(values) {
          var uniqueValues = [];
        
          values.forEach(function(item, i) {
            if ((uniqueValues.length < 1 || uniqueValues.indexOf(item) === -1) && item !== "") {
              uniqueValues.push(item);
            }
          });
          return uniqueValues;
        }
    
        // Add the unique values to the municipalility select element. this will allow the user
        // to filter lot layer by municipality.
        function addToSelect(values) {
          values.sort();
          values.unshift('None'); // Add 'None' to the array and place it to the beginning of the array
          values.forEach(function(value) {
              var option = document.createElement("option");
              option.text = value;
              packageSelect.add(option);
          });
        }

        // 2. Land Type:--------------------------------
        function filterLotLandType() {
          var query2 = lotLayer.createQuery();
          query2.where = lotLayer.definitionExpression; // use filtered municipality. is this correct?

          lotLayer.queryFeatures(query2)
          .then(getQuery2Values)
          .then(getUniqueValues2)
          .then(addToSelectQuery2);
        }

        // 3. Get values and return to list
        /// 3.1. Land Type
        function landTypeFilterList(cpValue) {
          var landTypeArray = [];

          function landTypeQuery() {
            var query = lotLayer.createQuery();
            query.where = cpValue === undefined || cpValue === 'None' ? "1=1" : "Package = '" + cpValue + "'";

            return lotLayer.queryFeatures(query).then(function(response) {
              stats = response.features;
              stats.forEach((result, index) => {
                const attributes = result.attributes;
                const landType = attributes.Type;
                landTypeArray.push(landType);
              });
              return landTypeArray;
            });
          }

          function getUniqueValues2(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
              if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                    uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
          }

          function addToSelectQuery2(query2Values) {
            landTypeSelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                landTypeSelect.add(option);
            });
          }
          landTypeQuery().then(getUniqueValues2).then(addToSelectQuery2)
        }
        landTypeFilterList();

        // 3. Section/station list
        function sectionFilterList(cpValue, landTypeValue) {
          var sectionArray = [];

          function sectionQuery() {
            var query = lotLayer.createQuery();
            if (cpValue === undefined && landTypeValue === undefined) {
              query.where = "1=1";

            // CP: None, Land Type: !None
            } else if (cpValue === 'None' && landTypeValue !== 'None') {
              query.where = "Type = '" + landTypeValue + "'";

            // CP: !None, Land Type: None
            } else if (cpValue !== 'None' && landTypeValue == 'None') {
              query.where = "Package = '" + cpValue + "'";

            // CP: !None , Land Type: !None
            } else if (cpValue !== 'None' && landTypeValue !== 'None') {
              query.where = "Package = '" + cpValue + "'" + " AND " + "Type = '" + landTypeValue + "'";
            }

            return lotLayer.queryFeatures(query).then(function(response) {
              stats = response.features;
              stats.forEach((result, index) => {
                const attributes = result.attributes;
                const section = attributes.Station1;
                sectionArray.push(section);
              });
              return sectionArray;
            });
          }

          function getUniqueValues3(values2) {
            var uniqueValues2 = [];
            values2.forEach(function(item, i) {
              if ((uniqueValues2.length < 1 || uniqueValues2.indexOf(item) === -1) && item !== "") {
                    uniqueValues2.push(item);
                }
            });
            return uniqueValues2;
          }

          function addToSelectQuery3(query2Values) {
            stationSelect.options.length = 0;
            query2Values.sort();
            query2Values.unshift('None');
            query2Values.forEach(function(value) {
                var option = document.createElement("option");
                option.text = value;
                stationSelect.add(option);
            });
          }
          sectionQuery().then(getUniqueValues3).then(addToSelectQuery3)
        }
        sectionFilterList();

        // 4. Set DefinitionExpression on the lot layer
        // 4.1. Only for Contract Package
        function setContractPackageExpression(cpValue) {
          const definitionExpression = "Package = '" + cpValue + "'";
          if (cpValue === 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            isfLayer.definitionExpression = null;
            constBoundary.definitionExpression = null;

          } else {
            lotLayer.definitionExpression = definitionExpression;
            structureLayer.definitionExpression = definitionExpression;
            isfLayer.definitionExpression = definitionExpression;
            constBoundary.definitionExpression = definitionExpression;
          }
          zoomToLayer(lotLayer);

          if (!lotLayer.visible) {
            lotLayer.visible = true;
          }
          return queryForLotGeometries;
        }

        // 4.2. CP + Land Type + Section/Station
        function setContractPackageLandTypeSectionExpression(cpValue, landTypeValue, sectionValue) {

          const packageDefinition = "Package = '" + cpValue + "'";
          const landTypeDefinition = "Type = '" + landTypeValue + "'";
          const sectionDefinition = "Station1 = '" + sectionValue + "'";

          const packageLandTypeDefinition = "Package = '" + cpValue + "'" + " AND " + "Type = '" + landTypeValue + "'";
          const packageSectionDefinition = "Package = '" + cpValue + "'" + " AND " + "Station1 = '" + sectionValue + "'";
          const packageLandTypeSectionDefinition = "Package = '" + cpValue + "'" + " AND " + "Type = '" + landTypeValue + "'" + " AND " + "Station1 = '" + sectionValue + "'";
          const landTypeSectionDefinition = "Type = '" + landTypeValue + "'" + " AND " + "Station1 = '" + sectionValue + "'";
          
          if (cpValue == 'None' && landTypeValue == 'None' && sectionValue == 'None') {
            lotLayer.definitionExpression = null;
            structureLayer.definitionExpression = null;
            isfLayer.definitionExpression = null;
            isfLayer.visible = true;

          } else if (cpValue !== 'None' && landTypeValue == 'None' && sectionValue == 'None') {
            lotLayer.definitionExpression = packageDefinition;
            structureLayer.definitionExpression = packageDefinition;
            isfLayer.definitionExpression = packageDefinition;

          } else if (cpValue == 'None' && landTypeValue !== 'None' && sectionValue == 'None') {
            lotLayer.definitionExpression = landTypeDefinition;
            structureLayer.definitionExpression = landTypeDefinition;
            isfLayer.definitionExpression = structureLayer.definitionExpression = landTypeDefinition;

          } else if (cpValue == 'None' && landTypeValue == 'None' && sectionValue !== 'None') {
            lotLayer.definitionExpression = sectionDefinition;
            structureLayer.definitionExpression = sectionDefinition;
            isfLayer.definitionExpression = sectionDefinition;

          } else if (cpValue !== 'None' && landTypeValue !== 'None' && sectionValue == 'None') {
            lotLayer.definitionExpression = packageLandTypeDefinition;
            structureLayer.definitionExpression = packageLandTypeDefinition;
            isfLayer.definitionExpression = packageLandTypeDefinition;

          } else if (cpValue !== 'None' && landTypeValue == 'None' && sectionValue !== 'None') {
            lotLayer.definitionExpression = packageSectionDefinition;
            structureLayer.definitionExpression = packageSectionDefinition;
            isfLayer.definitionExpression = packageSectionDefinition;

          } else if (cpValue == 'None' && landTypeValue !== 'None' && sectionValue !== 'None') {
            lotLayer.definitionExpression = landTypeSectionDefinition;
            structureLayer.definitionExpression = landTypeSectionDefinition;
            isfLayer.definitionExpression = landTypeSectionDefinition;

          }  else if (cpValue !== 'None' && landTypeValue !== 'None' && sectionValue !== 'None') {
            lotLayer.definitionExpression = packageLandTypeSectionDefinition;
            structureLayer.definitionExpression = packageLandTypeSectionDefinition;
            isfLayer.definitionExpression = packageLandTypeSectionDefinition;
          }
          zoomToLayer(lotLayer);

          if (!lotLayer.visible) {
            lotLayer.visible = true;
          }
          return queryForLotGeometries();
        }

        // When CP is changed, Land Type and station is reset to 'None'
        const changeSelected = (e) => {
          const $select = document.querySelector('#stationSelect');
          $select.value = 'None';
        };

        // 5. Add EventListener for land type and station dropdown lists
        /// 5.1. Contract Package
        packageSelect.addEventListener("change", function() {
          const cpValue = event.target.value;
          const landTypeValue = landTypeSelect.value;
          
          // Filter data
          setContractPackageExpression(cpValue);
          // Reset drowpdown 
          changeSelected();

          // Filter dropdown list
          landTypeFilterList(cpValue);
          sectionFilterList(cpValue, landTypeValue);

          // Filter each layer
          filterLot();
          filterStructure();
          filterIsf();

          // Update Chart and numbers
          updateChartLot();
          totalNumberOfLots().then(totalNumberOfLotsAll);
          //updateMoaChartLot();
          handedOverNumberLot();
          //updateChartStructure();
          totalNumberOfStructures().then(totalNumberOfStructureAll);
          //updateMoaChartStructure();
          isfNumber();

        });

        /// 5.2. Land Type
        landTypeSelect.addEventListener("change", function() {
          const cpValue = packageSelect.value;
          const landTypeValue = landTypeSelect.value;
          const sectionValue = 'None';

          // Filter data
          setContractPackageLandTypeSectionExpression(cpValue, landTypeValue, sectionValue);
          
          // Reset drowpdown 
          changeSelected();

          // Filter dropdown list
          //landTypeFilterList(cpValue);
          sectionFilterList(cpValue, landTypeValue);

          // Filter each layer
          filterLot();
          filterStructure();
          filterIsf();

          // Update Chart and numbers
          updateChartLot();
          totalNumberOfLots().then(totalNumberOfLotsAll);
          //updateMoaChartLot();
          handedOverNumberLot();
          //updateChartStructure();
          totalNumberOfStructures().then(totalNumberOfStructureAll);
          //updateMoaChartStructure();
          isfNumber();

        });

        /// 5.3. Section/ Station
        stationSelect.addEventListener("change", function() {
          const cpValue = packageSelect.value;
          const landTypeValue = landTypeSelect.value;
          const sectionValue = stationSelect.value;

          // Filter data
          setContractPackageLandTypeSectionExpression(cpValue, landTypeValue, sectionValue);

          // Update Chart and numbers
          updateChartLot();
          totalNumberOfLots().then(totalNumberOfLotsAll);
          //updateMoaChartLot();
          handedOverNumberLot();
          //updateChartStructure();
          totalNumberOfStructures().then(totalNumberOfStructureAll);
          //updateMoaChartStructure();
          isfNumber();

                    // Filter each layer
                    filterLot();
          filterStructure();
          filterIsf();

        });


        // 5. Filter Lot
        /// This is critical
        function filterLot() {
          var query2 = lotLayer.createQuery();
          query2.where = lotLayer.definitionExpression; // use filtered stations
        }

        function filterStructure() {
          var query2 = structureLayer.createQuery();
          query2.where = structureLayer.definitionExpression; // use filtered municipality. is this correct?
        }

        function filterIsf() {
          var query2 = isfLayer.createQuery();
          query2.where = isfLayer.definitionExpression; // use filtered isf
        }

        // Handed-Over filter button
        handedOverButton.addEventListener("change", function(event) {
          if (event.target.checked) {

          //lotLayer.definitionExpression = "HandOver = 1";
          view.when(function() {
            // View only handed-over lots
            view.whenLayerView(lotLayer).then(function (layerView) {
              lotLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH= results.features;
                const ROW_N = RESULT_LENGTH.length;
          
                // collected selected OBJECTID
                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                  var obj = results.features[i].attributes.OBJECTID;
                  objID.push(obj);
                }

                var queryExt = new Query({
                  objectIds: objID
                });
          
                lotLayer.queryExtent(queryExt).then(function(result) {
                  if (result.extent) {
                    view.goTo(result.extent)
                  }
                });
                highlightSelect = layerView.highlight(objID);
              }); // End of queryFeatures
              
              // Filter
              layerView.filter = {
                where: "HandedOver = 1"
              }
            }); // End of view.whenLayerView
          }); // End of view.when

          } else {
            // View all lots when check is turned off
            view.when(function() {
              view.whenLayerView(lotLayer).then(function (layerView) {
                lotLayer.queryFeatures().then(function(results) {
                  const RESULT_LENGTH= results.features;
                  const ROW_N = RESULT_LENGTH.length;
                  
                  let objID = [];
                  for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                  }
                  
                  var queryExt = new Query({
                    objectIds: objID
                  });
                  
                  lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                      view.goTo(result.extent)
                    }
                  });
                  
                  if (highlightSelect) {
                    highlightSelect.remove();
                  }
                }); // End of queryFeatures
                layerView.filter = {
                  where: "HandedOver = null || HandedOver = 1"
                }
              }); // End of view.whenLayerView
            }); // End of view.when
          }
        });


        // Charts for Lot and Structure
        // Lot Chart
        const dark = document.querySelector("#arcgis-maps-sdk-theme-dark");
        const light = document.querySelector("#arcgis-maps-sdk-theme-light");

        // Set color in light theme
        const lightThemeColor = "#212121";
        const darkThemeColor = "#FFFFFF";
        const LEGEND_FONT_SIZE = "0.9em";

        // Note that we need 'root' for each chart
        // for the second chart, var root2 = am5.Root.new("xxx");

        var root = am5.Root.new("pieChartLotDiv");
        function updateChartLot() {
          // Root element needs to be empty (as newly created) and can be used to add any other charts to it
          root.container.children.clear();

        // First, define statuses
        function Status_Name_Lot(){
          return {
            1: "Paid",
            2: "For Payment Processing",
            3: "For Legal Pass",
            4: "For Appraisal/Offer to Buy",
            5: "For Expro",
            6: "with WOP Fully Turned-over"
          }
        }

        var totalPaidLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 1 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalPaidLot",
        statisticType: "sum"
        };

        var totalpaypLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 2 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalpaypLot",
        statisticType: "sum"
        };

        var totalLegalpassLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 3 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalLegalpassLot",
        statisticType: "sum"
        };

        var totalOtbLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 4 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalOtbLot",
        statisticType: "sum"
        };

        var totalExproLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 5 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalExproLot",
        statisticType: "sum"
        };

        var totalDismissalLot = {
        onStatisticField: "CASE WHEN StatusNVS3 = 6 THEN 1 ELSE 0 END",
        outStatisticFieldName: "totalDismissalLot",
        statisticType: "sum"
        };

        var query = lotLayer.createQuery();
        query.outStatistics = [totalPaidLot, totalpaypLot, totalLegalpassLot,
                           totalOtbLot, totalExproLot, totalDismissalLot];
        query.returnGeometry = true;

        lotLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;

        const PAID = stats.totalPaidLot;
        const PAYP = stats.totalpaypLot;
        const LEGALPASS = stats.totalLegalpassLot;
        const OTB = stats.totalOtbLot;
        const EXPRO = stats.totalExproLot;
        const DISMISSAL = stats.totalDismissalLot;        

        // Set themes
        // https://www.amcharts.com/docs/v5/concepts/themes/
        root.setThemes([
          am5themes_Animated.new(root),
          am5themes_Responsive.new(root)
        ]);


        // Create chart
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
        var chart = root.container.children.push(
          am5percent.PieChart.new(root, {

          //centerY: am5.percent(-2), //-10
          //y: am5.percent(-30), // -30
          layout: root.verticalLayout
          })
        );

        // Create series
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Series
        var pieSeries = chart.series.push(
          am5percent.PieSeries.new(root, {
            name: "Series",
            categoryField: "category",
            valueField: "value",
            //legendLabelText: "[{fill}]{category}[/]",
            legendValueText: "{valuePercentTotal.formatNumber('#.')}% ({value})",
            radius: am5.percent(90), // outer radius
            innerRadius: am5.percent(40),
          })
        );



        // Set data
        // https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/#Setting_data
        //https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/pie-series/

        // To set slice color, you need to add this before data.setAll
        pieSeries.get("colors").set("colors", [
          am5.color("#70ad47"),
          am5.color("#0070FF"),
          am5.color("#FFFF00"),
          am5.color("#FFAA00"),
          am5.color("#FF0000"),
          am5.color("#00734C"),
        ]);

        // Set slice opacity and stroke color
        pieSeries.slices.template.setAll({
          fillOpacity: 0.9,
          stroke: am5.color(0xffffff),
          strokeWidth: 1,
          strokeOpacity: 1,
        });


        // Disabling labels and ticks
        pieSeries.labels.template.set("visible", false);
        pieSeries.ticks.template.set("visible", false);


        //pieSeries.appear(1000, 100)
        pieSeries.slices.template.events.on("click", function(ev) {
          const SELECTED = ev.target.dataItem.dataContext.category;
          if (SELECTED == Status_Name_Lot()[1]) {
            selectedStatus = 1;
          } else if (SELECTED == Status_Name_Lot()[2]) {
            selectedStatus = 2;
          } else if (SELECTED == Status_Name_Lot()[3]) {
            selectedStatus = 3;
          } else if (SELECTED == Status_Name_Lot()[4]) {
            selectedStatus = 4;
          } else if (SELECTED == Status_Name_Lot()[5]) {
            selectedStatus = 5;
          } else if (SELECTED == Status_Name_Lot()[6]) {
            selectedStatus = 6;
          } else {
            selectedStatus = null;
          }

          view.when(function() {
            view.whenLayerView(lotLayer).then(function (layerView) {
              //chartLayerView = layerView;

              lotLayer.queryFeatures().then(function(results) {
                const RESULT_LENGTH = results.features;
                const ROW_N = RESULT_LENGTH.length;

                let objID = [];
                for (var i=0; i < ROW_N; i++) {
                    var obj = results.features[i].attributes.OBJECTID;
                    objID.push(obj);
                }

                var queryExt = new Query({
                   objectIds: objID
                });

                lotLayer.queryExtent(queryExt).then(function(result) {
                    if (result.extent) {
                        view.goTo(result.extent)
                    }
                });

                if (highlightSelect) {
                    highlightSelect.remove();
                }
                highlightSelect = layerView.highlight(objID);

                view.on("click", function() {
                  layerView.filter = null;
                  highlightSelect.remove();
                });
              }); // End of queryFeatures
              layerView.filter = {
                where: "StatusNVS3 = " + selectedStatus
              }
            }); // End of view.whenLayerView
          }); // End of view.when
        });

        pieSeries.data.setAll(
          [
            {
              category: Status_Name_Lot()[1],
              value: PAID
            },
            {
              category: Status_Name_Lot()[2],
              value: PAYP,  
            },
            {
              category: Status_Name_Lot()[3],
              value: LEGALPASS,
            },
            {
              category: Status_Name_Lot()[4],
              value: OTB,
            },
            {
            category: Status_Name_Lot()[5],
              value: EXPRO,
            },
            {
              category: Status_Name_Lot()[6],
            value: DISMISSAL,
            }
          ]
        );


        // Legend
        // https://www.amcharts.com/docs/v5/charts/percent-charts/legend-percent-series/
        var legend = chart.children.push(am5.Legend.new(root, {
          centerX: am5.percent(50),
          x: am5.percent(50),
          layout: root.verticalLayout,
        }));
        legend.data.setAll(pieSeries.dataItems);

        // Change the size of legend markers
        legend.markers.template.setAll({
          width: 18,
          height: 18,
          strokeWidth: 1,
          strokeOpacity: 1,
          stroke: am5.color("#ccc"),

        });

        // Change the marker shape
        legend.markerRectangles.template.setAll({
          cornerRadiusTL: 10,
          cornerRadiusTR: 10,
          cornerRadiusBL: 10,
          cornerRadiusBR: 10,
        });

        const valueLabelsWidth = 50;

        // Responsive legend 
        // https://www.amcharts.com/docs/v5/tutorials/pie-chart-with-a-legend-with-dynamically-sized-labels/
        chart.onPrivate("width", function(width) {
          let box = document.querySelector('.box');
        const boxWidth = box.offsetWidth;
          //var availableSpace = Math.max(width - chart.width() - 100, 100);
          var availableSpace = (boxWidth - valueLabelsWidth) * 0.7
          console.log(width + " - " + chart.width());
          legend.labels.template.setAll({
            width: availableSpace,
            maxWidth: availableSpace
          });
        });

        // Change legend labelling properties
        // To have responsive font size, do not set font size
        legend.labels.template.setAll({
          oversizedBehavior: "truncate"
          //textDecoration: "underline"
          //width: am5.percent(200)
          //fontWeight: "300"
        });

        legend.valueLabels.template.setAll({
          textAlign: "right",
          width: valueLabelsWidth,
          //fontSize: LEGEND_FONT_SIZE,
        })

        legend.itemContainers.template.setAll({
          // set space between legend items
          paddingTop: 1.1,
          paddingBottom: 1.1,
        });


        pieSeries.appear(1000, 100);
        


        }); // End of queryFeatures
        } // End of updateChartLot()
updateChartLot();


      // view.when
      view.when(() => {
        document.querySelector("#header-title").textContent = "MMSP LAND ACQUISITION";
        document.querySelector("#item-description").innerHTML = `
                                                                 1. You can opt for either <b>light theme or dark theme</b> for a window screen via a switch icon in the upper right.<br>
                                                                 2. You can <b>filter the data</b> by CP, land type (station or subterranean), and section using dropdown lits.<br>
                                                                 3. <b>Toggle a checkbox</b> at the bottom of 'Land' panel to filter for handed-over lots.<br>
                                                                 4. View charts for summary statistics and progress on acquisition of land/structure.<br>
                                                                 5. <b>Click pie chart</b> to view the respective lots/structures on the map.<br>
                                                                 6. <b>Lots under expropriation</b> is available in the 'Expro List' tab under the theme switch.<br>
                                                                 7. <b>Click/unclick widgets</b> icon for viewing Layer list, legend, basemaps, and locate widgets under the main title.<br>
                                                                 8. <b>NVS</b> stands for <b>'Negotiated Voluntary Sale'.</b><br>
                                                                 9. <b>ROWUA</b> stands for <b>'Right-of-Way Usage Agreement'</b>.
                                                                 `
                                                                 ;
        
        let activeWidget;
        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        // Action bar 
        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
        let actionBarExpanded = false;
        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 135 : 45
          };
        });
        
        // Switch theme
        document.querySelector("calcite-shell").hidden = false;
        document.querySelector("calcite-loader").hidden = true;

        const toggleThemes = () => {
          // Calcite theme
          document.body.classList.toggle("calcite-theme-dark");
          // ArcGIS Maps SDK theme
          const dark = document.querySelector("#arcgis-maps-sdk-theme-dark");
          const light = document.querySelector("#arcgis-maps-sdk-theme-light");

          // Negate the 'disabled' attribute on both stylesheets to toggle their boolean values
          dark.disabled = !dark.disabled;
          light.disabled = !light.disabled;
          // ArcGIS Maps SDK basemap
          map.basemap = dark.disabled ? "gray-vector" : "dark-gray-vector";

          // Change the title color by theme
          totalNumberOfLots().then(totalNumberOfLotsAll);
          updateChartLot();
          //updateMoaChartLot()
          //handedOverNumberLot();
          //updateChartStructure();
          totalNumberOfStructures().then(totalNumberOfStructureAll);
          //updateMoaChartStructure();
          isfNumber();

          const dropdownContractPackageLabel = document.getElementById("dropdownContractPackageLabel");
          const dropdownLandTypeLabel = document.getElementById("dropdownLandTypeLabel");
          const dropdownStationTypeLabel = document.getElementById("dropdownStationTypeLabel");

          dropdownLandTypeLabel.style.color = dark.disabled ? "black" : "white";
          dropdownStationTypeLabel.style.color = dark.disabled ? "black" : "white";
          dropdownContractPackageLabel.style.color = dark.disabled ? "black" : "white";
        };

        document.querySelector("calcite-switch").addEventListener("calciteSwitchChange", toggleThemes);
      }); // end of view.when

    });

      
      // Widgets
      
      const basemaps = new BasemapGallery({
        view,
        container: "basemaps-container"
      });
      
      const layerList = new LayerList({
        view: view,
        selectionEnabled: true,
        container: "layers-container",
        listItemCreatedFunction: function(event) {
          const item = event.item;
          if (item.title === "BSS Boundary" || item.title === "BSS Building" || item.title === "Depot Building" || item.title === "Existing Structure"){
            item.visible = false
          }
        }
      });
      
      const legend = new Legend({
        view,
        container: "legend-container"
      });

      const locate = new Locate({
        view: view,
        container: "locate-container"
      });

      var searchWidget = new Search({
        view: view,
        locationEnabled: false,
        allPlaceholder: "LotID, StructureID",
        includeDefaultSources: false,
        sources: [
          {
            layer: lotLayer,
            searchFields: ["ID"],
            displayField: "ID",
            exactMatch: false,
            outFields: ["ID"],
            name: "Lot No",
            placeholder: "example: DP89"
          },
          {
            layer: structureLayer,
            searchFields: ["Id_1"],
            displayField: "Id",
            exactMatch: false,
            outFields: ["Id_1"],
            name: "Structure ID",
            placeholder: "example: QH-MMSP-02-01-S045C"
          }
        ]
      });

      view.ui.empty("top-left");

      // Create Expand widge for Search widget
      const searchExpand = new Expand({
        view: view,
        content: searchWidget,
        expandIconClass: "esri-icon-search",
        group: "top-right"
      });

      view.ui.add(searchExpand, {
        position: "top-right"
      });

      searchExpand.watch("expanded", function() {
        if(!searchExpand.expanded) {
          searchWidget.searchTerm = null;
        }
      });

    
      


    });
  </script>
</html>