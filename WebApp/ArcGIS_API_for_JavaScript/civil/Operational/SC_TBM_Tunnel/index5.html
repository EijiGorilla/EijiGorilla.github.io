<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the views-switch-2d-3d sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/views-switch-2d-3d/index.html
  -->
<title>SC Tunnel</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/dark/main.css"/>
    
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.7/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/1.0.7/calcite.css" />

    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Micro.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>
    <script src="https://js.arcgis.com/4.27/"></script>


  </head>
  <style>
  html,
  body,
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }

  body {
      display: flex;
    }

  calcite-loader {
    align-self: center;
    justify-self: center;
  }
  
  #see-through-label {
    position: fixed;
    z-index: 1;
    bottom: 10;
    right: 20%;
    padding: 5px;
    padding-bottom: 0;
  }

  calcite-tabs {
    height: 100%;
    width: 100%;
  }

  calcite-button {
    margin: 20;
  }

  #container {
    display: grid;
    flex-wrap: wrap;
    box-sizing: border-box;
    grid-template-columns: 1fr 0.25fr;
    width: 100%;
    height: 100%;
  }

  #header-title {
    margin-left: 1rem;
    margin-right: 1rem;
    margin-top: 1rem;
    font-size: 1.5vw;
  }

  #info-content {
    padding: 0.75rem;
  }

  calcite-rating {
    margin-top: 0.25rem;
  }
  
  #header {
    display: flex;
    padding: 0 1rem;
    background-color: var(--calcite-ui-foreground-1);
  }

  #header-controls {
    display: flex;
    margin-inline-start: auto;
    align-self: center;
  }

  #item-description b {
    color: orange;
    font-size: 0.9vw;
    font-weight: bold;
  }

  .label-wrapper {
    display: flex;
    margin-inline: 1rem;
    padding: 0.5rem;
    border: 1px solid var(--calcite-ui-border-1);
    cursor: pointer;
  }

  calcite-switch {
    margin: 0 0.5rem;
  }

  #informationDiv {
    background-color: rgb(0, 0, 0, 0);
    padding: 8;
    width: 100%;
    height: 100%;
  }

  .responsive {
    float: left;
    z-index: 99;
    position: absolute;
    right: 10%;
    bottom: 20%;
    width: 100%;
    max-width: 50px;
    height: auto;
  }

  #filterValuesDiv {
    position: fixed;
    z-index: 1;
    padding: 5;
    top: 10%;
    right: 50%;
  }

  #filterValuesDiv b {
    color: #d4ff33;
    margin: auto;
    font-size: 2.5vw;
  }

  #chartTbmDiv,
  #chartNatmDiv {
    width: 100%;
    height: 35%;
    align-items: center;
    padding-bottom: 0;
    margin-bottom: 0;
    background-color: rgb(0, 0, 0 ,0);
  }

  #chartSurveyDiv {
    width: 100%;
    height: 50%;
    align-items: center;
    padding: 0;
    margin: 0;
    background-color: rgb(0, 0, 0 ,0);
  }

  #dropdownDiv {
    background-color: rgb(0, 0, 0, 0);
    width: 50%;
    opacity: 1;
    color: white;
    text-align: right;
    margin: auto;
  }

  #cutterHeadPositionDiv {
    border: 1px solid var(--calcite-ui-border-1);
    font-size: 1.5rem;
    width: 99%;
    height: 2vw;
    text-align: center;
    font-weight: normal;
    padding-top: 1vw;
    color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    margin-top: 0.5vw;
    margin-bottom: 0.5vw;
  }

  #totalSegmentNoDiv {
    border: 1px solid var(--calcite-ui-border-1);
    width: 99%;
    height: 5vw;
    text-align: center;
    font-weight: normal;
    padding-top: 1vw;
    color: white;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    margin-top: 1vw;
    margin-bottom: 1vw;
  }

  #cutterHeadPositionDiv b,
  #totalSegmentNoDiv b {
    font-size: 1.5vw;
    text-align: center;
    font-weight: bold;
    color: white;
  }

  #cutterHeadPositionDiv h3 {
    text-align: center;
    font-size: 1.5vw;
    font-weight: normal;
    color: white;
  }

  #cutterHeadPositionDiv h6 {
    text-align: center;
    font-size: 1.5vw;
    font-weight: normal;
    color: white;
    padding: 1.5vw;
    margin: 0;
  }

  #cutterHeadPositionDiv h4 {
    text-align: center;
    font-size: 1vw;
    font-weight: bold;
    color: #d4ff33;
  }

  #segmentNo {
    margin-top: auto;
    margin-bottom: auto;
    margin-left: auto;
  }

  #cutterHeadPositionNorthDiv,
  #cutterHeadPositionSouthDiv {
    width: 99%;
    height: 3vw;
    font-weight: normal;
    color: white;
    font-size: 1.2rem;
    padding-top: 4%;
    padding-left: 20%;
    margin-top: auto;
    margin-bottom: auto;
  }


  #cutterHeadPositionNorthDiv span,
  #cutterHeadPositionSouthDiv span {
    font-size: 2.5vw;
    font-weight: bold;
    color: rgb(232, 54, 24);
  }

  .cutterHeadPositionNorth,
  .cutterHeadPositionSouth {
    display: flex;
    height: 10%;
  }

    img {
      width: 60;
      height: 60;
      margin-top: auto;
      margin-bottom: auto;
    }

  #totalSegmentNoDiv h5 {
    text-align: center;
    font-size: 2.6vw;
    font-weight: bold;
    color: #d4ff33;
    margin-top: 1.6vw;
  }

  #timeSeriesChart {
    position: absolute;
    z-index: 99;
    height: 40vh;
    width: 70vw;
    bottom: 40%;
    left: 5vw;
    background-color: rgb(37, 37, 37);
  }

  b {
    color: #d4ff33;
    font-size: 1.5w;
    font-weight: bold;
  }

  /*
  #dateDiv {
    font-size: 0.85vw;
    text-align: right;
    display: flex;
    align-items: flex-end;
    font-weight: bold;
  }
  */
  #dateDiv {
    position: fixed;
    z-index: 1;
    font-size: 0.85vw;
    text-align: right;
    bottom: 5;
    right: 5;
    font-weight: bold;
  }

  #menu {
    background-color: rgb(0, 0, 0 ,0);
  }

  .overlay {
    background-color: rgba(80, 80, 80, 0);
    padding-top: 30;
  }
  
  .button {
    cursor: pointer;
    font-size: 10pt !important;
    font-weight: bold !important;
    color: rgb(230, 230, 230);
  }
  
  .button:hover, #label {
    color: white;
  }

  #play {
    vertical-align: middle;
  }
  
  br{content:' ';}
  br:after{content:' ';}

  .esri-search__container button,
  .esri-layerlist__container button  {
    background-color: rgb(17, 54, 81);
  }

  .esri-layer-list__item-toggle-icon,
  .esri-layer-list__item-title {
    color: orange;
    font-size: 0.8vw;
    font-weight: normal;
    text-align: left;
  }

  .sassy-theme .esri-menu,
  .sassy-theme .esri-popup__main-container,
  .sassy-theme .esri-popup .esri-popup__pointer-direction,
  .sassy-theme .esri-popup .esri-popup__button,
  .sassy-theme .esri-button,
  .sassy-theme .esri-input,
  .sassy-theme .esri-legend,
  .sassy-theme .esri-layer-list,
  .sassy-theme .esri-widget a {
    background-color: rgb(0, 0, 0, 0.5);
    color: #fff;
  }

  .esri-legend__layer-caption {
    display: none;
  }

  /* Browser Setting */
  ::-webkit-scrollbar {
    display: none;
  }



  </style>
  <body class="calcite-theme-dark">
    <calcite-loader></calcite-loader>
    <calcite-shell content-behind>
      <!--  Header slot  -->
      <div slot="header" id="header">

        <!-- Title -->
        <h2 id="header-title" slot="header"></h2>

        <calcite-segmented-control id="segmentNo">
          <calcite-segmented-control-item id="All" value="All">All</calcite-segmented-control-item>
          <calcite-segmented-control-item id="NB" value="NB" checked>North-bound</calcite-segmented-control-item>
          <calcite-segmented-control-item id="SB" value="SB">South-bound</calcite-segmented-control-item>
        </calcite-segmented-control>
      </div>
      <div id="filterValuesDiv"></div>
      <!-- Icon Panel for Action -->
      <!-- https://developers.arcgis.com/calcite-design-system/icons/?icon=list&library=Calcite%20UI -->
      <calcite-shell-panel slot="panel-start" detached>
        <calcite-action-bar slot="action-bar">
          <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
          <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
          <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
          <calcite-action data-action-id="charts" icon="graph-time-series" text="Progree Chart"></calcite-action>
          <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        </calcite-action-bar>
        
        <!-- Map-specific panels (each one provides a div for ArcGIS Maps SDK for JavaScript widgets) -->
        <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>
        <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
          <div id="basemaps-container"></div>
        </calcite-panel>
        <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
          <div id="legend-container"></div>
        </calcite-panel>

        <calcite-panel class="timeSeries-panel" height-scale="l" data-panel-id="charts" hidden></calcite-panel>

        <calcite-panel class="animation-panel"  height-scale="l" data-panel-id="animation" hidden></calcite-panel>

        <!-- Info panel (populates with info from the web map) -->
        <calcite-panel heading="Description" data-panel-id="information" hidden>
          <div id="info-content">
            <!-- <img id="item-thumbnail" alt="webmap thumbnail" /> -->
            <div id="item-description">
              <!-- Dynamically populated -->
            </div>
          </div>
        </calcite-panel>
      </calcite-shell-panel>
      <div id="container">
        <div id="viewDiv"></div>
        <calcite-tabs>
          <div id="informationDiv">
            <calcite-tab-nav slot="tab-nav">
              <calcite-tab-title selected>Tunnel</calcite-tab-title>
              <calcite-tab-title>Survey</calcite-tab-title>
            </calcite-tab-nav>
            <calcite-tab>
              <div id="totalSegmentNoDiv"></div>
              <div id="chartTbmDiv"></div>
              <div id="cutterHeadPositionDiv">Cutter Head Position</div>
              <div class="cutterHeadPositionNorth">
                <img src="https://EijiGorilla.github.io/Symbols/North.svg">
                <div id="cutterHeadPositionNorthDiv"></div>
              </div>
              <div class="cutterHeadPositionSouth">
                <img src="https://EijiGorilla.github.io/Symbols/South.svg">
                <div id="cutterHeadPositionSouthDiv"></div>
              </div>
            </calcite-tab>
            <calcite-tab>
              <div id="chartSurveyDiv"></div>
            </calcite-tab>
          </calcite-tabs>
          </div>
      </div>
    <div id="timeSeriesChart" hidden></div>
    <div id="dateDiv"></div>
      <calcite-label layout="inline" id="see-through-label" class="esri-widget">
        <calcite-checkbox id="myLink"></calcite-checkbox>See-through-ground
      </calcite-label>
    </calcite-shell>
  </body>
  <script>
require([
    "esri/Basemap",
    "esri/Map",
    "esri/views/MapView",
    "esri/views/SceneView",
    "esri/layers/FeatureLayer",
    "esri/layers/support/FeatureFilter",
    "esri/layers/SceneLayer",
    "esri/layers/Layer",
    "esri/layers/TileLayer",
    "esri/layers/VectorTileLayer",
    "esri/layers/support/LabelClass",
    "esri/symbols/LabelSymbol3D",
    "esri/WebMap",
    "esri/WebScene",
    "esri/portal/PortalItem",
    "esri/portal/Portal",
    "esri/widgets/TimeSlider",
    "esri/widgets/Legend",
    "esri/widgets/LayerList",
    "esri/widgets/Fullscreen",
    "esri/rest/geometryService",
    "esri/rest/support/Query",
    "esri/rest/support/StatisticDefinition",
    "esri/symbols/WebStyleSymbol",
    "esri/TimeExtent",
    "esri/widgets/Expand",
    "esri/widgets/Editor",
    "esri/renderers/UniqueValueRenderer",
    "esri/widgets/support/DatePicker",
    "esri/widgets/FeatureTable",
    "esri/widgets/Compass",
    "esri/TimeExtent",
    "esri/layers/ElevationLayer",
    "esri/Ground",
    "esri/widgets/Search",
    "esri/widgets/BasemapToggle",
    "esri/geometry/geometryEngine",
    "esri/geometry/Polygon",
    "esri/geometry/support/webMercatorUtils",
    "esri/layers/GraphicsLayer",
    "esri/Graphic",
    "esri/geometry/SpatialReference",
    "esri/core/reactiveUtils",
    "esri/widgets/ElevationProfile",
    "esri/widgets/ElevationProfile/ElevationProfileLineQuery",
    "esri/layers/GraphicsLayer",
    "esri/Graphic",
    "esri/rest/support/RouteParameters",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/symbols/SimpleLineSymbol",
    "esri/geometry/Point",
    "esri/geometry/Polyline",
    "esri/views/3d/externalRenderers",
    "esri/rest/support/FeatureSet",
    "esri/core/Accessor",
    "esri/widgets/BasemapGallery",
    "esri/popup/content/CustomContent",
    "esri/PopupTemplate",
  ], function(Basemap, Map, MapView, SceneView, 
              FeatureLayer, FeatureFilter,
              SceneLayer, Layer, TileLayer, VectorTileLayer,
              LabelClass, LabelSymbol3D, WebMap,
              WebScene, PortalItem, Portal,
              TimeSlider, Legend, LayerList, Fullscreen,
              geometryService, Query,
              StatisticDefinition, WebStyleSymbol,
              TimeExtent, Expand, Editor, UniqueValueRenderer, DatePicker,
              FeatureTable, Compass, TimeExtent, ElevationLayer, Ground, Search,
              BasemapToggle, geometryEngine, Polygon,
              webMercatorUtils, GraphicsLayer, Graphic, SpatialReference, reactiveUtils,
              ElevationProfile, ElevationProfileLineQuery,
              GraphicsLayer, Graphic, RouteParameters,
              SimpleMarkerSymbol, SimpleLineSymbol, Point, Polyline,
              externalRenderers, FeatureSet, Accessor, BasemapGallery, CustomContent,
              PopupTemplate) {
  
  let chartLayerView;

  const spatialReference = SpatialReference.WebMercator;
   
  // Add custom DEM to the default elevation layer of esri
  const worldElevation = new ElevationLayer({
    url: "//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
    });
    
 
    var map = new Map({
      basemap: "satellite",//basemap, // "streets-night-vector", basemap, topo-vector
      ground: new Ground({
        layers: [worldElevation]
      })
    });
    //map.ground.surfaceColor = "#FFFF";
    //map.ground.opacity = 0.1;
     
    var view = new SceneView ({
      map: map,
      container: "viewDiv",
      viewingMode: "local",
      camera: {
        position: {
          x: 121.0322874,
          y: 14.6750462,
          z: 1000
        },
      tilt: 65
      },
      environment: {
        background: {
          type: "color", // autocasts as new ColorBackground()
          color: [0, 0, 0, 1]
        },
        // disable stars
        starsEnabled: false,
        //disable atmosphere
        atmosphereEnabled: false
      }
    });
  
    view.ui.components = [];
  
    // OpenStreetMap 3D Buildings
  let osmSymbol = {
    type: "mesh-3d",
    symbolLayers: [
      {
      type: "fill",
      material: {
        color: [74, 80, 87, 0.5],
        colorMixMode: "replace"
      },
      edges: {
        type: "solid", // autocasts as new SolidEdges3D()
        color: [225, 225, 225, 0.3]
      }
      }
    ]
  };
  
  var osm3D = new SceneLayer({
    portalItem: {
      id: "ca0470dbbddb4db28bad74ed39949e25"
    },
    title: "OpenStreetMap 3D Buildings"
  });
  map.add(osm3D);
  osm3D.renderer = {
    type: "simple",
    symbol: osmSymbol
  }

    //
    function shiftCamera(deg) {
      var camera = view.camera.clone();
      camera.position.longitude += deg;
      return camera;
    }
  
    function catchAbortError(error) {
      if (error.name != "AbortError") {
        console.error(error);
      }
    }
  
    // Setup UI
    var headerTitleDiv = document.getElementById("headerTitleDiv");
    const chartTbmDiv = document.getElementById("chartTbmDiv");


  //*******************************//
  // Import Layers                 //
  //*******************************//
  // ROW //
  var prowLayer = new FeatureLayer ({
    portalItem: {
      id: "d3926383cf3548569372216edb808996",
      portal: {
          url: "https://gis.railway-sector.com/portal"
      }
    },
    layerId: 1,
    title: "PROW",
    popupEnabled: false
  });
  map.add(prowLayer,0);

    // Lot Layer----------------------------------
    function colorLotReqs(){
        return {
            0: [0, 197, 255], 
            1: [112,173,71],
            2: [0,112,255],
            3: [255,255,0],
            4: [255,170,0],
            5: [255,0,0],
            6: [0,0,0,0]
        }
    }

    let defaultSymbol = {
        type: "simple-fill",  // autocasts as new SimpleFillSymbol()
        color: [0,0,0,0],
        style: "solid",
        outline: {  // autocasts as new SimpleLineSymbol()
            color: [110, 110, 110],
            width: 0.7
        }
    };
      

    let lotLayerRenderer = {
        type: "unique-value",
        defaultSymbol: defaultSymbol,  // autocasts as new SimpleFillSymbol()
        valueExpression: "When($feature.StatusLA == 0, '0',$feature.StatusLA == 1, '1', $feature.StatusLA == 2, '2', \
                               $feature.StatusLA == 3, '3', $feature.StatusLA == 4, '4', \
                               $feature.StatusLA == 5, '5', $feature.StatusLA)",
        uniqueValueInfos: [
            {
                value: "0",
                label: "Handed-Over",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[0],
                }
            },
            {
                value: "1",
                label: "Paid",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[1],
                }
            },
            {
                value: "2",
                label: "For Payment Processing",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[2],
                }
            },
            {
                value: "3",
                label: "For Legal Pass",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[3],
                }
            },
            {
                value: "4",
                label: "For Appraisal/Offer to Buy",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[4],
                }
            },
            {
                value: "5",
                label: "For Expro",
                symbol: {
                    type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                    color: colorLotReqs()[5],
                }
            }
        ]
    }

    var lotIdLabel = new LabelClass({
      labelExpressionInfo: {expression: "$feature.LotID"},
      symbol: {
        type: "text",
        color: "black",
        haloColor: "white",
        haloSize: 0.5,
        font: {
          size: 11,
          weight: "bold"
        }
      }
    });

    var lotLayer = new FeatureLayer({
      portalItem: {
        id: "c38a7320b34b45b580778d7363f4e4c3",
        portal: {
            url: "https://gis.railway-sector.com/portal"
        }
      },
      title: "Land Acquisition",
      layerId: 14,
      labelingInfo: [lotIdLabel],
      renderer:lotLayerRenderer,
      outFields: ["*"],
      minScale: 150000,
      maxScale: 0,
      //labelsVisible: false,
    });
    map.add(lotLayer,0);

    /// Popup for lot layer
    const lotStatusArray = [
        "Handed-Over",
        "Paid",
        "For Payment Processing",
        "For Legal Pass",
        "For Appraisal/Offer to Buy",
        "For Expro"
    ];

    const landUseArray = [
        "Agricultural",
        "Agricultural & Commercial",
        "Agricultural / Residential",
        "Commercial",
        "Industrial",
        "Irrigation",
        "Residential",
        "Road",
        "Road Lot",
        "Special Exempt"
    ]

    let customContentLot = new CustomContent({
        outFields: ["*"],
        creator: function(event) {

            // Extract AsscessDate of clicked pierAccessLayer
            const lotNo = event.graphic.attributes.LotID;
            const handOverDate = event.graphic.attributes.HandOverDate;
            const handOverArea = event.graphic.attributes.percentHandedOver;
            const statusLot = event.graphic.attributes.StatusLA;
            const landUse = event.graphic.attributes.LandUse;
            const municipal = event.graphic.attributes.Municipality;
            const barangay = event.graphic.attributes.Barangay;
            const landOwner = event.graphic.attributes.LandOwner;
            const cpNo = event.graphic.attributes.CP;

            // Convert numeric to date format

            var date = new Date(handOverDate);
            var DATES = dateFormat(date, 'MM-dd-yyyy');

            if (DATES === '01-01-1970') {
                var finalDate = "Undefined"
            } else {
                var finalDate = dateFormat(date, 'MM-dd-yyyy');
            }
            // Convert domain code to domain name
            /// 1. Status
            if (statusLot >= 0) {
                //headerTitleDiv.innerHTML = lotStatusArray[statusLot];
                var statusLotTemp = lotStatusArray[statusLot];
            }

            if (landUse >=1 ) {
                var landUseTemp = landUseArray[landUse - 1];
            }

            return `<ul><li>Handed-Over Area: <b>${handOverArea} %</b></li><br>
                    <li>Status:           <b>${statusLotTemp}</b></li><br>
                    <li>Land Use:         <b>${landUseTemp}</b></li><br>
                    <li>Municipality:     <b>${municipal}</b></li><br>
                    <li>Barangay:         <b>${barangay}</b></li><br>
                    <li>Land Owner:       <b>${landOwner}</b>
                    <li>CP:               <b>${cpNo}</b></li></ul>`;

        }
    });

    const templateLot = new PopupTemplate({
        outFields: ["*"],
        title: "Lot No.: <b>{LotID}</b>",
        lastEditInfoEnabled: false,
        content: [customContentLot]
    });
    lotLayer.popupTemplate = templateLot;


  // Station Layer:-------------------
  // Station labels
  var labelClass = new LabelClass({
    symbol: {
      type: "label-3d",// autocasts as new LabelSymbol3D()
      symbolLayers: [
        {
          type: "text", // autocasts as new TextSymbol3DLayer()
          material: {
            color: [255, 170, 0]
          },
          size: 20,
          color: "black",
          haloColor: "black",
          haloSize: 1,
          font: {
            family: "Ubuntu Mono",
            //weight: "bold"
          },
        }
      ],
      verticalOffset: {
        screenLength: 40,
        maxWorldLength: 100,
        minWorldLength: 20
      },
    },
    labelPlacement: "above-center",
    labelExpressionInfo: {
      expression: "$feature.Station"
      //value: "{TEXTSTRING}"
    }
  });

  // Station Symbol
  function stationsSymbol(name) {
    return {
      type: "web-style", // autocasts as new WebStyleSymbol()
      name: name,
      styleName: "EsriIconsStyle"//EsriRealisticTransportationStyle, EsriIconsStyle
    };
  }

  // Station Renderer
  var stationsRenderer = {
    type: "unique-value", // autocasts as new UniqueValueRenderer()
    field: "Station",
    defaultSymbol: stationsSymbol("Train"),//Backhoe, Train
  };

  var stationLayer = new SceneLayer({
    portalItem: {
      id: "87903f4d1859454a837d68e18a27ad4c",
      portal: {
        url: "https://gis.railway-sector.com/portal"
      }
    },
    labelingInfo: [labelClass],
    renderer: stationsRenderer,
    elevationInfo: {
      // this elevation mode will place points on top of
      // buildings or other SceneLayer 3D objects
      mode: "relative-to-ground"
    },
    definitionExpression: "Extension = 'SC'"
    //screenSizePerspectiveEnabled: false, // gives constant size regardless of zoom
  });
  stationLayer.listMode = "hide";
  map.add(stationLayer, 0);
  

  
  // TBM segmented line:-------------------
    // TBM Alignment:-------------------
const options = {
    profile: "circle",
    cap: "butt", // butt
    join: "miter",
    width: 5,
    height: 5,
    color: [200, 200, 200, 0.3],
    profileRotation: "all"
};

/* The colors used for the each transit line */
const colors = {
  1: [225, 225, 225, 0.1], // To be Constructed (white)
  2: [232, 54, 24, 1], // Excavated
  3: [0, 112, 255, 0.8], // Completed
};

let tbmStatusRenderer = {
  type: "unique-value",
  field: "Status",
  uniqueValueInfos: [
    {
      value: 1,
      label: 'To be Constructed',
      symbol: {
              type: "line-3d",
              symbolLayers: [
                {
                  type: "path",
                  profile: options.profile,
                  material: {
                    color: colors[1]
                  },
                  width: options.width,
                  height: options.height,
                  join: options.join,
                  cap: options.cap,
                  anchor: "bottom",
                  profileRotation: options.profileRotation
                }
              ]
            }
    },
    {
      value: 2,
      label: 'Excavating (Cutter Head)',
      symbol: {
              type: "line-3d",
              symbolLayers: [
                {
                  type: "path",
                  profile: options.profile,
                  material: {
                    color: colors[2]
                  },
                  width: options.width,
                  height: options.height,
                  join: options.join,
                  cap: options.cap,
                  anchor: "bottom",
                  profileRotation: options.profileRotation
                }
              ]
            }
    },
    {
      value: 3,
      label: 'Segmented',
      symbol: {
              type: "line-3d",
              symbolLayers: [
                {
                  type: "path",
                  profile: options.profile,
                  material: {
                    color: colors[3]
                  },
                  width: options.width,
                  height: options.height,
                  join: options.join,
                  cap: options.cap,
                  anchor: "bottom",
                  profileRotation: options.profileRotation
                }
              ]
            }
    }
  ]
}

  var tbmTunnelLayer = new FeatureLayer({
    portalItem: {
      id: "697cf5e1ab5a46eb870986d906bfc50b",
      portal: {
    url: "https://gis.railway-sector.com/portal"
  }
    },
    elevationInfo: {
      mode: "absolute-height",//"on-the-ground", relative-to-ground, absolute-height
      //offset: -2
    },
    hasZ: true,
    renderer: tbmStatusRenderer,
    //labelingInfo: [tbmSpotLabel2],
     title: "TBM Segment",
     outFields: ["*"],
     popupTemplate: {
        title: "Ring No.: <b>{RingNo}</b> (<b>{Line}</b>)",
        lastEditInfoEnabled: false,
        returnGeometry: true,
      }

    });
    map.add(tbmTunnelLayer);


  //*******************************//
  //      Progress Chart           //
  //*******************************//
  //const totalProgressDiv = document.getElementById("totalProgressDiv");
  const segmentedDateDiv = document.getElementById("segmentedDateDiv");
  
  // Find current position of TBM
  // The current position refers to the spot of minimum segment No.
  var graphicsLayer = new GraphicsLayer({
    title: "Cutter Head Position"
  });
  map.add(graphicsLayer);

  function tbmPositionSymbol(segmentLineValue) {
    graphicsLayer.removeAll();

    var query = tbmTunnelLayer.createQuery();
    query.where = segmentLineValue === "All" ? "tbmSpot = 1" : "tbmSpot = 1" + " AND " + "Line = '" + segmentLineValue + "'";
    query.returnGeometry = true;
    query.groupByFieldsForStatistics = ["Line"];
     
    tbmTunnelLayer.queryFeatures(query).then(function(response) {
      const stats = response.features;
      stats.forEach((result, index) => {
        const attributes = result.attributes;
        const lineType = result.Line;
        const segmentNo = result.RingNo;
        const vertex = result.geometry.paths[0];

        const long = (vertex[0][0] + vertex[1][0]) / 2;
        const lat = (vertex[0][1] + vertex[1][1]) / 2;
        // longitude: vertex[0][0]
        // latitude: vertex[0][1]

        const point = {
          spatialReference: spatialReference,
          type: "point",
          x: long,
          y: lat,
          z: -7
        }

        const symbol = {
          type: "point-3d",
            symbolLayers: [
              {
                type: "icon",
                resource: {
                  href: "https://EijiGorilla.github.io/Symbols/TBM_LOGO2.png"
                },
                size: 30
                //resource: {primitive: "circle"},
                //material: {color: "green"}
              }
            ],
            verticalOffset: {
              screenLength: 100,
              maxWorldLength: 500,
              minWorldLength: 40
            },
            callout: {
              type: "line",
              size: 1.5,
              color: "#E83618",
              border: {
                color: "#E83618"
              }
            },
            maxScale: 1000,
            minScale: 25000000
        }

        const myGraphic = new Graphic({
          geometry: point,
          symbol: symbol
        });

        graphicsLayer.add(myGraphic);
      });
    });
  }
  
  /////////////////////////////////////
  
  
  
  /* Function for zooming to selected layers */
  function zoomToLayer(layer) {
    return layer.queryExtent().then(function(response) {
      view.goTo(response.extent, { //response.extent
        speedFactor: 2
      }).catch(function(error) {
        if (error.name != "AbortError") {
          console.error(error);
        }
      });
    });
  }
  
  var highlightSelect;


    // Get last edited date
    const month = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    function getEditedDateValue() {
      var tempDates = [];

      var query = tbmTunnelLayer.createQuery();
      //query.fields = ["endDate"];
      query.where = "last_edited_date IS NOT NULL";
      return tbmTunnelLayer.queryFeatures(query).then(function(response) {
        var stats = response.features;
        stats.forEach((result, index) => {
          var attributes = result.attributes;
          const dates = attributes.last_edited_date;
          tempDates.push(dates);
        });
        const lastDate = Math.max(...tempDates);
        const lastEdit = new Date(lastDate);
        const yyyy = lastEdit.getFullYear();
        const mm = month[lastEdit.getMonth()];
        const dd = lastEdit.getDate();
        const lastEditedDate = `${mm} ${dd}, ${yyyy}`;
        document.getElementById("dateDiv").innerHTML = "As of June xx, 2023";//lastEditedDate;
      });
    }
    getEditedDateValue();
 
  // Create a Bar chart to calculate % completion for each viaduct sample
  am5.ready(function() {
        // Define color and labelling properties
    // color
    const chartTitleColor = am5.color("#d4ff33"); // yellow green
    const percentProgressLabelColor = am5.color("#00C3FF"); // light blue
    const strokeOtherColor = am5.color("#c5c5c5"); // grey

    // Thousand separators function
    function thousands_separators(num) {
      var num_parts = num.toString().split(".");
      num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return num_parts.join(".");
    }


    // Count the total number of rings
    const totalSegmentNoDiv = document.getElementById("totalSegmentNoDiv");

    function totalNumberRings(segmentLineValue) {
      const tbmExpression = "Line = '" + segmentLineValue + "'";

      var query = tbmTunnelLayer.createQuery();
      query.where = segmentLineValue === "All" ? null : tbmExpression;

      var total_number_ring_north = {
        onStatisticField: "CASE WHEN Line = 'NB' THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_ring_north",
        statisticType: "sum"
      };

      var total_number_ring_south = {
        onStatisticField: "CASE WHEN Line = 'SB' THEN 1 ELSE 0 END",
        outStatisticFieldName: "total_number_ring_south",
        statisticType: "sum"
      };

      query.outStatistics = [total_number_ring_north, total_number_ring_south];
      query.returnGeometry = true;
      
      tbmTunnelLayer.queryFeatures(query).then(function(response) {
        var stats = response.features[0].attributes;
        const north = stats.total_number_ring_north;
        const south = stats.total_number_ring_south;
        const value = north + south;
        const totalValue = thousands_separators(value);

        totalSegmentNoDiv.innerHTML = `
                                    <b>Total No. of Rings</b><br>
                                    <h5>${totalValue}</h5>
                                  `;
      })
    }

          ///////// PIE CHART /////////
  // 1. TBM
  var root = am5.Root.new("chartTbmDiv");
  root._logo.dispose();
function tbmChart(segmentLineValue) {
  var total_number_north = {
    onStatisticField: "CASE WHEN Line = 'NB' THEN 1 ELSE 0 END",
    outStatisticFieldName: "total_number_north",
    statisticType: "sum"
  }

  var total_number_south = {
    onStatisticField: "CASE WHEN Line = 'SB' THEN 1 ELSE 0 END",
    outStatisticFieldName: "total_number_south",
    statisticType: "sum"
  }
    
    var total_complete = {
    onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
    outStatisticFieldName: "total_complete",
    statisticType: "sum"
  }
    
    var query = tbmTunnelLayer.createQuery();
    query.outStatistics = [total_number_north, total_number_south, total_complete];
    query.returnGeometry = true;
    query.where = segmentLineValue === "All" ? null : "Line = '" + segmentLineValue + "'";
    
    tbmTunnelLayer.queryFeatures(query).then(function(response) {
    var stats = response.features[0].attributes;
    const north = stats.total_number_north;
    const south = stats.total_number_south;

    const totalNumber = north + south;
    const completed = stats.total_complete;

    const LOT_HANDOVER_PERC = ((completed/totalNumber)*100).toFixed(1);

  root.container.children.clear();
    // Set themes
  // https://www.amcharts.com/docs/v5/concepts/themes/
  root.setThemes([
    am5themes_Animated.new(root),
    am5themes_Responsive.new(root)
  ]);

  // Create chart
  // https://www.amcharts.com/docs/v5/charts/radar-chart/
  var chart = root.container.children.push(
    am5radar.RadarChart.new(root, {
      panX: false,
      panY: false,
      startAngle: -180,
      endAngle: 0,
      radius: am5.percent(90), // size of overall chart
      innerRadius: -20, // expand inward,

    })
  );

  // Chart title
 
  chart.children.unshift(am5.Label.new(root, {
    text: "[bold]SEGMENT RING",
    fontSize: "1.9em",
    //fontWeight: "bold",
    textAlign: "center",
    fill: percentProgressLabelColor,
    x: am5.percent(50),
    centerX: am5.percent(50),
    y: am5.percent(5),
    centerY: am5.percent(50),
    paddingBottom: 20
    //marginBottom: 20
  }));


  chart.children.unshift(am5.Label.new(root, {
    text: "Completed",
    fontSize: 25,
    textAlign: "center",
    fill: percentProgressLabelColor,
    x: am5.percent(50),
    centerX: am5.percent(50),
    y: am5.percent(100),
    centerY: am5.percent(100),
  }));

  chart.children.unshift(am5.Label.new(root, {
    text: "[bold]" + completed,
    fontSize: "2.3em",
    textAlign: "center",
    fill: chartTitleColor,
    x: am5.percent(50),
    centerX: am5.percent(50),
    y: am5.percent(65),
    centerY: am5.percent(100),

  }));

  //chart.getNumberFormatter().set("numberFormat", "#'%'");

  // Create axis and its renderer
  // https://www.amcharts.com/docs/v5/charts/radar-chart/gauge-charts/#Axes
  var axisRenderer = am5radar.AxisRendererCircular.new(root, {
    innerRadius: am5.percent(120), //gagues width becomes thicker outward
    strokeOpacity: 0.1,
    minGridDistance: 30
  });

  // Enable ticks
  axisRenderer.ticks.template.setAll({
    visible: true,
    strokeOpacity: 0.5,
    length: -6,
    //inside: true,
    stroke: strokeOtherColor
  });

  axisRenderer.grid.template.setAll({
    stroke: root.interfaceColors.get("background"),
    visible: false,
    strokeOpacity: 0.8
  });

  var xAxis = chart.xAxes.push(
    am5xy.ValueAxis.new(root, {
      maxDeviation: 0,
      min: 0,
      max: 100,
      strictMinMax: true,
      renderer: axisRenderer,
    })
  );

  // Axis labels properties
  xAxis.get("renderer").labels.template.setAll({
    fill: strokeOtherColor,
    fontSize: 10,
    textAlign: "center",  
    inside: true, // move labels inside ticks
    radius: 20
      
  });

  // Add clock hand
  // https://www.amcharts.com/docs/v5/charts/radar-chart/gauge-charts/#Clock_hands
  var axisDataItem = xAxis.makeDataItem({});
  var clockHand = am5radar.ClockHand.new(root, {
    //pinRadius: 10,
    radius: am5.percent(-3),
    innerRadius: -30,
    bottomWidth: 10,
    topWidth: 0
  });

  clockHand.pin.setAll({
    fillOpacity: 0,
    strokeOpacity: 0,
  });

  clockHand.hand.setAll({
    fillOpacity: 0.5,
    strokeOpacity: 0.7,
    stroke: am5.color("#808080"),
    fill: am5.color("#FFA500"),
    strokeWidth: 1,
  });

  var bullet = axisDataItem.set(
    "bullet",
    am5xy.AxisBullet.new(root, {
      sprite: clockHand
    })
  );

  xAxis.createAxisRange(axisDataItem);

  // Label for percent progress
  var label = chart.radarContainer.children.push(
    am5.Label.new(root, {
      centerX: am5.percent(50),
      textAlign: "center",
      centerY: am5.percent(90),
      y: am5.percent(25),
      fontSize: "2.9em",
      fill: percentProgressLabelColor
    })
  );

  // Add percent progress values
  bullet.get("sprite").on("rotation", function () {
    var value = axisDataItem.get("value");
    label.set("text", value.toString() + "%");
  });

    //var value = 30;

    axisDataItem.animate({
      key: "value",
      to: LOT_HANDOVER_PERC,
      duration: 500,
      easing: am5.ease.out(am5.ease.cubic)
    });

  chart.bulletsContainer.set("mask", undefined);

  var colorSet = am5.ColorSet.new(root, {});
  var axisRange0 = xAxis.createAxisRange(
    xAxis.makeDataItem({
      above: true,
      value: 0,
      endValue: LOT_HANDOVER_PERC
    })
  );

  axisRange0.get("axisFill").setAll({
    visible: true,
    fill: percentProgressLabelColor
  });

  axisRange0.get("label").setAll({
    forceHidden: true
  });

  var axisRange1 = xAxis.createAxisRange(
    xAxis.makeDataItem({
      above: true,
      value: LOT_HANDOVER_PERC,
      endValue: 100
    })
  );

  axisRange1.get("axisFill").setAll({
    visible: true,
    fill: strokeOtherColor
  });

  axisRange1.get("label").setAll({
    forceHidden: true,
  });

  // Make stuff animate on load
  chart.appear(1000, 100);
}); 
}

  // Selected Value Labels above gauge
  const filterValuesDiv = document.getElementById("filterValuesDiv");
  function selectedValuesLabel(segmentLineValue) {
   filterValuesDiv.innerHTML = `<b>${segmentLineValue}`;
  }

    // Default
    const cutterHeadPositionDiv = document.getElementById("cutterHeadPositionDiv");
    function defaultRender(){
      tbmTunnelLayer.visible = true;
      tbmTunnelLayer.definitionExpression = "Line = 'NB'";

      tbmChart("NB");

      defaultSegementedLine = "NB";

      // cutter head position symbol
      tbmPositionSymbol(defaultSegementedLine);

      // Cutter head position
      cutterHeadPosition(defaultSegementedLine);

      //selectedValuesLabel
      selectedValuesLabel(defaultSegementedLine)

      // Total Number of rings
      totalNumberRings(defaultSegementedLine);

      // timeSeriesChart
      timeSeriesChart(defaultSegementedLine);
    }

    view.when(() => {
      defaultRender();
      zoomToLayer(tbmTunnelLayer);
    })

       // Cutter head position for each TBM
  // note that cutter head position = permanently cased segment No. + 7
  // E.g., if segment no. 10 is casted, cutter head position = 10 + 7 = No. 17
  // In the attribute table, tbmSpot = 1

  const cutterHeadPositionNorthDiv = document.getElementById("cutterHeadPositionNorthDiv");
  const cutterHeadPositionSouthDiv = document.getElementById("cutterHeadPositionSouthDiv");

  function cutterHeadPosition(segmentLineValue) {
    var query = tbmTunnelLayer.createQuery();
    query.where = segmentLineValue === "All" ? "tbmSpot = 1" : "tbmSpot = 1" + " AND " + "Line = '" + segmentLineValue + "'";
    query.groupByFieldsForStatistics = ["Line"];

    tbmTunnelLayer.queryFeatures(query).then(function(response) {
      var stats = response.features;
      stats.forEach((result, index) => {
        const attributes = result.attributes;
        const segmentNo = attributes.RingNo;
        const tbmNo = attributes.Line;

        if (segmentLineValue === "All") {
          if (tbmNo === 'NB'){
            cutterHeadPositionNorthDiv.innerHTML = `Ring No. <span>${segmentNo}</span>`;
          } else if (tbmNo === 'SB') {
            cutterHeadPositionSouthDiv.innerHTML = `Ring No. <span>${segmentNo}</span>`;
          }

        } else if (tbmNo === 'NB') {
          cutterHeadPositionNorthDiv.innerHTML = `Ring No. <span>${segmentNo}</span>`;
          cutterHeadPositionSouthDiv.innerHTML = `Ring No. <span>----</span>`;

        } else if (tbmNo === 'SB') {
          cutterHeadPositionNorthDiv.innerHTML = `Ring No. <span>----</span>`;
          cutterHeadPositionSouthDiv.innerHTML = `Ring No. <span>${segmentNo}</span>`;
        }
      });
    });
  }

  // time series chart to show monthly progress
  var root2 = am5.Root.new("timeSeriesChart");
  root2._logo.dispose();
  
  function timeSeriesChart(segmentLineValue) {
    root2.container.children.clear();

    var total_complete_north = {
      onStatisticField: "CASE WHEN (Line = 'NB' and Status = 3) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_north",
      statisticType: "sum"
    };

    var total_complete_south = {
      onStatisticField: "CASE WHEN (Line = 'SB' and Status = 3) THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_south",
      statisticType: "sum"
    };

    var total_complete_segment = {
      onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
      outStatisticFieldName: "total_complete_segment",
      statisticType: "sum"
    };

    var query = tbmTunnelLayer.createQuery();
    query.where = segmentLineValue === "All" ? "endDate IS NOT NULL" : "endDate IS NOT NULL" + " AND " + "Line = '" + segmentLineValue + "'";
    query.outStatistics = [total_complete_north, total_complete_south, total_complete_segment];
    query.outFields = ["Line" ,"endDate"];
    query.orderByFields = ["endDate"];
    query.groupByFieldsForStatistics = ["endDate"];

    tbmTunnelLayer.queryFeatures(query).then(function(response) {
      var stats = response.features;

      // collect all dates for each viaduct type
      const data = stats.map((result, index) => {
        const attributes = result.attributes;
        const date = attributes.endDate;
        const north = attributes.total_complete_north;
        const south = attributes.total_complete_south;
        const value = north + south;

        //const value = attributes.total_complete_segment;
 
        // compile in object
        return Object.assign({}, {
          date: date,
          value: value,
        });
      });

      console.log(data);

      // 6. Add to Chart
      // set themes
      // set themes
      root2.setThemes([
        am5themes_Animated.new(root2)
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/xy-chart/
      var chart = root2.container.children.push(am5xy.XYChart.new(root2, {
        panX: false,
        panY: false,
        wheelX: "panX",
        wheelY: "zoomX"
      }));

      // Chart title
      chart.children.unshift(am5.Label.new(root2, {
        text: "Monthly Progress of Segmentation",
        fontSize: 14,
        fontWeight: "bold",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        x: am5.percent(50),
        centerX: am5.percent(50),
        paddingTop: 0,
        paddingBottom: 0,
      }));

      // Add cursor
      // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
      var cursor = chart.set("cursor", am5xy.XYCursor.new(root2, {
        behavior: "zoomX"
      }));
      cursor.lineY.set("visible", false);

      // Create axes
      // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
      var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root2, {
        maxDeviation: 0,
        groupData: true,
        baseInterval: {
          timeUnit: "day",
          count: 1
        },
        groupIntervals: [{timeUnit: "month", count: 1}],
        categoryField: "date",
        renderer: am5xy.AxisRendererX.new(root2, {
          //minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        }),
        tooltip: am5.Tooltip.new(root2, {})
      }));

      // Label properties for yAxis (category axis)
      xAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root2, {
        renderer: am5xy.AxisRendererY.new(root2, {
          minGridDistance: 60,
          strokeOpacity: 1,
          strokeWidth: 1,
          stroke: am5.color("#ffffff"),
        })
      }));

      yAxis.get("renderer").labels.template.setAll({
        //oversizedBehavior: "wrap",
        textAlign: "center",
        fill: am5.color("#ffffff"),
        //maxWidth: 150,
        fontSize: 12
      });

      // Add yaxix title
      yAxis.children.unshift(
        am5.Label.new(root2, {
          rotation: -90,
          text: "No. of Segmented Rings",
          y: am5.p50,
          centerX: am5.p50,
          fill: am5.color("#ffffff"),
          fontSize: 11
        })
      );

      // Add series
      // https://www.amcharts.com/docs/v5/charts/xy-chart/series/
      var series = chart.series.push(am5xy.ColumnSeries.new(root2, {
        name: "Series",
        xAxis: xAxis,
        yAxis: yAxis,
        valueYField: "value",
        valueXField: "date",
        valueYGrouped: "sum",
        tooltip: am5.Tooltip.new(root2, {
          labelText: "{valueY}"
        })
      }));

      series.bullets.push(function() {
        return am5.Bullet.new(root2, {
          sprite: am5.Label.new(root2, {
            text: "{valueY}",
            fill: root2.interfaceColors.get("alternativeText"),
            centerY: am5.p50,
            centerX: am5.p50,
            populateText: true
          })
        });
      });

      series.columns.template.setAll({ strokeOpacity: 0 })

      // Add scrollbar
      /*
      // https://www.amcharts.com/docs/v5/charts/xy-chart/scrollbars/
      chart.set("scrollbarX", am5.Scrollbar.new(root2, {
        orientation: "horizontal",
        fillOpacity: 0.5
      }));
  */
      series.data.setAll(data);

      // Make stuff animate on load
      // https://www.amcharts.com/docs/v5/concepts/animations/
      series.appear(1000);
      chart.appear(1000, 100);
    }); 
  }

  // Segment No list
  const segmentType = document.getElementById("segmentNo");
  segmentType.addEventListener("calciteSegmentedControlChange", async (event) => { segmentLineValue = event.target.value, filterItems() });

  function filterItems(){
    console.log(segmentLineValue);
    if (segmentLineValue === "All"){
      tbmTunnelLayer.definitionExpression = null;
      tbmTunnelLayer.visible = true;
    } else {
      tbmTunnelLayer.definitionExpression = "Line = '" + segmentLineValue + "'";
    }
    
    selectedValuesLabel(segmentLineValue);

    // Cutter head position
    cutterHeadPosition(segmentLineValue);

    // char title 
    tbmChart(segmentLineValue);

    // Cutter head position 3D point symbol
    tbmPositionSymbol(segmentLineValue);

    // Total number of rings
    totalNumberRings(segmentLineValue);

    // timeSeriesChart
    timeSeriesChart(segmentLineValue);

    //
    highlightSegment(segmentLineValue);


  }

  // highlight function
  function highlightSegment(segmentLineValue){
    // Highlight selected segment Lines
    var highlight = null;

    // Update layerView based on viaduct components being selected
    const highlighFilterExpression = segmentLineValue === "All" ? null : "Line = '" + segmentLineValue + "'";
    view.whenLayerView(tbmTunnelLayer).then(function (tbmTunnelLayerView) {
        tbmTunnelLayerView.filter = {
            where: highlighFilterExpression
        };

        var query = new Query();
        query.returnGeometry = true;
        tbmTunnelLayerView.queryFeatures(query).then(function(results) {
            const ggg = results.features;
            const rowN = ggg.length;
            
            // Extract and obtain OBJECTID
            let objID = [];
            for (var i=0; i< rowN; i++) {
                var obj = results.features[i].attributes.OBJECTID;
                objID.push(obj);
            }
            
            if (highlight) {
              highlightSelect.remove();
            }
            highlight = tbmTunnelLayerView.highlight(objID);

            // Reset selection by clicking anywhere on the map
            view.on("click", function() {
                tbmTunnelLayerView.filter = null;
                highlight.remove();
            });
        });
    }); // whenLayerView

  }

 
        // view.when
        view.when(() => {
          document.querySelector("#header-title").textContent = "SC TUNNEL CONSTRUCTION";
          document.querySelector("#item-description").innerHTML = `
                                                                    <p>1. <b>Filter</b> by contract package from the dropdown list in the header panel.</p>
                                                                    <p>2. <b>Filter</b> by tunnel segment No.from the 2nd dropdown list if needed.</p>
                                                                    <p>3. <b>Toggle</b> 'See through ground' at the bottom right to view underground.</p>
                                                                  `;
          const timeSeriesChartDiv = document.getElementById("timeSeriesChart");
          let activeWidget;
          const handleActionBarClick = ({ target }) => {
            if (target.tagName !== "CALCITE-ACTION") {
              return;
            }

            if (activeWidget) {
              document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
              document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;

            // Close the progress time series chart when chart widget is closed
            if (`${activeWidget}` === "charts") {
              //document.getElementById("land-checkbox").checked = false;
              timeSeriesChartDiv.style.display = "none";
            }
            }

            const nextWidget = target.dataset.actionId;
            if (nextWidget !== activeWidget) {
              document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
              document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
              activeWidget = nextWidget;

            // Open the time series chart when chart widget is opened.
            if (`${activeWidget}` === "charts") {
              //document.getElementById("land-checkbox").checked = true;
              timeSeriesChartDiv.style.display = "block";
            }

            } else {
              activeWidget = null;
            }
          };

          // Action bar 
          document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
          let actionBarExpanded = false;
          document.addEventListener("calciteActionBarToggle", event => {
            actionBarExpanded = !actionBarExpanded;
            view.padding = {
              left: actionBarExpanded ? 135 : 45
            };
          });
        
      }); // end of view.when

  }); // end am4core.ready()
  
  const basemaps = new BasemapGallery({
    view,
    container: "basemaps-container"
  });

  const layerList = new LayerList({
    view: view,
    selectionEnabled: true,
    container: "layers-container",
    listItemCreatedFunction: function(event) {
      const item = event.item;
      if (item.title === "Land Acquisition" || item.title === "OpenStreetMap 3D Buildings"){
        item.visible = false
      }
    }
      });
  
  // Legend
  const legend = new Legend({
    view: view,
    container: "legend-container",
    layerInfos: [
      {
        layer: tbmTunnelLayer,
        title: "TBM Tunnel"
      },
      {
        layer: lotLayer,
        title: "Land Acquisition"
      },
    ]
  });
  
  view.ui.empty("top-left");

  // See-through-Ground        
  view.when(function() {
  // allow navigation above and below the ground
  map.ground.navigationConstraint = {
    type: "none"
  };
  // the webscene has no basemap, so set a surfaceColor on the ground
  map.ground.surfaceColor = "#fff";
  // to see through the ground, set the ground opacity to 0.4
  map.ground.opacity = 0.9; //
  });

  document.getElementById("myLink").addEventListener("click", function(event) {
      const checked = event.srcElement.checked;
      map.ground.opacity = event.srcElement.checked ? 0.1 : 0.6;
    });


  });
  </script>
</html>